generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Channel {
  id              String             @id @default(uuid())
  name            String             @db.VarChar(100)
  code            String             @unique @db.VarChar(50)
  type            String             @db.VarChar(50)
  apiConfig       Json               @map("api_config")
  description     String?
  status          Status             @default(active)
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  warehouses      ChannelWarehouse[]
  products        Product[]
  syncRules       SyncRule[]
  listingProducts ListingProduct[]   @relation("ListingProducts")
  productPool     ProductPool[]      @relation("ProductPool")

  @@map("channels")
}

model ChannelWarehouse {
  id            String   @id @default(uuid())
  channelId     String   @map("channel_id")
  warehouseCode String   @map("warehouse_code") @db.VarChar(50)
  warehouseName String   @map("warehouse_name") @db.VarChar(100)
  region        String?  @db.VarChar(50)
  country       String?  @db.VarChar(50)
  extraData     Json?    @map("extra_data")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  channel       Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, warehouseCode])
  @@map("channel_warehouses")
}

model Platform {
  id          String             @id @default(uuid())
  name        String             @db.VarChar(100)
  code        String             @unique @db.VarChar(50)
  apiBaseUrl  String?            @map("api_base_url") @db.VarChar(255)
  description String?
  status      Status             @default(active)
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  shops       Shop[]
  categories  PlatformCategory[]
  categoryAttributeMappings CategoryAttributeMapping[]

  @@map("platforms")
}

model Shop {
  id              String           @id @default(uuid())
  platformId      String           @map("platform_id")
  name            String           @db.VarChar(100)
  code            String           @unique @db.VarChar(50)
  apiCredentials  Json             @map("api_credentials")
  region          String?          @db.VarChar(50)
  description     String?
  status          Status           @default(active)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  syncConfig      Json?            @map("sync_config")
  autoSyncConfig  AutoSyncConfig?
  autoSyncTasks   AutoSyncTask[]
  feedRecords     FeedRecord[]
  operationLogs   OperationLog[]
  products        Product[]
  syncTasks       ShopSyncTask[]
  platform        Platform         @relation(fields: [platformId], references: [id])
  syncRules       SyncRule[]
  listingProducts ListingProduct[] @relation("ListingProducts")
  listingTasks    ListingTask[]    @relation("ListingTasks")
  listingLogs     ListingLog[]     @relation("ListingLogs")
  listingFeedRecords ListingFeedRecord[] @relation("ListingFeedRecords")

  @@map("shops")
}

model SyncRule {
  id              String         @id @default(uuid())
  name            String         @db.VarChar(100)
  channelId       String         @map("channel_id")
  shopId          String         @map("shop_id")
  syncType        SyncType       @default(incremental) @map("sync_type")
  intervalDays    Int            @default(1) @map("interval_days")
  priceMultiplier Decimal        @default(1.0) @map("price_multiplier") @db.Decimal(10, 4)
  priceAdjustment Decimal        @default(0) @map("price_adjustment") @db.Decimal(10, 2)
  stockMultiplier Decimal        @default(1.0) @map("stock_multiplier") @db.Decimal(10, 4)
  stockAdjustment Int            @default(0) @map("stock_adjustment")
  fieldMapping    Json?          @map("field_mapping")
  lastSyncAt      DateTime?      @map("last_sync_at")
  nextSyncAt      DateTime?      @map("next_sync_at")
  status          SyncRuleStatus @default(active)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  products        Product[]
  syncLogs        SyncLog[]
  channel         Channel        @relation(fields: [channelId], references: [id])
  shop            Shop           @relation(fields: [shopId], references: [id])

  @@map("sync_rules")
}

model Product {
  id                String     @id @default(uuid())
  syncRuleId        String?    @map("sync_rule_id")
  shopId            String?    @map("shop_id")
  channelProductId  String     @map("channel_product_id") @db.VarChar(100)
  sku               String     @db.VarChar(100)
  title             String     @db.VarChar(500)
  originalPrice     Decimal    @map("original_price") @db.Decimal(10, 2)
  finalPrice        Decimal    @map("final_price") @db.Decimal(10, 2)
  originalStock     Int        @map("original_stock")
  finalStock        Int        @map("final_stock")
  currency          String     @default("USD") @db.VarChar(10)
  extraFields       Json?      @map("extra_fields")
  platformProductId String?    @map("platform_product_id") @db.VarChar(100)
  sourceChannel     String?    @map("source_channel") @db.VarChar(100)
  syncStatus        SyncStatus @default(pending) @map("sync_status")
  lastSyncAt        DateTime?  @map("last_sync_at")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  localPrice        Decimal?   @map("local_price") @db.Decimal(10, 2)
  localStock        Int?       @map("local_stock")
  channelId         String?    @map("channel_id")
  platformSku       String?    @map("platform_sku") @db.VarChar(100)
  channel           Channel?   @relation(fields: [channelId], references: [id])
  shop              Shop?      @relation(fields: [shopId], references: [id])
  syncRule          SyncRule?  @relation(fields: [syncRuleId], references: [id])

  @@unique([shopId, sourceChannel, sku])
  @@map("products")
}

model SyncLog {
  id           String        @id @default(uuid())
  syncRuleId   String        @map("sync_rule_id")
  syncType     SyncType      @map("sync_type")
  triggerType  TriggerType   @map("trigger_type")
  startedAt    DateTime      @default(now()) @map("started_at")
  finishedAt   DateTime?     @map("finished_at")
  totalCount   Int           @default(0) @map("total_count")
  successCount Int           @default(0) @map("success_count")
  failCount    Int           @default(0) @map("fail_count")
  status       SyncLogStatus @default(running)
  errorMessage String?       @map("error_message")
  details      Json?
  createdAt    DateTime      @default(now()) @map("created_at")
  syncRule     SyncRule      @relation(fields: [syncRuleId], references: [id])

  @@map("sync_logs")
}

model ShopSyncTask {
  id           String             @id @default(uuid())
  shopId       String             @map("shop_id")
  shopName     String             @map("shop_name") @db.VarChar(100)
  status       ShopSyncTaskStatus @default(pending)
  progress     Int                @default(0)
  total        Int                @default(0)
  created      Int                @default(0)
  updated      Int                @default(0)
  skipped      Int                @default(0)
  errorMessage String?            @map("error_message")
  startedAt    DateTime           @default(now()) @map("started_at")
  finishedAt   DateTime?          @map("finished_at")
  createdAt    DateTime           @default(now()) @map("created_at")
  createdSkus  Json?              @map("created_skus")
  skippedSkus  Json?              @map("skipped_skus")
  updatedSkus  Json?              @map("updated_skus")
  shop         Shop               @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("shop_sync_tasks")
}

model AutoSyncConfig {
  id           String    @id @default(uuid())
  shopId       String    @unique @map("shop_id")
  enabled      Boolean   @default(false)
  intervalDays Int       @default(1) @map("interval_days")
  syncType     String    @default("both") @map("sync_type")
  lastSyncAt   DateTime? @map("last_sync_at")
  nextSyncAt   DateTime? @map("next_sync_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  syncHour     Int       @default(8) @map("sync_hour")
  shop         Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("auto_sync_configs")
}

model AutoSyncTask {
  id             String        @id @default(uuid())
  shopId         String        @map("shop_id")
  syncType       String        @default("both") @map("sync_type")
  stage          AutoSyncStage @default(fetch_channel)
  channelStats   Json?         @map("channel_stats")
  localUpdated   Int           @default(0) @map("local_updated")
  platformFeedId String?       @map("platform_feed_id")
  platformStatus String?       @map("platform_status")
  totalProducts  Int           @default(0) @map("total_products")
  successCount   Int           @default(0) @map("success_count")
  failCount      Int           @default(0) @map("fail_count")
  errorMessage   String?       @map("error_message")
  startedAt      DateTime      @default(now()) @map("started_at")
  finishedAt     DateTime?     @map("finished_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  shop           Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("auto_sync_tasks")
}

model OperationLog {
  id         String    @id @default(uuid())
  shopId     String?   @map("shop_id")
  type       String    @db.VarChar(50)
  status     String    @default("running") @db.VarChar(20)
  total      Int       @default(0)
  processed  Int       @default(0)
  success    Int       @default(0)
  failed     Int       @default(0)
  message    String?
  detail     Json?
  startedAt  DateTime  @default(now()) @map("started_at")
  finishedAt DateTime? @map("finished_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  shop       Shop?     @relation(fields: [shopId], references: [id])

  @@map("operation_logs")
}

model FeedRecord {
  id           String       @id @default(uuid())
  shopId       String       @map("shop_id")
  feedId       String       @map("feed_id") @db.VarChar(100)
  syncType     FeedSyncType @map("sync_type")
  itemCount    Int          @default(0) @map("item_count")
  status       FeedStatus   @default(RECEIVED)
  successCount Int          @default(0) @map("success_count")
  failCount    Int          @default(0) @map("fail_count")
  errorMessage String?      @map("error_message")
  feedDetail   Json?        @map("feed_detail")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  completedAt  DateTime?    @map("completed_at")
  shop         Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, feedId])
  @@map("feed_records")
}

enum Status {
  active
  inactive
}

enum SyncRuleStatus {
  active
  paused
  inactive
}

enum SyncType {
  full
  incremental
}

enum SyncStatus {
  pending
  synced
  failed
}

enum SyncLogStatus {
  running
  success
  partial
  failed
}

enum TriggerType {
  scheduled
  manual
}

enum ShopSyncTaskStatus {
  pending
  running
  paused
  completed
  failed
  cancelled
}

enum FeedStatus {
  RECEIVED
  INPROGRESS
  PROCESSED
  ERROR
}

enum FeedSyncType {
  price
  inventory
  both
}

enum AutoSyncStage {
  fetch_channel
  update_local
  push_platform
  completed
  failed
  cancelled
  paused
}


// ==================== 商品刊登模块 ====================

// ==================== 商品池（渠道商品基础数据，与店铺无关）====================
model ProductPool {
  id              String        @id @default(uuid())
  channelId       String        @map("channel_id")

  // 基本信息
  sku             String        @db.VarChar(100)
  title           String        @db.VarChar(500)
  description     String?       @db.Text

  // 图片
  mainImageUrl    String?       @map("main_image_url")
  imageUrls       Json?         @map("image_urls")
  videoUrls       Json?         @map("video_urls")

  // 价格库存
  price           Decimal       @db.Decimal(10, 2)
  stock           Int           @default(0)
  currency        String        @default("USD") @db.VarChar(10)

  // 渠道原始数据
  channelRawData  Json?         @map("channel_raw_data")

  // 渠道标准化属性
  channelAttributes Json?       @map("channel_attributes")

  // 平台类目（可预设）
  platformCategoryId String?    @map("platform_category_id")

  // 时间戳
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // 关联
  channel         Channel       @relation("ProductPool", fields: [channelId], references: [id])
  listingProducts ListingProduct[] @relation("PoolToListing")

  @@unique([channelId, sku])
  @@map("product_pool")
}

// ==================== 刊登商品（关联商品池 + 店铺）====================
model ListingProduct {
  id              String        @id @default(uuid())
  shopId          String        @map("shop_id")
  productPoolId   String?       @map("product_pool_id")  // 关联商品池（可选）
  channelId       String        @map("channel_id")

  // 基本信息（可从商品池继承或独立设置）
  sku             String        @db.VarChar(100)
  title           String        @db.VarChar(500)
  description     String?       @db.Text

  // 图片
  mainImageUrl    String?       @map("main_image_url")
  imageUrls       Json?         @map("image_urls")
  videoUrls       Json?         @map("video_urls")

  // 价格库存（店铺可独立设置）
  price           Decimal       @db.Decimal(10, 2)
  stock           Int           @default(0)
  currency        String        @default("USD") @db.VarChar(10)

  // 渠道原始数据
  channelRawData  Json?         @map("channel_raw_data")

  // 渠道标准化属性
  channelAttributes Json?       @map("channel_attributes")

  // 平台类目映射
  platformCategoryId String?    @map("platform_category_id")

  // 平台属性填写值（店铺特定）
  platformAttributes Json?      @map("platform_attributes")

  // 平台特有字段
  platformSpecificData Json?    @map("platform_specific_data")

  // 属性映射配置
  attributeMapping Json?        @map("attribute_mapping")

  // AI 优化数据
  aiOptimizedData Json?         @map("ai_optimized_data")
  useAiOptimized  Boolean       @default(false) @map("use_ai_optimized")

  // 刊登状态
  listingStatus   ListingStatus @default(draft) @map("listing_status")
  platformItemId  String?       @map("platform_item_id") @db.VarChar(100)
  lastListedAt    DateTime?     @map("last_listed_at")
  listingError    String?       @map("listing_error")

  // 时间戳
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // 关联
  shop            Shop          @relation("ListingProducts", fields: [shopId], references: [id], onDelete: Cascade)
  channel         Channel       @relation("ListingProducts", fields: [channelId], references: [id])
  productPool     ProductPool?  @relation("PoolToListing", fields: [productPoolId], references: [id])

  @@unique([shopId, sku])
  @@map("listing_products")
}

model PlatformCategory {
  id              String              @id @default(uuid())
  platformId      String              @map("platform_id")
  country         String              @default("US") @db.VarChar(10)  // 国家代码，同平台不同国家类目独立

  categoryId      String              @map("category_id") @db.VarChar(100)
  categoryPath    String              @map("category_path") @db.VarChar(500)
  name            String              @db.VarChar(200)
  parentId        String?             @map("parent_id") @db.VarChar(100)
  level           Int                 @default(0)
  isLeaf          Boolean             @default(false) @map("is_leaf")

  // Walmart 特有字段（Product Type Group / Product Type）
  productTypeGroupId    String?       @map("product_type_group_id") @db.VarChar(200)
  productTypeGroupName  String?       @map("product_type_group_name") @db.VarChar(255)
  productTypeId         String?       @map("product_type_id") @db.VarChar(200)
  productTypeName       String?       @map("product_type_name") @db.VarChar(255)

  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  platform        Platform            @relation(fields: [platformId], references: [id], onDelete: Cascade)
  attributes      PlatformAttribute[]

  @@unique([platformId, country, categoryId])  // 同平台同国家下类目ID唯一
  @@index([platformId, country])               // 按平台+国家查询索引
  @@map("platform_categories")
}

model PlatformAttribute {
  id              String           @id @default(uuid())
  categoryId      String           @map("category_id")
  country         String           @default("US") @db.VarChar(10)  // 冗余存储国家，便于查询

  attributeId     String           @map("attribute_id") @db.VarChar(100)
  name            String           @db.VarChar(200)
  description     String?
  dataType        String           @map("data_type") @db.VarChar(50)
  isRequired      Boolean          @default(false) @map("is_required")
  isMultiSelect   Boolean          @default(false) @map("is_multi_select")
  maxLength       Int?             @map("max_length")
  enumValues      Json?            @map("enum_values")

  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  category        PlatformCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, attributeId])
  @@index([country])
  @@map("platform_attributes")
}

model ListingTask {
  id              String            @id @default(uuid())
  shopId          String            @map("shop_id")

  status          ListingTaskStatus @default(pending)
  totalCount      Int               @default(0) @map("total_count")
  successCount    Int               @default(0) @map("success_count")
  failCount       Int               @default(0) @map("fail_count")

  productIds      Json              @map("product_ids")
  results         Json?

  startedAt       DateTime          @default(now()) @map("started_at")
  finishedAt      DateTime?         @map("finished_at")
  createdAt       DateTime          @default(now()) @map("created_at")

  shop            Shop              @relation("ListingTasks", fields: [shopId], references: [id], onDelete: Cascade)

  @@map("listing_tasks")
}

enum ListingStatus {
  draft
  pending
  submitting
  listed
  failed
  updating
}

enum ListingTaskStatus {
  pending
  running
  completed
  failed
}

// ==================== 类目属性映射配置 ====================

model CategoryAttributeMapping {
  id              String   @id @default(uuid())
  platformId      String   @map("platform_id")
  categoryId      String   @map("category_id")  // 平台类目ID（非数据库ID）
  country         String   @default("US") @db.VarChar(10)
  
  // 映射规则 JSON 结构
  // {
  //   "rules": [
  //     {
  //       "attributeId": "brand",
  //       "attributeName": "品牌",
  //       "mappingType": "default_value" | "channel_data" | "enum_select" | "auto_generate",
  //       "value": "默认值或渠道字段路径",
  //       "isRequired": true,
  //       "dataType": "string"
  //     }
  //   ]
  // }
  mappingRules    Json     @map("mapping_rules")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  platform        Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  
  @@unique([platformId, country, categoryId])
  @@index([platformId, country])
  @@map("category_attribute_mappings")
}

enum AttributeMappingType {
  default_value   // 使用固定默认值
  channel_data    // 从渠道商品数据提取
  enum_select     // 从平台枚举值选择
  auto_generate   // 自动生成
}

// ==================== UPC 池管理 ====================

model UpcPool {
  id              String    @id @default(uuid())
  upcCode         String    @unique @map("upc_code") @db.VarChar(20)
  isUsed          Boolean   @default(false) @map("is_used")
  productSku      String?   @map("product_sku") @db.VarChar(100)  // 关联的商品 SKU
  shopId          String?   @map("shop_id")                        // 关联的店铺
  usedAt          DateTime? @map("used_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([isUsed])
  @@index([shopId])
  @@map("upc_pool")
}


// ==================== AI 优化模块 ====================

// AI 模型配置（一个渠道配置，包含多个模型）
model AiModel {
  id              String        @id @default(uuid())
  name            String        @db.VarChar(100)  // 渠道名称，如"中转接口"
  type            AiModelType   // openai, gemini, openai_compatible
  
  // 连接配置
  apiKey          String        @map("api_key") @db.VarChar(500)
  baseUrl         String?       @map("base_url") @db.VarChar(255)  // OpenAI 兼容接口需要
  
  // 兼容旧字段（单个模型）
  modelName       String?       @map("model_name") @db.VarChar(100)
  
  // 模型列表（JSON数组）
  // 格式: [{ "id": "gpt-4", "name": "gpt-4", "maxTokens": 8192 }, ...]
  modelList       Json          @default("[]") @map("model_list")
  
  // 默认模型（从 modelList 中选一个）
  defaultModel    String?       @map("default_model") @db.VarChar(100)
  
  // 默认参数
  maxTokens       Int           @default(2000) @map("max_tokens")
  temperature     Decimal       @default(0.7) @db.Decimal(3, 2)
  
  // 状态
  isDefault       Boolean       @default(false) @map("is_default")
  status          Status        @default(active)
  
  // 时间戳
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  // 关联
  optimizationLogs AiOptimizationLog[]
  
  @@map("ai_models")
}

enum AiModelType {
  openai
  gemini
  openai_compatible
}

// Prompt 模板
model PromptTemplate {
  id              String        @id @default(uuid())
  name            String        @db.VarChar(100)
  type            PromptType    // title, description, bullet_points, keywords, general
  content         String        @db.Text
  description     String?       @db.VarChar(500)
  
  // 是否系统预设
  isSystem        Boolean       @default(false) @map("is_system")
  isDefault       Boolean       @default(false) @map("is_default")
  
  // 状态
  status          Status        @default(active)
  
  // 时间戳
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  // 关联
  optimizationLogs AiOptimizationLog[]
  
  @@map("prompt_templates")
}

enum PromptType {
  title
  description
  bullet_points
  keywords
  general
}

// AI 优化日志
model AiOptimizationLog {
  id              String              @id @default(uuid())
  
  // 关联商品
  productType     String              @map("product_type") @db.VarChar(20) // pool, listing
  productId       String              @map("product_id")
  productSku      String              @map("product_sku") @db.VarChar(100)
  
  // 优化配置
  modelId         String              @map("model_id")
  templateId      String?             @map("template_id")
  field           String              @db.VarChar(50) // title, description, bullet_points, keywords
  
  // 内容
  originalContent String?             @map("original_content") @db.Text
  optimizedContent String?            @map("optimized_content") @db.Text
  promptUsed      String?             @map("prompt_used") @db.Text
  
  // 统计
  promptTokens    Int                 @default(0) @map("prompt_tokens")
  completionTokens Int                @default(0) @map("completion_tokens")
  totalTokens     Int                 @default(0) @map("total_tokens")
  duration        Int                 @default(0) // 毫秒
  
  // 状态
  status          AiOptLogStatus      @default(pending)
  errorMessage    String?             @map("error_message")
  
  // 是否已应用
  isApplied       Boolean             @default(false) @map("is_applied")
  appliedAt       DateTime?           @map("applied_at")
  
  // 时间戳
  createdAt       DateTime            @default(now()) @map("created_at")
  
  // 关联
  model           AiModel             @relation(fields: [modelId], references: [id])
  template        PromptTemplate?     @relation(fields: [templateId], references: [id])
  
  @@index([productType, productId])
  @@index([status])
  @@index([createdAt])
  @@map("ai_optimization_logs")
}

enum AiOptLogStatus {
  pending
  processing
  completed
  failed
}

// ==================== 刊登日志模块 ====================

// 刊登日志（详细记录每次刊登操作）
model ListingLog {
  id              String            @id @default(uuid())
  shopId          String            @map("shop_id")
  
  // 操作类型
  action          ListingLogAction  // submit, validate, retry
  
  // 商品信息
  productId       String?           @map("product_id")
  productSku      String?           @map("product_sku") @db.VarChar(100)
  
  // 请求数据
  requestData     Json?             @map("request_data")
  
  // 响应数据
  responseData    Json?             @map("response_data")
  
  // 状态
  status          ListingLogStatus  @default(pending)
  errorMessage    String?           @map("error_message") @db.Text
  errorCode       String?           @map("error_code") @db.VarChar(50)
  
  // 关联 Feed
  feedId          String?           @map("feed_id") @db.VarChar(100)
  
  // 耗时（毫秒）
  duration        Int               @default(0)
  
  // 时间戳
  createdAt       DateTime          @default(now()) @map("created_at")
  
  // 关联
  shop            Shop              @relation("ListingLogs", fields: [shopId], references: [id], onDelete: Cascade)
  
  @@index([shopId])
  @@index([productSku])
  @@index([status])
  @@index([createdAt])
  @@map("listing_logs")
}

enum ListingLogAction {
  submit      // 提交刊登
  validate    // 验证
  retry       // 重试
  update      // 更新
}

enum ListingLogStatus {
  pending     // 待处理
  processing  // 处理中
  success     // 成功
  failed      // 失败
}

// 刊登 Feed 记录（批量刊登的 Feed 跟踪）
model ListingFeedRecord {
  id              String              @id @default(uuid())
  shopId          String              @map("shop_id")
  
  // Feed 信息
  feedId          String              @map("feed_id") @db.VarChar(100)
  feedType        String              @default("item") @map("feed_type") @db.VarChar(50) // item, MP_ITEM
  
  // 商品数量
  itemCount       Int                 @default(0) @map("item_count")
  
  // 状态
  status          ListingFeedStatus   @default(RECEIVED)
  successCount    Int                 @default(0) @map("success_count")
  failCount       Int                 @default(0) @map("fail_count")
  
  // 错误信息
  errorMessage    String?             @map("error_message") @db.Text
  
  // 详情数据（缓存 Walmart API 返回的详情）
  feedDetail      Json?               @map("feed_detail")
  
  // 提交的数据（用于追踪）
  submittedData   Json?               @map("submitted_data")
  
  // 关联的商品 ID 列表
  productIds      Json?               @map("product_ids")
  
  // 时间戳
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  completedAt     DateTime?           @map("completed_at")
  
  // 关联
  shop            Shop                @relation("ListingFeedRecords", fields: [shopId], references: [id], onDelete: Cascade)
  
  @@unique([shopId, feedId])
  @@index([status])
  @@index([createdAt])
  @@map("listing_feed_records")
}

enum ListingFeedStatus {
  RECEIVED      // 已接收
  INPROGRESS    // 处理中
  PROCESSED     // 已完成
  ERROR         // 失败
}


// ==================== 图片处理模块 ====================

// 图片处理参数配置
model ImageProcessConfig {
  id              String    @id @default(uuid())
  name            String    @default("默认配置") @db.VarChar(100)
  
  // 文件大小限制（MB）
  maxSizeMB       Decimal   @default(5) @map("max_size_mb") @db.Decimal(5, 2)
  
  // 图片比例要求
  forceSquare     Boolean   @default(true) @map("force_square")  // 强制1:1
  aspectRatio     String?   @map("aspect_ratio") @db.VarChar(20) // 如 "1:1", "4:3"
  
  // 目标尺寸
  targetWidth     Int       @default(2000) @map("target_width")
  targetHeight    Int?      @map("target_height")
  
  // 输出格式
  outputFormat    String    @default("jpeg") @map("output_format") @db.VarChar(10)
  quality         Int       @default(85)
  
  // 是否默认配置
  isDefault       Boolean   @default(false) @map("is_default")
  
  // 时间戳
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // 关联
  tasks           ImageProcessTask[]
  
  @@map("image_process_configs")
}

// 图片处理任务
model ImageProcessTask {
  id              String              @id @default(uuid())
  
  // 任务名称
  name            String              @db.VarChar(200)
  
  // 处理范围
  scope           ImageProcessScope   // all, category, sku_list
  scopeValue      String?             @map("scope_value") @db.Text  // 类目ID 或 SKU列表(JSON)
  
  // 配置
  configId        String?             @map("config_id")
  
  // 统计
  totalCount      Int                 @default(0) @map("total_count")
  processedCount  Int                 @default(0) @map("processed_count")
  successCount    Int                 @default(0) @map("success_count")
  failCount       Int                 @default(0) @map("fail_count")
  skippedCount    Int                 @default(0) @map("skipped_count")
  
  // 状态
  status          ImageTaskStatus     @default(pending)
  errorMessage    String?             @map("error_message") @db.Text
  
  // 时间戳
  startedAt       DateTime?           @map("started_at")
  finishedAt      DateTime?           @map("finished_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  
  // 关联
  config          ImageProcessConfig? @relation(fields: [configId], references: [id])
  logs            ImageProcessLog[]
  
  @@index([status])
  @@index([createdAt])
  @@map("image_process_tasks")
}

// 图片处理日志（每张图片的处理记录）
model ImageProcessLog {
  id              String              @id @default(uuid())
  taskId          String              @map("task_id")
  
  // 商品信息
  productPoolId   String?             @map("product_pool_id")
  productSku      String              @map("product_sku") @db.VarChar(100)
  
  // 图片信息
  imageType       String              @map("image_type") @db.VarChar(20)  // main, additional
  imageIndex      Int                 @default(0) @map("image_index")     // 附图索引
  originalUrl     String              @map("original_url") @db.Text
  
  // 原始图片信息
  originalSize    Int                 @default(0) @map("original_size")   // 字节
  originalWidth   Int                 @default(0) @map("original_width")
  originalHeight  Int                 @default(0) @map("original_height")
  
  // 处理后信息
  processedUrl    String?             @map("processed_url") @db.Text
  processedSize   Int?                @map("processed_size")
  processedWidth  Int?                @map("processed_width")
  processedHeight Int?                @map("processed_height")
  
  // 处理操作
  operations      Json?               // ["裁剪为1:1", "压缩至85%"]
  wasProcessed    Boolean             @default(false) @map("was_processed")
  
  // 状态
  status          ImageLogStatus      @default(pending)
  errorMessage    String?             @map("error_message")
  
  // 时间戳
  createdAt       DateTime            @default(now()) @map("created_at")
  
  // 关联
  task            ImageProcessTask    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@index([taskId])
  @@index([productSku])
  @@index([status])
  @@map("image_process_logs")
}

enum ImageProcessScope {
  all           // 所有商品
  category      // 按平台类目
  sku_list      // SKU列表
}

enum ImageTaskStatus {
  pending       // 待开始
  running       // 运行中
  paused        // 已暂停
  completed     // 已完成
  failed        // 失败
  cancelled     // 已取消
}

enum ImageLogStatus {
  pending       // 待处理
  processing    // 处理中
  success       // 成功
  failed        // 失败
  skipped       // 跳过（不需要处理）
}

// ==================== 不可售平台配置 ====================

// 不可售平台（从渠道商品中自动收集）
model UnavailablePlatform {
  id              String    @id @default(uuid())
  platformId      String    @map("platform_id") @db.VarChar(50)  // 渠道返回的平台ID
  platformName    String    @map("platform_name") @db.VarChar(100)  // 平台名称
  channelId       String?   @map("channel_id")  // 来源渠道
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@unique([platformId, channelId])
  @@map("unavailable_platforms")
}
