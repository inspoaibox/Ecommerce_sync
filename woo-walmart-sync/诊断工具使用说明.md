# 诊断工具使用说明

## 📋 问题描述

当产品同步到 Walmart 时，出现以下错误：

```
[field] => sofa_and_loveseat_design
[description] => `sofa_and_loveseat_design` is a required attribute. 
                 Enter value for the attribute `sofa_and_loveseat_design`.
```

## 🔍 问题原因

**核心问题**：分类映射表中没有配置 `sofa_and_loveseat_design` 字段

即使代码中有字段定义和生成逻辑，如果分类映射表中没有配置该字段，字段也不会被传递到 Walmart API。

---

## 🛠️ 诊断工具

### **diagnose-sofa-design-universal.php**

**用途**：检查代码和配置，诊断字段缺失的原因

**特点**：
- ✅ 自动检测 WordPress 路径
- ✅ 适用于任何服务器
- ✅ 不需要修改代码
- ✅ 检查代码版本和配置状态

---

## 📝 使用步骤

### **步骤1: 上传诊断脚本**

1. 下载 `diagnose-sofa-design-universal.php` 文件
2. 通过 FTP 或文件管理器上传到服务器
3. 上传路径：`/wp-content/plugins/woo-walmart-sync/`

### **步骤2: 运行诊断脚本**

#### **方法1: SSH 命令行（推荐）**

```bash
cd /home/aokede.com/public_html/wp-content/plugins/woo-walmart-sync
php diagnose-sofa-design-universal.php
```

#### **方法2: 浏览器访问**

如果服务器不支持 SSH，可以创建一个临时的 Web 访问脚本：

1. 创建文件 `diagnose-web.php`：

```php
<?php
// 临时诊断页面 - 使用后请删除
header('Content-Type: text/plain; charset=utf-8');

// 安全检查：只允许管理员访问
if (!isset($_GET['key']) || $_GET['key'] !== 'your-secret-key-here') {
    die('Access denied');
}

include 'diagnose-sofa-design-universal.php';
?>
```

2. 上传到插件目录
3. 浏览器访问：`https://aokede.com/wp-content/plugins/woo-walmart-sync/diagnose-web.php?key=your-secret-key-here`
4. **使用后立即删除此文件！**

### **步骤3: 查看诊断结果**

诊断脚本会输出以下检查结果：

#### **✅ 代码检查（应该全部通过）**

```
【检查1: v5_common_attributes 配置】
✅ sofa_and_loveseat_design 已在 v5_common_attributes 中定义
✅ sofa_and_loveseat_design 已在 autoGenerateFields 数组中

【检查2: generate_special_attribute_value 方法】
✅ generate_special_attribute_value 中有 sofa_and_loveseat_design case

【检查3: extract_sofa_loveseat_design 方法】
✅ extract_sofa_loveseat_design 方法存在
✅ 方法包含默认值返回逻辑

【检查4: convert_field_data_type 方法】
✅ convert_field_data_type 中有 sofa_and_loveseat_design case

【检查5: 测试字段生成逻辑】
✅ 通过 - 正确返回默认值
```

#### **❌ 配置检查（可能显示问题）**

```
【检查6: 查看分类映射配置】
❌ 未配置 sofa_and_loveseat_design
   🔧 需要在分类映射页面点击「重置属性」按钮
```

---

## 🔧 解决方案

### **情况1: 代码检查全部通过，但配置检查失败**

**原因**：分类映射表中没有配置字段

**解决步骤**：

1. 登录 WordPress 后台
2. 进入 **Walmart 同步** → **分类映射** 页面
3. 找到沙发相关的分类映射（诊断结果中会列出）
4. 点击该分类的 **「重置属性」** 按钮
5. 等待页面刷新，系统会重新加载所有字段
6. 确认 `sofa_and_loveseat_design` 字段出现在字段列表中
7. 检查字段配置：
   - **映射类型**: 自动生成
   - **来源**: （留空）
   - **必填**: 是
8. 点击 **「保存」** 按钮
9. 重新运行诊断脚本验证
10. 重新同步失败的产品

### **情况2: 代码检查失败**

**原因**：服务器上的代码版本过旧

**解决步骤**：

1. 从开发环境下载最新的代码文件：
   - `woo-walmart-sync.php`
   - `includes/class-product-mapper.php`

2. 通过 FTP 上传到服务器，覆盖旧文件

3. 重新运行诊断脚本，确认代码检查通过

4. 然后执行「情况1」的解决步骤

---

## ✅ 验证修复

### **步骤1: 重新运行诊断脚本**

```bash
php diagnose-sofa-design-universal.php
```

**期望结果**：

```
【检查6: 查看分类映射配置】
✅ 已配置 sofa_and_loveseat_design
   类型: auto_generate
   来源: (空)
```

### **步骤2: 重新同步产品**

1. 在 WordPress 后台找到之前失败的产品
2. SKU: W714P357249, W487S00390, WF310165AAA
3. 点击 **「重新同步」** 按钮
4. 查看同步日志

**期望结果**：

- ✅ 产品同步成功
- ✅ 没有 `sofa_and_loveseat_design` 缺失错误
- ✅ 字段值为 `["Mid-Century Modern"]` 或其他匹配的设计风格

---

## 📊 诊断结果解读

### **检查1-5: 代码层面检查**

| 检查项 | 说明 | 如果失败 |
|--------|------|----------|
| v5_common_attributes | 字段是否在配置数组中定义 | 更新 woo-walmart-sync.php |
| autoGenerateFields | 字段是否在自动生成列表中 | 更新 woo-walmart-sync.php |
| generate_special_attribute_value | 字段生成入口是否存在 | 更新 class-product-mapper.php |
| extract_sofa_loveseat_design | 字段提取方法是否存在 | 更新 class-product-mapper.php |
| convert_field_data_type | 类型转换逻辑是否存在 | 更新 class-product-mapper.php |

### **检查6: 配置层面检查**

| 状态 | 说明 | 解决方案 |
|------|------|----------|
| ✅ 已配置 | 字段在分类映射中正确配置 | 无需操作 |
| ❌ 未配置 | 字段不在分类映射中 | 重置属性 |
| ❌ 没有找到分类 | 没有沙发相关的分类映射 | 创建分类映射 |

---

## 🚨 常见问题

### **Q1: 重置属性后，字段还是没有出现？**

**A**: 可能是代码版本问题

1. 检查诊断结果的「检查1-4」
2. 如果显示 ❌，说明代码未更新
3. 上传最新的代码文件
4. 再次重置属性

### **Q2: 字段出现了，但同步还是失败？**

**A**: 检查字段配置

1. 确认字段类型是「自动生成」
2. 确认来源字段为空
3. 查看同步日志中的「产品映射」步骤
4. 确认字段值不是 null

### **Q3: 诊断脚本无法运行？**

**A**: 检查 PHP 版本和权限

```bash
# 检查 PHP 版本（需要 7.0+）
php -v

# 检查文件权限
ls -l diagnose-sofa-design-universal.php

# 如果权限不足，添加执行权限
chmod +x diagnose-sofa-design-universal.php
```

### **Q4: 其他字段也缺失怎么办？**

**A**: 同样的解决方案

错误信息中列出的其他缺失字段：
- `color`
- `has_written_warranty`
- `assembledProductHeight`
- `seat_depth`
- `ageGroup`
- `shortDescription`
- `keyFeatures`
- `isAssemblyRequired`
- `assembledProductWidth`

这些字段缺失的原因也是分类映射配置问题，解决方案相同：**重置属性**。

---

## 📞 技术支持

如果按照上述步骤操作后问题仍未解决，请提供以下信息：

1. 诊断脚本的完整输出
2. 同步日志中的错误信息
3. 产品的 SKU 和分类信息
4. 服务器环境信息（PHP 版本、WordPress 版本）

---

## 🗑️ 清理

诊断完成后，建议删除诊断脚本：

```bash
rm diagnose-sofa-design-universal.php
rm diagnose-web.php  # 如果创建了 Web 访问版本
```

或通过 FTP/文件管理器删除这些文件。

---

## 📝 总结

**问题**：`sofa_and_loveseat_design` 字段缺失

**原因**：分类映射表中没有配置该字段

**解决**：在分类映射页面点击「重置属性」按钮

**验证**：重新运行诊断脚本，确认字段已配置

**结果**：产品同步成功，不再报错

---

**最后更新**: 2025-10-13

