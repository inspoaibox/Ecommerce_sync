# 诊断脚本使用指南

## 📋 问题背景

在服务器 aokede.com 上，产品同步到 Walmart 时报错：

```
[field] => sofa_and_loveseat_design
[description] => `sofa_and_loveseat_design` is a required attribute.
```

**已确认的信息**：
- ✅ 代码层面：字段定义和生成逻辑都正确
- ✅ 配置层面：字段已在分类映射中配置
- ✅ 字段类型：auto_generate
- ❓ **问题**：为什么配置后还是报错？

---

## 🔍 诊断脚本

### **diagnose-actual-problem.php**

**用途**：深度诊断字段映射的完整流程，找出字段在哪一步被过滤掉

**检查内容**：
1. ✅ 分类映射配置是否正确
2. ✅ 字段类型是否为 auto_generate
3. ✅ generate_special_attribute_value 返回值
4. ✅ convert_field_data_type 转换结果
5. ✅ is_empty_field_value 空值检查
6. ✅ Line 526 过滤条件
7. ✅ 最终映射数据中是否包含字段

---

## 📝 使用步骤

### **步骤1: 上传脚本到服务器**

```bash
# 通过 SCP 上传
scp diagnose-actual-problem.php user@aokede.com:/home/aokede.com/public_html/wp-content/plugins/woo-walmart-sync/
```

或通过 FTP/文件管理器上传到：
```
/home/aokede.com/public_html/wp-content/plugins/woo-walmart-sync/
```

### **步骤2: 运行诊断脚本**

#### **方法1: 自动查找沙发分类（推荐）**

```bash
ssh user@aokede.com
cd /home/aokede.com/public_html/wp-content/plugins/woo-walmart-sync
php diagnose-actual-problem.php
```

脚本会自动查找第一个沙发相关的分类映射。

#### **方法2: 指定分类映射 ID**

如果你知道具体的分类映射 ID（例如 144）：

```bash
php diagnose-actual-problem.php 144
```

### **步骤3: 查看诊断结果**

脚本会输出详细的诊断信息，包括：

```
=== 检查 sofa_and_loveseat_design 字段实际问题 ===

【步骤1: 获取分类映射配置】
✅ 找到字段配置:
  名称: sofa_and_loveseat_design
  类型: auto_generate
  来源: (空)

【步骤2: 获取测试产品】
使用产品 ID: 12345
产品名称: Modern Sofa
产品 SKU: W714P357249

【步骤3: 测试字段生成】
调用 generate_special_attribute_value('sofa_and_loveseat_design', product, 1)
返回值: ["Mid-Century Modern"]
类型: array
✅ 返回值正常

【步骤4: 测试类型转换】
调用 convert_field_data_type('sofa_and_loveseat_design', value, null)
输入值: ["Mid-Century Modern"]
输出值: ["Mid-Century Modern"]
类型: array
✅ 转换后正常

【步骤5: 测试空值检查】
调用 is_empty_field_value(value)
输入值: ["Mid-Century Modern"]
结果: false (非空)
✅ 被判断为非空值

【步骤6: 测试 Line 526 的完整条件】
条件1: ! is_null($value) = true
条件2: ! is_empty_field_value($value) = true
最终结果: true (字段会被添加)
✅ 字段会通过检查，被添加到映射数据中

【步骤7: 测试完整映射流程】
调用 map_product_to_walmart_format(product, 1)
✅ 字段存在于最终映射数据中
路径: MPItem[0]['Visible']['Sofas & Couches']['sofa_and_loveseat_design']
值: ["Mid-Century Modern"]

🎉 字段映射成功！如果同步还是失败，问题可能在其他地方。
```

---

## 🔴 可能的诊断结果

### **结果1: 字段未在分类映射中配置**

```
❌ 字段未在分类映射中配置
这就是问题所在！需要在分类映射页面重置属性。
```

**解决方案**：
1. 登录 WordPress 后台
2. 进入「Walmart 同步」→「分类映射」
3. 找到沙发分类
4. 点击「重置属性」
5. 保存配置

---

### **结果2: 字段类型配置错误**

```
⚠️ 警告：字段类型不是 'auto_generate'，而是 'default_value'
```

**解决方案**：
1. 在分类映射页面找到 sofa_and_loveseat_design 字段
2. 将类型改为「自动生成」
3. 保存配置

---

### **结果3: 字段值被判断为空**

```
❌ 返回值为 null！
   这会导致字段被过滤掉（Line 526 的条件）
```

或

```
❌ 返回值为空数组！
   这会被 is_empty_field_value() 判断为空（Line 2079）
```

**可能的原因**：
1. `extract_sofa_loveseat_design` 方法返回了 null
2. `convert_field_data_type` 方法返回了 null 或空数组
3. 代码逻辑有问题

**解决方案**：
1. 检查代码是否是最新版本
2. 查看 `extract_sofa_loveseat_design` 方法的实现
3. 确认默认值逻辑是否正确

---

### **结果4: 字段在映射过程中被过滤**

```
❌ 字段不存在于最终映射数据中
   这就是问题所在！
```

**可能的原因**：
1. 产品的分类没有正确关联到分类映射
2. 映射逻辑中有其他过滤条件
3. 字段名称大小写不匹配

**解决方案**：
1. 检查产品是否属于正确的分类
2. 查看同步日志中的详细信息
3. 检查 `map_product_to_walmart_format` 方法的完整逻辑

---

### **结果5: 字段映射正常**

```
✅ 字段存在于最终映射数据中
🎉 字段映射成功！如果同步还是失败，问题可能在其他地方。
```

**如果同步还是失败，可能的原因**：
1. API 请求发送时字段被过滤
2. 其他必填字段缺失导致整个请求失败
3. 网络或 API 问题

**建议**：
1. 查看完整的同步日志
2. 检查 API 响应中的详细错误信息
3. 确认其他必填字段都已配置

---

## 🔧 关键代码位置

### **Line 526: 字段过滤条件**

```php
// includes/class-product-mapper.php Line 526
if ( ! is_null( $value ) && ! $this->is_empty_field_value( $value ) ) {
    // 添加字段到映射数据
} else {
    // 跳过字段
}
```

**说明**：
- 如果 `$value` 为 null，字段会被过滤
- 如果 `is_empty_field_value()` 返回 true，字段会被过滤

### **Line 2079: 空数组判断**

```php
// includes/class-product-mapper.php Line 2079
if ( is_array( $value ) && empty( $value ) ) {
    return true;  // 判断为空
}
```

**说明**：
- 空数组 `[]` 会被判断为空值
- 但 `['Mid-Century Modern']` 不是空数组，不会被过滤

---

## 📊 诊断流程图

```
产品 → 获取分类映射
       ↓
    字段配置存在？
       ↓ 是
    字段类型 = auto_generate？
       ↓ 是
    generate_special_attribute_value()
       ↓
    返回值 = ["Mid-Century Modern"]
       ↓
    convert_field_data_type()
       ↓
    转换后 = ["Mid-Century Modern"]
       ↓
    is_empty_field_value()
       ↓
    结果 = false (非空)
       ↓
    Line 526 条件检查
       ↓
    ! is_null($value) && ! is_empty = true
       ↓
    添加到映射数据
       ↓
    MPItem[0]['Visible']['Sofas & Couches']['sofa_and_loveseat_design']
       ↓
    传递到 Walmart API
```

---

## 🚨 常见问题

### **Q1: 脚本提示找不到分类映射？**

**A**: 使用方法2，指定分类映射 ID

```bash
# 先查看所有分类映射
php diagnose-actual-problem.php

# 输出会显示可用的分类映射
# 然后使用具体的 ID
php diagnose-actual-problem.php 144
```

### **Q2: 脚本提示找不到产品？**

**A**: 脚本会自动创建测试产品，不影响诊断结果

### **Q3: 诊断显示字段正常，但同步还是失败？**

**A**: 问题可能在其他地方：

1. **检查其他缺失字段**：错误信息中还有其他9个缺失字段
2. **查看完整的同步日志**：可能有其他错误
3. **检查 API 请求**：字段可能在发送前被过滤

### **Q4: 如何查看同步日志？**

**A**: 在 WordPress 后台：

1. 进入「Walmart 同步」→「同步日志」
2. 找到失败的同步记录
3. 查看详细的错误信息和请求数据

---

## 📞 下一步操作

根据诊断结果：

1. **如果字段未配置** → 重置属性
2. **如果字段类型错误** → 修改为 auto_generate
3. **如果字段值为空** → 检查代码版本
4. **如果字段被过滤** → 检查产品分类
5. **如果字段正常** → 检查其他缺失字段

---

## 🗑️ 清理

诊断完成后，删除脚本：

```bash
rm diagnose-actual-problem.php
```

或通过 FTP/文件管理器删除。

---

**最后更新**: 2025-10-13

