<?php
/**
 * Plugin Name: Woo Walmart Sync
 * Description: å–å®¶è‡ªç”¨ï¼ŒWooCommerceå•†å“åŒæ­¥åˆ°æ²ƒå°”ç›ï¼ŒAPI Keyç›´è¿ï¼Œæ— éœ€OAuthæˆæƒ
 * Version: 2.0.0
 * Author: ä½ çš„åå­—
 * Text Domain: woo-walmart-sync
 */

if ( ! defined( 'ABSPATH' ) ) exit;

define( 'WOO_WALMART_SYNC_PATH', plugin_dir_path( __FILE__ ) );
define( 'WOO_WALMART_SYNC_URL', plugin_dir_url( __FILE__ ) );

// å…¨å±€æ—¥å¿—è®°å½•å‡½æ•° - å¿…é¡»åœ¨æ‰€æœ‰å…¶ä»–ä»£ç ä¹‹å‰å®šä¹‰
function woo_walmart_sync_log($action, $status, $request = '', $response = '', $product_id = null) {
    global $wpdb;
    $table_name = $wpdb->prefix . 'woo_walmart_sync_logs';

    // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è·³è¿‡æ—¥å¿—è®°å½•ï¼ˆé¿å…æ¿€æ´»æ—¶é”™è¯¯ï¼‰
    if ($wpdb->get_var("SHOW TABLES LIKE '$table_name'") != $table_name) {
        return;
    }

    $wpdb->insert(
        $table_name,
        [
            'created_at' => current_time('mysql'),
            'action'     => $action,
            'status'     => $status,
            'request'    => is_string($request) ? $request : wp_json_encode($request, JSON_UNESCAPED_UNICODE),
            'response'   => is_string($response) ? $response : wp_json_encode($response, JSON_UNESCAPED_UNICODE),
            'product_id' => $product_id,
        ]
    );
}

// å¼•å…¥æ ¸å¿ƒç±»
require_once WOO_WALMART_SYNC_PATH . 'includes/class-api-key-auth.php';
require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-spec-service.php';
require_once WOO_WALMART_SYNC_PATH . 'includes/class-product-mapper.php';
require_once WOO_WALMART_SYNC_PATH . 'includes/class-product-sync.php';
require_once WOO_WALMART_SYNC_PATH . 'includes/class-inventory-manager.php';

// å¼•å…¥å¤šå¸‚åœºæ”¯æŒç±»
require_once WOO_WALMART_SYNC_PATH . 'includes/class-multi-market-config.php';
require_once WOO_WALMART_SYNC_PATH . 'includes/class-multi-market-data-manager.php';
require_once WOO_WALMART_SYNC_PATH . 'includes/class-multi-market-api-router.php';

// åˆå§‹åŒ–åº“å­˜ç®¡ç†å™¨
add_action('plugins_loaded', function() {
    if (class_exists('WooWalmartSync_Inventory_Manager')) {
        new WooWalmartSync_Inventory_Manager();
    }
});

// ç§»é™¤WordPressç‰ˆæœ¬ä¿¡æ¯å’Œé¡µè„šæ–‡æœ¬
add_filter('admin_footer_text', '__return_empty_string', 11);
add_filter('update_footer', '__return_empty_string', 11);

// æ³¨å†Œå»¶è¿Ÿåº“å­˜åŒæ­¥é’©å­
add_action('walmart_delayed_inventory_sync', 'handle_delayed_inventory_sync', 10, 3);

/**
 * å¤„ç†å»¶è¿Ÿåº“å­˜åŒæ­¥
 * @param int $product_id å•†å“ID
 * @param string $walmart_sku Walmart SKU
 * @param string $feed_id Feed ID
 */
function handle_delayed_inventory_sync($product_id, $walmart_sku, $feed_id) {
    woo_walmart_sync_log('å»¶è¿Ÿåº“å­˜åŒæ­¥', 'å¼€å§‹', [
        'product_id' => $product_id,
        'walmart_sku' => $walmart_sku,
        'feed_id' => $feed_id
    ], "å¼€å§‹æ‰§è¡Œå»¶è¿Ÿåº“å­˜åŒæ­¥");

    // é¦–å…ˆæ£€æŸ¥FeedçŠ¶æ€ï¼Œç¡®ä¿å•†å“å·²ç»å¤„ç†å®Œæˆ
    $api_auth = new Woo_Walmart_API_Key_Auth();
    $endpoint = "/v3/feeds/{$feed_id}?includeDetails=true";
    $feed_result = $api_auth->make_request($endpoint);

    if (is_wp_error($feed_result)) {
        woo_walmart_sync_log('å»¶è¿Ÿåº“å­˜åŒæ­¥', 'å¤±è´¥', [
            'product_id' => $product_id,
            'walmart_sku' => $walmart_sku,
            'feed_id' => $feed_id,
            'error' => $feed_result->get_error_message()
        ], "FeedçŠ¶æ€æ£€æŸ¥å¤±è´¥: " . $feed_result->get_error_message());
        return;
    }

    $feed_status = $feed_result['feedStatus'] ?? 'UNKNOWN';

    woo_walmart_sync_log('å»¶è¿Ÿåº“å­˜åŒæ­¥-FeedçŠ¶æ€', 'ä¿¡æ¯', [
        'product_id' => $product_id,
        'walmart_sku' => $walmart_sku,
        'feed_id' => $feed_id,
        'feed_status' => $feed_status
    ], "FeedçŠ¶æ€: {$feed_status}");

    // å¦‚æœFeedè¿˜åœ¨å¤„ç†ä¸­ï¼Œå†å»¶è¿Ÿ5åˆ†é’Ÿ
    if (in_array($feed_status, ['SUBMITTED', 'INPROGRESS', 'PROCESSING'])) {
        woo_walmart_sync_log('å»¶è¿Ÿåº“å­˜åŒæ­¥', 'é‡æ–°è®¡åˆ’', [
            'product_id' => $product_id,
            'walmart_sku' => $walmart_sku,
            'feed_id' => $feed_id,
            'feed_status' => $feed_status,
            'next_delay_minutes' => 5
        ], "Feedä»åœ¨å¤„ç†ä¸­ï¼Œé‡æ–°è®¡åˆ’5åˆ†é’Ÿåæ‰§è¡Œ");

        // é‡æ–°è®¡åˆ’5åˆ†é’Ÿåæ‰§è¡Œ
        wp_schedule_single_event(
            time() + (5 * 60),
            'walmart_delayed_inventory_sync',
            [$product_id, $walmart_sku, $feed_id]
        );
        return;
    }

    // å¦‚æœFeedå¤„ç†å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ä½†ä¸æ‰§è¡Œåº“å­˜åŒæ­¥
    if ($feed_status === 'ERROR') {
        woo_walmart_sync_log('å»¶è¿Ÿåº“å­˜åŒæ­¥', 'è·³è¿‡', [
            'product_id' => $product_id,
            'walmart_sku' => $walmart_sku,
            'feed_id' => $feed_id,
            'feed_status' => $feed_status
        ], "Feedå¤„ç†å¤±è´¥ï¼Œè·³è¿‡åº“å­˜åŒæ­¥");
        return;
    }

    // Feedå¤„ç†æˆåŠŸï¼Œæ‰§è¡Œåº“å­˜åŒæ­¥
    if ($feed_status === 'PROCESSED') {
        woo_walmart_sync_log('å»¶è¿Ÿåº“å­˜åŒæ­¥', 'æ‰§è¡Œ', [
            'product_id' => $product_id,
            'walmart_sku' => $walmart_sku,
            'feed_id' => $feed_id,
            'feed_status' => $feed_status
        ], "Feedå¤„ç†å®Œæˆï¼Œå¼€å§‹æ‰§è¡Œåº“å­˜åŒæ­¥");

        // è§¦å‘åŸå§‹çš„åº“å­˜åŒæ­¥é’©å­
        do_action('woo_walmart_sync_product_created', $product_id, $walmart_sku);
    }
}

// åœ¨æˆ‘ä»¬çš„æ’ä»¶é¡µé¢å®Œå…¨ç§»é™¤WordPressé¡µè„š
add_action('admin_enqueue_scripts', function($hook) {
    // åªåœ¨æˆ‘ä»¬çš„æ’ä»¶é¡µé¢ç§»é™¤é¡µè„š
    if (!empty($hook) && (strpos($hook, 'woo-walmart') !== false || strpos($hook, 'walmart') !== false)) {
        add_action('admin_footer', function() {
            echo '<style>
                #wpfooter, .wp-admin #wpfooter, #footer-thankyou, #footer-upgrade {
                    display: none !important;
                }
            </style>';
        }, 999);
    }
});

// æ’ä»¶æ¿€æ´»æ—¶åˆ›å»ºæ—¥å¿—è¡¨å’Œè®¾ç½®å®šæ—¶ä»»åŠ¡
register_activation_hook(__FILE__, function() {
    global $wpdb;
    $charset_collate = $wpdb->get_charset_collate();

    // 1. æ—¥å¿—è¡¨
    $table_logs = $wpdb->prefix . 'woo_walmart_sync_logs';
    $sql_logs = "CREATE TABLE $table_logs (
        id mediumint(9) NOT NULL AUTO_INCREMENT,
        created_at datetime DEFAULT '0000-00-00 00:00:00' NOT NULL,
        action varchar(255) DEFAULT '' NOT NULL,
        status varchar(50) DEFAULT '' NOT NULL,
        request longtext,
        response longtext,
        product_id bigint(20) UNSIGNED,
        PRIMARY KEY  (id)
    ) $charset_collate;";

    // 2. UPCæ± è¡¨
    $table_upc = $wpdb->prefix . 'walmart_upc_pool';
    $sql_upc = "CREATE TABLE $table_upc (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        upc_code varchar(20) NOT NULL,
        is_used tinyint(1) NOT NULL DEFAULT 0,
        product_id bigint(20) UNSIGNED,
        used_at datetime,
        PRIMARY KEY  (id),
        UNIQUE KEY upc_code (upc_code)
    ) $charset_collate;";

    // 3. åˆ†ç±»æ˜ å°„è¡¨
    $table_cat_map = $wpdb->prefix . 'walmart_category_map';
    $sql_cat_map = "CREATE TABLE $table_cat_map (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        wc_category_id bigint(20) UNSIGNED NOT NULL,
        wc_category_name varchar(255) NOT NULL,
        walmart_category_path text NOT NULL,
        walmart_attributes longtext,
        local_category_ids longtext DEFAULT NULL COMMENT 'å…±äº«æ˜ å°„çš„æœ¬åœ°åˆ†ç±»IDæ•°ç»„(JSONæ ¼å¼)',
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        UNIQUE KEY wc_category_id (wc_category_id),
        KEY walmart_category_path (walmart_category_path(100))
    ) $charset_collate;";

    // 4. FeedçŠ¶æ€è¡¨
    $table_feeds = $wpdb->prefix . 'walmart_feeds';
    $sql_feeds = "CREATE TABLE $table_feeds (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        feed_id varchar(50) NOT NULL,
        product_id bigint(20) UNSIGNED NOT NULL,
        sku varchar(100) DEFAULT '',
        upc varchar(20) DEFAULT '',
        wpid varchar(50) DEFAULT '',
        status varchar(50) NOT NULL,
        submitted_at datetime NOT NULL,
        processed_at datetime,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        api_response longtext,
        PRIMARY KEY  (id),
        KEY feed_id (feed_id),
        KEY product_id (product_id),
        KEY sku (sku),
        KEY wpid (wpid),
        KEY status (status)
    ) $charset_collate;";

    // 5. æ‰¹é‡Feedç®¡ç†è¡¨
    $table_batch_feeds = $wpdb->prefix . 'walmart_batch_feeds';
    $sql_batch_feeds = "CREATE TABLE $table_batch_feeds (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        batch_id varchar(50) NOT NULL UNIQUE,
        parent_batch_id varchar(50) NULL,
        feed_id varchar(50) NULL,
        product_ids longtext NOT NULL,
        product_count int NOT NULL,
        sync_method varchar(50) NOT NULL,
        batch_type varchar(20) NOT NULL DEFAULT 'single',
        chunk_index int DEFAULT 0,
        total_chunks int DEFAULT 1,
        status varchar(50) NOT NULL DEFAULT 'PENDING',
        submitted_at datetime NULL,
        completed_at datetime NULL,
        progress_current int DEFAULT 0,
        progress_total int DEFAULT 0,
        success_count int DEFAULT 0,
        failed_count int DEFAULT 0,
        api_response longtext NULL,
        error_details longtext NULL,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        KEY parent_batch_id (parent_batch_id),
        KEY status (status),
        KEY sync_method (sync_method),
        KEY batch_type (batch_type)
    ) $charset_collate;";

    // 6. æ‰¹é‡å•†å“è¯¦æƒ…è¡¨
    $table_batch_items = $wpdb->prefix . 'walmart_batch_items';
    $sql_batch_items = "CREATE TABLE $table_batch_items (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        batch_id varchar(50) NOT NULL,
        product_id bigint(20) UNSIGNED NOT NULL,
        sku varchar(100),
        upc varchar(20),
        status varchar(50) NOT NULL DEFAULT 'PENDING',
        error_message text NULL,
        processed_at datetime NULL,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        KEY batch_id (batch_id),
        KEY product_id (product_id),
        KEY status (status)
    ) $charset_collate;";

    // åˆ›å»ºæ²ƒå°”ç›å•†å“ç¼“å­˜è¡¨
    $sql_walmart_products = "CREATE TABLE IF NOT EXISTS {$wpdb->prefix}walmart_products_cache (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        wpid varchar(191) NOT NULL,
        sku varchar(191) NOT NULL,
        product_name varchar(500) NOT NULL,
        price decimal(10,2) DEFAULT 0.00,
        inventory_count int(11) DEFAULT 0,
        upc varchar(50) DEFAULT '',
        status varchar(50) DEFAULT 'PUBLISHED',
        product_type varchar(100) DEFAULT '',
        category varchar(200) DEFAULT '',
        last_sync_time datetime NOT NULL,
        sync_status varchar(20) DEFAULT 'success',
        sync_error_message text,
        created_at datetime NOT NULL,
        updated_at datetime NOT NULL,
        PRIMARY KEY (id),
        UNIQUE KEY wpid (wpid),
        UNIQUE KEY sku (sku),
        KEY status (status),
        KEY sync_status (sync_status),
        KEY last_sync_time (last_sync_time)
    ) $charset_collate;";

    // åˆ›å»ºæ²ƒå°”ç›åŒæ­¥é€šçŸ¥è¡¨
    $sql_walmart_notifications = "CREATE TABLE IF NOT EXISTS {$wpdb->prefix}walmart_sync_notifications (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        notification_type varchar(50) NOT NULL,
        title varchar(255) NOT NULL,
        message text NOT NULL,
        status varchar(20) DEFAULT 'unread',
        priority varchar(20) DEFAULT 'normal',
        related_data longtext,
        created_at datetime NOT NULL,
        read_at datetime NULL,
        PRIMARY KEY (id),
        KEY notification_type (notification_type),
        KEY status (status),
        KEY priority (priority),
        KEY created_at (created_at)
    ) $charset_collate;";

    // åˆ›å»ºæœ¬åœ°å•†å“æ•°æ®ç¼“å­˜è¡¨
    $sql_walmart_local_cache = "CREATE TABLE IF NOT EXISTS {$wpdb->prefix}walmart_local_cache (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        sku varchar(191) NOT NULL,
        product_id bigint(20) UNSIGNED NOT NULL,
        product_name varchar(500) NOT NULL,
        price decimal(10,2) DEFAULT 0.00,
        stock_quantity int(11) DEFAULT 0,
        manage_stock tinyint(1) DEFAULT 0,
        stock_status varchar(20) DEFAULT 'instock',
        product_status varchar(20) DEFAULT 'publish',
        last_sync_time datetime NOT NULL,
        created_at datetime NOT NULL,
        updated_at datetime NOT NULL,
        PRIMARY KEY (id),
        UNIQUE KEY sku (sku),
        KEY product_id (product_id),
        KEY last_sync_time (last_sync_time),
        KEY product_status (product_status)
    ) $charset_collate;";

    // åˆ›å»ºåº“å­˜åŒæ­¥çŠ¶æ€è¡¨
    $sql_inventory_sync = "CREATE TABLE IF NOT EXISTS {$wpdb->prefix}walmart_inventory_sync (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        product_id bigint(20) UNSIGNED NOT NULL,
        walmart_sku varchar(191) NOT NULL,
        status varchar(20) NOT NULL,
        quantity int(11) NOT NULL DEFAULT 0,
        retry_count int(11) NOT NULL DEFAULT 0,
        last_sync_time datetime NOT NULL,
        created_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
        response_data longtext,
        PRIMARY KEY (id),
        UNIQUE KEY product_sku (product_id, walmart_sku),
        KEY status (status),
        KEY last_sync_time (last_sync_time)
    ) $charset_collate;";

    // åˆ›å»ºWalmartåˆ†ç±»æ•°æ®è¡¨
    $sql_walmart_categories = "CREATE TABLE IF NOT EXISTS {$wpdb->prefix}walmart_categories (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        category_id varchar(191) NOT NULL,
        category_name varchar(500) NOT NULL,
        parent_id varchar(191) DEFAULT NULL,
        level int(11) NOT NULL DEFAULT 0,
        path text,
        product_type_group_id varchar(191) DEFAULT NULL,
        product_type_group_name varchar(255) DEFAULT NULL,
        product_type_id varchar(191) DEFAULT NULL,
        product_type_name varchar(255) DEFAULT NULL,
        attributes_data longtext,
        is_active tinyint(1) DEFAULT 1,
        sync_status varchar(50) DEFAULT 'synced',
        last_sync_time datetime DEFAULT CURRENT_TIMESTAMP,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY (id),
        UNIQUE KEY category_id (category_id),
        KEY parent_id (parent_id),
        KEY level (level),
        KEY product_type_group_id (product_type_group_id),
        KEY product_type_id (product_type_id),
        KEY sync_status (sync_status),
        KEY last_sync_time (last_sync_time)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');

    // åˆ›å»ºè¡¨å¹¶éªŒè¯ç»“æœ
    $tables_to_create = [
        'logs' => [$sql_logs, $table_logs],
        'upc' => [$sql_upc, $wpdb->prefix . 'walmart_upc_pool'],
        'cat_map' => [$sql_cat_map, $wpdb->prefix . 'walmart_category_map'],
        'feeds' => [$sql_feeds, $wpdb->prefix . 'walmart_feeds'],
        'batch_feeds' => [$sql_batch_feeds, $wpdb->prefix . 'walmart_batch_feeds'],
        'batch_items' => [$sql_batch_items, $wpdb->prefix . 'walmart_batch_items'],
        'walmart_products' => [$sql_walmart_products, $wpdb->prefix . 'walmart_products_cache'],
        'walmart_notifications' => [$sql_walmart_notifications, $wpdb->prefix . 'walmart_sync_notifications'],
        'walmart_local_cache' => [$sql_walmart_local_cache, $wpdb->prefix . 'walmart_local_cache'],
        'inventory_sync' => [$sql_inventory_sync, $wpdb->prefix . 'walmart_inventory_sync'],
        'walmart_categories' => [$sql_walmart_categories, $wpdb->prefix . 'walmart_categories']
    ];

    $creation_results = [];
    foreach ($tables_to_create as $table_key => $table_info) {
        $sql = $table_info[0];
        $table_name = $table_info[1];

        // æ‰§è¡ŒdbDelta
        $result = dbDelta($sql);

        // éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
        $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table_name'") === $table_name;

        $creation_results[$table_key] = [
            'table_name' => $table_name,
            'created' => $table_exists,
            'dbdelta_result' => $result,
            'error' => $wpdb->last_error
        ];

        // å¦‚æœdbDeltaå¤±è´¥ï¼Œå°è¯•ç›´æ¥æ‰§è¡ŒSQL
        if (!$table_exists && !empty($sql)) {
            $wpdb->query($sql);
            $table_exists_after_direct = $wpdb->get_var("SHOW TABLES LIKE '$table_name'") === $table_name;
            $creation_results[$table_key]['direct_sql_success'] = $table_exists_after_direct;
            $creation_results[$table_key]['direct_sql_error'] = $wpdb->last_error;
        }
    }

    // è®°å½•åˆ›å»ºç»“æœåˆ°WordPressé€‰é¡¹è¡¨
    update_option('walmart_sync_table_creation_results', $creation_results);

    // æ£€æŸ¥å¹¶æ›´æ–°ç°æœ‰è¡¨ç»“æ„ï¼ˆå‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶åé¢ï¼‰
    // å»¶è¿Ÿæ‰§è¡Œè¡¨ç»“æ„æ›´æ–°ï¼Œç¡®ä¿æ‰€æœ‰å‡½æ•°éƒ½å·²å®šä¹‰
    
    // æ³¨å†Œå®šæ—¶ä»»åŠ¡
    if (!wp_next_scheduled('walmart_check_feed_status_hook')) {
        wp_schedule_event(time(), 'every_five_minutes', 'walmart_check_feed_status_hook');
    }

    // æ³¨å†Œæ¯æ—¥ç»Ÿè®¡æ›´æ–°ä»»åŠ¡
    if (!wp_next_scheduled('walmart_daily_stats_update')) {
        wp_schedule_event(strtotime('tomorrow 00:00:00'), 'daily', 'walmart_daily_stats_update');
    }

    // åˆå§‹åŒ–é»˜è®¤é…ç½®é€‰é¡¹
    add_option('woo_walmart_api_version', '5.0');  // é»˜è®¤ä½¿ç”¨V5.0
    add_option('woo_walmart_business_unit', 'WALMART_US');  // é»˜è®¤ç¾å›½æ²ƒå°”ç›
    add_option('woo_walmart_fulfillment_lag_time', 1);  // é»˜è®¤å¤‡è´§æ—¶é—´1å¤©

    // åœ¨æ¿€æ´»é’©å­çš„æœ€åè°ƒç”¨è¡¨ç»“æ„æ›´æ–°ï¼ˆç¡®ä¿æ‰€æœ‰å‡½æ•°éƒ½å·²å®šä¹‰ï¼‰
    add_action('init', 'woo_walmart_sync_update_table_structure_delayed', 999);
});

// AJAXå¤„ç†å‡½æ•°ï¼šæµ‹è¯•å¸‚åœºè¿æ¥
add_action('wp_ajax_walmart_test_market_connection', function() {
    // éªŒè¯nonce
    if (!wp_verify_nonce($_POST['nonce'], 'walmart_test_market_connection')) {
        wp_send_json_error(['message' => 'å®‰å…¨éªŒè¯å¤±è´¥']);
        return;
    }

    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'æƒé™ä¸è¶³']);
        return;
    }

    $market = sanitize_text_field($_POST['market']);
    $market_names = [
        'US' => 'ğŸ‡ºğŸ‡¸ ç¾å›½',
        'CA' => 'ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§',
        'MX' => 'ğŸ‡²ğŸ‡½ å¢¨è¥¿å“¥',
        'CL' => 'ğŸ‡¨ğŸ‡± æ™ºåˆ©'
    ];

    $market_name = isset($market_names[$market]) ? $market_names[$market] : $market;

    try {
        // è·å–å¸‚åœºç‰¹å®šçš„é…ç½®
        if ($market === 'US') {
            $client_id = get_option("woo_walmart_US_client_id", get_option('woo_walmart_client_id', ''));
            $client_secret = get_option("woo_walmart_US_client_secret", get_option('woo_walmart_client_secret', ''));
            $api_version = get_option("woo_walmart_US_api_version", get_option('woo_walmart_api_version', '5.0'));
        } else {
            $client_id = get_option("woo_walmart_{$market}_client_id", '');
            $client_secret = get_option("woo_walmart_{$market}_client_secret", '');
            $api_version = get_option("woo_walmart_{$market}_api_version", '5.0');
        }

        if (empty($client_id) || empty($client_secret)) {
            wp_send_json_error(['message' => "{$market_name}å¸‚åœºçš„APIå‡­è¯æœªé…ç½®"]);
            return;
        }

        // ä¸´æ—¶è®¾ç½®å¸‚åœºé…ç½®è¿›è¡Œæµ‹è¯•
        $original_client_id = get_option('woo_walmart_client_id', '');
        $original_client_secret = get_option('woo_walmart_client_secret', '');
        $original_business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');

        update_option('woo_walmart_client_id', $client_id);
        update_option('woo_walmart_client_secret', $client_secret);
        update_option('woo_walmart_business_unit', "WALMART_{$market}");

        // ä½¿ç”¨æ–°çš„å¤šå¸‚åœºAPIè·¯ç”±å™¨è¿›è¡Œæµ‹è¯•
        $api_router = new Woo_Walmart_Multi_Market_API_Router($market);

        // æµ‹è¯•è·å–token
        $token = $api_router->get_access_token();
        if (!$token) {
            throw new Exception('æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ');
        }

        // ç®€å•çš„è¿æ¥æµ‹è¯•æˆåŠŸï¼ˆè·å–åˆ°tokenå°±è¯´æ˜è¿æ¥æ­£å¸¸ï¼‰
        $test_response = ['success' => true];

        // æ¢å¤åŸå§‹é…ç½®
        update_option('woo_walmart_client_id', $original_client_id);
        update_option('woo_walmart_client_secret', $original_client_secret);
        update_option('woo_walmart_business_unit', $original_business_unit);

        if ($test_response && !isset($test_response['error'])) {
            wp_send_json_success(['message' => "{$market_name}å¸‚åœºè¿æ¥æµ‹è¯•æˆåŠŸï¼"]);
        } else {
            $error_msg = 'æœªçŸ¥é”™è¯¯';
            if (isset($test_response['error'])) {
                if (is_string($test_response['error'])) {
                    $error_msg = $test_response['error'];
                } elseif (is_array($test_response['error'])) {
                    $error_msg = json_encode($test_response['error'], JSON_UNESCAPED_UNICODE);
                } else {
                    $error_msg = (string)$test_response['error'];
                }
            }
            throw new Exception($error_msg);
        }

    } catch (Exception $e) {
        // ç¡®ä¿æ¢å¤åŸå§‹é…ç½®
        if (isset($original_client_id)) {
            update_option('woo_walmart_client_id', $original_client_id);
            update_option('woo_walmart_client_secret', $original_client_secret);
            update_option('woo_walmart_business_unit', $original_business_unit);
        }

        wp_send_json_error(['message' => "{$market_name}å¸‚åœºè¿æ¥å¤±è´¥ï¼š" . $e->getMessage()]);
    }
});

// AJAXå¤„ç†å‡½æ•°ï¼šè·å–å·®å¼‚å•†å“è¯¦æƒ…
add_action('wp_ajax_get_difference_products', function() {
    check_ajax_referer('walmart_difference_action', 'nonce');

    $type = sanitize_text_field($_POST['type']);
    $limit = isset($_POST['limit']) ? intval($_POST['limit']) : 50;

    try {
        require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-local-data-manager.php';
        $local_data_manager = new Walmart_Local_Data_Manager();

        $products = $local_data_manager->get_difference_products($type, $limit);

        wp_send_json_success($products);

    } catch (Exception $e) {
        wp_send_json_error('è·å–å·®å¼‚å•†å“å¤±è´¥ï¼š' . $e->getMessage());
    }
});

// AJAXå¤„ç†å‡½æ•°ï¼šåŒæ­¥å·®å¼‚å•†å“
add_action('wp_ajax_sync_difference_products', function() {


    check_ajax_referer('walmart_sync_action', 'nonce');

    // å¤„ç†product_idså‚æ•° - å¯èƒ½æ˜¯æ•°ç»„æˆ–é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
    $product_ids_raw = $_POST['product_ids'] ?? [];
    if (is_string($product_ids_raw)) {
        // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ŒæŒ‰é€—å·åˆ†å‰²
        $product_ids = array_map('intval', explode(',', $product_ids_raw));
    } else {
        // å¦‚æœæ˜¯æ•°ç»„ï¼Œç›´æ¥å¤„ç†
        $product_ids = array_map('intval', $product_ids_raw);
    }

    $sync_type = isset($_POST['sync_type']) ? sanitize_text_field($_POST['sync_type']) : 'all'; // æ–°å¢ï¼šåŒæ­¥ç±»å‹



    if (empty($product_ids)) {
        wp_send_json_error('æ²¡æœ‰é€‰æ‹©è¦åŒæ­¥çš„å•†å“');
        return;
    }

    // éªŒè¯åŒæ­¥ç±»å‹
    if (!in_array($sync_type, ['price', 'inventory', 'all'])) {
        wp_send_json_error('æ— æ•ˆçš„åŒæ­¥ç±»å‹');
        return;
    }

    try {
        woo_walmart_sync_log('å·®å¼‚å•†å“åŒæ­¥-å¼€å§‹', 'ä¿¡æ¯', [
            'product_ids' => $product_ids,
            'sync_type' => $sync_type,
            'product_count' => count($product_ids)
        ], "å¼€å§‹å·®å¼‚å•†å“åŒæ­¥ï¼Œç±»å‹: {$sync_type}ï¼Œå•†å“æ•°é‡: " . count($product_ids));

        require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-products-manager.php';
        $products_manager = new WooWalmartSync_Products_Manager();

        // æ ¹æ®å•†å“æ•°é‡é€‰æ‹©åŒæ­¥æ–¹å¼
        if (count($product_ids) <= 5) {
            // å°‘é‡å•†å“ä½¿ç”¨å•ä¸ªAPIåŒæ­¥
            $success_count = 0;
            $failed_count = 0;
            $sync_results = [];

            require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-local-data-manager.php';
            $local_data_manager = new Walmart_Local_Data_Manager();

            foreach ($product_ids as $product_id) {
                try {
                    global $wpdb;
                    $cache_table = $wpdb->prefix . 'walmart_products_cache';

                    // è·å–Walmartå•†å“ä¿¡æ¯
                    $walmart_product = $wpdb->get_row($wpdb->prepare(
                        "SELECT * FROM {$cache_table} WHERE id = %d",
                        $product_id
                    ));

                    if (!$walmart_product) {
                        $failed_count++;
                        $sync_results[] = "å•†å“ID {$product_id}: æœªæ‰¾åˆ°Walmartå•†å“æ•°æ®";
                        continue;
                    }

                    // è·å–æœ¬åœ°å•†å“æ•°æ®
                    $local_data = $local_data_manager->get_local_data_by_sku($walmart_product->sku);
                    if (!$local_data) {
                        $failed_count++;
                        $sync_results[] = "å•†å“ {$walmart_product->sku}: æœªæ‰¾åˆ°æœ¬åœ°å•†å“æ•°æ®";
                        continue;
                    }

                    // æ‰§è¡ŒåŒæ­¥æ“ä½œ
                    $item_success = 0;
                    $item_failed = 0;

                    // è®¡ç®—å·®å¼‚
                    $price_diff = abs(floatval($walmart_product->price) - floatval($local_data->price));
                    $inventory_diff = intval($walmart_product->inventory_count) - intval($local_data->stock_quantity);

                    // æ ¹æ®åŒæ­¥ç±»å‹æ‰§è¡Œç›¸åº”çš„åŒæ­¥æ“ä½œ
                    if ($sync_type === 'price' || $sync_type === 'all') {
                        // åŒæ­¥ä»·æ ¼
                        if ($price_diff > 0.01) {
                            $price_result = $products_manager->sync_single_product_price($walmart_product, $local_data);
                            if ($price_result['success']) {
                                $item_success++;
                                $sync_results[] = "å•†å“ {$walmart_product->sku}: ä»·æ ¼åŒæ­¥æˆåŠŸ";
                            } else {
                                $item_failed++;
                                $sync_results[] = "å•†å“ {$walmart_product->sku}: ä»·æ ¼åŒæ­¥å¤±è´¥ - " . $price_result['message'];
                            }
                        } elseif ($sync_type === 'price') {
                            $sync_results[] = "å•†å“ {$walmart_product->sku}: ä»·æ ¼ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥";
                        }
                    }

                    if ($sync_type === 'inventory' || $sync_type === 'all') {
                        // åŒæ­¥åº“å­˜
                        if ($inventory_diff != 0) {
                            $inventory_result = $products_manager->sync_single_product_inventory($walmart_product, $local_data);
                            if ($inventory_result['success']) {
                                $item_success++;
                                $sync_results[] = "å•†å“ {$walmart_product->sku}: åº“å­˜åŒæ­¥æˆåŠŸ";
                            } else {
                                $item_failed++;
                                $sync_results[] = "å•†å“ {$walmart_product->sku}: åº“å­˜åŒæ­¥å¤±è´¥ - " . $inventory_result['message'];
                            }
                        } elseif ($sync_type === 'inventory') {
                            $sync_results[] = "å•†å“ {$walmart_product->sku}: åº“å­˜ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥";
                        }
                    }

                    // å¦‚æœæ˜¯å…¨éƒ¨åŒæ­¥ä¸”æ²¡æœ‰å·®å¼‚ï¼Œè®°å½•ä¿¡æ¯
                    if ($sync_type === 'all' && $price_diff <= 0.01 && $inventory_diff == 0) {
                        $sync_results[] = "å•†å“ {$walmart_product->sku}: æ•°æ®ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥";
                    }

                    if ($item_failed > 0) {
                        $failed_count++;
                    } else {
                        $success_count++;
                    }

                    woo_walmart_sync_log('å·®å¼‚å•†å“åŒæ­¥', $item_failed > 0 ? 'è­¦å‘Š' : 'æˆåŠŸ', [
                        'product_id' => $product_id,
                        'sku' => $walmart_product->sku,
                        'sync_type' => $sync_type,
                        'price_diff' => $price_diff,
                        'inventory_diff' => $inventory_diff,
                        'item_success' => $item_success,
                        'item_failed' => $item_failed
                    ], "å·®å¼‚å•†å“åŒæ­¥å®Œæˆ: {$walmart_product->sku} (ç±»å‹: {$sync_type})");

                } catch (Exception $e) {
                    $failed_count++;
                    $sync_results[] = "å•†å“ID {$product_id}: åŒæ­¥å¼‚å¸¸ - " . $e->getMessage();

                    woo_walmart_sync_log('å·®å¼‚å•†å“åŒæ­¥', 'é”™è¯¯', [
                        'product_id' => $product_id,
                        'error' => $e->getMessage()
                    ], "å·®å¼‚å•†å“åŒæ­¥å¼‚å¸¸");
                }
            }

            wp_send_json_success([
                'message' => "åŒæ­¥å®Œæˆï¼šæˆåŠŸ {$success_count} ä¸ªï¼Œå¤±è´¥ {$failed_count} ä¸ª",
                'success_count' => $success_count,
                'failed_count' => $failed_count,
                'details' => $sync_results
            ]);

        } else {
            // å¤§é‡å•†å“ä½¿ç”¨æ‰¹é‡åŒæ­¥
            if ($sync_type === 'inventory') {
                // åªåŒæ­¥åº“å­˜
                $result = $products_manager->bulk_sync_inventory_by_ids($product_ids);
            } elseif ($sync_type === 'price') {
                // åªåŒæ­¥ä»·æ ¼
                $result = $products_manager->bulk_sync_price_by_ids($product_ids);
            } else {
                // å…¨éƒ¨åŒæ­¥ - å…ˆåŒæ­¥ä»·æ ¼å†åŒæ­¥åº“å­˜
                $price_result = $products_manager->bulk_sync_price_by_ids($product_ids);
                $inventory_result = $products_manager->bulk_sync_inventory_by_ids($product_ids);

                $result = [
                    'success' => true,
                    'message' => "æ‰¹é‡åŒæ­¥å®Œæˆï¼šä»·æ ¼åŒæ­¥ " . ($price_result['success'] ? 'æˆåŠŸ' : 'å¤±è´¥') .
                                "ï¼Œåº“å­˜åŒæ­¥ " . ($inventory_result['success'] ? 'æˆåŠŸ' : 'å¤±è´¥'),
                    'success_count' => ($price_result['success_count'] ?? 0) + ($inventory_result['success_count'] ?? 0),
                    'failed_count' => ($price_result['failed_count'] ?? 0) + ($inventory_result['failed_count'] ?? 0)
                ];
            }

            if ($result && $result['success']) {
                wp_send_json_success([
                    'message' => $result['message'],
                    'success_count' => $result['success_count'] ?? count($product_ids),
                    'failed_count' => $result['failed_count'] ?? 0
                ]);
            } else {
                wp_send_json_error($result['message'] ?? 'æ‰¹é‡åŒæ­¥å¤±è´¥');
            }
        }

    } catch (Exception $e) {
        wp_send_json_error('åŒæ­¥æ“ä½œå¤±è´¥ï¼š' . $e->getMessage());
    }
});

// AJAXå¤„ç†å‡½æ•°ï¼šåˆ·æ–°å·®å¼‚ç»Ÿè®¡
add_action('wp_ajax_refresh_difference_stats', function() {
    check_ajax_referer('walmart_difference_action', 'nonce');

    try {
        require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-local-data-manager.php';
        $local_data_manager = new Walmart_Local_Data_Manager();

        // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼Œé‡æ–°è®¡ç®—ç»Ÿè®¡
        delete_option('walmart_global_diff_stats');
        delete_option('walmart_global_diff_stats_time');

        woo_walmart_sync_log('å·®å¼‚ç»Ÿè®¡åˆ·æ–°', 'å¼€å§‹', [], 'ç”¨æˆ·æ‰‹åŠ¨è§¦å‘å·®å¼‚ç»Ÿè®¡åˆ·æ–°');

        // é‡æ–°è®¡ç®—å…¨å±€å·®å¼‚ç»Ÿè®¡
        $stats = $local_data_manager->get_global_difference_stats();

        woo_walmart_sync_log('å·®å¼‚ç»Ÿè®¡åˆ·æ–°', 'æˆåŠŸ', $stats, 'å·®å¼‚ç»Ÿè®¡åˆ·æ–°å®Œæˆ');

        wp_send_json_success([
            'message' => 'ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°',
            'stats' => $stats,
            'last_update' => human_time_diff(strtotime($stats['last_update']), current_time('timestamp')) . 'å‰'
        ]);

    } catch (Exception $e) {
        woo_walmart_sync_log('å·®å¼‚ç»Ÿè®¡åˆ·æ–°', 'é”™è¯¯', [
            'error' => $e->getMessage()
        ], 'å·®å¼‚ç»Ÿè®¡åˆ·æ–°å¤±è´¥');

        wp_send_json_error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥ï¼š' . $e->getMessage());
    }
});

// AJAXå¤„ç†å‡½æ•°ï¼šå•ä¸ªå•†å“åŒæ­¥
add_action('wp_ajax_sync_single_product', function() {
    check_ajax_referer('walmart_single_sync_action', 'nonce');

    $product_id = isset($_POST['product_id']) ? intval($_POST['product_id']) : 0;
    $sku = isset($_POST['sku']) ? sanitize_text_field($_POST['sku']) : '';

    if (empty($product_id) || empty($sku)) {
        wp_send_json_error('å•†å“IDæˆ–SKUä¸èƒ½ä¸ºç©º');
        return;
    }

    try {
        global $wpdb;

        // è·å–Walmartå•†å“ä¿¡æ¯
        $cache_table = $wpdb->prefix . 'walmart_products_cache';
        $walmart_product = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM {$cache_table} WHERE id = %d AND sku = %s",
            $product_id, $sku
        ));

        if (!$walmart_product) {
            wp_send_json_error('æœªæ‰¾åˆ°å¯¹åº”çš„Walmartå•†å“');
            return;
        }

        // è·å–æœ¬åœ°å•†å“æ•°æ®
        require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-local-data-manager.php';
        $local_data_manager = new Walmart_Local_Data_Manager();
        $local_data = $local_data_manager->get_local_data_by_sku($sku);

        if (!$local_data) {
            wp_send_json_error('æœªæ‰¾åˆ°å¯¹åº”çš„æœ¬åœ°å•†å“æ•°æ®ï¼Œè¯·å…ˆåŒæ­¥æœ¬åœ°æ•°æ®');
            return;
        }

        // æ‰§è¡ŒåŒæ­¥æ“ä½œ
        require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-products-manager.php';
        $products_manager = new WooWalmartSync_Products_Manager();

        $sync_results = [];
        $success_count = 0;
        $failed_count = 0;

        // æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥ä»·æ ¼
        $price_diff = abs(floatval($walmart_product->price) - floatval($local_data->price));
        if ($price_diff > 0.01) {
            $price_result = $products_manager->sync_single_product_price($walmart_product, $local_data);
            $sync_results[] = "ä»·æ ¼åŒæ­¥: " . ($price_result['success'] ? 'æˆåŠŸ' : 'å¤±è´¥ - ' . $price_result['message']);
            if ($price_result['success']) $success_count++; else $failed_count++;
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥åº“å­˜
        $inventory_diff = intval($walmart_product->inventory_count) - intval($local_data->stock_quantity);
        if ($inventory_diff != 0) {
            $inventory_result = $products_manager->sync_single_product_inventory($walmart_product, $local_data);
            $sync_results[] = "åº“å­˜åŒæ­¥: " . ($inventory_result['success'] ? 'æˆåŠŸ' : 'å¤±è´¥ - ' . $inventory_result['message']);
            if ($inventory_result['success']) $success_count++; else $failed_count++;
        }

        // å¦‚æœæ²¡æœ‰å·®å¼‚ï¼Œæ‰§è¡Œå¼ºåˆ¶åŒæ­¥
        if (empty($sync_results)) {
            $force_result = $products_manager->force_sync_single_product($walmart_product, $local_data);
            $sync_results[] = "å¼ºåˆ¶åŒæ­¥: " . ($force_result['success'] ? 'æˆåŠŸ' : 'å¤±è´¥ - ' . $force_result['message']);
            if ($force_result['success']) $success_count++; else $failed_count++;
        }

        // è®°å½•åŒæ­¥æ—¥å¿—
        woo_walmart_sync_log('å•ä¸ªå•†å“åŒæ­¥', $failed_count > 0 ? 'è­¦å‘Š' : 'æˆåŠŸ', [
            'product_id' => $product_id,
            'sku' => $sku,
            'sync_results' => $sync_results,
            'success_count' => $success_count,
            'failed_count' => $failed_count,
            'price_diff' => $price_diff,
            'inventory_diff' => $inventory_diff
        ], "å•†å“ {$sku} å•ä¸ªåŒæ­¥å®Œæˆ");

        if ($failed_count > 0) {
            wp_send_json_error([
                'message' => implode('; ', $sync_results),
                'success_count' => $success_count,
                'failed_count' => $failed_count
            ]);
        } else {
            wp_send_json_success([
                'message' => implode('; ', $sync_results),
                'success_count' => $success_count,
                'failed_count' => $failed_count,
                'refresh_needed' => true
            ]);
        }

    } catch (Exception $e) {
        woo_walmart_sync_log('å•ä¸ªå•†å“åŒæ­¥', 'é”™è¯¯', [
            'product_id' => $product_id,
            'sku' => $sku,
            'error' => $e->getMessage()
        ], "å•†å“ {$sku} å•ä¸ªåŒæ­¥å¼‚å¸¸");

        wp_send_json_error('åŒæ­¥æ“ä½œå¤±è´¥ï¼š' . $e->getMessage());
    }
});

// AJAXå¤„ç†å‡½æ•°ï¼šåˆ·æ–°å•ä¸ªæ‰¹æ¬¡çŠ¶æ€
add_action('wp_ajax_refresh_single_batch_status', function() {
    check_ajax_referer('walmart_batch_action', 'nonce');

    $batch_id = sanitize_text_field($_POST['batch_id']);

    if (empty($batch_id)) {
        wp_send_json_error(['message' => 'æ‰¹æ¬¡IDä¸èƒ½ä¸ºç©º']);
        return;
    }

    try {
        $sync = new Woo_Walmart_Product_Sync();

        // åªåˆ·æ–°æŒ‡å®šæ‰¹æ¬¡çš„çŠ¶æ€
        $result = $sync->check_single_batch_feed_status($batch_id);

        if ($result['success']) {
            wp_send_json_success([
                'message' => 'æ‰¹æ¬¡çŠ¶æ€å·²åˆ·æ–°',
                'batch_status' => $result['status'],
                'updated_at' => current_time('mysql')
            ]);
        } else {
            wp_send_json_error(['message' => $result['message']]);
        }
    } catch (Exception $e) {
        wp_send_json_error(['message' => 'åˆ·æ–°å¤±è´¥ï¼š' . $e->getMessage()]);
    }
});

// å»¶è¿Ÿæ‰§è¡Œçš„è¡¨ç»“æ„æ›´æ–°å‡½æ•°
function woo_walmart_sync_update_table_structure_delayed() {
    // åªåœ¨æ’ä»¶æ¿€æ´»åçš„ç¬¬ä¸€æ¬¡initæ—¶æ‰§è¡Œ
    static $executed = false;
    if ($executed) {
        return;
    }
    $executed = true;

    // æ£€æŸ¥æ˜¯å¦æ˜¯æ’ä»¶æ¿€æ´»åçš„é¦–æ¬¡è¿è¡Œ
    $activation_flag = get_option('woo_walmart_sync_activation_update', false);
    if (!$activation_flag) {
        woo_walmart_sync_update_table_structure();
        update_option('woo_walmart_sync_activation_update', true);
    }
}

// æ›´æ–°è¡¨ç»“æ„å‡½æ•°
function woo_walmart_sync_update_table_structure() {
    global $wpdb;

    $feeds_table = $wpdb->prefix . 'walmart_feeds';

    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ–°å­—æ®µ
    $columns = $wpdb->get_results("DESCRIBE $feeds_table");
    $existing_columns = array_column($columns, 'Field');

    $required_columns = ['sku', 'upc', 'wpid', 'created_at', 'updated_at'];
    $missing_columns = array_diff($required_columns, $existing_columns);

    if (!empty($missing_columns)) {
        woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'å¼€å§‹', [
            'table' => $feeds_table,
            'existing_columns' => $existing_columns,
            'missing_columns' => $missing_columns
        ], 'å¼€å§‹æ›´æ–°walmart_feedsè¡¨ç»“æ„');

        // æ·»åŠ ç¼ºå¤±çš„å­—æ®µ
        foreach ($missing_columns as $column) {
            switch ($column) {
                case 'sku':
                    $wpdb->query("ALTER TABLE $feeds_table ADD COLUMN sku varchar(100) DEFAULT '' AFTER product_id");
                    break;
                case 'upc':
                    $wpdb->query("ALTER TABLE $feeds_table ADD COLUMN upc varchar(20) DEFAULT '' AFTER sku");
                    break;
                case 'wpid':
                    $wpdb->query("ALTER TABLE $feeds_table ADD COLUMN wpid varchar(50) DEFAULT '' AFTER upc");
                    break;
                case 'created_at':
                    $wpdb->query("ALTER TABLE $feeds_table ADD COLUMN created_at datetime DEFAULT CURRENT_TIMESTAMP AFTER processed_at");
                    break;
                case 'updated_at':
                    $wpdb->query("ALTER TABLE $feeds_table ADD COLUMN updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP AFTER created_at");
                    break;
            }

            if ($wpdb->last_error) {
                woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'é”™è¯¯', [
                    'column' => $column,
                    'error' => $wpdb->last_error
                ], "æ·»åŠ å­—æ®µ {$column} å¤±è´¥");
            } else {
                woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'æˆåŠŸ', [
                    'column' => $column
                ], "æˆåŠŸæ·»åŠ å­—æ®µ {$column}");
            }
        }

        // æ·»åŠ ç´¢å¼•
        $wpdb->query("ALTER TABLE $feeds_table ADD INDEX sku (sku)");
        $wpdb->query("ALTER TABLE $feeds_table ADD INDEX wpid (wpid)");
        $wpdb->query("ALTER TABLE $feeds_table ADD INDEX status (status)");

        woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'å®Œæˆ', [
            'table' => $feeds_table,
            'added_columns' => $missing_columns
        ], 'walmart_feedsè¡¨ç»“æ„æ›´æ–°å®Œæˆ');
    }

    // æ£€æŸ¥å¹¶åˆ›å»ºåº“å­˜åŒæ­¥è¡¨
    $inventory_table = $wpdb->prefix . 'walmart_inventory_sync';
    $inventory_exists = $wpdb->get_var("SHOW TABLES LIKE '$inventory_table'") === $inventory_table;

    if (!$inventory_exists) {
        woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'å¼€å§‹', [
            'table' => $inventory_table
        ], 'å¼€å§‹åˆ›å»ºåº“å­˜åŒæ­¥è¡¨');

        $charset_collate = $wpdb->get_charset_collate();
        $sql_inventory_sync = "CREATE TABLE IF NOT EXISTS {$inventory_table} (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            product_id bigint(20) UNSIGNED NOT NULL,
            walmart_sku varchar(191) NOT NULL,
            status varchar(20) NOT NULL,
            quantity int(11) NOT NULL DEFAULT 0,
            retry_count int(11) NOT NULL DEFAULT 0,
            last_sync_time datetime NOT NULL,
            created_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
            response_data longtext,
            PRIMARY KEY (id),
            UNIQUE KEY product_sku (product_id, walmart_sku),
            KEY status (status),
            KEY last_sync_time (last_sync_time)
        ) {$charset_collate};";

        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql_inventory_sync);

        // éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
        $inventory_exists_after = $wpdb->get_var("SHOW TABLES LIKE '$inventory_table'") === $inventory_table;

        if ($inventory_exists_after) {
            woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'æˆåŠŸ', [
                'table' => $inventory_table
            ], 'åº“å­˜åŒæ­¥è¡¨åˆ›å»ºæˆåŠŸ');
        } else {
            woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'é”™è¯¯', [
                'table' => $inventory_table,
                'error' => $wpdb->last_error
            ], 'åº“å­˜åŒæ­¥è¡¨åˆ›å»ºå¤±è´¥');
        }
    }

    // æ£€æŸ¥å¹¶æ›´æ–°åˆ†ç±»æ˜ å°„è¡¨ç»“æ„
    $category_map_table = $wpdb->prefix . 'walmart_category_map';
    $category_map_exists = $wpdb->get_var("SHOW TABLES LIKE '$category_map_table'") === $category_map_table;

    if ($category_map_exists) {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ–°å­—æ®µ
        $cat_columns = $wpdb->get_results("DESCRIBE $category_map_table");
        $cat_existing_columns = array_column($cat_columns, 'Field');

        $cat_required_columns = ['local_category_ids', 'created_at', 'updated_at'];
        $cat_missing_columns = array_diff($cat_required_columns, $cat_existing_columns);

        if (!empty($cat_missing_columns)) {
            woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'å¼€å§‹', [
                'table' => $category_map_table,
                'existing_columns' => $cat_existing_columns,
                'missing_columns' => $cat_missing_columns
            ], 'å¼€å§‹æ›´æ–°walmart_category_mapè¡¨ç»“æ„');

            // æ·»åŠ ç¼ºå¤±çš„å­—æ®µ
            foreach ($cat_missing_columns as $column) {
                switch ($column) {
                    case 'local_category_ids':
                        $wpdb->query("ALTER TABLE $category_map_table ADD COLUMN local_category_ids longtext DEFAULT NULL COMMENT 'å…±äº«æ˜ å°„çš„æœ¬åœ°åˆ†ç±»IDæ•°ç»„(JSONæ ¼å¼)' AFTER walmart_attributes");
                        break;
                    case 'created_at':
                        $wpdb->query("ALTER TABLE $category_map_table ADD COLUMN created_at datetime DEFAULT CURRENT_TIMESTAMP AFTER local_category_ids");
                        break;
                    case 'updated_at':
                        $wpdb->query("ALTER TABLE $category_map_table ADD COLUMN updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP AFTER created_at");
                        break;
                }

                if ($wpdb->last_error) {
                    woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'é”™è¯¯', [
                        'table' => $category_map_table,
                        'column' => $column,
                        'error' => $wpdb->last_error
                    ], "æ·»åŠ å­—æ®µ {$column} å¤±è´¥");
                } else {
                    woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'æˆåŠŸ', [
                        'table' => $category_map_table,
                        'column' => $column
                    ], "æˆåŠŸæ·»åŠ å­—æ®µ {$column}");
                }
            }

            // æ·»åŠ ç´¢å¼•
            $wpdb->query("ALTER TABLE $category_map_table ADD INDEX walmart_category_path (walmart_category_path(100))");

            woo_walmart_sync_log('è¡¨ç»“æ„æ›´æ–°', 'å®Œæˆ', [
                'table' => $category_map_table,
                'added_columns' => $cat_missing_columns
            ], 'walmart_category_mapè¡¨ç»“æ„æ›´æ–°å®Œæˆ');
        }
    }
}

// åœ¨æ‰¹é‡æ“ä½œä¸­æ·»åŠ é€‰é¡¹
add_filter('bulk_actions-edit-product', function($bulk_actions) {
    $bulk_actions['walmart_batch_sync'] = 'åŒæ­¥åˆ° Walmart';
    $bulk_actions['walmart_mark_synced'] = 'æ ‡è®°ä¸ºå·²åŒæ­¥';
    $bulk_actions['walmart_mark_not_synced'] = 'æ ‡è®°ä¸ºæœªåŒæ­¥';
    return $bulk_actions;
});

// å¤„ç†æ‰¹é‡æ“ä½œ
add_filter('handle_bulk_actions-edit-product', function($redirect_to, $action, $post_ids) {
    // å¤„ç†æ ‡è®°æ“ä½œ
    if ($action === 'walmart_mark_synced') {
        return handle_walmart_mark_bulk_action($redirect_to, $post_ids, 'synced');
    }

    if ($action === 'walmart_mark_not_synced') {
        return handle_walmart_mark_bulk_action($redirect_to, $post_ids, 'not_synced');
    }

    if ($action !== 'walmart_batch_sync') {
        return $redirect_to;
    }

    $product_count = count($post_ids);
    $sync_strategy = determine_sync_method($product_count);

    // åˆ›å»ºæ‰¹é‡å¤„ç†
    $batch_builder = new Walmart_Batch_Feed_Builder();
    $result = $batch_builder->create_batch($post_ids, $sync_strategy['method']);

    if ($result['success']) {
        // ä¸ç›´æ¥è·³è½¬ï¼Œè€Œæ˜¯è¿”å›åˆ°å½“å‰é¡µé¢å¹¶æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        return add_query_arg([
            'walmart_batch_created' => 1,
            'product_count' => $product_count,
            'sync_method' => $sync_strategy['method'],
            'sync_description' => urlencode($sync_strategy['description']),
            'batch_id' => $result['batch_id'] ?? '',
            'show_redirect_prompt' => 1
        ], $redirect_to);
    } else {
        return add_query_arg('walmart_batch_error', urlencode($result['message']), $redirect_to);
    }
}, 10, 3);

// åœ¨åå°æ˜¾ç¤ºæ‰¹é‡æ“ä½œç»“æœçš„é€šçŸ¥
add_action('admin_notices', function() {
    if (!empty($_REQUEST['walmart_batch_created'])) {
        $count = intval($_REQUEST['product_count']);
        $sync_method = sanitize_text_field($_REQUEST['sync_method']);
        $sync_description = urldecode($_REQUEST['sync_description']);
        $batch_id = sanitize_text_field($_REQUEST['batch_id'] ?? '');
        $show_redirect_prompt = !empty($_REQUEST['show_redirect_prompt']);

        if ($show_redirect_prompt) {
            // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯å’Œè·³è½¬ç¡®è®¤å¼¹çª—
            $queue_url = admin_url('admin.php?page=woo-walmart-queue-manager');
            if ($batch_id) {
                $queue_url = add_query_arg('batch_id', $batch_id, $queue_url);
            }

            printf(
                '<div class="updated notice is-dismissible" id="walmart-batch-success-notice" style="border-left-color: #00a32a;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 20px;">âœ…</span>
                        <strong style="color: #00a32a; font-size: 16px;">æ‰¹é‡åŒæ­¥å·²å¯åŠ¨ï¼</strong>
                    </div>
                    <div style="margin-bottom: 15px; padding: 10px; background: #f0f6fc; border-radius: 4px;">
                        <p style="margin: 5px 0;"><strong>å•†å“æ•°é‡ï¼š</strong>%d ä¸ª</p>
                        <p style="margin: 5px 0;"><strong>åŒæ­¥æ–¹å¼ï¼š</strong>%s</p>
                        <p style="margin: 5px 0; color: #646970;">æ‚¨çš„å•†å“æ­£åœ¨åå°å¤„ç†ä¸­ï¼Œå¯ä»¥é€‰æ‹©æŸ¥çœ‹è¿›åº¦æˆ–ç»§ç»­å…¶ä»–æ“ä½œã€‚</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button type="button" class="button button-primary" onclick="walmartRedirectToQueue(\'%s\')" style="display: flex; align-items: center; gap: 5px;">
                            <span class="dashicons dashicons-list-view" style="font-size: 16px; width: 16px; height: 16px;"></span>
                            æŸ¥çœ‹åŒæ­¥é˜Ÿåˆ—
                        </button>
                        <button type="button" class="button button-secondary" onclick="walmartDismissNotice()" style="display: flex; align-items: center; gap: 5px;">
                            <span class="dashicons dashicons-dismiss" style="font-size: 16px; width: 16px; height: 16px;"></span>
                            ç»§ç»­åœ¨æ­¤é¡µé¢
                        </button>
                        <span style="color: #646970; font-size: 12px; margin-left: 10px;">
                            ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥éšæ—¶é€šè¿‡èœå•è®¿é—®åŒæ­¥é˜Ÿåˆ—
                        </span>
                    </div>
                </div>
                <script>
                function walmartRedirectToQueue(url) {
                    // æ·»åŠ æ·¡å‡ºæ•ˆæœ
                    const notice = document.getElementById("walmart-batch-success-notice");
                    notice.style.transition = "opacity 0.3s ease";
                    notice.style.opacity = "0.5";

                    setTimeout(function() {
                        window.location.href = url;
                    }, 200);
                }
                function walmartDismissNotice() {
                    const notice = document.getElementById("walmart-batch-success-notice");
                    notice.style.transition = "opacity 0.3s ease, transform 0.3s ease";
                    notice.style.opacity = "0";
                    notice.style.transform = "translateY(-10px)";

                    setTimeout(function() {
                        notice.style.display = "none";
                    }, 300);
                }

                // è‡ªåŠ¨å…³é—­åŠŸèƒ½ï¼ˆ30ç§’åï¼‰
                setTimeout(function() {
                    const notice = document.getElementById("walmart-batch-success-notice");
                    if (notice && notice.style.display !== "none") {
                        const autoCloseMsg = document.createElement("div");
                        autoCloseMsg.style.cssText = "margin-top: 10px; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 12px; color: #856404;";
                        autoCloseMsg.innerHTML = "â° æ­¤é€šçŸ¥å°†åœ¨10ç§’åè‡ªåŠ¨å…³é—­...";
                        notice.appendChild(autoCloseMsg);

                        setTimeout(function() {
                            if (notice && notice.style.display !== "none") {
                                walmartDismissNotice();
                            }
                        }, 10000);
                    }
                }, 30000);
                </script>',
                $count,
                esc_html($sync_description),
                esc_url($queue_url)
            );
        } else {
            // æ™®é€šæˆåŠŸä¿¡æ¯ï¼ˆä¸æ˜¾ç¤ºè·³è½¬é€‰é¡¹ï¼‰
            printf(
                '<div class="updated notice is-dismissible">
                    <p><strong>æ‰¹é‡åŒæ­¥å·²å¯åŠ¨ï¼</strong></p>
                    <p>å•†å“æ•°é‡ï¼š%d ä¸ª</p>
                    <p>åŒæ­¥æ–¹å¼ï¼š%s</p>
                    <p>æ‚¨å¯ä»¥åœ¨æ­¤é¡µé¢ç›‘æ§å¤„ç†è¿›åº¦ã€‚</p>
                </div>',
                $count,
                esc_html($sync_description)
            );
        }
    }

    if (!empty($_REQUEST['walmart_batch_error'])) {
        $error_message = urldecode($_REQUEST['walmart_batch_error']);
        printf('<div class="error notice is-dismissible"><p><strong>æ‰¹é‡åŒæ­¥å¤±è´¥ï¼š</strong>%s</p></div>', esc_html($error_message));
    }

    // æ˜¾ç¤ºæ ‡è®°æ“ä½œç»“æœé€šçŸ¥
    if (!empty($_REQUEST['walmart_mark_action'])) {
        $mark_action = sanitize_text_field($_REQUEST['walmart_mark_action']);
        $success_count = intval($_REQUEST['walmart_mark_success']);
        $failed_count = intval($_REQUEST['walmart_mark_failed']);
        $total_count = intval($_REQUEST['walmart_mark_total']);

        $action_text = $mark_action === 'synced' ? 'æ ‡è®°ä¸ºå·²åŒæ­¥' : 'æ ‡è®°ä¸ºæœªåŒæ­¥';
        $status_class = $success_count > 0 ? 'updated' : 'error';

        echo '<div class="' . $status_class . ' notice is-dismissible">';
        echo '<p><strong>' . $action_text . 'æ“ä½œå®Œæˆï¼š</strong></p>';
        echo '<ul>';
        if ($success_count > 0) {
            echo '<li>âœ… æˆåŠŸï¼š' . $success_count . ' ä¸ªäº§å“</li>';
        }
        if ($failed_count > 0) {
            echo '<li>âŒ å¤±è´¥ï¼š' . $failed_count . ' ä¸ªäº§å“</li>';
        }
        echo '<li>ğŸ“Š æ€»è®¡ï¼š' . $total_count . ' ä¸ªäº§å“</li>';
        echo '</ul>';
        echo '</div>';
    }
});

// å¤„ç†æ²ƒå°”ç›åŒæ­¥çŠ¶æ€æ ‡è®°æ‰¹é‡æ“ä½œ
function handle_walmart_mark_bulk_action($redirect_to, $post_ids, $mark_status) {
    if (empty($post_ids)) {
        return $redirect_to;
    }

    $success_count = 0;
    $failed_count = 0;

    foreach ($post_ids as $post_id) {
        // éªŒè¯æ˜¯å¦ä¸ºäº§å“
        if (get_post_type($post_id) !== 'product') {
            $failed_count++;
            continue;
        }

        // æ›´æ–°äº§å“çš„æ‰‹åŠ¨æ ‡è®°çŠ¶æ€
        $result = update_post_meta($post_id, '_walmart_sync_manual_status', $mark_status);

        if ($result !== false) {
            $success_count++;

            // è®°å½•æ—¥å¿—
            woo_walmart_sync_log('æ‰‹åŠ¨æ ‡è®°åŒæ­¥çŠ¶æ€', 'æˆåŠŸ', [
                'product_id' => $post_id,
                'mark_status' => $mark_status,
                'action' => $mark_status === 'synced' ? 'æ ‡è®°ä¸ºå·²åŒæ­¥' : 'æ ‡è®°ä¸ºæœªåŒæ­¥'
            ], "äº§å“ {$post_id} å·²" . ($mark_status === 'synced' ? 'æ ‡è®°ä¸ºå·²åŒæ­¥' : 'æ ‡è®°ä¸ºæœªåŒæ­¥'));
        } else {
            $failed_count++;
        }
    }

    // æ·»åŠ ç»“æœå‚æ•°åˆ°é‡å®šå‘URL
    $redirect_to = add_query_arg([
        'walmart_mark_action' => $mark_status,
        'walmart_mark_success' => $success_count,
        'walmart_mark_failed' => $failed_count,
        'walmart_mark_total' => count($post_ids)
    ], $redirect_to);

    return $redirect_to;
}

// å®šæ—¶ä»»åŠ¡æ‰§è¡Œçš„å‡½æ•°
add_action('walmart_check_feed_status_hook', function() {
    // 0. å®šæ—¶ä»»åŠ¡å¥åº·æ£€æŸ¥ - ç¡®ä¿ä¸‹æ¬¡æ‰§è¡Œå·²å®‰æ’
    $next_scheduled = wp_next_scheduled('walmart_check_feed_status_hook');
    if (!$next_scheduled || $next_scheduled <= time()) {
        // å¦‚æœæ²¡æœ‰ä¸‹æ¬¡æ‰§è¡Œè®¡åˆ’æˆ–å·²è¿‡æœŸï¼Œé‡æ–°å®‰æ’
        wp_clear_scheduled_hook('walmart_check_feed_status_hook');
        wp_schedule_event(time() + 300, 'every_five_minutes', 'walmart_check_feed_status_hook');

        woo_walmart_sync_log('å®šæ—¶ä»»åŠ¡å¥åº·æ£€æŸ¥', 'ä¿®å¤', [
            'next_scheduled_before' => $next_scheduled,
            'current_time' => time(),
            'rescheduled_time' => time() + 300
        ], 'æ£€æµ‹åˆ°å®šæ—¶ä»»åŠ¡ä¸¢å¤±æˆ–è¿‡æœŸï¼Œå·²é‡æ–°å®‰æ’');
    }

    // 1. å¤„ç†åŒæ­¥é˜Ÿåˆ— - æ¯æ¬¡åªå¤„ç†1ä¸ªå•†å“
    $queue = get_option('walmart_sync_queue', []);
    if (!empty($queue)) {
        // æ¯æ¬¡åªå¤„ç†1ä¸ªå•†å“
        $product_id = array_shift($queue);

        $sync = new Woo_Walmart_Product_Sync();
        $sync->initiate_sync($product_id);

        // æ›´æ–°é˜Ÿåˆ—ï¼ˆç§»é™¤å·²å¤„ç†çš„å•†å“ï¼‰
        update_option('walmart_sync_queue', $queue);

        // è®°å½•å¤„ç†è¿›åº¦
        $remaining_count = count($queue);
        woo_walmart_sync_log('é˜Ÿåˆ—å¤„ç†è¿›åº¦', 'è°ƒè¯•', [
            'processed_product_id' => $product_id,
            'remaining_count' => $remaining_count
        ], "å·²å¤„ç†å•†å“ID: {$product_id}ï¼Œé˜Ÿåˆ—å‰©ä½™: {$remaining_count}ä¸ª");
    }

    // 2. ä¼˜åŒ–FeedçŠ¶æ€æ£€æŸ¥é¢‘ç‡ - æ”¹ä¸ºæ¯3æ¬¡æ£€æŸ¥ä¸€æ¬¡ï¼ˆ15åˆ†é’Ÿï¼‰è€Œä¸æ˜¯10æ¬¡ï¼ˆ50åˆ†é’Ÿï¼‰
    $check_counter = get_option('walmart_feed_check_counter', 0);
    $check_counter++;

    if ($check_counter >= 3) {
        $sync = new Woo_Walmart_Product_Sync();
        $sync->check_feed_statuses();
        $check_counter = 0;

        woo_walmart_sync_log('FeedçŠ¶æ€æ£€æŸ¥', 'æ‰§è¡Œ', [
            'check_counter_reset' => true,
            'execution_time' => current_time('mysql')
        ], 'FeedçŠ¶æ€æ£€æŸ¥å·²æ‰§è¡Œï¼Œè®¡æ•°å™¨å·²é‡ç½®');
    }

    update_option('walmart_feed_check_counter', $check_counter);
});

// åæ¿€æ´»æ—¶æ¸…é™¤å®šæ—¶ä»»åŠ¡
register_deactivation_hook(__FILE__, function() {
    wp_clear_scheduled_hook('walmart_check_feed_status_hook');
    wp_clear_scheduled_hook('walmart_daily_stats_update');
});

// æ¯æ—¥ç»Ÿè®¡æ›´æ–°ä»»åŠ¡å¤„ç†å‡½æ•°
add_action('walmart_daily_stats_update', 'woo_walmart_sync_update_daily_stats');

function woo_walmart_sync_update_daily_stats() {
    try {
        require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-local-data-manager.php';
        $local_data_manager = new Walmart_Local_Data_Manager();

        // å¼ºåˆ¶æ›´æ–°å…¨å±€ç»Ÿè®¡
        delete_option('walmart_global_diff_stats');
        delete_option('walmart_global_diff_stats_time');

        $stats = $local_data_manager->get_global_difference_stats();

        woo_walmart_sync_log('æ¯æ—¥ç»Ÿè®¡æ›´æ–°', 'æˆåŠŸ', $stats, 'æ¯æ—¥0ç‚¹ç»Ÿè®¡æ›´æ–°å®Œæˆ');

    } catch (Exception $e) {
        woo_walmart_sync_log('æ¯æ—¥ç»Ÿè®¡æ›´æ–°', 'é”™è¯¯', [
            'error' => $e->getMessage()
        ], 'æ¯æ—¥ç»Ÿè®¡æ›´æ–°å¤±è´¥');
    }
}

// å¢åŠ è‡ªå®šä¹‰çš„croné—´éš”
add_filter('cron_schedules', function($schedules) {
    $schedules['every_five_minutes'] = [
        'interval' => 300, // 5åˆ†é’Ÿ
        'display'  => __('Every 5 Minutes'),
    ];
    return $schedules;
});

// æ’ä»¶å¥åº·ç›‘æ§å’Œè‡ªæ„ˆç³»ç»Ÿ
add_action('init', function() {
    // åªåœ¨ç®¡ç†åå°æˆ–å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶æ£€æŸ¥
    if (!is_admin() && !wp_doing_cron()) {
        return;
    }

    // æ‰§è¡Œå…¨é¢çš„å¥åº·æ£€æŸ¥
    walmart_plugin_health_check();
}, 1); // ä¼˜å…ˆçº§è®¾ä¸º1ï¼Œç¡®ä¿æ—©æœŸæ‰§è¡Œ

/**
 * æ’ä»¶å¥åº·æ£€æŸ¥å’Œè‡ªæ„ˆç³»ç»Ÿ
 * ç¡®ä¿æ’ä»¶åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½æ­£å¸¸è¿è¡Œ
 */
function walmart_plugin_health_check() {
    $health_issues = [];
    $auto_fixes = [];

    // 1. æ£€æŸ¥å®šæ—¶ä»»åŠ¡
    $cron_issues = walmart_check_cron_health();
    if (!empty($cron_issues['issues'])) {
        $health_issues = array_merge($health_issues, $cron_issues['issues']);
    }
    if (!empty($cron_issues['fixes'])) {
        $auto_fixes = array_merge($auto_fixes, $cron_issues['fixes']);
    }

    // 2. æ£€æŸ¥æ•°æ®åº“è¡¨
    $db_issues = walmart_check_database_health();
    if (!empty($db_issues['issues'])) {
        $health_issues = array_merge($health_issues, $db_issues['issues']);
    }
    if (!empty($db_issues['fixes'])) {
        $auto_fixes = array_merge($auto_fixes, $db_issues['fixes']);
    }

    // 3. æ£€æŸ¥é…ç½®å®Œæ•´æ€§
    $config_issues = walmart_check_config_health();
    if (!empty($config_issues['issues'])) {
        $health_issues = array_merge($health_issues, $config_issues['issues']);
    }
    if (!empty($config_issues['fixes'])) {
        $auto_fixes = array_merge($auto_fixes, $config_issues['fixes']);
    }

    // 4. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
    $data_issues = walmart_check_data_consistency();
    if (!empty($data_issues['issues'])) {
        $health_issues = array_merge($health_issues, $data_issues['issues']);
    }
    if (!empty($data_issues['fixes'])) {
        $auto_fixes = array_merge($auto_fixes, $data_issues['fixes']);
    }

    // è®°å½•å¥åº·æ£€æŸ¥ç»“æœ
    if (!empty($health_issues) || !empty($auto_fixes)) {
        woo_walmart_sync_log('æ’ä»¶å¥åº·æ£€æŸ¥', 'ç³»ç»Ÿ', [
            'health_issues' => $health_issues,
            'auto_fixes' => $auto_fixes,
            'check_time' => current_time('mysql'),
            'context' => is_admin() ? 'admin' : 'cron'
        ], 'æ’ä»¶å¥åº·æ£€æŸ¥å®Œæˆ - å‘ç°é—®é¢˜: ' . count($health_issues) . ', è‡ªåŠ¨ä¿®å¤: ' . count($auto_fixes));
    }
}

/**
 * æ£€æŸ¥å®šæ—¶ä»»åŠ¡å¥åº·çŠ¶æ€
 */
function walmart_check_cron_health() {
    $issues = [];
    $fixes = [];

    $critical_hooks = [
        'walmart_check_feed_status_hook' => 'every_five_minutes',
        'walmart_daily_stats_update' => 'daily'
    ];

    foreach ($critical_hooks as $hook => $schedule) {
        if (!wp_next_scheduled($hook)) {
            $issues[] = "å®šæ—¶ä»»åŠ¡ {$hook} æœªæ³¨å†Œ";

            // è‡ªåŠ¨ä¿®å¤
            if ($hook === 'walmart_check_feed_status_hook') {
                wp_schedule_event(time(), $schedule, $hook);
                $fixes[] = "é‡æ–°æ³¨å†Œå®šæ—¶ä»»åŠ¡ {$hook}";
            } elseif ($hook === 'walmart_daily_stats_update') {
                wp_schedule_event(strtotime('tomorrow 00:00:00'), $schedule, $hook);
                $fixes[] = "é‡æ–°æ³¨å†Œå®šæ—¶ä»»åŠ¡ {$hook}";
            }
        }
    }

    return ['issues' => $issues, 'fixes' => $fixes];
}

/**
 * æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€
 */
function walmart_check_database_health() {
    global $wpdb;
    $issues = [];
    $fixes = [];

    // æ£€æŸ¥å…³é”®è¡¨æ˜¯å¦å­˜åœ¨
    $required_tables = [
        'walmart_batch_feeds',
        'walmart_batch_items',
        'walmart_category_map',
        'walmart_feeds',
        'woo_walmart_sync_logs'
    ];

    foreach ($required_tables as $table) {
        $full_table_name = $wpdb->prefix . $table;
        $exists = $wpdb->get_var("SHOW TABLES LIKE '$full_table_name'");

        if (!$exists) {
            $issues[] = "æ•°æ®åº“è¡¨ {$full_table_name} ä¸å­˜åœ¨";
            // æ³¨æ„ï¼šè¡¨åˆ›å»ºéœ€è¦åœ¨æ’ä»¶æ¿€æ´»æ—¶å¤„ç†ï¼Œè¿™é‡Œåªè®°å½•é—®é¢˜
        }
    }

    return ['issues' => $issues, 'fixes' => $fixes];
}

/**
 * æ£€æŸ¥é…ç½®å®Œæ•´æ€§
 */
function walmart_check_config_health() {
    $issues = [];
    $fixes = [];

    // æ£€æŸ¥å…³é”®é…ç½®é¡¹
    $required_configs = [
        'woo_walmart_business_unit',
        'woo_walmart_api_version',
        'woo_walmart_fulfillment_center_id'
    ];

    foreach ($required_configs as $config) {
        $value = get_option($config, '');
        if (empty($value)) {
            $issues[] = "é…ç½®é¡¹ {$config} ä¸ºç©º";
        }
    }

    return ['issues' => $issues, 'fixes' => $fixes];
}

/**
 * æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
 */
function walmart_check_data_consistency() {
    global $wpdb;
    $issues = [];
    $fixes = [];

    // æ£€æŸ¥æ˜¯å¦æœ‰é•¿æ—¶é—´æœªæ›´æ–°çš„æ‰¹æ¬¡
    $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';
    $batch_items_table = $wpdb->prefix . 'walmart_batch_items';

    // æŸ¥æ‰¾è¶…è¿‡6å°æ—¶ä»åœ¨å¤„ç†ä¸­çš„æ‰¹æ¬¡
    $stale_batches = $wpdb->get_results(
        "SELECT batch_id, feed_id, created_at FROM $batch_feeds_table
         WHERE status IN ('SUBMITTED', 'PROCESSING')
         AND feed_id IS NOT NULL
         AND feed_id != ''
         AND created_at < DATE_SUB(NOW(), INTERVAL 6 HOUR)
         LIMIT 5"
    );

    if (!empty($stale_batches)) {
        foreach ($stale_batches as $batch) {
            $issues[] = "æ‰¹æ¬¡ {$batch->batch_id} è¶…è¿‡6å°æ—¶æœªæ›´æ–°çŠ¶æ€";

            // è‡ªåŠ¨è§¦å‘çŠ¶æ€æ£€æŸ¥
            if (class_exists('Woo_Walmart_Product_Sync')) {
                $sync = new Woo_Walmart_Product_Sync();
                // è°ƒç”¨å…¬å…±æ–¹æ³•æ¥æ£€æŸ¥ç‰¹å®šæ‰¹æ¬¡çŠ¶æ€
                $sync->check_single_batch_feed_status($batch->batch_id);
                $fixes[] = "è§¦å‘æ‰¹æ¬¡ {$batch->batch_id} çŠ¶æ€æ›´æ–°";
            }
        }
    }

    return ['issues' => $issues, 'fixes' => $fixes];
}

// é˜Ÿåˆ—ç®¡ç†é¡µé¢å†…å®¹
function woo_walmart_queue_manager_page() {
    global $wpdb;

    // å¤„ç†é˜Ÿåˆ—æ“ä½œ
    if (isset($_POST['action'])) {
        check_admin_referer('walmart_queue_action');

        switch ($_POST['action']) {
            case 'process_queue':
                // æ‰‹åŠ¨å¤„ç†é˜Ÿåˆ—
                $queue = get_option('walmart_sync_queue', []);
                if (!empty($queue)) {
                    $batch_size = isset($_POST['batch_size']) ? intval($_POST['batch_size']) : 5;
                    $process_method = isset($_POST['process_method']) ? $_POST['process_method'] : 'individual';

                    if ($process_method === 'batch_feed' && $batch_size >= 10) {
                        // ä½¿ç”¨æ‰¹é‡Feedå¤„ç†
                        $items_to_process = array_slice($queue, 0, $batch_size);
                        $batch_builder = new Walmart_Batch_Feed_Builder();
                        $sync_strategy = determine_sync_method(count($items_to_process));
                        $result = $batch_builder->create_batch($items_to_process, $sync_strategy['method']);

                        if ($result['success']) {
                            // ä»é˜Ÿåˆ—ä¸­ç§»é™¤å·²å¤„ç†çš„å•†å“
                            $remaining_queue = array_slice($queue, $batch_size);
                            update_option('walmart_sync_queue', $remaining_queue);

                            $message = 'å·²ä½¿ç”¨æ‰¹é‡Feedå¤„ç† ' . $batch_size . ' ä¸ªå•†å“ã€‚';
                            if ($result['batch_id']) {
                                $message .= ' æ‰¹æ¬¡ID: ' . $result['batch_id'];
                            }
                            echo '<div class="updated"><p>' . $message . ' é˜Ÿåˆ—ä¸­è¿˜æœ‰ ' . count($remaining_queue) . ' ä¸ªäº§å“ç­‰å¾…å¤„ç†ã€‚</p></div>';
                        } else {
                            echo '<div class="error"><p>æ‰¹é‡Feedå¤„ç†å¤±è´¥ï¼š' . $result['message'] . '</p></div>';
                        }
                    } else {
                        // ä½¿ç”¨å•ä¸ªAPIå¤„ç†
                        $items_to_process = array_slice($queue, 0, $batch_size);
                        $sync = new Woo_Walmart_Product_Sync();
                        $processed_count = 0;
                        $failed_count = 0;

                        foreach ($items_to_process as $product_id) {
                            $result = $sync->initiate_sync($product_id);
                            if ($result['success']) {
                                $processed_count++;
                            } else {
                                $failed_count++;
                            }
                        }

                        $remaining_queue = array_slice($queue, $batch_size);
                        update_option('walmart_sync_queue', $remaining_queue);

                        echo '<div class="updated"><p>å·²å¤„ç† ' . $processed_count . ' ä¸ªäº§å“ï¼Œå¤±è´¥ ' . $failed_count . ' ä¸ªï¼Œé˜Ÿåˆ—ä¸­è¿˜æœ‰ ' . count($remaining_queue) . ' ä¸ªäº§å“ç­‰å¾…å¤„ç†ã€‚</p></div>';
                    }
                } else {
                    echo '<div class="notice notice-info"><p>é˜Ÿåˆ—ä¸ºç©ºï¼Œæ²¡æœ‰éœ€è¦å¤„ç†çš„äº§å“ã€‚</p></div>';
                }
                break;

            case 'clear_queue':
                // æ¸…ç©ºé˜Ÿåˆ—
                update_option('walmart_sync_queue', []);
                echo '<div class="updated"><p>é˜Ÿåˆ—å·²æ¸…ç©ºï¼</p></div>';
                break;

            case 'remove_products':
                // ç§»é™¤æŒ‡å®šå•†å“
                if (!empty($_POST['remove_product_ids'])) {
                    $queue = get_option('walmart_sync_queue', []);
                    $remove_ids = array_map('intval', $_POST['remove_product_ids']);
                    $new_queue = array_diff($queue, $remove_ids);
                    update_option('walmart_sync_queue', array_values($new_queue));
                    echo '<div class="updated"><p>å·²ä»é˜Ÿåˆ—ä¸­ç§»é™¤ ' . count($remove_ids) . ' ä¸ªå•†å“ã€‚</p></div>';
                }
                break;

            case 'add_products':
                // æ·»åŠ å•†å“åˆ°é˜Ÿåˆ—
                if (!empty($_POST['add_product_ids'])) {
                    $queue = get_option('walmart_sync_queue', []);
                    $add_ids = array_map('intval', explode(',', $_POST['add_product_ids']));
                    $new_queue = array_unique(array_merge($queue, $add_ids));
                    update_option('walmart_sync_queue', $new_queue);
                    echo '<div class="updated"><p>å·²å‘é˜Ÿåˆ—æ·»åŠ  ' . count($add_ids) . ' ä¸ªå•†å“ã€‚</p></div>';
                }
                break;

            case 'recover_missing_products':
                // æ¢å¤ä¸¢å¤±çš„å•†å“ï¼šæ‰¾åˆ°æœ‰UPCä½†æ²¡æœ‰Feedè®°å½•çš„å•†å“
                global $wpdb;
                $upc_table = $wpdb->prefix . 'walmart_upc_pool';
                $feeds_table = $wpdb->prefix . 'walmart_feeds';

                // æŸ¥æ‰¾æœ‰UPCä½†æ²¡æœ‰Feedè®°å½•çš„å•†å“
                $missing_products = $wpdb->get_results("
                    SELECT u.product_id
                    FROM $upc_table u
                    LEFT JOIN $feeds_table f ON u.product_id = f.product_id
                    WHERE u.is_used = 1
                    AND u.product_id IS NOT NULL
                    AND f.product_id IS NULL
                ");

                if (!empty($missing_products)) {
                    $recovered_ids = [];
                    foreach ($missing_products as $row) {
                        $recovered_ids[] = $row->product_id;
                    }

                    $recovered_count = count($recovered_ids);

                    // æ™ºèƒ½é€‰æ‹©å¤„ç†æ–¹å¼
                    $sync_strategy = determine_sync_method($recovered_count);

                    if ($sync_strategy['method'] === 'individual' || $sync_strategy['method'] === 'small_batch') {
                        // å°æ‰¹é‡ï¼šåŠ å…¥é˜Ÿåˆ—å¤„ç†
                        $queue = get_option('walmart_sync_queue', []);
                        $new_queue = array_unique(array_merge($queue, $recovered_ids));
                        update_option('walmart_sync_queue', $new_queue);

                        echo '<div class="updated"><p>å·²æ¢å¤ ' . $recovered_count . ' ä¸ªä¸¢å¤±çš„å•†å“åˆ°é˜Ÿåˆ—ä¸­ã€‚å¤„ç†æ–¹å¼ï¼š' . $sync_strategy['description'] . '</p></div>';
                    } else {
                        // å¤§æ‰¹é‡ï¼šä½¿ç”¨æ‰¹é‡Feedå¤„ç†
                        $batch_builder = new Walmart_Batch_Feed_Builder();
                        $result = $batch_builder->create_batch($recovered_ids, $sync_strategy['method']);

                        if ($result['success']) {
                            $message = 'å·²æ¢å¤ ' . $recovered_count . ' ä¸ªä¸¢å¤±çš„å•†å“ï¼Œä½¿ç”¨æ‰¹é‡Feedå¤„ç†ã€‚';
                            if ($result['batch_id']) {
                                $message .= ' æ‰¹æ¬¡ID: ' . $result['batch_id'];
                            }
                            echo '<div class="updated"><p>' . $message . '</p></div>';

                            // è®°å½•æ¢å¤æ“ä½œ
                            woo_walmart_sync_log('æ¢å¤ä¸¢å¤±å•†å“', 'æˆåŠŸ', [
                                'recovered_count' => $recovered_count,
                                'sync_method' => $sync_strategy['method'],
                                'batch_id' => $result['batch_id']
                            ], 'æ‰¹é‡æ¢å¤ä¸¢å¤±å•†å“');
                        } else {
                            echo '<div class="error"><p>æ¢å¤å¤±è´¥ï¼š' . $result['message'] . '</p></div>';
                        }
                    }
                } else {
                    echo '<div class="notice notice-info"><p>æ²¡æœ‰å‘ç°ä¸¢å¤±çš„å•†å“ã€‚</p></div>';
                }
                break;

            case 'refresh_batch_status':
                // æ‰‹åŠ¨åˆ·æ–°æ‰€æœ‰æ‰¹æ¬¡çŠ¶æ€
                $sync = new Woo_Walmart_Product_Sync();
                $sync->check_batch_feed_statuses();
                echo '<div class="updated"><p>æ‰€æœ‰æ‰¹æ¬¡çŠ¶æ€å·²åˆ·æ–°ï¼</p></div>';
                break;
        }
    }

    // è·å–å½“å‰é˜Ÿåˆ—çŠ¶æ€
    $queue = get_option('walmart_sync_queue', []);
    $queue_count = count($queue);

    // è°ƒè¯•ï¼šè·å–è¯¦ç»†çŠ¶æ€ä¿¡æ¯
    $debug_info = debug_queue_status();

    // è·å–æ‰¹é‡FeedçŠ¶æ€
    $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';

    // è·å–æ´»è·ƒçš„ä¸»æ‰¹æ¬¡ï¼ˆåŒ…æ‹¬å•ä¸ªæ‰¹æ¬¡ï¼Œä¸åŒ…æ‹¬å­æ‰¹æ¬¡ï¼‰
    $active_batches = $wpdb->get_results(
        "SELECT DISTINCT * FROM $batch_feeds_table
         WHERE status IN ('PENDING', 'SUBMITTED', 'PROCESSING', 'QUEUED', 'PARTIAL_SUBMITTED')
         AND (batch_type = 'single' OR batch_type = 'master' OR batch_type IS NULL OR batch_type = '')
         ORDER BY created_at DESC
         LIMIT 10"
    );

    // è°ƒè¯•ï¼šè®°å½•æŸ¥è¯¢ç»“æœ
    if (isset($_GET['debug_delete']) && $_GET['debug_delete'] === '1') {
        woo_walmart_sync_log('æ‰¹æ¬¡æŸ¥è¯¢è°ƒè¯•', 'è°ƒè¯•', [
            'query_result_count' => count($active_batches),
            'batch_ids' => array_map(function($batch) { return $batch->batch_id; }, $active_batches),
            'sql_query' => $wpdb->last_query
        ], 'æ´»è·ƒæ‰¹æ¬¡æŸ¥è¯¢ç»“æœ');
    }

    // è·å–åˆ†é¡µå‚æ•°
    $batch_page = isset($_GET['batch_page']) ? max(1, intval($_GET['batch_page'])) : 1;
    $batch_per_page = isset($_GET['batch_per_page']) ? intval($_GET['batch_per_page']) : 10;

    // éªŒè¯æ¯é¡µæ•°é‡
    if (!in_array($batch_per_page, [10, 20, 50, 100])) {
        $batch_per_page = 10;
    }

    $batch_offset = ($batch_page - 1) * $batch_per_page;

    // è·å–æ€»æ•°
    $total_batches = $wpdb->get_var(
        "SELECT COUNT(*) FROM $batch_feeds_table
         WHERE status IN ('COMPLETED', 'ERROR')
         AND (batch_type = 'single' OR batch_type = 'master' OR batch_type IS NULL OR batch_type = '')"
    );

    // ç¡®ä¿å‚æ•°ç±»å‹æ­£ç¡®
    $batch_per_page = (int) $batch_per_page;
    $batch_offset = (int) $batch_offset;

    // è·å–å½“å‰é¡µçš„æ‰¹æ¬¡
    $recent_batches = $wpdb->get_results($wpdb->prepare(
        "SELECT * FROM $batch_feeds_table
         WHERE status IN ('COMPLETED', 'ERROR')
         AND (batch_type = 'single' OR batch_type = 'master' OR batch_type IS NULL OR batch_type = '')
         ORDER BY completed_at DESC
         LIMIT %d OFFSET %d",
        $batch_per_page,
        $batch_offset
    ));

    // è®¡ç®—åˆ†é¡µä¿¡æ¯
    $total_pages = ceil($total_batches / $batch_per_page);

    // ä¸ºæ¯ä¸ªä¸»æ‰¹æ¬¡è·å–å­æ‰¹æ¬¡ä¿¡æ¯
    foreach ($active_batches as &$batch) {
        if ($batch->batch_type === 'master') {
            $batch->sub_batches = $wpdb->get_results($wpdb->prepare(
                "SELECT * FROM $batch_feeds_table
                 WHERE parent_batch_id = %s
                 ORDER BY chunk_index ASC",
                $batch->batch_id
            ));
        }
    }

    // å¦‚æœæœ‰æŒ‡å®šçš„batch_idï¼Œé«˜äº®æ˜¾ç¤º
    $highlight_batch_id = isset($_GET['batch_id']) ? sanitize_text_field($_GET['batch_id']) : '';

    // è°ƒè¯•ï¼šæ˜¾ç¤ºæ‰¹æ¬¡æ•°æ®
    if (isset($_GET['debug']) && $_GET['debug'] === '1') {
        echo '<div class="notice notice-info"><h4>è°ƒè¯•ä¿¡æ¯ï¼š</h4>';
        echo '<p><strong>æ´»è·ƒæ‰¹æ¬¡æ•°é‡ï¼š</strong>' . count($active_batches) . '</p>';
        echo '<p><strong>æœ€è¿‘å®Œæˆæ‰¹æ¬¡æ•°é‡ï¼š</strong>' . count($recent_batches) . '</p>';
        if (!empty($active_batches)) {
            echo '<p><strong>æ´»è·ƒæ‰¹æ¬¡è¯¦æƒ…ï¼š</strong></p>';
            echo '<pre>' . print_r($active_batches, true) . '</pre>';
        }
        echo '</div>';
    }

    // è·å–æœ€è¿‘çš„é˜Ÿåˆ—å¤„ç†æ—¥å¿—
    $logs_table = $wpdb->prefix . 'woo_walmart_sync_logs';
    $recent_logs = $wpdb->get_results(
        "SELECT * FROM $logs_table
         WHERE action = 'é˜Ÿåˆ—å¤„ç†è¿›åº¦'
         ORDER BY created_at DESC
         LIMIT 20"
    );

    // è·å–å¤„ç†ç»Ÿè®¡
    $today_start = date('Y-m-d 00:00:00');
    $today_processed = $wpdb->get_var($wpdb->prepare(
        "SELECT COUNT(*) FROM $logs_table
         WHERE action = 'é˜Ÿåˆ—å¤„ç†è¿›åº¦'
         AND created_at >= %s",
        $today_start
    ));

    ?>
    <div class="wrap walmart-queue-manager">
        <h1><span class="dashicons dashicons-list-view"></span> é˜Ÿåˆ—ç®¡ç†</h1>
        <p class="description">ç›‘æ§å’Œç®¡ç†WalmartåŒæ­¥é˜Ÿåˆ—çš„å¤„ç†è¿›åº¦</p>

        <!-- æ‰¹é‡Feedç›‘æ§é¢æ¿ -->
        <?php if (!empty($active_batches) || !empty($recent_batches)): ?>
        <div class="batch-feeds-monitor">
            <h2><span class="dashicons dashicons-networking"></span> æ‰¹é‡Feedç›‘æ§</h2>

            <!-- æ´»è·ƒæ‰¹æ¬¡ -->
            <?php if (!empty($active_batches)): ?>
            <div class="active-batches-section">
                <h3>ğŸ”„ æ´»è·ƒæ‰¹æ¬¡</h3>
                <div class="batches-grid">
                    <?php
                    // ç¡®ä¿æ‰¹æ¬¡IDå”¯ä¸€æ€§
                    $displayed_batch_ids = [];
                    foreach ($active_batches as $batch):
                        // è·³è¿‡é‡å¤çš„æ‰¹æ¬¡ID
                        if (in_array($batch->batch_id, $displayed_batch_ids)) {
                            continue;
                        }
                        $displayed_batch_ids[] = $batch->batch_id;

                        $is_highlighted = ($batch->batch_id === $highlight_batch_id);
                        $batch_class = $is_highlighted ? 'batch-card highlighted' : 'batch-card';
                    ?>
                        <div class="<?php echo $batch_class; ?>" data-batch-id="<?php echo $batch->batch_id; ?>" id="batch-card-<?php echo $batch->batch_id; ?>">
                            <div class="batch-header">
                                <h4>æ‰¹æ¬¡ #<?php echo substr($batch->batch_id, -8); ?></h4>
                                <span class="batch-status status-<?php echo strtolower($batch->status ?: 'unknown'); ?>">
                                    <?php echo $batch->status ?: 'UNKNOWN'; ?>
                                </span>
                            </div>
                            <div class="batch-details">
                                <p><strong>å•†å“æ•°é‡ï¼š</strong><?php echo $batch->product_count; ?></p>
                                <p><strong>åŒæ­¥æ–¹å¼ï¼š</strong><?php echo $batch->sync_method; ?></p>

                                <?php if ($batch->batch_type === 'master'): ?>
                                    <p><strong>æ‰¹æ¬¡ç±»å‹ï¼š</strong>ä¸»æ‰¹æ¬¡ï¼ˆåˆ†ä¸º <?php echo $batch->total_chunks; ?> ä¸ªå­æ‰¹æ¬¡ï¼‰</p>
                                    <?php if (!empty($batch->sub_batches)): ?>
                                        <div class="sub-batches-summary">
                                            <p><strong>å­æ‰¹æ¬¡çŠ¶æ€ï¼š</strong></p>
                                            <div class="sub-batch-status-grid">
                                                <?php foreach ($batch->sub_batches as $sub_batch): ?>
                                                    <span class="sub-batch-status status-<?php echo strtolower($sub_batch->status ?: 'unknown'); ?>"
                                                          title="å­æ‰¹æ¬¡ <?php echo $sub_batch->chunk_index; ?>: <?php echo $sub_batch->status ?: 'UNKNOWN'; ?>">
                                                        <?php echo $sub_batch->chunk_index; ?>
                                                    </span>
                                                <?php endforeach; ?>
                                            </div>
                                        </div>
                                    <?php endif; ?>
                                <?php else: ?>
                                    <p><strong>è¿›åº¦ï¼š</strong><?php echo $batch->progress_current; ?>/<?php echo $batch->progress_total; ?></p>
                                <?php endif; ?>

                                <?php
                                // è®¡ç®—å¤„ç†ä¸­çš„æ•°é‡
                                $processing_count = $batch->product_count - $batch->success_count - $batch->failed_count;
                                ?>
                                <p>
                                    <strong>æˆåŠŸï¼š</strong>
                                    <?php if ($batch->success_count > 0): ?>
                                        <a href="#" class="batch-detail-link" data-batch-id="<?php echo $batch->batch_id; ?>" data-type="success" style="color: #0073aa; text-decoration: none;"><?php echo $batch->success_count; ?></a>
                                    <?php else: ?>
                                        <?php echo $batch->success_count; ?>
                                    <?php endif; ?>
                                    |
                                    <strong>å¤±è´¥ï¼š</strong>
                                    <?php if ($batch->failed_count > 0): ?>
                                        <a href="#" class="batch-detail-link" data-batch-id="<?php echo $batch->batch_id; ?>" data-type="failed" style="color: #d63638; text-decoration: none;"><?php echo $batch->failed_count; ?></a>
                                    <?php else: ?>
                                        <?php echo $batch->failed_count; ?>
                                    <?php endif; ?>
                                    <?php if ($processing_count > 0): ?>
                                        |
                                        <strong>å¤„ç†ä¸­ï¼š</strong>
                                        <a href="#" class="batch-detail-link" data-batch-id="<?php echo $batch->batch_id; ?>" data-type="processing" style="color: #dba617; text-decoration: none;"><?php echo $processing_count; ?></a>
                                    <?php endif; ?>
                                </p>
                                <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong><?php echo $batch->created_at; ?></p>

                                <?php if ($batch->feed_id): ?>
                                    <p><strong>Feed IDï¼š</strong><?php echo $batch->feed_id; ?></p>
                                <?php endif; ?>
                            </div>
                            <div class="batch-actions">
                                <button class="button button-small view-batch-details" data-batch-id="<?php echo $batch->batch_id; ?>">
                                    <span class="dashicons dashicons-visibility" style="font-size: 12px; margin-right: 2px;"></span>
                                    è¯¦æƒ…
                                </button>
                                <button class="button button-small refresh-batch-status"
                                        data-batch-id="<?php echo $batch->batch_id; ?>"
                                        title="åˆ·æ–°æ­¤æ‰¹æ¬¡çŠ¶æ€">
                                    <span class="dashicons dashicons-update" style="font-size: 12px; margin-right: 2px;"></span>
                                    åˆ·æ–°
                                </button>
                                <?php if ($batch->status === 'ERROR'): ?>
                                    <button class="button button-small retry-batch" data-batch-id="<?php echo $batch->batch_id; ?>">
                                        <span class="dashicons dashicons-redo" style="font-size: 12px; margin-right: 2px;"></span>
                                        é‡è¯•
                                    </button>
                                <?php endif; ?>
                                <?php if (in_array($batch->status, ['SUBMITTED', 'INPROGRESS'])): ?>
                                    <button class="button button-small process-batch-now"
                                            data-batch-id="<?php echo $batch->batch_id; ?>"
                                            title="ç«‹å³å¤„ç†æ­¤æ‰¹æ¬¡">
                                        <span class="dashicons dashicons-controls-play" style="font-size: 12px; margin-right: 2px;"></span>
                                        ç«‹å³å¤„ç†
                                    </button>
                                <?php endif; ?>
                                <button class="button button-small button-secondary mark-completed"
                                        data-batch-id="<?php echo $batch->batch_id; ?>"
                                        style="margin-right: 5px;"
                                        title="å°†æ‰¹æ¬¡æ ‡è®°ä¸ºå¤„ç†å®Œæˆ">
                                    <span class="dashicons dashicons-yes-alt" style="font-size: 12px; margin-right: 2px;"></span>
                                    æ ‡è®°ä¸ºå®Œæˆ
                                </button>
                                <button class="button button-small button-link-delete delete-batch"
                                        data-batch-id="<?php echo $batch->batch_id; ?>"
                                        onclick="return confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ‰¹æ¬¡å—ï¼Ÿ')">
                                    <span class="dashicons dashicons-trash" style="font-size: 12px; margin-right: 2px;"></span>
                                    åˆ é™¤
                                </button>
                            </div>

                            <!-- æ‰¹æ¬¡è¯¦æƒ…é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                            <div class="batch-details-panel" id="details-<?php echo $batch->batch_id; ?>" style="display: none;">
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <strong>æ‰¹æ¬¡IDï¼š</strong><?php echo $batch->batch_id; ?>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Feed IDï¼š</strong><?php echo $batch->feed_id ?: 'æœªåˆ†é…'; ?>
                                    </div>
                                    <div class="detail-item">
                                        <strong>æäº¤æ—¶é—´ï¼š</strong><?php echo $batch->submitted_at ?: 'æœªæäº¤'; ?>
                                    </div>
                                    <div class="detail-item">
                                        <strong>å®Œæˆæ—¶é—´ï¼š</strong><?php echo $batch->completed_at ?: 'æœªå®Œæˆ'; ?>
                                    </div>
                                    <?php if ($batch->error_details && $batch->status === 'ERROR'): ?>
                                        <div class="detail-item error-details">
                                            <strong>é”™è¯¯è¯¦æƒ…ï¼š</strong><?php echo esc_html($batch->error_details); ?>
                                        </div>
                                    <?php endif; ?>
                                    <?php if ($batch->status === 'SUBMITTED'): ?>
                                        <div class="detail-item">
                                            <strong>çŠ¶æ€è¯´æ˜ï¼š</strong>Feedå·²æäº¤åˆ°Walmartï¼Œç­‰å¾…å¤„ç†
                                        </div>
                                    <?php elseif ($batch->status === 'PROCESSING'): ?>
                                        <div class="detail-item">
                                            <strong>çŠ¶æ€è¯´æ˜ï¼š</strong>Walmartæ­£åœ¨å¤„ç†æ­¤æ‰¹æ¬¡
                                        </div>
                                    <?php elseif ($batch->status === 'COMPLETED'): ?>
                                        <div class="detail-item">
                                            <strong>çŠ¶æ€è¯´æ˜ï¼š</strong>æ‰¹æ¬¡å¤„ç†å®Œæˆ
                                        </div>
                                    <?php endif; ?>
                                </div>

                                <!-- æ˜¾ç¤ºæ‰¹æ¬¡ä¸­çš„å•†å“åˆ—è¡¨ -->
                                <?php
                                // ä»æ‰¹æ¬¡çš„product_idsè·å–å•†å“åˆ—è¡¨ï¼Œå¹¶æŸ¥è¯¢UPCä¿¡æ¯
                                $product_ids = json_decode($batch->product_ids, true);
                                if (!empty($product_ids)): ?>
                                    <h5>æ‰¹æ¬¡å•†å“åˆ—è¡¨ï¼š</h5>
                                    <div class="batch-items-list">
                                        <?php
                                        $upc_table = $wpdb->prefix . 'walmart_upc_pool';
                                        foreach ($product_ids as $product_id):
                                            $product = wc_get_product($product_id);
                                            if (!$product) continue;

                                            // è·å–UPCä¿¡æ¯
                                            $upc = $wpdb->get_var($wpdb->prepare(
                                                "SELECT upc_code FROM $upc_table WHERE product_id = %d AND is_used = 1",
                                                $product_id
                                            ));

                                            // è·å–FeedçŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                                            $feeds_table = $wpdb->prefix . 'walmart_feeds';
                                            $feed_status = $wpdb->get_var($wpdb->prepare(
                                                "SELECT status FROM $feeds_table WHERE product_id = %d AND feed_id = %s",
                                                $product_id,
                                                $batch->feed_id
                                            ));

                                            $status = $feed_status ?: 'PENDING';
                                        ?>
                                            <div class="batch-item">
                                                <span class="item-id">ID: <?php echo $product_id; ?></span>
                                                <span class="item-sku">SKU: <?php echo $product->get_sku() ?: 'N/A'; ?></span>
                                                <span class="item-upc">UPC: <?php echo $upc ?: 'N/A'; ?></span>
                                                <span class="item-status status-<?php echo strtolower($status ?: 'unknown'); ?>"><?php echo $status ?: 'UNKNOWN'; ?></span>
                                            </div>
                                        <?php endforeach; ?>
                                    </div>
                                <?php endif; ?>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
            <?php endif; ?>

            <!-- æœ€è¿‘å®Œæˆçš„æ‰¹æ¬¡ -->
            <?php if (!empty($recent_batches) || $total_batches > 0): ?>
            <div class="recent-batches-section">
                <div class="batches-header">
                    <h3>âœ… æœ€è¿‘å®Œæˆ</h3>
                    <div class="batches-controls">
                        <span class="batches-info">
                            å…± <?php echo $total_batches; ?> ä¸ªæ‰¹æ¬¡ï¼Œç¬¬ <?php echo $batch_page; ?> / <?php echo $total_pages; ?> é¡µ
                        </span>
                        <select id="batch-per-page" onchange="changeBatchPerPage(this.value)">
                            <option value="10" <?php selected($batch_per_page, 10); ?>>æ¯é¡µ 10 æ¡</option>
                            <option value="20" <?php selected($batch_per_page, 20); ?>>æ¯é¡µ 20 æ¡</option>
                            <option value="50" <?php selected($batch_per_page, 50); ?>>æ¯é¡µ 50 æ¡</option>
                            <option value="100" <?php selected($batch_per_page, 100); ?>>æ¯é¡µ 100 æ¡</option>
                        </select>
                    </div>
                </div>

                <?php if (!empty($recent_batches)): ?>
                <div class="recent-batches-list">
                    <?php foreach ($recent_batches as $batch): ?>
                        <div class="recent-batch-item">
                            <div class="batch-info">
                                <span class="batch-id">#<?php echo substr($batch->batch_id, -8); ?></span>
                                <span class="batch-count"><?php echo $batch->product_count; ?> ä¸ªå•†å“</span>
                                <span class="batch-method"><?php echo $batch->sync_method; ?></span>
                                <span class="batch-time"><?php echo $batch->completed_at; ?></span>
                            </div>
                            <div class="batch-result">
                                <span class="batch-status status-<?php echo strtolower($batch->status ?: 'unknown'); ?>">
                                    <?php echo $batch->status ?: 'UNKNOWN'; ?>
                                </span>
                                <span class="batch-stats">
                                    æˆåŠŸ: <a href="#" class="batch-detail-link" data-batch-id="<?php echo $batch->batch_id; ?>" data-type="success"><?php echo $batch->success_count; ?></a> |
                                    å¤±è´¥: <a href="#" class="batch-detail-link" data-batch-id="<?php echo $batch->batch_id; ?>" data-type="failed"><?php echo $batch->failed_count; ?></a>
                                </span>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
                <?php else: ?>
                <div class="no-batches">
                    <p>æš‚æ— å®Œæˆçš„æ‰¹æ¬¡è®°å½•</p>
                </div>
                <?php endif; ?>

                <!-- åˆ†é¡µæ§ä»¶ -->
                <?php if ($total_pages > 1): ?>
                <div class="batch-pagination">
                    <div class="pagination-info">
                        æ˜¾ç¤ºç¬¬ <?php echo $batch_offset + 1; ?> - <?php echo min($batch_offset + $batch_per_page, $total_batches); ?> æ¡ï¼Œå…± <?php echo $total_batches; ?> æ¡
                    </div>
                    <div class="pagination-controls">
                        <?php if ($batch_page > 1): ?>
                            <a href="<?php echo add_query_arg(['batch_page' => 1, 'batch_per_page' => $batch_per_page]); ?>" class="page-btn">é¦–é¡µ</a>
                            <a href="<?php echo add_query_arg(['batch_page' => $batch_page - 1, 'batch_per_page' => $batch_per_page]); ?>" class="page-btn">ä¸Šä¸€é¡µ</a>
                        <?php endif; ?>

                        <?php
                        // æ˜¾ç¤ºé¡µç 
                        $start_page = max(1, $batch_page - 2);
                        $end_page = min($total_pages, $batch_page + 2);

                        for ($i = $start_page; $i <= $end_page; $i++):
                        ?>
                            <a href="<?php echo add_query_arg(['batch_page' => $i, 'batch_per_page' => $batch_per_page]); ?>"
                               class="page-btn <?php echo ($i == $batch_page) ? 'current' : ''; ?>">
                                <?php echo $i; ?>
                            </a>
                        <?php endfor; ?>

                        <?php if ($batch_page < $total_pages): ?>
                            <a href="<?php echo add_query_arg(['batch_page' => $batch_page + 1, 'batch_per_page' => $batch_per_page]); ?>" class="page-btn">ä¸‹ä¸€é¡µ</a>
                            <a href="<?php echo add_query_arg(['batch_page' => $total_pages, 'batch_per_page' => $batch_per_page]); ?>" class="page-btn">æœ«é¡µ</a>
                        <?php endif; ?>
                    </div>
                </div>
                <?php endif; ?>
            </div>
            <?php endif; ?>
        </div>

        <!-- æ‰¹æ¬¡è¯¦æƒ…å¼¹çª— -->
        <div id="batch-detail-modal" class="batch-modal" style="display: none;">
            <div class="batch-modal-content">
                <div class="batch-modal-header">
                    <h3 id="batch-detail-title">æ‰¹æ¬¡è¯¦æƒ…</h3>
                    <span class="batch-modal-close">&times;</span>
                </div>
                <div class="batch-modal-body">
                    <div class="batch-detail-actions">
                        <button id="copy-all-skus" class="button button-secondary">å¤åˆ¶å…¨éƒ¨SKU</button>
                        <span id="copy-status" class="copy-status"></span>
                    </div>
                    <div id="batch-detail-content" class="batch-detail-content">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>

        <hr style="margin: 30px 0;">
        <?php endif; ?>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="queue-manager-container">
            <!-- å·¦ä¾§ï¼šçŠ¶æ€æ¦‚è§ˆå’Œæ“ä½œ -->
            <div class="queue-left-panel">
                <!-- é˜Ÿåˆ—çŠ¶æ€å¡ç‰‡ -->
                <div class="status-cards">
                    <div class="status-card queue-status">
                        <div class="card-icon">
                            <span class="dashicons dashicons-products"></span>
                        </div>
                        <div class="card-content">
                            <h3><?php echo $queue_count; ?></h3>
                            <p>é˜Ÿåˆ—ä¸­çš„å•†å“</p>
                        </div>
                    </div>

                    <div class="status-card time-status">
                        <div class="card-icon">
                            <span class="dashicons dashicons-clock"></span>
                        </div>
                        <div class="card-content">
                            <h3><?php echo $queue_count > 0 ? ceil($queue_count * 3 / 60) . ' åˆ†é’Ÿ' : '0'; ?></h3>
                            <p>é¢„è®¡å®Œæˆæ—¶é—´</p>
                        </div>
                    </div>

                    <div class="status-card processed-status">
                        <div class="card-icon">
                            <span class="dashicons dashicons-yes-alt"></span>
                        </div>
                        <div class="card-content">
                            <h3><?php echo $today_processed; ?></h3>
                            <p>ä»Šæ—¥å·²å¤„ç†</p>
                        </div>
                    </div>

                    <div class="status-card upc-status">
                        <div class="card-icon">
                            <span class="dashicons dashicons-tag"></span>
                        </div>
                        <div class="card-content">
                            <h3><?php echo $debug_info['used_upcs']; ?> / <?php echo $debug_info['total_upcs']; ?></h3>
                            <p>UPCä½¿ç”¨æƒ…å†µ</p>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œé¢æ¿ -->
                <div class="quick-actions-panel">
                    <h3><span class="dashicons dashicons-admin-tools"></span> å¿«é€Ÿæ“ä½œ</h3>
                    <div class="action-buttons">
                        <form method="post" class="action-form">
                            <?php wp_nonce_field('walmart_queue_action'); ?>
                            <input type="hidden" name="action" value="process_queue">
                            <div class="batch-control">
                                <div class="control-row">
                                    <label>å¤„ç†æ•°é‡ï¼š</label>
                                    <select name="batch_size" id="batch_size">
                                        <option value="1">1ä¸ª</option>
                                        <option value="5" selected>5ä¸ª</option>
                                        <option value="10">10ä¸ª</option>
                                        <option value="20">20ä¸ª</option>
                                        <option value="50">50ä¸ª</option>
                                        <option value="100">100ä¸ª</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <label>å¤„ç†æ–¹å¼ï¼š</label>
                                    <select name="process_method" id="process_method">
                                        <option value="individual">å•ä¸ªAPIï¼ˆé€‚åˆå°æ‰¹é‡ï¼‰</option>
                                        <option value="batch_feed">æ‰¹é‡Feedï¼ˆé€‚åˆå¤§æ‰¹é‡ï¼‰</option>
                                    </select>
                                </div>
                                <button type="submit" class="button button-primary" <?php echo $queue_count == 0 ? 'disabled' : ''; ?>>
                                    <span class="dashicons dashicons-controls-play"></span> ç«‹å³å¤„ç†
                                </button>
                            </div>
                        </form>

                        <form method="post" class="action-form" onsubmit="return confirm('ç¡®å®šè¦æ¢å¤ä¸¢å¤±çš„å•†å“å—ï¼Ÿ');">
                            <?php wp_nonce_field('walmart_queue_action'); ?>
                            <input type="hidden" name="action" value="recover_missing_products">
                            <button type="submit" class="button button-secondary">
                                <span class="dashicons dashicons-backup"></span> æ¢å¤ä¸¢å¤±å•†å“
                            </button>
                        </form>



                        <form method="post" class="action-form" onsubmit="return confirm('ç¡®å®šè¦æ¸…ç©ºæ•´ä¸ªé˜Ÿåˆ—å—ï¼Ÿ');">
                            <?php wp_nonce_field('walmart_queue_action'); ?>
                            <input type="hidden" name="action" value="clear_queue">
                            <button type="submit" class="button button-link-delete" <?php echo $queue_count == 0 ? 'disabled' : ''; ?>>
                                <span class="dashicons dashicons-trash"></span> æ¸…ç©ºé˜Ÿåˆ—
                            </button>
                        </form>
                    </div>
                </div>

                <!-- æ·»åŠ å•†å“é¢æ¿ -->
                <div class="add-products-panel">
                    <h3><span class="dashicons dashicons-plus-alt"></span> æ·»åŠ å•†å“åˆ°é˜Ÿåˆ—</h3>
                    <form method="post" class="add-form">
                        <?php wp_nonce_field('walmart_queue_action'); ?>
                        <input type="hidden" name="action" value="add_products">
                        <div class="input-group">
                            <input type="text" name="add_product_ids" placeholder="è¾“å…¥å•†å“IDï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼š123,456,789" class="regular-text">
                            <button type="submit" class="button button-secondary">
                                <span class="dashicons dashicons-plus"></span> æ·»åŠ 
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè¯¦ç»†ä¿¡æ¯å’Œæ—¥å¿— -->
            <div class="queue-right-panel">
                <!-- ç³»ç»ŸçŠ¶æ€è¯¦æƒ… -->
                <div class="system-status-panel">
                    <h3><span class="dashicons dashicons-info"></span> ç³»ç»ŸçŠ¶æ€</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <label>Feedè®°å½•æ€»æ•°ï¼š</label>
                            <span class="value"><?php echo $debug_info['total_feeds']; ?> ä¸ª</span>
                        </div>
                        <div class="status-item">
                            <label>å¾…å¤„ç†Feedï¼š</label>
                            <span class="value <?php echo $debug_info['pending_feeds'] > 0 ? 'pending' : 'success'; ?>">
                                <?php echo $debug_info['pending_feeds']; ?> ä¸ª
                            </span>
                        </div>
                        <div class="status-item">
                            <label>å¤„ç†é¢‘ç‡ï¼š</label>
                            <span class="value">æ¯3ç§’1ä¸ªå•†å“</span>
                        </div>
                        <div class="status-item">
                            <label>é˜Ÿåˆ—çŠ¶æ€ï¼š</label>
                            <span class="value <?php echo $queue_count > 0 ? 'processing' : 'idle'; ?>">
                                <?php echo $queue_count > 0 ? 'å¤„ç†ä¸­' : 'ç©ºé—²'; ?>
                            </span>
                        </div>
                    </div>

                    <?php if ($debug_info['used_upcs'] != $debug_info['total_feeds']): ?>
                    <div class="alert alert-warning">
                        <span class="dashicons dashicons-warning"></span>
                        <strong>æ³¨æ„ï¼š</strong>UPCä½¿ç”¨æ•°é‡(<?php echo $debug_info['used_upcs']; ?>)ä¸Feedè®°å½•æ•°é‡(<?php echo $debug_info['total_feeds']; ?>)ä¸åŒ¹é…ï¼Œå¯èƒ½æœ‰å•†å“åŒæ­¥å¤±è´¥ã€‚
                    </div>
                    <?php endif; ?>
                </div>

                <!-- æœ€è¿‘å¤„ç†æ—¥å¿— -->
                <div class="recent-logs-panel">
                    <h3><span class="dashicons dashicons-admin-page"></span> æœ€è¿‘å¤„ç†æ—¥å¿—</h3>
                    <?php if (!empty($recent_logs)): ?>
                    <div class="logs-container">
                        <?php foreach (array_slice($recent_logs, 0, 10) as $log):
                            $request_data = json_decode($log->request, true);
                            $processed_id = isset($request_data['processed_product_id']) ? $request_data['processed_product_id'] : 'N/A';
                            $remaining = isset($request_data['remaining_count']) ? $request_data['remaining_count'] : 'N/A';
                        ?>
                        <div class="log-item">
                            <div class="log-time"><?php echo date('H:i:s', strtotime($log->created_at)); ?></div>
                            <div class="log-content">
                                <span class="product-id">å•†å“ #<?php echo $processed_id; ?></span>
                                <span class="remaining">å‰©ä½™ <?php echo $remaining; ?> ä¸ª</span>
                            </div>
                        </div>
                        <?php endforeach; ?>
                    </div>
                    <?php else: ?>
                    <div class="no-logs">
                        <span class="dashicons dashicons-info"></span>
                        <p>æš‚æ— å¤„ç†æ—¥å¿—</p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- å½“å‰é˜Ÿåˆ—å•†å“ -->
        <?php if ($queue_count > 0): ?>
        <div class="queue-products-section">
            <h2><span class="dashicons dashicons-list-view"></span> å½“å‰é˜Ÿåˆ—å•†å“ <span class="count-badge"><?php echo $queue_count; ?></span></h2>
            <form method="post" class="queue-products-form">
                <?php wp_nonce_field('walmart_queue_action'); ?>
                <input type="hidden" name="action" value="remove_products">

                <div class="products-table-container">
                    <table class="wp-list-table widefat fixed striped">
                        <thead>
                            <tr>
                                <th class="check-column"><input type="checkbox" id="select-all"></th>
                                <th class="column-id">ID</th>
                                <th class="column-name">å•†å“åç§°</th>
                                <th class="column-sku">SKU</th>
                                <th class="column-status">çŠ¶æ€</th>
                                <th class="column-position">é˜Ÿåˆ—ä½ç½®</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php
                            $display_queue = array_slice($queue, 0, 50);
                            foreach ($display_queue as $index => $product_id):
                                $product = wc_get_product($product_id);
                                $product_name = $product ? $product->get_name() : "å•†å“ä¸å­˜åœ¨";
                                $sku = $product ? $product->get_sku() : "N/A";
                                $status = $product ? $product->get_status() : "unknown";
                                $status_class = $product ? ($status == 'publish' ? 'status-published' : 'status-draft') : 'status-error';
                            ?>
                            <tr>
                                <td><input type="checkbox" name="remove_product_ids[]" value="<?php echo $product_id; ?>"></td>
                                <td class="product-id"><?php echo $product_id; ?></td>
                                <td class="product-name">
                                    <?php if ($product): ?>
                                        <strong><?php echo esc_html(wp_trim_words($product_name, 8)); ?></strong>
                                    <?php else: ?>
                                        <span class="error">å•†å“ä¸å­˜åœ¨</span>
                                    <?php endif; ?>
                                </td>
                                <td class="product-sku"><?php echo esc_html($sku); ?></td>
                                <td class="product-status">
                                    <span class="status-indicator <?php echo $status_class; ?>">
                                        <?php echo esc_html($status); ?>
                                    </span>
                                </td>
                                <td class="queue-position">
                                    <span class="position-badge">#<?php echo ($index + 1); ?></span>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>

                <?php if ($queue_count > 50): ?>
                <div class="pagination-info">
                    <span class="dashicons dashicons-info"></span>
                    æ˜¾ç¤ºå‰50ä¸ªå•†å“ï¼Œè¿˜æœ‰ <strong><?php echo ($queue_count - 50); ?></strong> ä¸ªå•†å“æœªæ˜¾ç¤º
                </div>
                <?php endif; ?>

                <div class="bulk-actions">
                    <button type="submit" class="button button-secondary" onclick="return confirm('ç¡®å®šè¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤é€‰ä¸­çš„å•†å“å—ï¼Ÿ');">
                        <span class="dashicons dashicons-dismiss"></span> ç§»é™¤é€‰ä¸­å•†å“
                    </button>
                </div>
            </form>
        </div>
        <?php else: ?>
        <div class="empty-queue">
            <div class="empty-icon">
                <span class="dashicons dashicons-list-view"></span>
            </div>
            <h3>é˜Ÿåˆ—ä¸ºç©º</h3>
            <p>å½“å‰æ²¡æœ‰å•†å“åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­</p>
        </div>
        <?php endif; ?>
    </div>

    <style>
    /* é˜Ÿåˆ—ç®¡ç†é¡µé¢æ ·å¼ */
    .walmart-queue-manager {
        max-width: 1600px;
    }

    /* æ‰¹é‡Feedç›‘æ§æ ·å¼ */
    .batch-feeds-monitor {
        background: #fff;
        border: 1px solid #e1e1e1;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .batch-feeds-monitor h2 {
        margin: 0 0 25px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #333;
    }

    .active-batches-section,
    .recent-batches-section {
        margin-bottom: 25px;
    }

    .active-batches-section h3,
    .recent-batches-section h3 {
        margin: 0 0 15px 0;
        color: #555;
        font-size: 16px;
    }

    /* æ‰¹æ¬¡ç½‘æ ¼ - è‡ªé€‚åº”å¸ƒå±€ */
    .batches-grid {
        display: grid;
        gap: 20px;
        margin-bottom: 20px;
    }

    /* 1ä¸ªæ‰¹æ¬¡ï¼šå…¨å± */
    .batches-grid:has(.batch-card:nth-child(1):last-child) {
        grid-template-columns: 1fr;
    }

    /* 2ä¸ªæ‰¹æ¬¡ï¼šä¸¤åˆ— */
    .batches-grid:has(.batch-card:nth-child(2):last-child) {
        grid-template-columns: 1fr 1fr;
    }

    /* 3ä¸ªæ‰¹æ¬¡ï¼šä¸‰åˆ— */
    .batches-grid:has(.batch-card:nth-child(3):last-child) {
        grid-template-columns: 1fr 1fr 1fr;
    }

    /* 4ä¸ªæˆ–æ›´å¤šæ‰¹æ¬¡ï¼šæœ€å¤šä¸‰åˆ—ï¼Œè‡ªåŠ¨æ¢è¡Œ */
    .batches-grid:has(.batch-card:nth-child(4)) {
        grid-template-columns: repeat(3, 1fr);
    }

    /* å“åº”å¼ï¼šä¸­ç­‰å±å¹• */
    @media (max-width: 1200px) {
        .batches-grid:has(.batch-card:nth-child(3):last-child),
        .batches-grid:has(.batch-card:nth-child(4)) {
            grid-template-columns: 1fr 1fr;
        }
    }

    /* å“åº”å¼ï¼šå°å±å¹• */
    @media (max-width: 768px) {
        .batches-grid {
            grid-template-columns: 1fr !important;
        }
    }

    /* å…¼å®¹æ€§ï¼šå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ:has()ï¼Œä½¿ç”¨é»˜è®¤å¸ƒå±€ */
    @supports not (selector(:has(*))) {
        .batches-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
    }

    .batch-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .batch-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .batch-card.highlighted {
        border-color: #007cba;
        background: #e3f2fd;
        box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.2);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .batch-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }

    .batch-header h4 {
        margin: 0;
        color: #333;
        font-size: 14px;
    }

    .batch-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-submitted {
        background: #cce5ff;
        color: #004085;
    }

    .status-processing {
        background: #d4edda;
        color: #155724;
    }

    .status-queued {
        background: #e2e3e5;
        color: #383d41;
    }

    .status-completed {
        background: #d1ecf1;
        color: #0c5460;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
    }

    .status-partial_submitted {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    /* å­æ‰¹æ¬¡çŠ¶æ€æ ·å¼ */
    .sub-batches-summary {
        margin-top: 10px;
        padding: 10px;
        background: rgba(255,255,255,0.5);
        border-radius: 4px;
    }

    .sub-batch-status-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 5px;
    }

    .sub-batch-status {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        border-radius: 50%;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .sub-batch-status:hover {
        transform: scale(1.2);
    }

    .batch-details p {
        margin: 5px 0;
        font-size: 13px;
        color: #555;
    }

    .batch-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    /* æœ€è¿‘æ‰¹æ¬¡åˆ—è¡¨ */
    .recent-batches-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .recent-batch-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #dee2e6;
    }

    .batch-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .batch-id {
        font-family: monospace;
        font-weight: 600;
        color: #333;
    }

    .batch-count,
    .batch-method {
        font-size: 13px;
        color: #666;
    }

    .batch-time {
        font-size: 12px;
        color: #999;
    }

    .batch-result {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .batch-stats {
        font-size: 12px;
        color: #666;
    }

    .walmart-queue-manager h1 {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .description {
        color: #666;
        margin-bottom: 30px;
    }

    /* ä¸»å®¹å™¨å¸ƒå±€ */
    .queue-manager-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    /* çŠ¶æ€å¡ç‰‡ */
    .status-cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 25px;
    }

    .status-card {
        background: #fff;
        border: 1px solid #e1e1e1;
        border-radius: 8px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s ease;
    }

    .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .status-card .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .queue-status .card-icon {
        background: #e3f2fd;
        color: #1976d2;
    }

    .time-status .card-icon {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .processed-status .card-icon {
        background: #e8f5e8;
        color: #388e3c;
    }

    .upc-status .card-icon {
        background: #fff3e0;
        color: #f57c00;
    }

    .status-card .card-content h3 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
        line-height: 1;
    }

    .status-card .card-content p {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 14px;
    }

    /* é¢æ¿æ ·å¼ */
    .quick-actions-panel,
    .add-products-panel,
    .system-status-panel,
    .recent-logs-panel {
        background: #fff;
        border: 1px solid #e1e1e1;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .quick-actions-panel h3,
    .add-products-panel h3,
    .system-status-panel h3,
    .recent-logs-panel h3 {
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        color: #333;
    }

    /* æ“ä½œæŒ‰é’® */
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .action-form {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .batch-control {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
    }

    .control-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .batch-control label {
        font-weight: 500;
        color: #333;
    }

    .batch-control select {
        padding: 6px 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    /* è¾“å…¥ç»„ */
    .input-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .input-group input[type="text"] {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    /* ç³»ç»ŸçŠ¶æ€ç½‘æ ¼ */
    .status-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
    }

    .status-item label {
        font-weight: 500;
        color: #555;
    }

    .status-item .value {
        font-weight: 600;
    }

    .status-item .value.success {
        color: #28a745;
    }

    .status-item .value.pending {
        color: #ffc107;
    }

    .status-item .value.processing {
        color: #007cba;
    }

    .status-item .value.idle {
        color: #6c757d;
    }

    /* è­¦å‘Šæ¡† */
    .alert {
        padding: 15px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    /* æ—¥å¿—å®¹å™¨ */
    .logs-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e1e1e1;
        border-radius: 6px;
    }

    .log-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
    }

    .log-item:last-child {
        border-bottom: none;
    }

    .log-time {
        font-family: monospace;
        font-size: 12px;
        color: #666;
        min-width: 60px;
    }

    .log-content {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .product-id {
        font-weight: 500;
        color: #333;
    }

    .remaining {
        font-size: 12px;
        color: #666;
        background: #f0f0f0;
        padding: 2px 8px;
        border-radius: 12px;
    }

    .no-logs {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .no-logs .dashicons {
        font-size: 48px;
        opacity: 0.3;
        margin-bottom: 10px;
    }

    /* é˜Ÿåˆ—å•†å“éƒ¨åˆ† */
    .queue-products-section {
        grid-column: 1 / -1;
        background: #fff;
        border: 1px solid #e1e1e1;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .queue-products-section h2 {
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .count-badge {
        background: #007cba;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
    }

    .products-table-container {
        margin-bottom: 20px;
        border: 1px solid #e1e1e1;
        border-radius: 6px;
        overflow: hidden;
    }

    .products-table-container table {
        margin: 0;
        border: none;
    }

    .products-table-container th,
    .products-table-container td {
        padding: 12px 15px;
    }

    .column-id {
        width: 80px;
    }

    .column-sku {
        width: 120px;
    }

    .column-status {
        width: 100px;
    }

    .column-position {
        width: 100px;
    }

    .product-name strong {
        color: #333;
    }

    .product-name .error {
        color: #dc3545;
        font-style: italic;
    }

    .status-indicator {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-published {
        background: #d4edda;
        color: #155724;
    }

    .status-draft {
        background: #fff3cd;
        color: #856404;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
    }

    .position-badge {
        background: #f8f9fa;
        color: #495057;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .pagination-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 20px;
        color: #495057;
    }

    .bulk-actions {
        display: flex;
        gap: 10px;
    }

    /* ç©ºé˜Ÿåˆ—çŠ¶æ€ */
    .empty-queue {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        background: #fff;
        border: 1px solid #e1e1e1;
        border-radius: 8px;
        color: #666;
    }

    .empty-icon .dashicons {
        font-size: 64px;
        opacity: 0.3;
        margin-bottom: 20px;
    }

    .empty-queue h3 {
        margin: 0 0 10px 0;
        color: #333;
    }

    /* æ‰¹æ¬¡è¯¦æƒ…é¢æ¿æ ·å¼ */
    .batch-details-panel {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #e1e5e9;
		margin-left: 160px !important; 
        border-radius: 4px;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .detail-item {
        padding: 8px;
        background: white;
        border-radius: 3px;
        border-left: 3px solid #0073aa;
    }

    .detail-item.error-details {
        border-left-color: #dc3232;
        background: #fef7f7;
    }

    .batch-items-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 3px;
        background: white;
    }

    .batch-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
    }

    .batch-item:last-child {
        border-bottom: none;
    }

    .batch-item .item-id {
        font-weight: bold;
        color: #0073aa;
    }

    .batch-item .item-sku {
        color: #666;
        font-family: monospace;
    }

    .batch-item .item-upc {
        color: #666;
        font-family: monospace;
    }

    .batch-item .item-status {
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .batch-item .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .batch-item .status-submitted {
        background: #d4edda;
        color: #155724;
    }

    .batch-item .status-processing {
        background: #cce5ff;
        color: #004085;
    }

    .batch-item .status-completed {
        background: #d1ecf1;
        color: #0c5460;
    }

    .batch-item .status-error {
        background: #f8d7da;
        color: #721c24;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1200px) {
        .queue-manager-container {
            grid-template-columns: 1fr;
        }

        .status-cards {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .status-cards {
            grid-template-columns: 1fr;
        }

        .status-grid {
            grid-template-columns: 1fr;
        }

        .action-form {
            flex-direction: column;
            align-items: stretch;
        }

        .batch-control {
            flex-direction: column;
            align-items: stretch;
        }
    }

    /* æ‰¹æ¬¡è¯¦æƒ…å¼¹çª—æ ·å¼ */
    .batch-modal {
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .batch-modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .batch-modal-header {
        padding: 20px 25px;
        background: #f8f9fa;
        border-bottom: 1px solid #e1e1e1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .batch-modal-header h3 {
        margin: 0;
        color: #333;
    }

    .batch-modal-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }

    .batch-modal-close:hover {
        color: #333;
    }

    .batch-modal-body {
        padding: 25px;
        max-height: calc(80vh - 120px);
        overflow-y: auto;
    }

    .batch-detail-actions {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .batch-detail-content {
        background: #f8f9fa;
        border: 1px solid #e1e1e1;
        border-radius: 6px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
    }

    .batch-detail-content .loading {
        text-align: center;
        color: #666;
        padding: 20px;
    }

    .batch-detail-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .batch-detail-list li {
        padding: 8px 12px;
        margin-bottom: 5px;
        background: #fff;
        border: 1px solid #e1e1e1;
        border-radius: 4px;
        font-size: 13px;
    }

    .batch-detail-list li:last-child {
        margin-bottom: 0;
    }

    .batch-detail-list .success-item {
        border-left: 4px solid #28a745;
    }

    .batch-detail-list .failed-item {
        border-left: 4px solid #dc3545;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 15px;
    }

    .batch-detail-list .sku-text {
        font-family: monospace;
        font-weight: 600;
        color: #333;
        flex-shrink: 0;
    }

    .batch-detail-list .error-text {
        font-size: 12px;
        color: #dc3545;
        line-height: 1.4;
        text-align: right;
        flex: 1;
        word-break: break-word;
    }

    .copy-status {
        color: #28a745;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .copy-status.show {
        opacity: 1;
    }

    .batch-detail-link {
        color: #0073aa;
        text-decoration: none;
        font-weight: 500;
    }

    .batch-detail-link:hover {
        color: #005177;
        text-decoration: underline;
    }

    /* æ‰¹æ¬¡åˆ†é¡µæ ·å¼ */
    .batches-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e1e1e1;
    }

    .batches-header h3 {
        margin: 0;
    }

    .batches-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .batches-info {
        font-size: 13px;
        color: #666;
    }

    #batch-per-page {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
    }

    .no-batches {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        background: #f8f9fa;
        border-radius: 6px;
    }

    .batch-pagination {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e1e1e1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pagination-info {
        font-size: 13px;
        color: #666;
    }

    .pagination-controls {
        display: flex;
        gap: 5px;
    }

    .page-btn {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: #fff;
        color: #333;
        text-decoration: none;
        border-radius: 4px;
        font-size: 13px;
        transition: all 0.2s ease;
    }

    .page-btn:hover {
        background: #f8f9fa;
        border-color: #0073aa;
        color: #0073aa;
        text-decoration: none;
    }

    .page-btn.current {
        background: #0073aa;
        border-color: #0073aa;
        color: #fff;
    }

    .page-btn.current:hover {
        background: #005177;
        border-color: #005177;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .batches-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .batches-controls {
            width: 100%;
            justify-content: space-between;
        }

        .batch-pagination {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .pagination-controls {
            flex-wrap: wrap;
        }
    }
    </style>

    <script>
    // æ‰¹æ¬¡åˆ†é¡µå‡½æ•°
    function changeBatchPerPage(perPage) {
        const url = new URL(window.location);
        url.searchParams.set('batch_per_page', perPage);
        url.searchParams.set('batch_page', 1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        window.location.href = url.toString();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // å…¨é€‰åŠŸèƒ½
        const selectAll = document.getElementById('select-all');
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('input[name="remove_product_ids[]"]');
                checkboxes.forEach(function(checkbox) {
                    checkbox.checked = selectAll.checked;
                });
            });
        }

        // æ‰¹æ¬¡è¯¦æƒ…å¼¹çª—åŠŸèƒ½
        const modal = document.getElementById('batch-detail-modal');
        const modalTitle = document.getElementById('batch-detail-title');
        const modalContent = document.getElementById('batch-detail-content');
        const copyButton = document.getElementById('copy-all-skus');
        const copyStatus = document.getElementById('copy-status');
        const closeBtn = document.querySelector('.batch-modal-close');

        // ç‚¹å‡»æ‰¹æ¬¡è¯¦æƒ…é“¾æ¥
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('batch-detail-link')) {
                e.preventDefault();
                const batchId = e.target.getAttribute('data-batch-id');
                const type = e.target.getAttribute('data-type');

                // æ˜¾ç¤ºå¼¹çª—
                modal.style.display = 'block';
                let typeText = '';
                if (type === 'success') {
                    typeText = 'æˆåŠŸ';
                } else if (type === 'failed') {
                    typeText = 'å¤±è´¥';
                } else if (type === 'processing') {
                    typeText = 'å¤„ç†ä¸­';
                }
                modalTitle.textContent = `æ‰¹æ¬¡ #${batchId.substr(-8)} - ${typeText}å•†å“åˆ—è¡¨`;
                modalContent.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

                // åŠ è½½æ•°æ®
                loadBatchDetails(batchId, type);
            }
        });

        // å…³é—­å¼¹çª—
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // å¤åˆ¶å…¨éƒ¨SKU
        copyButton.addEventListener('click', function() {
            const skuElements = document.querySelectorAll('.batch-detail-list .sku-text');
            const skus = Array.from(skuElements).map(el => el.textContent.trim());

            if (skus.length > 0) {
                navigator.clipboard.writeText(skus.join('\n')).then(function() {
                    copyStatus.textContent = `å·²å¤åˆ¶ ${skus.length} ä¸ªSKU`;
                    copyStatus.classList.add('show');
                    setTimeout(() => {
                        copyStatus.classList.remove('show');
                    }, 3000);
                }).catch(function() {
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                    const textArea = document.createElement('textarea');
                    textArea.value = skus.join('\n');
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    copyStatus.textContent = `å·²å¤åˆ¶ ${skus.length} ä¸ªSKU`;
                    copyStatus.classList.add('show');
                    setTimeout(() => {
                        copyStatus.classList.remove('show');
                    }, 3000);
                });
            }
        });

        // åŠ è½½æ‰¹æ¬¡è¯¦æƒ…æ•°æ®
        function loadBatchDetails(batchId, type) {
            const data = new FormData();
            data.append('action', 'get_batch_details');
            data.append('batch_id', batchId);
            data.append('type', type);
            data.append('nonce', '<?php echo wp_create_nonce('batch_details_nonce'); ?>');

            fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    if (result.data.items && result.data.items.length > 0) {
                        let listHtml = '<ul class="batch-detail-list">';

                        result.data.items.forEach(item => {
                            if (result.data.type === 'failed' && item.error_message) {
                                // å¤±è´¥çš„å•†å“æ˜¾ç¤ºSKUå’Œé”™è¯¯ä¿¡æ¯
                                listHtml += `<li class="failed-item">
                                    <span class="sku-text">${item.sku}</span>
                                    <span class="error-text">${item.error_message}</span>
                                </li>`;
                            } else {
                                // æˆåŠŸçš„å•†å“åªæ˜¾ç¤ºSKU
                                listHtml += `<li class="success-item">
                                    <span class="sku-text">${item.sku}</span>
                                </li>`;
                            }
                        });

                        listHtml += '</ul>';
                        modalContent.innerHTML = listHtml;
                    } else {
                        modalContent.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³SKU</div>';
                    }
                } else {
                    modalContent.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥: ' + (result.data || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            })
            .catch(error => {
                modalContent.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            });
        }

        // æ‰¹æ¬¡è¯¦æƒ…åˆ‡æ¢åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-batch-details')) {
                const batchId = e.target.getAttribute('data-batch-id');
                const detailsPanel = document.getElementById('details-' + batchId);

                if (detailsPanel) {
                    if (detailsPanel.style.display === 'none') {
                        detailsPanel.style.display = 'block';
                        e.target.textContent = 'éšè—è¯¦æƒ…';
                    } else {
                        detailsPanel.style.display = 'none';
                        e.target.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
                    }
                }
            }
        });

        // ç«‹å³å¤„ç†æ‰¹æ¬¡åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('process-batch-now')) {
                const batchId = e.target.getAttribute('data-batch-id');
                const button = e.target;

                if (confirm('ç¡®å®šè¦ç«‹å³å¤„ç†æ­¤æ‰¹æ¬¡å—ï¼Ÿ')) {
                    button.disabled = true;
                    button.textContent = 'å¤„ç†ä¸­...';

                    // å‘é€AJAXè¯·æ±‚
                    fetch(ajaxurl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            action: 'process_batch_now',
                            batch_id: batchId,
                            nonce: '<?php echo wp_create_nonce("walmart_batch_action"); ?>'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('æ‰¹æ¬¡å¤„ç†å·²å¯åŠ¨ï¼š' + data.data.message);
                            location.reload();
                        } else {
                            alert('å¤„ç†å¤±è´¥ï¼š' + (data.data ? data.data.message : 'æœªçŸ¥é”™è¯¯'));
                            button.disabled = false;
                            button.textContent = 'ç«‹å³å¤„ç†';
                        }
                    })
                    .catch(error => {
                        console.error('AJAXé”™è¯¯:', error);
                        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
                        button.disabled = false;
                        button.textContent = 'ç«‹å³å¤„ç†';
                    });
                }
            }
        });

        // æ ‡è®°ä¸ºå®ŒæˆåŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('mark-completed') || e.target.closest('.mark-completed')) {
                const button = e.target.classList.contains('mark-completed') ? e.target : e.target.closest('.mark-completed');
                const batchId = button.getAttribute('data-batch-id');

                console.log('æ ‡è®°å®Œæˆè¯·æ±‚:', batchId);

                if (confirm('ç¡®å®šè¦å°†æ­¤æ‰¹æ¬¡æ ‡è®°ä¸ºå¤„ç†å®Œæˆå—ï¼Ÿ\n\næ‰¹æ¬¡ID: ' + batchId + '\n\næ­¤æ“ä½œå°†ï¼š\n- å°†æ‰¹æ¬¡çŠ¶æ€è®¾ç½®ä¸ºå·²å®Œæˆ\n- åœæ­¢åç»­çš„çŠ¶æ€æ£€æŸ¥\n- ä¿ç•™æ‰€æœ‰æ•°æ®è®°å½•')) {
                    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                    button.disabled = true;
                    const originalText = button.innerHTML;
                    button.innerHTML = '<span class="dashicons dashicons-update" style="font-size: 12px; margin-right: 2px; animation: spin 1s linear infinite;"></span>å¤„ç†ä¸­...';

                    // å‘é€AJAXè¯·æ±‚
                    fetch(ajaxurl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            action: 'mark_batch_completed',
                            batch_id: batchId,
                            nonce: '<?php echo wp_create_nonce('walmart_batch_action'); ?>'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('æ ‡è®°å®Œæˆå“åº”æ•°æ®:', data);

                        if (data.success) {
                            alert('æ‰¹æ¬¡å·²æ ‡è®°ä¸ºå®Œæˆï¼\n\n' + data.data.message);

                            // åˆ·æ–°é¡µé¢æˆ–æ›´æ–°æ‰¹æ¬¡çŠ¶æ€æ˜¾ç¤º
                            location.reload();
                        } else {
                            alert('æ ‡è®°å¤±è´¥ï¼š' + (data.data.message || 'æœªçŸ¥é”™è¯¯'));
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            button.disabled = false;
                            button.innerHTML = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('æ ‡è®°å®Œæˆè¯·æ±‚å¤±è´¥:', error);
                        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        button.disabled = false;
                        button.innerHTML = originalText;
                    });
                }
                return;
            }
        });

        // åˆ é™¤æ‰¹æ¬¡åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-batch')) {
                const batchId = e.target.getAttribute('data-batch-id');
                const button = e.target;

                console.log('åˆ é™¤æ‰¹æ¬¡è¯·æ±‚:', batchId);

                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ‰¹æ¬¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚\n\næ‰¹æ¬¡ID: ' + batchId)) {
                    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                    button.disabled = true;
                    button.textContent = 'åˆ é™¤ä¸­...';

                    // å‘é€AJAXè¯·æ±‚
                    fetch(ajaxurl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            action: 'delete_batch',
                            batch_id: batchId,
                            nonce: '<?php echo wp_create_nonce("walmart_batch_action"); ?>'
                        })
                    })
                    .then(response => {
                        console.log('åˆ é™¤å“åº”çŠ¶æ€:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('åˆ é™¤å“åº”æ•°æ®:', data);

                        if (data.success) {
                            const details = data.data.deleted_details || {};
                            const message = `æ‰¹æ¬¡å·²åˆ é™¤ï¼\n\nåˆ é™¤è¯¦æƒ…ï¼š\n- ä¸»æ‰¹æ¬¡ï¼š${details.main_batch || 1} ä¸ª\n- å­æ‰¹æ¬¡ï¼š${details.sub_batches || 0} ä¸ª\n- å•†å“è®°å½•ï¼š${details.batch_items || 0} ä¸ª`;
                            alert(message);

                            // ç«‹å³éšè—è¢«åˆ é™¤çš„æ‰¹æ¬¡å¡ç‰‡
                            const batchCard = button.closest('.batch-card');
                            if (batchCard) {
                                batchCard.style.opacity = '0.5';
                                batchCard.style.pointerEvents = 'none';
                                setTimeout(() => {
                                    batchCard.remove();
                                }, 500);
                            }

                            // å»¶è¿Ÿåˆ·æ–°é¡µé¢ç¡®ä¿åˆ é™¤å®Œæˆ
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            alert('åˆ é™¤å¤±è´¥ï¼š' + (data.data ? data.data.message : 'æœªçŸ¥é”™è¯¯'));
                            button.disabled = false;
                            button.textContent = 'åˆ é™¤';
                        }
                    })
                    .catch(error => {
                        console.error('AJAXé”™è¯¯:', error);
                        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•\n\né”™è¯¯è¯¦æƒ…ï¼š' + error.message);
                        button.disabled = false;
                        button.textContent = 'åˆ é™¤';
                    });
                }
            }
        });

        // åˆ·æ–°å•ä¸ªæ‰¹æ¬¡çŠ¶æ€åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('refresh-batch-status')) {
                const batchId = e.target.getAttribute('data-batch-id');
                const button = e.target;
                const originalText = button.innerHTML;

                console.log('åˆ·æ–°æ‰¹æ¬¡çŠ¶æ€è¯·æ±‚:', batchId);

                // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                button.disabled = true;
                button.innerHTML = '<span class="dashicons dashicons-update spin" style="font-size: 12px; margin-right: 2px;"></span>åˆ·æ–°ä¸­...';

                // å‘é€AJAXè¯·æ±‚
                fetch(ajaxurl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'refresh_single_batch_status',
                        batch_id: batchId,
                        nonce: '<?php echo wp_create_nonce("walmart_batch_action"); ?>'
                    })
                })
                .then(response => {
                    console.log('åˆ·æ–°å“åº”çŠ¶æ€:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('åˆ·æ–°å“åº”æ•°æ®:', data);

                    if (data.success) {
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        const message = `æ‰¹æ¬¡çŠ¶æ€å·²åˆ·æ–°ï¼\n\nå½“å‰çŠ¶æ€ï¼š${data.data.batch_status || 'æœªçŸ¥'}\næ›´æ–°æ—¶é—´ï¼š${data.data.updated_at || ''}`;

                        // åˆ›å»ºä¸´æ—¶æç¤º
                        const notification = document.createElement('div');
                        notification.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #00a32a;
                            color: white;
                            padding: 12px 20px;
                            border-radius: 4px;
                            z-index: 9999;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                            font-size: 14px;
                        `;
                        notification.textContent = 'æ‰¹æ¬¡çŠ¶æ€å·²åˆ·æ–°ï¼';
                        document.body.appendChild(notification);

                        // 3ç§’åç§»é™¤æç¤º
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 3000);

                        // å»¶è¿Ÿåˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        alert('åˆ·æ–°å¤±è´¥ï¼š' + (data.data ? data.data.message : 'æœªçŸ¥é”™è¯¯'));
                    }

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = originalText;
                })
                .catch(error => {
                    console.error('AJAXé”™è¯¯:', error);
                    alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•\n\né”™è¯¯è¯¦æƒ…ï¼š' + error.message);

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = originalText;
                });
            }
        });

        // è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼ˆæ¯30ç§’ï¼‰
        setTimeout(function() {
            location.reload();
        }, 30000);

        // æ·»åŠ åŠ è½½çŠ¶æ€
        const forms = document.querySelectorAll('.action-form, .add-form, .queue-products-form');
        forms.forEach(function(form) {
            form.addEventListener('submit', function() {
                const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="dashicons dashicons-update spin"></span> å¤„ç†ä¸­...';
                }
            });
        });
    });

    // æ·»åŠ æ—‹è½¬åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin {
            animation: spin 1s linear infinite;
        }
    `;
    document.head.appendChild(style);
    </script>
    <?php
}

// è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
function debug_queue_status() {
    $queue = get_option('walmart_sync_queue', []);
    $queue_count = count($queue);

    error_log("=== é˜Ÿåˆ—è°ƒè¯•ä¿¡æ¯ ===");
    error_log("é˜Ÿåˆ—å•†å“æ•°é‡: " . $queue_count);
    error_log("é˜Ÿåˆ—å†…å®¹: " . print_r($queue, true));

    // æ£€æŸ¥UPCå ç”¨æƒ…å†µ
    global $wpdb;
    $upc_table = $wpdb->prefix . 'walmart_upc_pool';
    $used_upcs = $wpdb->get_var("SELECT COUNT(*) FROM $upc_table WHERE is_used = 1");
    $total_upcs = $wpdb->get_var("SELECT COUNT(*) FROM $upc_table");

    error_log("UPCä½¿ç”¨æƒ…å†µ: {$used_upcs}/{$total_upcs}");

    // æ£€æŸ¥FeedçŠ¶æ€
    $feeds_table = $wpdb->prefix . 'walmart_feeds';
    $total_feeds = $wpdb->get_var("SELECT COUNT(*) FROM $feeds_table");
    $pending_feeds = $wpdb->get_var("SELECT COUNT(*) FROM $feeds_table WHERE status = 'SUBMITTED'");

    error_log("FeedçŠ¶æ€: æ€»è®¡{$total_feeds}ä¸ªï¼Œå¾…å¤„ç†{$pending_feeds}ä¸ª");
    error_log("=== é˜Ÿåˆ—è°ƒè¯•ä¿¡æ¯ç»“æŸ ===");

    return [
        'queue_count' => $queue_count,
        'queue_items' => $queue,
        'used_upcs' => $used_upcs,
        'total_upcs' => $total_upcs,
        'total_feeds' => $total_feeds,
        'pending_feeds' => $pending_feeds
    ];
}

// æ™ºèƒ½åŒæ­¥ç­–ç•¥å‡½æ•°
function determine_sync_method($product_count) {
    if ($product_count == 1) {
        return [
            'method' => 'individual',
            'description' => 'å•ä¸ªå•†å“ç«‹å³åŒæ­¥'
        ];
    } elseif ($product_count <= 100) {
        return [
            'method' => 'medium_batch_feed',
            'description' => 'æ‰¹é‡Feedå¤„ç†ï¼ˆä¸€æ¬¡æ€§æäº¤ï¼‰'
        ];
    } else {
        return [
            'method' => 'large_batch_feed',
            'description' => 'å¤§æ‰¹é‡åˆ†å‰²Feedå¤„ç†ï¼ˆæ¯æ‰¹100ä¸ªï¼‰'
        ];
    }
}

// æ‰¹é‡Feedæ„å»ºå™¨ç±»
class Walmart_Batch_Feed_Builder {

    public function create_batch($product_ids, $sync_method) {
        $batch_id = $this->generate_batch_id();

        // åˆ›å»ºæ‰¹æ¬¡è®°å½•
        $this->create_batch_record($batch_id, $product_ids, $sync_method);

        // æ ¹æ®åŒæ­¥æ–¹æ³•å¤„ç†
        switch ($sync_method) {
            case 'batch_feed':
            case 'medium_batch_feed':
            case 'large_batch_feed':
                return $this->process_batch_feed($batch_id, $product_ids);
            case 'small_batch':
                return $this->process_queue_batch($batch_id, $product_ids);
            default:
                return $this->process_individual($product_ids[0]);
        }
    }

    private function generate_batch_id() {
        return 'BATCH_' . date('YmdHis') . '_' . wp_rand(1000, 9999);
    }

    private function create_batch_record($batch_id, $product_ids, $sync_method) {
        global $wpdb;
        $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';
        $batch_items_table = $wpdb->prefix . 'walmart_batch_items';

        $product_count = count($product_ids);
        $batch_type = 'single';
        $total_chunks = 1;

        // åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†æ‰¹æ¬¡
        if ($sync_method === 'large_batch_feed' && $product_count > 200) {
            $batch_type = 'master';
            $total_chunks = ceil($product_count / 200);
        }

        // åˆ›å»ºä¸»æ‰¹æ¬¡è®°å½•
        $wpdb->insert(
            $batch_feeds_table,
            [
                'batch_id' => $batch_id,
                'product_ids' => wp_json_encode($product_ids),
                'product_count' => $product_count,
                'sync_method' => $sync_method,
                'batch_type' => $batch_type,
                'total_chunks' => $total_chunks,
                'status' => 'PENDING',
                'progress_total' => $product_count
            ]
        );

        // åˆ›å»ºæ‰¹æ¬¡å•†å“è¯¦æƒ…è®°å½•
        foreach ($product_ids as $product_id) {
            $product = wc_get_product($product_id);
            $sku = $product ? $product->get_sku() : '';

            $wpdb->insert(
                $batch_items_table,
                [
                    'batch_id' => $batch_id,
                    'product_id' => $product_id,
                    'sku' => $sku,
                    'status' => 'PENDING'
                ]
            );
        }

        woo_walmart_sync_log('æ‰¹æ¬¡åˆ›å»º', 'æˆåŠŸ', [
            'batch_id' => $batch_id,
            'product_count' => $product_count,
            'sync_method' => $sync_method,
            'batch_type' => $batch_type,
            'total_chunks' => $total_chunks
        ], 'æ‰¹æ¬¡åˆ›å»ºæˆåŠŸ');
    }

    private function process_batch_feed($batch_id, $product_ids) {
        $product_count = count($product_ids);

        if ($product_count <= 200) {
            // å°äº200ä¸ªå•†å“ï¼Œç›´æ¥æäº¤å•ä¸ªFeed
            $result = $this->submit_feed_chunk($batch_id, $product_ids, 0);

            if ($result['success']) {
                $this->update_batch_status($batch_id, 'SUBMITTED', 'æ‰¹é‡Feedå·²æäº¤');
                return [
                    'success' => true,
                    'batch_id' => $batch_id,
                    'feed_id' => $result['feed_id'] ?? null,
                    'message' => 'æ‰¹é‡Feedå·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­'
                ];
            } else {
                $this->update_batch_status($batch_id, 'ERROR', $result['message']);
                return $result;
            }
        } else {
            // å¤§äº200ä¸ªå•†å“ï¼Œåˆ†å‰²ä¸ºå­æ‰¹æ¬¡
            $chunks = array_chunk($product_ids, 200);
            $total_chunks = count($chunks);
            $successful_chunks = 0;
            $feed_ids = []; // æ”¶é›†æ‰€æœ‰å­æ‰¹æ¬¡çš„Feed ID

            foreach ($chunks as $chunk_index => $chunk) {
                $sub_batch_id = $batch_id . '_CHUNK_' . ($chunk_index + 1);

                // åˆ›å»ºå­æ‰¹æ¬¡è®°å½•
                $this->create_sub_batch_record($sub_batch_id, $batch_id, $chunk, $chunk_index + 1, $total_chunks);

                // æäº¤å­æ‰¹æ¬¡Feed
                $result = $this->submit_feed_chunk($sub_batch_id, $chunk, $chunk_index);

                if ($result['success']) {
                    $successful_chunks++;
                    $this->update_batch_status($sub_batch_id, 'SUBMITTED', 'å­æ‰¹æ¬¡Feedå·²æäº¤');

                    // æ”¶é›†Feed ID
                    if (!empty($result['feed_id'])) {
                        $feed_ids[] = $result['feed_id'];
                    }
                } else {
                    $this->update_batch_status($sub_batch_id, 'ERROR', $result['message']);
                    woo_walmart_sync_log('å­æ‰¹æ¬¡æäº¤å¤±è´¥', 'å¤±è´¥', [
                        'sub_batch_id' => $sub_batch_id,
                        'parent_batch_id' => $batch_id,
                        'chunk_index' => $chunk_index + 1,
                        'error' => $result['message']
                    ], $result['message']);
                }
            }

            // æ›´æ–°ä¸»æ‰¹æ¬¡çŠ¶æ€
            if ($successful_chunks === $total_chunks) {
                $this->update_batch_status($batch_id, 'SUBMITTED', "æ‰€æœ‰ {$total_chunks} ä¸ªå­æ‰¹æ¬¡å·²æäº¤");
                $message = "æ‰¹é‡Feedå·²åˆ†æˆ {$total_chunks} ä¸ªå­æ‰¹æ¬¡æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­";
            } elseif ($successful_chunks > 0) {
                $this->update_batch_status($batch_id, 'PARTIAL_SUBMITTED', "{$successful_chunks}/{$total_chunks} ä¸ªå­æ‰¹æ¬¡æäº¤æˆåŠŸ");
                $message = "éƒ¨åˆ†å­æ‰¹æ¬¡æäº¤æˆåŠŸï¼ˆ{$successful_chunks}/{$total_chunks}ï¼‰ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…";
            } else {
                $this->update_batch_status($batch_id, 'ERROR', 'æ‰€æœ‰å­æ‰¹æ¬¡æäº¤å¤±è´¥');
                return [
                    'success' => false,
                    'batch_id' => $batch_id,
                    'feed_id' => null,
                    'message' => 'æ‰€æœ‰å­æ‰¹æ¬¡æäº¤å¤±è´¥'
                ];
            }

            return [
                'success' => true,
                'batch_id' => $batch_id,
                'feed_id' => !empty($feed_ids) ? implode(',', $feed_ids) : null, // å¤šä¸ªFeed IDç”¨é€—å·åˆ†éš”
                'message' => $message,
                'sub_batches' => $total_chunks,
                'successful_sub_batches' => $successful_chunks,
                'feed_ids' => $feed_ids // æä¾›å®Œæ•´çš„Feed IDæ•°ç»„
            ];
        }
    }

    private function create_sub_batch_record($sub_batch_id, $parent_batch_id, $product_ids, $chunk_index, $total_chunks) {
        global $wpdb;
        $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';
        $batch_items_table = $wpdb->prefix . 'walmart_batch_items';

        // åˆ›å»ºå­æ‰¹æ¬¡è®°å½•
        $wpdb->insert(
            $batch_feeds_table,
            [
                'batch_id' => $sub_batch_id,
                'parent_batch_id' => $parent_batch_id,
                'product_ids' => wp_json_encode($product_ids),
                'product_count' => count($product_ids),
                'sync_method' => 'large_batch_feed',
                'batch_type' => 'chunk',
                'chunk_index' => $chunk_index,
                'total_chunks' => $total_chunks,
                'status' => 'PENDING',
                'progress_total' => count($product_ids)
            ]
        );

        // åˆ›å»ºå­æ‰¹æ¬¡å•†å“è¯¦æƒ…è®°å½•
        foreach ($product_ids as $product_id) {
            $product = wc_get_product($product_id);
            $sku = $product ? $product->get_sku() : '';

            $wpdb->insert(
                $batch_items_table,
                [
                    'batch_id' => $sub_batch_id,
                    'product_id' => $product_id,
                    'sku' => $sku,
                    'status' => 'PENDING'
                ]
            );
        }
    }

    private function process_queue_batch($batch_id, $product_ids) {
        // å°æ‰¹é‡ä½¿ç”¨ç°æœ‰é˜Ÿåˆ—æœºåˆ¶
        $queue = get_option('walmart_sync_queue', []);
        $new_queue = array_unique(array_merge($queue, $product_ids));
        update_option('walmart_sync_queue', $new_queue);

        $this->update_batch_status($batch_id, 'QUEUED', 'å·²åŠ å…¥å¤„ç†é˜Ÿåˆ—');

        return [
            'success' => true,
            'batch_id' => $batch_id,
            'message' => 'å·²åŠ å…¥å¤„ç†é˜Ÿåˆ—ï¼Œå°†æŒ‰é¡ºåºå¤„ç†'
        ];
    }

    private function process_individual($product_id) {
        // å•ä¸ªå•†å“ç«‹å³å¤„ç†
        $sync = new Woo_Walmart_Product_Sync();
        $result = $sync->initiate_sync($product_id);

        return [
            'success' => $result['success'],
            'batch_id' => null,
            'message' => $result['message']
        ];
    }

    private function submit_feed_chunk($batch_id, $product_ids, $chunk_index) {
        try {
            // æ„å»ºæ‰¹é‡Feedæ•°æ®
            $feed_data = $this->build_batch_feed_data($product_ids);

            if (empty($feed_data['MPItem'])) {
                return [
                    'success' => false,
                    'message' => 'æ²¡æœ‰æœ‰æ•ˆçš„å•†å“æ•°æ®å¯ä»¥åŒæ­¥'
                ];
            }

            // ğŸ”§ æ ¹æ®å½“å‰ä¸»å¸‚åœºåŠ¨æ€è·å– feedType
            $business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');
            $market_code = str_replace('WALMART_', '', $business_unit);

            require_once plugin_dir_path(__FILE__) . 'includes/class-multi-market-config.php';
            $market_config = Woo_Walmart_Multi_Market_Config::get_market_config($market_code);
            $feed_type = isset($market_config['feed_types']['item']) ? $market_config['feed_types']['item'] : 'MP_ITEM';

            // ğŸ” æ·»åŠ è°ƒè¯•æ—¥å¿—
            woo_walmart_sync_log('æ‰¹é‡Feedæäº¤-å‡†å¤‡', 'è°ƒè¯•', [
                'batch_id' => $batch_id,
                'chunk_index' => $chunk_index,
                'business_unit' => $business_unit,
                'market_code' => $market_code,
                'feed_type' => $feed_type,
                'product_count' => count($product_ids),
                'endpoint' => '/v3/feeds?feedType=' . $feed_type
            ], 'æ‰¹é‡Feedæäº¤å‰çš„é…ç½®æ£€æŸ¥');

            // æäº¤åˆ°æ²ƒå°”ç›API
            $api_auth = new Woo_Walmart_API_Key_Auth();
            $response = $api_auth->make_file_upload_request('/v3/feeds?feedType=' . $feed_type, $feed_data, 'batch_feed.json');

            // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€
            if (is_array($response) && !empty($response['feedId'])) {
                $this->update_batch_feed_id($batch_id, $response['feedId'], $chunk_index);

                // ä¸ºæ¯ä¸ªå•†å“åˆ›å»ºå•ç‹¬çš„Feedè®°å½•
                $this->create_individual_feed_records($product_ids, $response['feedId']);

                woo_walmart_sync_log('æ‰¹é‡Feedæäº¤', 'æˆåŠŸ', [
                    'batch_id' => $batch_id,
                    'chunk_index' => $chunk_index,
                    'feed_id' => $response['feedId'],
                    'product_count' => count($product_ids)
                ], $response, null);

                return [
                    'success' => true,
                    'feed_id' => $response['feedId']
                ];
            } else {
                woo_walmart_sync_log('æ‰¹é‡Feedæäº¤', 'å¤±è´¥', [
                    'batch_id' => $batch_id,
                    'chunk_index' => $chunk_index,
                    'product_count' => count($product_ids)
                ], $response, null);

                return [
                    'success' => false,
                    'message' => 'Feedæäº¤å¤±è´¥ï¼š' . (is_string($response) ? $response : 'æœªçŸ¥é”™è¯¯')
                ];
            }

        } catch (Exception $e) {
            woo_walmart_sync_log('æ‰¹é‡Feedæäº¤', 'å¼‚å¸¸', [
                'batch_id' => $batch_id,
                'chunk_index' => $chunk_index,
                'error' => $e->getMessage()
            ], '', null);

            return [
                'success' => false,
                'message' => 'æäº¤å¼‚å¸¸ï¼š' . $e->getMessage()
            ];
        }
    }

    private function build_batch_feed_data($product_ids) {
        $mapper = new Woo_Walmart_Product_Mapper();
        $items = [];

        // ğŸ†• è·å–å¸‚åœºä»£ç 
        $business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');
        $market_code = str_replace('WALMART_', '', $business_unit);

        foreach ($product_ids as $product_id) {
            $product = wc_get_product($product_id);
            if (!$product) continue;

            // éªŒè¯å•†å“
            if (!$this->validate_product($product)) continue;

            // åˆ†é…UPC
            $upc = $this->assign_upc_for_product($product_id);
            if (!$upc) continue;

            // è·å–åˆ†ç±»æ˜ å°„
            $category_mapping = $this->get_category_mapping($product);
            if (!$category_mapping) continue;

            // æ„å»ºå•ä¸ªå•†å“æ•°æ® - ä¼ é€’å¸‚åœºä»£ç 
            $item_data = $mapper->map(
                $product,
                $category_mapping['walmart_category'],
                $upc,
                $category_mapping['attributes'],
                get_option('woo_walmart_fulfillment_lag_time', 2),
                $market_code
            );

            if ($item_data && !empty($item_data['MPItem'])) {
                $items[] = $item_data['MPItem'][0]; // æå–å•ä¸ªå•†å“æ•°æ®
            }
        }

        // ğŸ”§ æ ¹æ®å¸‚åœºåŠ¨æ€é€‰æ‹©Feedæ ¼å¼
        if ($market_code === 'CA') {
            // ğŸ”§ CA: ä¿®å¤æ—¥æœŸæ ¼å¼ (éœ€è¦ YYYY-MM-DDï¼Œä¸æ˜¯ ISO 8601)
            foreach ($items as &$item) {
                if (isset($item['Orderable']['startDate'])) {
                    $item['Orderable']['startDate'] = date('Y-m-d', strtotime($item['Orderable']['startDate']));
                }
                if (isset($item['Orderable']['endDate'])) {
                    $item['Orderable']['endDate'] = date('Y-m-d', strtotime($item['Orderable']['endDate']));
                }
            }
            unset($item);

            // ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§å¸‚åœºï¼šä½¿ç”¨ CA_MP_ITEM_INTL_SPEC.json è§„èŒƒ (ç‰ˆæœ¬ 3.16)
            return [
                'MPItemFeedHeader' => [
                    'version' => '3.16',
                    'mart' => 'WALMART_CA',
                    'sellingChannel' => 'marketplace',
                    'processMode' => 'REPLACE',
                    'subset' => 'EXTERNAL',
                    'locale' => ['en', 'fr'],  // ğŸ”§ CAéœ€è¦localeå­—æ®µ
                    'subCategory' => 'furniture_other'  // ğŸ”§ CAéœ€è¦subCategoryï¼Œé»˜è®¤ä½¿ç”¨furniture_other
                ],
                'MPItem' => $items
            ];
        } else {
            // ğŸ‡ºğŸ‡¸ ç¾å›½å¸‚åœºï¼šä¿æŒ V5.0 æ ¼å¼
            return [
                'MPItemFeedHeader' => [
                    'businessUnit' => $business_unit,  // V5.0 æ–°å¢å¿…éœ€å­—æ®µ
                    'locale' => 'en',
                    'version' => '5.0.20241118-04_39_24-api'  // V5.0 å®Œæ•´ç‰ˆæœ¬å·
                    // V5.0 ç§»é™¤äº†: sellingChannel, processMode, subset, subCategory
                ],
                'MPItem' => $items
            ];
        }
    }

    private function validate_product($product) {
        // åŸºæœ¬éªŒè¯é€»è¾‘
        if (!$product->get_sku()) return false;
        if ($product->get_price() <= 0) return false;
        if (!$product->get_name()) return false;
        if ($product->get_status() !== 'publish') return false;

        return true;
    }

    private function assign_upc_for_product($product_id) {
        global $wpdb;
        $upc_table = $wpdb->prefix . 'walmart_upc_pool';

        // æ£€æŸ¥æ˜¯å¦å·²æœ‰UPC
        $existing_upc = $wpdb->get_var($wpdb->prepare(
            "SELECT upc_code FROM $upc_table WHERE product_id = %d AND is_used = 1",
            $product_id
        ));

        if ($existing_upc) {
            return $existing_upc;
        }

        // åˆ†é…æ–°UPC
        $available_upc = $wpdb->get_row(
            "SELECT id, upc_code FROM $upc_table WHERE is_used = 0 LIMIT 1"
        );

        if ($available_upc) {
            $wpdb->update(
                $upc_table,
                [
                    'is_used' => 1,
                    'product_id' => $product_id,
                    'used_at' => current_time('mysql')
                ],
                ['id' => $available_upc->id]
            );

            // å°†UPCä¿å­˜åˆ°äº§å“metaä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
            update_post_meta($product_id, '_walmart_upc', $available_upc->upc_code);

            // è®°å½•UPCåˆ†é…æ—¥å¿—
            woo_walmart_sync_log('UPCåˆ†é…', 'æˆåŠŸ', [
                'product_id' => $product_id,
                'upc_code' => $available_upc->upc_code,
                'upc_pool_id' => $available_upc->id
            ], 'æˆåŠŸä¸ºäº§å“åˆ†é…UPC: ' . $available_upc->upc_code, $product_id);

            return $available_upc->upc_code;
        }

        return false;
    }

    private function get_category_mapping($product) {
        global $wpdb;
        $map_table = $wpdb->prefix . 'walmart_category_map';

        // è·å–äº§å“åˆ†ç±»
        $product_categories = wp_get_post_terms($product->get_id(), 'product_cat');

        foreach ($product_categories as $category) {
            $cat_id = $category->term_id;

            // é¦–å…ˆå°è¯•ç›´æ¥æŸ¥è¯¢ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
            $mapping = $wpdb->get_row($wpdb->prepare(
                "SELECT walmart_category_path, walmart_attributes FROM $map_table WHERE wc_category_id = %d",
                $cat_id
            ));

            if ($mapping) {
                return [
                    'walmart_category' => $mapping->walmart_category_path,
                    'attributes' => json_decode($mapping->walmart_attributes, true) ?: []
                ];
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼ŒæŸ¥è¯¢å…±äº«æ˜ å°„ï¼ˆæ–°æ ¼å¼ï¼‰
            // å°è¯•æ•°å­—æ ¼å¼æŸ¥è¯¢
            $shared_mapping = $wpdb->get_row($wpdb->prepare(
                "SELECT walmart_category_path, walmart_attributes
                 FROM $map_table
                 WHERE local_category_ids IS NOT NULL
                 AND JSON_CONTAINS(local_category_ids, %s)",
                json_encode($cat_id)
            ));

            if ($shared_mapping) {
                return [
                    'walmart_category' => $shared_mapping->walmart_category_path,
                    'attributes' => json_decode($shared_mapping->walmart_attributes, true) ?: []
                ];
            }

            // å¦‚æœæ•°å­—æ ¼å¼å¤±è´¥ï¼Œå°è¯•å­—ç¬¦ä¸²æ ¼å¼
            $shared_mapping = $wpdb->get_row($wpdb->prepare(
                "SELECT walmart_category_path, walmart_attributes
                 FROM $map_table
                 WHERE local_category_ids IS NOT NULL
                 AND JSON_CONTAINS(local_category_ids, %s)",
                json_encode(strval($cat_id))
            ));

            if ($shared_mapping) {
                return [
                    'walmart_category' => $shared_mapping->walmart_category_path,
                    'attributes' => json_decode($shared_mapping->walmart_attributes, true) ?: []
                ];
            }
        }

        // æ²¡æœ‰æ‰¾åˆ°æ˜ å°„ï¼Œè¿”å›nullè€Œä¸æ˜¯ç¡¬ç¼–ç çš„åˆ†ç±»
        return null;
    }

    private function update_batch_status($batch_id, $status, $message = '') {
        global $wpdb;
        $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';

        $update_data = [
            'status' => $status,
            'updated_at' => current_time('mysql')
        ];

        if ($status === 'SUBMITTED') {
            $update_data['submitted_at'] = current_time('mysql');
        } elseif ($status === 'COMPLETED' || $status === 'ERROR') {
            $update_data['completed_at'] = current_time('mysql');
        }

        // åªæœ‰é”™è¯¯çŠ¶æ€æ‰è®°å½•åˆ°error_detailså­—æ®µ
        if ($message) {
            if ($status === 'ERROR') {
                $update_data['error_details'] = $message;
            } else {
                // æˆåŠŸçŠ¶æ€çš„æ¶ˆæ¯è®°å½•åˆ°status_messageå­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                // æˆ–è€…ä¸è®°å½•ï¼Œé¿å…æ˜¾ç¤ºåœ¨é”™è¯¯è¯¦æƒ…ä¸­
                // $update_data['status_message'] = $message;
            }
        }

        $wpdb->update(
            $batch_feeds_table,
            $update_data,
            ['batch_id' => $batch_id]
        );
    }

    private function update_batch_feed_id($batch_id, $feed_id, $chunk_index) {
        global $wpdb;
        $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';

        $wpdb->update(
            $batch_feeds_table,
            [
                'feed_id' => $feed_id,
                'status' => 'SUBMITTED',
                'submitted_at' => current_time('mysql')
            ],
            ['batch_id' => $batch_id]
        );

        // å¦‚æœæ˜¯å­æ‰¹æ¬¡ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ä¸»æ‰¹æ¬¡çŠ¶æ€
        $this->update_master_batch_status($batch_id);
    }

    private function update_master_batch_status($batch_id) {
        global $wpdb;
        $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';

        // æ£€æŸ¥æ˜¯å¦æ˜¯å­æ‰¹æ¬¡
        $batch_info = $wpdb->get_row($wpdb->prepare(
            "SELECT parent_batch_id, batch_type FROM $batch_feeds_table WHERE batch_id = %s",
            $batch_id
        ));

        if (!$batch_info || $batch_info->batch_type !== 'chunk' || !$batch_info->parent_batch_id) {
            return; // ä¸æ˜¯å­æ‰¹æ¬¡ï¼Œæ— éœ€æ›´æ–°ä¸»æ‰¹æ¬¡
        }

        $parent_batch_id = $batch_info->parent_batch_id;

        // è·å–æ‰€æœ‰å­æ‰¹æ¬¡çš„çŠ¶æ€
        $sub_batches = $wpdb->get_results($wpdb->prepare(
            "SELECT status, success_count, failed_count FROM $batch_feeds_table
             WHERE parent_batch_id = %s",
            $parent_batch_id
        ));

        if (empty($sub_batches)) return;

        // ç»Ÿè®¡å­æ‰¹æ¬¡çŠ¶æ€
        $total_sub_batches = count($sub_batches);
        $completed_sub_batches = 0;
        $error_sub_batches = 0;
        $total_success = 0;
        $total_failed = 0;

        foreach ($sub_batches as $sub_batch) {
            if ($sub_batch->status === 'COMPLETED') {
                $completed_sub_batches++;
            } elseif ($sub_batch->status === 'ERROR') {
                $error_sub_batches++;
            }
            $total_success += $sub_batch->success_count;
            $total_failed += $sub_batch->failed_count;
        }

        // ç¡®å®šä¸»æ‰¹æ¬¡çŠ¶æ€
        $master_status = 'PROCESSING';
        $status_message = '';

        if ($completed_sub_batches === $total_sub_batches) {
            $master_status = 'COMPLETED';
            $status_message = 'æ‰€æœ‰å­æ‰¹æ¬¡å¤„ç†å®Œæˆ';
        } elseif ($error_sub_batches === $total_sub_batches) {
            $master_status = 'ERROR';
            $status_message = 'æ‰€æœ‰å­æ‰¹æ¬¡å¤„ç†å¤±è´¥';
        } elseif ($completed_sub_batches + $error_sub_batches === $total_sub_batches) {
            $master_status = 'COMPLETED';
            $status_message = "éƒ¨åˆ†å­æ‰¹æ¬¡æˆåŠŸï¼ˆ{$completed_sub_batches}/{$total_sub_batches}ï¼‰";
        }

        // æ›´æ–°ä¸»æ‰¹æ¬¡çŠ¶æ€
        $update_data = [
            'status' => $master_status,
            'success_count' => $total_success,
            'failed_count' => $total_failed,
            'progress_current' => $total_success + $total_failed,
            'updated_at' => current_time('mysql')
        ];

        if ($master_status === 'COMPLETED' || $master_status === 'ERROR') {
            $update_data['completed_at'] = current_time('mysql');
            $update_data['error_details'] = $status_message;
        }

        $wpdb->update(
            $batch_feeds_table,
            $update_data,
            ['batch_id' => $parent_batch_id]
        );

        woo_walmart_sync_log('ä¸»æ‰¹æ¬¡çŠ¶æ€æ›´æ–°', 'æˆåŠŸ', [
            'parent_batch_id' => $parent_batch_id,
            'master_status' => $master_status,
            'completed_sub_batches' => $completed_sub_batches,
            'total_sub_batches' => $total_sub_batches,
            'total_success' => $total_success,
            'total_failed' => $total_failed
        ], $status_message);
    }

    /**
     * ä¸ºæ‰¹é‡Feedä¸­çš„æ¯ä¸ªå•†å“åˆ›å»ºå•ç‹¬çš„Feedè®°å½•
     * è¿™æ ·åœ¨åŒæ­¥çŠ¶æ€é¡µé¢å°±èƒ½çœ‹åˆ°æ¯ä¸ªå•†å“çš„çŠ¶æ€
     */
    private function create_individual_feed_records($product_ids, $feed_id) {
        global $wpdb;
        $feeds_table = $wpdb->prefix . 'walmart_feeds';
        $upc_table = $wpdb->prefix . 'walmart_upc_pool';

        $created_count = 0;
        $skipped_count = 0;

        foreach ($product_ids as $product_id) {
            $product = wc_get_product($product_id);
            if (!$product) {
                $skipped_count++;
                continue;
            }

            // è·å–å•†å“çš„UPC
            $upc = $wpdb->get_var($wpdb->prepare(
                "SELECT upc_code FROM $upc_table WHERE product_id = %d AND is_used = 1",
                $product_id
            ));

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨Feedè®°å½•
            $existing_feed = $wpdb->get_var($wpdb->prepare(
                "SELECT id FROM $feeds_table WHERE product_id = %d AND feed_id = %s",
                $product_id,
                $feed_id
            ));

            if ($existing_feed) {
                $skipped_count++;
                continue; // å·²å­˜åœ¨ï¼Œè·³è¿‡
            }

            // å³ä½¿UPCä¸ºç©ºä¹Ÿåˆ›å»ºè®°å½•ï¼Œè¿™æ ·å¯ä»¥åœ¨åŒæ­¥çŠ¶æ€é¡µé¢çœ‹åˆ°
            $insert_result = $wpdb->insert(
                $feeds_table,
                [
                    'product_id' => $product_id,
                    'sku' => $product->get_sku(),
                    'upc' => $upc ?: '', // å…è®¸ç©ºUPC
                    'feed_id' => $feed_id,
                    'status' => 'SUBMITTED',
                    'submitted_at' => current_time('mysql'),
                    'created_at' => current_time('mysql'),
                    'updated_at' => current_time('mysql')
                ]
            );

            if ($insert_result) {
                $created_count++;
            } else {
                $skipped_count++;
                // è®°å½•æ’å…¥å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯
                woo_walmart_sync_log('Feedè®°å½•æ’å…¥å¤±è´¥', 'é”™è¯¯', [
                    'product_id' => $product_id,
                    'feed_id' => $feed_id,
                    'sku' => $product->get_sku(),
                    'upc' => $upc,
                    'wpdb_error' => $wpdb->last_error
                ], "å•†å“ID {$product_id} çš„Feedè®°å½•æ’å…¥å¤±è´¥");
            }
        }

        // è®°å½•åˆ›å»ºç»“æœ
        woo_walmart_sync_log('æ‰¹é‡Feedè®°å½•åˆ›å»º', 'å®Œæˆ', [
            'feed_id' => $feed_id,
            'total_products' => count($product_ids),
            'created_records' => $created_count,
            'skipped_records' => $skipped_count
        ], "ä¸ºFeed {$feed_id} åˆ›å»ºäº† {$created_count} ä¸ªå•†å“è®°å½•");
    }
}

// æ—¥å¿—å‡½æ•°å·²ç§»åˆ°æ–‡ä»¶å¼€å¤´

// AJAXå¤„ç†å‡½æ•°ï¼šç«‹å³å¤„ç†æ‰¹æ¬¡
add_action('wp_ajax_process_batch_now', function() {
    check_ajax_referer('walmart_batch_action', 'nonce');

    $batch_id = sanitize_text_field($_POST['batch_id']);

    if (empty($batch_id)) {
        wp_send_json_error(['message' => 'æ‰¹æ¬¡IDä¸èƒ½ä¸ºç©º']);
        return;
    }

    global $wpdb;
    $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';

    // è·å–æ‰¹æ¬¡ä¿¡æ¯
    $batch = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $batch_feeds_table WHERE batch_id = %s",
        $batch_id
    ));

    if (!$batch) {
        wp_send_json_error(['message' => 'æ‰¹æ¬¡ä¸å­˜åœ¨']);
        return;
    }

    // æ£€æŸ¥æ‰¹æ¬¡çŠ¶æ€
    if (!in_array($batch->status, ['PENDING', 'SUBMITTED', 'QUEUED'])) {
        wp_send_json_error(['message' => 'æ‰¹æ¬¡çŠ¶æ€ä¸å…è®¸ç«‹å³å¤„ç†']);
        return;
    }

    try {
        // æ ¹æ®æ‰¹æ¬¡ç±»å‹å¤„ç†
        if ($batch->sync_method === 'small_batch') {
            // å°æ‰¹é‡ï¼šåŠ å…¥é˜Ÿåˆ—ç«‹å³å¤„ç†
            $product_ids = json_decode($batch->product_ids, true);
            if (!empty($product_ids)) {
                $queue = get_option('walmart_sync_queue', []);
                // å°†æ‰¹æ¬¡å•†å“æ·»åŠ åˆ°é˜Ÿåˆ—å‰é¢ï¼ˆä¼˜å…ˆå¤„ç†ï¼‰
                $new_queue = array_unique(array_merge($product_ids, $queue));
                update_option('walmart_sync_queue', $new_queue);

                // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€
                $wpdb->update(
                    $batch_feeds_table,
                    ['status' => 'PROCESSING', 'updated_at' => current_time('mysql')],
                    ['batch_id' => $batch_id]
                );

                wp_send_json_success(['message' => 'æ‰¹æ¬¡å·²åŠ å…¥é˜Ÿåˆ—ä¼˜å…ˆå¤„ç†']);
            }
        } else {
            // ä¸­å¤§æ‰¹é‡ï¼šæ£€æŸ¥FeedçŠ¶æ€
            $sync = new Woo_Walmart_Product_Sync();
            $sync->check_batch_feed_statuses();

            wp_send_json_success(['message' => 'å·²åˆ·æ–°æ‰¹æ¬¡çŠ¶æ€ï¼Œè¯·æŸ¥çœ‹æœ€æ–°çŠ¶æ€']);
        }
    } catch (Exception $e) {
        wp_send_json_error(['message' => 'å¤„ç†å¤±è´¥ï¼š' . $e->getMessage()]);
    }
});

// AJAXå¤„ç†å‡½æ•°ï¼šåˆ é™¤æ‰¹æ¬¡
add_action('wp_ajax_delete_batch', function() {
    check_ajax_referer('walmart_batch_action', 'nonce');

    $batch_id = sanitize_text_field($_POST['batch_id']);

    if (empty($batch_id)) {
        wp_send_json_error(['message' => 'æ‰¹æ¬¡IDä¸èƒ½ä¸ºç©º']);
        return;
    }

    global $wpdb;
    $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';
    $batch_items_table = $wpdb->prefix . 'walmart_batch_items';
    $feeds_table = $wpdb->prefix . 'walmart_feeds';

    try {
        // é¦–å…ˆæ£€æŸ¥æ‰¹æ¬¡æ˜¯å¦å­˜åœ¨
        $batch_exists = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $batch_feeds_table WHERE batch_id = %s",
            $batch_id
        ));

        if (!$batch_exists) {
            wp_send_json_error(['message' => 'æ‰¹æ¬¡ä¸å­˜åœ¨']);
            return;
        }

        // è·å–æ‰¹æ¬¡ä¿¡æ¯ç”¨äºæ—¥å¿—
        $batch_info = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $batch_feeds_table WHERE batch_id = %s",
            $batch_id
        ));

        // åˆ é™¤ç›¸å…³çš„å•ä¸ªFeedè®°å½•
        if ($batch_info && $batch_info->feed_id) {
            $deleted_feeds = $wpdb->delete($feeds_table, ['feed_id' => $batch_info->feed_id]);
            woo_walmart_sync_log('åˆ é™¤æ‰¹æ¬¡Feedè®°å½•', 'æˆåŠŸ', [
                'batch_id' => $batch_id,
                'feed_id' => $batch_info->feed_id,
                'deleted_feeds_count' => $deleted_feeds
            ], "åˆ é™¤äº† {$deleted_feeds} ä¸ªFeedè®°å½•");
        }

        // åˆ é™¤æ‰¹æ¬¡å•†å“è®°å½•
        $deleted_items = $wpdb->delete($batch_items_table, ['batch_id' => $batch_id]);

        // åˆ é™¤å­æ‰¹æ¬¡ï¼ˆå¦‚æœæœ‰ï¼‰
        $sub_batches = $wpdb->get_results($wpdb->prepare(
            "SELECT batch_id, feed_id FROM $batch_feeds_table WHERE parent_batch_id = %s",
            $batch_id
        ));

        $deleted_sub_batches = 0;
        foreach ($sub_batches as $sub_batch) {
            // åˆ é™¤å­æ‰¹æ¬¡çš„Feedè®°å½•
            if ($sub_batch->feed_id) {
                $wpdb->delete($feeds_table, ['feed_id' => $sub_batch->feed_id]);
            }
            // åˆ é™¤å­æ‰¹æ¬¡çš„å•†å“è®°å½•
            $wpdb->delete($batch_items_table, ['batch_id' => $sub_batch->batch_id]);
            // åˆ é™¤å­æ‰¹æ¬¡è®°å½•
            $wpdb->delete($batch_feeds_table, ['batch_id' => $sub_batch->batch_id]);
            $deleted_sub_batches++;
        }

        // åˆ é™¤ä¸»æ‰¹æ¬¡
        $result = $wpdb->delete($batch_feeds_table, ['batch_id' => $batch_id]);

        if ($result) {
            // è®°å½•è¯¦ç»†çš„åˆ é™¤æ“ä½œ
            woo_walmart_sync_log('æ‰¹æ¬¡åˆ é™¤', 'æˆåŠŸ', [
                'batch_id' => $batch_id,
                'deleted_items' => $deleted_items,
                'deleted_sub_batches' => $deleted_sub_batches,
                'batch_info' => [
                    'product_count' => $batch_info->product_count,
                    'sync_method' => $batch_info->sync_method,
                    'status' => $batch_info->status,
                    'feed_id' => $batch_info->feed_id
                ]
            ], "æ‰‹åŠ¨åˆ é™¤æ‰¹æ¬¡ï¼š{$batch_id}");

            wp_send_json_success([
                'message' => 'æ‰¹æ¬¡å·²åˆ é™¤',
                'deleted_details' => [
                    'batch_items' => $deleted_items,
                    'sub_batches' => $deleted_sub_batches,
                    'main_batch' => 1
                ]
            ]);
        } else {
            wp_send_json_error(['message' => 'åˆ é™¤ä¸»æ‰¹æ¬¡å¤±è´¥']);
        }
    } catch (Exception $e) {
        woo_walmart_sync_log('æ‰¹æ¬¡åˆ é™¤', 'å¼‚å¸¸', [
            'batch_id' => $batch_id,
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString()
        ], 'åˆ é™¤æ‰¹æ¬¡æ—¶å‘ç”Ÿå¼‚å¸¸');

        wp_send_json_error(['message' => 'åˆ é™¤å¤±è´¥ï¼š' . $e->getMessage()]);
    }
});

// æ³¨å†Œåå°èœå•
add_action( 'admin_menu', function() {
    // è°ƒè¯•ï¼šè®°å½•èœå•æ³¨å†Œ
    error_log('Walmart Sync: æ­£åœ¨æ³¨å†Œèœå•');
    add_menu_page(
        'WalmartåŒæ­¥è®¾ç½®',
        'Walmart åŒæ­¥',
        'manage_options',
        'woo-walmart-sync',
        'woo_walmart_sync_settings_page',
        'dashicons-store'
    );
    // è®¾ç½®é¡µé¢å­èœå•
    add_submenu_page(
        'woo-walmart-sync',
        'API è®¾ç½®',
        'API è®¾ç½®',
        'manage_options',
        'woo-walmart-sync', // ä¸ä¸»èœå•slugç›¸åŒï¼Œå®ç°åŒé¡µ
        'woo_walmart_sync_settings_page'
    );
    // åˆ†ç±»æ˜ å°„é¡µé¢å­èœå•
    add_submenu_page(
        'woo-walmart-sync',
        'åˆ†ç±»æ˜ å°„',
        'åˆ†ç±»æ˜ å°„',
        'manage_options',
        'woo-walmart-category-mapping',
        'woo_walmart_category_mapping_page'
    );
     // UPCæ± ç®¡ç†é¡µé¢å­èœå•
     add_submenu_page(
        'woo-walmart-sync',
        'UPCæ± ç®¡ç†',
        'UPCæ± ç®¡ç†',
        'manage_options',
        'woo-walmart-upc-pool',
        'woo_walmart_upc_pool_page'
    );



    // UPCå¯¼å‡ºé¡µé¢ï¼ˆéšè—èœå•ï¼Œä»…ç”¨äºå¤„ç†å¯¼å‡ºè¯·æ±‚ï¼‰
    add_submenu_page(
        '', // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºéšè—èœå•ï¼Œé¿å…nullå€¼
        'UPCæ•°æ®å¯¼å‡º',
        'UPCæ•°æ®å¯¼å‡º',
        'manage_options',
        'woo-walmart-upc-export',
        'woo_walmart_upc_export_handler'
    );
    // æ—¥å¿—é¡µé¢å­èœå•
    add_submenu_page(
        'woo-walmart-sync',
        'åŒæ­¥æ—¥å¿—',
        'åŒæ­¥æ—¥å¿—',
        'manage_options',
        'woo-walmart-sync-logs',
        'woo_walmart_sync_logs_page'
    );

    add_submenu_page(
        'woo-walmart-sync',
        'åº“å­˜åŒæ­¥ç®¡ç†',
        'åº“å­˜åŒæ­¥ç®¡ç†',
        'manage_options',
        'woo-walmart-inventory-sync',
        'woo_walmart_inventory_sync_page'
    );

    // Walmartå•†å“ç®¡ç†é¡µé¢
    add_submenu_page(
        'woo-walmart-sync',
        'Walmartå•†å“ç®¡ç†',
        'Walmartå•†å“ç®¡ç†',
        'manage_options',
        'woo-walmart-products-manager',
        'woo_walmart_products_manager_page'
    );

    // WalmartåŒæ­¥é€šçŸ¥é¡µé¢
    add_submenu_page(
        'woo-walmart-sync',
        'åŒæ­¥é€šçŸ¥',
        'åŒæ­¥é€šçŸ¥',
        'manage_options',
        'woo-walmart-notifications',
        'woo_walmart_notifications_page'
    );



    // åŒæ­¥çŠ¶æ€é¡µé¢å­èœå•
    add_submenu_page(
        'woo-walmart-sync',
        'åŒæ­¥çŠ¶æ€',
        'åŒæ­¥çŠ¶æ€',
        'manage_options',
        'woo-walmart-sync-feeds',
        'woo_walmart_feeds_page'
    );
    // é˜Ÿåˆ—ç®¡ç†é¡µé¢å­èœå•
    add_submenu_page(
        'woo-walmart-sync',
        'é˜Ÿåˆ—ç®¡ç†',
        'é˜Ÿåˆ—ç®¡ç†',
        'manage_options',
        'woo-walmart-queue-manager',
        'woo_walmart_queue_manager_page'
    );

    // å›¾ç‰‡æ‰«æç®¡ç†é¡µé¢å­èœå•
    add_submenu_page(
        'woo-walmart-sync',
        'å›¾ç‰‡æ‰«æç®¡ç†',
        'å›¾ç‰‡æ‰«æç®¡ç†',
        'manage_options',
        'woo-walmart-image-scanner',
        'woo_walmart_image_scanner_page'
    );

    // SKUæ‰¹é‡åŒæ­¥é¡µé¢å­èœå•
    add_submenu_page(
        'woo-walmart-sync',
        'SKUæ‰¹é‡åŒæ­¥',
        'SKUæ‰¹é‡åŒæ­¥',
        'manage_options',
        'woo-walmart-sku-batch-sync',
        'woo_walmart_sku_batch_sync_page'
    );

    // ğŸ”§ AJAXè°ƒè¯•æµ‹è¯•é¡µé¢ï¼ˆä¸´æ—¶ï¼‰
    add_submenu_page(
        'woo-walmart-sync',
        'AJAXè°ƒè¯•æµ‹è¯•',
        'ğŸ”§ AJAXè°ƒè¯•',
        'manage_options',
        'woo-walmart-ajax-debug',
        'woo_walmart_ajax_debug_page'
    );

    // è°ƒè¯•ï¼šè®°å½•é˜Ÿåˆ—ç®¡ç†èœå•æ³¨å†Œ
    error_log('Walmart Sync: é˜Ÿåˆ—ç®¡ç†èœå•å·²æ³¨å†Œ');
});

// åŠ è½½ç®¡ç†é¡µé¢æ ·å¼å’Œè„šæœ¬
add_action('admin_enqueue_scripts', function($hook) {
    // åªåœ¨æˆ‘ä»¬çš„æ’ä»¶é¡µé¢åŠ è½½æ ·å¼
    if (!$hook || !is_string($hook) || (strpos($hook, 'woo-walmart') === false && strpos($hook, 'walmart') === false)) {
        return;
    }

    // æ·»åŠ å†…è”æ ·å¼
    $styles = get_walmart_admin_styles();
    if ($styles && is_string($styles)) {
        wp_add_inline_style('wp-admin', $styles);
    }
});

// è·å–ç®¡ç†é¡µé¢æ ·å¼
function get_walmart_admin_styles() {
    return '
        /* Walmartæ’ä»¶åŸºç¡€æ ·å¼ */
        .walmart-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #2271b1;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            line-height: 1.4;
            transition: all 0.2s ease;
        }

        .walmart-btn:hover {
            background: #135e96;
            color: #fff;
        }

        .walmart-btn-primary {
            background: #2271b1;
        }

        .walmart-btn-secondary {
            background: #646970;
        }

        .walmart-btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .walmart-stats-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .walmart-stat-box {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            padding: 20px;
            flex: 1;
            min-width: 200px;
            text-align: center;
        }

        .walmart-stat-box h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #646970;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #1d2327;
            margin-bottom: 5px;
        }

        .stat-text {
            font-size: 16px;
            font-weight: 600;
            color: #1d2327;
            margin-bottom: 5px;
        }

        /* å•†å“ç®¡ç†é¡µé¢ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .walmart-products-manager .walmart-stat-box {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            padding: 20px;
            flex: 1;
            min-width: 200px;
            text-align: center;
        }

        .walmart-products-manager .walmart-stat-box h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #646970;
        }

        .walmart-products-manager .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #1d2327;
            margin-bottom: 5px;
        }

        .walmart-products-manager .stat-text {
            font-size: 16px;
            font-weight: 600;
            color: #1d2327;
            margin-bottom: 5px;
        }

        .walmart-products-manager .walmart-stat-box p {
            margin: 0;
            color: #646970;
            font-size: 12px;
        }

        .walmart-stat-box p {
            margin: 0;
            color: #646970;
            font-size: 12px;
        }

        .walmart-actions-panel {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
        }

        .action-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .action-form label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }

        /* Walmartå•†å“ç®¡ç†é¡µé¢æ ·å¼ */
        .walmart-products-manager {
            max-width: 100%;
            margin: 0;
            overflow: hidden;
        }

        .walmart-products-manager .wrap {
            margin: 0;
            padding: 0 20px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .walmart-products-manager .walmart-search-panel {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }

        .walmart-products-manager .search-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .walmart-products-manager .search-input {
            min-width: 250px;
            padding: 8px 12px;
        }

        .walmart-products-manager .status-filter {
            padding: 8px 12px;
            min-width: 120px;
        }

        .walmart-products-manager .per-page-selector {
            padding: 8px 12px;
            min-width: 100px;
        }

        /* å…¨é€‰é¢æ¿æ ·å¼ */
        .walmart-select-all-panel {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }

        .select-all-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .selected-count {
            color: #2271b1;
            font-weight: normal;
        }

        /* å•†å“å¡ç‰‡ç½‘æ ¼ */
        .walmart-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        /* å•†å“å¡ç‰‡æ ·å¼ */
        .walmart-product-card {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .walmart-product-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .walmart-product-card.selected {
            border-color: #2271b1;
            box-shadow: 0 0 0 1px #2271b1;
        }

        /* å¡ç‰‡å¤´éƒ¨ */
        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f6f7f7;
            border-bottom: 1px solid #c3c4c7;
        }

        .product-checkbox-wrapper input[type="checkbox"] {
            transform: scale(1.2);
        }

        .product-status .status-published {
            background: #d1e7dd;
            color: #0f5132;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .product-status .status-unpublished {
            background: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        /* å¡ç‰‡å†…å®¹ */
        .product-card-content {
            padding: 15px;
        }

        .product-title {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
            color: #1d2327;
            line-height: 1.4;
            min-height: 44px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* å•†å“å…ƒæ•°æ® */
        .product-meta {
            margin-bottom: 15px;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .meta-label {
            font-size: 12px;
            color: #646970;
            font-weight: 600;
        }

        .meta-value {
            font-size: 12px;
            background: #f0f0f1;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: Consolas, Monaco, monospace;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .product-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f6f7f7;
            border-radius: 4px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 11px;
            color: #646970;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .stat-value {
            display: block;
            font-size: 16px;
            font-weight: 700;
            color: #1d2327;
        }

        .stat-value.price {
            color: #00a32a;
        }

        .stat-value.inventory {
            color: #2271b1;
        }

        /* å¡ç‰‡åº•éƒ¨ */
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #f0f0f1;
        }

        .last-sync {
            font-size: 11px;
            color: #646970;
        }

        .product-actions .walmart-btn-small {
            padding: 6px 12px;
            font-size: 11px;
        }

        .walmart-bulk-actions-panel {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }

        .walmart-bulk-actions-panel h3 {
            margin: 0 0 15px 0;
            color: #1d2327;
        }

        .bulk-actions-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .bulk-action-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .bulk-action-group label {
            font-weight: 600;
            color: #1d2327;
        }

        .bulk-action-select {
            padding: 8px 12px;
            min-width: 150px;
        }

        .walmart-pagination {
            text-align: center;
            margin: 20px 0;
        }

        .walmart-pagination .page-numbers {
            display: inline-block;
            padding: 8px 12px;
            margin: 0 2px;
            background: #fff;
            border: 1px solid #c3c4c7;
            color: #2271b1;
            text-decoration: none;
            border-radius: 3px;
        }

        .walmart-pagination .page-numbers:hover {
            background: #f6f7f7;
        }

        .walmart-pagination .page-numbers.current {
            background: #2271b1;
            color: #fff;
            border-color: #2271b1;
        }

        .walmart-empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            margin: 20px 0;
        }

        .walmart-empty-state h3 {
            color: #646970;
            margin-bottom: 10px;
        }

        .walmart-empty-state p {
            color: #646970;
        }

        /* è¡¨æ ¼å®¹å™¨æ ·å¼ */
        .walmart-table-container {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            margin: 20px 0;
            overflow-x: auto;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        /* åˆ†é¡µæ ·å¼ä¼˜åŒ– */
        .walmart-pagination-info {
            text-align: center;
            margin: 15px 0;
            color: #646970;
            font-size: 14px;
        }

        .walmart-per-page-selector {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f6f7f7;
            border-radius: 4px;
        }

        .walmart-per-page-selector label {
            font-weight: 600;
            color: #1d2327;
            margin-right: 10px;
        }

        .walmart-per-page-selector select {
            padding: 8px 12px;
            min-width: 100px;
            border: 1px solid #8c8f94;
            border-radius: 4px;
            background: #fff;
            font-size: 14px;
        }

        .walmart-per-page-selector span {
            margin-left: 10px;
            color: #646970;
        }

        /* è¡¨æ ¼å“åº”å¼æ ·å¼ */
        @media (max-width: 1200px) {
            .walmart-table {
                font-size: 13px;
            }

            .walmart-table th,
            .walmart-table td {
                padding: 8px 6px;
            }
        }

        @media (max-width: 768px) {
            .walmart-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                max-width: calc(100vw - 40px);
            }

            .walmart-table {
                min-width: 600px;
                font-size: 12px;
                width: 100%;
            }

            .walmart-table th,
            .walmart-table td {
                padding: 6px 4px;
                word-break: break-word;
            }

            .walmart-products-manager .wrap {
                padding: 0 10px;
            }
        }

        /* è¡¨æ ¼åŠ è½½åŠ¨ç”» */
        .walmart-table tbody tr {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ’åºæç¤º */
        .sort-info {
            font-size: 12px;
            color: #646970;
            margin: 10px 0;
            text-align: center;
        }

        .sort-info .current-sort {
            font-weight: 600;
            color: #2271b1;
        }

        /* é€šçŸ¥é¡µé¢æ ·å¼ */
        .walmart-notifications-list {
            margin: 20px 0;
        }

        .notification-item {
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            overflow: hidden;
        }

        .notification-item.unread {
            border-left: 4px solid #2271b1;
        }

        .notification-item.priority-error {
            border-left: 4px solid #d63638;
        }

        .notification-item.priority-success {
            border-left: 4px solid #00a32a;
        }

        .notification-checkbox {
            padding: 15px;
            background: #f6f7f7;
            border-right: 1px solid #c3c4c7;
        }

        .notification-content {
            flex: 1;
            padding: 15px;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .notification-header h4 {
            margin: 0;
            color: #1d2327;
        }

        .notification-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 12px;
            color: #646970;
        }

        .notification-type {
            background: #f0f0f1;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .notification-status.unread {
            background: #2271b1;
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .notification-message {
            color: #1d2327;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .notification-details details {
            margin-top: 10px;
        }

        .notification-details summary {
            cursor: pointer;
            color: #2271b1;
            font-weight: 600;
        }

        .notification-details pre {
            background: #f6f7f7;
            padding: 10px;
            border-radius: 3px;
            font-size: 11px;
            overflow-x: auto;
            margin-top: 10px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .walmart-products-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .product-stats {
                flex-direction: column;
                gap: 8px;
            }

            .stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: left;
            }

            .stat-label {
                margin-bottom: 0;
            }

            .walmart-stats-container {
                flex-direction: column;
            }

            .search-group {
                flex-direction: column;
                align-items: stretch;
            }

            .bulk-actions-row {
                flex-direction: column;
                align-items: stretch;
            }

            .bulk-action-group {
                flex-direction: column;
                align-items: stretch;
            }

            .bulk-action-group label {
                min-width: auto;
            }
        }
    ';
}

// åˆ†ç±»æ˜ å°„é¡µé¢å†…å®¹
function woo_walmart_category_mapping_page() {
    global $wpdb;
    $map_table = $wpdb->prefix . 'walmart_category_map';



    // å¤„ç†å•ä¸ªæ˜ å°„ä¿å­˜
    if (isset($_POST['action']) && $_POST['action'] === 'save_mapping') {
        check_admin_referer('walmart_category_map_save');
        if (!empty($_POST['walmart_category'])) {
            foreach ($_POST['walmart_category'] as $wc_cat_id => $walmart_path) {
                $wc_cat_id = intval($wc_cat_id);
                $walmart_path = sanitize_text_field($walmart_path);
                $wc_term = get_term($wc_cat_id, 'product_cat');
                
                $attributes_mapping = [];
                // å¢åŠ å¥å£®æ€§æ£€æŸ¥ï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„é”®éƒ½å­˜åœ¨
                if (isset($_POST['attributes'][$wc_cat_id]['name']) && is_array($_POST['attributes'][$wc_cat_id]['name'])) {
                     $raw_attributes = wp_unslash($_POST['attributes'][$wc_cat_id]);

                     // åŒæ—¶æ£€æŸ¥æ˜¯å¦æœ‰å¿…å¡«çº§åˆ«ä¿¡æ¯å’Œæšä¸¾å€¼ä¿¡æ¯
                     $required_levels = isset($_POST['required_levels'][$wc_cat_id]) ? wp_unslash($_POST['required_levels'][$wc_cat_id]) : [];
                     $enum_values = isset($_POST['enum_values'][$wc_cat_id]) ? wp_unslash($_POST['enum_values'][$wc_cat_id]) : [];



                     // è·å–ç°æœ‰çš„æ˜ å°„æ•°æ®è¿›è¡Œæ¯”è¾ƒ - ä»æ•°æ®åº“è¡¨è¯»å–
                     $existing_db_data = $wpdb->get_row($wpdb->prepare(
                         "SELECT walmart_attributes FROM $map_table WHERE wc_category_id = %d",
                         $wc_cat_id
                     ));
                     $existing_mapping = [];
                     if ($existing_db_data && !empty($existing_db_data->walmart_attributes)) {
                         $existing_mapping = json_decode($existing_db_data->walmart_attributes, true);
                         if (!is_array($existing_mapping)) {
                             $existing_mapping = [];
                         }
                     }
                     $existing_names = isset($existing_mapping['name']) ? $existing_mapping['name'] : [];
                     $existing_types = isset($existing_mapping['type']) ? $existing_mapping['type'] : [];
                     $existing_sources = isset($existing_mapping['source']) ? $existing_mapping['source'] : [];

                     // æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜åŒ–
                     $has_changes = false;
                     $changes_log = [];

                     // é¦–å…ˆæ£€æŸ¥æ•°ç»„é•¿åº¦æ˜¯å¦å˜åŒ–
                     if (count($raw_attributes['name']) !== count($existing_names)) {
                         $has_changes = true;
                         $changes_log[] = 'å±æ€§æ•°é‡å˜åŒ–: ' . count($existing_names) . ' -> ' . count($raw_attributes['name']);
                     }

                     // æ£€æŸ¥æ¯ä¸ªå±æ€§æ˜¯å¦æœ‰å˜åŒ–
                     foreach($raw_attributes['name'] as $index => $name) {
                        if (!empty($name)) {
                            $name = sanitize_text_field($name);
                            $type = isset($raw_attributes['type'][$index]) ? sanitize_text_field($raw_attributes['type'][$index]) : 'default_value';
                            $source = isset($raw_attributes['source'][$index]) ? sanitize_text_field($raw_attributes['source'][$index]) : '';

                            // æ£€æŸ¥è¿™ä¸ªå±æ€§æ˜¯å¦æœ‰å˜åŒ–
                            $existing_name = isset($existing_names[$index]) ? $existing_names[$index] : '';
                            $existing_type = isset($existing_types[$index]) ? $existing_types[$index] : '';
                            $existing_source = isset($existing_sources[$index]) ? $existing_sources[$index] : '';

                            if ($name !== $existing_name || $type !== $existing_type || $source !== $existing_source) {
                                $has_changes = true;
                                $changes_log[] = "ç´¢å¼•{$index}: {$existing_name}|{$existing_type}|{$existing_source} -> {$name}|{$type}|{$source}";
                            }

                            $attributes_mapping['name'][] = $name;
                            $attributes_mapping['type'][] = $type;
                            $attributes_mapping['source'][] = $source;

                            // ä¿å­˜å¿…å¡«çº§åˆ«ä¿¡æ¯
                            $required_level = isset($required_levels[$index]) ? sanitize_text_field($required_levels[$index]) : '';
                            $attributes_mapping['required_level'][] = $required_level;

                            // ä¿å­˜æšä¸¾å€¼ä¿¡æ¯
                            $enum_value = isset($enum_values[$index]) ? $enum_values[$index] : '';
                            $attributes_mapping['enum_values'][] = $enum_value;


                        }
                     }

                     // åªæœ‰åœ¨æœ‰å®é™…å˜åŒ–æ—¶æ‰ä¿å­˜å’Œè®°å½•æ—¥å¿—
                     if ($has_changes) {
                         woo_walmart_sync_log('åˆ†ç±»æ˜ å°„ä¿å­˜-æœ‰å˜åŒ–', 'ä¿å­˜', [
                             'wc_cat_id' => $wc_cat_id,
                             'changes' => $changes_log,
                             'final_data' => $attributes_mapping
                         ], '');
                     } else {
                         woo_walmart_sync_log('åˆ†ç±»æ˜ å°„ä¿å­˜-æ— å˜åŒ–', 'è·³è¿‡', ['wc_cat_id' => $wc_cat_id], '');
                         // å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œä½¿ç”¨ç°æœ‰çš„æ˜ å°„æ•°æ®
                         $attributes_mapping = $existing_mapping;
                     }
                } else {
                    // å¦‚æœæ²¡æœ‰æäº¤å±æ€§æ•°æ®ï¼Œä¿æŒç°æœ‰æ˜ å°„ - ä»æ•°æ®åº“è¡¨è¯»å–
                    $existing_db_data = $wpdb->get_row($wpdb->prepare(
                        "SELECT walmart_attributes FROM $map_table WHERE wc_category_id = %d",
                        $wc_cat_id
                    ));
                    $attributes_mapping = [];
                    if ($existing_db_data && !empty($existing_db_data->walmart_attributes)) {
                        $attributes_mapping = json_decode($existing_db_data->walmart_attributes, true);
                        if (!is_array($attributes_mapping)) {
                            $attributes_mapping = [];
                        }
                    }
                }

                if ($wc_term && !is_wp_error($wc_term)) {
                    if (empty($walmart_path)) {
                        $wpdb->delete($map_table, ['wc_category_id' => $wc_cat_id]);
                    } else {
                        $json_data = wp_json_encode($attributes_mapping, JSON_UNESCAPED_UNICODE);
                        $wpdb->replace(
                            $map_table,
                            [
                                'wc_category_id' => $wc_cat_id,
                                'wc_category_name' => $wc_term->name,
                                'walmart_category_path' => $walmart_path,
                                'walmart_attributes' => $json_data
                            ]
                        );

                    }
                }
            }
            echo '<div class="updated"><p>åˆ†ç±»æ˜ å°„å·²ä¿å­˜ï¼</p></div>';
        }
    }

    // å¤„ç†ä»æ²ƒå°”ç›è·å–åˆ†ç±»
    if (isset($_GET['action']) && $_GET['action'] === 'fetch_walmart_categories') {
        check_admin_referer('fetch_walmart_categories_nonce');
        $api_auth = new Woo_Walmart_API_Key_Auth();

        // ä½¿ç”¨5.0ç‰ˆæœ¬çš„åˆ†ç±»ç«¯ç‚¹
        $endpoint = '/v3/items/taxonomy?version=5.0';

        woo_walmart_sync_log('åˆ†ç±»è·å–', 'å¼€å§‹', [
            'endpoint' => $endpoint
        ], 'å¼€å§‹ä»Walmart APIè·å–5.0ç‰ˆæœ¬åˆ†ç±»æ•°æ®');

        $result = $api_auth->make_request($endpoint);

        if (!is_wp_error($result)) {
            // è§£æAPIå“åº”æ•°æ®
            $categories_data = null;
            if (isset($result['payload'])) {
                $categories_data = $result['payload'];
            } elseif (isset($result['itemTaxonomy'])) {
                $categories_data = $result['itemTaxonomy'];
            } elseif (is_array($result) && isset($result[0]['id'])) {
                $categories_data = $result;
            }

            if ($categories_data && is_array($categories_data)) {
                // ä¿å­˜åˆ°æ•°æ®åº“
                $save_result = woo_walmart_save_categories_to_db($categories_data);

                if ($save_result['success']) {
                    // åŒæ—¶ä¿å­˜åˆ°transientä»¥ä¿æŒå‘åå…¼å®¹
                    set_transient('walmart_api_categories', $categories_data, DAY_IN_SECONDS);

                    echo '<div class="updated">';
                    echo '<p><strong>å·²æˆåŠŸä»æ²ƒå°”ç›è·å–å¹¶ä¿å­˜æœ€æ–°åˆ†ç±»ï¼</strong></p>';
                    echo '<ul style="margin-left: 20px;">';
                    echo '<li><strong>APIç‰ˆæœ¬:</strong> 5.0</li>';
                    echo '<li><strong>æ€»åˆ†ç±»æ•°:</strong> ' . $save_result['stats']['categories'] . '</li>';
                    echo '<li><strong>PTGæ•°é‡:</strong> ' . $save_result['stats']['ptgs'] . '</li>';
                    echo '<li><strong>PTæ•°é‡:</strong> ' . $save_result['stats']['pts'] . '</li>';
                    echo '<li><strong>æ›´æ–°æ—¶é—´:</strong> ' . current_time('Y-m-d H:i:s') . '</li>';
                    echo '</ul>';
                    echo '</div>';

                    woo_walmart_sync_log('åˆ†ç±»è·å–', 'æˆåŠŸ', $save_result['stats'], 'åˆ†ç±»æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“');
                } else {
                    echo '<div class="error">';
                    echo '<p><strong>åˆ†ç±»æ•°æ®ä¿å­˜å¤±è´¥</strong></p>';
                    echo '<p>é”™è¯¯ä¿¡æ¯: ' . esc_html($save_result['message']) . '</p>';
                    echo '</div>';

                    woo_walmart_sync_log('åˆ†ç±»è·å–', 'å¤±è´¥', [
                        'error' => $save_result['message']
                    ], 'åˆ†ç±»æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥');
                }
            } else {
                echo '<div class="error">';
                echo '<p><strong>APIå“åº”æ•°æ®æ ¼å¼é”™è¯¯</strong></p>';
                echo '<p>å“åº”ç±»å‹: ' . gettype($result) . '</p>';
                echo '<p>å“åº”é”®: ' . (is_array($result) ? implode(', ', array_keys($result)) : 'N/A') . '</p>';
                echo '</div>';

                woo_walmart_sync_log('åˆ†ç±»è·å–', 'å¤±è´¥', [
                    'response_type' => gettype($result),
                    'response_keys' => is_array($result) ? array_keys($result) : 'not_array'
                ], 'APIå“åº”æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ');
            }
        } else {
            $error_details = $result->get_error_message();
            echo '<div class="error">';
            echo '<p><strong>ä»æ²ƒå°”ç›è·å–åˆ†ç±»å¤±è´¥</strong></p>';
            echo '<p>APIç‰ˆæœ¬: 5.0</p>';
            echo '<p>é”™è¯¯ä¿¡æ¯: ' . esc_html($error_details) . '</p>';
            echo '<p>è¯·æ£€æŸ¥APIæƒé™æˆ–æŸ¥çœ‹åŒæ­¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚</p>';
            echo '</div>';

            woo_walmart_sync_log('åˆ†ç±»è·å–', 'å¤±è´¥', [
                'error' => $error_details
            ], 'Walmart APIè°ƒç”¨å¤±è´¥');
        }
    }

    // ğŸ‡¨ğŸ‡¦ å¤„ç†ä»åŠ æ‹¿å¤§è§„èŒƒæ–‡ä»¶è·å–åˆ†ç±»
    if (isset($_GET['action']) && $_GET['action'] === 'fetch_ca_categories') {
        check_admin_referer('fetch_ca_categories_nonce');

        woo_walmart_sync_log('åŠ æ‹¿å¤§åˆ†ç±»è·å–', 'å¼€å§‹', [], 'å¼€å§‹ä»CA_MP_ITEM_INTL_SPEC.jsonè§„èŒƒæ–‡ä»¶è§£æåˆ†ç±»æ•°æ®');

        // è¯»å–åŠ æ‹¿å¤§è§„èŒƒæ–‡ä»¶
        $spec_file = plugin_dir_path(__FILE__) . 'api/CA_MP_ITEM_INTL_SPEC.json';

        if (!file_exists($spec_file)) {
            echo '<div class="error">';
            echo '<p><strong>è§„èŒƒæ–‡ä»¶ä¸å­˜åœ¨</strong></p>';
            echo '<p>æ–‡ä»¶è·¯å¾„: ' . esc_html($spec_file) . '</p>';
            echo '</div>';
            woo_walmart_sync_log('åŠ æ‹¿å¤§åˆ†ç±»è·å–', 'å¤±è´¥', ['file' => $spec_file], 'è§„èŒƒæ–‡ä»¶ä¸å­˜åœ¨');
        } else {
            $spec_content = file_get_contents($spec_file);
            $spec_data = json_decode($spec_content, true);

            if (json_last_error() !== JSON_ERROR_NONE) {
                echo '<div class="error">';
                echo '<p><strong>è§„èŒƒæ–‡ä»¶è§£æå¤±è´¥</strong></p>';
                echo '<p>JSONé”™è¯¯: ' . json_last_error_msg() . '</p>';
                echo '</div>';
                woo_walmart_sync_log('åŠ æ‹¿å¤§åˆ†ç±»è·å–', 'å¤±è´¥', [], 'JSONè§£æå¤±è´¥: ' . json_last_error_msg());
            } else {
                // ä»è§„èŒƒæ–‡ä»¶ä¸­æå–äº§å“ç±»å‹ï¼ˆåœ¨ Visible éƒ¨åˆ†çš„ properties ä¸­ï¼‰
                $categories_data = [];

                if (isset($spec_data['properties']['MPItem']['items']['properties']['Visible']['properties'])) {
                    $visible_properties = $spec_data['properties']['MPItem']['items']['properties']['Visible']['properties'];

                    $category_index = 0;
                    foreach ($visible_properties as $category_name => $category_spec) {
                        // æ¯ä¸ª key å°±æ˜¯ä¸€ä¸ªäº§å“ç±»å‹åç§°
                        $categories_data[] = [
                            'categoryId' => 'CA_' . strtoupper(str_replace(' ', '_', $category_name)),
                            'categoryName' => $category_name,
                            'categoryPath' => $category_name,
                            'market' => 'CA',
                            'version' => '3.16'
                        ];
                        $category_index++;
                    }
                }

                if (!empty($categories_data)) {
                    // ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆä½¿ç”¨ä¸“é—¨çš„åŠ æ‹¿å¤§åˆ†ç±»è¡¨æˆ–æ ‡è®°ï¼‰
                    global $wpdb;
                    $table_name = $wpdb->prefix . 'walmart_categories_ca';

                    // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
                    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table_name'") === $table_name;

                    if (!$table_exists) {
                        $charset_collate = $wpdb->get_charset_collate();
                        $sql = "CREATE TABLE $table_name (
                            id mediumint(9) NOT NULL AUTO_INCREMENT,
                            category_id varchar(100) NOT NULL,
                            category_name varchar(255) NOT NULL,
                            category_path varchar(255) NOT NULL,
                            market varchar(10) DEFAULT 'CA',
                            version varchar(20) DEFAULT '3.16',
                            created_at datetime DEFAULT CURRENT_TIMESTAMP,
                            PRIMARY KEY (id),
                            UNIQUE KEY category_id (category_id)
                        ) $charset_collate;";

                        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
                        dbDelta($sql);
                    }

                    // æ¸…ç©ºæ—§æ•°æ®å¹¶æ’å…¥æ–°æ•°æ®
                    $wpdb->query("TRUNCATE TABLE $table_name");

                    $inserted = 0;
                    foreach ($categories_data as $category) {
                        $result = $wpdb->insert($table_name, [
                            'category_id' => $category['categoryId'],
                            'category_name' => $category['categoryName'],
                            'category_path' => $category['categoryPath'],
                            'market' => $category['market'],
                            'version' => $category['version']
                        ]);
                        if ($result) {
                            $inserted++;
                        }
                    }

                    // åŒæ—¶ä¿å­˜åˆ° transient ä»¥ä¾›ä¸‹æ‹‰èœå•ä½¿ç”¨
                    set_transient('walmart_ca_categories', $categories_data, DAY_IN_SECONDS);

                    echo '<div class="updated">';
                    echo '<p><strong>å·²æˆåŠŸä»è§„èŒƒæ–‡ä»¶è§£æå¹¶ä¿å­˜åŠ æ‹¿å¤§å¸‚åœºåˆ†ç±»ï¼</strong></p>';
                    echo '<ul style="margin-left: 20px;">';
                    echo '<li><strong>è§„èŒƒç‰ˆæœ¬:</strong> 3.16</li>';
                    echo '<li><strong>æ€»åˆ†ç±»æ•°:</strong> ' . count($categories_data) . '</li>';
                    echo '<li><strong>å·²æ’å…¥:</strong> ' . $inserted . ' æ¡</li>';
                    echo '<li><strong>æ›´æ–°æ—¶é—´:</strong> ' . current_time('Y-m-d H:i:s') . '</li>';
                    echo '</ul>';
                    echo '<h4>åˆ†ç±»åˆ—è¡¨ï¼ˆå‰20ä¸ªï¼‰:</h4>';
                    echo '<ul style="margin-left: 20px; max-height: 300px; overflow-y: auto;">';
                    $display_count = 0;
                    foreach ($categories_data as $category) {
                        if ($display_count >= 20) {
                            echo '<li>... è¿˜æœ‰ ' . (count($categories_data) - 20) . ' ä¸ªåˆ†ç±»</li>';
                            break;
                        }
                        echo '<li>' . esc_html($category['categoryName']) . ' (ID: ' . esc_html($category['categoryId']) . ')</li>';
                        $display_count++;
                    }
                    echo '</ul>';
                    echo '</div>';

                    woo_walmart_sync_log('åŠ æ‹¿å¤§åˆ†ç±»è·å–', 'æˆåŠŸ', [
                        'total' => count($categories_data),
                        'inserted' => $inserted
                    ], 'åŠ æ‹¿å¤§å¸‚åœºåˆ†ç±»æ•°æ®å·²æˆåŠŸä¿å­˜');
                } else {
                    echo '<div class="error">';
                    echo '<p><strong>æœªèƒ½ä»è§„èŒƒæ–‡ä»¶ä¸­æå–åˆ†ç±»æ•°æ®</strong></p>';
                    echo '<p>è¯·æ£€æŸ¥è§„èŒƒæ–‡ä»¶ç»“æ„æ˜¯å¦æ­£ç¡®ã€‚</p>';
                    echo '</div>';

                    woo_walmart_sync_log('åŠ æ‹¿å¤§åˆ†ç±»è·å–', 'å¤±è´¥', [], 'æœªèƒ½ä»è§„èŒƒæ–‡ä»¶ä¸­æå–åˆ†ç±»æ•°æ®');
                }
            }
        }
    }

    // ä¸´æ—¶åŠŸèƒ½ï¼šè·å–æ²ƒå°”ç›äº§å“ç±»å‹åˆ†ç±»æ³•
    if (isset($_GET['action']) && $_GET['action'] === 'get_walmart_taxonomy') {
        check_admin_referer('get_walmart_taxonomy_nonce');
        $api_auth = new Woo_Walmart_API_Key_Auth();
        $api_version = get_option('woo_walmart_api_version', '5.0');

        echo '<div class="notice notice-info"><p><strong>å½“å‰APIç‰ˆæœ¬:</strong> ' . esc_html($api_version) . '</p></div>';

        // å°è¯•å¤šç§æ–¹æ³•è·å–åˆ†ç±»æ³•
        echo '<h4>å°è¯•æ–¹æ³•1: æ–°ç‰ˆæœ¬äº§å“ç±»å‹åˆ†ç±»æ³• (POST)</h4>';

        // ğŸ”§ æ ¹æ®å½“å‰ä¸»å¸‚åœºåŠ¨æ€è·å– feedType
        $business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');
        $market_code = str_replace('WALMART_', '', $business_unit);
        require_once plugin_dir_path(__FILE__) . 'includes/class-multi-market-config.php';
        $market_config = Woo_Walmart_Multi_Market_Config::get_market_config($market_code);
        $feed_type = isset($market_config['feed_types']['item']) ? $market_config['feed_types']['item'] : 'MP_ITEM';

        $result1 = $api_auth->make_request('/v3/items/taxonomy', 'POST', [
            'version' => $api_version === '5.0' ? '5.0.20241118-04_39_24-api' : '1.0',
            'feedType' => $feed_type
        ]);

        echo '<h4>å°è¯•æ–¹æ³•2: ä¼ ç»Ÿåˆ†ç±»æ³• (GET)</h4>';
        $result2 = $api_auth->make_request('/v3/items/taxonomy');

        echo '<h4>å°è¯•æ–¹æ³•3: å¸¦versionå‚æ•°çš„GET</h4>';
        $version_param = $api_version === '5.0' ? '5.0.20241118-04_39_24-api' : '1.0';
        $result3 = $api_auth->make_request('/v3/items/taxonomy?version=' . urlencode($version_param));

        // é€‰æ‹©æœ€å¥½çš„ç»“æœ
        $result = null;
        if (!is_wp_error($result1) && !isset($result1['error'])) {
            $result = $result1;
            echo '<p style="color: green;">ä½¿ç”¨æ–¹æ³•1çš„ç»“æœ</p>';
        } elseif (!is_wp_error($result2) && !isset($result2['error'])) {
            $result = $result2;
            echo '<p style="color: green;">ä½¿ç”¨æ–¹æ³•2çš„ç»“æœ</p>';
        } elseif (!is_wp_error($result3) && !isset($result3['error'])) {
            $result = $result3;
            echo '<p style="color: green;">ä½¿ç”¨æ–¹æ³•3çš„ç»“æœ</p>';
        } else {
            $result = $result1; // æ˜¾ç¤ºç¬¬ä¸€ä¸ªé”™è¯¯
            echo '<p style="color: red;">æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªé”™è¯¯</p>';
        }

        echo '<div style="background: #fff; padding: 20px; margin: 20px 0; border: 1px solid #ccc;">';
        echo '<h3>æ²ƒå°”ç›åˆ†ç±»æ³•è°ƒè¯•ä¿¡æ¯</h3>';

        if (is_wp_error($result)) {
            echo '<p style="color: red;">APIé”™è¯¯: ' . $result->get_error_message() . '</p>';
        } elseif (empty($result)) {
            echo '<p style="color: red;">APIè¿”å›ç©ºç»“æœ</p>';
        } else {
            echo '<p style="color: green;">APIè°ƒç”¨æˆåŠŸï¼</p>';
            echo '<h4>ç»“æœç»“æ„:</h4>';
            echo '<pre>' . print_r(array_keys($result), true) . '</pre>';

            echo '<h4>Payloadè¯¦ç»†ä¿¡æ¯:</h4>';
            if (isset($result['payload'])) {
                echo '<p>Payloadç±»å‹: ' . gettype($result['payload']) . '</p>';
                if (is_array($result['payload'])) {
                    echo '<p>Payloadæ•°ç»„é•¿åº¦: ' . count($result['payload']) . '</p>';
                    echo '<p>Payloadå‰5ä¸ªé”®: </p>';
                    echo '<pre>' . print_r(array_slice(array_keys($result['payload']), 0, 5), true) . '</pre>';

                    if (count($result['payload']) > 0) {
                        echo '<p>ç¬¬ä¸€ä¸ªå…ƒç´ ç»“æ„: </p>';
                        $first_element = reset($result['payload']);
                        if (is_array($first_element)) {
                            echo '<pre>' . print_r(array_keys($first_element), true) . '</pre>';
                        } else {
                            echo '<pre>' . print_r($first_element, true) . '</pre>';
                        }
                    }
                } else {
                    echo '<pre>' . print_r($result['payload'], true) . '</pre>';
                }
            } else {
                echo '<p>æ²¡æœ‰payloadå­—æ®µ</p>';
            }

            echo '<h4>å®Œæ•´ç»“æœ (æˆªå–å‰1000å­—ç¬¦):</h4>';
            echo '<pre>' . esc_html(substr(print_r($result, true), 0, 1000)) . '...</pre>';

            // æ˜¾ç¤ºæ‰€æœ‰åˆ†ç±»ä¿¡æ¯
            if (isset($result['payload']) && is_array($result['payload']) && count($result['payload']) > 0) {
                echo '<h4>æ‰€æœ‰åˆ†ç±» (å‰15ä¸ª):</h4>';

                $count = 0;
                foreach ($result['payload'] as $category) {
                    if ($count >= 15) break; // æ˜¾ç¤ºå‰15ä¸ª

                    if (isset($category['categoryName'])) {
                        echo '<p>' . ($count + 1) . '. <strong>' . esc_html($category['categoryName']) . '</strong> (ID: ' . esc_html($category['categoryId']) . ')</p>';
                        $count++;
                    }
                }

                echo '<h4>æŸ¥æ‰¾å®¶å…·ç›¸å…³åˆ†ç±»:</h4>';
                $found_categories = [];
                foreach ($result['payload'] as $category) {
                    if (isset($category['categoryName'])) {
                        $name = $category['categoryName'];
                        if (stripos($name, 'furniture') !== false ||
                            stripos($name, 'home') !== false ||
                            stripos($name, 'dining') !== false ||
                            stripos($name, 'kitchen') !== false ||
                            stripos($name, 'decor') !== false ||
                            stripos($name, 'living') !== false ||
                            stripos($name, 'bedroom') !== false ||
                            stripos($name, 'table') !== false) {

                            $found_categories[] = $category;
                            echo '<p>âœ… <strong>' . esc_html($name) . '</strong> (ID: ' . esc_html($category['categoryId']) . ')</p>';
                        }
                    }
                }

                if (empty($found_categories)) {
                    echo '<p>æ²¡æœ‰æ‰¾åˆ°æ˜æ˜¾çš„å®¶å…·ç›¸å…³åˆ†ç±»ã€‚è®©æˆ‘ä»¬æŸ¥çœ‹æ‰€æœ‰åˆ†ç±»åç§°ï¼š</p>';
                    echo '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">';
                    foreach ($result['payload'] as $category) {
                        if (isset($category['categoryName'])) {
                            echo '<p>' . esc_html($category['categoryName']) . ' (ID: ' . esc_html($category['categoryId']) . ')</p>';
                        }
                    }
                    echo '</div>';
                }
            } else {
                echo '<h4>å®Œæ•´ç»“æœ:</h4>';
                echo '<pre style="max-height: 400px; overflow-y: auto;">' . esc_html(print_r($result, true)) . '</pre>';
            }
        }
        echo '</div>';
    }

    // å¤„ç†ä¿®å¤æ˜ å°„æ•°æ®
    if (isset($_GET['action']) && $_GET['action'] === 'fix_mapping_data') {
        check_admin_referer('fix_mapping_data_nonce');

        // è·å–æ‰€æœ‰æ˜ å°„æ•°æ®
        $all_mappings = $wpdb->get_results("SELECT * FROM $map_table");
        $fixed_count = 0;

        foreach ($all_mappings as $mapping) {
            if (!empty($mapping->walmart_attributes)) {
                $attributes = json_decode($mapping->walmart_attributes, true);

                if (is_array($attributes) && isset($attributes['name'], $attributes['type'], $attributes['source'])) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç´¢å¼•é”™ä½é—®é¢˜
                    $name_count = count($attributes['name']);
                    $type_count = count($attributes['type']);
                    $source_count = count($attributes['source']);

                    // å¦‚æœæ•°ç»„é•¿åº¦ä¸ä¸€è‡´ï¼Œå°è¯•ä¿®å¤
                    if ($name_count !== $type_count || $name_count !== $source_count) {
                        woo_walmart_sync_log('æ•°æ®ä¿®å¤', 'å‘ç°é—®é¢˜', [
                            'wc_category_id' => $mapping->wc_category_id,
                            'name_count' => $name_count,
                            'type_count' => $type_count,
                            'source_count' => $source_count,
                            'original_data' => $attributes
                        ], 'å‘ç°æ•°ç»„é•¿åº¦ä¸ä¸€è‡´');

                        // é‡æ–°æ„å»ºæ•°æ®ï¼Œç¡®ä¿æ•°ç»„é•¿åº¦ä¸€è‡´ï¼Œç§»é™¤ç©ºçš„å±æ€§å
                        $fixed_attributes = ['name' => [], 'type' => [], 'source' => []];

                        for ($i = 0; $i < $name_count; $i++) {
                            $attr_name = isset($attributes['name'][$i]) ? trim($attributes['name'][$i]) : '';
                            if (!empty($attr_name)) {
                                $fixed_attributes['name'][] = $attr_name;
                                $fixed_attributes['type'][] = isset($attributes['type'][$i]) ? $attributes['type'][$i] : 'default_value';
                                $fixed_attributes['source'][] = isset($attributes['source'][$i]) ? $attributes['source'][$i] : '';
                            }
                        }

                        // æ›´æ–°æ•°æ®åº“
                        $wpdb->update(
                            $map_table,
                            ['walmart_attributes' => wp_json_encode($fixed_attributes, JSON_UNESCAPED_UNICODE)],
                            ['id' => $mapping->id]
                        );

                        woo_walmart_sync_log('æ•°æ®ä¿®å¤', 'ä¿®å¤å®Œæˆ', [
                            'wc_category_id' => $mapping->wc_category_id,
                            'fixed_data' => $fixed_attributes
                        ], 'æ•°æ®ä¿®å¤å®Œæˆ');

                        $fixed_count++;
                    }
                }
            }
        }

        echo '<div class="updated"><p>æ•°æ®ä¿®å¤å®Œæˆï¼ä¿®å¤äº† ' . $fixed_count . ' ä¸ªåˆ†ç±»çš„æ˜ å°„æ•°æ®ã€‚</p></div>';
    }

    // ä»æ•°æ®åº“è·å–å·²ä¿å­˜çš„æ˜ å°„
    $saved_mappings = $wpdb->get_results("SELECT wc_category_id, walmart_category_path, walmart_attributes FROM $map_table", OBJECT_K);

    // ä»æ•°æ®åº“è·å–æ²ƒå°”ç›åˆ†ç±»æ•°æ®
    $walmart_categories = woo_walmart_get_categories_for_mapping();
    
    // è·å–æ‰€æœ‰WooCommerceå•†å“åˆ†ç±»å’Œå±æ€§
    $wc_categories = get_terms(['taxonomy' => 'product_cat', 'hide_empty' => false]);
    $wc_attributes = array_map('wc_attribute_label', array_keys(wc_get_attribute_taxonomies()));
    
    ?>
    <div class="wrap">
        <h1>Walmartåˆ†ç±»æ˜ å°„ç®¡ç†</h1>
    <style>
        /* å¼ºåˆ¶ä¿®å¤WordPressåå°å¸ƒå±€æº¢å‡ºé—®é¢˜ */
        body.wp-admin {
            overflow-x: hidden !important;
        }

        #wpbody-content {
            overflow-x: hidden !important;
        }

        /* ç›´æ¥ä¿®å¤è¿™ä¸ªé¡µé¢çš„å¸ƒå±€é—®é¢˜ */
        .wp-admin .wrap {
            margin-right: 20px !important;
            max-width: none !important;
            width: auto !important;
        }

        #wpbody {
            overflow-x: hidden !important;
        }

        #wpcontent {
            overflow-x: hidden !important;
        }
        /* åˆ†ç±»æ˜ å°„é¡µé¢æ•´ä½“æ ·å¼ - ç²¾ç¡®ä¿®å¤ */
        .category-mapping-container {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
            position: relative !important;
            left: 0 !important;
            right: 0 !important;
        }

        /* ç¡®ä¿æ‰€æœ‰å­å…ƒç´ éƒ½ä¸ä¼šæº¢å‡º */
        .category-mapping-container * {
            box-sizing: border-box !important;
        }

        /* åˆ†ç±»æ˜ å°„é¡µé¢ä¸“ç”¨æ ·å¼ - é˜²æ­¢æº¢å‡º */
        .category-mapping-page-wrap {
            contain: layout !important;
            isolation: isolate !important;
        }

        .category-mapping-page-wrap .category-mapping-container {
            contain: layout !important;
            max-width: 100% !important;
            overflow: hidden !important;
        }

        /* ğŸ”¥ æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼šç»å¯¹ç»Ÿä¸€çš„åˆ†ç±»æ ·å¼ */

        /* å¼ºåˆ¶é‡ç½®æ‰€æœ‰åˆ†ç±»å®¹å™¨ */
        .walmart-category-group,
        .unmapped-categories-section,
        div.walmart-category-group,
        div.unmapped-categories-section {
            /* å°ºå¯¸ç»Ÿä¸€ */
            width: 100% !important;
            max-width: 100% !important;
            min-width: 0 !important;

            /* ä½ç½®ç»Ÿä¸€ */
            margin: 0 0 20px 0 !important;
            padding: 0 !important;
            left: 0 !important;
            right: 0 !important;
            top: auto !important;
            bottom: auto !important;

            /* å¸ƒå±€ç»Ÿä¸€ */
            position: relative !important;
            display: block !important;
            float: none !important;
            clear: both !important;
            transform: none !important;

            /* å¤–è§‚ç»Ÿä¸€ */
            box-sizing: border-box !important;
            overflow: hidden !important;
            border-radius: 8px !important;
            background: #fff !important;
        }

        /* è¾¹æ¡†åŒºåˆ† - å”¯ä¸€çš„è§†è§‰å·®å¼‚ */
        .walmart-category-group,
        div.walmart-category-group {
            border: 2px solid #007cba !important;
        }

        .unmapped-categories-section,
        div.unmapped-categories-section {
            border: 1px solid #ddd !important;
        }

        /* ä¸»å®¹å™¨ */
        .category-mapping-page-wrap {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 20px 0 0 !important;
            padding: 20px !important;
            box-sizing: border-box !important;
            overflow-x: hidden !important;
        }

        /* å¼ºåˆ¶è¦†ç›–ä»»ä½•å†…è”æ ·å¼ */
        .walmart-category-group[style],
        .unmapped-categories-section[style],
        div.walmart-category-group[style],
        div.unmapped-categories-section[style] {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 0 20px 0 !important;
            padding: 0 !important;
            left: 0 !important;
            right: 0 !important;
            transform: none !important;
        }

        /* ğŸ”¥ å­å…ƒç´ æ ·å¼ - æ›¿ä»£å†…è”æ ·å¼ */
        .walmart-category-group-header {
            background: #007cba !important;
            color: white !important;
            padding: 15px 20px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .walmart-category-group-header h3 {
            margin: 0 !important;
            color: white !important;
            font-size: 16px !important;
        }

        .category-info {
            font-size: 12px !important;
            opacity: 0.9 !important;
            margin-top: 4px !important;
        }

        .walmart-category-group-header .add-local-category-btn {
            background: rgba(255,255,255,0.2) !important;
            border-color: rgba(255,255,255,0.3) !important;
            color: white !important;
        }

        .walmart-category-group-header .dashicons {
            font-size: 12px !important;
            line-height: 1 !important;
        }

        .walmart-category-group-content {
            background: #f8f9fa !important;
        }

        .shared-mapping-categories {
            padding: 15px 20px !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .shared-category-item {
            display: flex !important;
            align-items: center !important;
            padding: 10px 15px !important;
            margin-bottom: 8px !important;
            background: white !important;
            border-radius: 6px !important;
            border: 1px solid #ddd !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .category-basic-info {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            width: 22% !important;
        }

        .category-details {
            flex: 1 !important;
            min-width: 0 !important;
        }

        .category-details h4 {
            margin: 0 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #1d2327 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .category-meta {
            font-size: 12px !important;
            color: #646970 !important;
            margin-top: 2px !important;
        }

        /* ğŸ”¥ ç»ˆæå†…è”æ ·å¼è¦†ç›– - å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å¯èƒ½å½±å“å¸ƒå±€çš„å†…è”æ ·å¼ */
        .walmart-category-group *[style],
        .unmapped-categories-section *[style],
        .category-row *[style] {
            /* é‡ç½®æ‰€æœ‰å¯èƒ½å½±å“å®¹å™¨å°ºå¯¸çš„å±æ€§ */
            width: auto !important;
            max-width: none !important;
            min-width: 0 !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            padding-left: inherit !important;
            padding-right: inherit !important;
            left: auto !important;
            right: auto !important;
            transform: none !important;
            position: static !important;
        }

        /* ç‰¹åˆ«å¼ºåˆ¶ä¸»å®¹å™¨å…ƒç´  */
        .walmart-category-group[style],
        .unmapped-categories-section[style],
        .category-row[style] {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 0 20px 0 !important;
            padding: 0 !important;
            left: 0 !important;
            right: 0 !important;
            transform: none !important;
            position: relative !important;
            box-sizing: border-box !important;
        }

        /* ğŸ”¥ ç»ˆæå¼ºåˆ¶é‡ç½® - è¦†ç›–æ‰€æœ‰å¯èƒ½çš„å†…è”æ ·å¼ */
        .category-mapping-page-wrap *[style*="margin-left"],
        .category-mapping-page-wrap *[style*="width"],
        .category-mapping-page-wrap *[style*="max-width"],
        .category-mapping-page-wrap *[style*="position"],
        .category-mapping-page-wrap *[style*="left"],
        .category-mapping-page-wrap *[style*="right"],
        .category-mapping-page-wrap *[style*="transform"] {
            margin-left: 0 !important;
            width: auto !important;
            max-width: 100% !important;
            position: static !important;
            left: auto !important;
            right: auto !important;
            transform: none !important;
        }

        /* ğŸš€ ç»ˆæè§£å†³æ–¹æ¡ˆï¼šå¼ºåˆ¶æ‰€æœ‰åˆ†ç±»å®¹å™¨ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å›ºå®šå®½åº¦ */
        .walmart-category-group,
        .unmapped-categories-section,
        div.walmart-category-group,
        div.unmapped-categories-section,
        .category-mapping-page-wrap .walmart-category-group,
        .category-mapping-page-wrap .unmapped-categories-section,
        body .walmart-category-group,
        body .unmapped-categories-section,
        html .walmart-category-group,
        html .unmapped-categories-section,
        form .walmart-category-group,
        form .unmapped-categories-section {
            /* ğŸ”¥ æœ€å¼ºåŠ›é‡ç½® */
            all: unset !important;

            /* ğŸ¯ å¼ºåˆ¶ç»Ÿä¸€å›ºå®šå®½åº¦å’Œä½ç½® - å®Œå…¨ä¸ä¾èµ–çˆ¶å®¹å™¨ */
            display: block !important;
            width: 1600px !important;
            max-width: 1600px !important;
            min-width: 1600px !important;
            margin: 0 0 20px 0 !important;  /* é‡ç½®è¾¹è· */
            padding: 0 !important;
            box-sizing: border-box !important;
            overflow: hidden !important;
            border-radius: 8px !important;
            background: #fff !important;
            position: relative !important;
            left: 200px !important;  /* å¼ºåˆ¶å·¦åç§»200px */
            right: auto !important;
            top: auto !important;
            bottom: auto !important;
            transform: none !important;
            float: none !important;
            clear: both !important;

            /* ğŸ”’ é˜²æ­¢ä»»ä½•å¯èƒ½çš„å®½åº¦å˜åŒ– */
            flex: none !important;
            flex-basis: auto !important;
            flex-grow: 0 !important;
            flex-shrink: 0 !important;
        }

        /* é‡æ–°åº”ç”¨è¾¹æ¡†åŒºåˆ† */
        .walmart-category-group,
        div.walmart-category-group,
        .category-mapping-page-wrap .walmart-category-group {
            border: 2px solid #007cba !important;
        }

        .unmapped-categories-section,
        div.unmapped-categories-section,
        .category-mapping-page-wrap .unmapped-categories-section {
            border: 1px solid #ddd !important;
        }

        /* ğŸ”¥ å¼ºåˆ¶æ‰€æœ‰å­å…ƒç´ ä¸å½±å“çˆ¶å®¹å™¨å®½åº¦ */
        .walmart-category-group *,
        .unmapped-categories-section * {
            max-width: 100% !important;
            box-sizing: border-box !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }

        /* ğŸ¯ ç‰¹åˆ«å¤„ç†å¯èƒ½å¯¼è‡´å®½åº¦é—®é¢˜çš„å…ƒç´  */
        .walmart-category-group table,
        .unmapped-categories-section table,
        .walmart-category-group .attribute-mapper,
        .unmapped-categories-section .attribute-mapper {
            width: 100% !important;
            max-width: 100% !important;
            table-layout: fixed !important;
        }

        /* ç¡®ä¿æ‰€æœ‰å­å…ƒç´ ä¹Ÿä¸ä¼šæº¢å‡º */
        body.wp-admin .category-mapping-page-wrap * {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* ç‰¹åˆ«å¤„ç†å†…è”æ ·å¼ */
        body.wp-admin div[style*="margin-left: 160px"],
        body.wp-admin div[style*="margin-left: 180px"],
        body.wp-admin div[style*="margin-left: 200px"],
        body.wp-admin h3[style*="margin-left"] {
            margin-left: 0 !important;
            padding-left: 0 !important;
        }

        /* å¼ºåˆ¶è¦†ç›–wrapå®¹å™¨çš„æ ·å¼ */
        body.wp-admin .category-mapping-page-wrap.wrap {
            margin-left: 0 !important;
            margin-right: 20px !important;
            max-width: calc(100% - 40px) !important;
            width: calc(100% - 40px) !important;
        }

        /* ç¡®ä¿åœ¨WordPressåå°æ¡†æ¶å†…æ­£ç¡®æ˜¾ç¤º */
        body.wp-admin #wpbody-content .wrap.category-mapping-page-wrap {
            margin-left: 0 !important;
            margin-right: 20px !important;
            padding: 20px !important;
            max-width: calc(100% - 40px) !important;
            width: calc(100% - 40px) !important;
            box-sizing: border-box !important;
        }

        /* é˜²æ­¢ä»»ä½•å…ƒç´ è¶…å‡ºwpbody-contentçš„è¾¹ç•Œ */
        body.wp-admin #wpbody-content {
            overflow-x: hidden !important;
        }

        /* åˆ†ç±»è¡Œæ ·å¼ */
        .category-row {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            background: #fff !important;
            margin: 0 0 20px 0 !important;
            border: 1px solid #e1e5e9 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
        }

        .category-row:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
            border-color: #007cba !important;
        }

        .category-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-info {
            flex: 1;
        }

        .category-title {
            font-size: 16px;
            font-weight: 600;
            color: #1d2327;
            margin: 0 0 5px 0;
        }

        .category-meta {
            font-size: 13px;
            color: #646970;
        }

        .walmart-category-section {
            padding: 0 20px 20px 20px;
        }

        .walmart-category-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: #1d2327;
        }

        .walmart-category-selector {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #8c8f94;
            border-radius: 4px;
            font-size: 14px;
        }

        /* å±æ€§æ˜ å°„åŒºåŸŸæ ·å¼ */
        .attribute-mapper {
            margin-top: 20px;
            border-top: 1px solid #f0f0f1;
            padding-top: 20px;
        }

        .attribute-mapper-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 20px;
        }

        .attribute-mapper-title {
            font-size: 14px;
            font-weight: 600;
            color: #1d2327;
            margin: 0;
        }

        .attribute-controls {
            display: flex;
            gap: 8px;
			margin-left: 0;
            align-items: center;
        }

        .toggle-attributes-btn {
            background: #f6f7f7;
            border: 1px solid #dcdcde;
            color: #2c3338;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-attributes-btn:hover {
            background: #f0f0f1;
            border-color: #8c8f94;
        }

        .toggle-attributes-btn.expanded {
            background: #007cba;
            color: white;
            border-color: #005a87;
        }

        /* å±æ€§è¡¨æ ¼æ ·å¼ */
        .attributes-container {
            margin: 0 0 20px 0;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #dcdcde;
            display: none; /* é»˜è®¤éšè— */
            width: 100% !important; /* å›ºå®šå®½åº¦ï¼Œå‡å»å·¦å³margin */
            table-layout: fixed !important; /* å›ºå®šè¡¨æ ¼å¸ƒå±€ */
        }

        /* å¼ºåˆ¶åº”ç”¨åˆ—å®½ */
        .attributes-container th {
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        .attributes-container.expanded {
            display: table;
        }

        .attributes-container th,
        .attributes-container td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f1;
            text-align: left;
        }

        .attributes-container th {
            background: #f6f7f7;
            font-weight: 600;
            color: #1d2327;
            font-size: 13px;
        }

        .attributes-container tbody tr:hover {
            background: #f9f9f9;
        }

        /* å•ä¸ªä¿å­˜æŒ‰é’®æ ·å¼ */
        .individual-save-section {
            padding: 15px 20px;
            background: #f9f9f9;
            border-top: 1px solid #f0f0f1;
            border-radius: 0 0 8px 8px;
            display: none;
        }

        .individual-save-section.show {
            display: block;
        }

        .individual-save-btn {
            background: #00a32a;
            border-color: #00a32a;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .individual-save-btn:hover {
            background: #008a20;
            border-color: #008a20;
        }

        .individual-save-btn:disabled {
            background: #dcdcde;
            border-color: #dcdcde;
            color: #646970;
            cursor: not-allowed;
        }

        /* æ“ä½œæŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .add-attribute-row {
            margin: 15px 0 0 0 !important;
            background: #f6f7f7;
			margin-left: 15px !important; 
            border: 1px dashed #8c8f94;
            color: #2c3338;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-attribute-row:hover {
            background: #f0f0f1;
            border-color: #646970;
        }

        .attribute-mapper .walmart-attr-name { font-weight: bold; }
        .attribute-mapper .is-required { color: #d63638; font-weight: bold; }

        /* å¤‡æ³¨åˆ—æ ·å¼ */
        .description-cell {
            padding: 8px 12px !important;
            background-color: #f8f9fa;
            border-left: 3px solid #e9ecef;
        }

        .description-cell span {
            display: block;
            font-size: 12px !important;
            color: #6c757d !important;
            line-height: 1.4 !important;
            word-wrap: break-word;
            max-width: 200px;
        }

        .batch-description-cell {
            padding: 8px 12px !important;
            background-color: #f8f9fa;
            border-left: 3px solid #e9ecef;
        }

        /* ç§»é™¤å“åº”å¼CSS - ä¿æŒå›ºå®šå°ºå¯¸ */

            .individual-save-btn {
                width: auto;  /* æ”¹ä¸ºè‡ªåŠ¨å®½åº¦ï¼Œä¸å æ»¡æ•´ä¸ªå®¹å™¨ */
                min-width: 120px;  /* è®¾ç½®æœ€å°å®½åº¦ç¡®ä¿æŒ‰é’®ä¸ä¼šå¤ªå° */
                justify-content: center;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .attributes-container {
            transition: all 0.3s ease;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }

        .attributes-container.expanded {
            opacity: 1;
            max-height: 1000px;
        }

        .individual-save-section {
            transition: all 0.3s ease;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }

        .individual-save-section.show {
            opacity: 1;
            max-height: 100px;
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        /* æ”¹è¿›çš„æŒ‰é’®æ ·å¼ */
        .button-small {
            padding: 4px 8px;
            font-size: 12px;
            line-height: 1.4;
        }

        .dashicons {
            font-size: 16px;
            width: 16px;
            height: 16px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .mapping-status {
            display: inline-block;
            margin-left: 8px;
        }

        /* æ”¹è¿›çš„è¡¨æ ¼æ ·å¼ */
        .attributes-container input,
        .attributes-container select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #8c8f94;
            border-radius: 3px;
            font-size: 13px;
        }

        .attributes-container input:focus,
        .attributes-container select:focus {
            border-color: #007cba;
            box-shadow: 0 0 0 1px #007cba;
            outline: none;
        }



        /* Walmartåˆ†ç±»æ ‘å½¢é€‰æ‹©å™¨æ ·å¼ */
        .walmart-category-tree-selector {
            position: relative;
            width: 100%;
        }

        .category-selector-display {
            border: 1px solid #ddd;
            padding: 8px 12px;
            background: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            min-height: 20px;
        }

        .category-selector-display:hover {
            border-color: #999;
        }

        .category-selector-display.active {
            border-color: #0073aa;
            box-shadow: 0 0 0 1px #0073aa;
        }

        .selected-category {
            flex: 1;
            color: #333;
        }

        .dropdown-arrow {
            color: #666;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .category-selector-display.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .category-tree-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 400px;
            overflow: hidden;
        }

        .category-search {
            padding: 10px;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .category-search-input {
            width: 100%;
            padding: 6px 30px 6px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }

        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 14px;
        }

        .category-tree-container {
            max-height: 320px;
            overflow-y: auto;
        }

        .category-tree-item {
            padding: 6px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
        }

        .category-tree-item:hover {
            background: #f8f9fa;
        }

        .category-tree-item.selected {
            background: #e3f2fd;
            color: #1976d2;
        }

        .category-tree-item .expand-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
        }

        .category-tree-item .expand-icon:hover {
            color: #333;
        }

        .category-tree-item.level-0 {
            font-weight: 600;
            background: #f8f9fa;
        }

        .category-tree-item.level-1 {
            padding-left: 25px;
            font-size: 13px;
        }

        .category-tree-item.level-2 {
            padding-left: 40px;
            font-size: 12px;
            color: #666;
        }

        .category-tree-item .category-name {
            flex: 1;
        }

        .category-tree-item .category-count {
            font-size: 11px;
            color: #999;
            margin-left: 10px;
        }

        .loading {
            padding: 20px;
            text-align: center;
            color: #666;
        }

        .batch-attributes-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .batch-attributes-table th,
        .batch-attributes-table td {
            padding: 8px 10px;
            border: 1px solid #dee2e6;
            text-align: left;
        }

        .batch-attributes-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
        }

        .batch-attributes-table input,
        .batch-attributes-table select {
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 13px;
        }

        .batch-actions {
            border-top: 1px solid #dee2e6;
            padding-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #batch-save-btn {
            background: #007cba;
            border-color: #007cba;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
        }

        #batch-save-btn:disabled {
            background: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }

        #selected-count {
            font-weight: 500;
            font-size: 14px;
        }

        /* è¡¨æ ¼å¤é€‰æ¡†æ ·å¼ */
        .check-column {
            width: 40px;
            text-align: center;
        }

        .category-checkbox {
            transform: scale(1.2);
        }

        #select-all-categories {
            transform: scale(1.2);
        }

        /* æ–°å¢æœ¬åœ°ç±»ç›®å¼¹çª—æ ·å¼ - é€‚é…WordPressåå°æ¡†æ¶ */
        .local-category-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç¡®ä¿å¼¹çª—åœ¨WordPressåå°ä¸­æ­£ç¡®æ˜¾ç¤º */
        body.wp-admin .local-category-modal-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 999999 !important;
        }

        .local-category-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .local-category-modal-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .local-category-modal-header h3 {
            margin: 0;
            color: #1d2327;
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 90px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #333;
        }

        .local-category-modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .local-category-list {
            margin-top: 15px;
        }

        .local-category-checkboxes {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .local-category-checkboxes.hierarchical {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .local-category-item {
            display: block;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f1;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .local-category-item:last-child {
            border-bottom: none;
        }

        .local-category-item:hover {
            background-color: #f8f9fa;
            border-left: 3px solid #007cba;
        }

        .local-category-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            vertical-align: top;
            margin-top: 3px;
        }

        .local-category-item .category-content {
            display: inline-block;
            width: calc(100% - 30px);
            vertical-align: top;
        }

        .local-category-item .hierarchy-indicator {
            color: #8c8f94;
            font-size: 12px;
            margin-right: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre;
            display: inline-block;
            min-width: 20px;
        }

        .local-category-item .category-path {
            color: #646970;
            font-size: 11px;
            font-weight: normal;
            margin-right: 4px;
        }

        .local-category-item .category-name {
            font-weight: 600;
            color: #1d2327;
            font-size: 14px;
        }

        .local-category-item .category-meta {
            display: block;
            font-size: 11px;
            color: #8c8f94;
            margin-top: 4px;
            font-style: italic;
        }

        /* ä¸åŒå±‚çº§çš„æ ·å¼ */
        .local-category-item.level-0 {
            background-color: #f8f9fa;
            border-left: 3px solid #007cba;
        }

        .local-category-item.level-1 {
            background-color: #fbfbfb;
            border-left: 3px solid #28a745;
        }

        .local-category-item.level-2 {
            background-color: #fdfdfd;
            border-left: 3px solid #ffc107;
        }

        .local-category-item.level-0:hover {
            background-color: #e9ecef;
            border-left-color: #005a87;
        }

        .local-category-item.level-1:hover {
            background-color: #f1f3f4;
            border-left-color: #1e7e34;
        }

        .local-category-item.level-2:hover {
            background-color: #f8f9fa;
            border-left-color: #e0a800;
        }

        /* å±‚çº§ç¼©è¿› */
        .local-category-item.level-0 .category-name {
            font-size: 15px;
            font-weight: 700;
        }

        .local-category-item.level-1 .category-name {
            font-size: 14px;
            font-weight: 600;
        }

        .local-category-item.level-2 .category-name {
            font-size: 13px;
            font-weight: 500;
        }

        .local-category-modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f8f9fa;
        }

        .loading, .no-categories, .error {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            color: #d63638;
        }


            }

            .local-category-modal {
                width: 95%;
                max-height: 90vh;
            }

            .local-category-modal-header,
            .local-category-modal-body,
            .local-category-modal-footer {
                padding: 15px;
            }
        }
    </style>
    </div> <!-- å…³é—­ç¬¬5621è¡Œçš„wrapå®¹å™¨ -->

    <div class="wrap category-mapping-page-wrap">
        <h1>åˆ†ç±»æ˜ å°„</h1>
        <p>å°†æ‚¨çš„WooCommerceåˆ†ç±»ä¸æ²ƒå°”ç›åˆ†ç±»åŒ¹é…ã€‚é€‰æ‹©åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŠ è½½V5.0è§„èŒƒå±æ€§ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ·»åŠ æ›´å¤šå±æ€§ã€‚</p>



        <a href="<?php echo esc_url(wp_nonce_url(admin_url('admin.php?page=woo-walmart-category-mapping&action=fetch_walmart_categories'), 'fetch_walmart_categories_nonce')); ?>" class="button button-primary">
            ä»æ²ƒå°”ç›æ›´æ–°åˆ†ç±»åˆ—è¡¨ (5.0)
        </a>
        <a href="<?php echo esc_url(wp_nonce_url(admin_url('admin.php?page=woo-walmart-category-mapping&action=fetch_ca_categories'), 'fetch_ca_categories_nonce')); ?>" class="button button-primary" style="margin-left: 10px;">
            ä»è§„èŒƒæ–‡ä»¶æ›´æ–°åˆ†ç±»åˆ—è¡¨ï¼ˆåŠ æ‹¿å¤§ 3.16ï¼‰
        </a>
        <a href="<?php echo esc_url(wp_nonce_url(admin_url('admin.php?page=woo-walmart-category-mapping&action=fix_mapping_data'), 'fix_mapping_data_nonce')); ?>" class="button button-secondary" style="margin-left: 10px;" onclick="return confirm('è¿™å°†ä¿®å¤æ•°æ®ç´¢å¼•é”™ä½é—®é¢˜ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')">
            ä¿®å¤æ˜ å°„æ•°æ®
        </a>

        <hr/>


        
        <!-- å•ä¸ªæ˜ å°„è¡¨å• -->
        <div class="category-mapping-container">
            <form method="post" id="individual-mapping-form">
                <input type="hidden" name="action" value="save_mapping">
                <?php wp_nonce_field('walmart_category_map_save'); ?>

                <!-- å±æ€§æ§åˆ¶æ  -->
                <div class="attributes-control-bar" style="background: #f6f7f7; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dcdcde;">
                    <div style="display: flex; align-items: center; justify-content: flex-end;">
                        <div>
                            <button type="button" id="expand-all-attributes" class="button button-secondary">
                                <span class="dashicons dashicons-arrow-down-alt2"></span> å±•å¼€æ‰€æœ‰å±æ€§
                            </button>
                            <button type="button" id="collapse-all-attributes" class="button button-secondary" style="margin-left: 8px;">
                                <span class="dashicons dashicons-arrow-up-alt2"></span> æ”¶ç¼©æ‰€æœ‰å±æ€§
                            </button>
                        </div>
                    </div>
                </div>

                <!-- åˆ†ç±»æ˜ å°„åˆ—è¡¨ -->
                <?php
                // ğŸ”§ ä¿®å¤åˆ†ç»„é€»è¾‘ï¼šæ­£ç¡®å¤„ç†å…±äº«æ˜ å°„ï¼Œé¿å…åˆ†ç±»åˆ†è£‚
                $grouped_categories = [];
                $unmapped_categories = [];

                // è·å–æ‰€æœ‰æ˜ å°„è®°å½•
                global $wpdb;
                $map_table = $wpdb->prefix . 'walmart_category_map';
                $all_mappings = $wpdb->get_results("SELECT * FROM $map_table");

                // ğŸ¯ å…³é”®ä¿®å¤ï¼šç›´æ¥æŒ‰æ˜ å°„è®°å½•åˆ†ç»„ï¼Œè€Œä¸æ˜¯æŒ‰æœ¬åœ°åˆ†ç±»
                foreach ($all_mappings as $mapping) {
                    $walmart_cat = $mapping->walmart_category_path;

                    // è·å–è¯¥æ˜ å°„è®°å½•å¯¹åº”çš„æ‰€æœ‰æœ¬åœ°åˆ†ç±»
                    $local_category_ids = [];
                    if (!empty($mapping->local_category_ids)) {
                        $local_category_ids = json_decode($mapping->local_category_ids, true) ?: [];
                    } else {
                        // å…¼å®¹æ—§æ•°æ®
                        $local_category_ids = [$mapping->wc_category_id];
                    }

                    // è·å–è¿™äº›IDå¯¹åº”çš„å®é™…åˆ†ç±»å¯¹è±¡
                    $local_categories = [];
                    foreach ($wc_categories as $wc_cat) {
                        if (in_array($wc_cat->term_id, $local_category_ids)) {
                            $local_categories[] = $wc_cat;
                        }
                    }

                    // åªæœ‰å½“æœ‰å®é™…åˆ†ç±»æ—¶æ‰åˆ›å»ºåˆ†ç»„
                    if (!empty($local_categories)) {
                        // ğŸ”¥ å…³é”®ï¼šç¡®ä¿æ¯ä¸ªWalmartåˆ†ç±»åªæœ‰ä¸€ä¸ªåˆ†ç»„
                        if (!isset($grouped_categories[$walmart_cat])) {
                            $grouped_categories[$walmart_cat] = [
                                'mapping' => $mapping,
                                'local_categories' => []
                            ];
                        }

                        // å°†æ‰€æœ‰æœ¬åœ°åˆ†ç±»æ·»åŠ åˆ°åŒä¸€ä¸ªåˆ†ç»„
                        $grouped_categories[$walmart_cat]['local_categories'] = array_merge(
                            $grouped_categories[$walmart_cat]['local_categories'],
                            $local_categories
                        );
                    }
                }

                // æ‰¾å‡ºæœªæ˜ å°„çš„åˆ†ç±»
                $mapped_category_ids = [];
                foreach ($all_mappings as $mapping) {
                    if (!empty($mapping->local_category_ids)) {
                        $local_ids = json_decode($mapping->local_category_ids, true) ?: [];
                        $mapped_category_ids = array_merge($mapped_category_ids, $local_ids);
                    } else {
                        $mapped_category_ids[] = $mapping->wc_category_id;
                    }
                }

                foreach ($wc_categories as $wc_cat) {
                    if (!in_array($wc_cat->term_id, $mapped_category_ids)) {
                        $unmapped_categories[] = $wc_cat;
                    }
                }

                // å…ˆæ˜¾ç¤ºå·²æ˜ å°„çš„åˆ†ç»„
                foreach ($grouped_categories as $walmart_cat => $group_data) :
                    $mapping = $group_data['mapping'];
                    $local_cats = $group_data['local_categories'];

                    // è·å–Walmartåˆ†ç±»åç§°
                    $walmart_cat_name = '';
                    if (!empty($walmart_categories)) {
                        foreach ($walmart_categories as $wm_cat) {
                            if ($wm_cat['categoryId'] === $walmart_cat) {
                                $walmart_cat_name = $wm_cat['categoryName'];
                                break;
                            }
                        }
                    }
                    $walmart_cat_name = $walmart_cat_name ?: $walmart_cat;

                    // è·å–å…±äº«æ˜ å°„çš„æ‰€æœ‰æœ¬åœ°åˆ†ç±»ID
                    $all_local_ids = [];
                    if (!empty($mapping->local_category_ids)) {
                        $all_local_ids = json_decode($mapping->local_category_ids, true) ?: [];
                    } else {
                        $all_local_ids = [$mapping->wc_category_id];
                    }
                ?>
                    <!-- Walmartåˆ†ç±»åˆ†ç»„ -->
                    <div class="walmart-category-group">
                        <div class="walmart-category-group-header">
                            <div>
                                <h3>
                                    ğŸ“¦ Walmartåˆ†ç±»: <?php echo esc_html($walmart_cat_name); ?>
                                </h3>
                                <div class="category-info">
                                    åŒ…å« <?php echo count($all_local_ids); ?> ä¸ªæœ¬åœ°åˆ†ç±» (å…±äº«æ˜ å°„ID: <?php echo $mapping->id; ?>)
                                </div>
                            </div>
                            <button type="button" class="button button-secondary button-small add-local-category-btn"
                                    data-walmart-category="<?php echo esc_attr($walmart_cat); ?>"
                                    data-walmart-category-name="<?php echo esc_attr($walmart_cat_name); ?>">
                                <span class="dashicons dashicons-plus-alt2"></span>
                                æ–°å¢æœ¬åœ°ç±»ç›®
                            </button>
                        </div>

                        <div class="walmart-category-group-content">
                            <!-- å…±äº«æ˜ å°„ä¸­çš„æœ¬åœ°åˆ†ç±»åˆ—è¡¨ -->
                            <div class="shared-mapping-categories">
                                <?php foreach ($local_cats as $index => $wc_cat) : ?>
                                    <div class="shared-category-item">
                                        <div class="category-basic-info">
                                            <div class="category-details">
                                                <h4>
                                                    <?php echo esc_html($wc_cat->name); ?>
                                                </h4>
                                                <div class="category-meta">
                                                    ID: <?php echo $wc_cat->term_id; ?> | å•†å“æ•°: <?php echo $wc_cat->count; ?>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="width: 18%; text-align: center; color: #646970; font-size: 12px;">
                                            å…±äº«æ˜ å°„
                                        </div>
                                        <div style="width: 45%; text-align: center; color: #646970; font-size: 12px;">
                                            <?php echo esc_html($walmart_cat_name); ?>
                                        </div>
                                        <div style="width: 15%; display: flex; justify-content: center;">
                                            <button type="button" class="button button-small remove-from-shared-mapping-btn"
                                                    data-category-id="<?php echo $wc_cat->term_id; ?>"
                                                    data-category-name="<?php echo esc_attr($wc_cat->name); ?>"
                                                    data-mapping-id="<?php echo $mapping->id; ?>"
                                                    style="color: #d63638; border-color: #d63638; font-size: 11px; padding: 4px 8px;">
                                                <span class="dashicons dashicons-minus" style="font-size: 10px; line-height: 1;"></span>
                                                ç§»é™¤
                                            </button>
                                        </div>
                                    </div>
                                <?php endforeach; ?>
                            </div>

                            <!-- å…±äº«çš„å±æ€§æ˜ å°„é…ç½® -->
                            <?php
                            // ä½¿ç”¨å…±äº«æ˜ å°„çš„ä¿¡æ¯
                            $current_walmart_cat = $mapping->walmart_category_path;
                            $current_attributes = $mapping && !empty($mapping->walmart_attributes) ? json_decode($mapping->walmart_attributes, true) : ['name' => [], 'type' => [], 'source' => [], 'required_level' => [], 'group' => [], 'format' => [], 'enum_values' => []];
                            if (!is_array($current_attributes) || !isset($current_attributes['name'])) {
                               $current_attributes = ['name' => [], 'type' => [], 'source' => [], 'required_level' => [], 'group' => [], 'format' => [], 'enum_values' => []];
                            }

                            // é‡è¦ä¿®å¤ï¼šç¡®ä¿JSONè§£ç årequired_levelæ•°ç»„å­˜åœ¨ä¸”é•¿åº¦æ­£ç¡®
                            if (!isset($current_attributes['required_level']) || !is_array($current_attributes['required_level'])) {
                                $current_attributes['required_level'] = [];
                            }

                            // å…¼å®¹æ€§ä¿®å¤ï¼šç¡®ä¿enum_valuesæ•°ç»„å­˜åœ¨
                            if (!isset($current_attributes['enum_values']) || !is_array($current_attributes['enum_values'])) {
                                $current_attributes['enum_values'] = [];
                            }

                            // å¦‚æœrequired_levelæ•°ç»„é•¿åº¦ä¸åŒ¹é…ï¼Œç”¨ç©ºå­—ç¬¦ä¸²å¡«å……
                            $name_count = count($current_attributes['name']);
                            $required_level_count = count($current_attributes['required_level']);
                            if ($required_level_count < $name_count) {
                                $current_attributes['required_level'] = array_pad($current_attributes['required_level'], $name_count, '');
                            }

                            // ç¡®ä¿formatæ•°ç»„å­˜åœ¨ä¸”é•¿åº¦æ­£ç¡®
                            if (!isset($current_attributes['format'])) {
                                $current_attributes['format'] = [];
                            }
                            $format_count = count($current_attributes['format']);
                            if ($format_count < $name_count) {
                                $current_attributes['format'] = array_pad($current_attributes['format'], $name_count, '');
                            }

                            // ç¡®ä¿enum_valuesæ•°ç»„é•¿åº¦æ­£ç¡®
                            $enum_values_count = count($current_attributes['enum_values']);
                            if ($enum_values_count < $name_count) {
                                $current_attributes['enum_values'] = array_pad($current_attributes['enum_values'], $name_count, '');
                            }

                            // ç¡®ä¿enum_valuesæ•°ç»„å­˜åœ¨ä¸”é•¿åº¦æ­£ç¡®
                            if (!isset($current_attributes['enum_values'])) {
                                $current_attributes['enum_values'] = [];
                            }
                            $enum_values_count = count($current_attributes['enum_values']);
                            if ($enum_values_count < $name_count) {
                                $current_attributes['enum_values'] = array_pad($current_attributes['enum_values'], $name_count, '');
                            }

                            // ä½¿ç”¨ç¬¬ä¸€ä¸ªåˆ†ç±»çš„IDä½œä¸ºå…±äº«å±æ€§çš„æ ‡è¯†
                            $shared_category_id = $local_cats[0]->term_id;
                            ?>

                            <!-- å…±äº«å±æ€§æ˜ å°„åŒºåŸŸ -->
                            <div class="shared-attribute-mapper" style="padding: 0 20px 20px;">
                                <div class="attribute-mapper" data-wc-cat-id="<?php echo $shared_category_id; ?>">
                                    <!-- éšè—çš„åˆ†ç±»é€‰æ‹©å™¨ä¿¡æ¯ï¼Œä¾›JavaScriptä½¿ç”¨ -->
                                    <div class="walmart-category-tree-selector" style="display: none;">
                                        <input type="hidden" class="walmart-category-value" value="<?php echo esc_attr($current_walmart_cat); ?>">
                                        <span class="selected-category"><?php echo esc_html($walmart_cat_name); ?></span>
                                    </div>
                                    <!-- å…±äº«å±æ€§æ˜ å°„æ ‡é¢˜ -->
                                    <div class="attribute-mapper-header">
                                        <h4 class="attribute-mapper-title" style="margin: 15px 0 10px 0; font-size: 16px; color: #1d2327;">
                                            ğŸ”§ å…±äº«å±æ€§æ˜ å°„è§„åˆ™
                                            <?php if (!empty($current_attributes['name'])): ?>
                                                <span style="color: #646970; font-weight: normal; font-size: 13px;">
                                                    (å·²é…ç½® <?php echo count($current_attributes['name']); ?> ä¸ªå±æ€§)
                                                </span>
                                            <?php endif; ?>
                                        </h4>
                                        <div class="attribute-controls">
                                            <button type="button" class="toggle-attributes-btn" data-category-id="<?php echo $shared_category_id; ?>">
                                                <span class="dashicons dashicons-arrow-down-alt2"></span>
                                                <span class="btn-text">å±•å¼€å±æ€§</span>
                                            </button>
                                            <button type="button" class="button button-secondary button-small fetch-attributes-button" title="æ™ºèƒ½åŠ è½½ï¼šæ£€æµ‹åˆ†ç±»å˜æ›´ï¼Œè¯¢é—®æ˜¯å¦æ›¿æ¢ç°æœ‰å±æ€§">
                                                <span class="dashicons dashicons-download"></span>
                                                åŠ è½½V5.0è§„èŒƒ
                                            </button>
                                            <button type="button" class="button button-secondary button-small force-replace-attributes-button" title="æ¸…ç©ºç°æœ‰å±æ€§ï¼Œé‡æ–°åŠ è½½å®Œæ•´è§„èŒƒ">
                                                <span class="dashicons dashicons-update"></span> é‡ç½®å±æ€§
                                            </button>
                                            <button type="button" class="button button-secondary button-small clear-attributes-button" style="color: #d63638; border-color: #d63638;">
                                                <span class="dashicons dashicons-trash"></span> æ¸…é™¤å±æ€§
                                            </button>
                                            <button type="button" class="button button-secondary button-small debug-api-response-button">
                                                <span class="dashicons dashicons-search"></span> è°ƒè¯•API
                                            </button>
                                        </div>
                                    </div>
                                    <div style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-left: 3px solid #0073aa; font-size: 11px; <?php echo (!empty($current_attributes['name']) && count(array_filter($current_attributes['name'])) > 0) ? '' : 'display: none;'; ?>" class="required-level-info">
                                        <strong>V5.0å¿…å¡«çº§åˆ«ï¼š</strong>
                                        <span style="color: #dc3545;">â–  é€šç”¨å¿…å¡«</span> |
                                        <span style="color: #fd7e14;">â–  ç±»ç›®å¿…å¡«</span> |
                                        <span style="color: #198754;">â–  æ¨è</span>
                                    </div>
                                    <table class="attributes-container" id="attributes-table-<?php echo $shared_category_id; ?>">
                                <thead>
                                    <tr>
                                        <th style="width: 22% !important; max-width: 22% !important;">æ²ƒå°”ç›å±æ€§å</th>
                                        <th style="width: 9% !important; max-width: 9% !important;">æ˜ å°„ç±»å‹</th>
                                        <th style="width: 54% !important; max-width: 54% !important;">æ¥æº/å€¼</th>
                                        <th style="width: 15%; display: none;">æ•°æ®æ ¼å¼</th>
                                        <th style="width: 15%;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                            <?php
                                            // ç¡®ä¿æ‰€æœ‰æ•°ç»„é•¿åº¦ä¸€è‡´ï¼Œå¹¶ä¿®å¤ç´¢å¼•é”™ä½é—®é¢˜
                                            $name_count = count($current_attributes['name']);
                                            $type_count = count($current_attributes['type']);
                                            $source_count = count($current_attributes['source']);

                                            // ä½¿ç”¨nameæ•°ç»„çš„é•¿åº¦ä½œä¸ºåŸºå‡†
                                            $max_count = $name_count;

                                            for ($i = 0; $i < $max_count; $i++) :
                                                $current_name = isset($current_attributes['name'][$i]) ? $current_attributes['name'][$i] : '';
                                                $current_type = isset($current_attributes['type'][$i]) && !empty($current_attributes['type'][$i]) ? $current_attributes['type'][$i] : 'default_value';
                                                $current_source = isset($current_attributes['source'][$i]) ? $current_attributes['source'][$i] : '';
                                                $current_required_level = isset($current_attributes['required_level'][$i]) ? $current_attributes['required_level'][$i] : '';
                                                $current_group = isset($current_attributes['group'][$i]) ? $current_attributes['group'][$i] : '';
                                                // å¦‚æœæ²¡æœ‰è®¾ç½®æ ¼å¼ï¼Œä¿æŒä¸ºç©ºï¼ˆä¸è®¾ç½®é»˜è®¤å€¼ï¼‰ï¼Œè¿™æ ·å¯ä»¥ä¿æŒåŸæœ‰é€»è¾‘
                                                $current_format = isset($current_attributes['format'][$i]) ? $current_attributes['format'][$i] : '';




                                                // è·³è¿‡ç©ºçš„å±æ€§å
                                                if (empty($current_name)) {
                                                    continue;
                                                }
                                            ?>
                                                <tr>
                                                    <td>
                                                        <input type="text" name="attributes[<?php echo $shared_category_id; ?>][name][]" value="<?php echo esc_attr($current_name); ?>" placeholder="ä¾‹å¦‚: brand" class="attribute-name-input">
                                                        <input type="hidden" name="required_levels[<?php echo $shared_category_id; ?>][]" value="<?php echo esc_attr($current_required_level); ?>">
                                                        <input type="hidden" name="attribute_groups[<?php echo $shared_category_id; ?>][]" value="<?php echo esc_attr($current_group); ?>">
                                                        <?php
                                                        // æ˜¾ç¤ºå¿…å¡«çº§åˆ«æ ‡è¯† - æ”¯æŒæ–°çš„æ•°æ®æ ¼å¼
                                                        $show_mark = false;
                                                        $required_text = '';
                                                        $required_color = '';

                                                        // æ–°æ ¼å¼ï¼šä½¿ç”¨required_level=1/0å’Œgroupå­—æ®µ
                                                        if ($current_required_level === '1') {
                                                            $show_mark = true;
                                                            if ($current_group === 'Visible') {
                                                                $required_text = 'â–  ç±»ç›®å¿…å¡«';
                                                                $required_color = '#fd7e14';
                                                            } else {
                                                                $required_text = 'â–  é€šç”¨å¿…å¡«';
                                                                $required_color = '#dc3545';
                                                            }
                                                        }
                                                        // æ—§æ ¼å¼ï¼šä½¿ç”¨å­—ç¬¦ä¸²çº§åˆ«
                                                        elseif (!empty($current_required_level)) {
                                                            switch($current_required_level) {
                                                                case 'system':
                                                                case 'sell':
                                                                    $required_text = 'â–  é€šç”¨å¿…å¡«';
                                                                    $required_color = '#dc3545';
                                                                    $show_mark = true;
                                                                    break;
                                                                case 'visible':
                                                                    $required_text = 'â–  ç±»ç›®å¿…å¡«';
                                                                    $required_color = '#fd7e14';
                                                                    $show_mark = true;
                                                                    break;
                                                                case 'recommended':
                                                                    $required_text = 'â–  æ¨è';
                                                                    $required_color = '#198754';
                                                                    $show_mark = true;
                                                                    break;
                                                            }
                                                        }
                                                        // é»˜è®¤æ˜¾ç¤ºæ¨è
                                                        else {
                                                            $required_text = 'â–  æ¨è';
                                                            $required_color = '#198754';
                                                            $show_mark = true;
                                                        }

                                                        if ($show_mark) {
                                                            echo ' <span class="is-required" style="color: ' . $required_color . '; font-weight: bold; font-size: 11px;" title="' . $required_text . '">' . $required_text . '</span>';
                                                        }
                                                        ?>
                                                    </td>
                                                    <td>
                                                        <select name="attributes[<?php echo $shared_category_id; ?>][type][]" class="attr-type-selector">
                                                            <option value="wc_attribute" <?php selected($current_type, 'wc_attribute'); ?>>WooCommerceå±æ€§</option>
                                                            <option value="default_value" <?php selected($current_type, 'default_value'); ?>>é»˜è®¤å€¼</option>
                                                            <option value="auto_generate" <?php selected($current_type, 'auto_generate'); ?>>è‡ªåŠ¨ç”Ÿæˆ</option>
                                                            <option value="walmart_field" <?php selected($current_type, 'walmart_field'); ?>>æ²ƒå°”ç›å­—æ®µ</option>
                                                            <option value="attributes_field" <?php selected($current_type, 'attributes_field'); ?>>Attributeså­—æ®µ</option>
                                                        </select>
                                                    </td>
                                                    <td class="source-cell">
                                                        <?php if ($current_type === 'wc_attribute') : ?>
                                                            <select name="attributes[<?php echo $shared_category_id; ?>][source][]">
                                                                <?php foreach ($wc_attributes as $wc_attr) : ?>
                                                                    <option value="<?php echo esc_attr($wc_attr); ?>" <?php selected($current_source, $wc_attr); ?>><?php echo esc_html($wc_attr); ?></option>
                                                                <?php endforeach; ?>
                                                            </select>
                                                        <?php elseif ($current_type === 'auto_generate') : ?>
                                                            <span style="color: #0073aa; font-weight: 500;">
                                                                <?php
                                                                // æ ¹æ®å±æ€§åç§°æ˜¾ç¤ºå…·ä½“çš„ç”Ÿæˆè§„åˆ™
                                                                $rules = [
                                                                    'productName' => 'ä½¿ç”¨äº§å“æ ‡é¢˜',
                                                                    'brand' => 'ä½¿ç”¨äº§å“å“ç‰Œï¼Œæ— å“ç‰Œæ—¶ä½¿ç”¨"Unbranded"',
                                                                    'shortDescription' => 'ä½¿ç”¨äº§å“å®Œæ•´æè¿°',
                                                                    'keyFeatures' => 'ä¼˜å…ˆä½¿ç”¨ç®€çŸ­æè¿°çš„ç‰¹è‰²åˆ—è¡¨ï¼Œå¦åˆ™ä»äº§å“æè¿°å’Œæ ‡é¢˜æ™ºèƒ½ç”Ÿæˆ3-5ä¸ªç‰¹è‰²',
                                                                    'mainImageUrl' => 'è¯»å–äº§å“ä¸»å›¾ï¼ˆæ”¯æŒè¿œç¨‹URLå’Œæœ¬åœ°å›¾ç‰‡ï¼‰',
                                                                    'material' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Main Materialï¼Œå¦åˆ™ä»æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–',
                                                                    'bed_frame_type' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«åºŠæ¶ç±»å‹ï¼Œé»˜è®¤ä¸ºStandard Bed Frames',
                                                                    'bedSize' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§bedSizeï¼Œå¦åˆ™é»˜è®¤ä¸ºNon-Standard',
                                                                    'assembledProductLength' => 'ä»äº§å“å±æ€§Product Sizeæå–é•¿åº¦å€¼ï¼Œé»˜è®¤1 in',
                                                                    'assembledProductWidth' => 'ä»äº§å“å±æ€§Product Sizeæå–å®½åº¦å€¼ï¼Œé»˜è®¤1 in',
                                                                    'assembledProductHeight' => 'ä»äº§å“å±æ€§Product Sizeæå–é«˜åº¦å€¼ï¼Œé»˜è®¤1 in',
                                                                    'assembledProductWeight' => 'ä»äº§å“å±æ€§Product Weightæå–é‡é‡å€¼ï¼Œé»˜è®¤1 lb',
                                                                    'productSecondaryImageURL' => 'è¯»å–äº§å“é™„åŠ å›¾ç‰‡ï¼ˆä¼˜å…ˆè¿œç¨‹URLï¼Œå¦åˆ™æœ¬åœ°å›¾ç‰‡ï¼‰',
                                                                    'productIdentifiers' => 'è‡ªåŠ¨ç”ŸæˆUPCäº§å“æ ‡è¯†ç¬¦ï¼ˆé»˜è®¤UPCç±»å‹ï¼‰',
                                                                    'netContent' => 'æ•°å€¼ä¸º1ï¼Œé»˜è®¤å•ä½ä¸ºCount',
                                                                    'box_spring_required' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦éœ€è¦å¼¹ç°§åºŠå«ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'color' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Main Colorï¼Œå¦åˆ™ä»æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–ï¼Œæ— æ³•æå–åˆ™ç•™ç©º',
                                                                    'colorCategory' => 'æ ¹æ®colorå€¼åŒ¹é…ç›¸è¿‘é¢œè‰²è¯å¡«å…¥',
                                                                    'items_included' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§items_includedï¼Œå¦åˆ™ç•™ç©º',
                                                                    'manufacturerPartNumber' => 'ä½¿ç”¨äº§å“SKUå€¼ï¼ˆä¸­æ–‡è‡ªåŠ¨ç¼–ç ï¼‰',
                                                                    'maximumLoadWeight' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§maximumLoadWeightï¼Œè§£ææ•°å€¼å¹¶è®¾ç½®å•ä½ä¸ºlb',
                                                                    'modelNumber' => 'ä½¿ç”¨äº§å“SKUå€¼ï¼ˆä¸­æ–‡è‡ªåŠ¨ç¼–ç ï¼‰',
                                                                    'occasion' => 'ä½¿ç”¨é¢„è®¾çš„èŠ‚æ—¥åœºåˆåˆ—è¡¨ï¼šLabor Day;Memorial Day;Independence Day;Black Friday;Cyber Monday;Christmas;New Year;Presidents\' Day;Thanksgiving',
                                                                    'productLine' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§productLineï¼Œå¦åˆ™ç•™ç©º',
                                                                    'swatchImages' => 'è¯»å–äº§å“ä¸»å›¾ï¼ˆæ”¯æŒè¿œç¨‹URLå’Œæœ¬åœ°å›¾ç‰‡ï¼‰',
                                                                    'sku' => 'ä½¿ç”¨æœ¬åœ°äº§å“SKUå€¼',
                                                                    'price' => 'ä½¿ç”¨æœ¬åœ°äº§å“ä»·æ ¼å€¼ï¼ˆæœ€å¤šä¸¤ä½å°æ•°ï¼‰',
                                                                    'ShippingWeight' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Package Weightï¼Œå¦åˆ™é»˜è®¤ä¸º1',
                                                                    'electronicsIndicator' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«ç”µå­å…ƒä»¶ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'gender' => 'æ€§åˆ«åˆ†ç±»ï¼Œå¯é€‰æ‹©Unisexï¼ˆä¸­æ€§ï¼‰ã€Maleï¼ˆç”·æ€§ï¼‰ã€Femaleï¼ˆå¥³æ€§ï¼‰ï¼Œé»˜è®¤ä¸ºUnisex',
                                                                    'has_storage' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦æœ‰å‚¨ç‰©ç©ºé—´ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'has_trundle' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«æ‹–æ‹‰åºŠï¼Œé»˜è®¤ä¸ºNo',
                                                                    'homeDecorStyle' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«å®¶å±…è£…é¥°é£æ ¼ï¼Œé»˜è®¤ä¸ºMinimalist',
                                                                    'isAssemblyRequired' => 'äº§å“æ˜¯å¦éœ€è¦ç»„è£…ï¼Œé»˜è®¤ä¸ºYes',
                                                                    'IsPreorder' => 'æ˜¯å¦ä¸ºé¢„è®¢å•†å“ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'isPrimaryVariant' => 'æ˜¯å¦ä¸ºä¸»è¦å˜ä½“ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'MustShipAlone' => 'æ˜¯å¦å¿…é¡»å•ç‹¬å‘è´§ï¼Œé»˜è®¤ä¸ºYes',
                                                                    'numberOfDrawers' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æŠ½å±‰æ•°é‡ï¼Œé»˜è®¤ä¸º0',
                                                                    'numberOfShelves' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«ææ¿æ•°é‡ï¼Œé»˜è®¤ä¸º0',
                                                                    'ProductIdUpdate' => 'æ˜¯å¦æ›´æ–°äº§å“IDï¼Œé»˜è®¤ä¸ºNo',
                                                                    'items_included' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«åŒ…å«çš„ç‰©å“æ¸…å•',
                                                                    'maximumLoadWeight' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ€å¤§æ‰¿é‡ï¼Œé»˜è®¤ä¸º1 lb',
                                                                    'upholstered' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ˜¯å¦æœ‰è½¯å«è¦†ç›–ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'wood_type' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ¨æç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸åŒæ­¥',
                                                                    'wood_tone' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ¨æè‰²è°ƒï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸åŒæ­¥',
                                                                    'profile' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«äº§å“è½®å»“ç±»å‹ï¼Œé»˜è®¤ä¸ºStandard Profile',
                                                                    'theme' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«äº§å“ä¸»é¢˜ï¼Œé»˜è®¤ä¸ºMulti-theme',
                                                                    'arm_style' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ‰¶æ‰‹é£æ ¼ï¼Œé»˜è®¤ä¸ºArmless',
                                                                    'frameColor' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¡†æ¶é¢œè‰²ï¼Œé»˜è®¤ä¸ºProduct color',
                                                                    'chair_style' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¤…å­é£æ ¼ï¼Œé»˜è®¤ä¸ºSide Chair',
                                                                    'frameMaterial' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¡†æ¶æè´¨ï¼Œé»˜è®¤æå–äº§å“æè´¨',
                                                                    'ottoman_included' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«è„šå‡³ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'pattern' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«å›¾æ¡ˆæ ·å¼ï¼Œé»˜è®¤ä¸ºSolid',
                                                                    'leg_color' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«è…¿éƒ¨é¢œè‰²ï¼Œé»˜è®¤ä¸ºäº§å“ä¸»ä½“é¢œè‰²',
                                                                    'leg_material' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«è…¿éƒ¨æè´¨ï¼Œé»˜è®¤ä¸ºäº§å“ä¸»ä½“æè´¨',
                                                                    'preset_bed_positions' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«é¢„è®¾åºŠä½ï¼Œé»˜è®¤ä¸ºNone',
                                                                    'shipsInOriginalPackaging' => 'æ˜¯å¦å¯ä»¥åŸåŒ…è£…å‘è´§ï¼Œé»˜è®¤ä¸ºYes',
                                                                    'fulfillmentCenterID' => 'ä½¿ç”¨è®¾ç½®ä¸­çš„å±¥è¡Œä¸­å¿ƒID',
                                                                    'fulfillmentLagTime' => 'é»˜è®¤1å¤©å¤‡è´§æ—¶é—´ï¼ˆnumber_with_unitç»“æ„ï¼‰',
                                                                    'releaseDate' => 'åŒæ­¥å½“å¤©å¾€å‰æ¨ä¸€å¤©ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2025/07/31ï¼‰',
                                                                    'startDate' => 'åŒæ­¥å½“å¤©å¾€å‰æ¨ä¸€å¤©ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2025/07/31ï¼‰',
                                                                    'endDate' => 'åŒæ­¥å½“å¤©å¾€åæ¨15å¹´ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2040/07/31ï¼‰',
                                                                    'bed_frame_adjustability' => 'ä»äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–åºŠæ¶å¯è°ƒæ€§å…³é”®è¯ï¼ˆAdjustable Foot/Headï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©º'
                                                                ];
                                                                echo isset($rules[$current_name]) ? $rules[$current_name] : 'è‡ªåŠ¨ç”Ÿæˆ';
                                                                ?>
                                                            </span>
                                                            <input type="hidden" name="attributes[<?php echo $shared_category_id; ?>][source][]" value="auto">
                                                        <?php elseif ($current_type === 'walmart_field') : ?>
                                                            <?php
                                                            $current_enum_values = isset($current_attributes['enum_values'][$i]) ? $current_attributes['enum_values'][$i] : '';
                                                            ?>
                                                            <select name="attributes[<?php echo $shared_category_id; ?>][source][]" class="walmart-field-selector" data-attribute-name="<?php echo esc_attr($current_name); ?>" data-current-value="<?php echo esc_attr($current_source); ?>" data-enum-values="<?php echo esc_attr($current_enum_values); ?>">
                                                                <option value="">é€‰æ‹©æ²ƒå°”ç›å­—æ®µå€¼</option>
                                                                <!-- æ²ƒå°”ç›å­—æ®µé€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                                                            </select>
                                                            <!-- éšè—å­—æ®µä¿å­˜æšä¸¾å€¼ -->
                                                            <input type="hidden" name="enum_values[<?php echo $shared_category_id; ?>][]" value="<?php echo esc_attr($current_enum_values); ?>">
                                                        <?php elseif ($current_type === 'attributes_field') : ?>
                                                            <?php
                                                            $current_attributes_key = isset($current_attributes['attributes_key'][$i]) ? $current_attributes['attributes_key'][$i] : $current_name;
                                                            ?>
                                                            <div class="attributes-field-container" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;">
                                                                <div style="margin-bottom: 8px;">
                                                                    <label style="font-weight: bold; color: #333; font-size: 12px;">ä¼˜å…ˆä»Attributeså­—æ®µè·å–:</label>
                                                                    <input type="text" name="attributes[<?php echo $shared_category_id; ?>][attributes_key][]"
                                                                           value="<?php echo esc_attr($current_attributes_key); ?>"
                                                                           placeholder="è¾“å…¥Attributesä¸­çš„å­—æ®µåï¼ˆå¦‚: <?php echo esc_attr($current_name); ?>ï¼‰"
                                                                           style="width: 100%; margin-top: 3px;" class="attributes-key-input">
                                                                </div>
                                                                <div>
                                                                    <label style="font-weight: bold; color: #666; font-size: 12px;">å¤‡ç”¨é»˜è®¤å€¼:</label>
                                                                    <input type="text" name="attributes[<?php echo $shared_category_id; ?>][source][]"
                                                                           value="<?php echo esc_attr($current_source); ?>"
                                                                           placeholder="å½“Attributeså­—æ®µä¸å­˜åœ¨æ—¶ä½¿ç”¨æ­¤é»˜è®¤å€¼"
                                                                           style="width: 100%; margin-top: 3px;" class="attributes-fallback-input">
                                                                </div>
                                                                <div style="margin-top: 5px; font-size: 11px; color: #666;">
                                                                    ğŸ’¡ ç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨äº§å“Attributesä¸­çš„"<span class="attr-key-preview"><?php echo esc_html($current_attributes_key); ?></span>"å­—æ®µå€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å¤‡ç”¨é»˜è®¤å€¼
                                                                </div>
                                                            </div>
                                                        <?php else : ?>
                                                            <input type="text" name="attributes[<?php echo $shared_category_id; ?>][source][]" value="<?php echo esc_attr($current_source); ?>" placeholder="è¾“å…¥é»˜è®¤å€¼">
                                                        <?php endif; ?>
                                                    </td>
                                                    <td class="format-cell" style="display: none;">
                                                        <select name="attributes[<?php echo $shared_category_id; ?>][format][]" class="data-format-selector" style="width: 100%;">
                                                            <option value="auto" selected>è‡ªåŠ¨æ£€æµ‹ / Auto Detect</option>
                                                        </select>
                                                    </td>
                                                    <td><a href="#" class="button remove-attribute-row">ç§»é™¤</a></td>
                                                </tr>
                                            <?php endfor; ?>
                                </tbody>
                            </table>

                            <button type="button" class="button add-attribute-row" data-category-id="<?php echo $shared_category_id; ?>">
                                <span class="dashicons dashicons-plus-alt"></span> æ‰‹åŠ¨æ·»åŠ å±æ€§
                            </button>
                        </div>

                        <!-- å•ä¸ªåˆ†ç±»ä¿å­˜åŒºåŸŸ -->
                        <div class="individual-save-section" id="save-section-<?php echo $shared_category_id; ?>">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <strong>ä¿å­˜å…±äº«æ˜ å°„é…ç½®</strong>
                                    <small style="display: block; color: #646970; margin-top: 2px;">
                                        å°†ä¿å­˜æ­¤Walmartåˆ†ç±»ä¸‹æ‰€æœ‰æœ¬åœ°åˆ†ç±»çš„å…±äº«å±æ€§è§„åˆ™
                                    </small>
                                </div>
                                <button type="button" class="individual-save-btn" data-category-id="<?php echo $shared_category_id; ?>">
                                    <span class="dashicons dashicons-yes"></span> ä¿å­˜æ˜ å°„
                                </button>
                            </div>
                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php endforeach; // ç»“æŸWalmartåˆ†ç±»åˆ†ç»„å¾ªç¯ ?>

                <!-- æœªæ˜ å°„çš„åˆ†ç±» -->
                <?php if (!empty($unmapped_categories)) : ?>
                    <div class="unmapped-categories-section">
                        <h3 style="color: #d63638; margin-bottom: 20px;">
                            ğŸ”„ æœªæ˜ å°„çš„æœ¬åœ°åˆ†ç±» (<?php echo count($unmapped_categories); ?> ä¸ª)
                        </h3>

                        <?php foreach ($unmapped_categories as $wc_cat) :
                            $current_map = isset($saved_mappings[$wc_cat->term_id]) ? $saved_mappings[$wc_cat->term_id] : null;
                            $current_walmart_cat = $current_map ? $current_map->walmart_category_path : '';
                            // ä¿®æ­£ï¼šç¡®ä¿åœ¨json_decodeå¤±è´¥æˆ–ä¸ºç©ºæ—¶ï¼Œæä¾›ä¸€ä¸ªå¸¦'name'é”®çš„é»˜è®¤ç©ºæ•°ç»„
                            $current_attributes = $current_map && !empty($current_map->walmart_attributes) ? json_decode($current_map->walmart_attributes, true) : ['name' => [], 'type' => [], 'source' => [], 'required_level' => [], 'group' => [], 'format' => [], 'enum_values' => []];
                            if (!is_array($current_attributes) || !isset($current_attributes['name'])) {
                               $current_attributes = ['name' => [], 'type' => [], 'source' => [], 'required_level' => [], 'group' => [], 'format' => [], 'enum_values' => []];
                            }

                            // é‡è¦ä¿®å¤ï¼šç¡®ä¿JSONè§£ç årequired_levelæ•°ç»„å­˜åœ¨ä¸”é•¿åº¦æ­£ç¡®
                            if (!isset($current_attributes['required_level']) || !is_array($current_attributes['required_level'])) {
                                $current_attributes['required_level'] = [];
                            }

                            // å…¼å®¹æ€§ä¿®å¤ï¼šç¡®ä¿enum_valuesæ•°ç»„å­˜åœ¨
                            if (!isset($current_attributes['enum_values']) || !is_array($current_attributes['enum_values'])) {
                                $current_attributes['enum_values'] = [];
                            }

                            // å¦‚æœrequired_levelæ•°ç»„é•¿åº¦ä¸åŒ¹é…ï¼Œç”¨ç©ºå­—ç¬¦ä¸²å¡«å……
                            $name_count = count($current_attributes['name']);
                            $required_level_count = count($current_attributes['required_level']);
                            if ($required_level_count < $name_count) {
                                $current_attributes['required_level'] = array_pad($current_attributes['required_level'], $name_count, '');
                            }

                            // ç¡®ä¿required_levelæ•°ç»„å­˜åœ¨
                            if (!isset($current_attributes['required_level'])) {
                                $current_attributes['required_level'] = [];
                            }

                            // ç¡®ä¿formatæ•°ç»„å­˜åœ¨ä¸”é•¿åº¦æ­£ç¡®
                            if (!isset($current_attributes['format'])) {
                                $current_attributes['format'] = [];
                            }
                            $format_count = count($current_attributes['format']);
                            if ($format_count < $name_count) {
                                $current_attributes['format'] = array_pad($current_attributes['format'], $name_count, '');
                            }

                            // ç¡®ä¿enum_valuesæ•°ç»„é•¿åº¦æ­£ç¡®
                            $enum_values_count = count($current_attributes['enum_values']);
                            if ($enum_values_count < $name_count) {
                                $current_attributes['enum_values'] = array_pad($current_attributes['enum_values'], $name_count, '');
                            }

                            // ç¡®ä¿enum_valuesæ•°ç»„å­˜åœ¨ä¸”é•¿åº¦æ­£ç¡®
                            if (!isset($current_attributes['enum_values'])) {
                                $current_attributes['enum_values'] = [];
                            }
                            $enum_values_count = count($current_attributes['enum_values']);
                            if ($enum_values_count < $name_count) {
                                $current_attributes['enum_values'] = array_pad($current_attributes['enum_values'], $name_count, '');
                            }
                        ?>
                            <!-- å•ä¸ªåˆ†ç±»æ˜ å°„é¡¹ -->
                            <div class="category-row" data-category-id="<?php echo $wc_cat->term_id; ?>">
                                <!-- åˆ†ç±»å¤´éƒ¨ -->
                                <div class="category-header">
                                    <div class="category-info">
                                        <h3 class="category-title"><?php echo esc_html($wc_cat->name); ?></h3>
                                        <div class="category-meta">
                                            ID: <?php echo $wc_cat->term_id; ?> | å•†å“æ•°: <?php echo $wc_cat->count; ?>
                                            <?php if ($current_walmart_cat): ?>
                                                | å·²æ˜ å°„åˆ°: <span style="color: #00a32a; font-weight: 500;">
                                                    <?php
                                                    // æ˜¾ç¤ºWalmartåˆ†ç±»åç§°
                                                    $walmart_cat_name = '';
                                                    if (!empty($walmart_categories)) {
                                                        foreach ($walmart_categories as $wm_cat) {
                                                            if ($wm_cat['categoryId'] === $current_walmart_cat) {
                                                                $walmart_cat_name = $wm_cat['categoryName'];
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    echo $walmart_cat_name ?: $current_walmart_cat;
                                                    ?>
                                                </span>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                </div>

                                <!-- Walmartåˆ†ç±»é€‰æ‹© -->
                                <div class="walmart-category-section">
                                    <label class="walmart-category-label">é€‰æ‹©Walmartåˆ†ç±»</label>
                                    <!-- Walmartåˆ†ç±»é€‰æ‹©å™¨ - æ ‘å½¢ç»“æ„ -->
                                    <div class="walmart-category-tree-selector" data-wc-cat-id="<?php echo esc_attr($wc_cat->term_id); ?>">
                                        <input type="hidden" name="walmart_category[<?php echo esc_attr($wc_cat->term_id); ?>]"
                                               class="walmart-category-value" value="<?php echo esc_attr($current_walmart_cat); ?>">

                                        <div class="category-selector-display" onclick="toggleCategoryTree(this)">
                                            <span class="selected-category">
                                                <?php
                                                if ($current_walmart_cat) {
                                                    // æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„åˆ†ç±»åç§°
                                                    $current_name = '';
                                                    if (!empty($walmart_categories)) {
                                                        foreach ($walmart_categories as $wm_cat) {
                                                            if ($wm_cat['categoryId'] === $current_walmart_cat) {
                                                                $current_name = $wm_cat['categoryName'];
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    echo esc_html($current_name ?: $current_walmart_cat);
                                                } else {
                                                    echo '-- è¯·é€‰æ‹©ä¸€ä¸ªæ²ƒå°”ç›åˆ†ç±» --';
                                                }
                                                ?>
                                            </span>
                                            <span class="dropdown-arrow">â–¼</span>
                                        </div>

                                        <div class="category-tree-dropdown" style="display: none;">
                                            <div class="category-search">
                                                <input type="text" placeholder="æœç´¢åˆ†ç±»..." class="category-search-input">
                                                <button type="button" class="clear-search" style="display: none;">âœ•</button>
                                            </div>
                                            <div class="category-tree-container">
                                                <div class="loading">åŠ è½½ä¸­...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- å±æ€§æ˜ å°„åŒºåŸŸ -->
                                <div class="attribute-mapper" data-wc-cat-id="<?php echo $wc_cat->term_id; ?>">
                                    <div class="attribute-controls">
                                        <div class="attribute-header">
                                            <h4>å±æ€§æ˜ å°„é…ç½®</h4>
                                            <div class="attribute-count">
                                                <span class="count-text">å·²é…ç½® <span class="count-number"><?php echo count(array_filter($current_attributes['name'])); ?></span> ä¸ªå±æ€§</span>
                                            </div>
                                        </div>
                                        <div class="attribute-controls">
                                            <button type="button" class="toggle-attributes-btn" data-category-id="<?php echo $wc_cat->term_id; ?>">
                                                <span class="dashicons dashicons-arrow-down-alt2"></span>
                                                <span class="btn-text">å±•å¼€å±æ€§</span>
                                            </button>
                                            <button type="button" class="button button-secondary button-small fetch-attributes-button" title="æ™ºèƒ½åŠ è½½ï¼šæ£€æµ‹åˆ†ç±»å˜æ›´ï¼Œè¯¢é—®æ˜¯å¦æ›¿æ¢ç°æœ‰å±æ€§">
                                                <span class="dashicons dashicons-download"></span>
                                                åŠ è½½V5.0è§„èŒƒ
                                            </button>
                                            <button type="button" class="button button-secondary button-small force-replace-attributes-button" title="æ¸…ç©ºç°æœ‰å±æ€§ï¼Œé‡æ–°åŠ è½½å®Œæ•´è§„èŒƒ">
                                                <span class="dashicons dashicons-update"></span> é‡ç½®å±æ€§
                                            </button>
                                            <button type="button" class="button button-secondary button-small clear-attributes-button" style="color: #d63638; border-color: #d63638;">
                                                <span class="dashicons dashicons-trash"></span> æ¸…é™¤å±æ€§
                                            </button>
                                            <button type="button" class="button button-secondary button-small debug-api-response-button">
                                                <span class="dashicons dashicons-search"></span> è°ƒè¯•API
                                            </button>
                                        </div>
                                    </div>
                                    <div style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-left: 3px solid #0073aa; font-size: 11px; <?php echo (!empty($current_attributes['name']) && count(array_filter($current_attributes['name'])) > 0) ? '' : 'display: none;'; ?>" class="required-level-info">
                                        <strong>V5.0å¿…å¡«çº§åˆ«ï¼š</strong>
                                        <span style="color: #dc3545;">â–  é€šç”¨å¿…å¡«</span> |
                                        <span style="color: #fd7e14;">â–  ç±»ç›®å¿…å¡«</span> |
                                        <span style="color: #198754;">â–  æ¨è</span>
                                    </div>
                                    <table class="attributes-container" id="attributes-table-<?php echo $wc_cat->term_id; ?>">
                                        <thead>
                                            <tr>
                                                <th style="width: 22% !important; max-width: 22% !important;">æ²ƒå°”ç›å±æ€§å</th>
                                                <th style="width: 9% !important; max-width: 9% !important;">æ˜ å°„ç±»å‹</th>
                                                <th style="width: 44% !important; max-width: 44% !important;">æ¥æº/å€¼</th>
                                                <th style="width: 15%; display: none;">æ•°æ®æ ¼å¼</th>
                                                <th style="width: 10%;">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php
                                            $name_count = count($current_attributes['name']);
                                            for ($i = 0; $i < $name_count; $i++) :
                                                $current_name = $current_attributes['name'][$i];
                                                $current_type = isset($current_attributes['type'][$i]) ? $current_attributes['type'][$i] : 'default_value';
                                                $current_source = isset($current_attributes['source'][$i]) ? $current_attributes['source'][$i] : '';
                                                $current_required_level = isset($current_attributes['required_level'][$i]) ? $current_attributes['required_level'][$i] : '';
                                                $current_group = isset($current_attributes['group'][$i]) ? $current_attributes['group'][$i] : '';
                                                $current_format = isset($current_attributes['format'][$i]) ? $current_attributes['format'][$i] : '';

                                                if (empty($current_name)) continue;
                                            ?>
                                                <tr>
                                                    <td>
                                                        <input type="text" name="attributes[<?php echo $wc_cat->term_id; ?>][name][]" value="<?php echo esc_attr($current_name); ?>" placeholder="å±æ€§åç§°" style="width: 100%;">
                                                        <?php
                                                        // æ˜¾ç¤ºå¿…å¡«çº§åˆ«æ ‡è¯†
                                                        $show_mark = false;
                                                        $required_text = '';
                                                        $required_color = '';

                                                        if (!empty($current_required_level)) {
                                                            switch($current_required_level) {
                                                                case 'system':
                                                                case 'sell':
                                                                    $required_text = 'â–  é€šç”¨å¿…å¡«';
                                                                    $required_color = '#dc3545';
                                                                    $show_mark = true;
                                                                    break;
                                                                case 'visible':
                                                                    $required_text = 'â–  ç±»ç›®å¿…å¡«';
                                                                    $required_color = '#fd7e14';
                                                                    $show_mark = true;
                                                                    break;
                                                                case 'recommended':
                                                                    $required_text = 'â–  æ¨è';
                                                                    $required_color = '#198754';
                                                                    $show_mark = true;
                                                                    break;
                                                            }
                                                        }
                                                        // é»˜è®¤æ˜¾ç¤ºæ¨è
                                                        else {
                                                            $required_text = 'â–  æ¨è';
                                                            $required_color = '#198754';
                                                            $show_mark = true;
                                                        }

                                                        if ($show_mark) {
                                                            echo ' <span class="is-required" style="color: ' . $required_color . '; font-weight: bold; font-size: 11px;" title="' . esc_attr($required_text) . '">' . $required_text . '</span>';
                                                        }
                                                        ?>
                                                        <input type="hidden" name="required_levels[<?php echo $wc_cat->term_id; ?>][]" value="<?php echo esc_attr($current_required_level); ?>">
                                                        <input type="hidden" name="attribute_groups[<?php echo $wc_cat->term_id; ?>][]" value="<?php echo esc_attr($current_group); ?>">
                                                    </td>
                                                    <td>
                                                        <select name="attributes[<?php echo $wc_cat->term_id; ?>][type][]" class="attr-type-selector" style="width: 100%;">
                                                            <option value="default_value" <?php selected($current_type, 'default_value'); ?>>é»˜è®¤å€¼</option>
                                                            <option value="wc_attribute" <?php selected($current_type, 'wc_attribute'); ?>>WooCommerceå±æ€§</option>
                                                            <option value="auto_generate" <?php selected($current_type, 'auto_generate'); ?>>è‡ªåŠ¨ç”Ÿæˆ</option>
                                                            <option value="walmart_field" <?php selected($current_type, 'walmart_field'); ?>>æ²ƒå°”ç›å­—æ®µ</option>
                                                            <option value="attributes_field" <?php selected($current_type, 'attributes_field'); ?>>Attributeså­—æ®µ</option>
                                                        </select>
                                                    </td>
                                                    <td class="source-cell">
                                                        <?php if ($current_type === 'wc_attribute') : ?>
                                                            <select name="attributes[<?php echo $wc_cat->term_id; ?>][source][]" style="width: 100%;">
                                                                <?php foreach ($wc_attributes as $wc_attr) : ?>
                                                                    <option value="<?php echo esc_attr($wc_attr); ?>" <?php selected($current_source, $wc_attr); ?>><?php echo esc_html($wc_attr); ?></option>
                                                                <?php endforeach; ?>
                                                            </select>
                                                        <?php elseif ($current_type === 'auto_generate') : ?>
                                                            <span style="color: #0073aa; font-weight: 500;">
                                                                <?php
                                                                $rules = [
                                                                    'productName' => 'ä½¿ç”¨äº§å“æ ‡é¢˜ï¼ˆè‡ªåŠ¨å¤„ç†ä¸­æ–‡å­—ç¬¦ï¼‰',
                                                                    'brand' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Brandï¼Œå¦åˆ™ä»æ ‡é¢˜æå–ï¼Œæ— æ³•æå–åˆ™ç•™ç©º',
                                                                    'shortDescription' => 'ä½¿ç”¨äº§å“å®Œæ•´æè¿°ï¼ˆè‡ªåŠ¨å¤„ç†HTMLæ ‡ç­¾å’Œä¸­æ–‡å­—ç¬¦ï¼‰',
                                                                    'keyFeatures' => 'ä»äº§å“æè¿°ä¸­æå–å…³é”®ç‰¹æ€§ï¼ˆè‡ªåŠ¨å¤„ç†HTMLå’Œä¸­æ–‡ï¼‰',
                                                                    'mainImageUrl' => 'è¯»å–äº§å“ä¸»å›¾ï¼ˆä¼˜å…ˆè¿œç¨‹URLï¼Œå¦åˆ™æœ¬åœ°å›¾ç‰‡ï¼‰',
                                                                    'material' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Materialï¼Œå¦åˆ™ä»æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–ï¼Œæ— æ³•æå–åˆ™ç•™ç©º',
                                                                    'bed_frame_type' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«åºŠæ¶ç±»å‹ï¼Œé»˜è®¤ä¸ºStandard Bed Frames',
                                                                    'bedSize' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§bedSizeï¼Œå¦åˆ™ç•™ç©º',
                                                                    'assembledProductLength' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Lengthï¼Œè§£ææ•°å€¼å¹¶è®¾ç½®å•ä½ä¸ºin',
                                                                    'assembledProductWidth' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Widthï¼Œè§£ææ•°å€¼å¹¶è®¾ç½®å•ä½ä¸ºin',
                                                                    'assembledProductHeight' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Heightï¼Œè§£ææ•°å€¼å¹¶è®¾ç½®å•ä½ä¸ºin',
                                                                    'assembledProductWeight' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Weightï¼Œè§£ææ•°å€¼å¹¶è®¾ç½®å•ä½ä¸ºlb',
                                                                    'productSecondaryImageURL' => 'è¯»å–äº§å“é™„åŠ å›¾ç‰‡ï¼ˆä¼˜å…ˆè¿œç¨‹URLï¼Œå¦åˆ™æœ¬åœ°å›¾ç‰‡ï¼‰',
                                                                    'productIdentifiers' => 'è‡ªåŠ¨ç”ŸæˆUPCäº§å“æ ‡è¯†ç¬¦ï¼ˆé»˜è®¤UPCç±»å‹ï¼‰',
                                                                    'netContent' => 'æ•°å€¼ä¸º1ï¼Œé»˜è®¤å•ä½ä¸ºCount',
                                                                    'box_spring_required' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦éœ€è¦å¼¹ç°§åºŠå«ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'color' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Main Colorï¼Œå¦åˆ™ä»æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–ï¼Œæ— æ³•æå–åˆ™ç•™ç©º',
                                                                    'colorCategory' => 'æ ¹æ®colorå€¼åŒ¹é…ç›¸è¿‘é¢œè‰²è¯å¡«å…¥',
                                                                    'items_included' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§items_includedï¼Œå¦åˆ™ç•™ç©º',
                                                                    'manufacturerPartNumber' => 'ä½¿ç”¨äº§å“SKUå€¼ï¼ˆä¸­æ–‡è‡ªåŠ¨ç¼–ç ï¼‰',
                                                                    'maximumLoadWeight' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§maximumLoadWeightï¼Œè§£ææ•°å€¼å¹¶è®¾ç½®å•ä½ä¸ºlb',
                                                                    'modelNumber' => 'ä½¿ç”¨äº§å“SKUå€¼ï¼ˆä¸­æ–‡è‡ªåŠ¨ç¼–ç ï¼‰',
                                                                    'occasion' => 'ä½¿ç”¨é¢„è®¾çš„èŠ‚æ—¥åœºåˆåˆ—è¡¨ï¼šLabor Day;Memorial Day;Independence Day;Black Friday;Cyber Monday;Christmas;New Year;Presidents\' Day;Thanksgiving',
                                                                    'productLine' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§productLineï¼Œå¦åˆ™ç•™ç©º',
                                                                    'swatchImages' => 'è¯»å–äº§å“ä¸»å›¾ï¼ˆæ”¯æŒè¿œç¨‹URLå’Œæœ¬åœ°å›¾ç‰‡ï¼‰',
                                                                    'sku' => 'ä½¿ç”¨æœ¬åœ°äº§å“SKUå€¼',
                                                                    'price' => 'ä½¿ç”¨æœ¬åœ°äº§å“ä»·æ ¼å€¼ï¼ˆæœ€å¤šä¸¤ä½å°æ•°ï¼‰',
                                                                    'ShippingWeight' => 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Package Weightï¼Œå¦åˆ™é»˜è®¤ä¸º1',
                                                                    'electronicsIndicator' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«ç”µå­å…ƒä»¶ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'gender' => 'æ€§åˆ«åˆ†ç±»ï¼Œå¯é€‰æ‹©Unisexï¼ˆä¸­æ€§ï¼‰ã€Maleï¼ˆç”·æ€§ï¼‰ã€Femaleï¼ˆå¥³æ€§ï¼‰ï¼Œé»˜è®¤ä¸ºUnisex',
                                                                    'has_storage' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦æœ‰å‚¨ç‰©ç©ºé—´ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'has_trundle' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«æ‹–æ‹‰åºŠï¼Œé»˜è®¤ä¸ºNo',
                                                                    'homeDecorStyle' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«å®¶å±…è£…é¥°é£æ ¼ï¼Œé»˜è®¤ä¸ºMinimalist',
                                                                    'isAssemblyRequired' => 'äº§å“æ˜¯å¦éœ€è¦ç»„è£…ï¼Œé»˜è®¤ä¸ºYes',
                                                                    'IsPreorder' => 'æ˜¯å¦ä¸ºé¢„è®¢å•†å“ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'isPrimaryVariant' => 'æ˜¯å¦ä¸ºä¸»è¦å˜ä½“ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'MustShipAlone' => 'æ˜¯å¦å¿…é¡»å•ç‹¬å‘è´§ï¼Œé»˜è®¤ä¸ºYes',
                                                                    'numberOfDrawers' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æŠ½å±‰æ•°é‡ï¼Œé»˜è®¤ä¸º0',
                                                                    'numberOfShelves' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«ææ¿æ•°é‡ï¼Œé»˜è®¤ä¸º0',
                                                                    'ProductIdUpdate' => 'æ˜¯å¦æ›´æ–°äº§å“IDï¼Œé»˜è®¤ä¸ºNo',
                                                                    'items_included' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«åŒ…å«çš„ç‰©å“æ¸…å•',
                                                                    'maximumLoadWeight' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ€å¤§æ‰¿é‡ï¼Œé»˜è®¤ä¸º1 lb',
                                                                    'upholstered' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ˜¯å¦æœ‰è½¯å«è¦†ç›–ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'wood_type' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ¨æç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸åŒæ­¥',
                                                                    'wood_tone' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ¨æè‰²è°ƒï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸åŒæ­¥',
                                                                    'profile' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«äº§å“è½®å»“ç±»å‹ï¼Œé»˜è®¤ä¸ºStandard Profile',
                                                                    'theme' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«äº§å“ä¸»é¢˜ï¼Œé»˜è®¤ä¸ºMulti-theme',
                                                                    'arm_style' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ‰¶æ‰‹é£æ ¼ï¼Œé»˜è®¤ä¸ºArmless',
                                                                    'frameColor' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¡†æ¶é¢œè‰²ï¼Œé»˜è®¤ä¸ºProduct color',
                                                                    'chair_style' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¤…å­é£æ ¼ï¼Œé»˜è®¤ä¸ºSide Chair',
                                                                    'frameMaterial' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¡†æ¶æè´¨ï¼Œé»˜è®¤æå–äº§å“æè´¨',
                                                                    'ottoman_included' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«è„šå‡³ï¼Œé»˜è®¤ä¸ºNo',
                                                                    'pattern' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«å›¾æ¡ˆæ ·å¼ï¼Œé»˜è®¤ä¸ºSolid',
                                                                    'leg_color' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«è…¿éƒ¨é¢œè‰²ï¼Œé»˜è®¤ä¸ºäº§å“ä¸»ä½“é¢œè‰²',
                                                                    'leg_material' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«è…¿éƒ¨æè´¨ï¼Œé»˜è®¤ä¸ºäº§å“ä¸»ä½“æè´¨',
                                                                    'preset_bed_positions' => 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«é¢„è®¾åºŠä½ï¼Œé»˜è®¤ä¸ºNone',
                                                                    'shipsInOriginalPackaging' => 'æ˜¯å¦å¯ä»¥åŸåŒ…è£…å‘è´§ï¼Œé»˜è®¤ä¸ºYes',
                                                                    'fulfillmentCenterID' => 'ä½¿ç”¨è®¾ç½®ä¸­çš„å±¥è¡Œä¸­å¿ƒID',
                                                                    'fulfillmentLagTime' => 'é»˜è®¤1å¤©å¤‡è´§æ—¶é—´ï¼ˆnumber_with_unitç»“æ„ï¼‰',
                                                                    'releaseDate' => 'åŒæ­¥å½“å¤©å¾€å‰æ¨ä¸€å¤©ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2025/07/31ï¼‰',
                                                                    'startDate' => 'åŒæ­¥å½“å¤©å¾€å‰æ¨ä¸€å¤©ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2025/07/31ï¼‰',
                                                                    'endDate' => 'åŒæ­¥å½“å¤©å¾€åæ¨15å¹´ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2040/07/31ï¼‰',
                                                                    'bed_frame_adjustability' => 'ä»äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–åºŠæ¶å¯è°ƒæ€§å…³é”®è¯ï¼ˆAdjustable Foot/Headï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©º',
                                                                    // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µè¯´æ˜
                                                                    'table_color' => 'ä»äº§å“æè¿°ä¸­æå–æ¡Œå­é¢œè‰²ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨äº§å“ä¸»é¢˜é¢œè‰²å€¼ï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å€¼',
                                                                    'table_top_type' => 'ä»äº§å“æè¿°ä¸­æå–æ¡Œé¢ç±»å‹ä¿¡æ¯ï¼Œæ”¯æŒTray Topå’ŒLift Topä¸¤ç§ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨Tray Top',
                                                                    'tableHeight' => 'ä»äº§å“æè¿°ä¸­æå–æ¡Œå­é«˜åº¦ä¿¡æ¯ï¼Œè¿”å›æµ‹é‡å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "in"}ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å€¼',
                                                                    // ğŸ†• æŸœä½“ç›¸å…³å­—æ®µè¯´æ˜
                                                                    'cabinet_color' => 'è‡ªåŠ¨ä»æ ‡é¢˜å’Œäº§å“æè¿°æå–æŸœä½“é¢œè‰²ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨äº§å“ä¸»ä½“é¢œè‰²ï¼Œå¦‚æœéƒ½æ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                                                                    'cabinet_material' => 'è‡ªåŠ¨ä»æ ‡é¢˜å’Œäº§å“æè¿°æå–æŸœä½“æè´¨ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨äº§å“ä¸»ä½“æè´¨ï¼Œå¦‚æœéƒ½æ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                                                                    'hardwareFinish' => 'è‡ªåŠ¨ä»æ ‡é¢˜å’Œäº§å“æè¿°æå–äº”é‡‘è¡¨é¢å¤„ç†ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨äº§å“é¢œè‰²',
                                                                    'recommendedRooms' => 'é»˜è®¤ä½¿ç”¨å¤šä¸ªé€‰é¡¹ï¼šLiving Room, Bedroom, Dining Room, Family Room, Kitchen, Bathroom, Laundry Room, Pantry, Home Office, Office, Conference Room, Cubicle',
                                                                    // ğŸ†• åˆ†ç±»ç‰¹å®šfeatureså­—æ®µè¯´æ˜
                                                                    'features' => 'æ ¹æ®äº§å“çš„æœ¬åœ°åˆ†ç±»IDåŠ¨æ€è·å–å¯ç”¨çš„ç‰¹æ€§é€‰é¡¹ï¼Œç„¶åä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æ™ºèƒ½åŒ¹é…æœ€åˆé€‚çš„ç‰¹æ€§ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ'
                                                                ];
                                                                echo isset($rules[$current_name]) ? $rules[$current_name] : 'è‡ªåŠ¨ç”Ÿæˆ';
                                                                ?>
                                                            </span>
                                                            <input type="hidden" name="attributes[<?php echo $wc_cat->term_id; ?>][source][]" value="auto">
                                                        <?php elseif ($current_type === 'walmart_field') : ?>
                                                            <?php
                                                            $current_enum_values = isset($current_attributes['enum_values'][$i]) ? $current_attributes['enum_values'][$i] : '';
                                                            ?>
                                                            <select name="attributes[<?php echo $wc_cat->term_id; ?>][source][]" class="walmart-field-selector" data-attribute-name="<?php echo esc_attr($current_name); ?>" data-current-value="<?php echo esc_attr($current_source); ?>" data-enum-values="<?php echo esc_attr($current_enum_values); ?>">
                                                                <option value="">é€‰æ‹©æ²ƒå°”ç›å­—æ®µå€¼</option>
                                                                <!-- æ²ƒå°”ç›å­—æ®µé€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                                                            </select>
                                                            <!-- éšè—å­—æ®µä¿å­˜æšä¸¾å€¼ -->
                                                            <input type="hidden" name="enum_values[<?php echo $wc_cat->term_id; ?>][]" value="<?php echo esc_attr($current_enum_values); ?>">
                                                        <?php elseif ($current_type === 'attributes_field') : ?>
                                                            <?php
                                                            $current_attributes_key = isset($current_attributes['attributes_key'][$i]) ? $current_attributes['attributes_key'][$i] : $current_name;
                                                            ?>
                                                            <div class="attributes-field-container" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;">
                                                                <div style="margin-bottom: 8px;">
                                                                    <label style="font-weight: bold; color: #333; font-size: 12px;">ä¼˜å…ˆä»Attributeså­—æ®µè·å–:</label>
                                                                    <input type="text" name="attributes[<?php echo $wc_cat->term_id; ?>][attributes_key][]"
                                                                           value="<?php echo esc_attr($current_attributes_key); ?>"
                                                                           placeholder="è¾“å…¥Attributesä¸­çš„å­—æ®µåï¼ˆå¦‚: <?php echo esc_attr($current_name); ?>ï¼‰"
                                                                           style="width: 100%; margin-top: 3px;" class="attributes-key-input">
                                                                </div>
                                                                <div>
                                                                    <label style="font-weight: bold; color: #666; font-size: 12px;">å¤‡ç”¨é»˜è®¤å€¼:</label>
                                                                    <input type="text" name="attributes[<?php echo $wc_cat->term_id; ?>][source][]"
                                                                           value="<?php echo esc_attr($current_source); ?>"
                                                                           placeholder="å½“Attributeså­—æ®µä¸å­˜åœ¨æ—¶ä½¿ç”¨æ­¤é»˜è®¤å€¼"
                                                                           style="width: 100%; margin-top: 3px;" class="attributes-fallback-input">
                                                                </div>
                                                                <div style="margin-top: 5px; font-size: 11px; color: #666;">
                                                                    ğŸ’¡ ç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨äº§å“Attributesä¸­çš„"<span class="attr-key-preview"><?php echo esc_html($current_attributes_key); ?></span>"å­—æ®µå€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å¤‡ç”¨é»˜è®¤å€¼
                                                                </div>
                                                            </div>
                                                        <?php else : ?>
                                                            <input type="text" name="attributes[<?php echo $wc_cat->term_id; ?>][source][]" value="<?php echo esc_attr($current_source); ?>" placeholder="è¾“å…¥é»˜è®¤å€¼">
                                                        <?php endif; ?>
                                                    </td>
                                                    <td class="format-cell" style="display: none;">
                                                        <select name="attributes[<?php echo $wc_cat->term_id; ?>][format][]" class="data-format-selector" style="width: 100%;">
                                                            <option value="auto" selected>è‡ªåŠ¨æ£€æµ‹ / Auto Detect</option>
                                                        </select>
                                                    </td>
                                                    <td><a href="#" class="button remove-attribute-row">ç§»é™¤</a></td>
                                                </tr>
                                            <?php endfor; ?>
                                        </tbody>
                                    </table>

                                    <button type="button" class="button add-attribute-row" data-category-id="<?php echo $wc_cat->term_id; ?>">
                                        <span class="dashicons dashicons-plus"></span> æ·»åŠ å±æ€§
                                    </button>

                                    <!-- ä¿å­˜æŒ‰é’®åŒºåŸŸ -->
                                    <div class="save-section" id="save-section-<?php echo $wc_cat->term_id; ?>">
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e1e5e9; margin-top: 15px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                                <div>
                                                    <strong>ä¿å­˜æ­¤åˆ†ç±»çš„æ˜ å°„é…ç½®</strong>
                                                    <small style="display: block; color: #646970; margin-top: 2px;">
                                                        ä¿å­˜ "<?php echo esc_html($wc_cat->name); ?>" çš„æ²ƒå°”ç›åˆ†ç±»æ˜ å°„å’Œå±æ€§é…ç½®
                                                    </small>
                                                </div>
                                                <button type="button" class="button button-primary individual-save-btn" data-category-id="<?php echo $wc_cat->term_id; ?>">
                                                    <span class="dashicons dashicons-yes"></span> ä¿å­˜æ˜ å°„
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <?php endforeach; // ç»“æŸæœªæ˜ å°„åˆ†ç±»å¾ªç¯ ?>
                    </div>
                <?php endif; ?>

                <!-- å…¨å±€ä¿å­˜æŒ‰é’®ï¼ˆä¿ç•™ç”¨äºæ‰¹é‡ä¿å­˜ï¼‰ -->
                <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #e1e5e9; margin-left: 0; margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <strong>æ‰¹é‡ä¿å­˜æ‰€æœ‰æ˜ å°„</strong>
                            <small style="display: block; color: #646970; margin-top: 2px;">
                                ä¸€æ¬¡æ€§ä¿å­˜é¡µé¢ä¸Šæ‰€æœ‰åˆ†ç±»çš„æ˜ å°„é…ç½®
                            </small>
                        </div>
                        <input type="submit" class="button button-primary" value="ä¿å­˜æ‰€æœ‰æ˜ å°„" style="padding: 8px 20px;">
                    </div>
                </div>
            </form>
        </div>


        <script type="text/template" id="attribute-row-template">
            <tr>
                <td>
                    <input type="text" name="attributes[{wc_cat_id}][name][]" placeholder="ä¾‹å¦‚: brand" class="attribute-name-input">
                </td>
                <td>
                    <select name="attributes[{wc_cat_id}][type][]" class="attr-type-selector">
                        <option value="wc_attribute">WooCommerceå±æ€§</option>
                        <option value="default_value">é»˜è®¤å€¼</option>
                        <option value="auto_generate">è‡ªåŠ¨ç”Ÿæˆ</option>
                        <option value="walmart_field">æ²ƒå°”ç›å­—æ®µ</option>
                        <option value="attributes_field">Attributeså­—æ®µ</option>
                    </select>
                </td>
                <td class="source-cell">
                    <select name="attributes[{wc_cat_id}][source][]">
                        <?php foreach ($wc_attributes as $wc_attr) : ?>
                            <option value="<?php echo esc_attr($wc_attr); ?>"><?php echo esc_html($wc_attr); ?></option>
                        <?php endforeach; ?>
                    </select>
                </td>
                <td class="format-cell" style="display: none;">
                    <select name="attributes[{wc_cat_id}][format][]" class="data-format-selector" style="width: 100%;">
                        <option value="auto" selected>è‡ªåŠ¨æ£€æµ‹ / Auto Detect</option>
                    </select>
                </td>
                <td><a href="#" class="button remove-attribute-row">ç§»é™¤</a></td>
            </tr>
        </script>
        <script type="text/javascript">
    // ç¡®ä¿ajaxurlå¯ç”¨
    if (typeof ajaxurl === 'undefined') {
        var ajaxurl = '<?php echo admin_url('admin-ajax.php'); ?>';
    }

    // ç§»é™¤æ‰€æœ‰JavaScriptä¿®å¤å‡½æ•°

    // ç§»é™¤forceUniformSizeså‡½æ•°

    // ç§»é™¤fixPartialOverflowå‡½æ•°

    // ç§»é™¤forceFixInlineStyleså‡½æ•°

    // ç§»é™¤forceElementsIntoWpbodyContentå‡½æ•°

    // ç§»é™¤preventElementEscapeå‡½æ•°

    // ç§»é™¤æ‰€æœ‰è°ƒè¯•å’Œå¤æ‚é€»è¾‘ï¼Œé¿å…å¹²æ‰°æ­£å¸¸ç»“æ„

    // ğŸ”¥ å®Œå…¨ç§»é™¤æ‰€æœ‰JavaScriptä¿®å¤ - çº¯CSSè§£å†³æ–¹æ¡ˆ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ”¥ æ‰€æœ‰JavaScriptä¿®å¤å·²ç§»é™¤ï¼Œçº¯CSSè§£å†³æ–¹æ¡ˆ');
    });

    jQuery(document).ready(function($) {
        // ğŸš¨ å¼ºåˆ¶JavaScriptä¿®å¤å¯¹é½é—®é¢˜ - CSSæ— æ•ˆæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
        console.log('ğŸš¨ å¯åŠ¨JavaScriptå¼ºåˆ¶å¯¹é½ä¿®å¤...');

        function forceAlignment() {
            const containers = $('.walmart-category-group, .unmapped-categories-section');
            console.log(`æ‰¾åˆ° ${containers.length} ä¸ªå®¹å™¨ï¼Œå¼€å§‹å¼ºåˆ¶å¯¹é½...`);

            containers.each(function(index) {
                const $this = $(this);

                // å®Œå…¨é‡ç½®æ ·å¼
                this.style.cssText = '';

                // è·å–å½“å‰å·¦è¾¹è·ï¼Œè®¡ç®—éœ€è¦çš„è´Ÿè¾¹è·æ¥ç»Ÿä¸€åˆ°200px
                const rect = this.getBoundingClientRect();
                const currentLeft = rect.left;
                const targetLeft = 200;
                const marginAdjustment = targetLeft - currentLeft;

                // å¼ºåˆ¶åº”ç”¨ç»Ÿä¸€æ ·å¼ - ä½¿ç”¨ç›¸å¯¹å®šä½å’Œè´Ÿè¾¹è·ï¼Œå®½åº¦1660px
                this.style.setProperty('position', 'relative', 'important');
                this.style.setProperty('display', 'block', 'important');
                this.style.setProperty('width', '1660px', 'important');
                this.style.setProperty('max-width', '1660px', 'important');
                this.style.setProperty('min-width', '1660px', 'important');
                this.style.setProperty('margin', `0 0 20px ${marginAdjustment}px`, 'important');
                this.style.setProperty('padding', '0', 'important');
                this.style.setProperty('left', '0', 'important');
                this.style.setProperty('right', 'auto', 'important');
                this.style.setProperty('box-sizing', 'border-box', 'important');
                this.style.setProperty('overflow', 'hidden', 'important');
                this.style.setProperty('border-radius', '8px', 'important');
                this.style.setProperty('background', '#fff', 'important');
                this.style.setProperty('float', 'none', 'important');
                this.style.setProperty('clear', 'both', 'important');

                // æ ¹æ®ç±»å‹è®¾ç½®è¾¹æ¡†
                if (this.classList.contains('walmart-category-group')) {
                    this.style.setProperty('border', '2px solid #007cba', 'important');
                } else {
                    this.style.setProperty('border', '1px solid #ddd', 'important');
                }

                console.log(`âœ… å¼ºåˆ¶ä¿®å¤å®¹å™¨ ${index + 1}: ${this.className}`);
            });

            console.log('ğŸš¨ JavaScriptå¼ºåˆ¶å¯¹é½ä¿®å¤å®Œæˆï¼');
        }

        // ç«‹å³æ‰§è¡Œ
        forceAlignment();

        // å»¶è¿Ÿå†æ¬¡æ‰§è¡Œï¼Œç¡®ä¿è¦†ç›–ä»»ä½•åç»­çš„æ ·å¼
        setTimeout(forceAlignment, 500);
        setTimeout(forceAlignment, 1000);

        // ğŸ” è¯¦ç»†è°ƒè¯•ä¿¡æ¯ - æ‰¾å‡ºå®½åº¦å·®å¼‚çš„åŸå› 
        setTimeout(function() {
            const containers = $('.walmart-category-group, .unmapped-categories-section');
            console.log(`é¡µé¢ä¸Šå…±æœ‰ ${containers.length} ä¸ªåˆ†ç±»å®¹å™¨`);

            const widthMap = new Map();

            containers.each(function(index) {
                const $this = $(this);
                const width = $this.outerWidth();
                const innerWidth = $this.width();
                const left = $this.offset().left;
                const computedStyle = window.getComputedStyle(this);
                const hasInlineStyle = this.hasAttribute('style');
                const inlineStyle = hasInlineStyle ? this.getAttribute('style') : 'none';

                const rect = this.getBoundingClientRect();
                const rightEdge = rect.right;
                const windowWidth = window.innerWidth;
                const rightMargin = windowWidth - rightEdge;

                console.log(`ğŸ” å®¹å™¨ ${index + 1} è¯¦ç»†ä¿¡æ¯:`);
                console.log(`  - ç±»å: ${this.className}`);
                console.log(`  - å¤–éƒ¨å®½åº¦: ${width}px`);
                console.log(`  - å†…éƒ¨å®½åº¦: ${innerWidth}px`);
                console.log(`  - å·¦è¾¹è·: ${left}px`);
                console.log(`  - å³è¾¹è·: ${rightMargin}px`);
                console.log(`  - å³è¾¹ç•Œä½ç½®: ${rightEdge}px`);
                console.log(`  - CSSå®½åº¦: ${computedStyle.width}`);
                console.log(`  - CSSæœ€å¤§å®½åº¦: ${computedStyle.maxWidth}`);
                console.log(`  - CSSè¾¹è·: ${computedStyle.margin}`);
                console.log(`  - CSSå®šä½: ${computedStyle.position}`);
                console.log(`  - çˆ¶å…ƒç´ : ${this.parentElement ? this.parentElement.tagName + '.' + this.parentElement.className : 'none'}`);

                // ç»Ÿè®¡å®½åº¦åˆ†å¸ƒ
                if (widthMap.has(width)) {
                    widthMap.set(width, widthMap.get(width) + 1);
                } else {
                    widthMap.set(width, 1);
                }
            });

            console.log(`ğŸ“Š å®½åº¦åˆ†å¸ƒç»Ÿè®¡:`);
            widthMap.forEach((count, width) => {
                console.log(`  ${width}px: ${count}ä¸ªå®¹å™¨`);
            });

            if (widthMap.size > 1) {
                console.log(`âŒ å‘ç° ${widthMap.size} ç§ä¸åŒå®½åº¦ï¼éœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥`);
            } else {
                console.log(`âœ… æ‰€æœ‰å®¹å™¨å®½åº¦ä¸€è‡´ï¼`);
            }
        }, 1000);

        // åˆå§‹åŒ–å·²å­˜åœ¨çš„æ²ƒå°”ç›å­—æ®µé€‰æ‹©å™¨
        initializeExistingWalmartFields();

        // å»¶è¿Ÿå†æ¬¡åˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²åŠ è½½
        setTimeout(function() {
            initializeExistingWalmartFields();
        }, 500);

        function initializeExistingWalmartFields() {
            console.log('åˆå§‹åŒ–æ²ƒå°”ç›å­—æ®µé€‰æ‹©å™¨...');
            $('.walmart-field-selector').each(function() {
                var $select = $(this);
                var attributeName = $select.data('attribute-name');
                var currentValue = $select.data('current-value');
                var savedEnumValues = $select.data('enum-values');

                console.log('åˆå§‹åŒ–æ²ƒå°”ç›å­—æ®µ:', attributeName, 'å½“å‰å€¼:', currentValue, 'ä¿å­˜çš„æšä¸¾å€¼:', savedEnumValues);

                if (attributeName) {
                    var enumValues = null;

                    // ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„æšä¸¾å€¼
                    if (savedEnumValues) {
                        if (Array.isArray(savedEnumValues)) {
                            // å¦‚æœå·²ç»æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨
                            enumValues = savedEnumValues;
                            console.log('ä½¿ç”¨ä¿å­˜çš„æšä¸¾å€¼(æ•°ç»„):', enumValues);
                        } else if (typeof savedEnumValues === 'string') {
                            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
                            try {
                                enumValues = JSON.parse(savedEnumValues);
                                console.log('ä½¿ç”¨ä¿å­˜çš„æšä¸¾å€¼(è§£æ):', enumValues);
                            } catch (e) {
                                console.log('è§£æä¿å­˜çš„æšä¸¾å€¼å¤±è´¥:', e);
                            }
                        } else {
                            console.log('ä¿å­˜çš„æšä¸¾å€¼æ ¼å¼ä¸æ­£ç¡®:', typeof savedEnumValues, savedEnumValues);
                        }
                    }

                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æšä¸¾å€¼ï¼Œä»æ•°æ®åº“è·å–
                    if (!enumValues) {
                        console.log('æ²¡æœ‰ä¿å­˜çš„æšä¸¾å€¼ï¼Œä»æ•°æ®åº“è·å–:', attributeName);
                        getEnumValuesFromDatabase(attributeName, function(dbEnumValues) {
                            if (dbEnumValues && dbEnumValues.length > 0) {
                                console.log('ä»æ•°æ®åº“è·å–çš„æšä¸¾å€¼:', dbEnumValues);
                                loadWalmartFieldOptions($select, attributeName, currentValue, dbEnumValues);
                            } else {
                                console.log('æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°æšä¸¾å€¼ï¼Œä½¿ç”¨ç©ºé€‰é¡¹');
                                loadWalmartFieldOptions($select, attributeName, currentValue, null);
                            }
                        });
                    } else {
                        // ä½¿ç”¨ä¿å­˜çš„æšä¸¾å€¼
                        console.log('ä½¿ç”¨ä¿å­˜çš„æšä¸¾å€¼:', enumValues);
                        loadWalmartFieldOptions($select, attributeName, currentValue, enumValues);
                    }
                } else {
                    console.log('è­¦å‘Š: æ²ƒå°”ç›å­—æ®µé€‰æ‹©å™¨ç¼ºå°‘attribute-nameå±æ€§');
                }
            });
        }

        // æ ¹æ®å±æ€§åç§°è·å–æšä¸¾å€¼çš„å‡½æ•°
        function getEnumValuesForAttribute(attributeName) {
            // æ²ƒå°”ç›å­—æ®µæšä¸¾å€¼æ˜ å°„ï¼ˆä¸loadWalmartFieldOptionsä¸­çš„æ˜ å°„ä¿æŒä¸€è‡´ï¼‰
            var walmartFieldOptions = {
                // åŸºæœ¬å±æ€§
                'isProp65WarningRequired': ['Yes', 'No'],
                'has_written_warranty': ['Yes - Warranty Text', 'Yes - Warranty URL', 'No'],
                'condition': ['New', 'Open Box'],
                'currency': ['USD'],

                // å°ºå¯¸å•ä½
                'assembledProductLengthUnit': ['mm', 'ft', 'cm', 'in'],
                'assembledProductWidthUnit': ['mm', 'ft', 'cm', 'in'],
                'assembledProductHeightUnit': ['mm', 'ft', 'cm', 'in'],
                'assembledProductWeightUnit': ['kg', 'lb', 'oz'],

                // è¿è¾“å•ä½
                'shippingWeightUnit': ['kg', 'lb', 'oz'],
                'shippingLengthUnit': ['mm', 'ft', 'cm', 'in'],
                'shippingWidthUnit': ['mm', 'ft', 'cm', 'in'],
                'shippingHeightUnit': ['mm', 'ft', 'cm', 'in'],

                // å‡€å«é‡å•ä½
                'productNetContentUnit': ['Count', 'Inch', 'Pint', 'Liter', 'Gallon', 'Ounce', 'Pound', 'Fluid Ounces', 'Each'],

                // ä»·æ ¼å•ä½
                'pricePerUnitUom': ['Each', 'Ounce', 'Pound', 'Gallon', 'Liter', 'Count', 'Cubic Foot', 'Square Foot'],

                // å®¶å±…å¨æˆ¿
                'dishwasherSafe': ['Yes', 'No'],
                'microwaveSafe': ['Yes', 'No'],

                // å©´å„¿ç”¨å“
                'bpaFree': ['Yes', 'No'],
                'ageGroup': ['Teen', 'Tween', 'Adult', 'Child', 'Baby', 'Toddler'],
                'safetyFeatures': ['Foldable', 'Adjustable Height', 'Safety Lock'],

                // æœè£…
                'gender': ['Unisex', 'Male', 'Female'],

                // é€šç”¨å±æ€§
                'colorCategory': ['Blue', 'Brown', 'Gold', 'Green', 'Red', 'Black', 'White', 'Yellow', 'Purple', 'Orange', 'Pink', 'Gray'],
                'sizeDescriptor': ['Compact', 'Large', 'Medium', 'Small', 'Extra Large'],
                'retailPackaging': ['Set', 'Kit'],
                'isPrimaryVariant': ['Yes', 'No'],

                // å˜ä½“å±æ€§
                'variantAttributeNames': ['color', 'assembledProductWidth', 'multipackQuantity', 'size', 'count', 'assembledProductHeight'],

                // è­¦å‘Šå’Œè®¤è¯
                'smallPartsWarnings': ['0 - No warning applicable', '5 - Choking hazard is a marble', '4 - Choking hazard balloon'],
                'thirdPartyAccreditationSymbolOnProductPackageCode': ['CAC Absence of Peanut', 'For Life (Social Responsibility)', 'Certified California Sustainable Vineyard and Winery (CCSW)'],

                // V5.0æ–°å¢çš„é‡è¦å±æ€§
                'SkuUpdate': ['Yes', 'No'],
                'ProductIdUpdate': ['Yes', 'No'],
                'chemicalAerosolPesticide': ['Yes', 'No'],
                'batteryTechnologyType': ['Mercury', 'Carbon Zinc', 'Lead Acid (Non-Spillable)', 'Alkaline', 'Does Not Contain a Battery', 'Lithium Primary (Lithium Metal)', 'Nickel Cadmium', 'Lithium Ion', 'Nickel Metal Hydride', 'Lead Acid', 'Silver', 'Magnesium'],
                'features': ['Lighted Headboard', 'Under Bed Storage', 'Nailhead Trim', 'USB Port', 'Tufted'],
                'has_storage': ['Yes', 'No'],
                'has_trundle': ['Yes', 'No'],
                'homeDecorStyle': ['Mid-Century', 'Tropical', 'Eclectic', 'Glam', 'Cottage', 'Minimalist', 'Transitional', 'Rustic/Lodge', 'Scandinavian', 'Traditional', 'Victorian', 'Bohemian', 'Asian Inspired', 'Farmhouse', 'Industrial', 'French Country', 'Modern', 'Contemporary', 'Shabby Chic', 'Coastal', 'Southwestern', 'Art Deco'],
                'isAssemblyRequired': ['Yes', 'No'],
                'IsPreorder': ['Yes', 'No'],
                'isPrimaryVariant': ['Yes', 'No'],
                'MustShipAlone': ['Yes', 'No'],
                'ProductIdUpdate': ['Yes', 'No'],
                'shipsInOriginalPackaging': ['Yes', 'No'],
                'MustShipAlone': ['Yes', 'No'],
                'IsPreorder': ['Yes', 'No'],
                'assemblyRequired': ['Yes', 'No'],

                // æ—…è¡Œå’Œå®‰å…¨ç›¸å…³
                'isTsaApproved': ['Yes', 'No'],
                'isFireRetardant': ['Yes', 'No'],
                'isWaterproof': ['Yes', 'No'],
                'isWaterResistant': ['Yes', 'No'],

                // å¸¸è§çš„Yes/Noå­—æ®µ
                'isAssemblyRequired': ['Yes', 'No'],
                'inflexKitComponent': ['Yes', 'No'],
                'isPortable': ['Yes', 'No'],
                'isReusable': ['Yes', 'No'],
                'isRecyclable': ['Yes', 'No']
            };

            return walmartFieldOptions[attributeName] || null;
        }

        // ä»æ•°æ®åº“è·å–å±æ€§æšä¸¾å€¼çš„å‡½æ•°
        function getEnumValuesFromDatabase(attributeName, callback) {
            // è·å–å½“å‰é¡µé¢çš„æ²ƒå°”ç›åˆ†ç±»
            var walmartCategory = getCurrentWalmartCategory();

            if (!walmartCategory) {
                console.log('æ— æ³•ç¡®å®šå½“å‰æ²ƒå°”ç›åˆ†ç±»');
                callback(null);
                return;
            }

            console.log('ä»æ•°æ®åº“è·å–æšä¸¾å€¼:', attributeName, 'åˆ†ç±»:', walmartCategory);

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'get_attribute_enum_values',
                    attribute_name: attributeName,
                    walmart_category: walmartCategory,
                    nonce: '<?php echo wp_create_nonce('walmart_enum_values_nonce'); ?>'
                },
                success: function(response) {
                    if (response.success && response.data && response.data.length > 0) {
                        console.log('æˆåŠŸè·å–æ•°æ®åº“æšä¸¾å€¼:', response.data);
                        callback(response.data);
                    } else {
                        console.log('æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°æšä¸¾å€¼:', response);
                        callback(null);
                    }
                },
                error: function(xhr, status, error) {
                    console.log('è·å–æ•°æ®åº“æšä¸¾å€¼å¤±è´¥:', error);
                    callback(null);
                }
            });
        }

        // è·å–å½“å‰æ²ƒå°”ç›åˆ†ç±»çš„å‡½æ•°
        function getCurrentWalmartCategory() {
            // å°è¯•ä»é¡µé¢ä¸­çš„å„ç§ä½ç½®è·å–æ²ƒå°”ç›åˆ†ç±»
            var category = null;

            // æ–¹æ³•1: ä»åˆ†ç±»ç»„æ ‡é¢˜è·å–
            $('.walmart-category-group-header h3').each(function() {
                var text = $(this).text();
                var match = text.match(/æ²ƒå°”ç›åˆ†ç±»:\s*(.+)/);
                if (match) {
                    category = match[1].trim();
                    return false; // è·³å‡ºå¾ªç¯
                }
            });

            // æ–¹æ³•2: ä»é€‰æ‹©å™¨è·å–
            if (!category) {
                $('.walmart-category-value').each(function() {
                    var val = $(this).val();
                    if (val) {
                        category = val;
                        return false;
                    }
                });
            }

            // æ–¹æ³•3: ä»URLå‚æ•°è·å–
            if (!category) {
                var urlParams = new URLSearchParams(window.location.search);
                category = urlParams.get('walmart_category');
            }

            return category;
        }



        // å±•å¼€/æ”¶ç¼©å•ä¸ªå±æ€§åŒºåŸŸ
        $(document).on('click', '.toggle-attributes-btn', function() {
            var $btn = $(this);
            var categoryId = $btn.data('category-id');
            var $table = $('#attributes-table-' + categoryId);
            var $saveSection = $('#save-section-' + categoryId);
            var $btnText = $btn.find('.btn-text');
            var $icon = $btn.find('.dashicons');

            if ($table.hasClass('expanded')) {
                // æ”¶ç¼©
                $table.removeClass('expanded');
                $saveSection.removeClass('show');
                $btn.removeClass('expanded');
                $btnText.text('å±•å¼€å±æ€§');
                $icon.removeClass('dashicons-arrow-up-alt2').addClass('dashicons-arrow-down-alt2');
            } else {
                // å±•å¼€
                $table.addClass('expanded');
                $saveSection.addClass('show');
                $btn.addClass('expanded');
                $btnText.text('æ”¶ç¼©å±æ€§');
                $icon.removeClass('dashicons-arrow-down-alt2').addClass('dashicons-arrow-up-alt2');
            }
        });

        // å±•å¼€æ‰€æœ‰å±æ€§
        $('#expand-all-attributes').on('click', function() {
            $('.attributes-container').addClass('expanded');
            $('.individual-save-section').addClass('show');
            $('.toggle-attributes-btn').addClass('expanded');
            $('.toggle-attributes-btn .btn-text').text('æ”¶ç¼©å±æ€§');
            $('.toggle-attributes-btn .dashicons').removeClass('dashicons-arrow-down-alt2').addClass('dashicons-arrow-up-alt2');
        });

        // æ”¶ç¼©æ‰€æœ‰å±æ€§
        $('#collapse-all-attributes').on('click', function() {
            $('.attributes-container').removeClass('expanded');
            $('.individual-save-section').removeClass('show');
            $('.toggle-attributes-btn').removeClass('expanded');
            $('.toggle-attributes-btn .btn-text').text('å±•å¼€å±æ€§');
            $('.toggle-attributes-btn .dashicons').removeClass('dashicons-arrow-up-alt2').addClass('dashicons-arrow-down-alt2');
        });

        // å•ä¸ªåˆ†ç±»ä¿å­˜åŠŸèƒ½
        $(document).on('click', '.individual-save-btn', function() {
            var $btn = $(this);
            var categoryId = $btn.data('category-id');

            // æ”¯æŒæ™®é€šæ˜ å°„å’Œå…±äº«æ˜ å°„ä¸¤ç§ç»“æ„
            var $categoryRow = $('.category-row[data-category-id="' + categoryId + '"]');
            var $sharedMapper = $('.attribute-mapper[data-wc-cat-id="' + categoryId + '"]');
            var isSharedMapping = $sharedMapper.length > 0 && $categoryRow.length === 0;

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $btn.prop('disabled', true);
            var originalHtml = $btn.html();
            $btn.html('<span class="dashicons dashicons-update spin"></span> ä¿å­˜ä¸­...');

            // æ”¶é›†è¯¥åˆ†ç±»çš„æ•°æ®
            var formData = new FormData();
            formData.append('action', 'save_category_mapping');
            formData.append('_wpnonce', $('input[name="_wpnonce"]').val());

            // Walmartåˆ†ç±»
            var walmartCategory = '';
            var attributeRows = null;

            if (isSharedMapping) {
                // å…±äº«æ˜ å°„ç»“æ„
                var treeSelector = $sharedMapper.find('.walmart-category-tree-selector');
                if (treeSelector.length > 0) {
                    walmartCategory = treeSelector.find('.walmart-category-value').val();
                } else {
                    // ä»é¡µé¢å¤´éƒ¨è·å–åˆ†ç±»ä¿¡æ¯
                    var groupHeader = $sharedMapper.closest('.walmart-category-group').find('.walmart-category-group-header h3');
                    if (groupHeader.length > 0) {
                        var headerText = groupHeader.text();
                        var match = headerText.match(/Walmartåˆ†ç±»:\s*(.+)$/);
                        if (match) {
                            walmartCategory = match[1].trim();
                        }
                    }
                }
                attributeRows = $sharedMapper.find('.attributes-container tbody tr');
            } else {
                // æ™®é€šæ˜ å°„ç»“æ„
                walmartCategory = $categoryRow.find('.walmart-category-tree-selector .walmart-category-value').val();
                attributeRows = $categoryRow.find('.attributes-container tbody tr');
            }

            if (walmartCategory) {
                formData.append('walmart_category[' + categoryId + ']', walmartCategory);
            }

            // å±æ€§æ•°æ® - é‡æ–°æ•´ç†æ•°ç»„ç´¢å¼•ç¡®ä¿è¿ç»­
            var attributeData = {
                name: [],
                type: [],
                source: [],
                attributes_key: [],
                format: []
            };

            // æ”¶é›†æ‰€æœ‰å±æ€§è¡Œçš„æ•°æ®ï¼Œé‡æ–°åˆ†é…è¿ç»­ç´¢å¼•
            attributeRows.each(function(newIndex) {
                var $row = $(this);
                var name = $row.find('input[name*="[name]"]').val();
                var type = $row.find('select[name*="[type]"]').val();
                var source = '';
                var attributesKey = '';

                // è·å–sourceå€¼ï¼ˆå¯èƒ½æ˜¯inputæˆ–selectï¼‰
                var sourceInput = $row.find('input[name*="[source]"]');
                var sourceSelect = $row.find('select[name*="[source]"]');
                if (sourceInput.length > 0) {
                    source = sourceInput.val();
                } else if (sourceSelect.length > 0) {
                    source = sourceSelect.val();
                }

                // è·å–attributes_keyå€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                var attributesKeyInput = $row.find('input[name*="[attributes_key]"]');
                if (attributesKeyInput.length > 0) {
                    attributesKey = attributesKeyInput.val();
                }

                // è·å–formatå€¼
                var format = $row.find('select[name*="[format]"]').val() || '';

                // åªæ·»åŠ éç©ºçš„å±æ€§å
                if (name && name.trim()) {
                    attributeData.name.push(name);
                    attributeData.type.push(type || 'default_value');
                    attributeData.source.push(source || '');
                    attributeData.attributes_key.push(attributesKey || '');
                    attributeData.format.push(format);
                }
            });

            // å°†é‡æ–°æ•´ç†çš„æ•°æ®æ·»åŠ åˆ°FormData
            attributeData.name.forEach(function(value, index) {
                formData.append('attributes[' + categoryId + '][name][' + index + ']', value);
                formData.append('attributes[' + categoryId + '][type][' + index + ']', attributeData.type[index]);
                formData.append('attributes[' + categoryId + '][source][' + index + ']', attributeData.source[index]);
                formData.append('attributes[' + categoryId + '][attributes_key][' + index + ']', attributeData.attributes_key[index]);
                formData.append('attributes[' + categoryId + '][format][' + index + ']', attributeData.format[index]);
            });

            console.log('é‡æ–°æ•´ç†å±æ€§æ•°æ®:', attributeData);

            // å¿…å¡«çº§åˆ«ã€å±æ€§åˆ†ç»„å’Œæšä¸¾å€¼æ•°æ® - ä¸å±æ€§æ•°æ®ä¿æŒåŒæ­¥
            var requiredLevels = [];
            var attributeGroups = [];
            var enumValues = [];

            attributeRows.each(function(newIndex) {
                var $row = $(this);
                var name = $row.find('input[name*="[name]"]').val();

                // åªå¤„ç†æœ‰æ•ˆçš„å±æ€§è¡Œ
                if (name && name.trim()) {
                    var requiredLevel = $row.find('input[name*="required_levels"]').val() || '';
                    var attributeGroup = $row.find('input[name*="attribute_groups"]').val() || '';
                    var enumValue = $row.find('input[name*="enum_values"]').val() || '';

                    requiredLevels.push(requiredLevel);
                    attributeGroups.push(attributeGroup);
                    enumValues.push(enumValue);
                }
            });

            // æ·»åŠ åˆ°FormData
            requiredLevels.forEach(function(value, index) {
                formData.append('required_levels[' + categoryId + '][' + index + ']', value);
            });
            attributeGroups.forEach(function(value, index) {
                formData.append('attribute_groups[' + categoryId + '][' + index + ']', value);
            });
            enumValues.forEach(function(value, index) {
                formData.append('enum_values[' + categoryId + '][' + index + ']', value);
            });

            console.log('æ”¶é›†çš„æšä¸¾å€¼æ•°æ®:', enumValues);

            // å‘é€AJAXè¯·æ±‚
            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showNotification('åˆ†ç±»æ˜ å°„ä¿å­˜æˆåŠŸï¼', 'success');

                        // æ›´æ–°åˆ†ç±»å¤´éƒ¨çš„æ˜ å°„çŠ¶æ€æ˜¾ç¤º
                        updateCategoryMappingStatus(categoryId, walmartCategory);

                        // ä¿å­˜æˆåŠŸååˆ·æ–°é¡µé¢ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„æ•°æ®
                        setTimeout(function() {
                            console.log('ä¿å­˜æˆåŠŸï¼Œåˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®');
                            window.location.reload();
                        }, 1000);
                    } else {
                        showNotification('ä¿å­˜å¤±è´¥: ' + (response.data || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error, 'error');
                },
                complete: function() {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    $btn.prop('disabled', false);
                    $btn.html(originalHtml);
                }
            });
        });

        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type) {
            var bgColor = type === 'success' ? '#00a32a' : '#d63638';
            var notification = $('<div style="position: fixed; top: 32px; right: 20px; background: ' + bgColor + '; color: white; padding: 12px 20px; border-radius: 4px; z-index: 9999; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">' + message + '</div>');
            $('body').append(notification);

            setTimeout(function() {
                notification.fadeOut(function() {
                    notification.remove();
                });
            }, 3000);
        }

        // æ›´æ–°åˆ†ç±»æ˜ å°„çŠ¶æ€æ˜¾ç¤º
        function updateCategoryMappingStatus(categoryId, walmartCategoryId) {
            if (!walmartCategoryId) return;

            var $categoryRow = $('.category-row[data-category-id="' + categoryId + '"]');
            var $meta = $categoryRow.find('.category-meta');
            var $treeSelector = $categoryRow.find('.walmart-category-tree-selector');
            var walmartCategoryName = $treeSelector.find('.selected-category').text();

            // ç§»é™¤æ—§çš„æ˜ å°„çŠ¶æ€
            $meta.find('.mapping-status').remove();

            // æ·»åŠ æ–°çš„æ˜ å°„çŠ¶æ€
            $meta.append(' | <span class="mapping-status">å·²æ˜ å°„åˆ°: <span style="color: #00a32a; font-weight: 500;">' + walmartCategoryName + '</span></span>');
        }

        // æ›´æ–°å±æ€§æ•°é‡æ˜¾ç¤º
        function updateAttributeCount(mapperDiv) {
            var $header = mapperDiv.find('.attribute-mapper-title');
            var $tbody = mapperDiv.find('.attributes-container tbody');
            var attributeCount = $tbody.find('tr').length;

            // ç§»é™¤æ—§çš„è®¡æ•°æ˜¾ç¤º
            $header.find('.attribute-count').remove();

            // æ·»åŠ æ–°çš„è®¡æ•°æ˜¾ç¤º
            if (attributeCount > 0) {
                $header.append(' <span class="attribute-count" style="color: #646970; font-weight: normal; font-size: 13px;">(å·²é…ç½® ' + attributeCount + ' ä¸ªå±æ€§)</span>');
            }
        }











        // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœåˆ†ç±»å·²æœ‰å±æ€§é…ç½®ï¼Œè‡ªåŠ¨å±•å¼€
        $('.attributes-container tbody tr').each(function() {
            var $tbody = $(this).closest('tbody');
            var $table = $tbody.closest('.attributes-container');
            var categoryId = $table.attr('id').replace('attributes-table-', '');

            // æ³¨é‡Šæ‰è‡ªåŠ¨å±•å¼€é€»è¾‘ï¼Œæ”¹ä¸ºé»˜è®¤æ”¶ç¼©
            // if ($tbody.find('tr').length > 0) {
            //     // æœ‰å±æ€§é…ç½®ï¼Œè‡ªåŠ¨å±•å¼€
            //     $table.addClass('expanded');
            //     $('#save-section-' + categoryId).addClass('show');
            //     $('.toggle-attributes-btn[data-category-id="' + categoryId + '"]').addClass('expanded');
            //     $('.toggle-attributes-btn[data-category-id="' + categoryId + '"] .btn-text').text('æ”¶ç¼©å±æ€§');
            //     $('.toggle-attributes-btn[data-category-id="' + categoryId + '"] .dashicons').removeClass('dashicons-arrow-down-alt2').addClass('dashicons-arrow-up-alt2');
            // }
        });



        // å¤„ç†æ–¹å¼è¯´æ˜
        $('#process_method').on('change', function() {
            var method = $(this).val();
            var batchSize = parseInt($('#batch_size').val());
            var $form = $(this).closest('form');

            // ç§»é™¤ä¹‹å‰çš„æç¤º
            $form.find('.method-tip').remove();

            var tip = '';
            if (method === 'batch_feed') {
                if (batchSize < 10) {
                    tip = '<div class="method-tip" style="color: #856404; font-size: 12px; margin-top: 5px;">âš ï¸ æ‰¹é‡Feedé€‚åˆ10ä¸ªä»¥ä¸Šå•†å“ï¼Œå½“å‰æ•°é‡è¾ƒå°‘</div>';
                } else {
                    tip = '<div class="method-tip" style="color: #155724; font-size: 12px; margin-top: 5px;">âœ… æ‰¹é‡Feedå¤„ç†ï¼Œæ•ˆç‡æ›´é«˜ï¼Œé¿å…APIé™åˆ¶</div>';
                }
            } else {
                if (batchSize >= 10) {
                    tip = '<div class="method-tip" style="color: #856404; font-size: 12px; margin-top: 5px;">âš ï¸ å•†å“è¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨æ‰¹é‡Feedå¤„ç†</div>';
                } else {
                    tip = '<div class="method-tip" style="color: #155724; font-size: 12px; margin-top: 5px;">âœ… å•ä¸ªAPIå¤„ç†ï¼Œé€‚åˆå°‘é‡å•†å“</div>';
                }
            }

            if (tip) {
                $form.find('.batch-control').append(tip);
            }
        });

        // è§¦å‘åˆå§‹æç¤º
        $('#batch_size').trigger('change');
        $('#process_method').trigger('change');
        // é¡µé¢åŠ è½½æ—¶ï¼Œç¡®ä¿æ‰€æœ‰ auto_generate ç±»å‹çš„å­—æ®µéƒ½æœ‰æ­£ç¡®çš„ hidden è¾“å…¥
        // ä½†ä¸è¦è¦†ç›–ç”¨æˆ·å·²ç»è®¾ç½®çš„å€¼
        $('.attr-type-selector').each(function() {
            if ($(this).val() === 'auto_generate') {
                var $row = $(this).closest('tr');
                var sourceCell = $row.find('.source-cell');
                var wcCatId = $(this).closest('.attribute-mapper').data('wc-cat-id');
                var selectName = 'attributes[' + wcCatId + '][source][]';
                var attributeName = $row.find('input[name*="[name]"]').val();

                // åªæœ‰å½“source-cellå®Œå…¨ä¸ºç©ºæ—¶æ‰è®¾ç½®è‡ªåŠ¨ç”Ÿæˆè§„åˆ™
                // å¦‚æœæœ‰ä»»ä½•å†…å®¹ï¼ˆæ–‡æœ¬ã€è¾“å…¥æ¡†ã€é€‰æ‹©å™¨ï¼‰ï¼Œéƒ½ä¸è¦è¦†ç›–
                var hasContent = sourceCell.find('input, select').length > 0 ||
                                sourceCell.text().trim().length > 0;

                if (!hasContent) {
                    var generationRule = getAutoGenerationRule(attributeName);
                    sourceCell.html('<span style="color: #0073aa; font-weight: 500;">' + generationRule + '</span><input type="hidden" name="' + selectName + '" value="auto">');
                    console.log('é¡µé¢åŠ è½½ - è®¾ç½®ç©ºç™½è‡ªåŠ¨ç”Ÿæˆå­—æ®µ:', attributeName);
                } else {
                    console.log('é¡µé¢åŠ è½½ - è·³è¿‡å·²æœ‰å†…å®¹çš„å­—æ®µ:', attributeName, 'å†…å®¹:', sourceCell.html().substring(0, 50));
                }
            }
        });

        // é¡µé¢åŠ è½½æ—¶ï¼Œä¸ºç°æœ‰çš„å±æ€§åç§°è¾“å…¥æ¡†æ·»åŠ class
        $('input[name*="[name]"]').each(function() {
            $(this).addClass('attribute-name-input');
        });

        // æ·»åŠ è¡Œ
        $('body').on('click', '.add-attribute-row', function(e) {
            e.preventDefault();
            // ä¿®æ­£ï¼šä»dataå±æ€§è·å–åˆ†ç±»ID
            var wcCatId = $(this).data('category-id');
            if (!wcCatId) {
                // å¤‡ç”¨æ–¹æ³•ï¼šä»çˆ¶çº§å…ƒç´ è·å–
                wcCatId = $(this).closest('.attribute-mapper').data('wc-cat-id');
            }
            if (!wcCatId) {
                alert('å‘ç”Ÿé”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°åˆ†ç±»IDã€‚');
                return;
            }

            var template = $('#attribute-row-template').html().replace(/{wc_cat_id}/g, wcCatId);
            var $newRow = $(template); // å°†æ–°è¡Œè½¬ä¸ºjQueryå¯¹è±¡

            // å°†æ–°è¡Œæ·»åŠ åˆ°è¡¨æ ¼ä¸­
            $('#attributes-table-' + wcCatId + ' tbody').append($newRow);

            // å…³é”®ä¿®æ­£ï¼šæ‰‹åŠ¨è§¦å‘æ–°è¡Œä¸­ä¸‹æ‹‰æ¡†çš„changeäº‹ä»¶ï¼Œä»¥æ­£ç¡®ç”Ÿæˆç¬¬ä¸‰ä¸ªå•å…ƒæ ¼
            $newRow.find('.attr-type-selector').trigger('change');

            // ç¡®ä¿å±æ€§è¡¨æ ¼æ˜¯å±•å¼€çŠ¶æ€
            var $table = $('#attributes-table-' + wcCatId);
            if (!$table.hasClass('expanded')) {
                $('.toggle-attributes-btn[data-category-id="' + wcCatId + '"]').trigger('click');
            }
        });


        // ç§»é™¤è¡Œ
        $('body').on('click', '.remove-attribute-row', function(e) {
            e.preventDefault();
            $(this).closest('tr').remove();
        });

        // æ—§çš„ç¡¬ç¼–ç å¿…å¡«æ£€æŸ¥é€»è¾‘å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨æ•°æ®åº“é©±åŠ¨çš„å¿…å¡«çº§åˆ«ç³»ç»Ÿ

        // åŠ¨æ€åˆ‡æ¢æºç±»å‹
        $('body').on('change', '.attr-type-selector', function() {
            var selector = $(this);
            var $row = selector.closest('tr');
            var sourceCell = $row.find('.source-cell');
            var newType = selector.val();

            // ç§»é™¤ç‰¹æ®Šç±»å‹å¤„ç†é€»è¾‘ - è®©è‡ªåŠ¨æ£€æµ‹é€»è¾‘å¤„ç†æ‰€æœ‰æ ¼å¼

            // ä¿®æ­£ï¼šä»æ­£ç¡®çš„çˆ¶çº§å…ƒç´ è·å– wcCatId
            var wcCatId = selector.closest('.attribute-mapper').data('wc-cat-id');
            var selectName = 'attributes[' + wcCatId + '][source][]';

            // è·å–å½“å‰çš„sourceå€¼ï¼Œä»¥ä¾¿åœ¨åˆ‡æ¢ç±»å‹æ—¶ä¿ç•™
            var currentValue = '';
            var currentInput = sourceCell.find('input, select');
            if (currentInput.length > 0) {
                currentValue = currentInput.val() || '';
            }

            if (newType === 'wc_attribute') {
                var wc_attr_select = $('<select name="' + selectName + '"></select>');
                var wc_attrs = <?php echo json_encode(array_values($wc_attributes)); ?>; // ç¡®ä¿æ˜¯çº¯æ•°ç»„
                wc_attrs.forEach(function(wc_attr) {
                    var option = $('<option></option>').attr('value', wc_attr).text(wc_attr);
                    // åªæœ‰å½“å‰å€¼ç¡®å®æ˜¯WooCommerceå±æ€§æ—¶æ‰ä¿ç•™é€‰æ‹©
                    if (wc_attrs.includes(currentValue) && wc_attr === currentValue) {
                        option.prop('selected', true);
                    }
                    wc_attr_select.append(option);
                });
                sourceCell.html(wc_attr_select);
            } else if (newType === 'auto_generate') {
                // è·å–å±æ€§åç§°æ¥æ˜¾ç¤ºå…·ä½“çš„ç”Ÿæˆè§„åˆ™
                var attributeName = $row.find('input[name*="[name]"]').val();
                var generationRule = getAutoGenerationRule(attributeName);
                sourceCell.html('<span style="color: #0073aa; font-weight: 500;">' + generationRule + '</span><input type="hidden" name="' + selectName + '" value="auto">');
            } else if (newType === 'walmart_field') {
                // æ²ƒå°”ç›å­—æ®µç±»å‹ï¼šåˆ›å»ºé€‰æ‹©å™¨å¹¶åŠ è½½æšä¸¾å€¼
                var walmart_field_select = $('<select name="' + selectName + '" class="walmart-field-selector"></select>');
                walmart_field_select.append('<option value="">é€‰æ‹©æ²ƒå°”ç›å­—æ®µå€¼</option>');

                // è·å–å½“å‰å±æ€§åç§°ä»¥æŸ¥æ‰¾å¯¹åº”çš„æšä¸¾å€¼
                var attributeName = selector.closest('tr').find('.attribute-name-input').val();
                var enumValues = selector.data('enum-values') || getEnumValuesForAttribute(attributeName);
                loadWalmartFieldOptions(walmart_field_select, attributeName, currentValue, enumValues);

                sourceCell.html(walmart_field_select);
            } else if (newType === 'attributes_field') {
                // Attributeså­—æ®µç±»å‹ï¼šåˆ›å»ºåŒé‡è¾“å…¥ç•Œé¢
                var attributeName = $row.find('input[name*="[name]"]').val();
                var attributesFieldHtml =
                    '<div class="attributes-field-container" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;">' +
                        '<div style="margin-bottom: 8px;">' +
                            '<label style="font-weight: bold; color: #333; font-size: 12px;">ä¼˜å…ˆä»Attributeså­—æ®µè·å–:</label>' +
                            '<input type="text" name="' + selectName.replace('source', 'attributes_key') + '" ' +
                                   'placeholder="è¾“å…¥Attributesä¸­çš„å­—æ®µåï¼ˆå¦‚: ' + attributeName + 'ï¼‰" ' +
                                   'style="width: 100%; margin-top: 3px;" class="attributes-key-input">' +
                        '</div>' +
                        '<div>' +
                            '<label style="font-weight: bold; color: #666; font-size: 12px;">å¤‡ç”¨é»˜è®¤å€¼:</label>' +
                            '<input type="text" name="' + selectName + '" ' +
                                   'placeholder="å½“Attributeså­—æ®µä¸å­˜åœ¨æ—¶ä½¿ç”¨æ­¤é»˜è®¤å€¼" ' +
                                   'style="width: 100%; margin-top: 3px;" class="attributes-fallback-input">' +
                        '</div>' +
                        '<div style="margin-top: 5px; font-size: 11px; color: #666;">' +
                            'ğŸ’¡ ç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨äº§å“Attributesä¸­çš„"<span class="attr-key-preview">' + attributeName + '</span>"å­—æ®µå€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å¤‡ç”¨é»˜è®¤å€¼' +
                        '</div>' +
                    '</div>';

                sourceCell.html(attributesFieldHtml);

                // ç›‘å¬Attributeså­—æ®µåè¾“å…¥ï¼Œå®æ—¶æ›´æ–°æç¤º
                sourceCell.find('.attributes-key-input').on('input', function() {
                    var keyValue = $(this).val() || attributeName;
                    sourceCell.find('.attr-key-preview').text(keyValue);
                });
            } else {
                // default_value ç±»å‹ï¼šä¿ç•™ç”¨æˆ·è¾“å…¥çš„å€¼ï¼Œé™¤éæ˜¯ç³»ç»Ÿè‡ªåŠ¨å€¼
                var wc_attrs = <?php echo json_encode(array_values($wc_attributes)); ?>;
                var defaultValue = '';

                // ä¿ç•™ç”¨æˆ·è¾“å…¥çš„å€¼ï¼Œé™¤éæ˜¯'auto'æˆ–WooCommerceå±æ€§ID
                if (currentValue && currentValue !== 'auto' && !wc_attrs.includes(currentValue)) {
                    defaultValue = currentValue;
                } else if (currentValue === 'auto') {
                    // å¦‚æœä¹‹å‰æ˜¯autoï¼Œæ¸…ç©ºè®©ç”¨æˆ·é‡æ–°è¾“å…¥
                    defaultValue = '';
                }

                sourceCell.html('<input type="text" name="' + selectName + '" value="' + defaultValue + '" placeholder="è¾“å…¥é»˜è®¤å€¼">');
            }
        });

        // è·å–è‡ªåŠ¨ç”Ÿæˆè§„åˆ™çš„å‡½æ•°
        function getAutoGenerationRule(attributeName) {
            var rules = {
                'productName': 'ä½¿ç”¨äº§å“æ ‡é¢˜',
                'brand': 'ä½¿ç”¨äº§å“å“ç‰Œï¼Œæ— å“ç‰Œæ—¶ä½¿ç”¨"Unbranded"',
                'shortDescription': 'ä½¿ç”¨äº§å“å®Œæ•´æè¿°',
                'keyFeatures': 'ä¼˜å…ˆä½¿ç”¨ç®€çŸ­æè¿°çš„ç‰¹è‰²åˆ—è¡¨ï¼Œå¦åˆ™ä»äº§å“æè¿°å’Œæ ‡é¢˜æ™ºèƒ½ç”Ÿæˆ3-5ä¸ªç‰¹è‰²',
                'mainImageUrl': 'è¯»å–äº§å“ä¸»å›¾ï¼ˆæ”¯æŒè¿œç¨‹URLå’Œæœ¬åœ°å›¾ç‰‡ï¼‰',
                'material': 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Main Materialï¼Œå¦åˆ™ä»æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–',
                'bed_frame_type': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«åºŠæ¶ç±»å‹ï¼Œé»˜è®¤ä¸ºStandard Bed Frames',
                'bedSize': 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§bedSizeï¼Œå¦åˆ™é»˜è®¤ä¸ºNon-Standard',
                'assembledProductLength': 'ä»äº§å“å±æ€§Product Sizeæå–é•¿åº¦å€¼ï¼Œé»˜è®¤1 in',
                'assembledProductWidth': 'ä»äº§å“å±æ€§Product Sizeæå–å®½åº¦å€¼ï¼Œé»˜è®¤1 in',
                'assembledProductHeight': 'ä»äº§å“å±æ€§Product Sizeæå–é«˜åº¦å€¼ï¼Œé»˜è®¤1 in',
                'assembledProductWeight': 'ä»äº§å“å±æ€§Product Weightæå–é‡é‡å€¼ï¼Œé»˜è®¤1 lb',
                'productSecondaryImageURL': 'è¯»å–äº§å“é™„åŠ å›¾ç‰‡ï¼ˆä¼˜å…ˆè¿œç¨‹URLï¼Œå¦åˆ™æœ¬åœ°å›¾ç‰‡ï¼‰',
                'productIdentifiers': 'è‡ªåŠ¨ç”ŸæˆUPCäº§å“æ ‡è¯†ç¬¦ï¼ˆé»˜è®¤UPCç±»å‹ï¼‰',
                'netContent': 'æ•°å€¼ä¸º1ï¼Œé»˜è®¤å•ä½ä¸ºCount',
                'box_spring_required': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦éœ€è¦å¼¹ç°§åºŠå«ï¼Œé»˜è®¤ä¸ºNo',
                'color': 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Main Colorï¼Œå¦åˆ™ä»æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–ï¼Œæ— æ³•æå–åˆ™ç•™ç©º',
                'colorCategory': 'æ ¹æ®colorå€¼åŒ¹é…ç›¸è¿‘é¢œè‰²è¯å¡«å…¥',
                'items_included': 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§items_includedï¼Œå¦åˆ™ç•™ç©º',
                'manufacturerPartNumber': 'ä½¿ç”¨äº§å“SKUå€¼ï¼ˆä¸­æ–‡è‡ªåŠ¨ç¼–ç ï¼‰',
                'maximumLoadWeight': 'ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§maximumLoadWeightï¼Œè§£ææ•°å€¼å¹¶è®¾ç½®å•ä½ä¸ºlb',
                'modelNumber': 'ä½¿ç”¨äº§å“SKUå€¼ï¼ˆä¸­æ–‡è‡ªåŠ¨ç¼–ç ï¼‰',
                'occasion': 'ä½¿ç”¨é¢„è®¾çš„èŠ‚æ—¥åœºåˆåˆ—è¡¨ï¼šLabor Day;Memorial Day;Independence Day;Black Friday;Cyber Monday;Christmas;New Year;Presidents\' Day;Thanksgiving',
                'ageGroup': 'ä½¿ç”¨é¢„è®¾çš„å¹´é¾„ç»„åˆ†ç±»ï¼Œé»˜è®¤ä¸ºAdultï¼Œå¯é€‰ï¼šAdultã€Teenã€Childã€Toddler',
                'batteryTechnologyType': 'ä½¿ç”¨é¢„è®¾çš„ç”µæ± æŠ€æœ¯ç±»å‹ï¼Œé»˜è®¤ä¸ºDoes Not Contain a Batteryï¼ŒåŒ…å«12ç§ç”µæ± ç±»å‹é€‰é¡¹',
                'bed_type': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«åºŠçš„ç±»å‹ï¼Œé»˜è®¤ä¸ºStandard Beds',
                'bedSize': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«åºŠçš„å°ºå¯¸ï¼Œé»˜è®¤ä¸ºNon-Standard',
                'box_spring_required': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦éœ€è¦å¼¹ç°§åºŠå«ï¼Œé»˜è®¤ä¸ºNo',
                'electronicsIndicator': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«ç”µå­å…ƒä»¶ï¼Œé»˜è®¤ä¸ºNo',
                'features': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«åºŠæ¶ç‰¹è‰²åŠŸèƒ½ï¼Œé»˜è®¤ä¸ºUnder Bed Storageï¼ˆä»…é™Bed Framesç±»ç›®ï¼‰',
                'finish': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«è¡¨é¢å¤„ç†/æ¶‚è£…ï¼Œå¦‚Glossyã€Matteã€Satinç­‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨äº§å“æè´¨',
                'gender': 'æ€§åˆ«åˆ†ç±»ï¼Œå¯é€‰æ‹©Unisexï¼ˆä¸­æ€§ï¼‰ã€Maleï¼ˆç”·æ€§ï¼‰ã€Femaleï¼ˆå¥³æ€§ï¼‰ï¼Œé»˜è®¤ä¸ºUnisex',
                'has_storage': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…å‚¨ç‰©ç›¸å…³å…³é”®è¯ï¼ˆstorageã€drawerã€compartmentã€hidden storageç­‰ï¼‰ï¼Œè¿”å›Yes/Noï¼Œé»˜è®¤ä¸ºNo',
                'has_trundle': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ‹–æ‹‰åºŠç›¸å…³å…³é”®è¯ï¼ˆtrundleã€pull-out bedã€daybed with trundleç­‰ï¼‰ï¼Œè¿”å›Yes/Noï¼Œé»˜è®¤ä¸ºNo',
                'homeDecorStyle': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…è£…é¥°é£æ ¼å…³é”®è¯ï¼ˆmodernã€traditionalã€rusticã€industrialã€minimalistç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„å®¶å±…è£…é¥°é£æ ¼ï¼Œé»˜è®¤ä¸ºMinimalist',
                'isAssemblyRequired': 'äº§å“æ˜¯å¦éœ€è¦ç»„è£…ï¼Œé»˜è®¤ä¸ºYes',
                'IsPreorder': 'æ˜¯å¦ä¸ºé¢„è®¢å•†å“ï¼Œé»˜è®¤ä¸ºNo',
                'isPrimaryVariant': 'æ˜¯å¦ä¸ºä¸»è¦å˜ä½“ï¼Œé»˜è®¤ä¸ºNo',
                'MustShipAlone': 'æ˜¯å¦å¿…é¡»å•ç‹¬å‘è´§ï¼Œé»˜è®¤ä¸ºYes',
                'numberOfDrawers': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æŠ½å±‰æ•°é‡å…³é”®è¯ï¼ˆ"X drawer"ã€"X-drawer"ã€"with drawers"ç­‰ï¼‰ï¼Œæå–æ•°å­—å¹¶éªŒè¯åˆç†èŒƒå›´ï¼Œè¿”å›æ•´æ•°ï¼Œé»˜è®¤ä¸º0',
                'numberOfShelves': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…ææ¿æ•°é‡å…³é”®è¯ï¼ˆ"X shelf"ã€"X-shelf"ã€"with shelves"ç­‰ï¼‰ï¼Œæå–æ•°å­—å¹¶éªŒè¯åˆç†èŒƒå›´ï¼Œè¿”å›æ•´æ•°ï¼Œé»˜è®¤ä¸º0',
                'ProductIdUpdate': 'æ˜¯å¦æ›´æ–°äº§å“IDï¼Œé»˜è®¤ä¸ºNo',
                'items_included': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«åŒ…å«çš„ç‰©å“æ¸…å•',
                'maximumLoadWeight': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ€å¤§æ‰¿é‡ï¼Œé»˜è®¤ä¸º1 lb',
                'upholstered': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…è½¯å«ç›¸å…³å…³é”®è¯ï¼ˆupholsteredã€paddedã€cushionedã€fabric coveredç­‰ï¼‰ï¼Œè¿”å›Yes/Noï¼Œé»˜è®¤ä¸ºNo',
                'wood_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æœ¨æç±»å‹å…³é”®è¯ï¼ˆoakã€pineã€mapleã€walnutã€cherryã€mahoganyç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰æœ¨æç±»å‹ä¸­é€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ä¸åŒæ­¥æ­¤å­—æ®µ',
                'wood_tone': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æœ¨æè‰²è°ƒå…³é”®è¯ï¼ˆnaturalã€darkã€lightã€mediumã€espressoã€honeyç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰è‰²è°ƒä¸­é€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ä¸åŒæ­¥æ­¤å­—æ®µ',
                'profile': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«äº§å“è½®å»“ç±»å‹ï¼Œé»˜è®¤ä¸ºStandard Profile',
                'theme': 'æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«äº§å“ä¸»é¢˜ï¼Œé»˜è®¤ä¸ºMulti-theme',
                'arm_style': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ‰¶æ‰‹ç›¸å…³å…³é”®è¯ï¼ˆarmlessã€with armsã€padded armsç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„æ‰¶æ‰‹é£æ ¼ï¼Œé»˜è®¤ä¸ºArmless',
                'frameColor': 'ä¼˜å…ˆä»äº§å“å±æ€§Frame Colorä¸­è·å–ï¼Œå¦åˆ™ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­è¯†åˆ«æ¡†æ¶é¢œè‰²è¯æ±‡ï¼Œæˆ–ä½¿ç”¨äº§å“ä¸»ä½“é¢œè‰²å±æ€§ï¼Œé»˜è®¤ä¸ºProduct color',
                'chair_style': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ¤…å­ç±»å‹å…³é”®è¯ï¼ˆside chairã€arm chairã€accent chairç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„æ¤…å­é£æ ¼ï¼Œé»˜è®¤ä¸ºSide Chair',
                'frameMaterial': 'ä¼˜å…ˆä»äº§å“å±æ€§Frame Materialä¸­è·å–ï¼Œå¦åˆ™ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­è¯†åˆ«æ¡†æ¶æè´¨è¯æ±‡ï¼ˆmetalã€woodã€plasticç­‰ï¼‰ï¼Œæˆ–ä½¿ç”¨äº§å“ä¸»ä½“æè´¨å±æ€§ï¼Œé»˜è®¤æå–äº§å“æè´¨',
                'ottoman_included': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…è„šå‡³ç›¸å…³å…³é”®è¯ï¼ˆottomanã€footstoolã€with ottomanç­‰ï¼‰ï¼Œè¿”å›Yes/Noï¼Œé»˜è®¤ä¸ºNo',
                'pattern': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…å›¾æ¡ˆç›¸å…³å…³é”®è¯ï¼ˆsolidã€stripedã€floralã€geometricç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„å›¾æ¡ˆæ ·å¼ï¼Œé»˜è®¤ä¸ºSolid',
                'leg_color': 'ä¼˜å…ˆä»äº§å“å±æ€§Leg Colorä¸­è·å–ï¼Œå¦åˆ™ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­è¯†åˆ«è…¿éƒ¨é¢œè‰²è¯æ±‡ï¼Œæˆ–ä½¿ç”¨äº§å“ä¸»ä½“é¢œè‰²å±æ€§ï¼Œé»˜è®¤ä¸ºäº§å“ä¸»ä½“é¢œè‰²',
                'leg_material': 'ä¼˜å…ˆä»äº§å“å±æ€§Leg Materialä¸­è·å–ï¼Œå¦åˆ™ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­è¯†åˆ«è…¿éƒ¨æè´¨è¯æ±‡ï¼ˆwoodã€metalã€plasticç­‰ï¼‰ï¼Œæˆ–ä½¿ç”¨äº§å“ä¸»ä½“æè´¨å±æ€§ï¼Œé»˜è®¤ä¸ºäº§å“ä¸»ä½“æè´¨',
                'preset_bed_positions': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…é¢„è®¾åºŠä½ç›¸å…³å…³é”®è¯ï¼ˆadjustableã€recliningã€positionsç­‰ï¼‰ï¼Œè¯†åˆ«å¯è°ƒèŠ‚åºŠä½åŠŸèƒ½ï¼Œé»˜è®¤ä¸ºNone',
                'dining_chair_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…é¤æ¤…ç±»å‹å…³é”®è¯ï¼šåŒ…å«"arm"ç›¸å…³è¯æ±‡çš„è¯†åˆ«ä¸ºDining Arm Chairsï¼Œå¦åˆ™ä¸ºDining Side Chairsï¼Œé»˜è®¤ä¸ºDining Side Chairs',
                'seat_back_style': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ¤…èƒŒæ ·å¼å…³é”®è¯ï¼ˆfiddle backã€wingbackã€ladder backã€cross backç­‰ï¼‰ï¼Œä»11ç§é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„æ¤…èƒŒæ ·å¼ï¼Œé»˜è®¤ä¸ºSplat Back',
                'seat_back_cushion_style': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ¤…èƒŒåå«æ ·å¼å…³é”®è¯ï¼ˆtufted backã€biscuit backã€split backã€loose backã€tight backã€sewn-pillow backã€cushion backã€pillow backç­‰ï¼‰ï¼Œä»8ç§é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„åå«æ ·å¼ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'seat_back_thickness': 'ä»äº§å“å±æ€§Seat Back Thicknessã€Back Thicknessã€Thicknessä¸­æå–æ•°å€¼ï¼Œæˆ–ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…"thick"ç­‰å…³é”®è¯+æ•°å­—ï¼Œè¿”å›measurement_objectæ ¼å¼ï¼Œé»˜è®¤ä¸º1 in',
                'decorative_pillow_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…è£…é¥°æ•ç±»å‹å…³é”®è¯ï¼ˆbolsterã€pillow setã€floor pillowã€lumbar pillowã€throw pillowç­‰ï¼‰ï¼Œä»5ç§é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é»˜è®¤ä¸ºBolster Pillow',
                'is_filled': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åˆ¤æ–­äº§å“æ˜¯å¦å¡«å……ï¼ˆfilledã€stuffedã€paddedç­‰å…³é”®è¯è¡¨ç¤ºYesï¼Œunfilledã€emptyã€insert onlyç­‰å…³é”®è¯è¡¨ç¤ºNoï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®ä¿¡æ¯åˆ™é»˜è®¤ä¸ºYes',
                'seat_back_width': 'ä»äº§å“å±æ€§Seat Back Widthã€Back Widthã€Backrest Widthä¸­æå–æ•°å€¼ï¼Œæˆ–ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…"back width"ç­‰å…³é”®è¯+æ•°å­—ï¼Œè¿”å›measurement_objectæ ¼å¼ï¼Œé»˜è®¤ä¸º1 in',
                'seat_color': 'ä¼˜å…ˆä»äº§å“å±æ€§Seat Colorã€Cushion Colorã€Upholstery Colorä¸­è·å–ï¼Œå¦åˆ™ä½¿ç”¨äº§å“ä¸»ä½“é¢œè‰²å±æ€§Colorã€Primary Colorï¼Œæˆ–ä»äº§å“åç§°ä¸­è¯†åˆ«å¸¸è§é¢œè‰²è¯æ±‡ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œé»˜è®¤ä¸ºNatural',
                'seat_depth': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–åº§æ¤…æ·±åº¦å°ºå¯¸ï¼ˆå•ä½ï¼šè‹±å¯¸ï¼‰ï¼Œæ”¯æŒå¤šç§åŒ¹é…æ¨¡å¼ï¼ˆseat depthã€cushion depthã€chair depthã€å°ºå¯¸ä¸­çš„ç¬¬ä¸‰ä¸ªæ•°å€¼ç­‰ï¼‰ï¼ŒéªŒè¯èŒƒå›´5-50è‹±å¯¸ï¼Œè¿”å›measurement_objectæ ¼å¼{measure: number, unit: "in"}ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é»˜è®¤ä¸º1 in',
                'seat_material': 'ä¼˜å…ˆä»äº§å“å±æ€§Seat Materialã€Cushion Materialã€Upholstery Materialä¸­è·å–ï¼Œå¦åˆ™ä½¿ç”¨äº§å“ä¸»ä½“æè´¨å±æ€§Materialã€Primary Materialï¼Œæˆ–ä»äº§å“åç§°å’Œæè¿°ä¸­è¯†åˆ«å¸¸è§æè´¨è¯æ±‡ï¼ˆleatherã€fabricã€cottonç­‰ï¼‰ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œé»˜è®¤ä¸ºFabric',
                'seat_width': 'ä»äº§å“å±æ€§Seat Widthã€Widthä¸­æå–æ•°å€¼ï¼Œæˆ–ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…"wide"ã€"width"ç­‰å…³é”®è¯+æ•°å­—ï¼Œæ”¯æŒç‰¹æ®Šå¤„ç†ä»»ä½•æ•°å­—+inchesç»„åˆï¼Œè¿”å›measurement_objectæ ¼å¼ï¼Œé»˜è®¤ä¸º1 in',
                'seatBackHeight': 'ä»äº§å“å±æ€§Seat Back Heightã€Back Heightã€Backrest Heightä¸­æå–æ•°å€¼ï¼Œæˆ–ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…"back height"ç­‰å…³é”®è¯+æ•°å­—ï¼Œè¿”å›measurement_objectæ ¼å¼ï¼Œé»˜è®¤ä¸º1 in',
                'seatHeight': 'ä»äº§å“å±æ€§Seat Heightã€Heightä¸­æå–æ•°å€¼ï¼Œæˆ–ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…"seat height"ã€"height"ç­‰å…³é”®è¯+æ•°å­—ï¼Œè¿”å›measurement_objectæ ¼å¼ï¼Œé»˜è®¤ä¸º1 in',
                'seatingCapacity': 'ä»äº§å“å±æ€§Seating Capacityã€Capacityã€Seatsä¸­æå–æ•°å­—ï¼Œæˆ–ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…"X seater"ã€"for X people"ã€"capacity: X"ç­‰æ¨¡å¼ï¼Œæ ¹æ®äº§å“ç±»å‹æ™ºèƒ½æ¨æ–­ï¼ˆsofaâ†’3, loveseatâ†’2, benchâ†’2ï¼‰ï¼Œè¿”å›æ•´æ•°ï¼Œé»˜è®¤ä¸º1',
                'recommendedLocations': 'ä»äº§å“å±æ€§Recommended Locationsã€Locationã€Use Locationä¸­è·å–ï¼Œæˆ–é€šè¿‡å…³é”®è¯å¾—åˆ†ç®—æ³•è¯†åˆ«ï¼šæˆ·å¤–è¯æ±‡ï¼ˆoutdoorã€patioã€gardenã€weather resistantç­‰ï¼‰vså®¤å†…è¯æ±‡ï¼ˆindoorã€homeã€officeã€bedroomç­‰ï¼‰ï¼Œå†²çªæ—¶ä¼˜å…ˆæˆ·å¤–ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œé»˜è®¤ä¸ºIndoor',
                'shipsInOriginalPackaging': 'æ˜¯å¦å¯ä»¥åŸåŒ…è£…å‘è´§ï¼Œé»˜è®¤ä¸ºYes',
                'productLine': 'ä¼˜å…ˆä»äº§å“å±æ€§ï¼ˆProduct Lineã€Collectionã€Seriesï¼‰è·å–ï¼Œå¦åˆ™è·å–äº§å“çš„æœ€æ·±å±‚çº§åˆ†ç±»åç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ†ç±»åˆ™ä»äº§å“æ ‡é¢˜ä¸­æå–äº§å“çº¿å…³é”®è¯ï¼ˆseriesã€collectionã€lineã€modelç­‰ï¼‰ï¼Œå¦‚æœéƒ½æ²¡æœ‰åˆ™ä½¿ç”¨äº§å“ç±»å‹ï¼Œæœ€åè¿”å›é»˜è®¤å€¼Standardï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œæ¯é¡¹æœ€å¤§400å­—ç¬¦',
                'swatchImages': 'è¯»å–äº§å“ä¸»å›¾ï¼ˆæ”¯æŒè¿œç¨‹URLå’Œæœ¬åœ°å›¾ç‰‡ï¼‰',
                'sku': 'ä½¿ç”¨æœ¬åœ°äº§å“SKUå€¼',
                'price': 'ä½¿ç”¨æœ¬åœ°äº§å“ä»·æ ¼å€¼ï¼ˆæœ€å¤šä¸¤ä½å°æ•°ï¼‰',
                'ShippingWeight': 'è¿è¾“é‡é‡æå–è§„åˆ™ï¼ˆ5çº§ä¼˜å…ˆçº§ï¼‰ï¼š1. ä¼˜å…ˆä»äº§å“å±æ€§Package Weightæå–ï¼ˆæ”¯æŒ4ç§æ ¼å¼ï¼‰ï¼›2. å¦‚æœæ²¡æœ‰ï¼Œå°è¯•å¤šåŒ…è£¹é‡é‡ç´¯åŠ ï¼ˆPackage 1 Weight + Package 2 Weight + ...ï¼‰ï¼›3. å¦‚æœè¿˜æ²¡æœ‰ï¼Œå°è¯•Product Weightå±æ€§ï¼›4. å¦‚æœè¿˜æ²¡æœ‰ï¼Œä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–åŒ…è£¹é‡é‡ï¼ˆæ”¯æŒshipping weightã€package weightã€packed weightç­‰å…³é”®è¯ï¼‰ï¼›5. æœ€åé»˜è®¤ä¸º1ã€‚è¿”å›å­—ç¬¦ä¸²æ ¼å¼çš„æ•°å­—ï¼Œå•ä½ä¸ºlbsã€‚',
                'fulfillmentCenterID': 'ä½¿ç”¨è®¾ç½®ä¸­çš„å±¥è¡Œä¸­å¿ƒID',
                // ğŸ†• backing_material å­—æ®µ
                'backing_material': 'ä»äº§å“å±æ€§Backing Materialæˆ–backing_materialä¸­è·å–åœ°æ¯¯èƒŒè¡¬ææ–™ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œç¤ºä¾‹å€¼ï¼šLatexã€Thermoplastic Elastomerã€Rubberï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• åœ°æ¯¯ç›¸å…³å­—æ®µ - 2025-10-28
                'pile_thickness': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…åœ°æ¯¯ç»’æ¯›åšåº¦å…³é”®è¯ï¼ˆShag Pileã€High Pileã€Low Pileã€Medium Pileã€Flat Pileã€High-Low Pileï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'pileHeight': 'ä»äº§å“å±æ€§Pile Heightä¸­æå–æ•°å€¼å¹¶è§£æä¸ºmeasurement_objectæ ¼å¼ï¼ˆå•ä½ï¼šmmæˆ–inï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'rug_construction': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…åœ°æ¯¯åˆ¶ä½œæ–¹å¼å…³é”®è¯ï¼ˆMachine Madeã€Handmadeï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'rug_technique_weave': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…åœ°æ¯¯ç¼–ç»‡æŠ€æœ¯å…³é”®è¯ï¼ˆTuftedã€Knottedã€Hookedã€Flat Weaveã€Loomedã€Needle Punchedã€Braidedï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• åœ°æ¯¯å°ºå¯¸å­—æ®µ - 2025-10-28ï¼ˆæ³¨æ„ï¼šä¿ç•™å®Œæ•´çš„è‹±å°º+è‹±å¯¸æ ¼å¼ï¼Œä¸è¿›è¡Œå•ä½æ¢ç®—ï¼‰
                'rugSize': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–åœ°æ¯¯å°ºå¯¸ï¼Œæ ¼å¼ä¸ºå®½xé•¿ï¼ˆè‹±å°ºå’Œè‹±å¯¸ï¼‰ï¼Œä¾‹å¦‚ï¼š3\' x 5\'ã€5\'2" x 7\'6"ã€8\'6" x 10\'ï¼Œæœ€å¤§é•¿åº¦200å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'size': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–åœ°æ¯¯å°ºå¯¸ï¼Œä¼˜å…ˆä»äº§å“å±æ€§è·å–ï¼Œæ ¼å¼ä¸ºå®½xé•¿ï¼ˆè‹±å°ºå’Œè‹±å¯¸ï¼‰ï¼Œä¾‹å¦‚ï¼š3\' x 5\'ã€5\'2" x 7\'6"ã€8\'6" x 10\'ï¼Œæœ€å¤§é•¿åº¦500å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• ç¯ç½©é…ä»¶ç±»å‹å­—æ®µ - 2025-10-28
                'lamp_shade_fitter_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…ç¯ç½©é…ä»¶ç±»å‹å…³é”®è¯ï¼ˆClip-Onã€Spiderã€Slip UNOã€Threaded UNOï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• åœ£è¯æ ‘ç›¸å…³å­—æ®µ - 2025-10-28
                'christmas_tree_feature': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–åœ£è¯æ ‘ç‰¹å¾å…³é”®è¯ï¼ˆDecoratedã€Hingedã€Flockedã€Pottedã€Pre-Litã€Rotatingã€Twinkling Lightsã€Unlitã€Frosted Lightsï¼‰ï¼Œæœ€å¤§é•¿åº¦80å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'christmas_tree_shape': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…åœ£è¯æ ‘å½¢çŠ¶å…³é”®è¯ï¼ˆTeardropã€Pencilã€Fullã€Upside Downã€Dressã€Slimã€Spiralã€Triangularã€Pyramidã€Halfã€Cornerã€Topiaryã€Conicalï¼‰ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'christmas_tree_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…åœ£è¯æ ‘ç±»å‹å…³é”®è¯ï¼ˆArtificial Christmas Treesã€Fresh Cut Christmas Treesã€Tabletop Christmas Treesã€Living Christmas Treesï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é»˜è®¤ä½¿ç”¨Artificial Christmas Trees',
                // ğŸ†• é¢œè‰²å’ŒåŒ…è£…ç›¸å…³å­—æ®µ - 2025-10-28
                'colorDescriptor': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…é¢œè‰²æè¿°ç¬¦å…³é”®è¯ï¼ˆPastelã€Rainbowã€Neonã€Metallicã€Fluorescentã€Pearlescentã€Glitterï¼‰ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é»˜è®¤ä½¿ç”¨Rainbow',
                'frameColorConfiguration': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–æ¡†æ¶é¢œè‰²é…ç½®ï¼ˆå¦‚Blackã€Brownã€Silverï¼‰ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œæ¯é¡¹æœ€å¤§40å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• è®¤è¯å’ŒåŒ…è£…å­—æ®µ - 2025-10-28
                'has_nrtl_listing_certification': 'é»˜è®¤ä½¿ç”¨Noï¼Œè¡¨ç¤ºæ˜¯å¦å…·æœ‰NRTLè®¤è¯ï¼ˆå›½å®¶è®¤å¯æµ‹è¯•å®éªŒå®¤è®¤è¯ï¼‰',
                'ib_retail_packaging': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…é›¶å”®åŒ…è£…ç±»å‹ï¼ˆValue Packã€Setã€Bundleã€Kitã€Combo Packã€Pairã€Bonus Packã€Single Pieceï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é»˜è®¤ä½¿ç”¨Single Piece',
                'isCollectible': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åˆ¤æ–­æ˜¯å¦ä¸ºæ”¶è—å“ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®è¯´æ˜åˆ™é»˜è®¤ä½¿ç”¨Yes',
                // ğŸ†• ç¯å…‰ç›¸å…³å­—æ®µ - 2025-10-28
                'light_functions': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…ç¯å…‰åŠŸèƒ½å…³é”®è¯ï¼ˆChasingã€Color Changingã€Twinklingã€Pulsingã€Constantã€Fadingï¼‰ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é»˜è®¤ä½¿ç”¨Constant',
                'lightBulbColor': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–ç¯æ³¡é¢œè‰²ï¼ˆå¦‚Beigeã€Redã€Blueã€Multicolorç­‰ï¼‰ï¼Œæœ€å¤§400å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'lightBulbType': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…ç¯æ³¡ç±»å‹ï¼ˆLEDã€Incandescentï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'numberOfLights': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–ç¯çš„æ•°é‡ï¼Œè¿”å›æ•´æ•°ï¼ˆèŒƒå›´0-100000000000000000ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• æ ‘æœ¨ç±»å‹å­—æ®µ - 2025-10-28
                'tree_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ ‘æœ¨ç±»å‹ï¼ˆFirã€Spruceã€Pineï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é€‰æ‹©æœ€ç›¸è¿‘æˆ–æœ€å¸¸ç”¨çš„æšä¸¾å€¼ï¼ˆé»˜è®¤Firï¼‰',
                // ğŸ†• è£…é¥°å’Œå¢™è´´ç›¸å…³å­—æ®µ - 2025-10-29
                'alphanumericCharacter': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å­—æ¯æ•°å­—å­—ç¬¦ï¼ˆå¦‚Aã€9ã€42ï¼‰ï¼Œæœ€å¤§40å­—ç¬¦ï¼Œç”¨äºå­—æ¯æˆ–æ•°å­—äº§å“ï¼ˆå¦‚é—¨ç‰Œå·ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'subject': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–äº§å“ä¸»é¢˜æˆ–æç»˜å†…å®¹ï¼ˆå¦‚Sitting Safari Adorable Giraffeã€Farmhouse Windmillï¼‰ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œæ¯é¡¹æœ€å¤§4000å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'wall_decal_and_sticker_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…å¢™è´´ç±»å‹ï¼ˆWall Decalsã€Wall Stickersï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• æ¤ç‰©ç›†æ ½ç›¸å…³å­—æ®µ - 2025-10-29
                'plant_pot_and_planter_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ¤ç‰©ç›†æ ½ç±»å‹ï¼ˆPlant Potã€Plant Planterï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• é—¨å’ŒæŸœå­ç›¸å…³å­—æ®µ - 2025-10-30
                'doorOpeningStyle': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…é—¨å¼€å¯æ ·å¼ï¼ˆLift Openã€Swing Openã€Slidingï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'cabinet_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æŸœå­ç±»å‹ï¼ˆOver-the-Toilet Cabinetsã€Wall Cabinetsã€Base Cabinetsç­‰9ç§ç±»å‹ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'doorStyle': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…é—¨æ ·å¼ï¼ˆShakerã€Flat Panelã€Raised Panelç­‰9ç§æ ·å¼ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                // ğŸ†• æŠ½å±‰å°ºå¯¸å’Œå®‰è£…ç›¸å…³å­—æ®µ - 2025-10-30
                'drawer_depth': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–æŠ½å±‰æ·±åº¦å°ºå¯¸ï¼ˆå•ä½ï¼šè‹±å¯¸ï¼‰ï¼Œè¿”å›å¯¹è±¡æ ¼å¼{measure: "æ•°å€¼", unit: "in"}ï¼Œæœ€å¤§80å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'drawer_height': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–æŠ½å±‰é«˜åº¦å°ºå¯¸ï¼ˆå•ä½ï¼šè‹±å¯¸ï¼‰ï¼Œè¿”å›å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "in"}ï¼ŒèŒƒå›´0-100000000000000000ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'drawer_width': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–æŠ½å±‰å®½åº¦å°ºå¯¸ï¼ˆå•ä½ï¼šè‹±å¯¸ï¼‰ï¼Œè¿”å›å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "in"}ï¼ŒèŒƒå›´0-100000000000000000ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'has_doors': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åˆ¤æ–­äº§å“æ˜¯å¦æœ‰é—¨ï¼ˆYesã€Noï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®ä¿¡æ¯åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'mountType': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…å®‰è£…ç±»å‹ï¼ˆWall Mountã€Corner Mountã€Freestandingã€Recessed Mountï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®äº§å“ç±»å‹åˆ¤æ–­ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œå¿…å¡«å­—æ®µä¸èƒ½ç•™ç©º',
                'orientation': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…äº§å“æ–¹å‘ï¼ˆHorizontalã€Verticalï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é»˜è®¤ä½¿ç”¨Horizontal',
                'fulfillmentLagTime': 'é»˜è®¤1å¤©å¤‡è´§æ—¶é—´ï¼ˆæ•´æ•°ï¼ŒèŒƒå›´0-10å¤©ï¼‰',
                'releaseDate': 'åŒæ­¥å½“å¤©å¾€å‰æ¨ä¸€å¤©ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2025/07/31ï¼‰',
                'startDate': 'åŒæ­¥å½“å¤©å¾€å‰æ¨ä¸€å¤©ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2025/07/31ï¼‰',
                'endDate': 'åŒæ­¥å½“å¤©å¾€åæ¨15å¹´ï¼ˆå¦‚2025/08/01åŒæ­¥åˆ™ä¸º2040/07/31ï¼‰',
                'bed_frame_adjustability': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨æå–åºŠæ¶å¯è°ƒæ€§å…³é”®è¯ï¼ˆAdjustable Foot/Headï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©º',

                // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µè¯´æ˜
                'base_style': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…åº•åº§æ ·å¼å…³é”®è¯ï¼ˆstandard legsã€frameã€pedestalã€cross legsã€sledã€trestleã€star baseã€abstractã€blockç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„åº•åº§æ ·å¼ï¼Œé»˜è®¤ä¸ºStandard Legs',
                'baseColor': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–åº•åº§é¢œè‰²ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨äº§å“ä¸»ä½“é¢œè‰²å±æ€§ï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆ™ä¸ä¼ é€’æ­¤å­—æ®µ',
                'baseMaterial': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–åº•åº§æè´¨ä¿¡æ¯ï¼ˆwoodã€steelã€metalã€plasticç­‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'is_extendable': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…å¯æ‰©å±•ç›¸å…³å…³é”®è¯ï¼ˆextendableã€expandableã€extensionã€leafç­‰ï¼‰ï¼Œè¿”å›Yes/Noï¼Œé»˜è®¤ä¸ºNo',
                'table_leaf_type': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ¡Œå¶ç±»å‹å…³é”®è¯ï¼ˆdrop leafã€self-storing leafã€butterfly leafã€removable leafç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ä¸ä¼ é€’æ­¤å­—æ®µ',
                'table_shape': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…æ¡Œå­å½¢çŠ¶å…³é”®è¯ï¼ˆroundã€squareã€rectangleã€ovalã€curvedç­‰ï¼‰ï¼Œä»é¢„å®šä¹‰æšä¸¾å€¼ä¸­é€‰æ‹©æœ€åŒ¹é…çš„å½¢çŠ¶ï¼Œé»˜è®¤ä¸ºFree Formï¼Œè¿”å›æ•°ç»„æ ¼å¼',
                'table_top__material': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–æ¡Œé¢æè´¨ä¿¡æ¯ï¼ˆwoodã€glassã€MDFã€resinç­‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µï¼Œè¿”å›æ•°ç»„æ ¼å¼',
                'top_color': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–é¡¶éƒ¨é¢œè‰²ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™æå–äº§å“ä¸»ä½“é¢œè‰²ï¼Œè¿”å›æ•°ç»„æ ¼å¼',

                // ğŸ†• é€šç”¨å½¢çŠ¶å­—æ®µè¯´æ˜
                'shape': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æ™ºèƒ½è¯†åˆ«äº§å“çš„ç‰©ç†å½¢çŠ¶ï¼ˆRoundã€Squareã€Rectangleã€Ovalã€Triangleã€Heartã€Starã€Curvedã€Geometricç­‰ï¼‰ï¼Œæ”¯æŒ47ç§æ ‡å‡†å½¢çŠ¶ï¼Œå¦‚æœæ— æ³•è¯†åˆ«åˆ™é»˜è®¤ä¸ºAsymmetrical',

                // ğŸ†• é—¨æ•°é‡å­—æ®µè¯´æ˜
                'number_of_doors': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–é—¨çš„æ•°é‡ï¼ˆå¦‚"2-door cabinet"ã€"single door"ã€"3 doors"ç­‰ï¼‰ï¼Œè¿”å›æ•´æ•°å€¼ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™é»˜è®¤ä¸º0',

                // ğŸ†• å±‚æ•°å­—æ®µè¯´æ˜
                'number_of_tiers': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å±‚æ•°æˆ–çº§æ•°ï¼ˆå¦‚"3-tier shelf"ã€"2 tiers"ã€"multi-tier"ç­‰ï¼‰ï¼Œè¿”å›æ•´æ•°å€¼ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™é»˜è®¤ä¸º0',

                // ğŸ†• åº“å­˜æ•°é‡å­—æ®µè¯´æ˜
                'quantity': 'è‡ªåŠ¨è¯»å–æœ¬åœ°äº§å“çš„åº“å­˜æ•°é‡ï¼Œæ•´æ•°ç±»å‹ï¼ŒèŒƒå›´0-100000000000000000ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åº“å­˜ç®¡ç†æˆ–åº“å­˜ä¸ºnullåˆ™è¿”å›0',

                // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µè¯´æ˜
                'table_color': 'ä»äº§å“æè¿°ä¸­æå–æ¡Œå­é¢œè‰²ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨äº§å“ä¸»é¢˜é¢œè‰²å€¼ï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å€¼',
                'table_top_type': 'ä»äº§å“æè¿°ä¸­æå–æ¡Œé¢ç±»å‹ä¿¡æ¯ï¼Œæ”¯æŒTray Topå’ŒLift Topä¸¤ç§ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨Tray Top',
                'tableHeight': 'ä»äº§å“æè¿°ä¸­æå–æ¡Œå­é«˜åº¦ä¿¡æ¯ï¼Œè¿”å›æµ‹é‡å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "in"}ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å€¼',

                // ğŸ†• æŸœä½“ç›¸å…³å­—æ®µè¯´æ˜
                'cabinet_color': 'è‡ªåŠ¨ä»æ ‡é¢˜å’Œäº§å“æè¿°æå–æŸœä½“é¢œè‰²ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨äº§å“ä¸»ä½“é¢œè‰²ï¼Œå¦‚æœéƒ½æ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'cabinet_material': 'è‡ªåŠ¨ä»æ ‡é¢˜å’Œäº§å“æè¿°æå–æŸœä½“æè´¨ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨äº§å“ä¸»ä½“æè´¨ï¼Œå¦‚æœéƒ½æ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'hardwareFinish': 'è‡ªåŠ¨ä»æ ‡é¢˜å’Œäº§å“æè¿°æå–äº”é‡‘è¡¨é¢å¤„ç†ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨äº§å“é¢œè‰²',
                'recommendedRooms': 'é»˜è®¤ä½¿ç”¨å¤šä¸ªé€‰é¡¹ï¼šLiving Room, Bedroom, Dining Room, Family Room, Kitchen, Bathroom, Laundry Room, Pantry, Home Office, Office, Conference Room, Cubicle',

                // ğŸ†• åˆ†ç±»ç‰¹å®šfeatureså­—æ®µè¯´æ˜
                'features': 'æ ¹æ®äº§å“çš„æœ¬åœ°åˆ†ç±»IDåŠ¨æ€è·å–å¯ç”¨çš„ç‰¹æ€§é€‰é¡¹ï¼Œç„¶åä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æ™ºèƒ½åŒ¹é…æœ€åˆé€‚çš„ç‰¹æ€§ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',

                // ğŸ†• é€šç”¨å­—æ®µæ‹“å±•è¯´æ˜ - 2025-10-12 (ç¬¬ä¸€æ‰¹)
                'frame_finish': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æ¡†æ¶è¡¨é¢å¤„ç†ä¿¡æ¯ï¼ˆå¦‚Stainless Steelã€Chromeã€Polishedç­‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨äº§å“é¢œè‰²',
                'handle_width': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æŠŠæ‰‹å®½åº¦ä¿¡æ¯ï¼Œè¿”å›æµ‹é‡å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "in"}ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨1 in',
                'handleMaterial': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æŠŠæ‰‹æè´¨ä¿¡æ¯ï¼ˆå¦‚Plasticã€Woodã€Metalç­‰ï¼‰ï¼Œè¿”å›æ•°ç»„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'kitchen_serving_and_storage_cart_type': 'ä»äº§å“æè¿°è‡ªåŠ¨è¯†åˆ«å¨æˆ¿æ¨è½¦ç±»å‹ï¼ˆServing Cartæˆ–Bar Cartï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨Serving Cart',
                'numberOfHooks': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æŒ‚é’©æ•°é‡ï¼Œè¿”å›æ•´æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º0',
                'numberOfWheels': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–è½®å­æ•°é‡ï¼Œè¿”å›æ•´æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º0',
                'topMaterial': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–é¡¶éƒ¨æè´¨ä¿¡æ¯ï¼ˆå¦‚Woodã€Glassã€Mirrorç­‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',

                // ğŸ†• é€šç”¨å­—æ®µæ‹“å±•è¯´æ˜ - 2025-10-12 (ç¬¬äºŒæ‰¹)
                'dining_furniture_set_type': 'ä»äº§å“æè¿°è‡ªåŠ¨è¯†åˆ«é¤å…å®¶å…·å¥—è£…ç±»å‹ï¼ˆDining Table with Benchã€Dining Nookã€Pub Table Setç­‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨Dining Table with Chair',
                'overall_chair_depth': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æ¤…å­æ•´ä½“æ·±åº¦ï¼Œè¿”å›æµ‹é‡å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "in"}ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'overall_chair_height': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æ¤…å­æ•´ä½“é«˜åº¦ï¼Œè¿”å›æµ‹é‡å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "in"}ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'overall_chair_width': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æ¤…å­æ•´ä½“å®½åº¦ï¼Œè¿”å›æµ‹é‡å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "in"}ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'seat_back_height_descriptor': 'ä»äº§å“æè¿°è‡ªåŠ¨è¯†åˆ«åº§æ¤…é èƒŒé«˜åº¦æè¿°ï¼ˆMid Backã€High Backã€Low Backï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ',
                'seating_capacity_with_leaf': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–å¸¦æ‰©å±•å¶æ¿çš„åº§ä½å®¹é‡ï¼Œè¿”å›æ•´æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º1',
                'table_length': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æ¡Œå­é•¿åº¦ï¼Œè¿”å›æµ‹é‡å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "ft/cm/in"}ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨1 in',
                'table_width': 'ä»äº§å“æè¿°è‡ªåŠ¨æå–æ¡Œå­å®½åº¦ï¼Œè¿”å›æµ‹é‡å¯¹è±¡æ ¼å¼{measure: æ•°å€¼, unit: "ft/cm/in"}ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨1 in',

                // ğŸ†• é€šç”¨å­—æ®µæ‹“å±•è¯´æ˜ - 2025-10-13 (ç¬¬ä¸‰æ‰¹)
                'sizeDescriptor': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å°ºå¯¸æè¿°ç¬¦ï¼ˆCompactã€Regularã€Oversizedç­‰ï¼‰ï¼Œæ”¯æŒå¤šç§å°ºå¯¸å…³é”®è¯åŒ¹é…ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ä¸ä¼ é€’æ­¤å­—æ®µ',
                'sofa_and_loveseat_design': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–æ²™å‘è®¾è®¡é£æ ¼ï¼ˆMid-Century Modernã€Tuxedoã€Camelbackç­‰ï¼‰ï¼Œæ”¯æŒ8ç§è®¾è®¡é£æ ¼ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™é»˜è®¤ä¸ºMid-Century Modernï¼Œè¿”å›æ•°ç»„æ ¼å¼',
                'sofa_bed_size': 'ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–æ²™å‘åºŠå°ºå¯¸ï¼ˆTwinã€Fullã€Queenã€Kingï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ä¸ä¼ é€’æ­¤å­—æ®µ'
            };

            return rules[attributeName] || 'è‡ªåŠ¨ç”Ÿæˆ';
        }

        // åŠ è½½æ²ƒå°”ç›å­—æ®µé€‰é¡¹çš„å‡½æ•°
        function loadWalmartFieldOptions(selectElement, attributeName, currentValue, enumValues) {
            console.log('åŠ è½½æ²ƒå°”ç›å­—æ®µé€‰é¡¹:', attributeName, 'å½“å‰å€¼:', currentValue, 'æšä¸¾å€¼:', enumValues);
            var options = [];

            // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„æšä¸¾å€¼
            if (enumValues && enumValues.length > 0) {
                options = enumValues;

            } else {
                // æ²ƒå°”ç›å­—æ®µæšä¸¾å€¼æ˜ å°„ï¼ˆåŸºäºV5.0è§„èŒƒï¼‰
                var walmartFieldOptions = {
                    // åŸºæœ¬å±æ€§
                    'isProp65WarningRequired': ['Yes', 'No'],
                    'has_written_warranty': ['Yes - Warranty Text', 'Yes - Warranty URL', 'No'],
                    'condition': ['New', 'Open Box'],
                    'currency': ['USD'],

                    // å°ºå¯¸å•ä½
                    'assembledProductLengthUnit': ['mm', 'ft', 'cm', 'in'],
                    'assembledProductWidthUnit': ['mm', 'ft', 'cm', 'in'],
                    'assembledProductHeightUnit': ['mm', 'ft', 'cm', 'in'],
                    'assembledProductWeightUnit': ['kg', 'lb', 'oz'],

                    // è¿è¾“å•ä½
                    'shippingWeightUnit': ['kg', 'lb', 'oz'],
                    'shippingLengthUnit': ['mm', 'ft', 'cm', 'in'],
                    'shippingWidthUnit': ['mm', 'ft', 'cm', 'in'],
                    'shippingHeightUnit': ['mm', 'ft', 'cm', 'in'],

                    // å‡€å«é‡å•ä½
                    'productNetContentUnit': ['Count', 'Inch', 'Pint', 'Liter', 'Gallon', 'Ounce', 'Pound', 'Fluid Ounces', 'Each'],

                    // ä»·æ ¼å•ä½
                    'pricePerUnitUom': ['Each', 'Ounce', 'Pound', 'Gallon', 'Liter', 'Count', 'Cubic Foot', 'Square Foot'],

                    // å®¶å±…å¨æˆ¿
                    'dishwasherSafe': ['Yes', 'No'],
                    'microwaveSafe': ['Yes', 'No'],

                    // å©´å„¿ç”¨å“
                    'bpaFree': ['Yes', 'No'],
                    'ageGroup': ['Teen', 'Tween', 'Adult', 'Child', 'Baby', 'Toddler'],
                    'safetyFeatures': ['Foldable', 'Adjustable Height', 'Safety Lock'],

                    // æœè£…
                    'gender': ['Unisex', 'Male', 'Female'],

                    // é€šç”¨å±æ€§
                    'colorCategory': ['Blue', 'Brown', 'Gold', 'Green', 'Red', 'Black', 'White', 'Yellow', 'Purple', 'Orange', 'Pink', 'Gray'],
                    'sizeDescriptor': ['Compact', 'Large', 'Medium', 'Small', 'Extra Large'],
                    'retailPackaging': ['Set', 'Kit'],
                    'isPrimaryVariant': ['Yes', 'No'],

                    // å˜ä½“å±æ€§
                    'variantAttributeNames': ['color', 'assembledProductWidth', 'multipackQuantity', 'size', 'count', 'assembledProductHeight'],

                    // è­¦å‘Šå’Œè®¤è¯
                    'smallPartsWarnings': ['0 - No warning applicable', '5 - Choking hazard is a marble', '4 - Choking hazard balloon'],
                    'thirdPartyAccreditationSymbolOnProductPackageCode': ['CAC Absence of Peanut', 'For Life (Social Responsibility)', 'Certified California Sustainable Vineyard and Winery (CCSW)'],

                    // V5.0æ–°å¢çš„é‡è¦å±æ€§
                    'SkuUpdate': ['Yes', 'No'],
                    'ProductIdUpdate': ['Yes', 'No'],
                    'chemicalAerosolPesticide': ['Yes', 'No'],
                    'batteryTechnologyType': ['Mercury', 'Carbon Zinc', 'Lead Acid (Non-Spillable)', 'Alkaline', 'Does Not Contain a Battery', 'Lithium Primary (Lithium Metal)', 'Nickel Cadmium', 'Lithium Ion', 'Nickel Metal Hydride', 'Lead Acid', 'Silver', 'Magnesium'],
                    'features': ['Lighted Headboard', 'Under Bed Storage', 'Nailhead Trim', 'USB Port', 'Tufted'],
                    'has_storage': ['Yes', 'No'],
                    'has_trundle': ['Yes', 'No'],
                    'homeDecorStyle': ['Mid-Century', 'Tropical', 'Eclectic', 'Glam', 'Cottage', 'Minimalist', 'Transitional', 'Rustic/Lodge', 'Scandinavian', 'Traditional', 'Victorian', 'Bohemian', 'Asian Inspired', 'Farmhouse', 'Industrial', 'French Country', 'Modern', 'Contemporary', 'Shabby Chic', 'Coastal', 'Southwestern', 'Art Deco'],
                    'isAssemblyRequired': ['Yes', 'No'],
                    'IsPreorder': ['Yes', 'No'],
                    'isPrimaryVariant': ['Yes', 'No'],
                    'MustShipAlone': ['Yes', 'No'],
                    'ProductIdUpdate': ['Yes', 'No'],
                    'shipsInOriginalPackaging': ['Yes', 'No'],
                    'MustShipAlone': ['Yes', 'No'],
                    'IsPreorder': ['Yes', 'No'],
                    'assemblyRequired': ['Yes', 'No'],

                    // æ—…è¡Œå’Œå®‰å…¨ç›¸å…³
                    'isTsaApproved': ['Yes', 'No'],
                    'isFireRetardant': ['Yes', 'No'],
                    'isWaterproof': ['Yes', 'No'],
                    'isWaterResistant': ['Yes', 'No'],

                    // å¸¸è§çš„Yes/Noå­—æ®µ
                    'isAssemblyRequired': ['Yes', 'No'],
                    'inflexKitComponent': ['Yes', 'No'],
                    'isPortable': ['Yes', 'No'],
                    'isReusable': ['Yes', 'No'],
                    'isRecyclable': ['Yes', 'No']
                };
                options = walmartFieldOptions[attributeName] || [];

            }

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†é»˜è®¤é€‰é¡¹ï¼‰
            selectElement.find('option:not(:first)').remove();

            // æ·»åŠ æšä¸¾é€‰é¡¹
            console.log('æ·»åŠ é€‰é¡¹åˆ°', attributeName, 'é€‰é¡¹åˆ—è¡¨:', options);
            options.forEach(function(option) {
                var optionElement = $('<option></option>').attr('value', option).text(option);
                if (option === currentValue) {
                    optionElement.prop('selected', true);
                    console.log('è®¾ç½®é€‰ä¸­é€‰é¡¹:', option, 'å¯¹äºå­—æ®µ:', attributeName);
                }
                selectElement.append(optionElement);
            });

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„æšä¸¾å€¼ï¼Œæ˜¾ç¤ºæç¤º
            if (options.length === 0) {
                selectElement.append('<option value="" disabled>æ­¤å±æ€§æš‚æ— é¢„å®šä¹‰é€‰é¡¹</option>');
            }

            // æ›´æ–°å¯¹åº”çš„éšè—å­—æ®µï¼Œä¿å­˜æšä¸¾å€¼
            if (options && options.length > 0) {
                var enumValuesJson = JSON.stringify(options);

                // åœ¨åŒä¸€è¡Œä¸­æŸ¥æ‰¾éšè—å­—æ®µï¼ˆæ›´å¯é çš„æ–¹æ³•ï¼‰
                var $row = selectElement.closest('tr');
                var $hiddenField = $row.find('input[type="hidden"][name*="enum_values"]');

                if ($hiddenField.length > 0) {
                    $hiddenField.val(enumValuesJson);
                    console.log('âœ… æ›´æ–°éšè—å­—æ®µæˆåŠŸ:', attributeName, options, 'éšè—å­—æ®µname:', $hiddenField.attr('name'));
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°éšè—å­—æ®µ:', attributeName);
                    console.log('è°ƒè¯•ä¿¡æ¯ - è¡Œä¸­æ‰€æœ‰éšè—å­—æ®µ:', $row.find('input[type="hidden"]').map(function() {
                        return $(this).attr('name') + '=' + $(this).val();
                    }).get());
                }
            }
        }

        // æ¸…é™¤å±æ€§æŒ‰é’®
        $('body').on('click', '.clear-attributes-button', function() {
            var button = $(this);
            var mapperDiv = button.closest('.attribute-mapper');
            var wcCatId = mapperDiv.data('wc-cat-id');

            // ä¿®å¤ï¼šåœ¨æ–°çš„UIç»“æ„ä¸­ï¼Œä½¿ç”¨æ ‘å½¢é€‰æ‹©å™¨
            var categoryRow = button.closest('.category-row');
            var treeSelector = categoryRow.find('.walmart-category-tree-selector');

            // è·å–åˆ†ç±»åç§°
            var categoryTitle = categoryRow.find('.category-title').text() || 'æœªçŸ¥åˆ†ç±»';

            // ç¡®è®¤å¯¹è¯æ¡†
            var confirmMessage = `ç¡®å®šè¦æ¸…é™¤ "${categoryTitle}" çš„æ‰€æœ‰å±æ€§é…ç½®å’Œæ˜ å°„å…³ç³»å—ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\nâ€¢ æ¸…é™¤æ‰€æœ‰å±æ€§æ˜ å°„é…ç½®\nâ€¢ é‡ç½®Walmartåˆ†ç±»é€‰æ‹©\nâ€¢ å›åˆ°æœªç»‘å®šçŠ¶æ€\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;

            if (!confirm(confirmMessage)) {
                return;
            }

            button.html('<span class="dashicons dashicons-update"></span> æ¸…é™¤ä¸­...').prop('disabled', true);

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'clear_category_attributes',
                    nonce: '<?php echo wp_create_nonce('walmart_category_map_nonce'); ?>',
                    wc_category_id: wcCatId
                },
                success: function(response) {
                    if(response.success) {
                        // æ¸…é™¤å±æ€§è¡¨æ ¼
                        var tbody = mapperDiv.find('.attributes-container tbody');
                        tbody.empty();

                        // é‡ç½®Walmartåˆ†ç±»é€‰æ‹©å™¨
                        treeSelector.find('.walmart-category-value').val('');
                        treeSelector.find('.selected-category').text('-- è¯·é€‰æ‹©ä¸€ä¸ªæ²ƒå°”ç›åˆ†ç±» --');

                        // éšè—å±æ€§æ˜ å°„åŒºåŸŸ
                        mapperDiv.find('.attributes-container').hide();

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        alert('âœ… å±æ€§é…ç½®å’Œæ˜ å°„å…³ç³»å·²æ¸…é™¤ï¼\n\nåˆ†ç±»å·²å›åˆ°æœªç»‘å®šçŠ¶æ€ï¼Œæ‚¨å¯ä»¥é‡æ–°é€‰æ‹©Walmartåˆ†ç±»ã€‚');

                        // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
                        setTimeout(function() {
                            location.reload();
                        }, 1000);

                    } else {
                        alert('âŒ æ¸…é™¤å¤±è´¥: ' + (response.data || 'æœªçŸ¥é”™è¯¯'));
                    }
                },
                error: function() {
                    alert('âŒ è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                },
                complete: function() {
                    button.html('<span class="dashicons dashicons-trash"></span> æ¸…é™¤å±æ€§').prop('disabled', false);
                }
            });
        });

        // è°ƒè¯•APIå“åº”æŒ‰é’®
        $('body').on('click', '.debug-api-response-button', function() {
            var button = $(this);
            var mapperDiv = button.closest('.attribute-mapper');
            var wcCatId = mapperDiv.data('wc-cat-id');

            // æ”¯æŒæ™®é€šæ˜ å°„å’Œå…±äº«æ˜ å°„ä¸¤ç§ç»“æ„
            var categoryRow = button.closest('.category-row');
            var treeSelector = null;
            var walmartCatId = '';
            var walmartCatName = '';

            if (categoryRow.length > 0) {
                // æ™®é€šæ˜ å°„ç»“æ„
                treeSelector = categoryRow.find('.walmart-category-tree-selector');
                if (treeSelector.length > 0) {
                    walmartCatId = treeSelector.find('.walmart-category-value').val();
                    walmartCatName = treeSelector.find('.selected-category').text();
                }
            } else {
                // å…±äº«æ˜ å°„ç»“æ„
                treeSelector = mapperDiv.find('.walmart-category-tree-selector');
                if (treeSelector.length > 0) {
                    walmartCatId = treeSelector.find('.walmart-category-value').val();
                    walmartCatName = treeSelector.find('.selected-category').text();
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°éšè—çš„é€‰æ‹©å™¨ï¼Œå°è¯•ä»é¡µé¢å…¶ä»–åœ°æ–¹è·å–ä¿¡æ¯
                    var groupHeader = mapperDiv.closest('.walmart-category-group').find('.walmart-category-group-header h3');
                    if (groupHeader.length > 0) {
                        var headerText = groupHeader.text();
                        var match = headerText.match(/Walmartåˆ†ç±»:\s*(.+)$/);
                        if (match) {
                            walmartCatName = match[1].trim();
                            walmartCatId = walmartCatName; // ä½¿ç”¨åç§°ä½œä¸ºIDçš„åå¤‡
                        }
                    }
                }
            }

            if (!walmartCatId || !walmartCatName) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ²ƒå°”ç›åˆ†ç±»ã€‚');
                return;
            }

            button.text('è°ƒè¯•ä¸­...').prop('disabled', true);

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'debug_walmart_api_response',
                    nonce: '<?php echo wp_create_nonce('walmart_category_map_nonce'); ?>',
                    category_id: walmartCatId,
                    category_name: walmartCatName
                },
                success: function(response) {
                    if(response.success) {
                        // åˆ›å»ºè°ƒè¯•çª—å£
                        var debugWindow = window.open('', 'debug', 'width=1200,height=800,scrollbars=yes');
                        debugWindow.document.write('<html><head><title>Walmart APIè°ƒè¯•å“åº”</title>');
                        debugWindow.document.write('<style>');
                        debugWindow.document.write('body { font-family: Arial, sans-serif; margin: 20px; }');
                        debugWindow.document.write('h2 { color: #0073aa; border-bottom: 2px solid #0073aa; padding-bottom: 10px; }');
                        debugWindow.document.write('h3 { color: #333; margin-top: 30px; }');
                        debugWindow.document.write('.info-box { background: #f0f8ff; padding: 15px; border-left: 4px solid #0073aa; margin: 10px 0; }');
                        debugWindow.document.write('.error-box { background: #ffe6e6; padding: 15px; border-left: 4px solid #dc3545; margin: 10px 0; }');
                        debugWindow.document.write('pre { background: #f5f5f5; padding: 15px; overflow: auto; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }');
                        debugWindow.document.write('.json-key { color: #0066cc; font-weight: bold; }');
                        debugWindow.document.write('.json-string { color: #009900; }');
                        debugWindow.document.write('.json-number { color: #cc6600; }');
                        debugWindow.document.write('</style></head><body>');

                        debugWindow.document.write('<h2>ğŸ” Walmart APIè°ƒè¯•å“åº”</h2>');

                        // åŸºæœ¬ä¿¡æ¯
                        debugWindow.document.write('<div class="info-box">');
                        debugWindow.document.write('<p><strong>åˆ†ç±»åç§°:</strong> ' + response.data.category_name + '</p>');
                        debugWindow.document.write('<p><strong>åˆ†ç±»ID:</strong> ' + response.data.category_id + '</p>');
                        debugWindow.document.write('<p><strong>APIç‰ˆæœ¬:</strong> ' + response.data.api_version + '</p>');
                        debugWindow.document.write('<p><strong>APIç«¯ç‚¹:</strong> ' + response.data.endpoint + '</p>');
                        debugWindow.document.write('<p><strong>è§£æå±æ€§æ•°é‡:</strong> ' + response.data.parsed_count + '</p>');
                        debugWindow.document.write('</div>');

                        // é”™è¯¯ä¿¡æ¯
                        if (response.data.is_error) {
                            debugWindow.document.write('<div class="error-box">');
                            debugWindow.document.write('<h3>âŒ APIè°ƒç”¨é”™è¯¯</h3>');
                            debugWindow.document.write('<p>' + response.data.error_message + '</p>');
                            debugWindow.document.write('</div>');
                        }

                        // è¯·æ±‚å‚æ•°
                        debugWindow.document.write('<h3>ğŸ“¤ è¯·æ±‚å‚æ•°</h3>');
                        debugWindow.document.write('<pre>' + JSON.stringify(response.data.request_body, null, 2) + '</pre>');

                        // åŸå§‹å“åº”
                        debugWindow.document.write('<h3>ğŸ“¥ åŸå§‹APIå“åº”</h3>');
                        debugWindow.document.write('<pre>' + JSON.stringify(response.data.raw_response, null, 2) + '</pre>');

                        // è§£æç»“æœ
                        debugWindow.document.write('<h3>ğŸ”§ è§£æåçš„å±æ€§</h3>');
                        debugWindow.document.write('<pre>' + JSON.stringify(response.data.parsed_attributes, null, 2) + '</pre>');

                        debugWindow.document.write('</body></html>');
                        debugWindow.document.close();
                    } else {
                        alert('è°ƒè¯•å¤±è´¥: ' + (response.data ? response.data.message : 'æœªçŸ¥é”™è¯¯'));
                    }
                },
                error: function() {
                    alert('AJAXè¯·æ±‚å¤±è´¥ã€‚');
                },
                complete: function() {
                    button.text('è°ƒè¯•API').prop('disabled', false);
                }
            });
        });

        // é‡ç½®å±æ€§æŒ‰é’®
        $('body').on('click', '.force-replace-attributes-button', function() {
            var button = $(this);
            var mapperDiv = button.closest('.attribute-mapper');
            var wcCatId = mapperDiv.data('wc-cat-id');
            // æ”¯æŒæ™®é€šæ˜ å°„å’Œå…±äº«æ˜ å°„ä¸¤ç§ç»“æ„
            var categoryRow = button.closest('.category-row');
            var treeSelector = null;
            var walmartCatId = '';
            var walmartCatName = '';

            if (categoryRow.length > 0) {
                // æ™®é€šæ˜ å°„ç»“æ„
                treeSelector = categoryRow.find('.walmart-category-tree-selector');
                if (treeSelector.length > 0) {
                    walmartCatId = treeSelector.find('.walmart-category-value').val();
                    walmartCatName = treeSelector.find('.selected-category').text();
                }
            } else {
                // å…±äº«æ˜ å°„ç»“æ„
                treeSelector = mapperDiv.find('.walmart-category-tree-selector');
                if (treeSelector.length > 0) {
                    walmartCatId = treeSelector.find('.walmart-category-value').val();
                    walmartCatName = treeSelector.find('.selected-category').text();
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°éšè—çš„é€‰æ‹©å™¨ï¼Œå°è¯•ä»é¡µé¢å…¶ä»–åœ°æ–¹è·å–ä¿¡æ¯
                    var groupHeader = mapperDiv.closest('.walmart-category-group').find('.walmart-category-group-header h3');
                    if (groupHeader.length > 0) {
                        var headerText = groupHeader.text();
                        var match = headerText.match(/Walmartåˆ†ç±»:\s*(.+)$/);
                        if (match) {
                            walmartCatName = match[1].trim();
                            walmartCatId = walmartCatName; // ä½¿ç”¨åç§°ä½œä¸ºIDçš„åå¤‡
                        }
                    }
                }
            }

            if (!walmartCatId || !walmartCatName || walmartCatName === '-- è¯·é€‰æ‹©ä¸€ä¸ªæ²ƒå°”ç›åˆ†ç±» --') {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ²ƒå°”ç›åˆ†ç±»ã€‚');
                return;
            }

            var tbody = mapperDiv.find('.attributes-container tbody');
            var existingCount = tbody.find('tr').length;

            if (existingCount > 0) {
                var confirmReplace = confirm(
                    'ç¡®å®šè¦é‡ç½®ç°æœ‰çš„ ' + existingCount + ' ä¸ªå±æ€§å—ï¼Ÿ\n\n' +
                    'è¿™å°†æ¸…ç©ºæ‰€æœ‰ç°æœ‰å±æ€§ï¼Œé‡æ–°åŠ è½½ "' + walmartCatName + '" çš„å®Œæ•´V5.0è§„èŒƒã€‚\n\n' +
                    'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼'
                );

                if (!confirmReplace) {
                    return;
                }
            }

            button.text('é‡ç½®ä¸­...').prop('disabled', true);

            // æ¸…ç©ºç°æœ‰å±æ€§
            tbody.empty();

            // è°ƒç”¨åŠ è½½å±æ€§çš„é€»è¾‘ï¼Œä½†å¼ºåˆ¶æ›¿æ¢ï¼Œä¼˜å…ˆä»æ•°æ®åº“è¯»å–
            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'get_walmart_category_attributes',
                    nonce: '<?php echo wp_create_nonce('walmart_category_map_nonce'); ?>',
                    category_id: walmartCatId,
                    category_name: walmartCatName,
                    force_refresh: true,
                    force_replace: true,  // æ ‡è®°ä¸ºå¼ºåˆ¶æ›¿æ¢
                    use_database: true    // ä¼˜å…ˆä»æ•°æ®åº“è¯»å–å·²ä¿å­˜çš„å±æ€§
                },
                success: function(response) {
                    if(response.success) {
                        // è®°å½•å½“å‰åŠ è½½çš„åˆ†ç±»
                        tbody.data('last-loaded-category', walmartCatId);

                        // æ·»åŠ æ‰€æœ‰å±æ€§ï¼ˆä¸æ£€æŸ¥é‡å¤ï¼Œå› ä¸ºå·²ç»æ¸…ç©ºäº†ï¼‰
                        console.log('é‡ç½®å±æ€§ - å¤„ç†å±æ€§æ•°æ®:', response.data);
                        response.data.forEach(function(attr) {
                            console.log('å¤„ç†å±æ€§:', attr.attributeName, 'ç±»å‹:', attr.defaultType);

                            // è½¬æ¢ allowed_values ä¸º enumValuesï¼ˆä¿®å¤æšä¸¾å€¼æ˜¾ç¤ºé—®é¢˜ï¼‰
                            if (attr.allowed_values && !attr.enumValues) {
                                if (typeof attr.allowed_values === 'string') {
                                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ŒæŒ‰ | åˆ†å‰²
                                    attr.enumValues = attr.allowed_values.split('|').filter(function(val) {
                                        return val.trim() && !val.startsWith('UNITS:') && !val.startsWith('DEFAULT_UNIT:');
                                    });
                                } else if (Array.isArray(attr.allowed_values)) {
                                    // å¦‚æœå·²ç»æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨
                                    attr.enumValues = attr.allowed_values;
                                }
                                console.log('è½¬æ¢æšä¸¾å€¼:', attr.attributeName, 'æšä¸¾å€¼:', attr.enumValues);
                            }
                            var newRow = $('#attribute-row-template').html().replace(/{wc_cat_id}/g, wcCatId);
                            var $newRow = $(newRow);
                            $newRow.find('input[name*="[name]"]').val(attr.attributeName).prop('readonly', true);

                            // ä¸ºç‰¹å®šå­—æ®µè®¾ç½®é»˜è®¤ç±»å‹å’Œå€¼
                            var autoGenerateFields = [
                                'productName', 'brand', 'shortDescription', 'keyFeatures', 'mainImageUrl', 'material',
                                'bed_frame_type', 'bed_type', 'bedSize', 'finish', 'assembledProductLength', 'assembledProductWidth', 'assembledProductHeight', 'assembledProductWeight',
                                'productSecondaryImageURL', 'productIdentifiers', 'netContent', 'box_spring_required', 'color', 'colorCategory',
                                'items_included', 'manufacturerPartNumber', 'maximumLoadWeight', 'modelNumber',
                                'productLine', 'swatchImages', 'sku', 'price', 'ShippingWeight', 'bed_frame_adjustability',
                                'electronicsIndicator', 'fulfillmentCenterID', 'releaseDate', 'startDate', 'endDate',
                                'arm_height', 'has_storage', 'has_trundle', 'homeDecorStyle', 'numberOfDrawers', 'numberOfShelves', 'upholstered', 'wood_type', 'wood_tone', 'profile', 'theme', 'arm_style', 'frameColor', 'chair_style', 'frameMaterial', 'ottoman_included', 'pattern', 'leg_color', 'leg_material', 'preset_bed_positions', 'dining_chair_type', 'seat_back_style', 'seat_back_cushion_style', 'seat_back_thickness', 'seat_back_width', 'seat_color', 'seat_depth', 'seat_material', 'seat_width', 'seatBackHeight', 'seatHeight', 'seatingCapacity', 'recommendedLocations',
                                // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µ
                                'base_style', 'baseColor', 'baseMaterial', 'is_extendable', 'table_leaf_type', 'table_shape', 'table_top__material', 'top_color',
                                // ğŸ†• é€šç”¨å½¢çŠ¶å­—æ®µ
                                'shape',
                                // ğŸ†• é—¨æ•°é‡å­—æ®µ
                                'number_of_doors',
                                // ğŸ†• å±‚æ•°å­—æ®µ
                                'number_of_tiers',
                                // ğŸ†• åº“å­˜æ•°é‡å­—æ®µ
                                'quantity',
                                // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µ
                                'table_color', 'table_top_type', 'tableHeight',
                                // ğŸ†• æŸœä½“ç›¸å…³å­—æ®µ
                                // ğŸ†• backing_material å­—æ®µ
                                'backing_material',
                                'cabinet_color', 'cabinet_material', 'hardwareFinish', 'recommendedRooms',
                                // ğŸ†• åˆ†ç±»ç‰¹å®šfeatureså­—æ®µ
                                'features',
                                // ğŸ†• é€šç”¨å­—æ®µæ‹“å±• - 2025-10-12 (ç¬¬ä¸€æ‰¹)
                                'frame_finish', 'handle_width', 'handleMaterial', 'kitchen_serving_and_storage_cart_type',
                                'numberOfHooks', 'numberOfWheels', 'topMaterial',
                                // ğŸ†• é€šç”¨å­—æ®µæ‹“å±• - 2025-10-12 (ç¬¬äºŒæ‰¹)
                                'dining_furniture_set_type', 'overall_chair_depth', 'overall_chair_height', 'overall_chair_width',
                                'seat_back_height_descriptor', 'seating_capacity_with_leaf', 'table_length', 'table_width',
                                // ğŸ†• é€šç”¨å­—æ®µæ‹“å±• - 2025-10-13 (ç¬¬ä¸‰æ‰¹)
                                'sizeDescriptor', 'sofa_and_loveseat_design', 'sofa_bed_size',
                                // ğŸ†• åœ°æ¯¯ç›¸å…³å­—æ®µ - 2025-10-28
                                'pile_thickness', 'pileHeight', 'rug_construction', 'rug_technique_weave',
                                // ğŸ†• åœ°æ¯¯å°ºå¯¸å­—æ®µ - 2025-10-28
                                'rugSize', 'size',
                                // ğŸ†• ç¯ç½©é…ä»¶ç±»å‹å­—æ®µ - 2025-10-28
                                'lamp_shade_fitter_type',
                                // ğŸ†• åœ£è¯æ ‘ç›¸å…³å­—æ®µ - 2025-10-28
                                'christmas_tree_feature', 'christmas_tree_shape', 'christmas_tree_type',
                                // ğŸ†• é¢œè‰²å’ŒåŒ…è£…ç›¸å…³å­—æ®µ - 2025-10-28
                                'colorDescriptor', 'frameColorConfiguration',
                                // ğŸ†• è®¤è¯å’ŒåŒ…è£…å­—æ®µ - 2025-10-28
                                'has_nrtl_listing_certification', 'ib_retail_packaging', 'isCollectible',
                                // ğŸ†• ç¯å…‰ç›¸å…³å­—æ®µ - 2025-10-28
                                'light_functions', 'lightBulbColor', 'lightBulbType', 'numberOfLights',
                                // ğŸ†• æ ‘æœ¨ç±»å‹å­—æ®µ - 2025-10-28
                                'tree_type',
                                // ğŸ†• è£…é¥°å’Œå¢™è´´ç›¸å…³å­—æ®µ - 2025-10-29
                                'alphanumericCharacter', 'subject', 'wall_decal_and_sticker_type',
                                // ğŸ†• æ¤ç‰©ç›†æ ½ç›¸å…³å­—æ®µ - 2025-10-29
                                'plant_pot_and_planter_type',
                                // ğŸ†• é—¨å’ŒæŸœå­ç›¸å…³å­—æ®µ - 2025-10-30
                                'doorOpeningStyle', 'cabinet_type', 'doorStyle',
                                // ğŸ†• æŠ½å±‰å°ºå¯¸å’Œå®‰è£…ç›¸å…³å­—æ®µ - 2025-10-30
                                'drawer_depth', 'drawer_height', 'drawer_width', 'has_doors', 'mountType', 'orientation',
                                // ğŸ†• è£…é¥°æ•ç›¸å…³å­—æ®µ - 2025-11-04
                                'decorative_pillow_type', 'is_filled'
                            ];
                            var walmartFields = {
                                'isProp65WarningRequired': 'No',
                                'condition': 'New',
                                'has_written_warranty': 'Yes - Warranty Text',
                                'smallPartsWarnings': '0 - No warning applicable',
                                'ageGroup': 'Adult',
                                'batteryTechnologyType': 'Does Not Contain a Battery',
                                'chemicalAerosolPesticide': 'No',
                                'features': 'Under Bed Storage',
                                'gender': 'Unisex',
                                'isAssemblyRequired': 'Yes',
                                'IsPreorder': 'No',
                                'isPrimaryVariant': 'No',
                                'MustShipAlone': 'Yes',
                                'ProductIdUpdate': 'No',
                                'shipsInOriginalPackaging': 'Yes'
                            };
                            var defaultValueFields = {
                                'warrantyText': 'This warranty does not cover damages caused by misuse, drops, or human error.',
                                'assemblyInstructions': 'Assembly is effortless with our clear instructions and intuitive design. You\'ll have it set up and ready to enjoy in just a few simple minutes.',
                                'countPerPack': '1',
                                'inflexKitComponent': 'No',
                                'isAssemblyRequired': 'Yes',
                                'multipackQuantity': '1',
                                'pieceCount': '1',

                                'profile': 'Profile',
                                'suggested_number_of_people_for_assembly': '2',
                                'count': '1',
                                'occasion': 'Labor Day;Memorial Day;Independence Day;Black Friday;Cyber Monday;Christmas;New Year;Presidents\' Day;Thanksgiving',
                                'stateRestrictions': 'None',
                                'chemicalAerosolPesticide': 'No',
                                'batteryTechnologyType': 'Does Not Contain a Battery',
                                'fillMaterial': 'Foam',
                                'cleaningCareAndMaintenance': 'Clean regularly with a soft, damp cloth to remove dust and food stains.',
                                'fulfillmentLagTime': '1',
                                'shipsInOriginalPackaging': 'Yes',
                                'MustShipAlone': 'Yes',
                                // ğŸ†• è®¢å•æ•°é‡é™åˆ¶å­—æ®µ
                                'maximumOrderQuantity': '20',
                                'minimumOrderQuantity': '1',
                                'IsPreorder': 'No'
                            };

                            var sourceCell = $newRow.find('.source-cell');
                            var selectName = 'attributes[' + wcCatId + '][source][]';

                            // é‡ç½®å±æ€§æ—¶ä¸éœ€è¦æ£€æŸ¥å·²å­˜åœ¨å­—æ®µï¼Œå› ä¸ºå·²ç»æ¸…ç©ºäº†è¡¨æ ¼

                            if (autoGenerateFields.includes(attr.attributeName)) {
                                // è‡ªåŠ¨ç”Ÿæˆå­—æ®µï¼ˆä»…å¯¹æ–°å­—æ®µæˆ–æœªä¿®æ”¹å­—æ®µï¼‰
                                $newRow.find('.attr-type-selector').val('auto_generate');
                                var generationRule = getAutoGenerationRule(attr.attributeName);
                                sourceCell.html('<span style="color: #0073aa; font-weight: 500;">' + generationRule + '</span><input type="hidden" name="' + selectName + '" value="auto">');
                                console.log('é‡ç½®å±æ€§ - å·²è®¾ç½®è‡ªåŠ¨ç”Ÿæˆå­—æ®µ:', attr.attributeName, generationRule);
                            } else if (attr.enumValues && attr.enumValues.length > 0) {
                                // æœ‰æšä¸¾å€¼çš„å­—æ®µ - åˆ›å»ºä¸‹æ‹‰é€‰æ‹©å™¨
                                $newRow.find('.attr-type-selector').val('walmart_field');
                                var walmart_field_select = $('<select name="' + selectName + '" class="walmart-field-selector"></select>');
                                walmart_field_select.append('<option value="">é€‰æ‹©æ²ƒå°”ç›å­—æ®µå€¼</option>');

                                // ç›´æ¥ä½¿ç”¨é‡ç½®æ—¶è·å–çš„æšä¸¾å€¼ï¼Œä¸ä¾èµ–åç»­AJAXè°ƒç”¨
                                attr.enumValues.forEach(function(enumValue) {
                                    walmart_field_select.append('<option value="' + enumValue + '">' + enumValue + '</option>');
                                });

                                // è®¾ç½®é»˜è®¤å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
                                var defaultValue = walmartFields[attr.attributeName] || '';
                                if (defaultValue) {
                                    walmart_field_select.val(defaultValue);
                                }

                                sourceCell.html(walmart_field_select);
                                console.log('é‡ç½®å±æ€§ - å·²è®¾ç½®æšä¸¾å­—æ®µé€‰æ‹©å™¨:', attr.attributeName, 'æšä¸¾å€¼:', attr.enumValues);
                            } else if (walmartFields[attr.attributeName]) {
                                // é¢„å®šä¹‰æ²ƒå°”ç›å­—æ®µï¼ˆæ— æšä¸¾å€¼ï¼‰
                                $newRow.find('.attr-type-selector').val('walmart_field');
                                var walmart_field_select = $('<select name="' + selectName + '" class="walmart-field-selector"></select>');
                                walmart_field_select.append('<option value="">é€‰æ‹©æ²ƒå°”ç›å­—æ®µå€¼</option>');
                                loadWalmartFieldOptions(walmart_field_select, attr.attributeName, walmartFields[attr.attributeName], null);
                                sourceCell.html(walmart_field_select);
                                console.log('é‡ç½®å±æ€§ - å·²è®¾ç½®é¢„å®šä¹‰æ²ƒå°”ç›å­—æ®µ:', attr.attributeName, walmartFields[attr.attributeName]);
                            } else if (defaultValueFields[attr.attributeName]) {
                                // é»˜è®¤å€¼å­—æ®µ - åªåœ¨é‡ç½®æ—¶è®¾ç½®ï¼Œä¸è¦†ç›–å·²ä¿å­˜çš„å€¼
                                $newRow.find('.attr-type-selector').val('default_value');
                                sourceCell.html('<input type="text" name="' + selectName + '" value="' + defaultValueFields[attr.attributeName] + '" placeholder="è¾“å…¥é»˜è®¤å€¼">');
                                console.log('é‡ç½®å±æ€§ - å·²è®¾ç½®é»˜è®¤å€¼å­—æ®µ:', attr.attributeName, defaultValueFields[attr.attributeName]);
                            }

                            // ç§»é™¤ç‰¹æ®Šæ ¼å¼å¤„ç† - è®©è‡ªåŠ¨æ£€æµ‹é€»è¾‘å¤„ç†æ‰€æœ‰æ ¼å¼è½¬æ¢



                            // æ ¹æ®å±æ€§åˆ†ç»„å’Œæ˜¯å¦å¿…å¡«æ¥æ˜¾ç¤ºæ ‡è¯†
                            var isRequired = attr.isrequired || false;
                            var group = attr.group || 'General';

                            if (isRequired) {
                                var requiredText = '';
                                var requiredColor = '';
                                var requiredIcon = 'â– ';

                                switch(group) {
                                    case 'Visible':
                                        requiredText = requiredIcon + ' ç±»ç›®å¿…å¡«';
                                        requiredColor = '#fd7e14';
                                        break;
                                    case 'Orderable':
                                        requiredText = requiredIcon + ' é€šç”¨å¿…å¡«';
                                        requiredColor = '#dc3545';
                                        break;
                                    default:
                                        requiredText = requiredIcon + ' å¿…å¡«';
                                        requiredColor = '#dc3545';
                                }

                                $newRow.find('input[name*="[name]"]').after(' <span class="is-required" style="color: ' + requiredColor + '; font-weight: bold; font-size: 11px;" title="' + requiredText + '">' + requiredText + '</span>');
                            } else {
                                $newRow.find('input[name*="[name]"]').after(' <span class="is-recommended" style="color: #198754; font-weight: bold; font-size: 11px;" title="æ¨èå¡«å†™">â–  æ¨è</span>');
                            }

                            var requiredValue = isRequired ? '1' : '0';
                            $newRow.append('<input type="hidden" name="required_levels[' + wcCatId + '][]" value="' + requiredValue + '">');
                            $newRow.append('<input type="hidden" name="attribute_groups[' + wcCatId + '][]" value="' + group + '">');

                            // å¦‚æœæœ‰æšä¸¾å€¼ï¼Œå­˜å‚¨åˆ°dataå±æ€§ä¸­å¹¶æ·»åŠ éšè—å­—æ®µï¼ˆä¿®å¤é‡ç½®å±æ€§åæšä¸¾å€¼ä¸æ˜¾ç¤ºçš„é—®é¢˜ï¼‰
                            if (attr.enumValues && attr.enumValues.length > 0) {
                                // å­˜å‚¨æšä¸¾å€¼åˆ°å…ƒç´ çš„dataå±æ€§ä¸­ï¼Œä¾›åç»­ä½¿ç”¨
                                $newRow.find('.attr-type-selector').data('enum-values', attr.enumValues);

                                // æ·»åŠ éšè—å­—æ®µä¿å­˜æšä¸¾å€¼åˆ°è¡¨å•ä¸­
                                var enumValuesJson = JSON.stringify(attr.enumValues);
                                $newRow.append('<input type="hidden" name="enum_values[' + wcCatId + '][]" value="' + enumValuesJson.replace(/"/g, '&quot;') + '">');

                                console.log('é‡ç½®å±æ€§ - å·²è®¾ç½®æšä¸¾å€¼:', attr.attributeName, attr.enumValues);
                            }

                            // ç§»é™¤æ ¼å¼ç›¸å…³çš„æ•°æ®æ ‡è®° - è®©è‡ªåŠ¨æ£€æµ‹é€»è¾‘å¤„ç†

                            tbody.append($newRow);

                            // é‡ç½®å±æ€§æ—¶ä¸éœ€è¦è§¦å‘changeäº‹ä»¶ï¼Œå› ä¸ºæšä¸¾å€¼å·²ç»ç›´æ¥è®¾ç½®å¥½äº†
                        });

                        // æ›´æ–°å±æ€§æ•°é‡æ˜¾ç¤º
                        updateAttributeCount(mapperDiv);

                        // æ˜¾ç¤ºå¿…å¡«çº§åˆ«è¯´æ˜
                        button.closest('.attribute-mapper').find('.required-level-info').show();
                        alert('é‡ç½®æˆåŠŸï¼å·²åŠ è½½ ' + response.data.length + ' ä¸ªæœ€æ–°å±æ€§ã€‚');
                    } else {
                        alert('é‡ç½®å¤±è´¥: ' + response.data.message);
                    }
                },
                error: function() {
                    alert('é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                },
                complete: function() {
                    button.text('é‡ç½®å±æ€§').prop('disabled', false);
                }
            });
        });

        // Fetch attributes button (ä¿®å¤é€‰æ‹©å™¨è·¯å¾„é—®é¢˜)
        $('body').on('click', '.fetch-attributes-button', function() {
            var button = $(this);
            var mapperDiv = button.closest('.attribute-mapper');
            var wcCatId = mapperDiv.data('wc-cat-id');

            // ä¿®å¤ï¼šæ”¯æŒæ™®é€šæ˜ å°„å’Œå…±äº«æ˜ å°„ä¸¤ç§ç»“æ„
            var categoryRow = button.closest('.category-row');
            var treeSelector = null;
            var walmartCatId = '';
            var walmartCatName = '';

            if (categoryRow.length > 0) {
                // æ™®é€šæ˜ å°„ç»“æ„
                treeSelector = categoryRow.find('.walmart-category-tree-selector');
                if (treeSelector.length > 0) {
                    walmartCatId = treeSelector.find('.walmart-category-value').val();
                    walmartCatName = treeSelector.find('.selected-category').text();
                }
            } else {
                // å…±äº«æ˜ å°„ç»“æ„
                treeSelector = mapperDiv.find('.walmart-category-tree-selector');
                if (treeSelector.length > 0) {
                    walmartCatId = treeSelector.find('.walmart-category-value').val();
                    walmartCatName = treeSelector.find('.selected-category').text();
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°éšè—çš„é€‰æ‹©å™¨ï¼Œå°è¯•ä»é¡µé¢å…¶ä»–åœ°æ–¹è·å–ä¿¡æ¯
                    var groupHeader = mapperDiv.closest('.walmart-category-group').find('.walmart-category-group-header h3');
                    if (groupHeader.length > 0) {
                        var headerText = groupHeader.text();
                        var match = headerText.match(/Walmartåˆ†ç±»:\s*(.+)$/);
                        if (match) {
                            walmartCatName = match[1].trim();
                            walmartCatId = walmartCatName; // ä½¿ç”¨åç§°ä½œä¸ºIDçš„åå¤‡
                        }
                    }
                }
            }

            // è°ƒè¯•ä¿¡æ¯ï¼ˆå¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç§»é™¤ï¼‰
            if (window.console && console.log) {
                console.log('Debug fetch attributes:', {
                    wcCatId: wcCatId,
                    walmartCatId: walmartCatId,
                    walmartCatName: walmartCatName,
                    selectorFound: treeSelector.length > 0
                });
            }

            if (!walmartCatId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ²ƒå°”ç›åˆ†ç±»ã€‚');
                return;
            }

            button.text('åŠ è½½ä¸­...').prop('disabled', true);
            
            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'get_walmart_category_attributes',
                    nonce: '<?php echo wp_create_nonce('walmart_category_map_nonce'); ?>',
                    category_id: walmartCatId,
                    category_name: walmartCatName,
                    force_refresh: true  // å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ä»¥ç¡®ä¿V5.0å±æ€§æ­£ç¡®æ˜¾ç¤º
                },
                success: function(response) {
                    if(response.success) {
                        var tbody = mapperDiv.find('.attributes-container tbody');

                        // æ£€æŸ¥æ˜¯å¦æ›´æ¢äº†åˆ†ç±»
                        var lastLoadedCategory = tbody.data('last-loaded-category');
                        var currentCategory = walmartCatId;
                        var categoryChanged = lastLoadedCategory && lastLoadedCategory !== currentCategory;

                        // å¦‚æœæ›´æ¢äº†åˆ†ç±»ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦æ›¿æ¢æ‰€æœ‰å±æ€§
                        if (categoryChanged) {
                            var confirmReplace = confirm(
                                'æ£€æµ‹åˆ°æ‚¨æ›´æ¢äº†Walmartåˆ†ç±»ï¼ˆä» "' + lastLoadedCategory + '" åˆ° "' + currentCategory + '"ï¼‰ã€‚\n\n' +
                                'ç‚¹å‡»"ç¡®å®š"ï¼šæ¸…ç©ºç°æœ‰å±æ€§ï¼ŒåŠ è½½æ–°åˆ†ç±»çš„å±æ€§\n' +
                                'ç‚¹å‡»"å–æ¶ˆ"ï¼šä¿ç•™ç°æœ‰å±æ€§ï¼Œåªæ·»åŠ æ–°çš„å±æ€§'
                            );

                            if (confirmReplace) {
                                // æ¸…ç©ºæ‰€æœ‰ç°æœ‰å±æ€§
                                tbody.empty();
                            }
                        }
                        // å¦‚æœæ˜¯ç›¸åŒåˆ†ç±»ï¼Œè¯¢é—®æ˜¯å¦è¦å®Œå…¨æ›¿æ¢
                        else if (tbody.find('tr').length > 0) {
                            var confirmRefresh = confirm(
                                'å½“å‰å·²æœ‰ ' + tbody.find('tr').length + ' ä¸ªå±æ€§ã€‚\n\n' +
                                'ç‚¹å‡»"ç¡®å®š"ï¼šæ¸…ç©ºç°æœ‰å±æ€§ï¼Œé‡æ–°åŠ è½½æœ€æ–°è§„èŒƒ\n' +
                                'ç‚¹å‡»"å–æ¶ˆ"ï¼šä¿ç•™ç°æœ‰å±æ€§ï¼Œåªæ·»åŠ æ–°çš„å±æ€§'
                            );

                            if (confirmRefresh) {
                                // æ¸…ç©ºæ‰€æœ‰ç°æœ‰å±æ€§
                                tbody.empty();
                            }
                        }

                        // è®°å½•å½“å‰åŠ è½½çš„åˆ†ç±»
                        tbody.data('last-loaded-category', currentCategory);

                        // æ·»åŠ æ–°å±æ€§
                        console.log('æ™ºèƒ½åŠ è½½ - å¤„ç†å±æ€§æ•°æ®:', response.data);
                        response.data.forEach(function(attr) {
                            console.log('å¤„ç†å±æ€§:', attr.attributeName, 'ç±»å‹:', attr.defaultType);

                            // è½¬æ¢ allowed_values ä¸º enumValuesï¼ˆä¿®å¤æšä¸¾å€¼æ˜¾ç¤ºé—®é¢˜ï¼‰
                            if (attr.allowed_values && !attr.enumValues) {
                                if (typeof attr.allowed_values === 'string') {
                                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ŒæŒ‰ | åˆ†å‰²
                                    attr.enumValues = attr.allowed_values.split('|').filter(function(val) {
                                        return val.trim() && !val.startsWith('UNITS:') && !val.startsWith('DEFAULT_UNIT:');
                                    });
                                } else if (Array.isArray(attr.allowed_values)) {
                                    // å¦‚æœå·²ç»æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨
                                    attr.enumValues = attr.allowed_values;
                                }
                                console.log('è½¬æ¢æšä¸¾å€¼:', attr.attributeName, 'æšä¸¾å€¼:', attr.enumValues);
                            }
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåå±æ€§ï¼Œé¿å…é‡å¤æ·»åŠ 
                            var exists = false;
                            tbody.find('input[name*="[name]"]').each(function() {
                                if ($(this).val() === attr.attributeName) {
                                    exists = true;
                                }
                            });

                            if (!exists) {
                                var newRow = $('#attribute-row-template').html().replace(/{wc_cat_id}/g, wcCatId);
                                var $newRow = $(newRow);
                                $newRow.find('input[name*="[name]"]').val(attr.attributeName).prop('readonly', true); // è‡ªåŠ¨åŠ è½½çš„åªè¯»

                                // ä¸ºç‰¹å®šå­—æ®µè®¾ç½®é»˜è®¤ç±»å‹å’Œå€¼ï¼ˆä»…åœ¨æ™ºèƒ½åŠ è½½æ–°å­—æ®µæ—¶ï¼‰
                                var autoGenerateFields = [
                                    'productName', 'brand', 'shortDescription', 'keyFeatures', 'mainImageUrl', 'material',
                                    'bed_frame_type', 'bed_type', 'bedSize', 'finish', 'assembledProductLength', 'assembledProductWidth', 'assembledProductHeight', 'assembledProductWeight',
                                    'productSecondaryImageURL', 'productIdentifiers', 'netContent', 'box_spring_required', 'color', 'colorCategory',
                                    'items_included', 'manufacturerPartNumber', 'maximumLoadWeight', 'modelNumber',
                                    'productLine', 'swatchImages', 'sku', 'price', 'ShippingWeight', 'bed_frame_adjustability',
                                    'electronicsIndicator', 'fulfillmentCenterID', 'releaseDate', 'startDate', 'endDate',
                                    'arm_height', 'has_storage', 'has_trundle', 'homeDecorStyle', 'numberOfDrawers', 'numberOfShelves', 'upholstered', 'wood_type', 'wood_tone', 'profile', 'theme', 'arm_style', 'frameColor', 'chair_style', 'frameMaterial', 'ottoman_included', 'pattern', 'leg_color', 'leg_material', 'preset_bed_positions', 'dining_chair_type', 'seat_back_style', 'seat_back_cushion_style', 'seat_back_thickness', 'seat_back_width', 'seat_color', 'seat_depth', 'seat_material', 'seat_width', 'seatBackHeight', 'seatHeight', 'seatingCapacity', 'recommendedLocations',
                                    // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µ
                                    'base_style', 'baseColor', 'baseMaterial', 'is_extendable', 'table_leaf_type', 'table_shape', 'table_top__material', 'top_color',
                                    // ğŸ†• é€šç”¨å½¢çŠ¶å­—æ®µ
                                    'shape',
                                    // ğŸ†• é—¨æ•°é‡å­—æ®µ
                                    'number_of_doors',
                                    // ğŸ†• å±‚æ•°å­—æ®µ
                                    'number_of_tiers',
                                    // ğŸ†• åº“å­˜æ•°é‡å­—æ®µ
                                    'quantity',
                                    // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µ
                                    'table_color', 'table_top_type', 'tableHeight',
                                    // ğŸ†• æŸœä½“ç›¸å…³å­—æ®µ
                                    // ğŸ†• backing_material å­—æ®µ
                                    'backing_material',
                                    'cabinet_color', 'cabinet_material', 'hardwareFinish', 'recommendedRooms',
                                    // ğŸ†• åˆ†ç±»ç‰¹å®šfeatureså­—æ®µ
                                    'features',
                                    // ğŸ†• é€šç”¨å­—æ®µæ‹“å±• - 2025-10-12 (ç¬¬ä¸€æ‰¹)
                                    'frame_finish', 'handle_width', 'handleMaterial', 'kitchen_serving_and_storage_cart_type',
                                    'numberOfHooks', 'numberOfWheels', 'topMaterial',
                                    // ğŸ†• é€šç”¨å­—æ®µæ‹“å±• - 2025-10-12 (ç¬¬äºŒæ‰¹)
                                    'dining_furniture_set_type', 'overall_chair_depth', 'overall_chair_height', 'overall_chair_width',
                                    'seat_back_height_descriptor', 'seating_capacity_with_leaf', 'table_length', 'table_width',
                                    // ğŸ†• é€šç”¨å­—æ®µæ‹“å±• - 2025-10-13 (ç¬¬ä¸‰æ‰¹)
                                    'sizeDescriptor', 'sofa_and_loveseat_design', 'sofa_bed_size',
                                    // ğŸ†• åœ°æ¯¯ç›¸å…³å­—æ®µ - 2025-10-28
                                    'pile_thickness', 'pileHeight', 'rug_construction', 'rug_technique_weave',
                                    // ğŸ†• åœ°æ¯¯å°ºå¯¸å­—æ®µ - 2025-10-28
                                    'rugSize', 'size',
                                    // ğŸ†• ç¯ç½©é…ä»¶ç±»å‹å­—æ®µ - 2025-10-28
                                    'lamp_shade_fitter_type',
                                    // ğŸ†• åœ£è¯æ ‘ç›¸å…³å­—æ®µ - 2025-10-28
                                    'christmas_tree_feature', 'christmas_tree_shape', 'christmas_tree_type',
                                    // ğŸ†• é¢œè‰²å’ŒåŒ…è£…ç›¸å…³å­—æ®µ - 2025-10-28
                                    'colorDescriptor', 'frameColorConfiguration',
                                    // ğŸ†• è®¤è¯å’ŒåŒ…è£…å­—æ®µ - 2025-10-28
                                    'has_nrtl_listing_certification', 'ib_retail_packaging', 'isCollectible',
                                    // ğŸ†• ç¯å…‰ç›¸å…³å­—æ®µ - 2025-10-28
                                    'light_functions', 'lightBulbColor', 'lightBulbType', 'numberOfLights',
                                    // ğŸ†• æ ‘æœ¨ç±»å‹å­—æ®µ - 2025-10-28
                                    'tree_type',
                                    // ğŸ†• è£…é¥°å’Œå¢™è´´ç›¸å…³å­—æ®µ - 2025-10-29
                                    'alphanumericCharacter', 'subject', 'wall_decal_and_sticker_type',
                                    // ğŸ†• æ¤ç‰©ç›†æ ½ç›¸å…³å­—æ®µ - 2025-10-29
                                    'plant_pot_and_planter_type',
                                    // ğŸ†• é—¨å’ŒæŸœå­ç›¸å…³å­—æ®µ - 2025-10-30
                                    'doorOpeningStyle', 'cabinet_type', 'doorStyle',
                                    // ğŸ†• æŠ½å±‰å°ºå¯¸å’Œå®‰è£…ç›¸å…³å­—æ®µ - 2025-10-30
                                    'drawer_depth', 'drawer_height', 'drawer_width', 'has_doors', 'mountType', 'orientation',
                                    // ğŸ†• è£…é¥°æ•ç›¸å…³å­—æ®µ - 2025-11-04
                                    'decorative_pillow_type', 'is_filled'
                                ];
                                var walmartFields = {
                                    'isProp65WarningRequired': 'No',
                                    'condition': 'New',
                                    'has_written_warranty': 'Yes - Warranty Text',
                                    'smallPartsWarnings': '0 - No warning applicable',
                                    'ageGroup': 'Adult',
                                    'batteryTechnologyType': 'Does Not Contain a Battery',
                                    'chemicalAerosolPesticide': 'No',
                                    'features': 'Under Bed Storage',
                                    'gender': 'Unisex',
                                    'isAssemblyRequired': 'Yes',
                                    'IsPreorder': 'No',
                                    'isPrimaryVariant': 'No',
                                    'MustShipAlone': 'Yes',
                                    'ProductIdUpdate': 'No',
                                    'shipsInOriginalPackaging': 'Yes'
                                };
                                var defaultValueFields = {
                                    'warrantyText': 'This warranty does not cover damages caused by misuse, drops, or human error.',
                                    'assemblyInstructions': 'Assembly is effortless with our clear instructions and intuitive design. You\'ll have it set up and ready to enjoy in just a few simple minutes.',
                                    'countPerPack': '1',
                                    'inflexKitComponent': 'No',
                                    'isAssemblyRequired': 'Yes',
                                    'multipackQuantity': '1',
                                    'pieceCount': '1',

                                    'profile': 'Profile',
                                    'suggested_number_of_people_for_assembly': '2',
                                    'count': '1',
                                    'stateRestrictions': 'None',
                                    'chemicalAerosolPesticide': 'No',
                                    'batteryTechnologyType': 'Does Not Contain a Battery',
                                    'fillMaterial': 'Foam',
                                    'cleaningCareAndMaintenance': 'Clean regularly with a soft, damp cloth to remove dust and food stains.',
                                    'fulfillmentLagTime': '1',
                                    'shipsInOriginalPackaging': 'Yes',
                                    'MustShipAlone': 'Yes',
                                    'IsPreorder': 'No',
                                    // ğŸ†• è®¢å•æ•°é‡é™åˆ¶å­—æ®µ
                                    'maximumOrderQuantity': '20',
                                    'minimumOrderQuantity': '1',
                                    'occasion': 'Labor Day;Memorial Day;Independence Day;Black Friday;Cyber Monday;Christmas;New Year;Presidents\' Day;Thanksgiving'
                                };

                                var sourceCell = $newRow.find('.source-cell');
                                var selectName = 'attributes[' + wcCatId + '][source][]';

                                // æ£€æŸ¥å­—æ®µæ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…è¦†ç›–ç”¨æˆ·è®¾ç½®ï¼‰
                                var existingRow = tbody.find('input[name*="[name]"][value="' + attr.attributeName + '"]').closest('tr');
                                if (existingRow.length > 0) {
                                    // å­—æ®µå·²å­˜åœ¨ï¼Œè·³è¿‡è‡ªåŠ¨è®¾ç½®ï¼Œä¿ç•™ç”¨æˆ·é…ç½®
                                    console.log('æ™ºèƒ½åŠ è½½ - è·³è¿‡å·²å­˜åœ¨å­—æ®µ:', attr.attributeName);
                                    return; // è·³è¿‡è¿™ä¸ªå­—æ®µ
                                }

                                if (autoGenerateFields.includes(attr.attributeName)) {
                                    // è‡ªåŠ¨ç”Ÿæˆå­—æ®µï¼ˆä»…å¯¹æ–°å­—æ®µï¼‰
                                    $newRow.find('.attr-type-selector').val('auto_generate');
                                    var generationRule = getAutoGenerationRule(attr.attributeName);
                                    sourceCell.html('<span style="color: #0073aa; font-weight: 500;">' + generationRule + '</span><input type="hidden" name="' + selectName + '" value="auto">');
                                    console.log('æ™ºèƒ½åŠ è½½ - å·²è®¾ç½®è‡ªåŠ¨ç”Ÿæˆå­—æ®µ:', attr.attributeName, generationRule);
                                } else if (attr.enumValues && attr.enumValues.length > 0) {
                                    // æœ‰æšä¸¾å€¼çš„å­—æ®µ - åˆ›å»ºä¸‹æ‹‰é€‰æ‹©å™¨
                                    $newRow.find('.attr-type-selector').val('walmart_field');
                                    var walmart_field_select = $('<select name="' + selectName + '" class="walmart-field-selector"></select>');
                                    walmart_field_select.append('<option value="">é€‰æ‹©æ²ƒå°”ç›å­—æ®µå€¼</option>');

                                    // åŠ è½½æšä¸¾å€¼ï¼Œä¼˜å…ˆä½¿ç”¨é¢„å®šä¹‰çš„é»˜è®¤å€¼
                                    var defaultValue = walmartFields[attr.attributeName] || '';
                                    loadWalmartFieldOptions(walmart_field_select, attr.attributeName, defaultValue, attr.enumValues);
                                    sourceCell.html(walmart_field_select);
                                    console.log('æ™ºèƒ½åŠ è½½ - å·²è®¾ç½®æšä¸¾å­—æ®µé€‰æ‹©å™¨:', attr.attributeName, 'æšä¸¾å€¼:', attr.enumValues);
                                } else if (walmartFields[attr.attributeName]) {
                                    // é¢„å®šä¹‰æ²ƒå°”ç›å­—æ®µï¼ˆæ— æšä¸¾å€¼ï¼‰
                                    $newRow.find('.attr-type-selector').val('walmart_field');
                                    var walmart_field_select = $('<select name="' + selectName + '" class="walmart-field-selector"></select>');
                                    walmart_field_select.append('<option value="">é€‰æ‹©æ²ƒå°”ç›å­—æ®µå€¼</option>');
                                    loadWalmartFieldOptions(walmart_field_select, attr.attributeName, walmartFields[attr.attributeName], null);
                                    sourceCell.html(walmart_field_select);
                                    console.log('æ™ºèƒ½åŠ è½½ - å·²è®¾ç½®é¢„å®šä¹‰æ²ƒå°”ç›å­—æ®µ:', attr.attributeName, walmartFields[attr.attributeName]);
                                } else if (defaultValueFields[attr.attributeName]) {
                                    // é»˜è®¤å€¼å­—æ®µ
                                    $newRow.find('.attr-type-selector').val('default_value');
                                    sourceCell.html('<input type="text" name="' + selectName + '" value="' + defaultValueFields[attr.attributeName] + '" placeholder="è¾“å…¥é»˜è®¤å€¼">');
                                    console.log('æ™ºèƒ½åŠ è½½ - å·²è®¾ç½®é»˜è®¤å€¼å­—æ®µ:', attr.attributeName, defaultValueFields[attr.attributeName]);
                                }

                                // ç§»é™¤ç‰¹æ®Šæ ¼å¼å¤„ç† - è®©è‡ªåŠ¨æ£€æµ‹é€»è¾‘å¤„ç†æ‰€æœ‰æ ¼å¼è½¬æ¢



                                // æ ¹æ®å±æ€§åˆ†ç»„å’Œæ˜¯å¦å¿…å¡«æ¥æ˜¾ç¤ºæ ‡è¯†
                                var isRequired = attr.isrequired || false;
                                var group = attr.group || 'General';

                                if (isRequired) {
                                    var requiredText = '';
                                    var requiredColor = '';
                                    var requiredIcon = 'â– ';

                                    // æ ¹æ®å±æ€§åˆ†ç»„ç¡®å®šå¿…å¡«ç±»å‹
                                    switch(group) {
                                        case 'Visible':
                                            requiredText = requiredIcon + ' ç±»ç›®å¿…å¡«';
                                            requiredColor = '#fd7e14';
                                            break;
                                        case 'Orderable':
                                            requiredText = requiredIcon + ' é€šç”¨å¿…å¡«';
                                            requiredColor = '#dc3545';
                                            break;
                                        default:
                                            requiredText = requiredIcon + ' å¿…å¡«';
                                            requiredColor = '#dc3545';
                                    }

                                    $newRow.find('input[name*="[name]"]').after(' <span class="is-required" style="color: ' + requiredColor + '; font-weight: bold; font-size: 11px;" title="' + requiredText + '">' + requiredText + '</span>');
                                } else {
                                    // éå¿…å¡«å­—æ®µæ˜¾ç¤ºä¸ºæ¨è
                                    $newRow.find('input[name*="[name]"]').after(' <span class="is-recommended" style="color: #198754; font-weight: bold; font-size: 11px;" title="æ¨èå¡«å†™">â–  æ¨è</span>');
                                }

                                // æ·»åŠ éšè—å­—æ®µå­˜å‚¨å¿…å¡«ä¿¡æ¯
                                var requiredValue = isRequired ? '1' : '0';
                                $newRow.append('<input type="hidden" name="required_levels[' + wcCatId + '][]" value="' + requiredValue + '">');
                                $newRow.append('<input type="hidden" name="attribute_groups[' + wcCatId + '][]" value="' + group + '">');

                                // å¦‚æœæœ‰é»˜è®¤ç±»å‹ï¼Œè®¾ç½®å®ƒ
                                if (attr.defaultType) {
                                    $newRow.find('.attr-type-selector').val(attr.defaultType);
                                }

                                // å¦‚æœæœ‰æšä¸¾å€¼ï¼Œå­˜å‚¨åˆ°dataå±æ€§ä¸­å¹¶æ·»åŠ éšè—å­—æ®µï¼ˆä¸é™åˆ¶defaultTypeï¼‰
                                if (attr.enumValues && attr.enumValues.length > 0) {
                                    // å­˜å‚¨æšä¸¾å€¼åˆ°å…ƒç´ çš„dataå±æ€§ä¸­ï¼Œä¾›åç»­ä½¿ç”¨
                                    $newRow.find('.attr-type-selector').data('enum-values', attr.enumValues);

                                    // æ·»åŠ éšè—å­—æ®µä¿å­˜æšä¸¾å€¼åˆ°è¡¨å•ä¸­
                                    var enumValuesJson = JSON.stringify(attr.enumValues);
                                    $newRow.append('<input type="hidden" name="enum_values[' + wcCatId + '][]" value="' + enumValuesJson.replace(/"/g, '&quot;') + '">');

                                    // å¦‚æœé»˜è®¤ç±»å‹æ˜¯walmart_fieldï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºè¯¥ç±»å‹
                                    if (attr.defaultType === 'walmart_field') {
                                        $newRow.find('.attr-type-selector').val('walmart_field');
                                    }
                                }

                                tbody.append($newRow);

                                // ç§»é™¤æ ¼å¼ç›¸å…³çš„æ•°æ®æ ‡è®° - è®©è‡ªåŠ¨æ£€æµ‹é€»è¾‘å¤„ç†

                                // è‡ªåŠ¨åŠ è½½çš„è¡Œä¹Ÿéœ€è¦è§¦å‘changeæ¥ç”Ÿæˆç¬¬ä¸‰æ ¼
                                $newRow.find('.attr-type-selector').trigger('change');
                            }
                        });

                        // æ›´æ–°å±æ€§æ•°é‡æ˜¾ç¤º
                        updateAttributeCount(mapperDiv);

                        // æ˜¾ç¤ºå¿…å¡«çº§åˆ«è¯´æ˜
                        button.closest('.attribute-mapper').find('.required-level-info').show();
                        alert('V5.0å±æ€§è§„èŒƒåŠ è½½å®Œæˆï¼å·²åŠ è½½ ' + response.data.length + ' ä¸ªå±æ€§ã€‚');
                    } else {
                        alert('é”™è¯¯: ' + response.data.message);
                    }
                },
                error: function() {
                    alert('AJAXè¯·æ±‚å¤±è´¥ã€‚');
                },
                complete: function() {
                    button.text('åŠ è½½V5.0è§„èŒƒ').prop('disabled', false);
                }
            });
        });

        // Walmartåˆ†ç±»æ ‘å½¢é€‰æ‹©å™¨åŠŸèƒ½
        window.toggleCategoryTree = function(element) {
            const selector = element.closest('.walmart-category-tree-selector');
            if (!selector) {
                console.error('æ‰¾ä¸åˆ° .walmart-category-tree-selector å…ƒç´ ');
                return;
            }

            const dropdown = selector.querySelector('.category-tree-dropdown');
            const display = selector.querySelector('.category-selector-display');

            if (!dropdown) {
                console.error('æ‰¾ä¸åˆ° .category-tree-dropdown å…ƒç´ ');
                return;
            }

            if (!display) {
                console.error('æ‰¾ä¸åˆ° .category-selector-display å…ƒç´ ');
                return;
            }

            // å…³é—­å…¶ä»–æ‰“å¼€çš„ä¸‹æ‹‰æ¡†
            document.querySelectorAll('.walmart-category-tree-selector').forEach(other => {
                if (other !== selector) {
                    const otherDropdown = other.querySelector('.category-tree-dropdown');
                    const otherDisplay = other.querySelector('.category-selector-display');
                    if (otherDropdown) otherDropdown.style.display = 'none';
                    if (otherDisplay) otherDisplay.classList.remove('active');
                }
            });

            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                display.classList.add('active');
                loadCategoryTree(selector);
            } else {
                dropdown.style.display = 'none';
                display.classList.remove('active');
            }
        };

        // åŠ è½½åˆ†ç±»æ ‘æ•°æ®
        function loadCategoryTree(selector) {
            const container = selector.querySelector('.category-tree-container');
            if (!container) {
                console.error('æ‰¾ä¸åˆ° .category-tree-container å…ƒç´ ');
                return;
            }

            const wcCatId = selector.dataset.wcCatId;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            // AJAXè·å–åˆ†ç±»æ•°æ®
            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'get_walmart_category_tree',
                    wc_cat_id: wcCatId,
                    _wpnonce: $('#individual-mapping-form input[name="_wpnonce"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        renderCategoryTree(container, response.data, selector);
                        setupCategorySearch(selector);
                    } else {
                        container.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥: ' + (response.data || 'æœªçŸ¥é”™è¯¯') + '</div>';
                    }
                },
                error: function() {
                    container.innerHTML = '<div class="loading">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</div>';
                }
            });
        }

        // æ¸²æŸ“åˆ†ç±»æ ‘
        function renderCategoryTree(container, categories, selector) {
            let html = '';
            const selectedValue = selector.querySelector('.walmart-category-value').value;

            // æŒ‰å±‚çº§åˆ†ç»„
            const levelGroups = {0: [], 1: [], 2: []};
            categories.forEach(cat => {
                const level = parseInt(cat.level) || 0;
                if (levelGroups[level]) {
                    levelGroups[level].push(cat);
                }
            });

            // æ¸²æŸ“ä¸»åˆ†ç±»ï¼ˆLevel 0ï¼‰
            levelGroups[0].forEach(category => {
                const isSelected = category.categoryId === selectedValue;
                const childCount = levelGroups[1].filter(ptg => ptg.parent_id === category.categoryId).length;

                html += `
                    <div class="category-tree-item level-0 ${isSelected ? 'selected' : ''}"
                         data-category-id="${category.categoryId}"
                         data-category-name="${category.categoryName}"
                         data-level="0">
                        <span class="expand-icon" onclick="toggleCategoryChildren(this, event)" data-expanded="false">
                            ${childCount > 0 ? 'â–¶' : ''}
                        </span>
                        <span class="category-name">${category.categoryName}</span>
                        <span class="category-count">${childCount} PTG</span>
                    </div>
                    <div class="category-children" data-parent="${category.categoryId}" style="display: none;"></div>
                `;
            });

            container.innerHTML = html;

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('.category-tree-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.classList.contains('expand-icon')) return;
                    selectCategory(this, selector);
                });
            });

            // å­˜å‚¨å®Œæ•´æ•°æ®ä¾›æœç´¢ä½¿ç”¨
            selector._categoryData = categories;
        }

        // åˆ‡æ¢å­åˆ†ç±»æ˜¾ç¤º
        window.toggleCategoryChildren = function(icon, event) {
            event.stopPropagation();

            const item = icon.closest('.category-tree-item');
            const categoryId = item.dataset.categoryId;
            const level = parseInt(item.dataset.level);
            const childrenContainer = item.nextElementSibling;
            const isExpanded = icon.dataset.expanded === 'true';

            if (isExpanded) {
                // æ”¶ç¼©
                childrenContainer.style.display = 'none';
                icon.textContent = 'â–¶';
                icon.dataset.expanded = 'false';
            } else {
                // å±•å¼€
                if (childrenContainer.children.length === 0) {
                    // æ‡’åŠ è½½å­åˆ†ç±»
                    loadCategoryChildren(categoryId, level, childrenContainer, icon.closest('.walmart-category-tree-selector'));
                }
                childrenContainer.style.display = 'block';
                icon.textContent = 'â–¼';
                icon.dataset.expanded = 'true';
            }
        };

        // åŠ è½½å­åˆ†ç±»
        function loadCategoryChildren(parentId, parentLevel, container, selector) {
            const categories = selector._categoryData || [];
            const childLevel = parentLevel + 1;
            const children = categories.filter(cat => cat.parent_id === parentId && parseInt(cat.level) === childLevel);

            let html = '';
            const selectedValue = selector.querySelector('.walmart-category-value').value;

            children.forEach(child => {
                const isSelected = child.categoryId === selectedValue;
                const grandChildCount = categories.filter(gc => gc.parent_id === child.categoryId && parseInt(gc.level) === childLevel + 1).length;

                html += `
                    <div class="category-tree-item level-${childLevel} ${isSelected ? 'selected' : ''}"
                         data-category-id="${child.categoryId}"
                         data-category-name="${child.categoryName}"
                         data-level="${childLevel}">
                        <span class="expand-icon" onclick="toggleCategoryChildren(this, event)" data-expanded="false">
                            ${grandChildCount > 0 ? 'â–¶' : ''}
                        </span>
                        <span class="category-name">${child.categoryName}</span>
                        ${grandChildCount > 0 ? `<span class="category-count">${grandChildCount} PT</span>` : ''}
                    </div>
                    <div class="category-children" data-parent="${child.categoryId}" style="display: none;"></div>
                `;
            });

            container.innerHTML = html;

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('.category-tree-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.classList.contains('expand-icon')) return;
                    selectCategory(this, selector);
                });
            });
        }

        // é€‰æ‹©åˆ†ç±»
        function selectCategory(item, selector) {
            const categoryId = item.dataset.categoryId;
            const categoryName = item.dataset.categoryName;

            // æ›´æ–°éšè—å­—æ®µå€¼
            const valueInput = selector.querySelector('.walmart-category-value');
            if (valueInput) valueInput.value = categoryId;

            // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
            const selectedCategory = selector.querySelector('.selected-category');
            if (selectedCategory) selectedCategory.textContent = categoryName;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            selector.querySelectorAll('.category-tree-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');

            // å…³é—­ä¸‹æ‹‰æ¡†
            const dropdown = selector.querySelector('.category-tree-dropdown');
            const display = selector.querySelector('.category-selector-display');
            if (dropdown) dropdown.style.display = 'none';
            if (display) display.classList.remove('active');

            // è§¦å‘changeäº‹ä»¶
            if (valueInput) $(valueInput).trigger('change');
        }

        // è®¾ç½®æœç´¢åŠŸèƒ½
        function setupCategorySearch(selector) {
            const searchInput = selector.querySelector('.category-search-input');
            const clearBtn = selector.querySelector('.clear-search');
            const container = selector.querySelector('.category-tree-container');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();

                if (query) {
                    clearBtn.style.display = 'block';
                    performCategorySearch(query, selector);
                } else {
                    clearBtn.style.display = 'none';
                    renderCategoryTree(container, selector._categoryData || [], selector);
                }
            });

            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                this.style.display = 'none';
                renderCategoryTree(container, selector._categoryData || [], selector);
            });
        }

        // æ‰§è¡Œæœç´¢
        function performCategorySearch(query, selector) {
            const categories = selector._categoryData || [];
            const container = selector.querySelector('.category-tree-container');
            const selectedValue = selector.querySelector('.walmart-category-value').value;

            // æœç´¢åŒ¹é…çš„åˆ†ç±»
            const matches = categories.filter(cat =>
                cat.categoryName.toLowerCase().includes(query) ||
                cat.categoryId.toLowerCase().includes(query)
            );

            let html = '';
            if (matches.length > 0) {
                matches.forEach(cat => {
                    const isSelected = cat.categoryId === selectedValue;
                    const levelName = ['åˆ†ç±»', 'PTG', 'PT'][cat.level] || `Level ${cat.level}`;

                    html += `
                        <div class="category-tree-item level-${cat.level} ${isSelected ? 'selected' : ''}"
                             data-category-id="${cat.categoryId}"
                             data-category-name="${cat.categoryName}"
                             data-level="${cat.level}">
                            <span class="expand-icon"></span>
                            <span class="category-name">${cat.categoryName}</span>
                            <span class="category-count">${levelName}</span>
                        </div>
                    `;
                });
            } else {
                html = '<div class="loading">æœªæ‰¾åˆ°åŒ¹é…çš„åˆ†ç±»</div>';
            }

            container.innerHTML = html;

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('.category-tree-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    selectCategory(this, selector);
                });
            });
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.walmart-category-tree-selector')) {
                document.querySelectorAll('.walmart-category-tree-selector').forEach(selector => {
                    const dropdown = selector.querySelector('.category-tree-dropdown');
                    const display = selector.querySelector('.category-selector-display');
                    if (dropdown) dropdown.style.display = 'none';
                    if (display) display.classList.remove('active');
                });
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å±æ€§æ•°é‡æ˜¾ç¤º
        $('.attribute-mapper').each(function() {
            updateAttributeCount($(this));
        });

        // æ–°å¢æœ¬åœ°ç±»ç›®åŠŸèƒ½
        $(document).on('click', '.add-local-category-btn', function() {
            var $btn = $(this);
            var walmartCategory = $btn.data('walmart-category');
            var walmartCategoryName = $btn.data('walmart-category-name');

            console.log('æ–°å¢æœ¬åœ°ç±»ç›®:', {
                walmartCategory: walmartCategory,
                walmartCategoryName: walmartCategoryName
            });

            // æ˜¾ç¤ºæœ¬åœ°ç±»ç›®é€‰æ‹©å¼¹çª—
            showLocalCategoryModal(walmartCategory, walmartCategoryName);
        });

        // ç§»é™¤åˆ†ç±»åŠŸèƒ½
        $(document).on('click', '.remove-from-shared-mapping-btn', function() {
            var $btn = $(this);
            var categoryId = $btn.data('category-id');
            var categoryName = $btn.data('category-name');
            var mappingId = $btn.data('mapping-id');

            console.log('ç§»é™¤åˆ†ç±»:', {
                categoryId: categoryId,
                categoryName: categoryName,
                mappingId: mappingId
            });

            // ç¡®è®¤å¯¹è¯æ¡†
            if (!confirm('ç¡®å®šè¦ç§»é™¤åˆ†ç±» "' + categoryName + '" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\nâ€¢ åˆ é™¤è¯¥åˆ†ç±»çš„æ˜ å°„å…³ç³»\nâ€¢ ä¸ä¼šå½±å“å…¶ä»–åˆ†ç±»çš„æ˜ å°„\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            $btn.prop('disabled', true).text('ç§»é™¤ä¸­...');

            // å‘é€AJAXè¯·æ±‚åˆ é™¤æ˜ å°„
            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'remove_category_mapping',
                    category_id: categoryId,
                    mapping_id: mappingId,
                    nonce: '<?php echo wp_create_nonce('walmart_category_map_nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        // æˆåŠŸç§»é™¤ï¼Œåˆ·æ–°é¡µé¢
                        location.reload();
                    } else {
                        alert('ç§»é™¤å¤±è´¥: ' + (response.data || 'æœªçŸ¥é”™è¯¯'));
                        $btn.prop('disabled', false).html('<span class="dashicons dashicons-minus" style="font-size: 12px; line-height: 1;"></span>ç§»é™¤åˆ†ç±»');
                    }
                },
                error: function(xhr, status, error) {
                    alert('ç§»é™¤å¤±è´¥: ' + error);
                    $btn.prop('disabled', false).html('<span class="dashicons dashicons-minus" style="font-size: 12px; line-height: 1;"></span>ç§»é™¤åˆ†ç±»');
                }
            });
        });

        // æ˜¾ç¤ºæœ¬åœ°ç±»ç›®é€‰æ‹©å¼¹çª—
        function showLocalCategoryModal(walmartCategory, walmartCategoryName) {
            // åˆ›å»ºå¼¹çª—HTML
            var modalHtml = `
                <div id="local-category-modal" class="local-category-modal-overlay">
                    <div class="local-category-modal">
                        <div class="local-category-modal-header">
                            <h3>æ–°å¢æœ¬åœ°ç±»ç›®åˆ° "${walmartCategoryName}"</h3>
                            <button type="button" class="close-modal">&times;</button>
                        </div>
                        <div class="local-category-modal-body">
                            <p>é€‰æ‹©è¦æ˜ å°„åˆ° <strong>${walmartCategoryName}</strong> çš„æœ¬åœ°ç±»ç›®ï¼š</p>
                            <div class="local-category-list">
                                <div class="loading">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                        <div class="local-category-modal-footer">
                            <button type="button" class="button button-secondary close-modal">å–æ¶ˆ</button>
                            <button type="button" class="button button-primary save-local-categories" disabled>ä¿å­˜æ˜ å°„</button>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤ç°æœ‰å¼¹çª—
            $('#local-category-modal').remove();

            // æ·»åŠ å¼¹çª—åˆ°é¡µé¢
            $('body').append(modalHtml);

            // åŠ è½½æœªæ˜ å°„çš„æœ¬åœ°ç±»ç›®
            loadUnmappedLocalCategories(walmartCategory);

            // ç»‘å®šå…³é—­äº‹ä»¶
            $('.close-modal, .local-category-modal-overlay').on('click', function(e) {
                if (e.target === this) {
                    $('#local-category-modal').remove();
                }
            });

            // ç»‘å®šä¿å­˜äº‹ä»¶
            $('.save-local-categories').on('click', function() {
                saveLocalCategoryMappings(walmartCategory, walmartCategoryName);
            });
        }

        // åŠ è½½æœªæ˜ å°„çš„æœ¬åœ°ç±»ç›®
        function loadUnmappedLocalCategories(walmartCategory) {
            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'get_unmapped_local_categories',
                    walmart_category: walmartCategory,
                    nonce: '<?php echo wp_create_nonce('walmart_category_map_nonce'); ?>'
                },
                success: function(response) {
                    if (response.success && response.data.length > 0) {
                        var listHtml = '<div class="local-category-checkboxes hierarchical">';

                        response.data.forEach(function(category) {
                            // è®¡ç®—ç¼©è¿›çº§åˆ«
                            var indentLevel = category.level || 0;
                            var indentClass = 'level-' + indentLevel;
                            var indentStyle = 'padding-left: ' + (15 + indentLevel * 20) + 'px;';

                            // æ„å»ºå±‚çº§æŒ‡ç¤ºå™¨
                            var hierarchyIndicator = '';
                            if (indentLevel > 0) {
                                hierarchyIndicator = '<span class="hierarchy-indicator">';
                                for (var i = 0; i < indentLevel; i++) {
                                    hierarchyIndicator += i === indentLevel - 1 ? 'â””â”€ ' : 'â”‚  ';
                                }
                                hierarchyIndicator += '</span>';
                            }

                            // æ˜¾ç¤ºå®Œæ•´è·¯å¾„ä½œä¸ºæç¤º
                            var fullPath = category.full_path || category.name;
                            var pathHint = category.parent_names && category.parent_names.length > 0
                                ? '<span class="category-path">' + category.parent_names.join(' > ') + ' > </span>'
                                : '';

                            listHtml += `
                                <label class="local-category-item ${indentClass}" style="${indentStyle}" title="${fullPath}">
                                    <input type="checkbox" name="local_categories[]" value="${category.term_id}">
                                    ${hierarchyIndicator}
                                    <span class="category-content">
                                        ${pathHint}
                                        <span class="category-name">${category.name}</span>
                                        <span class="category-meta">ID: ${category.term_id} | å•†å“æ•°: ${category.count}</span>
                                    </span>
                                </label>
                            `;
                        });

                        listHtml += '</div>';

                        $('.local-category-list').html(listHtml);

                        // ç›‘å¬å¤é€‰æ¡†å˜åŒ–
                        $('input[name="local_categories[]"]').on('change', function() {
                            var selectedCount = $('input[name="local_categories[]"]:checked').length;
                            $('.save-local-categories').prop('disabled', selectedCount === 0);
                        });
                    } else {
                        $('.local-category-list').html('<div class="no-categories">æ²¡æœ‰å¯ç”¨çš„æœªæ˜ å°„æœ¬åœ°ç±»ç›®</div>');
                    }
                },
                error: function() {
                    $('.local-category-list').html('<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>');
                }
            });
        }

        // ä¿å­˜æœ¬åœ°ç±»ç›®æ˜ å°„
        function saveLocalCategoryMappings(walmartCategory, walmartCategoryName) {
            var selectedCategories = [];
            $('input[name="local_categories[]"]:checked').each(function() {
                selectedCategories.push($(this).val());
            });

            if (selectedCategories.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæœ¬åœ°ç±»ç›®');
                return;
            }

            var $saveBtn = $('.save-local-categories');
            $saveBtn.prop('disabled', true).text('ä¿å­˜ä¸­...');

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'save_local_category_mappings',
                    walmart_category: walmartCategory,
                    walmart_category_name: walmartCategoryName,
                    local_categories: selectedCategories,
                    nonce: '<?php echo wp_create_nonce('walmart_category_map_nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        alert('æœ¬åœ°ç±»ç›®æ˜ å°„ä¿å­˜æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚');
                        location.reload();
                    } else {
                        alert('ä¿å­˜å¤±è´¥ï¼š' + (response.data || 'æœªçŸ¥é”™è¯¯'));
                    }
                },
                error: function() {
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                },
                complete: function() {
                    $saveBtn.prop('disabled', false).text('ä¿å­˜æ˜ å°„');
                }
            });
        }

    });
</script>
    </div> <!-- å…³é—­ .wrap å®¹å™¨ -->
        <?php
}

// UPCæ± ç®¡ç†é¡µé¢å†…å®¹
function woo_walmart_upc_pool_page() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'walmart_upc_pool';

    // å¤„ç†å„ç§æ“ä½œ
    if (isset($_POST['action'])) {
        $action = $_POST['action'];

        // UPCå¯¼å…¥
        if ($action === 'import_upc' && !empty($_POST['upc_codes'])) {
            check_admin_referer('walmart_upc_import');
            $upc_codes = preg_split('/\\r\\n|\\r|\\n/', sanitize_textarea_field($_POST['upc_codes']));
            $imported_count = 0;
            foreach ($upc_codes as $code) {
                $code = trim($code);
                if (!empty($code)) {
                    // IGNORE å…³é”®å­—å¯ä»¥é˜²æ­¢æ’å…¥é‡å¤çš„UPC
                    $result = $wpdb->query($wpdb->prepare("INSERT IGNORE INTO $table_name (upc_code) VALUES (%s)", $code));
                    if ($result) {
                        $imported_count++;
                    }
                }
            }
            echo "<div class='updated'><p>æˆåŠŸå¯¼å…¥ {$imported_count} ä¸ªæ–°çš„UPCç ã€‚</p></div>";
        }

        // å•ä¸ªUPCæ“ä½œ
        elseif (in_array($action, ['toggle_status', 'delete_upc']) && isset($_POST['upc_id'])) {
            check_admin_referer('walmart_upc_action');
            $upc_id = intval($_POST['upc_id']);

            if ($action === 'toggle_status') {
                $current_status = $wpdb->get_var($wpdb->prepare("SELECT is_used FROM $table_name WHERE id = %d", $upc_id));
                $new_status = $current_status ? 0 : 1;

                $update_data = ['is_used' => $new_status];
                if ($new_status == 0) {
                    // æ ‡è®°ä¸ºæœªä½¿ç”¨æ—¶ï¼Œæ¸…é™¤å…³è”ä¿¡æ¯
                    $update_data['product_id'] = null;
                    $update_data['used_at'] = null;
                } else {
                    // æ ‡è®°ä¸ºå·²ä½¿ç”¨æ—¶ï¼Œè®¾ç½®ä½¿ç”¨æ—¶é—´
                    $update_data['used_at'] = current_time('mysql');
                }

                $wpdb->update($table_name, $update_data, ['id' => $upc_id]);
                echo '<div class="updated"><p>UPCçŠ¶æ€å·²æ›´æ–°ã€‚</p></div>';
            }
            elseif ($action === 'delete_upc') {
                $wpdb->delete($table_name, ['id' => $upc_id]);
                echo '<div class="updated"><p>UPCå·²åˆ é™¤ã€‚</p></div>';
            }
        }

        // æ‰¹é‡æ“ä½œ
        elseif ($action === 'bulk_action' && isset($_POST['bulk_action_type']) && !empty($_POST['upc_ids'])) {
            check_admin_referer('walmart_upc_bulk');
            $bulk_action = sanitize_text_field($_POST['bulk_action_type']);
            $upc_ids = array_map('intval', $_POST['upc_ids']);
            $affected = 0;

            if ($bulk_action === 'mark_used') {
                $prepare_values = array_merge([current_time('mysql')], array_map('intval', $upc_ids));
                $affected = $wpdb->query($wpdb->prepare(
                    "UPDATE $table_name SET is_used = 1, used_at = %s WHERE id IN (" . implode(',', array_fill(0, count($upc_ids), '%d')) . ")",
                    $prepare_values
                ));
            }
            elseif ($bulk_action === 'mark_unused') {
                $affected = $wpdb->query($wpdb->prepare(
                    "UPDATE $table_name SET is_used = 0, product_id = NULL, used_at = NULL WHERE id IN (" . implode(',', array_fill(0, count($upc_ids), '%d')) . ")",
                    $upc_ids
                ));
            }
            elseif ($bulk_action === 'delete') {
                $affected = $wpdb->query($wpdb->prepare(
                    "DELETE FROM $table_name WHERE id IN (" . implode(',', array_fill(0, count($upc_ids), '%d')) . ")",
                    $upc_ids
                ));
            }

            echo '<div class="updated"><p>æ‰¹é‡æ“ä½œå®Œæˆï¼Œå½±å“äº† ' . $affected . ' ä¸ªUPCç ã€‚</p></div>';
        }
    }

    // è·å–åˆ†é¡µå’Œæœç´¢å‚æ•°
    $per_page = 20;
    $current_page = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
    $search_term = isset($_GET['s']) ? sanitize_text_field($_GET['s']) : '';
    $search_type = isset($_GET['search_type']) ? sanitize_text_field($_GET['search_type']) : 'upc';
    $offset = ($current_page - 1) * $per_page;

    // æ„å»ºæŸ¥è¯¢
    $where_clauses = [];
    if (!empty($search_term)) {
        if ($search_type === 'sku') {
            // SKUæœç´¢ï¼šéœ€è¦å…³è”äº§å“è¡¨
            $where_clauses[] = $wpdb->prepare(
                "product_id IN (SELECT ID FROM {$wpdb->posts} p
                 INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id
                 WHERE pm.meta_key = '_sku' AND pm.meta_value LIKE %s)",
                '%' . $wpdb->esc_like($search_term) . '%'
            );
        } else {
            // UPCæœç´¢ï¼ˆé»˜è®¤ï¼‰
            $where_clauses[] = $wpdb->prepare("upc_code LIKE %s", '%' . $wpdb->esc_like($search_term) . '%');
        }
    }
    $where_sql = empty($where_clauses) ? '' : 'WHERE ' . implode(' AND ', $where_clauses);

    $total_items = $wpdb->get_var("SELECT COUNT(*) FROM $table_name $where_sql");
    $upcs = $wpdb->get_results("SELECT * FROM $table_name $where_sql ORDER BY id DESC LIMIT $per_page OFFSET $offset");
    
    ?>
    <div class="wrap">
        <h1>UPCæ± ç®¡ç†</h1>

        <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
        <div class="upc-stats-cards" style="display: flex; gap: 20px; margin-bottom: 30px;">
            <div class="stats-card" style="background: #fff; border: 1px solid #c3c4c7; border-radius: 4px; padding: 20px; flex: 1; box-shadow: 0 1px 1px rgba(0,0,0,.04);">
                <h3 style="margin: 0 0 10px 0; color: #1d2327; font-size: 18px;">æ€»UPCæ•°é‡</h3>
                <p style="margin: 0; font-size: 24px; font-weight: 600; color: #2271b1;"><?php echo number_format($total_items); ?></p>
            </div>
            <div class="stats-card" style="background: #fff; border: 1px solid #c3c4c7; border-radius: 4px; padding: 20px; flex: 1; box-shadow: 0 1px 1px rgba(0,0,0,.04);">
                <h3 style="margin: 0 0 10px 0; color: #1d2327; font-size: 18px;">å·²ä½¿ç”¨</h3>
                <p style="margin: 0; font-size: 24px; font-weight: 600; color: #d63638;"><?php echo number_format($wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE is_used = 1")); ?></p>
            </div>
            <div class="stats-card" style="background: #fff; border: 1px solid #c3c4c7; border-radius: 4px; padding: 20px; flex: 1; box-shadow: 0 1px 1px rgba(0,0,0,.04);">
                <h3 style="margin: 0 0 10px 0; color: #1d2327; font-size: 18px;">å¯ç”¨</h3>
                <p style="margin: 0; font-size: 24px; font-weight: 600; color: #00a32a;"><?php echo number_format($wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE is_used = 0")); ?></p>
            </div>
        </div>

        <!-- å¯¼å‡ºåŠŸèƒ½åŒºåŸŸ -->
        <div class="upc-export-section" style="background: #fff; border: 1px solid #c3c4c7; border-radius: 4px; padding: 20px; margin-bottom: 30px; box-shadow: 0 1px 1px rgba(0,0,0,.04);">
            <h3 style="margin: 0 0 15px 0; color: #1d2327; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                <span class="dashicons dashicons-download" style="font-size: 18px; color: #2271b1;"></span>
                UPCæ•°æ®å¯¼å‡º
            </h3>
            <p style="margin: 0 0 15px 0; color: #646970; font-size: 14px;">
                æ ¹æ®ç­›é€‰æ¡ä»¶å¯¼å‡ºUPCæ•°æ®ï¼Œæ”¯æŒå¯¼å‡ºå…¨éƒ¨ã€å·²ä½¿ç”¨æˆ–å¯ç”¨çš„UPCç ã€‚
            </p>
            <div class="export-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="<?php echo wp_nonce_url(admin_url('admin.php?page=woo-walmart-upc-export&export_type=all'), 'walmart_export_upc'); ?>"
                   class="button button-primary" style="display: flex; align-items: center; gap: 5px;">
                    <span class="dashicons dashicons-download" style="font-size: 16px;"></span>
                    å¯¼å‡ºå…¨éƒ¨UPC (<?php echo number_format($total_items); ?>ä¸ª)
                </a>
                <a href="<?php echo wp_nonce_url(admin_url('admin.php?page=woo-walmart-upc-export&export_type=used'), 'walmart_export_upc'); ?>"
                   class="button button-secondary" style="display: flex; align-items: center; gap: 5px;">
                    <span class="dashicons dashicons-download" style="font-size: 16px;"></span>
                    å¯¼å‡ºå·²ä½¿ç”¨ (<?php echo number_format($wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE is_used = 1")); ?>ä¸ª)
                </a>
                <a href="<?php echo wp_nonce_url(admin_url('admin.php?page=woo-walmart-upc-export&export_type=available'), 'walmart_export_upc'); ?>"
                   class="button button-secondary" style="display: flex; align-items: center; gap: 5px;">
                    <span class="dashicons dashicons-download" style="font-size: 16px;"></span>
                    å¯¼å‡ºå¯ç”¨ (<?php echo number_format($wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE is_used = 0")); ?>ä¸ª)
                </a>
                <?php if (!empty($search_term)): ?>
                <a href="<?php echo wp_nonce_url(admin_url('admin.php?page=woo-walmart-upc-export&export_type=filtered&search_term=' . urlencode($search_term) . '&search_type=' . urlencode($search_type)), 'walmart_export_upc'); ?>"
                   class="button button-secondary" style="display: flex; align-items: center; gap: 5px;">
                    <span class="dashicons dashicons-download" style="font-size: 16px;"></span>
                    å¯¼å‡ºç­›é€‰ç»“æœ
                </a>
                <?php endif; ?>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #646970;">
                <strong>å¯¼å‡ºæ ¼å¼ï¼š</strong>CSVæ–‡ä»¶ï¼ŒåŒ…å«UPCç ã€çŠ¶æ€ã€å…³è”äº§å“IDã€å…³è”SKUã€ä½¿ç”¨æ—¶é—´ç­‰ä¿¡æ¯
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="upc-main-content" style="display: grid; grid-template-columns: 350px 1fr; gap: 30px;">

            <!-- å·¦ä¾§ï¼šå¯¼å…¥UPC -->
            <div class="upc-import-section">
                <div class="postbox" style="margin-bottom: 0;">
                    <div class="postbox-header">
                        <h2 class="hndle">æ‰¹é‡å¯¼å…¥UPC</h2>
                    </div>
                    <div class="inside">
                        <p style="margin-top: 0;">æ¯è¡Œè¾“å…¥ä¸€ä¸ªUPCç ï¼Œæ”¯æŒæ‰¹é‡å¯¼å…¥ã€‚</p>
                        <form method="post">
                            <input type="hidden" name="action" value="import_upc">
                            <?php wp_nonce_field('walmart_upc_import'); ?>
                            <div class="form-field">
                                <label for="upc_codes" style="font-weight: 600; margin-bottom: 8px; display: block;">UPCç åˆ—è¡¨</label>
                                <textarea name="upc_codes" id="upc_codes" rows="12" style="width:100%; resize: vertical;" placeholder="è¯·è¾“å…¥UPCç ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;123456789012&#10;234567890123&#10;345678901234"></textarea>
                            </div>
                            <p class="submit" style="margin-bottom: 0;">
                                <input type="submit" class="button button-primary" value="å¯¼å…¥UPC">
                            </p>
                        </form>

                        <div class="import-tips" style="margin-top: 20px; padding: 15px; background: #f0f6fc; border-left: 4px solid #2271b1; border-radius: 0 4px 4px 0;">
                            <h4 style="margin: 0 0 10px 0; color: #1d2327;">å¯¼å…¥è¯´æ˜</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>æ¯è¡Œè¾“å…¥ä¸€ä¸ªUPCç </li>
                                <li>é‡å¤çš„UPCç ä¼šè¢«è‡ªåŠ¨å¿½ç•¥</li>
                                <li>æ”¯æŒ12ä½æ ‡å‡†UPCç </li>
                                <li>å¯¼å…¥åå¯åœ¨å³ä¾§åˆ—è¡¨ä¸­æŸ¥çœ‹</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šUPCåˆ—è¡¨ -->
            <div class="upc-list-section">
                <div class="postbox" style="margin-bottom: 0;">
                    <div class="postbox-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="hndle">UPCç¼–ç æ± </h2>
                        <form method="get" style="margin: 0;">
                            <input type="hidden" name="page" value="woo-walmart-upc-pool">
                            <div class="search-box" style="display: flex; gap: 5px; align-items: center;">
                                <select name="search_type" style="width: 80px;">
                                    <option value="upc" <?php selected($search_type, 'upc'); ?>>UPC</option>
                                    <option value="sku" <?php selected($search_type, 'sku'); ?>>SKU</option>
                                </select>
                                <input type="search" id="upc-search-input" name="s" value="<?php echo esc_attr($search_term); ?>"
                                       placeholder="<?php echo $search_type === 'sku' ? 'æœç´¢SKU...' : 'æœç´¢UPCç ...'; ?>"
                                       style="width: 200px;">
                                <input type="submit" id="search-submit" class="button" value="æœç´¢">
                                <?php if (!empty($search_term)): ?>
                                    <a href="<?php echo admin_url('admin.php?page=woo-walmart-upc-pool'); ?>" class="button button-secondary">æ¸…é™¤</a>
                                <?php endif; ?>
                            </div>
                        </form>
                    </div>
                    <div class="inside" style="padding: 0;">
                        <!-- æ‰¹é‡æ“ä½œæ  -->
                        <div class="tablenav top" style="padding: 10px 20px; border-bottom: 1px solid #c3c4c7; background: #f9f9f9;">
                            <form method="post" id="bulk-action-form">
                                <?php wp_nonce_field('walmart_upc_bulk'); ?>
                                <input type="hidden" name="action" value="bulk_action">
                                <div class="alignleft actions">
                                    <select name="bulk_action_type" id="bulk-action-selector">
                                        <option value="">æ‰¹é‡æ“ä½œ</option>
                                        <option value="mark_used">æ ‡è®°ä¸ºå·²ä½¿ç”¨</option>
                                        <option value="mark_unused">æ ‡è®°ä¸ºæœªä½¿ç”¨</option>
                                        <option value="delete">åˆ é™¤</option>
                                    </select>
                                    <input type="submit" class="button action" value="åº”ç”¨" onclick="return confirmBulkAction()">
                                </div>
                                <div class="alignright">
                                    <span id="selected-count" style="color: #646970;">å·²é€‰æ‹© 0 é¡¹</span>
                                </div>
                                <div style="clear: both;"></div>
                            </form>
                        </div>

                        <div class="table-responsive" style="overflow-x: auto;">
                            <table class="wp-list-table widefat fixed striped" style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="select-all-upcs"></th>
                                        <th style="width: 50px;">ID</th>
                                        <th style="width: 140px;">UPCç </th>
                                        <th style="width: 80px;">çŠ¶æ€</th>
                                        <th style="width: 90px;">å…³è”äº§å“</th>
                                        <th style="width: 100px;">å…³è”SKU</th>
                                        <th style="width: 120px;">ä½¿ç”¨æ—¶é—´</th>
                                        <th style="width: 120px;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php if (empty($upcs)) : ?>
                                        <tr>
                                            <td colspan="8" style="text-align: center; padding: 40px; color: #646970;">
                                                <div style="font-size: 16px; margin-bottom: 10px;">ğŸ“¦</div>
                                                <div>æ²¡æœ‰æ‰¾åˆ°UPCç </div>
                                                <?php if (!empty($search_term)) : ?>
                                                    <div style="margin-top: 10px;">
                                                        <a href="<?php echo admin_url('admin.php?page=woo-walmart-upc-pool'); ?>" class="button button-secondary">æŸ¥çœ‹å…¨éƒ¨</a>
                                                    </div>
                                                <?php endif; ?>
                                            </td>
                                        </tr>
                                    <?php else : ?>
                                        <?php foreach ($upcs as $upc) :
                                            // è·å–äº§å“SKU
                                            $product_sku = '';
                                            if ($upc->product_id) {
                                                $product = wc_get_product($upc->product_id);
                                                $product_sku = $product ? $product->get_sku() : '';
                                            }
                                        ?>
                                            <tr>
                                                <td><input type="checkbox" name="upc_ids[]" value="<?php echo esc_attr($upc->id); ?>" class="upc-checkbox"></td>
                                                <td><span style="color: #646970;">#<?php echo esc_html($upc->id); ?></span></td>
                                                <td>
                                                    <strong style="font-family: 'Courier New', monospace; font-size: 13px;">
                                                        <?php echo esc_html($upc->upc_code); ?>
                                                    </strong>
                                                </td>
                                                <td>
                                                    <?php if ($upc->is_used) : ?>
                                                        <span class="status-badge used" style="display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;">å·²ä½¿ç”¨</span>
                                                    <?php else : ?>
                                                        <span class="status-badge available" style="display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0;">å¯ç”¨</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td>
                                                    <?php if ($upc->product_id) : ?>
                                                        <a href="<?php echo get_edit_post_link($upc->product_id); ?>" target="_blank" style="text-decoration: none;">
                                                            #<?php echo esc_html($upc->product_id); ?>
                                                            <span class="dashicons dashicons-external" style="font-size: 12px; margin-left: 2px;"></span>
                                                        </a>
                                                    <?php else : ?>
                                                        <span style="color: #646970;">-</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td>
                                                    <?php if (!empty($product_sku)) : ?>
                                                        <strong style="font-family: 'Courier New', monospace; font-size: 12px; color: #2271b1;">
                                                            <?php echo esc_html($product_sku); ?>
                                                        </strong>
                                                    <?php else : ?>
                                                        <span style="color: #646970;">-</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td>
                                                    <?php if ($upc->used_at) : ?>
                                                        <span style="color: #646970; font-size: 13px;">
                                                            <?php echo esc_html(date('Y-m-d H:i', strtotime($upc->used_at))); ?>
                                                        </span>
                                                    <?php else : ?>
                                                        <span style="color: #646970;">-</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td>
                                                    <div class="row-actions" style="white-space: nowrap;">
                                                        <form method="post" style="display: inline;">
                                                            <?php wp_nonce_field('walmart_upc_action'); ?>
                                                            <input type="hidden" name="action" value="toggle_status">
                                                            <input type="hidden" name="upc_id" value="<?php echo esc_attr($upc->id); ?>">
                                                            <button type="submit" class="button button-small" style="margin-right: 5px;">
                                                                <?php echo $upc->is_used ? 'æ ‡è®°æœªä½¿ç”¨' : 'æ ‡è®°å·²ä½¿ç”¨'; ?>
                                                            </button>
                                                        </form>
                                                        <form method="post" style="display: inline;">
                                                            <?php wp_nonce_field('walmart_upc_action'); ?>
                                                            <input type="hidden" name="action" value="delete_upc">
                                                            <input type="hidden" name="upc_id" value="<?php echo esc_attr($upc->id); ?>">
                                                            <button type="submit" class="button button-small button-link-delete" onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªUPCç å—ï¼Ÿ')">
                                                                åˆ é™¤
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>

                        <?php
                        // åˆ†é¡µé“¾æ¥
                        $total_pages = ceil($total_items / $per_page);
                        if ($total_pages > 1) : ?>
                            <div class="tablenav bottom" style="padding: 15px 20px; border-top: 1px solid #c3c4c7; background: #f9f9f9;">
                                <div class="tablenav-pages" style="float: right;">
                                    <?php echo paginate_links([
                                        'base' => add_query_arg('paged', '%#%'),
                                        'format' => '',
                                        'prev_text' => 'â€¹ ä¸Šä¸€é¡µ',
                                        'next_text' => 'ä¸‹ä¸€é¡µ â€º',
                                        'total' => $total_pages,
                                        'current' => $current_page,
                                        'type' => 'plain'
                                    ]); ?>
                                </div>
                                <div class="displaying-num" style="color: #646970; line-height: 32px;">
                                    æ˜¾ç¤ºç¬¬ <?php echo (($current_page - 1) * $per_page + 1); ?>-<?php echo min($current_page * $per_page, $total_items); ?> é¡¹ï¼Œå…± <?php echo $total_items; ?> é¡¹
                                </div>
                                <div style="clear: both;"></div>
                            </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    .upc-stats-cards .stats-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,.1);
        transition: box-shadow 0.2s ease;
    }

    .postbox {
        border: 1px solid #c3c4c7;
        box-shadow: 0 1px 1px rgba(0,0,0,.04);
    }

    .postbox-header {
        border-bottom: 1px solid #c3c4c7;
        padding: 12px 20px;
        background: #fff;
    }

    .postbox-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #1d2327;
    }

    .postbox .inside {
        padding: 20px;
    }

    .status-badge {
        white-space: nowrap;
    }

    .row-actions .button {
        font-size: 11px;
        height: auto;
        line-height: 1.4;
        padding: 2px 6px;
    }

    .button-link-delete {
        color: #d63638 !important;
        border-color: transparent !important;
        background: transparent !important;
    }

    .button-link-delete:hover {
        color: #fff !important;
        background: #d63638 !important;
        border-color: #d63638 !important;
    }

    .export-buttons .button {
        transition: all 0.2s ease;
    }

    .export-buttons .button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .export-buttons .button-primary:hover {
        background: #135e96;
        border-color: #135e96;
    }

    .upc-export-section {
        border-left: 4px solid #2271b1;
    }

    @media (max-width: 1200px) {
        .upc-main-content {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .upc-stats-cards {
            flex-direction: column;
        }

        .upc-stats-cards .stats-card {
            flex: none;
        }
    }

    @media (max-width: 768px) {
        .postbox-header {
            flex-direction: column;
            gap: 15px;
        }

        .search-box {
            width: 100%;
        }

        .search-box input[type="search"] {
            width: 100% !important;
        }

        .row-actions {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .row-actions form {
            display: block !important;
            margin: 0 !important;
        }
    }
    </style>

    <script type="text/javascript">
    jQuery(document).ready(function($) {
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        $('#select-all-upcs').on('change', function() {
            $('.upc-checkbox').prop('checked', this.checked);
            updateSelectedCount();
        });

        // å•ä¸ªå¤é€‰æ¡†å˜åŒ–
        $('.upc-checkbox').on('change', function() {
            updateSelectedCount();

            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            var totalCheckboxes = $('.upc-checkbox').length;
            var checkedCheckboxes = $('.upc-checkbox:checked').length;

            if (checkedCheckboxes === 0) {
                $('#select-all-upcs').prop('indeterminate', false).prop('checked', false);
            } else if (checkedCheckboxes === totalCheckboxes) {
                $('#select-all-upcs').prop('indeterminate', false).prop('checked', true);
            } else {
                $('#select-all-upcs').prop('indeterminate', true);
            }
        });

        // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
        function updateSelectedCount() {
            var count = $('.upc-checkbox:checked').length;
            $('#selected-count').text('å·²é€‰æ‹© ' + count + ' é¡¹');
        }

        // æ‰¹é‡æ“ä½œè¡¨å•æäº¤å‰éªŒè¯
        $('#bulk-action-form').on('submit', function(e) {
            var selectedAction = $('#bulk-action-selector').val();
            var selectedCount = $('.upc-checkbox:checked').length;

            if (!selectedAction) {
                e.preventDefault();
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ‰¹é‡æ“ä½œã€‚');
                return false;
            }

            if (selectedCount === 0) {
                e.preventDefault();
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªUPCç ã€‚');
                return false;
            }

            // å°†é€‰ä¸­çš„å¤é€‰æ¡†æ·»åŠ åˆ°è¡¨å•ä¸­
            $('.upc-checkbox:checked').each(function() {
                $('<input>').attr({
                    type: 'hidden',
                    name: 'upc_ids[]',
                    value: $(this).val()
                }).appendTo('#bulk-action-form');
            });

            return true;
        });
    });

    // æ‰¹é‡æ“ä½œç¡®è®¤
    function confirmBulkAction() {
        var selectedAction = document.getElementById('bulk-action-selector').value;
        var selectedCount = document.querySelectorAll('.upc-checkbox:checked').length;

        if (!selectedAction) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªæ‰¹é‡æ“ä½œã€‚');
            return false;
        }

        if (selectedCount === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªUPCç ã€‚');
            return false;
        }

        var actionText = '';
        switch(selectedAction) {
            case 'mark_used':
                actionText = 'æ ‡è®°ä¸ºå·²ä½¿ç”¨';
                break;
            case 'mark_unused':
                actionText = 'æ ‡è®°ä¸ºæœªä½¿ç”¨';
                break;
            case 'delete':
                actionText = 'åˆ é™¤';
                break;
        }

        return confirm('ç¡®å®šè¦å¯¹é€‰ä¸­çš„ ' + selectedCount + ' ä¸ªUPCç æ‰§è¡Œ"' + actionText + '"æ“ä½œå—ï¼Ÿ');
    }
    </script>
    <?php
}

/**
 * æµ‹è¯•APIç«¯ç‚¹è¿æ¥
 * @param Woo_Walmart_API_Key_Auth $auth APIè®¤è¯å¯¹è±¡
 * @param string $api_version APIç‰ˆæœ¬
 * @return array æµ‹è¯•ç»“æœ
 */
function woo_walmart_test_api_endpoint($auth, $api_version) {
    try {
        // æµ‹è¯•ä¸€ä¸ªç®€å•çš„APIç«¯ç‚¹ - è·å–æ‰€æœ‰å•†å“åˆ—è¡¨ï¼ˆé™åˆ¶1ä¸ªï¼‰
        $endpoint = '/v3/items?limit=1';
        $result = $auth->make_request($endpoint);

        if (is_wp_error($result)) {
            return [
                'success' => false,
                'message' => 'APIè¯·æ±‚å¤±è´¥: ' . $result->get_error_message()
            ];
        }

        // æ£€æŸ¥å“åº”æ ¼å¼
        if (is_array($result)) {
            $response_info = [
                'endpoint' => $endpoint,
                'response_keys' => array_keys($result),
                'api_version_used' => $api_version,
                'timestamp' => current_time('c')
            ];

            // å¦‚æœæœ‰å•†å“æ•°æ®ï¼Œæ·»åŠ ä¸€äº›åŸºæœ¬ä¿¡æ¯
            if (isset($result['ItemResponse']) && is_array($result['ItemResponse'])) {
                $response_info['items_count'] = count($result['ItemResponse']);
                if (!empty($result['ItemResponse'][0])) {
                    $first_item = $result['ItemResponse'][0];
                    $response_info['sample_item_keys'] = array_keys($first_item);
                }
            }

            return [
                'success' => true,
                'message' => 'æˆåŠŸè·å–APIå“åº”',
                'details' => $response_info
            ];
        }

        return [
            'success' => false,
            'message' => 'APIå“åº”æ ¼å¼å¼‚å¸¸'
        ];

    } catch (Exception $e) {
        return [
            'success' => false,
            'message' => 'æµ‹è¯•å¼‚å¸¸: ' . $e->getMessage()
        ];
    }
}

// è®¾ç½®é¡µå†…å®¹
function woo_walmart_sync_settings_page() {
    $result_message = '';

    // å¤„ç†ä¿å­˜è®¾ç½®
    if (isset($_POST['action']) && $_POST['action'] === 'save_settings') {
        check_admin_referer('woo_walmart_sync_save');

        // ä¿å­˜å¤šå¸‚åœºé…ç½®
        $markets = ['US', 'CA', 'MX', 'CL'];
        foreach ($markets as $market) {
            if (isset($_POST["woo_walmart_{$market}_client_id"])) {
                update_option("woo_walmart_{$market}_client_id", sanitize_text_field($_POST["woo_walmart_{$market}_client_id"]));
            }
            if (isset($_POST["woo_walmart_{$market}_client_secret"])) {
                update_option("woo_walmart_{$market}_client_secret", sanitize_text_field($_POST["woo_walmart_{$market}_client_secret"]));
            }
            if (isset($_POST["woo_walmart_{$market}_fulfillment_lag_time"])) {
                update_option("woo_walmart_{$market}_fulfillment_lag_time", intval($_POST["woo_walmart_{$market}_fulfillment_lag_time"]));
            }
            if (isset($_POST["woo_walmart_{$market}_fulfillment_center_id"])) {
                update_option("woo_walmart_{$market}_fulfillment_center_id", sanitize_text_field($_POST["woo_walmart_{$market}_fulfillment_center_id"]));
            }
            if (isset($_POST["woo_walmart_{$market}_shipping_template"])) {
                update_option("woo_walmart_{$market}_shipping_template", sanitize_text_field($_POST["woo_walmart_{$market}_shipping_template"]));
            }
            if (isset($_POST["woo_walmart_{$market}_api_version"])) {
                update_option("woo_walmart_{$market}_api_version", sanitize_text_field($_POST["woo_walmart_{$market}_api_version"]));
            }
            // ğŸ†• ä¿å­˜Channel Typeé…ç½®
            if (isset($_POST["woo_walmart_{$market}_channel_type"])) {
                update_option("woo_walmart_{$market}_channel_type", sanitize_text_field($_POST["woo_walmart_{$market}_channel_type"]));
            }
            // ğŸ†• ä¿å­˜è®¤è¯æ–¹å¼é€‰æ‹©
            if (isset($_POST["woo_walmart_{$market}_auth_method"])) {
                update_option("woo_walmart_{$market}_auth_method", sanitize_text_field($_POST["woo_walmart_{$market}_auth_method"]));
            }
            // ğŸ†• ä¿å­˜æ—§ç‰ˆè®¤è¯å‡­è¯
            if (isset($_POST["woo_walmart_{$market}_consumer_id"])) {
                update_option("woo_walmart_{$market}_consumer_id", sanitize_text_field($_POST["woo_walmart_{$market}_consumer_id"]));
            }
            if (isset($_POST["woo_walmart_{$market}_private_key"])) {
                update_option("woo_walmart_{$market}_private_key", sanitize_textarea_field($_POST["woo_walmart_{$market}_private_key"]));
            }
            if (isset($_POST["woo_walmart_{$market}_legacy_channel_type"])) {
                update_option("woo_walmart_{$market}_legacy_channel_type", sanitize_text_field($_POST["woo_walmart_{$market}_legacy_channel_type"]));
            }
            // å¸‚åœºå¯ç”¨çŠ¶æ€
            update_option("woo_walmart_{$market}_enabled", isset($_POST["woo_walmart_{$market}_enabled"]) ? 1 : 0);
        }

        // ä¿å­˜å…¨å±€è®¾ç½®
        update_option('woo_walmart_default_market', sanitize_text_field($_POST['woo_walmart_default_market']));
        update_option('woo_walmart_placeholder_image_1', esc_url_raw($_POST['woo_walmart_placeholder_image_1']));
        update_option('woo_walmart_placeholder_image_2', esc_url_raw($_POST['woo_walmart_placeholder_image_2']));

        // å‘åå…¼å®¹ï¼šä¿å­˜é»˜è®¤å¸‚åœºçš„é…ç½®åˆ°æ—§çš„é€‰é¡¹å
        $default_market = sanitize_text_field($_POST['woo_walmart_default_market']);
        $default_market_code = str_replace('WALMART_', '', $default_market);
        update_option('woo_walmart_client_id', get_option("woo_walmart_{$default_market_code}_client_id", ''));
        update_option('woo_walmart_client_secret', get_option("woo_walmart_{$default_market_code}_client_secret", ''));
        update_option('woo_walmart_fulfillment_lag_time', get_option("woo_walmart_{$default_market_code}_fulfillment_lag_time", 1));
        update_option('woo_walmart_fulfillment_center_id', get_option("woo_walmart_{$default_market_code}_fulfillment_center_id", ''));
        update_option('woo_walmart_shipping_template', get_option("woo_walmart_{$default_market_code}_shipping_template", ''));
        update_option('woo_walmart_api_version', get_option("woo_walmart_{$default_market_code}_api_version", '5.0'));
        update_option('woo_walmart_business_unit', $default_market);

        $result_message = '<div class="updated"><p>å¤šå¸‚åœºè®¾ç½®å·²ä¿å­˜ï¼</p></div>';
    }

    // å¤„ç†æ‰‹åŠ¨å¤„ç†é˜Ÿåˆ—
    if (isset($_POST['action']) && $_POST['action'] === 'process_queue') {
        check_admin_referer('woo_walmart_process_queue');

        $queue = get_option('walmart_sync_queue', []);
        if (!empty($queue)) {
            $items_to_process = array_slice($queue, 0, 5);
            $sync = new Woo_Walmart_Product_Sync();
            $processed_count = 0;

            foreach ($items_to_process as $product_id) {
                $result = $sync->initiate_sync($product_id);
                if ($result['success']) {
                    $processed_count++;
                }
            }

            $remaining_queue = array_slice($queue, 5);
            update_option('walmart_sync_queue', $remaining_queue);

            $result_message = '<div class="updated"><p>å·²å¤„ç† ' . $processed_count . ' ä¸ªäº§å“ï¼Œé˜Ÿåˆ—ä¸­è¿˜æœ‰ ' . count($remaining_queue) . ' ä¸ªäº§å“ç­‰å¾…å¤„ç†ã€‚</p></div>';
        } else {
            $result_message = '<div class="notice notice-info"><p>é˜Ÿåˆ—ä¸ºç©ºï¼Œæ²¡æœ‰éœ€è¦å¤„ç†çš„äº§å“ã€‚</p></div>';
        }
    }



    $client_id = get_option('woo_walmart_client_id', '');
    $client_secret = get_option('woo_walmart_client_secret', '');
    echo $result_message;
    ?>
    <div class="wrap">
        <h1>ğŸŒ æ²ƒå°”ç›å¤šå¸‚åœºAPIè®¾ç½®</h1>
        <form method="post">
            <input type="hidden" name="action" value="save_settings">
            <?php wp_nonce_field('woo_walmart_sync_save'); ?>

            <!-- å…¨å±€è®¾ç½® -->
            <h2>ğŸŒ å…¨å±€è®¾ç½®</h2>
            <table class="form-table">
                <tr>
                    <th>é»˜è®¤å¸‚åœº</th>
                    <td>
                        <select name="woo_walmart_default_market">
                            <option value="WALMART_US" <?php selected(get_option('woo_walmart_default_market', 'WALMART_US'), 'WALMART_US'); ?>>ğŸ‡ºğŸ‡¸ ç¾å›½æ²ƒå°”ç› (WALMART_US)</option>
                            <option value="WALMART_CA" <?php selected(get_option('woo_walmart_default_market', 'WALMART_US'), 'WALMART_CA'); ?>>ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§æ²ƒå°”ç› (WALMART_CA)</option>
                            <option value="WALMART_MX" <?php selected(get_option('woo_walmart_default_market', 'WALMART_US'), 'WALMART_MX'); ?>>ğŸ‡²ğŸ‡½ å¢¨è¥¿å“¥æ²ƒå°”ç› (WALMART_MX)</option>
                            <option value="WALMART_CL" <?php selected(get_option('woo_walmart_default_market', 'WALMART_US'), 'WALMART_CL'); ?>>ğŸ‡¨ğŸ‡± æ™ºåˆ©æ²ƒå°”ç› (WALMART_CL)</option>
                        </select>
                        <p class="description">é€‰æ‹©ä¸»è¦ä½¿ç”¨çš„å¸‚åœºã€‚æ–°äº§å“åŒæ­¥æ—¶å°†ä¼˜å…ˆä½¿ç”¨æ­¤å¸‚åœºçš„é…ç½®ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å ä½ç¬¦å›¾ç‰‡é“¾æ¥1</th>
                    <td>
                        <input type="url" name="woo_walmart_placeholder_image_1" value="<?php echo esc_attr(get_option('woo_walmart_placeholder_image_1', '')); ?>" class="regular-text" />
                        <p class="description">å½“äº§å“å›¾ç‰‡ä¸º4å¼ æ—¶ä½¿ç”¨çš„å ä½ç¬¦å›¾ç‰‡URLã€‚å»ºè®®ä½¿ç”¨é«˜è´¨é‡çš„é€šç”¨äº§å“å›¾ç‰‡ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å ä½ç¬¦å›¾ç‰‡é“¾æ¥2</th>
                    <td>
                        <input type="url" name="woo_walmart_placeholder_image_2" value="<?php echo esc_attr(get_option('woo_walmart_placeholder_image_2', '')); ?>" class="regular-text" />
                        <p class="description">å½“äº§å“å›¾ç‰‡ä¸º3å¼ æ—¶ä½¿ç”¨çš„ç¬¬äºŒä¸ªå ä½ç¬¦å›¾ç‰‡URLã€‚ä¸å ä½ç¬¦å›¾ç‰‡1ä¸€èµ·ä½¿ç”¨ã€‚</p>
                    </td>
                </tr>
            </table>

            <!-- ç¾å›½å¸‚åœºè®¾ç½® -->
            <h2>ğŸ‡ºğŸ‡¸ ç¾å›½å¸‚åœº (WALMART_US)</h2>
            <table class="form-table">
                <tr>
                    <th>å¯ç”¨ç¾å›½å¸‚åœº</th>
                    <td>
                        <label>
                            <input type="checkbox" name="woo_walmart_US_enabled" value="1" <?php checked(get_option('woo_walmart_US_enabled', 1), 1); ?> />
                            å¯ç”¨ç¾å›½æ²ƒå°”ç›å¸‚åœºåŒæ­¥
                        </label>
                        <p class="description">å‹¾é€‰ä»¥å¯ç”¨ç¾å›½å¸‚åœºçš„äº§å“åŒæ­¥åŠŸèƒ½ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Client ID</th>
                    <td>
                        <input type="text" name="woo_walmart_US_client_id" value="<?php echo esc_attr(get_option('woo_walmart_US_client_id', $client_id)); ?>" class="regular-text" />
                        <p class="description">ç¾å›½å¸‚åœºçš„Client IDã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Client Secret</th>
                    <td>
                        <input type="password" name="woo_walmart_US_client_secret" value="<?php echo esc_attr(get_option('woo_walmart_US_client_secret', $client_secret)); ?>" class="regular-text" />
                        <p class="description">ç¾å›½å¸‚åœºçš„Client Secretã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å¤‡è´§æ—¶é—´ (Fulfillment Lag Time)</th>
                    <td>
                        <input type="number" name="woo_walmart_US_fulfillment_lag_time" value="<?php echo esc_attr(get_option('woo_walmart_US_fulfillment_lag_time', get_option('woo_walmart_fulfillment_lag_time', 1))); ?>" class="small-text" min="1">
                        <p class="description">ç¾å›½å¸‚åœºï¼šæ‚¨åœ¨æ”¶åˆ°è®¢å•åï¼Œéœ€è¦å¤šå°‘å¤©æ¥å‡†å¤‡å‘è´§ã€‚é»˜è®¤ä¸º1å¤©ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å‘è´§æ¨¡å¼</th>
                    <td>
                        <select name="woo_walmart_US_fulfillment_type" disabled>
                            <option value="SELLER_FULFILLED" selected>è‡ªå‘è´§ (Seller Fulfilled)</option>
                            <option value="WFS">æ²ƒå°”ç›å‘è´§ (WFS)</option>
                        </select>
                        <p class="description">ç¾å›½å¸‚åœºå½“å‰é…ç½®ä¸ºè‡ªå‘è´§æ¨¡å¼ã€‚å¦‚éœ€ä½¿ç”¨WFSï¼Œè¯·è”ç³»æ²ƒå°”ç›ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å±¥è¡Œä¸­å¿ƒID</th>
                    <td>
                        <input type="text" name="woo_walmart_US_fulfillment_center_id" value="<?php echo esc_attr(get_option('woo_walmart_US_fulfillment_center_id', get_option('woo_walmart_fulfillment_center_id', ''))); ?>" class="regular-text" />
                        <p class="description">ç¾å›½å¸‚åœºå±¥è¡Œä¸­å¿ƒIDã€‚ç”¨äºæŒ‡å®šå•†å“å­˜å‚¨å’Œå‘è´§çš„å±¥è¡Œä¸­å¿ƒã€‚å¦‚æœä¸ºç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ 'WFS'ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>è¿è¾“æ¨¡æ¿</th>
                    <td>
                        <input type="text" name="woo_walmart_US_shipping_template" value="<?php echo esc_attr(get_option('woo_walmart_US_shipping_template', get_option('woo_walmart_shipping_template', ''))); ?>" class="regular-text" />
                        <p class="description">ç¾å›½å¸‚åœºè¿è¾“æ¨¡æ¿åç§°ã€‚å¦‚æœä¸ºç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤è¿è¾“è®¾ç½®ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>APIç‰ˆæœ¬</th>
                    <td>
                        <select name="woo_walmart_US_api_version">
                            <option value="5.0" <?php selected(get_option('woo_walmart_US_api_version', get_option('woo_walmart_api_version', '5.0')), '5.0'); ?>>V5.0</option>
                        </select>
                        <p class="description">ç¾å›½å¸‚åœºAPIç‰ˆæœ¬ã€‚V5.0æ˜¯å½“å‰æ¨èç‰ˆæœ¬ï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’ŒåŠŸèƒ½ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>æµ‹è¯•è¿æ¥</th>
                    <td>
                        <button type="button" class="button button-secondary" onclick="testMarketConnection('US')" id="test-us-btn">
                            ğŸ‡ºğŸ‡¸ æµ‹è¯•ç¾å›½å¸‚åœºè¿æ¥
                        </button>
                        <span id="test-us-result" style="margin-left: 10px;"></span>
                        <p class="description">æµ‹è¯•ç¾å›½å¸‚åœºçš„APIè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚</p>
                    </td>
                </tr>
            </table>

            <!-- åŠ æ‹¿å¤§å¸‚åœºè®¾ç½® -->
            <h2>ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§å¸‚åœº (WALMART_CA)</h2>
            <table class="form-table">
                <tr>
                    <th>å¯ç”¨åŠ æ‹¿å¤§å¸‚åœº</th>
                    <td>
                        <label>
                            <input type="checkbox" name="woo_walmart_CA_enabled" value="1" <?php checked(get_option('woo_walmart_CA_enabled', 0), 1); ?> />
                            å¯ç”¨åŠ æ‹¿å¤§æ²ƒå°”ç›å¸‚åœºåŒæ­¥
                        </label>
                        <p class="description">å‹¾é€‰ä»¥å¯ç”¨åŠ æ‹¿å¤§å¸‚åœºçš„äº§å“åŒæ­¥åŠŸèƒ½ã€‚æ”¯æŒåŒè¯­æ ‡ç­¾å’Œå¤æ‚ç¨åˆ¶ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Client ID</th>
                    <td>
                        <input type="text" name="woo_walmart_CA_client_id" value="<?php echo esc_attr(get_option('woo_walmart_CA_client_id', '')); ?>" class="regular-text" />
                        <p class="description">åŠ æ‹¿å¤§å¸‚åœºçš„Client IDã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Client Secret</th>
                    <td>
                        <input type="password" name="woo_walmart_CA_client_secret" value="<?php echo esc_attr(get_option('woo_walmart_CA_client_secret', '')); ?>" class="regular-text" />
                        <p class="description">åŠ æ‹¿å¤§å¸‚åœºçš„Client Secretï¼ˆOAuth 2.0 æ–°ç‰ˆè®¤è¯ï¼‰ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th colspan="2" style="background: #f0f0f1; padding: 15px;">
                        <strong>ğŸ” è®¤è¯æ–¹å¼é€‰æ‹©</strong>
                    </th>
                </tr>
                <tr>
                    <th>è®¤è¯æ–¹å¼</th>
                    <td>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" name="woo_walmart_CA_auth_method" value="oauth" <?php checked(get_option('woo_walmart_CA_auth_method', 'oauth'), 'oauth'); ?> />
                            <strong>OAuth 2.0 (æ–°ç‰ˆ - æ¨è)</strong>
                            <span style="color: #00a32a; margin-left: 5px;">âœ“ Walmart æ¨è</span>
                        </label>
                        <p class="description" style="margin-left: 24px; margin-top: 5px;">
                            ä½¿ç”¨ä¸Šé¢é…ç½®çš„ Client ID å’Œ Client Secretã€‚é€‚ç”¨äºæ–°è´¦æˆ·å’Œå·²è¿ç§»çš„è´¦æˆ·ã€‚
                        </p>

                        <label style="display: block; margin: 15px 0 10px 0;">
                            <input type="radio" name="woo_walmart_CA_auth_method" value="signature" <?php checked(get_option('woo_walmart_CA_auth_method', 'oauth'), 'signature'); ?> />
                            <strong>Digital Signature (æ—§ç‰ˆ)</strong>
                            <span style="color: #d63638; margin-left: 5px;">âš ï¸ å³å°†å¼ƒç”¨</span>
                        </label>
                        <p class="description" style="margin-left: 24px; margin-top: 5px;">
                            ä½¿ç”¨ Consumer ID å’Œ Private Keyã€‚ä»…åœ¨ OAuth 2.0 ä¸å¯ç”¨æ—¶ä½¿ç”¨ã€‚
                        </p>
                    </td>
                </tr>
                <tr class="ca-legacy-auth-fields" style="display: none;">
                    <th>Consumer ID (æ—§ç‰ˆ)</th>
                    <td>
                        <input type="text" name="woo_walmart_CA_consumer_id" value="<?php echo esc_attr(get_option('woo_walmart_CA_consumer_id', '')); ?>" class="regular-text" placeholder="e2461fa0-739b-4764-9d22-f73f990ab431" />
                        <p class="description">æ—§ç‰ˆè®¤è¯çš„ Consumer IDã€‚ä» Walmart å¼€å‘è€…é—¨æˆ·çš„ "API Keys (Legacy)" éƒ¨åˆ†è·å–ã€‚</p>
                    </td>
                </tr>
                <tr class="ca-legacy-auth-fields" style="display: none;">
                    <th>Private Key (æ—§ç‰ˆ)</th>
                    <td>
                        <textarea name="woo_walmart_CA_private_key" rows="8" class="large-text code" placeholder="-----BEGIN PRIVATE KEY-----&#10;MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC...&#10;-----END PRIVATE KEY-----"><?php echo esc_textarea(get_option('woo_walmart_CA_private_key', '')); ?></textarea>
                        <p class="description">æ—§ç‰ˆè®¤è¯çš„ Private Keyï¼ˆå®Œæ•´çš„ PEM æ ¼å¼ï¼ŒåŒ…å« BEGIN å’Œ END æ ‡è®°ï¼‰ã€‚ä» Walmart å¼€å‘è€…é—¨æˆ·è·å–ã€‚</p>
                    </td>
                </tr>
                <tr class="ca-legacy-auth-fields" style="display: none;">
                    <th>Channel Type (æ—§ç‰ˆ)</th>
                    <td>
                        <input type="text" name="woo_walmart_CA_legacy_channel_type" value="<?php echo esc_attr(get_option('woo_walmart_CA_legacy_channel_type', '')); ?>" class="regular-text" placeholder="d62e611e-606e-41b9-96cf-38ee37331c47" />
                        <p class="description">æ—§ç‰ˆè®¤è¯ä¸“ç”¨çš„ Channel Type UUIDã€‚ä» Walmart å¼€å‘è€…é—¨æˆ·çš„ "API Keys (Legacy)" åº•éƒ¨è·å–ã€‚</p>
                    </td>
                </tr>
                <script>
                jQuery(document).ready(function($) {
                    function toggleCAAuthFields() {
                        var method = $('input[name="woo_walmart_CA_auth_method"]:checked').val();
                        if (method === 'signature') {
                            $('.ca-legacy-auth-fields').show();
                        } else {
                            $('.ca-legacy-auth-fields').hide();
                        }
                    }

                    $('input[name="woo_walmart_CA_auth_method"]').change(toggleCAAuthFields);
                    toggleCAAuthFields();
                });
                </script>
                <tr>
                    <th>å¤‡è´§æ—¶é—´ (Fulfillment Lag Time)</th>
                    <td>
                        <input type="number" name="woo_walmart_CA_fulfillment_lag_time" value="<?php echo esc_attr(get_option('woo_walmart_CA_fulfillment_lag_time', 1)); ?>" class="small-text" min="1">
                        <p class="description">åŠ æ‹¿å¤§å¸‚åœºï¼šæ‚¨åœ¨æ”¶åˆ°è®¢å•åï¼Œéœ€è¦å¤šå°‘å¤©æ¥å‡†å¤‡å‘è´§ã€‚é»˜è®¤ä¸º1å¤©ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å‘è´§æ¨¡å¼</th>
                    <td>
                        <select name="woo_walmart_CA_fulfillment_type" disabled>
                            <option value="SELLER_FULFILLED" selected>è‡ªå‘è´§ (Seller Fulfilled)</option>
                            <option value="WFS_CA">æ²ƒå°”ç›å‘è´§ (WFS_CA)</option>
                        </select>
                        <p class="description">åŠ æ‹¿å¤§å¸‚åœºå½“å‰é…ç½®ä¸ºè‡ªå‘è´§æ¨¡å¼ã€‚å±¥è¡Œä¸­å¿ƒIDè¯·ä½¿ç”¨æ‚¨åœ¨æ²ƒå°”ç›åŠ æ‹¿å¤§åå°çœ‹åˆ°çš„å®é™…IDã€‚å¦‚éœ€ä½¿ç”¨WFSï¼Œè¯·è”ç³»æ²ƒå°”ç›ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å±¥è¡Œä¸­å¿ƒID</th>
                    <td>
                        <input type="text" name="woo_walmart_CA_fulfillment_center_id" value="<?php echo esc_attr(get_option('woo_walmart_CA_fulfillment_center_id', '')); ?>" class="regular-text" />
                        <p class="description">åŠ æ‹¿å¤§å¸‚åœºå±¥è¡Œä¸­å¿ƒIDã€‚è¯·è¾“å…¥æ‚¨åœ¨æ²ƒå°”ç›åŠ æ‹¿å¤§å–å®¶åå°çœ‹åˆ°çš„å®é™…å±¥è¡Œä¸­å¿ƒIDï¼ˆå¦‚ï¼š10002789621ï¼‰ã€‚å¦‚æœä¸ºç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤çš„è‡ªå‘è´§æ¨¡å¼ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>è¿è¾“æ¨¡æ¿</th>
                    <td>
                        <input type="text" name="woo_walmart_CA_shipping_template" value="<?php echo esc_attr(get_option('woo_walmart_CA_shipping_template', '')); ?>" class="regular-text" />
                        <p class="description">åŠ æ‹¿å¤§å¸‚åœºè¿è¾“æ¨¡æ¿åç§°ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Channel Type</th>
                    <td>
                        <input type="text" name="woo_walmart_CA_channel_type" value="<?php echo esc_attr(get_option('woo_walmart_CA_channel_type', '')); ?>" class="regular-text" placeholder="d62e611e-606e-41b9-96cf-38ee37331c47" />
                        <p class="description">åŠ æ‹¿å¤§å¸‚åœºä¸“ç”¨çš„Channel Type UUIDã€‚è¿™æ˜¯APIè¯·æ±‚å¤´ WM_CONSUMER.CHANNEL.TYPE çš„å€¼ã€‚è¯·ä»æ²ƒå°”ç›åŠ æ‹¿å¤§å¼€å‘è€…é—¨æˆ·è·å–æ­£ç¡®çš„UUIDã€‚å¦‚æœä¸ºç©ºï¼Œå°†ä½¿ç”¨ä¸šåŠ¡å•å…ƒåç§°ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>APIç‰ˆæœ¬</th>
                    <td>
                        <select name="woo_walmart_CA_api_version">
                            <option value="5.0" <?php selected(get_option('woo_walmart_CA_api_version', '5.0'), '5.0'); ?>>V5.0</option>
                        </select>
                        <p class="description">åŠ æ‹¿å¤§å¸‚åœºAPIç‰ˆæœ¬ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>æµ‹è¯•è¿æ¥</th>
                    <td>
                        <button type="button" class="button button-secondary" onclick="testMarketConnection('CA')" id="test-ca-btn">
                            ğŸ‡¨ğŸ‡¦ æµ‹è¯•åŠ æ‹¿å¤§å¸‚åœºè¿æ¥
                        </button>
                        <span id="test-ca-result" style="margin-left: 10px;"></span>
                        <p class="description">æµ‹è¯•åŠ æ‹¿å¤§å¸‚åœºçš„APIè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚æ”¯æŒåŒè¯­æ ‡ç­¾å’Œå¤æ‚ç¨åˆ¶ã€‚</p>
                    </td>
                </tr>
            </table>

            <!-- å¢¨è¥¿å“¥å¸‚åœºè®¾ç½® -->
            <h2>ğŸ‡²ğŸ‡½ å¢¨è¥¿å“¥å¸‚åœº (WALMART_MX)</h2>
            <table class="form-table">
                <tr>
                    <th>å¯ç”¨å¢¨è¥¿å“¥å¸‚åœº</th>
                    <td>
                        <label>
                            <input type="checkbox" name="woo_walmart_MX_enabled" value="1" <?php checked(get_option('woo_walmart_MX_enabled', 0), 1); ?> />
                            å¯ç”¨å¢¨è¥¿å“¥æ²ƒå°”ç›å¸‚åœºåŒæ­¥
                        </label>
                        <p class="description">å‹¾é€‰ä»¥å¯ç”¨å¢¨è¥¿å“¥å¸‚åœºçš„äº§å“åŒæ­¥åŠŸèƒ½ã€‚æ”¯æŒè¥¿ç­ç‰™è¯­æœ¬åœ°åŒ–å’ŒIVAç¨åˆ¶ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Client ID</th>
                    <td>
                        <input type="text" name="woo_walmart_MX_client_id" value="<?php echo esc_attr(get_option('woo_walmart_MX_client_id', '')); ?>" class="regular-text" />
                        <p class="description">å¢¨è¥¿å“¥å¸‚åœºçš„Client IDã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Client Secret</th>
                    <td>
                        <input type="password" name="woo_walmart_MX_client_secret" value="<?php echo esc_attr(get_option('woo_walmart_MX_client_secret', '')); ?>" class="regular-text" />
                        <p class="description">å¢¨è¥¿å“¥å¸‚åœºçš„Client Secretã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å¤‡è´§æ—¶é—´ (Fulfillment Lag Time)</th>
                    <td>
                        <input type="number" name="woo_walmart_MX_fulfillment_lag_time" value="<?php echo esc_attr(get_option('woo_walmart_MX_fulfillment_lag_time', 2)); ?>" class="small-text" min="1">
                        <p class="description">å¢¨è¥¿å“¥å¸‚åœºï¼šæ‚¨åœ¨æ”¶åˆ°è®¢å•åï¼Œéœ€è¦å¤šå°‘å¤©æ¥å‡†å¤‡å‘è´§ã€‚é»˜è®¤ä¸º2å¤©ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å‘è´§æ¨¡å¼</th>
                    <td>
                        <select name="woo_walmart_MX_fulfillment_type" disabled>
                            <option value="SELLER_FULFILLED" selected>è‡ªå‘è´§ (Seller Fulfilled)</option>
                            <option value="WFS_MX">æ²ƒå°”ç›å‘è´§ (WFS_MX)</option>
                        </select>
                        <p class="description">å¢¨è¥¿å“¥å¸‚åœºå½“å‰é…ç½®ä¸ºè‡ªå‘è´§æ¨¡å¼ã€‚å±¥è¡Œä¸­å¿ƒIDè¯·ä½¿ç”¨æ‚¨åœ¨æ²ƒå°”ç›å¢¨è¥¿å“¥åå°çœ‹åˆ°çš„å®é™…IDã€‚å¦‚éœ€ä½¿ç”¨WFSï¼Œè¯·è”ç³»æ²ƒå°”ç›ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å±¥è¡Œä¸­å¿ƒID</th>
                    <td>
                        <input type="text" name="woo_walmart_MX_fulfillment_center_id" value="<?php echo esc_attr(get_option('woo_walmart_MX_fulfillment_center_id', '')); ?>" class="regular-text" />
                        <p class="description">å¢¨è¥¿å“¥å¸‚åœºå±¥è¡Œä¸­å¿ƒIDã€‚è¯·è¾“å…¥æ‚¨åœ¨æ²ƒå°”ç›å¢¨è¥¿å“¥å–å®¶åå°çœ‹åˆ°çš„å®é™…å±¥è¡Œä¸­å¿ƒIDã€‚å¦‚æœä¸ºç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤çš„è‡ªå‘è´§æ¨¡å¼ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>è¿è¾“æ¨¡æ¿</th>
                    <td>
                        <input type="text" name="woo_walmart_MX_shipping_template" value="<?php echo esc_attr(get_option('woo_walmart_MX_shipping_template', '')); ?>" class="regular-text" />
                        <p class="description">å¢¨è¥¿å“¥å¸‚åœºè¿è¾“æ¨¡æ¿åç§°ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>APIç‰ˆæœ¬</th>
                    <td>
                        <select name="woo_walmart_MX_api_version">
                            <option value="5.0" <?php selected(get_option('woo_walmart_MX_api_version', '5.0'), '5.0'); ?>>V5.0</option>
                        </select>
                        <p class="description">å¢¨è¥¿å“¥å¸‚åœºAPIç‰ˆæœ¬ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>æµ‹è¯•è¿æ¥</th>
                    <td>
                        <button type="button" class="button button-secondary" onclick="testMarketConnection('MX')" id="test-mx-btn">
                            ğŸ‡²ğŸ‡½ æµ‹è¯•å¢¨è¥¿å“¥å¸‚åœºè¿æ¥
                        </button>
                        <span id="test-mx-result" style="margin-left: 10px;"></span>
                        <p class="description">æµ‹è¯•å¢¨è¥¿å“¥å¸‚åœºçš„APIè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚æ”¯æŒè¥¿ç­ç‰™è¯­æœ¬åœ°åŒ–å’ŒIVAç¨åˆ¶ã€‚</p>
                    </td>
                </tr>
            </table>

            <!-- æ™ºåˆ©å¸‚åœºè®¾ç½® -->
            <h2>ğŸ‡¨ğŸ‡± æ™ºåˆ©å¸‚åœº (WALMART_CL)</h2>
            <table class="form-table">
                <tr>
                    <th>å¯ç”¨æ™ºåˆ©å¸‚åœº</th>
                    <td>
                        <label>
                            <input type="checkbox" name="woo_walmart_CL_enabled" value="1" <?php checked(get_option('woo_walmart_CL_enabled', 0), 1); ?> />
                            å¯ç”¨æ™ºåˆ©æ²ƒå°”ç›å¸‚åœºåŒæ­¥
                        </label>
                        <p class="description">å‹¾é€‰ä»¥å¯ç”¨æ™ºåˆ©å¸‚åœºçš„äº§å“åŒæ­¥åŠŸèƒ½ã€‚å—ç¾å¸‚åœºå…¥å£ï¼Œæ”¯æŒåŸºç¡€åŠŸèƒ½é›†ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Client ID</th>
                    <td>
                        <input type="text" name="woo_walmart_CL_client_id" value="<?php echo esc_attr(get_option('woo_walmart_CL_client_id', '')); ?>" class="regular-text" />
                        <p class="description">æ™ºåˆ©å¸‚åœºçš„Client IDã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>Client Secret</th>
                    <td>
                        <input type="password" name="woo_walmart_CL_client_secret" value="<?php echo esc_attr(get_option('woo_walmart_CL_client_secret', '')); ?>" class="regular-text" />
                        <p class="description">æ™ºåˆ©å¸‚åœºçš„Client Secretã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å¤‡è´§æ—¶é—´ (Fulfillment Lag Time)</th>
                    <td>
                        <input type="number" name="woo_walmart_CL_fulfillment_lag_time" value="<?php echo esc_attr(get_option('woo_walmart_CL_fulfillment_lag_time', 3)); ?>" class="small-text" min="1">
                        <p class="description">æ™ºåˆ©å¸‚åœºï¼šæ‚¨åœ¨æ”¶åˆ°è®¢å•åï¼Œéœ€è¦å¤šå°‘å¤©æ¥å‡†å¤‡å‘è´§ã€‚é»˜è®¤ä¸º3å¤©ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å‘è´§æ¨¡å¼</th>
                    <td>
                        <select name="woo_walmart_CL_fulfillment_type" disabled>
                            <option value="SELLER_FULFILLED" selected>è‡ªå‘è´§ (Seller Fulfilled)</option>
                            <option value="WFS_CL">æ²ƒå°”ç›å‘è´§ (WFS_CL)</option>
                        </select>
                        <p class="description">æ™ºåˆ©å¸‚åœºå½“å‰é…ç½®ä¸ºè‡ªå‘è´§æ¨¡å¼ã€‚å±¥è¡Œä¸­å¿ƒIDè¯·ä½¿ç”¨æ‚¨åœ¨æ²ƒå°”ç›æ™ºåˆ©åå°çœ‹åˆ°çš„å®é™…IDã€‚å¦‚éœ€ä½¿ç”¨WFSï¼Œè¯·è”ç³»æ²ƒå°”ç›ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>å±¥è¡Œä¸­å¿ƒID</th>
                    <td>
                        <input type="text" name="woo_walmart_CL_fulfillment_center_id" value="<?php echo esc_attr(get_option('woo_walmart_CL_fulfillment_center_id', '')); ?>" class="regular-text" />
                        <p class="description">æ™ºåˆ©å¸‚åœºå±¥è¡Œä¸­å¿ƒIDã€‚è¯·è¾“å…¥æ‚¨åœ¨æ²ƒå°”ç›æ™ºåˆ©å–å®¶åå°çœ‹åˆ°çš„å®é™…å±¥è¡Œä¸­å¿ƒIDã€‚å¦‚æœä¸ºç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤çš„è‡ªå‘è´§æ¨¡å¼ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>è¿è¾“æ¨¡æ¿</th>
                    <td>
                        <input type="text" name="woo_walmart_CL_shipping_template" value="<?php echo esc_attr(get_option('woo_walmart_CL_shipping_template', '')); ?>" class="regular-text" />
                        <p class="description">æ™ºåˆ©å¸‚åœºè¿è¾“æ¨¡æ¿åç§°ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>APIç‰ˆæœ¬</th>
                    <td>
                        <select name="woo_walmart_CL_api_version">
                            <option value="5.0" <?php selected(get_option('woo_walmart_CL_api_version', '5.0'), '5.0'); ?>>V5.0</option>
                        </select>
                        <p class="description">æ™ºåˆ©å¸‚åœºAPIç‰ˆæœ¬ã€‚</p>
                    </td>
                </tr>
                <tr>
                    <th>æµ‹è¯•è¿æ¥</th>
                    <td>
                        <button type="button" class="button button-secondary" onclick="testMarketConnection('CL')" id="test-cl-btn">
                            ğŸ‡¨ğŸ‡± æµ‹è¯•æ™ºåˆ©å¸‚åœºè¿æ¥
                        </button>
                        <span id="test-cl-result" style="margin-left: 10px;"></span>
                        <p class="description">æµ‹è¯•æ™ºåˆ©å¸‚åœºçš„APIè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚å—ç¾å¸‚åœºå…¥å£ï¼Œæ”¯æŒåŸºç¡€åŠŸèƒ½é›†ã€‚</p>
                    </td>
                </tr>
            </table>

            <p><input type="submit" class="button button-primary" value="ğŸ’¾ ä¿å­˜å¤šå¸‚åœºè®¾ç½®"></p>
        </form>

        <script type="text/javascript">
        function testMarketConnection(market) {
            const btn = document.getElementById('test-' + market.toLowerCase() + '-btn');
            const result = document.getElementById('test-' + market.toLowerCase() + '-result');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.innerHTML = 'ğŸ”„ æµ‹è¯•ä¸­...';
            result.innerHTML = '';

            // å‡†å¤‡AJAXæ•°æ®
            const formData = new FormData();
            formData.append('action', 'walmart_test_market_connection');
            formData.append('market', market);
            formData.append('nonce', '<?php echo wp_create_nonce('walmart_test_market_connection'); ?>');

            // å‘é€AJAXè¯·æ±‚
            fetch(ajaxurl, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                const marketFlags = {
                    'US': 'ğŸ‡ºğŸ‡¸',
                    'CA': 'ğŸ‡¨ğŸ‡¦',
                    'MX': 'ğŸ‡²ğŸ‡½',
                    'CL': 'ğŸ‡¨ğŸ‡±'
                };
                btn.innerHTML = marketFlags[market] + ' æµ‹è¯•' + (market === 'US' ? 'ç¾å›½' : market === 'CA' ? 'åŠ æ‹¿å¤§' : market === 'MX' ? 'å¢¨è¥¿å“¥' : 'æ™ºåˆ©') + 'å¸‚åœºè¿æ¥';

                // æ˜¾ç¤ºç»“æœ
                if (data.success) {
                    result.innerHTML = '<span style="color: #46b450; font-weight: bold;">âœ… ' + data.data.message + '</span>';
                } else {
                    result.innerHTML = '<span style="color: #dc3232; font-weight: bold;">âŒ ' + data.data.message + '</span>';
                }
            })
            .catch(error => {
                // é”™è¯¯å¤„ç†
                btn.disabled = false;
                const marketFlags = {
                    'US': 'ğŸ‡ºğŸ‡¸',
                    'CA': 'ğŸ‡¨ğŸ‡¦',
                    'MX': 'ğŸ‡²ğŸ‡½',
                    'CL': 'ğŸ‡¨ğŸ‡±'
                };
                btn.innerHTML = marketFlags[market] + ' æµ‹è¯•' + (market === 'US' ? 'ç¾å›½' : market === 'CA' ? 'åŠ æ‹¿å¤§' : market === 'MX' ? 'å¢¨è¥¿å“¥' : 'æ™ºåˆ©') + 'å¸‚åœºè¿æ¥';
                result.innerHTML = '<span style="color: #dc3232; font-weight: bold;">âŒ è¿æ¥å¤±è´¥: ' + error.message + '</span>';
            });
        }
        </script>

        <hr>

        <h2>ğŸ“Š å¤šå¸‚åœºè¿æ¥çŠ¶æ€æ€»è§ˆ</h2>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 15px 0;">
            <p><strong>ğŸ’¡ æç¤ºï¼š</strong>æ¯ä¸ªå¸‚åœºéƒ½æœ‰ç‹¬ç«‹çš„æµ‹è¯•æŒ‰é’®ï¼Œæ‚¨å¯ä»¥åœ¨å„å¸‚åœºé…ç½®åŒºåŸŸä¸­æµ‹è¯•å¯¹åº”çš„APIè¿æ¥ã€‚</p>
            <p>æµ‹è¯•å°†éªŒè¯ä»¥ä¸‹å†…å®¹ï¼š</p>
            <ul style="margin-left: 20px; margin-bottom: 10px;">
                <li>âœ… APIå¯†é’¥çš„æœ‰æ•ˆæ€§</li>
                <li>âœ… å¸‚åœºç‰¹å®šçš„ä¸šåŠ¡å•å…ƒè®¾ç½®</li>
                <li>âœ… Tokenè·å–çŠ¶æ€</li>
                <li>âœ… APIç«¯ç‚¹è¿é€šæ€§æµ‹è¯•</li>
            </ul>
        </div>

        <hr>

        <h2>è¿æ¥è°ƒè¯•ä¿¡æ¯</h2>
        <p>å¦‚æœ"æµ‹è¯•è¿æ¥"å¤±è´¥ï¼Œä¸‹é¢çš„ä¿¡æ¯å¯ä»¥å¸®åŠ©æ‚¨æˆ–æ‚¨çš„ä¸»æœºæœåŠ¡å•†è¯Šæ–­é—®é¢˜ã€‚</p>
        <?php
        $debug_url = 'https://marketplace.walmartapis.com/v3/token';
        // ä½¿ç”¨ HEAD è¯·æ±‚ï¼Œæ›´è½»é‡ï¼Œåªä¸ºæµ‹è¯•è¿æ¥æ€§
        $response = wp_remote_head( $debug_url, [ 'timeout' => 20 ] );

        if ( is_wp_error( $response ) ) {
            echo '<div class="notice notice-error is-dismissible"><p><strong>è°ƒè¯•è¯·æ±‚å¤±è´¥ã€‚</strong> è¿™é€šå¸¸æ„å‘³ç€æ‚¨çš„æœåŠ¡å™¨æ— æ³•è¿æ¥åˆ°æ²ƒå°”ç›çš„æœåŠ¡å™¨ã€‚ä¸‹é¢æ˜¯å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼š</p>';
            echo '<pre>' . esc_html( print_r( $response->get_error_messages(), true ) ) . '</pre>';
            echo '<p>è¯·å°†æ­¤é”™è¯¯ä¿¡æ¯æˆªå›¾å¹¶æä¾›ç»™æ‚¨çš„ä¸»æœºæœåŠ¡å•†ï¼Œä»–ä»¬å¯èƒ½éœ€è¦æ£€æŸ¥æœåŠ¡å™¨çš„é˜²ç«å¢™æˆ–SSL/TLSé…ç½®ã€‚</p></div>';
        } else {
            $http_code = wp_remote_retrieve_response_code( $response );
            $http_message = wp_remote_retrieve_response_message( $response );
            echo '<div class="notice notice-success is-dismissible"><p><strong>è°ƒè¯•è¯·æ±‚æˆåŠŸã€‚</strong> æ‚¨çš„æœåŠ¡å™¨å¯ä»¥è¿æ¥åˆ°æ²ƒå°”ç›çš„æœåŠ¡å™¨ã€‚</p>';
            echo '<p>HTTPçŠ¶æ€ç ï¼š ' . esc_html( $http_code ) . ' ' . esc_html( $http_message ) . '</p>';
            echo '<p>è¿™è¯´æ˜ç½‘ç»œè¿æ¥æœ¬èº«æ˜¯æ­£å¸¸çš„ã€‚å¦‚æœè·å–Tokenä»ç„¶å¤±è´¥ï¼Œé—®é¢˜å¾ˆå¯èƒ½å‡ºåœ¨æ‚¨çš„Client IDæˆ–Client Secretä¸Šï¼Œè¯·ä»”ç»†æ£€æŸ¥ã€‚</p></div>';
        }
        ?>

        <!-- é˜Ÿåˆ—ç®¡ç†éƒ¨åˆ† -->
        <h2>åŒæ­¥é˜Ÿåˆ—ç®¡ç†</h2>
        <?php
        $queue = get_option('walmart_sync_queue', []);
        $queue_count = count($queue);
        ?>
        <div class="card">
            <h3>å½“å‰é˜Ÿåˆ—çŠ¶æ€</h3>
            <p>é˜Ÿåˆ—ä¸­æœ‰ <strong><?php echo $queue_count; ?></strong> ä¸ªäº§å“ç­‰å¾…åŒæ­¥ã€‚</p>

            <?php if ($queue_count > 0): ?>
                <form method="post" style="margin-top: 10px;">
                    <?php wp_nonce_field('woo_walmart_process_queue'); ?>
                    <input type="hidden" name="action" value="process_queue">
                    <input type="submit" class="button button-primary" value="ç«‹å³å¤„ç†é˜Ÿåˆ—ï¼ˆå¤„ç†å‰5ä¸ªï¼‰">
                </form>

                <h4>é˜Ÿåˆ—ä¸­çš„äº§å“ï¼š</h4>
                <ul style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    <?php foreach (array_slice($queue, 0, 20) as $product_id):
                        $product = wc_get_product($product_id);
                        $product_name = $product ? $product->get_name() : "äº§å“ID: $product_id";
                    ?>
                        <li><?php echo esc_html($product_name); ?> (ID: <?php echo $product_id; ?>)</li>
                    <?php endforeach; ?>
                    <?php if ($queue_count > 20): ?>
                        <li><em>...è¿˜æœ‰ <?php echo ($queue_count - 20); ?> ä¸ªäº§å“</em></li>
                    <?php endif; ?>
                </ul>
            <?php endif; ?>

            <p><small>
                <strong>è¯´æ˜ï¼š</strong>æ‰¹é‡åŒæ­¥çš„äº§å“ä¼šå…ˆåŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åç”±å®šæ—¶ä»»åŠ¡æ¯5åˆ†é’Ÿè‡ªåŠ¨å¤„ç†ã€‚
                å¦‚æœå®šæ—¶ä»»åŠ¡æœªæ­£å¸¸å·¥ä½œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„æŒ‰é’®æ‰‹åŠ¨å¤„ç†é˜Ÿåˆ—ã€‚
            </small></p>
        </div>
    </div>
    <?php
}

// æ—¥å¿—é¡µé¢å†…å®¹
function woo_walmart_sync_logs_page() {
    global $wpdb;

    // æ£€æŸ¥ä½¿ç”¨æ–°çš„æ—¥å¿—è¡¨
    $logs_table = $wpdb->prefix . 'walmart_sync_logs';
    $old_table = $wpdb->prefix . 'woo_walmart_sync_logs';

    // ä¼˜å…ˆä½¿ç”¨æ–°è¡¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨æ—§è¡¨
    $table_name = $logs_table;
    if($wpdb->get_var("SHOW TABLES LIKE '$logs_table'") != $logs_table) {
        if($wpdb->get_var("SHOW TABLES LIKE '$old_table'") == $old_table) {
            $table_name = $old_table;
        } else {
            echo '<div class="error"><p>æ—¥å¿—è¡¨ä¸å­˜åœ¨ï¼Œè¯·å°è¯•åœç”¨å¹¶é‡æ–°å¯ç”¨æ’ä»¶ä»¥åˆ›å»ºæ•°æ®åº“è¡¨ã€‚</p></div>';
            return;
        }
    }

    $result_message = '';

    // å¤„ç†æ“ä½œ
    if (isset($_POST['action'])) {
        check_admin_referer('walmart_logs_action');

        switch ($_POST['action']) {
            case 'delete_logs':
                if (!empty($_POST['log_ids'])) {
                    $ids = array_map('intval', $_POST['log_ids']);
                    $placeholders = implode(',', array_fill(0, count($ids), '%d'));
                    $wpdb->query($wpdb->prepare(
                        "DELETE FROM {$table_name} WHERE id IN ({$placeholders})",
                        $ids
                    ));
                    $result_message = '<div class="notice notice-success"><p>å·²åˆ é™¤ ' . count($ids) . ' æ¡æ—¥å¿—ã€‚</p></div>';
                }
                break;

            case 'clear_old_logs':
                // åˆ é™¤7å¤©å‰çš„æ—¥å¿—
                $wpdb->query($wpdb->prepare(
                    "DELETE FROM {$table_name} WHERE created_at < %s",
                    date('Y-m-d H:i:s', strtotime('-7 days'))
                ));
                $result_message = '<div class="notice notice-success"><p>å·²æ¸…é™¤7å¤©å‰çš„æ—§æ—¥å¿—ã€‚</p></div>';
                break;

            case 'clear_debug_logs':
                // åˆ é™¤è°ƒè¯•çº§åˆ«çš„æ—¥å¿—
                $level_field = ($table_name == $old_table) ? 'status' : 'level';
                $wpdb->query("DELETE FROM {$table_name} WHERE {$level_field} = 'è°ƒè¯•'");
                $result_message = '<div class="notice notice-success"><p>å·²æ¸…é™¤æ‰€æœ‰è°ƒè¯•æ—¥å¿—ã€‚</p></div>';
                break;

            case 'clear_all_logs':
                $deleted = $wpdb->query("DELETE FROM {$table_name}");
                if ($deleted !== false) {
                    $result_message = '<div class="notice notice-success"><p>å·²æˆåŠŸæ¸…é™¤ ' . $deleted . ' æ¡æ—¥å¿—è®°å½•ã€‚</p></div>';
                } else {
                    $result_message = '<div class="notice notice-error"><p>æ¸…é™¤æ—¥å¿—å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p></div>';
                }
                break;
        }
    }

    // è·å–ç­›é€‰å‚æ•°
    $per_page = 50;
    $current_page = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
    $offset = ($current_page - 1) * $per_page;

    $level_filter = isset($_GET['level_filter']) ? sanitize_text_field($_GET['level_filter']) : '';
    $operation_filter = isset($_GET['operation_filter']) ? sanitize_text_field($_GET['operation_filter']) : '';
    $date_filter = isset($_GET['date_filter']) ? sanitize_text_field($_GET['date_filter']) : '';
    $sku_filter = isset($_GET['sku_filter']) ? sanitize_text_field($_GET['sku_filter']) : '';

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    $where_conditions = ['1=1'];
    $where_values = [];

    // æ ¹æ®è¡¨ç»“æ„è°ƒæ•´å­—æ®µå
    $level_field = ($table_name == $old_table) ? 'status' : 'level';
    $operation_field = ($table_name == $old_table) ? 'action' : 'operation';

    if (!empty($level_filter)) {
        $where_conditions[] = "{$level_field} = %s";
        $where_values[] = $level_filter;
    }

    if (!empty($operation_filter)) {
        $where_conditions[] = "{$operation_field} LIKE %s";
        $where_values[] = '%' . $operation_filter . '%';
    }

    if (!empty($date_filter)) {
        $where_conditions[] = "DATE(created_at) = %s";
        $where_values[] = $date_filter;
    }

    // SKUç­›é€‰ï¼šé€šè¿‡product_idå…³è”æˆ–åœ¨request/responseä¸­æœç´¢
    if (!empty($sku_filter)) {
        // å…ˆé€šè¿‡SKUæŸ¥æ‰¾product_id
        $product_id = $wpdb->get_var($wpdb->prepare(
            "SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key = '_sku' AND meta_value = %s LIMIT 1",
            $sku_filter
        ));

        if ($product_id) {
            // å¦‚æœæ‰¾åˆ°product_idï¼Œä¼˜å…ˆä½¿ç”¨product_idç­›é€‰
            $where_conditions[] = "(product_id = %d OR request LIKE %s OR response LIKE %s)";
            $where_values[] = $product_id;
            $where_values[] = '%' . $wpdb->esc_like($sku_filter) . '%';
            $where_values[] = '%' . $wpdb->esc_like($sku_filter) . '%';
        } else {
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°product_idï¼Œåªåœ¨requestå’Œresponseä¸­æœç´¢
            $where_conditions[] = "(request LIKE %s OR response LIKE %s)";
            $where_values[] = '%' . $wpdb->esc_like($sku_filter) . '%';
            $where_values[] = '%' . $wpdb->esc_like($sku_filter) . '%';
        }
    }

    $where_clause = implode(' AND ', $where_conditions);

    // è·å–æ€»æ•°
    $total_query = "SELECT COUNT(*) FROM {$table_name} WHERE {$where_clause}";
    if (!empty($where_values)) {
        $total_items = $wpdb->get_var($wpdb->prepare($total_query, $where_values));
    } else {
        $total_items = $wpdb->get_var($total_query);
    }

    // è·å–æ—¥å¿—åˆ—è¡¨
    $logs_query = "SELECT * FROM {$table_name} WHERE {$where_clause} ORDER BY created_at DESC LIMIT %d OFFSET %d";
    $query_values = array_merge($where_values, [(int) $per_page, (int) $offset]);
    $logs = $wpdb->get_results($wpdb->prepare($logs_query, $query_values));

    // è®¡ç®—åˆ†é¡µ
    $total_pages = ceil($total_items / $per_page);

    // è·å–ç»Ÿè®¡ä¿¡æ¯
    $stats = [
        'total' => $wpdb->get_var("SELECT COUNT(*) FROM {$table_name}"),
        'error' => $wpdb->get_var("SELECT COUNT(*) FROM {$table_name} WHERE {$level_field} = 'é”™è¯¯'"),
        'warning' => $wpdb->get_var("SELECT COUNT(*) FROM {$table_name} WHERE {$level_field} = 'è­¦å‘Š'"),
        'success' => $wpdb->get_var("SELECT COUNT(*) FROM {$table_name} WHERE {$level_field} = 'æˆåŠŸ'"),
        'debug' => $wpdb->get_var("SELECT COUNT(*) FROM {$table_name} WHERE {$level_field} = 'è°ƒè¯•'"),
        'info' => $wpdb->get_var("SELECT COUNT(*) FROM {$table_name} WHERE {$level_field} = 'ä¿¡æ¯'")
    ];

    // è·å–æ“ä½œç±»å‹åˆ—è¡¨
    $operation_types = $wpdb->get_col("SELECT DISTINCT {$operation_field} FROM {$table_name} ORDER BY {$operation_field}");

    ?>
    <div class="wrap walmart-logs">
        <h1><span class="dashicons dashicons-list-view"></span> æ²ƒå°”ç›åŒæ­¥æ—¥å¿—</h1>
        <p class="description">æŸ¥çœ‹å’Œç®¡ç†WalmartåŒæ­¥çš„è¯¦ç»†æ—¥å¿—è®°å½•ï¼Œæ”¯æŒæŒ‰ç±»å‹ã€çº§åˆ«ã€æ—¥æœŸç­›é€‰</p>

        <?php echo $result_message; ?>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="walmart-stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
            <div class="walmart-stat-box" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px;">ğŸ“Š æ€»æ—¥å¿—</h3>
                <div class="stat-number" style="font-size: 24px; font-weight: bold; color: #2271b1;"><?php echo $stats['total'] ?: 0; ?></div>
                <p style="margin: 5px 0 0 0; color: #646970; font-size: 12px;">æ‰€æœ‰æ—¥å¿—</p>
            </div>

            <div class="walmart-stat-box" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px;">âŒ é”™è¯¯</h3>
                <div class="stat-number" style="font-size: 24px; font-weight: bold; color: #d63638;"><?php echo $stats['error'] ?: 0; ?></div>
                <p style="margin: 5px 0 0 0; color: #646970; font-size: 12px;">é”™è¯¯æ—¥å¿—</p>
            </div>

            <div class="walmart-stat-box" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px;">âš ï¸ è­¦å‘Š</h3>
                <div class="stat-number" style="font-size: 24px; font-weight: bold; color: #f56e28;"><?php echo $stats['warning'] ?: 0; ?></div>
                <p style="margin: 5px 0 0 0; color: #646970; font-size: 12px;">è­¦å‘Šæ—¥å¿—</p>
            </div>

            <div class="walmart-stat-box" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px;">âœ… æˆåŠŸ</h3>
                <div class="stat-number" style="font-size: 24px; font-weight: bold; color: #00a32a;"><?php echo $stats['success'] ?: 0; ?></div>
                <p style="margin: 5px 0 0 0; color: #646970; font-size: 12px;">æˆåŠŸæ—¥å¿—</p>
            </div>

            <div class="walmart-stat-box" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px;">â„¹ï¸ ä¿¡æ¯</h3>
                <div class="stat-number" style="font-size: 24px; font-weight: bold; color: #2271b1;"><?php echo $stats['info'] ?: 0; ?></div>
                <p style="margin: 5px 0 0 0; color: #646970; font-size: 12px;">ä¿¡æ¯æ—¥å¿—</p>
            </div>

            <div class="walmart-stat-box" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px;">ğŸ”§ è°ƒè¯•</h3>
                <div class="stat-number" style="font-size: 24px; font-weight: bold; color: #646970;"><?php echo $stats['debug'] ?: 0; ?></div>
                <p style="margin: 5px 0 0 0; color: #646970; font-size: 12px;">è°ƒè¯•æ—¥å¿—</p>
            </div>
        </div>

        <!-- ç­›é€‰é¢æ¿ -->
        <div class="walmart-search-panel" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin: 20px 0;">
            <form method="get" class="search-form">
                <input type="hidden" name="page" value="woo-walmart-sync-logs">
                <div class="search-group" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <select name="level_filter" class="level-filter" style="min-width: 120px;">
                        <option value="">æ‰€æœ‰çº§åˆ«</option>
                        <option value="é”™è¯¯" <?php selected($level_filter, 'é”™è¯¯'); ?>>âŒ é”™è¯¯</option>
                        <option value="è­¦å‘Š" <?php selected($level_filter, 'è­¦å‘Š'); ?>>âš ï¸ è­¦å‘Š</option>
                        <option value="æˆåŠŸ" <?php selected($level_filter, 'æˆåŠŸ'); ?>>âœ… æˆåŠŸ</option>
                        <option value="ä¿¡æ¯" <?php selected($level_filter, 'ä¿¡æ¯'); ?>>â„¹ï¸ ä¿¡æ¯</option>
                        <option value="è°ƒè¯•" <?php selected($level_filter, 'è°ƒè¯•'); ?>>ğŸ”§ è°ƒè¯•</option>
                    </select>

                    <select name="operation_filter" class="operation-filter" style="min-width: 150px;">
                        <option value="">æ‰€æœ‰æ“ä½œç±»å‹</option>
                        <option value="æ‰¹é‡åº“å­˜åŒæ­¥" <?php selected($operation_filter, 'æ‰¹é‡åº“å­˜åŒæ­¥'); ?>>ğŸš€ æ‰¹é‡åº“å­˜åŒæ­¥</option>
                        <option value="å•ä¸ªåº“å­˜åŒæ­¥" <?php selected($operation_filter, 'å•ä¸ªåº“å­˜åŒæ­¥'); ?>>ğŸ”„ å•ä¸ªåº“å­˜åŒæ­¥</option>
                        <option value="å•†å“åŒæ­¥" <?php selected($operation_filter, 'å•†å“åŒæ­¥'); ?>>ğŸ“¦ å•†å“åŒæ­¥</option>
                        <option value="ä»·æ ¼åŒæ­¥" <?php selected($operation_filter, 'ä»·æ ¼åŒæ­¥'); ?>>ğŸ’° ä»·æ ¼åŒæ­¥</option>
                        <option value="APIè°ƒç”¨" <?php selected($operation_filter, 'APIè°ƒç”¨'); ?>>ğŸ”— APIè°ƒç”¨</option>
                        <option value="Feedå¤„ç†" <?php selected($operation_filter, 'Feedå¤„ç†'); ?>>ğŸ“‹ Feedå¤„ç†</option>
                        <?php foreach ($operation_types as $op_type): ?>
                            <?php if (!in_array($op_type, ['æ‰¹é‡åº“å­˜åŒæ­¥', 'å•ä¸ªåº“å­˜åŒæ­¥', 'å•†å“åŒæ­¥', 'ä»·æ ¼åŒæ­¥', 'APIè°ƒç”¨', 'Feedå¤„ç†'])): ?>
                                <option value="<?php echo esc_attr($op_type); ?>" <?php selected($operation_filter, $op_type); ?>>
                                    <?php echo esc_html($op_type); ?>
                                </option>
                            <?php endif; ?>
                        <?php endforeach; ?>
                    </select>

                    <input type="date" name="date_filter" value="<?php echo esc_attr($date_filter); ?>"
                           placeholder="é€‰æ‹©æ—¥æœŸ" class="date-filter" style="min-width: 150px;">

                    <input type="text" name="sku_filter" value="<?php echo esc_attr($sku_filter); ?>"
                           placeholder="è¾“å…¥SKU" class="sku-filter" style="min-width: 150px;">

                    <button type="submit" class="button button-primary">ğŸ” ç­›é€‰</button>

                    <?php if (!empty($level_filter) || !empty($operation_filter) || !empty($date_filter) || !empty($sku_filter)): ?>
                        <a href="<?php echo admin_url('admin.php?page=woo-walmart-sync-logs'); ?>"
                           class="button button-secondary">æ¸…é™¤ç­›é€‰</a>
                    <?php endif; ?>
                </div>
            </form>
        </div>

        <!-- æ‰¹é‡æ“ä½œ -->
        <?php if (!empty($logs)): ?>
        <form method="post" id="logs-form">
            <?php wp_nonce_field('walmart_logs_action'); ?>

            <div class="walmart-bulk-actions" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <select name="action" id="bulk-action">
                    <option value="">æ‰¹é‡æ“ä½œ</option>
                    <option value="delete_logs">åˆ é™¤é€‰ä¸­</option>
                </select>
                <button type="submit" class="button button-secondary"
                        onclick="return confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼');">æ‰§è¡Œ</button>

                <button type="submit" name="action" value="clear_old_logs"
                        class="button button-secondary"
                        onclick="return confirm('ç¡®å®šè¦æ¸…é™¤7å¤©å‰çš„æ—§æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼');">
                    æ¸…é™¤æ—§æ—¥å¿—
                </button>

                <button type="submit" name="action" value="clear_debug_logs"
                        class="button button-secondary"
                        onclick="return confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è°ƒè¯•æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼');">
                    æ¸…é™¤è°ƒè¯•æ—¥å¿—
                </button>

                <button type="submit" name="action" value="clear_all_logs"
                        class="button button-secondary"
                        onclick="return confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼');">
                    æ¸…é™¤æ‰€æœ‰æ—¥å¿—
                </button>
            </div>

            <!-- æ—¥å¿—åˆ—è¡¨ -->
            <div class="walmart-logs-table" style="background: #fff; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                <table class="widefat striped" style="margin: 0;">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all-logs">
                            </th>
                            <th style="width: 120px;">æ—¶é—´</th>
                            <th style="width: 60px;">çº§åˆ«</th>
                            <th style="width: 150px;">æ“ä½œç±»å‹</th>
                            <th style="width: 80px;">å¤„ç†æ–¹å¼</th>
                            <th style="width: 200px;">æ¶ˆæ¯</th>
                            <th style="width: 300px;">è¯·æ±‚æ•°æ®</th>
                            <th style="width: 300px;">å“åº”æ•°æ®</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($logs as $log): ?>
                        <?php
                        // æ ¹æ®è¡¨ç»“æ„è·å–å­—æ®µå€¼
                        $level = ($table_name == $old_table) ? $log->status : $log->level;
                        $operation = ($table_name == $old_table) ? $log->action : $log->operation;
                        $message = isset($log->message) ? $log->message : '';
                        $product_id = isset($log->product_id) ? $log->product_id : '';
                        ?>
                        <tr class="log-level-<?php echo strtolower($level ?: 'unknown'); ?>">
                            <td>
                                <input type="checkbox" name="log_ids[]" value="<?php echo $log->id; ?>">
                            </td>
                            <td style="font-size: 11px;">
                                <?php echo date('m-d H:i:s', strtotime($log->created_at)); ?>
                            </td>
                            <td>
                                <?php
                                $level_icons = [
                                    'é”™è¯¯' => 'âŒ',
                                    'è­¦å‘Š' => 'âš ï¸',
                                    'æˆåŠŸ' => 'âœ…',
                                    'ä¿¡æ¯' => 'â„¹ï¸',
                                    'è°ƒè¯•' => 'ğŸ”§'
                                ];
                                $level_colors = [
                                    'é”™è¯¯' => '#d63638',
                                    'è­¦å‘Š' => '#f56e28',
                                    'æˆåŠŸ' => '#00a32a',
                                    'ä¿¡æ¯' => '#2271b1',
                                    'è°ƒè¯•' => '#646970'
                                ];
                                $icon = isset($level_icons[$level]) ? $level_icons[$level] : 'ğŸ“';
                                $color = isset($level_colors[$level]) ? $level_colors[$level] : '#646970';
                                ?>
                                <span style="color: <?php echo $color; ?>; font-weight: bold; font-size: 12px;">
                                    <?php echo $icon; ?> <?php echo esc_html($level); ?>
                                </span>
                            </td>
                            <td>
                                <code style="font-size: 11px; background: #f0f0f1; padding: 2px 4px; border-radius: 2px;">
                                    <?php echo esc_html($operation); ?>
                                </code>
                            </td>
                            <td>
                                <?php if (strpos($operation, 'æ‰¹é‡åº“å­˜åŒæ­¥-APIå¤„ç†') !== false): ?>
                                    <span style="color: #00a32a; font-weight: bold; font-size: 11px;">ğŸš€ æ‰¹é‡API</span>
                                <?php elseif (strpos($operation, 'æ‰¹é‡åº“å­˜åŒæ­¥-æ‰¹æ¬¡') !== false): ?>
                                    <span style="color: #2271b1; font-weight: bold; font-size: 11px;">ğŸ“¦ æ‰¹æ¬¡å¤„ç†</span>
                                <?php elseif (strpos($operation, 'æ‰¹é‡åº“å­˜åŒæ­¥') !== false): ?>
                                    <span style="color: #f56e28; font-weight: bold; font-size: 11px;">âš¡ æ‰¹é‡æ¨¡å¼</span>
                                <?php elseif (strpos($operation, 'å•ä¸ª') !== false): ?>
                                    <span style="color: #d63638; font-weight: bold; font-size: 11px;">ğŸ”„ å•ä¸ªæ¨¡å¼</span>
                                <?php else: ?>
                                    <span style="color: #646970; font-size: 11px;">-</span>
                                <?php endif; ?>
                            </td>
                            <td style="font-size: 12px; max-width: 200px; word-wrap: break-word;">
                                <?php echo esc_html($message); ?>
                                <?php if ($product_id): ?>
                                    <br><small style="color: #646970;">å•†å“ID: <?php echo esc_html($product_id); ?></small>
                                <?php endif; ?>
                            </td>
                            <td style="max-width: 300px; word-wrap: break-word; font-size: 11px;">
                                <?php
                                if ($table_name == $old_table && !empty($log->request)) {
                                    $request_data = json_decode($log->request, true);
                                    if ($request_data) {
                                        echo '<pre style="margin: 0; font-size: 10px; max-height: 100px; overflow-y: auto; background: #f9f9f9; padding: 5px; border-radius: 3px;">' . esc_html(print_r($request_data, true)) . '</pre>';
                                    } else {
                                        echo '<span style="color: #646970;">-</span>';
                                    }
                                } elseif ($table_name == $logs_table && !empty($log->request_data)) {
                                    $request_data = json_decode($log->request_data, true);
                                    if ($request_data) {
                                        echo '<pre style="margin: 0; font-size: 10px; max-height: 100px; overflow-y: auto; background: #f9f9f9; padding: 5px; border-radius: 3px;">' . esc_html(print_r($request_data, true)) . '</pre>';
                                    } else {
                                        echo '<span style="color: #646970;">-</span>';
                                    }
                                } else {
                                    echo '<span style="color: #646970;">-</span>';
                                }
                                ?>
                            </td>
                            <td style="max-width: 300px; word-wrap: break-word; font-size: 11px;">
                                <?php
                                if ($table_name == $old_table && !empty($log->response)) {
                                    $response_data = json_decode($log->response, true);
                                    if ($response_data) {
                                        echo '<pre style="margin: 0; font-size: 10px; max-height: 100px; overflow-y: auto; background: #f9f9f9; padding: 5px; border-radius: 3px;">' . esc_html(print_r($response_data, true)) . '</pre>';
                                    } else {
                                        echo '<span style="color: #646970;">-</span>';
                                    }
                                } elseif ($table_name == $logs_table && !empty($log->response_data)) {
                                    $response_data = json_decode($log->response_data, true);
                                    if ($response_data) {
                                        echo '<pre style="margin: 0; font-size: 10px; max-height: 100px; overflow-y: auto; background: #f9f9f9; padding: 5px; border-radius: 3px;">' . esc_html(print_r($response_data, true)) . '</pre>';
                                    } else {
                                        echo '<span style="color: #646970;">-</span>';
                                    }
                                } else {
                                    echo '<span style="color: #646970;">-</span>';
                                }
                                ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </form>

        <!-- åˆ†é¡µ -->
        <?php if ($total_pages > 1): ?>
        <div class="walmart-pagination" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin: 20px 0; text-align: center;">
            <div class="pagination-info" style="margin-bottom: 10px; color: #646970; font-size: 13px;">
                æ˜¾ç¤ºç¬¬ <?php echo $offset + 1; ?> - <?php echo min($offset + $per_page, $total_items); ?> æ¡ï¼Œ
                å…± <?php echo $total_items; ?> æ¡æ—¥å¿—
            </div>
            <?php
            $pagination_args = [
                'base' => add_query_arg('paged', '%#%'),
                'format' => '',
                'current' => $current_page,
                'total' => $total_pages,
                'prev_text' => 'â€¹ ä¸Šä¸€é¡µ',
                'next_text' => 'ä¸‹ä¸€é¡µ â€º'
            ];
            echo paginate_links($pagination_args);
            ?>
        </div>
        <?php endif; ?>

        <?php else: ?>
        <div class="walmart-empty-state" style="background: #fff; padding: 40px; border: 1px solid #ddd; border-radius: 4px; text-align: center; margin: 20px 0;">
            <h3>ğŸ“‹ æš‚æ— æ—¥å¿—</h3>
            <p>å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—è®°å½•ã€‚</p>
        </div>
        <?php endif; ?>

        <!-- è¯´æ˜é¢æ¿ -->
        <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
            <h3>ğŸ” å¦‚ä½•è¯†åˆ«å¤„ç†æ–¹å¼</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <div>
                    <h4>æ‰¹é‡APIæ¨¡å¼æ ‡è¯†ï¼š</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><span style="color: #00a32a; font-weight: bold;">ğŸš€ æ‰¹é‡API</span>ï¼šä½¿ç”¨Walmartæ‰¹é‡API</li>
                        <li><span style="color: #2271b1; font-weight: bold;">ğŸ“¦ æ‰¹æ¬¡å¤„ç†</span>ï¼šæ‰¹é‡APIçš„åˆ†æ‰¹å¤„ç†</li>
                        <li><span style="color: #f56e28; font-weight: bold;">âš¡ æ‰¹é‡æ¨¡å¼</span>ï¼šæ‰¹é‡æ“ä½œæ€»ä½“æ—¥å¿—</li>
                    </ul>
                </div>
                <div>
                    <h4>å•ä¸ªAPIæ¨¡å¼æ ‡è¯†ï¼š</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><span style="color: #d63638; font-weight: bold;">ğŸ”„ å•ä¸ªæ¨¡å¼</span>ï¼šå•ä¸ªå•†å“é€ä¸€å¤„ç†</li>
                        <li>æ“ä½œç±»å‹åŒ…å«"å•ä¸ª"å­—æ ·</li>
                        <li>æ²¡æœ‰æ‰¹æ¬¡ç›¸å…³çš„æ—¥å¿—</li>
                    </ul>
                </div>
            </div>

            <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px;">
                <strong>ğŸ’¡ å¿«é€Ÿåˆ¤æ–­æŠ€å·§ï¼š</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>ç­›é€‰"æ‰¹é‡åº“å­˜åŒæ­¥"æ“ä½œç±»å‹ï¼Œçœ‹åˆ°"APIå¤„ç†å¼€å§‹"å’Œ"å…±Xä¸ªæ‰¹æ¬¡" = <strong>æ‰¹é‡APIæ¨¡å¼</strong></li>
                    <li>çœ‹åˆ°"æ‰¹æ¬¡Xå¤„ç†å®Œæˆ" = <strong>ç¡®è®¤ä½¿ç”¨æ‰¹é‡API</strong></li>
                    <li>åªçœ‹åˆ°"å¼€å§‹åŒæ­¥å•†å“XXXçš„åº“å­˜"ä¸”æ²¡æœ‰æ‰¹æ¬¡ä¿¡æ¯ = <strong>å•ä¸ªAPIæ¨¡å¼</strong></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
    // å…¨é€‰åŠŸèƒ½
    document.getElementById('select-all-logs').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="log_ids[]"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // åˆ‡æ¢è¯¦æƒ…æ˜¾ç¤º
    function toggleLogDetails(logId) {
        const details = document.getElementById('log-details-' + logId);
        if (details.style.display === 'none') {
            details.style.display = 'block';
        } else {
            details.style.display = 'none';
        }
    }
    </script>

    <style>
    .walmart-logs .log-level-é”™è¯¯ {
        background-color: #fef2f2;
    }

    .walmart-logs .log-level-è­¦å‘Š {
        background-color: #fef3e2;
    }

    .walmart-logs .log-level-æˆåŠŸ {
        background-color: #f0f9f4;
    }

    .walmart-logs .log-level-è°ƒè¯• {
        background-color: #f8f9fa;
    }
    </style>
    <?php
}



// åœ¨äº§å“åˆ—è¡¨é¡µæ·»åŠ è‡ªå®šä¹‰åˆ—
add_filter('manage_edit-product_columns', 'add_walmart_sync_column');
function add_walmart_sync_column($columns) {
    $columns['walmart_sync'] = 'Walmart åŒæ­¥';
    return $columns;
}

// æ·»åŠ æ²ƒå°”ç›åŒæ­¥çŠ¶æ€ç­›é€‰ä¸‹æ‹‰èœå•
add_action('restrict_manage_posts', 'add_walmart_sync_filter');
function add_walmart_sync_filter() {
    global $typenow;

    if ($typenow === 'product') {
        $selected = isset($_GET['walmart_sync_filter']) ? $_GET['walmart_sync_filter'] : '';

        echo '<select name="walmart_sync_filter" id="walmart_sync_filter" style="margin-left: 10px;">';
        echo '<option value="">æ²ƒå°”ç›åŒæ­¥çŠ¶æ€</option>';
        echo '<option value="synced"' . selected($selected, 'synced', false) . '>å·²åŒæ­¥</option>';
        echo '<option value="not_synced"' . selected($selected, 'not_synced', false) . '>æœªåŒæ­¥</option>';
        echo '<option value="processing"' . selected($selected, 'processing', false) . '>å¤„ç†ä¸­</option>';
        echo '<option value="failed"' . selected($selected, 'failed', false) . '>åŒæ­¥å¤±è´¥</option>';
        echo '</select>';
    }
}

// å¤„ç†æ²ƒå°”ç›åŒæ­¥çŠ¶æ€ç­›é€‰
add_filter('parse_query', 'filter_products_by_walmart_sync_status');
function filter_products_by_walmart_sync_status($query) {
    global $pagenow, $typenow, $wpdb;

    if ($pagenow === 'edit.php' && $typenow === 'product' && isset($_GET['walmart_sync_filter']) && !empty($_GET['walmart_sync_filter'])) {
        $filter_value = $_GET['walmart_sync_filter'];
        $feeds_table = $wpdb->prefix . 'walmart_feeds';

        // æ ¹æ®ç­›é€‰æ¡ä»¶æ„å»ºå­æŸ¥è¯¢
        switch ($filter_value) {
            case 'synced':
                // å·²åŒæ­¥ï¼šåŒ…å«Feedä¸­PROCESSEDçŠ¶æ€çš„äº§å“å’Œæ‰‹åŠ¨æ ‡è®°ä¸ºå·²åŒæ­¥çš„äº§å“
                $feed_synced_query = "
                    SELECT f1.product_id
                    FROM {$feeds_table} f1
                    INNER JOIN (
                        SELECT product_id, MAX(id) as max_id
                        FROM {$feeds_table}
                        GROUP BY product_id
                    ) f2 ON f1.product_id = f2.product_id AND f1.id = f2.max_id
                    WHERE f1.status = 'PROCESSED'
                ";
                $feed_synced_ids = $wpdb->get_col($feed_synced_query);

                // è·å–æ‰‹åŠ¨æ ‡è®°ä¸ºå·²åŒæ­¥çš„äº§å“
                $manual_synced_ids = $wpdb->get_col("
                    SELECT post_id FROM {$wpdb->postmeta}
                    WHERE meta_key = '_walmart_sync_manual_status'
                    AND meta_value = 'synced'
                ");

                // åˆå¹¶ä¸¤ä¸ªåˆ—è¡¨
                $all_synced_ids = array_unique(array_merge($feed_synced_ids, $manual_synced_ids));
                $query->set('post__in', !empty($all_synced_ids) ? $all_synced_ids : [0]);
                break;

            case 'not_synced':
                // æœªåŒæ­¥ï¼šæ²¡æœ‰Feedè®°å½•ä¸”æ²¡æœ‰æ‰‹åŠ¨æ ‡è®°ä¸ºå·²åŒæ­¥çš„äº§å“ï¼Œæˆ–æ‰‹åŠ¨æ ‡è®°ä¸ºæœªåŒæ­¥çš„äº§å“
                $has_feed_ids = $wpdb->get_col("SELECT DISTINCT product_id FROM {$feeds_table}");
                $manual_synced_ids = $wpdb->get_col("
                    SELECT post_id FROM {$wpdb->postmeta}
                    WHERE meta_key = '_walmart_sync_manual_status'
                    AND meta_value = 'synced'
                ");
                $manual_not_synced_ids = $wpdb->get_col("
                    SELECT post_id FROM {$wpdb->postmeta}
                    WHERE meta_key = '_walmart_sync_manual_status'
                    AND meta_value = 'not_synced'
                ");

                // æ’é™¤æœ‰Feedè®°å½•æˆ–æ‰‹åŠ¨æ ‡è®°ä¸ºå·²åŒæ­¥çš„äº§å“ï¼Œä½†åŒ…å«æ‰‹åŠ¨æ ‡è®°ä¸ºæœªåŒæ­¥çš„äº§å“
                $exclude_ids = array_unique(array_merge($has_feed_ids, $manual_synced_ids));
                $exclude_ids = array_diff($exclude_ids, $manual_not_synced_ids); // ä¸æ’é™¤æ‰‹åŠ¨æ ‡è®°ä¸ºæœªåŒæ­¥çš„

                if (!empty($exclude_ids)) {
                    $query->set('post__not_in', $exclude_ids);
                }

                // å¦‚æœæœ‰æ‰‹åŠ¨æ ‡è®°ä¸ºæœªåŒæ­¥çš„äº§å“ï¼Œç¡®ä¿å®ƒä»¬è¢«åŒ…å«
                if (!empty($manual_not_synced_ids)) {
                    $current_post_in = $query->get('post__in');
                    if (empty($current_post_in)) {
                        // è·å–æ‰€æœ‰äº§å“IDï¼Œç„¶åæ’é™¤ä¸éœ€è¦çš„
                        $all_product_ids = $wpdb->get_col("
                            SELECT ID FROM {$wpdb->posts}
                            WHERE post_type = 'product' AND post_status = 'publish'
                        ");
                        $include_ids = array_diff($all_product_ids, $exclude_ids);
                        $include_ids = array_unique(array_merge($include_ids, $manual_not_synced_ids));
                        $query->set('post__in', $include_ids);
                        $query->set('post__not_in', []); // æ¸…é™¤not_inï¼Œå› ä¸ºæˆ‘ä»¬ç”¨post__inäº†
                    }
                }
                break;

            case 'processing':
                // å¤„ç†ä¸­ï¼šæœ€æ–°çŠ¶æ€ä¸ºSUBMITTEDã€INPROGRESSæˆ–PROCESSING
                $subquery = "
                    SELECT f1.product_id
                    FROM {$feeds_table} f1
                    INNER JOIN (
                        SELECT product_id, MAX(id) as max_id
                        FROM {$feeds_table}
                        GROUP BY product_id
                    ) f2 ON f1.product_id = f2.product_id AND f1.id = f2.max_id
                    WHERE f1.status IN ('SUBMITTED', 'INPROGRESS', 'PROCESSING')
                ";
                $product_ids = $wpdb->get_col($subquery);
                $query->set('post__in', !empty($product_ids) ? $product_ids : [0]);
                break;

            case 'failed':
                // åŒæ­¥å¤±è´¥ï¼šæœ€æ–°çŠ¶æ€ä¸ºERROR
                $subquery = "
                    SELECT f1.product_id
                    FROM {$feeds_table} f1
                    INNER JOIN (
                        SELECT product_id, MAX(id) as max_id
                        FROM {$feeds_table}
                        GROUP BY product_id
                    ) f2 ON f1.product_id = f2.product_id AND f1.id = f2.max_id
                    WHERE f1.status = 'ERROR'
                ";
                $product_ids = $wpdb->get_col($subquery);
                $query->set('post__in', !empty($product_ids) ? $product_ids : [0]);
                break;
        }
    }
}

// è·å–äº§å“çš„æ²ƒå°”ç›åŒæ­¥çŠ¶æ€ï¼ˆæ”¹è¿›ç‰ˆï¼‰
function get_product_walmart_sync_status($product_id) {
    global $wpdb;
    $feeds_table = $wpdb->prefix . 'walmart_feeds';
    $batch_items_table = $wpdb->prefix . 'walmart_batch_items';

    // æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨æ ‡è®°çš„çŠ¶æ€
    $manual_status = get_post_meta($product_id, '_walmart_sync_manual_status', true);
    if ($manual_status === 'synced') {
        return [
            'status' => 'manual_synced',
            'display_text' => 'å·²æ ‡è®°',
            'color' => '#5cb85c',
            'details' => 'æ‰‹åŠ¨æ ‡è®°ä¸ºå·²åŒæ­¥'
        ];
    } elseif ($manual_status === 'not_synced') {
        return [
            'status' => 'manual_not_synced',
            'display_text' => 'æœªæ ‡è®°',
            'color' => '#999',
            'details' => 'æ‰‹åŠ¨æ ‡è®°ä¸ºæœªåŒæ­¥'
        ];
    }

    // æ£€æŸ¥æœ€æ–°çš„FeedçŠ¶æ€
    $last_feed = $wpdb->get_row($wpdb->prepare(
        "SELECT status, created_at FROM $feeds_table WHERE product_id = %d ORDER BY id DESC LIMIT 1",
        $product_id
    ));

    if (!$last_feed) {
        return [
            'status' => 'never_synced',
            'display_text' => 'æœªåŒæ­¥',
            'color' => '#999',
            'details' => 'ä»æœªåŒæ­¥è¿‡'
        ];
    }

    // æ£€æŸ¥æ‰¹æ¬¡åŒæ­¥çŠ¶æ€
    $batch_status = $wpdb->get_row($wpdb->prepare(
        "SELECT bi.status, bi.error_message, bf.success_count, bf.failed_count
         FROM $batch_items_table bi
         LEFT JOIN {$wpdb->prefix}walmart_batch_feeds bf ON bi.batch_id = bf.batch_id
         WHERE bi.product_id = %d
         ORDER BY bi.id DESC LIMIT 1",
        $product_id
    ));

    // æ ¹æ®çŠ¶æ€è¿”å›ç›¸åº”ä¿¡æ¯
    switch ($last_feed->status) {
        case 'SUBMITTED':
        case 'INPROGRESS':
        case 'PROCESSING':
            return [
                'status' => 'processing',
                'display_text' => 'å¤„ç†ä¸­...',
                'color' => '#f0ad4e',
                'details' => 'æ­£åœ¨å¤„ç†ä¸­'
            ];

        case 'PROCESSED':
            if ($batch_status && $batch_status->status === 'SUCCESS') {
                return [
                    'status' => 'success',
                    'display_text' => 'æˆåŠŸ',
                    'color' => '#5cb85c',
                    'details' => 'åŒæ­¥æˆåŠŸ'
                ];
            } else {
                return [
                    'status' => 'completed',
                    'display_text' => 'å·²å¤„ç†',
                    'color' => '#5cb85c',
                    'details' => 'Feedå·²å¤„ç†'
                ];
            }

        case 'ERROR':
            return [
                'status' => 'error',
                'display_text' => 'å¤±è´¥',
                'color' => '#d9534f',
                'details' => $batch_status->error_message ?? 'åŒæ­¥å¤±è´¥'
            ];

        default:
            return [
                'status' => 'unknown',
                'display_text' => 'æœªçŸ¥',
                'color' => '#999',
                'details' => 'çŠ¶æ€æœªçŸ¥'
            ];
    }
}

add_action('manage_product_posts_custom_column', 'display_walmart_sync_column', 10, 2);
function display_walmart_sync_column($column, $post_id) {
    if ($column === 'walmart_sync') {
        // ä½¿ç”¨æ”¹è¿›çš„çŠ¶æ€æ£€æµ‹
        $sync_status = get_product_walmart_sync_status($post_id);

        echo '<div id="walmart-sync-status-' . esc_attr($post_id) . '" style="color:' . esc_attr($sync_status['color']) . '; font-weight: bold;" title="' . esc_attr($sync_status['details']) . '">' . esc_html($sync_status['display_text']) . '</div>';
        echo '<div style="margin-top: 5px;">';
        echo '<button class="button walmart-sync-button" data-product-id="' . esc_attr($post_id) . '" style="font-size: 11px; padding: 2px 6px;">åŒæ­¥</button>';
        echo '<button class="button button-secondary walmart-test-button" data-product-id="' . esc_attr($post_id) . '" style="margin-left: 3px; font-size: 11px; padding: 2px 6px;">æµ‹è¯•</button>';
        echo '</div>';
    }
}

// ä¸ºäº§å“åˆ—è¡¨é¡µæ·»åŠ JSå’ŒCSS
add_action('admin_enqueue_scripts', function($hook) {
    if ('edit.php' !== $hook || get_post_type() !== 'product') {
        return;
    }

    // ç¡®ä¿jQueryå·²åŠ è½½
    wp_enqueue_script('jquery');

    // æ·»åŠ ç­›é€‰å™¨æ ·å¼
    wp_add_inline_style('wp-admin', '
        #walmart_sync_filter {
            margin-left: 10px;
            padding: 4px 8px;
            border: 1px solid #8c8f94;
            border-radius: 3px;
            background: #fff;
            font-size: 13px;
            min-width: 140px;
        }
        #walmart_sync_filter:focus {
            border-color: #2271b1;
            box-shadow: 0 0 0 1px #2271b1;
            outline: 2px solid transparent;
        }
        .tablenav.top .actions {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
    ');

    // åˆ›å»ºnonceå€¼
    $sync_nonce = wp_create_nonce('walmart_sync_nonce');
    $test_nonce = wp_create_nonce('walmart_test_nonce');

    // æ·»åŠ JavaScriptä»£ç 
    $script = "
    jQuery(document).ready(function($) {
        console.log('Walmart Sync: JavaScript loaded');

        // åŒæ­¥æŒ‰é’®å¤„ç†
        $('.walmart-sync-button').on('click', function(e) {
            e.preventDefault();
            var button = $(this);
            var productId = button.data('product-id');
            var statusDiv = $('#walmart-sync-status-' + productId);

            console.log('Walmart Sync: Button clicked for product ID:', productId);

            button.prop('disabled', true).text('åŒæ­¥ä¸­...');
            statusDiv.css('color', '#f0ad4e').text('è¯·æ±‚ä¸­...');

            var ajaxData = {
                action: 'walmart_sync_product',
                product_id: productId,
                nonce: '{$sync_nonce}'
            };

            console.log('Walmart Sync: Sending AJAX request with data:', ajaxData);

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: ajaxData,
                dataType: 'json',
                timeout: 30000,
                success: function(response) {
                    console.log('Walmart Sync: AJAX success response:', response);

                    if (response && response.success) {
                        statusDiv.css('color', '#f0ad4e').text('å¤„ç†ä¸­...');
                        button.text('é‡æ–°åŒæ­¥');

                        var message = response.data && response.data.message ? response.data.message : 'åŒæ­¥è¯·æ±‚å·²æäº¤';
                        alert('æˆåŠŸ: ' + message);
                    } else {
                        statusDiv.css('color', '#d9534f').text('è¯·æ±‚å¤±è´¥');
                        var errorMsg = response && response.data && response.data.message ? response.data.message : 'æœªçŸ¥é”™è¯¯';
                        alert('é”™è¯¯: ' + errorMsg);
                        button.text('é‡æ–°åŒæ­¥');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Walmart Sync: AJAX error:', {xhr: xhr, status: status, error: error});

                    statusDiv.css('color', '#d9534f').text('AJAXé”™è¯¯');

                    var errorMessage = 'AJAXè¯·æ±‚å¤±è´¥';
                    if (status === 'timeout') {
                        errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
                    } else if (xhr.responseText) {
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            if (errorResponse.data && errorResponse.data.message) {
                                errorMessage = errorResponse.data.message;
                            }
                        } catch (e) {
                            errorMessage = 'æœåŠ¡å™¨å“åº”é”™è¯¯: ' + xhr.status;
                        }
                    }

                    alert('é”™è¯¯: ' + errorMessage);
                    button.text('é‡æ–°åŒæ­¥');
                },
                complete: function() {
                    button.prop('disabled', false);
                    console.log('Walmart Sync: AJAX request completed');
                }
            });
        });

        // æµ‹è¯•æŒ‰é’®å¤„ç†
        $('.walmart-test-button').on('click', function(e) {
            e.preventDefault();
            var button = $(this);
            var productId = button.data('product-id');

            console.log('Walmart Test: Button clicked for product ID:', productId);

            button.prop('disabled', true).text('æµ‹è¯•ä¸­...');

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'walmart_test_ajax',
                    product_id: productId,
                    nonce: '{$test_nonce}'
                },
                dataType: 'json',
                success: function(response) {
                    console.log('Walmart Test: AJAX success response:', response);
                    if (response && response.success) {
                        alert('æµ‹è¯•æˆåŠŸ: ' + response.data.message);
                    } else {
                        alert('æµ‹è¯•å¤±è´¥: ' + (response.data ? response.data.message : 'æœªçŸ¥é”™è¯¯'));
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Walmart Test: AJAX error:', {xhr: xhr, status: status, error: error});
                    alert('æµ‹è¯•AJAXé”™è¯¯: ' + error);
                },
                complete: function() {
                    button.prop('disabled', false).text('æµ‹è¯•');
                }
            });
        });
    });
    ";

    // æ·»åŠ å†…è”è„šæœ¬
    wp_add_inline_script('jquery', $script);
});

// æ³¨å†ŒAJAX action
add_action('wp_ajax_walmart_sync_product', 'handle_walmart_sync_product_ajax');

function handle_walmart_sync_product_ajax() {
    // æ·»åŠ è°ƒè¯•æ—¥å¿—
    try {
        woo_walmart_sync_log('AJAXå¤„ç†-å¼€å§‹', 'è°ƒè¯•', $_POST, 'æ”¶åˆ°AJAXè¯·æ±‚');
    } catch (Exception $e) {
        // å¦‚æœæ—¥å¿—è®°å½•å¤±è´¥ï¼Œç›´æ¥è¿”å›é”™è¯¯
        wp_send_json_error(['message' => 'æ—¥å¿—ç³»ç»Ÿé”™è¯¯: ' . $e->getMessage()]);
        return;
    }

    // æ£€æŸ¥å¿…è¦å‚æ•°
    if (!isset($_POST['product_id'])) {
        woo_walmart_sync_log('AJAXå¤„ç†-å‚æ•°ç¼ºå¤±', 'é”™è¯¯', $_POST, 'ç¼ºå°‘product_idå‚æ•°');
        wp_send_json_error(['message' => 'ç¼ºå°‘äº§å“IDå‚æ•°']);
        return;
    }

    $product_id = intval($_POST['product_id']);

    try {
        // ç¡®ä¿ç±»æ–‡ä»¶å·²åŠ è½½
        if (!class_exists('Woo_Walmart_Product_Sync')) {
            $class_file = WOO_WALMART_SYNC_PATH . 'includes/class-product-sync.php';
            if (!file_exists($class_file)) {
                woo_walmart_sync_log('AJAXå¤„ç†-æ–‡ä»¶ä¸å­˜åœ¨', 'é”™è¯¯', $_POST, 'ç±»æ–‡ä»¶ä¸å­˜åœ¨: ' . $class_file);
                wp_send_json_error(['message' => 'åŒæ­¥ç±»æ–‡ä»¶ä¸å­˜åœ¨']);
                return;
            }
            require_once $class_file;
        }

        woo_walmart_sync_log('AJAXå¤„ç†-ç±»åŠ è½½å®Œæˆ', 'è°ƒè¯•', $_POST, 'Woo_Walmart_Product_Syncç±»å·²åŠ è½½');

        if (!class_exists('Woo_Walmart_Product_Sync')) {
            woo_walmart_sync_log('AJAXå¤„ç†-ç±»ä¸å­˜åœ¨', 'é”™è¯¯', $_POST, 'ç±»åŠ è½½åä»ä¸å­˜åœ¨');
            wp_send_json_error(['message' => 'åŒæ­¥ç±»åŠ è½½å¤±è´¥']);
            return;
        }

        $sync = new Woo_Walmart_Product_Sync();

        // ä¸´æ—¶è·³è¿‡nonceéªŒè¯ï¼Œç›´æ¥è°ƒç”¨åŒæ­¥é€»è¾‘
        $result = $sync->initiate_sync($product_id);

        woo_walmart_sync_log('AJAXå¤„ç†-åŒæ­¥å®Œæˆ', 'è°ƒè¯•', $_POST, $result);

        if ($result['success']) {
            wp_send_json_success(['message' => $result['message']]);
        } else {
            wp_send_json_error(['message' => $result['message']]);
        }

    } catch (Exception $e) {
        woo_walmart_sync_log('AJAXå¤„ç†-å¼‚å¸¸', 'é”™è¯¯', $_POST, $e->getMessage());
        wp_send_json_error(['message' => 'AJAXå¤„ç†å¼‚å¸¸: ' . $e->getMessage()]);
    } catch (Error $e) {
        woo_walmart_sync_log('AJAXå¤„ç†-è‡´å‘½é”™è¯¯', 'é”™è¯¯', $_POST, $e->getMessage());
        wp_send_json_error(['message' => 'AJAXå¤„ç†è‡´å‘½é”™è¯¯: ' . $e->getMessage()]);
    }
}

// æµ‹è¯•AJAXç«¯ç‚¹
add_action('wp_ajax_walmart_test_ajax', 'handle_walmart_test_ajax');

function handle_walmart_test_ajax() {
    global $wpdb;

    // ç®€å•çš„æµ‹è¯•ï¼Œä¸éªŒè¯nonceï¼Œç¡®ä¿åŸºæœ¬åŠŸèƒ½å·¥ä½œ
    $product_id = isset($_POST['product_id']) ? intval($_POST['product_id']) : 0;

    // æ£€æŸ¥æ•°æ®åº“è¡¨
    $tables_status = [];
    $required_tables = [
        'woo_walmart_sync_logs',
        'walmart_category_map',
        'walmart_upc_pool',
        'walmart_feeds'
    ];

    foreach ($required_tables as $table) {
        $full_table_name = $wpdb->prefix . $table;
        $exists = $wpdb->get_var("SHOW TABLES LIKE '$full_table_name'") == $full_table_name;
        $tables_status[$table] = $exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨';
    }

    // å°è¯•è®°å½•æµ‹è¯•æ—¥å¿—
    try {
        woo_walmart_sync_log('AJAXæµ‹è¯•', 'æˆåŠŸ', $_POST, 'æµ‹è¯•AJAXåŠŸèƒ½æ­£å¸¸', $product_id);
        $log_status = 'æ—¥å¿—è®°å½•æˆåŠŸ';
    } catch (Exception $e) {
        $log_status = 'æ—¥å¿—è®°å½•å¤±è´¥: ' . $e->getMessage();
    }

    // æ£€æŸ¥ç±»æ–‡ä»¶
    $class_files_status = [];
    $required_classes = [
        'class-product-sync.php',
        'class-api-auth.php',
        'class-product-mapper.php'
    ];

    foreach ($required_classes as $file) {
        $file_path = WOO_WALMART_SYNC_PATH . 'includes/' . $file;
        $class_files_status[$file] = file_exists($file_path) ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨';
    }

    wp_send_json_success([
        'message' => 'AJAXåŠŸèƒ½æ­£å¸¸ï¼Œäº§å“ID: ' . $product_id,
        'timestamp' => current_time('mysql'),
        'log_status' => $log_status,
        'tables_status' => $tables_status,
        'class_files_status' => $class_files_status,
        'plugin_path' => WOO_WALMART_SYNC_PATH,
        'post_data' => $_POST
    ]);
}

// AJAX action for clearing category attributes
add_action('wp_ajax_clear_category_attributes', function() {
    check_ajax_referer('walmart_category_map_nonce', 'nonce');

    if (empty($_POST['wc_category_id'])) {
        wp_send_json_error(['message' => 'ç¼ºå°‘åˆ†ç±»ID']);
    }

    $wc_category_id = intval($_POST['wc_category_id']);

    try {
        global $wpdb;
        $map_table = $wpdb->prefix . 'walmart_category_map';

        // æ£€æŸ¥åˆ†ç±»æ˜¯å¦å­˜åœ¨
        $category = get_term($wc_category_id, 'product_cat');
        if (is_wp_error($category) || !$category) {
            wp_send_json_error(['message' => 'åˆ†ç±»ä¸å­˜åœ¨']);
        }

        // æŸ¥æ‰¾è¯¥åˆ†ç±»çš„æ˜ å°„è®°å½•ï¼ˆå…¼å®¹ä¸æ”¯æŒJSON_CONTAINSçš„MySQLç‰ˆæœ¬ï¼‰
        $mapping = null;

        // é¦–å…ˆå°è¯•ç›´æ¥åŒ¹é…wc_category_id
        $mapping = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $map_table WHERE wc_category_id = %d",
            $wc_category_id
        ));

        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæœç´¢local_category_idså­—æ®µ
        if (!$mapping) {
            $all_mappings = $wpdb->get_results("SELECT * FROM $map_table WHERE local_category_ids IS NOT NULL AND local_category_ids != ''");

            foreach ($all_mappings as $potential_mapping) {
                $local_ids = json_decode($potential_mapping->local_category_ids, true) ?: [];
                if (in_array($wc_category_id, array_map('intval', $local_ids))) {
                    $mapping = $potential_mapping;
                    break;
                }
            }
        }

        if ($mapping) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å…±äº«æ˜ å°„
            $local_ids = [];
            if (!empty($mapping->local_category_ids)) {
                $local_ids = json_decode($mapping->local_category_ids, true) ?: [];
            } else {
                $local_ids = [$mapping->wc_category_id];
            }

            if (count($local_ids) > 1) {
                // å…±äº«æ˜ å°„ï¼šåªç§»é™¤å½“å‰åˆ†ç±»ï¼Œä¸åˆ é™¤æ•´ä¸ªè®°å½•
                $local_ids = array_filter($local_ids, function($id) use ($wc_category_id) {
                    return intval($id) !== $wc_category_id;
                });

                if (!empty($local_ids)) {
                    // æ›´æ–°æ˜ å°„è®°å½•ï¼Œç§»é™¤å½“å‰åˆ†ç±»
                    $result = $wpdb->update(
                        $map_table,
                        ['local_category_ids' => json_encode(array_values($local_ids))],
                        ['id' => $mapping->id]
                    );

                    if ($result !== false) {
                        woo_walmart_sync_log('æ¸…é™¤åˆ†ç±»å±æ€§-å…±äº«æ˜ å°„', 'æˆåŠŸ', [
                            'wc_category_id' => $wc_category_id,
                            'category_name' => $category->name,
                            'mapping_id' => $mapping->id,
                            'remaining_categories' => $local_ids
                        ]);
                        wp_send_json_success(['message' => 'å·²ä»å…±äº«æ˜ å°„ä¸­ç§»é™¤è¯¥åˆ†ç±»']);
                    } else {
                        throw new Exception('æ›´æ–°å…±äº«æ˜ å°„å¤±è´¥: ' . $wpdb->last_error);
                    }
                } else {
                    // å¦‚æœç§»é™¤åæ²¡æœ‰å‰©ä½™åˆ†ç±»ï¼Œåˆ é™¤æ•´ä¸ªæ˜ å°„è®°å½•
                    $result = $wpdb->delete($map_table, ['id' => $mapping->id]);
                    if ($result !== false) {
                        woo_walmart_sync_log('æ¸…é™¤åˆ†ç±»å±æ€§-åˆ é™¤ç©ºæ˜ å°„', 'æˆåŠŸ', [
                            'wc_category_id' => $wc_category_id,
                            'category_name' => $category->name,
                            'mapping_id' => $mapping->id
                        ]);
                        wp_send_json_success(['message' => 'æ˜ å°„è®°å½•å·²å®Œå…¨æ¸…é™¤']);
                    } else {
                        throw new Exception('åˆ é™¤æ˜ å°„è®°å½•å¤±è´¥: ' . $wpdb->last_error);
                    }
                }
            } else {
                // ç‹¬ç«‹æ˜ å°„ï¼šç›´æ¥åˆ é™¤æ•´ä¸ªè®°å½•
                $result = $wpdb->delete($map_table, ['id' => $mapping->id]);
                if ($result !== false) {
                    woo_walmart_sync_log('æ¸…é™¤åˆ†ç±»å±æ€§-ç‹¬ç«‹æ˜ å°„', 'æˆåŠŸ', [
                        'wc_category_id' => $wc_category_id,
                        'category_name' => $category->name,
                        'mapping_id' => $mapping->id,
                        'walmart_category' => $mapping->walmart_category_path
                    ]);
                    wp_send_json_success(['message' => 'å±æ€§é…ç½®å’Œæ˜ å°„å…³ç³»å·²æ¸…é™¤']);
                } else {
                    throw new Exception('åˆ é™¤æ˜ å°„è®°å½•å¤±è´¥: ' . $wpdb->last_error);
                }
            }
        } else {
            // æ²¡æœ‰æ‰¾åˆ°æ˜ å°„è®°å½•
            wp_send_json_success(['message' => 'è¯¥åˆ†ç±»æ²¡æœ‰æ˜ å°„è®°å½•ï¼Œæ— éœ€æ¸…é™¤']);
        }

    } catch (Exception $e) {
        woo_walmart_sync_log('æ¸…é™¤åˆ†ç±»å±æ€§å¤±è´¥', 'é”™è¯¯', [
            'wc_category_id' => $wc_category_id,
            'error' => $e->getMessage()
        ]);

        wp_send_json_error(['message' => 'æ¸…é™¤å¤±è´¥: ' . $e->getMessage()]);
    }
});

// AJAX action for fetching category attributes
add_action('wp_ajax_get_walmart_category_attributes', function() {
    check_ajax_referer('walmart_category_map_nonce', 'nonce');
    
    if (empty($_POST['category_id']) || empty($_POST['category_name'])) {
        wp_send_json_error(['message' => 'ç¼ºå°‘åˆ†ç±»IDæˆ–åç§°']);
    }
    
    $category_id = sanitize_text_field($_POST['category_id']);
    $category_name = sanitize_text_field($_POST['category_name']);
    
    $transient_key = 'walmart_attributes_' . $category_id;

    // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ä»¥ç¡®ä¿V5.0æ–°å±æ€§èƒ½æ­£ç¡®æ˜¾ç¤º
    $force_refresh = isset($_POST['force_refresh']) ? $_POST['force_refresh'] : false;
    if ($force_refresh) {
        delete_transient($transient_key);
        woo_walmart_sync_log('å¼ºåˆ¶æ¸…é™¤å±æ€§ç¼“å­˜', 'ä¿¡æ¯', ['category_id' => $category_id], '');
    }

    $attributes = get_transient($transient_key);

    // æ£€æŸ¥æ˜¯å¦åº”è¯¥ä»æ•°æ®åº“è¯»å–å·²ä¿å­˜çš„å±æ€§ï¼ˆç”¨äºé‡ç½®å±æ€§åŠŸèƒ½ï¼‰
    $use_database = isset($_POST['use_database']) ? $_POST['use_database'] : false;

    if ($use_database) {
        // ä»æ•°æ®åº“è¯»å–å·²ä¿å­˜çš„å±æ€§
        $attributes = get_attributes_from_database($category_id);
        if (!empty($attributes)) {
            woo_walmart_sync_log('ä»æ•°æ®åº“è¯»å–å±æ€§', 'æˆåŠŸ', [
                'category_id' => $category_id,
                'attributes_count' => count($attributes)
            ], 'æˆåŠŸä»æ•°æ®åº“è¯»å–å·²ä¿å­˜çš„å±æ€§');

            // ç¼“å­˜ç»“æœ
            set_transient($transient_key, $attributes, DAY_IN_SECONDS);
            wp_send_json_success($attributes);
            return;
        }
    }

    if ($attributes === false) {
        // æ ¹æ®å½“å‰ä¸»å¸‚åœºåŠ¨æ€è·å– feedType å’Œç‰ˆæœ¬
        $business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');
        $market_code = str_replace('WALMART_', '', $business_unit);

        require_once plugin_dir_path(__FILE__) . 'includes/class-multi-market-config.php';
        $market_config = Woo_Walmart_Multi_Market_Config::get_market_config($market_code);
        $feed_type = isset($market_config['feed_types']['item']) ? $market_config['feed_types']['item'] : 'MP_ITEM';

        // ğŸ”§ åŠ æ‹¿å¤§å¸‚åœºï¼šä»æœ¬åœ°è§„èŒƒæ–‡ä»¶è§£æå±æ€§
        if ($market_code === 'CA') {
            woo_walmart_sync_log('CAå¸‚åœºè·å–å±æ€§', 'ä¿¡æ¯', [
                'category_name' => $category_name,
                'category_id' => $category_id,
                'market' => 'CA',
                'spec_version' => '3.16'
            ], 'ä»æœ¬åœ°CA_MP_ITEM_INTL_SPEC.jsonè§£æå±æ€§');

            $attributes = parse_ca_spec_attributes($category_id, $category_name);

            if (empty($attributes)) {
                woo_walmart_sync_log('CAå¸‚åœºè·å–å±æ€§-è§£æå¤±è´¥', 'Warning', [
                    'category_id' => $category_id,
                    'category_name' => $category_name
                ], 'æ— æ³•ä»CAè§„èŒƒæ–‡ä»¶è§£æå±æ€§');
                wp_send_json_error(['message' => 'æ— æ³•ä»åŠ æ‹¿å¤§è§„èŒƒæ–‡ä»¶è§£æå±æ€§']);
                return;
            }
        } else {
            // ğŸ‡ºğŸ‡¸ ç¾å›½åŠå…¶ä»–å¸‚åœºï¼šä½¿ç”¨ V5.0 Get Spec API
            $api_auth = new Woo_Walmart_API_Key_Auth();

            woo_walmart_sync_log('V5.0åŠ¨æ€è·å–å±æ€§', 'ä¿¡æ¯', [
                'category_name' => $category_name,
                'category_id' => $category_id,
                'market' => $market_code,
                'feed_type' => $feed_type
            ], 'V5.0ä½¿ç”¨Get Spec APIåŠ¨æ€è·å–å±æ€§');

            // ä½¿ç”¨å‚è€ƒæ’ä»¶çš„APIè°ƒç”¨æ–¹å¼
            $endpoint = '/v3/items/spec';
            $body = [
                'feedType' => $feed_type,
                'version' => '5.0.20241118-04_39_24-api',
                'productTypes' => [$category_id]  // V5.0 ä½¿ç”¨åˆ†ç±»ID
            ];

            // æ‰§è¡ŒAPIè°ƒç”¨
            $result = $api_auth->make_request($endpoint, 'POST', $body);

            if (is_wp_error($result)) {
                woo_walmart_sync_log('V5.0è·å–å±æ€§-APIå¤±è´¥', 'Error', ['endpoint' => $endpoint, 'body' => $body, 'category_id' => $category_id], $result->get_error_message());
                wp_send_json_error(['message' => 'APIè°ƒç”¨å¤±è´¥: ' . $result->get_error_message()]);
                return;
            }

            // è§£æV5.0 JSON Schemaæ ¼å¼çš„å“åº”
            $attributes = parse_v5_spec_response($result, $category_id);

            if (empty($attributes)) {
                woo_walmart_sync_log('V5.0è·å–å±æ€§-è§£æå¤±è´¥', 'Warning', ['endpoint' => $endpoint, 'body' => $body, 'response' => $result], 'æ— æ³•è§£æå±æ€§æ•°æ®');
                wp_send_json_error(['message' => 'æ— æ³•è§£æå±æ€§æ•°æ®']);
                return;
            }
        }

        // ä¿å­˜å±æ€§åˆ°æ•°æ®åº“
        $saved_count = save_attributes_to_database($attributes, $category_id, $category_name);

        woo_walmart_sync_log('V5.0è·å–å±æ€§-æˆåŠŸ', 'æˆåŠŸ', [
            'category_id' => $category_id,
            'attributes_count' => count($attributes),
            'saved_count' => $saved_count
        ], 'V5.0å±æ€§è·å–å¹¶ä¿å­˜æˆåŠŸ');

        // ç¼“å­˜ç»“æœ
        set_transient($transient_key, $attributes, DAY_IN_SECONDS);

        wp_send_json_success($attributes);
        return;

    }

    wp_send_json_success($attributes);
});

// AJAX action for debugging API response
add_action('wp_ajax_debug_walmart_api_response', function() {
    check_ajax_referer('walmart_category_map_nonce', 'nonce');

    if (empty($_POST['category_id']) || empty($_POST['category_name'])) {
        wp_send_json_error(['message' => 'ç¼ºå°‘åˆ†ç±»IDæˆ–åç§°']);
    }

    $category_id = sanitize_text_field($_POST['category_id']);
    $category_name = sanitize_text_field($_POST['category_name']);

    // æ ¹æ®å½“å‰ä¸»å¸‚åœºåŠ¨æ€è·å–é…ç½®
    $business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');
    $market_code = str_replace('WALMART_', '', $business_unit);

    require_once plugin_dir_path(__FILE__) . 'includes/class-multi-market-config.php';
    $market_config = Woo_Walmart_Multi_Market_Config::get_market_config($market_code);
    $feed_type = isset($market_config['feed_types']['item']) ? $market_config['feed_types']['item'] : 'MP_ITEM';

    // ğŸ”§ åŠ æ‹¿å¤§å¸‚åœºï¼šä»æœ¬åœ°è§„èŒƒæ–‡ä»¶è§£æ
    if ($market_code === 'CA') {
        $parsed_attributes = parse_ca_spec_attributes($category_id, $category_name);

        wp_send_json_success([
            'market' => 'CA',
            'spec_version' => '3.16',
            'source' => 'Local CA_MP_ITEM_INTL_SPEC.json file',
            'category_id' => $category_id,
            'category_name' => $category_name,
            'parsed_attributes' => $parsed_attributes,
            'parsed_count' => count($parsed_attributes),
            'note' => 'CAå¸‚åœºä½¿ç”¨æœ¬åœ°è§„èŒƒæ–‡ä»¶ï¼Œä¸è°ƒç”¨API'
        ]);
        return;
    }

    // ğŸ‡ºğŸ‡¸ ç¾å›½åŠå…¶ä»–å¸‚åœºï¼šè°ƒç”¨ V5.0 API
    $api_auth = new Woo_Walmart_API_Key_Auth();

    $endpoint = '/v3/items/spec';
    $body = [
        'feedType' => $feed_type,
        'version' => '5.0.20241118-04_39_24-api',
        'productTypes' => [$category_id]  // V5.0 ä½¿ç”¨åˆ†ç±»ID
    ];

    $result = $api_auth->make_request($endpoint, 'POST', $body);

    // å°è¯•è§£æ
    $parsed_attributes = [];
    if (!is_wp_error($result) && is_array($result)) {
        $parsed_attributes = parse_v5_spec_response($result, $category_id);
    }

    // è¿”å›è°ƒè¯•ä¿¡æ¯
    wp_send_json_success([
        'market' => $market_code,
        'api_version' => '5.0',
        'endpoint' => $endpoint,
        'request_body' => $body,
        'raw_response' => $result,
        'parsed_attributes' => $parsed_attributes,
        'parsed_count' => count($parsed_attributes),
        'is_error' => is_wp_error($result),
        'error_message' => is_wp_error($result) ? $result->get_error_message() : null,
        'category_id' => $category_id,
        'category_name' => $category_name
    ]);
});

/**
 * è§£ææ²ƒå°”ç› Get Spec API å“åº”
 * @param array $response APIå“åº”
 * @param string $category_name åˆ†ç±»åç§°
 * @return array è§£æåçš„å±æ€§æ•°ç»„
 */
function parse_walmart_spec_response($response, $category_name) {
    $attributes = [];
    $api_version = get_option('woo_walmart_api_version', '5.0');

    // è®°å½•åŸå§‹å“åº”ç”¨äºè°ƒè¯•
    woo_walmart_sync_log('APIå“åº”è§£æ-å¼€å§‹', 'è°ƒè¯•', ['category_name' => $category_name, 'api_version' => $api_version], $response);

    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å“åº”
    if (isset($response['error']) || isset($response['errors'])) {
        woo_walmart_sync_log('APIå“åº”è§£æ-å‘ç°é”™è¯¯', 'è­¦å‘Š', ['category_name' => $category_name, 'api_version' => $api_version], $response);
        return []; // è¿”å›ç©ºæ•°ç»„ï¼Œè®©ç³»ç»Ÿä½¿ç”¨é»˜è®¤å±æ€§
    }

    // V5.0 å“åº”ç»“æ„
    return parse_v5_spec_response($response, $category_name);
}

/**
 * ğŸ‡¨ğŸ‡¦ è§£æåŠ æ‹¿å¤§å¸‚åœº CA_MP_ITEM_INTL_SPEC.json è§„èŒƒæ–‡ä»¶çš„å±æ€§
 *
 * @param string $category_id åˆ†ç±»ID (ä¾‹å¦‚: "CA_FURNITURE")
 * @param string $category_name åˆ†ç±»åç§° (ä¾‹å¦‚: "Furniture")
 * @return array è§£æåçš„å±æ€§æ•°ç»„
 */
function parse_ca_spec_attributes($category_id, $category_name) {
    $attributes = [];

    // è¯»å–åŠ æ‹¿å¤§è§„èŒƒæ–‡ä»¶
    $spec_file = plugin_dir_path(__FILE__) . 'api/CA_MP_ITEM_INTL_SPEC.json';

    if (!file_exists($spec_file)) {
        woo_walmart_sync_log('CAå±æ€§è§£æ', 'é”™è¯¯', [
            'spec_file' => $spec_file
        ], 'CAè§„èŒƒæ–‡ä»¶ä¸å­˜åœ¨');
        return [];
    }

    $spec_content = file_get_contents($spec_file);
    $spec_data = json_decode($spec_content, true);

    if (json_last_error() !== JSON_ERROR_NONE) {
        woo_walmart_sync_log('CAå±æ€§è§£æ', 'é”™è¯¯', [
            'json_error' => json_last_error_msg()
        ], 'CAè§„èŒƒæ–‡ä»¶JSONè§£æå¤±è´¥');
        return [];
    }

    // ä»åˆ†ç±»IDä¸­æå–äº§å“ç±»å‹åç§° (CA_FURNITURE -> Furniture)
    $product_type_name = str_replace('CA_', '', $category_id);
    $product_type_name = str_replace('_', ' ', $product_type_name);
    $product_type_name = ucwords(strtolower($product_type_name));

    // åœ¨è§„èŒƒæ–‡ä»¶ä¸­æŸ¥æ‰¾å¯¹åº”çš„äº§å“ç±»å‹
    // ç»“æ„: properties.MPItem.items.properties.Visible.properties.[ProductTypeName]
    if (!isset($spec_data['properties']['MPItem']['items']['properties']['Visible']['properties'][$product_type_name])) {
        woo_walmart_sync_log('CAå±æ€§è§£æ', 'è­¦å‘Š', [
            'product_type_name' => $product_type_name,
            'available_types' => array_keys($spec_data['properties']['MPItem']['items']['properties']['Visible']['properties'] ?? [])
        ], 'åœ¨CAè§„èŒƒæ–‡ä»¶ä¸­æœªæ‰¾åˆ°è¯¥äº§å“ç±»å‹');
        return [];
    }

    $product_spec = $spec_data['properties']['MPItem']['items']['properties']['Visible']['properties'][$product_type_name];

    // è§£æ Visible éƒ¨åˆ†çš„å±æ€§
    if (isset($product_spec['properties'])) {
        foreach ($product_spec['properties'] as $attr_name => $attr_spec) {
            $attribute = [
                'attributeName' => $attr_name,
                'isrequired' => in_array($attr_name, $product_spec['required'] ?? []),
                'group' => 'Visible',
                'defaultType' => 'product_field'
            ];

            // è§£ææ•°æ®ç±»å‹
            if (isset($attr_spec['type'])) {
                $attribute['dataType'] = $attr_spec['type'];
            }

            // è§£ææšä¸¾å€¼
            if (isset($attr_spec['enum'])) {
                $attribute['enumValues'] = $attr_spec['enum'];
                $attribute['defaultType'] = 'walmart_field';
            }

            // è§£ææè¿°
            if (isset($attr_spec['description'])) {
                $attribute['description'] = $attr_spec['description'];
            }

            $attributes[] = $attribute;
        }
    }

    // è§£æ Orderable éƒ¨åˆ†çš„é€šç”¨å±æ€§
    if (isset($spec_data['properties']['MPItem']['items']['properties']['Orderable']['properties'])) {
        $orderable_spec = $spec_data['properties']['MPItem']['items']['properties']['Orderable'];

        foreach ($orderable_spec['properties'] as $attr_name => $attr_spec) {
            // è·³è¿‡å·²ç»åœ¨ Visible ä¸­å®šä¹‰çš„å±æ€§
            $already_exists = false;
            foreach ($attributes as $existing_attr) {
                if ($existing_attr['attributeName'] === $attr_name) {
                    $already_exists = true;
                    break;
                }
            }

            if ($already_exists) {
                continue;
            }

            $attribute = [
                'attributeName' => $attr_name,
                'isrequired' => in_array($attr_name, $orderable_spec['required'] ?? []),
                'group' => 'Orderable',
                'defaultType' => 'product_field'
            ];

            // è§£ææ•°æ®ç±»å‹
            if (isset($attr_spec['type'])) {
                $attribute['dataType'] = $attr_spec['type'];
            }

            // è§£ææšä¸¾å€¼
            if (isset($attr_spec['enum'])) {
                $attribute['enumValues'] = $attr_spec['enum'];
                $attribute['defaultType'] = 'walmart_field';
            }

            // è§£æå¤šè¯­è¨€å­—æ®µ
            if (isset($attr_spec['properties']) && isset($attr_spec['properties']['en'])) {
                $attribute['multilingual'] = true;
            }

            // è§£ææè¿°
            if (isset($attr_spec['description'])) {
                $attribute['description'] = $attr_spec['description'];
            }

            $attributes[] = $attribute;
        }
    }

    woo_walmart_sync_log('CAå±æ€§è§£æ', 'æˆåŠŸ', [
        'product_type_name' => $product_type_name,
        'attributes_count' => count($attributes)
    ], 'æˆåŠŸè§£æCAè§„èŒƒå±æ€§');

    return $attributes;
}

/**
 * è§£æV5.0 JSON Schemaæ ¼å¼çš„å±æ€§å“åº”
 * å®Œå…¨æŒ‰ç…§å‚è€ƒæ’ä»¶çš„é€»è¾‘å®ç°
 */
function parse_v5_spec_response($spec_data, $product_type_id) {
    $synced_count = 0;

    // è®°å½•åŸå§‹å“åº”ç”¨äºè°ƒè¯•
    woo_walmart_sync_log('å±æ€§åŒæ­¥', 'APIå“åº”æ•°æ®', [
        'product_type_id' => $product_type_id,
        'response_keys' => array_keys($spec_data),
        'response_sample' => array_slice($spec_data, 0, 3, true)
    ], 'è°ƒè¯•APIå“åº”ç»“æ„');

    // å°è¯•å¤šç§å¯èƒ½çš„æ•°æ®ç»“æ„è·¯å¾„
    $possible_paths = [
        ['schema'],  // æ–°çš„JSON Schemaæ ¼å¼
        ['payload', 'itemSpecs'],
        ['payload', 'itemTypeInfo'],
        ['itemSpecs'],
        ['itemTypeInfo'],
        ['data', 'itemSpecs'],
        ['data', 'specs'],
        ['specs'],
        ['attributes']
    ];

    $item_specs = null;
    $used_path = '';

    foreach ($possible_paths as $path) {
        $current_data = $spec_data;
        $path_valid = true;

        foreach ($path as $key) {
            if (isset($current_data[$key])) {
                $current_data = $current_data[$key];
            } else {
                $path_valid = false;
                break;
            }
        }

        if ($path_valid && is_array($current_data) && !empty($current_data)) {
            $item_specs = $current_data;
            $used_path = implode(' -> ', $path);
            break;
        }
    }

    if (!$item_specs) {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†è·¯å¾„ï¼Œå°è¯•ç›´æ¥åœ¨æ ¹çº§åˆ«æŸ¥æ‰¾å±æ€§
        if (isset($spec_data['attributes']) && is_array($spec_data['attributes'])) {
            $item_specs = [$spec_data]; // åŒ…è£…æˆæ•°ç»„
            $used_path = 'root -> attributes';
        } else {
            woo_walmart_sync_log('å±æ€§åŒæ­¥', 'æœªæ‰¾åˆ°å±æ€§æ•°æ®', [
                'product_type_id' => $product_type_id,
                'tried_paths' => $possible_paths,
                'response_structure' => analyze_response_structure($spec_data)
            ], 'å±æ€§è§£æå¤±è´¥');
            return [];
        }
    }

    woo_walmart_sync_log('å±æ€§åŒæ­¥', 'æ‰¾åˆ°å±æ€§æ•°æ®', [
        'product_type_id' => $product_type_id,
        'used_path' => $used_path,
        'specs_count' => is_array($item_specs) ? count($item_specs) : 'not_array'
    ], 'å¼€å§‹è§£æå±æ€§');

    // ç‰¹æ®Šå¤„ç†JSON Schemaæ ¼å¼
    if ($used_path === 'schema') {
        return parse_json_schema_attributes($item_specs, $product_type_id);
    }

    // å¦‚æœä¸æ˜¯schemaæ ¼å¼ï¼Œè¿”å›ç©ºæ•°ç»„ï¼ˆV5.0ä¸»è¦ä½¿ç”¨schemaæ ¼å¼ï¼‰
    woo_walmart_sync_log('å±æ€§åŒæ­¥', 'éschemaæ ¼å¼', [
        'product_type_id' => $product_type_id,
        'used_path' => $used_path
    ], 'è·³è¿‡éschemaæ ¼å¼');

    return [];
    return $attributes;
}

/**
 * ä»JSON Schemaå±æ€§å®šä¹‰ä¸­æå–å±æ€§ä¿¡æ¯ (V2ç‰ˆæœ¬ï¼ŒåŸºäºçœŸå®APIå“åº”)
 */
function extract_attribute_from_schema_v2($property_name, $property_def, $product_type_id, $is_required = false, $group = 'General') {
    // åŸºæœ¬å±æ€§ä¿¡æ¯
    $attribute = [
        'attributeName' => $property_name,
        'isrequired' => $is_required,
        'description' => $property_def['title'] ?? $property_def['description'] ?? '',
        'defaultType' => 'text',
        'group' => $group
    ];

    // è‡ªåŠ¨æ£€æµ‹å°ºå¯¸/é‡é‡å¯¹è±¡å­—æ®µ
    if (isset($property_def['type']) && $property_def['type'] === 'object' &&
        isset($property_def['properties'])) {

        // æ£€æŸ¥æ ‡å‡†çš„measure/unitç»“æ„
        if (isset($property_def['properties']['measure']) && isset($property_def['properties']['unit'])) {

            // è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†å°ºå¯¸/é‡é‡å¯¹è±¡å­—æ®µ
            $attribute['defaultType'] = 'measurement_object';

            // æå–æ”¯æŒçš„å•ä½
            $unit_def = $property_def['properties']['unit'];
            if (isset($unit_def['enum']) && is_array($unit_def['enum'])) {
                $attribute['allowed_units'] = $unit_def['enum'];
                $attribute['default_unit'] = $unit_def['enum'][0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªä½œä¸ºé»˜è®¤å•ä½
            }

            // æå–measureçš„éªŒè¯è§„åˆ™
            $measure_def = $property_def['properties']['measure'];
            $validation_rules = [];
            if (isset($measure_def['minimum'])) {
                $validation_rules['min'] = $measure_def['minimum'];
            }
            if (isset($measure_def['maximum'])) {
                $validation_rules['max'] = $measure_def['maximum'];
            }
            if (!empty($validation_rules)) {
                $attribute['validation_rules'] = $validation_rules;
            }

            // æ ¹æ®å­—æ®µåå’Œå•ä½è‡ªåŠ¨åˆ†ç»„
            if (auto_detect_field_category($property_name, $attribute['allowed_units'] ?? [])) {
                $attribute['group'] = auto_detect_field_category($property_name, $attribute['allowed_units'] ?? []);
            }

            return $attribute;
        }
        // æ£€æŸ¥netContentç‰¹æ®Šç»“æ„ï¼ˆproductNetContentMeasure/productNetContentUnitï¼‰
        elseif (isset($property_def['properties']['productNetContentMeasure']) && isset($property_def['properties']['productNetContentUnit'])) {

            // è¿™æ˜¯ä¸€ä¸ªnetContentç±»å‹çš„measurement_objectå­—æ®µ
            $attribute['defaultType'] = 'measurement_object';
            $attribute['measure_field'] = 'productNetContentMeasure';
            $attribute['unit_field'] = 'productNetContentUnit';

            // æå–æ”¯æŒçš„å•ä½
            $unit_def = $property_def['properties']['productNetContentUnit'];
            if (isset($unit_def['enum']) && is_array($unit_def['enum'])) {
                $attribute['allowed_units'] = $unit_def['enum'];
                $attribute['default_unit'] = $unit_def['enum'][0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªä½œä¸ºé»˜è®¤å•ä½
            }

            // æå–measureçš„éªŒè¯è§„åˆ™
            $measure_def = $property_def['properties']['productNetContentMeasure'];
            $validation_rules = [];
            if (isset($measure_def['minimum'])) {
                $validation_rules['min'] = $measure_def['minimum'];
            }
            if (isset($measure_def['maximum'])) {
                $validation_rules['max'] = $measure_def['maximum'];
            }
            if (!empty($validation_rules)) {
                $attribute['validation_rules'] = $validation_rules;
            }

            $attribute['group'] = 'Content';

            return $attribute;
        }
    }

    // æ ¹æ®ç±»å‹ç¡®å®šå­—æ®µç±»å‹
    if (isset($property_def['type'])) {
        switch ($property_def['type']) {
            case 'string':
                $attribute['defaultType'] = 'text';
                break;
            case 'number':
            case 'integer':
                // æ£€æŸ¥æ ‡é¢˜æˆ–æè¿°ä¸­æ˜¯å¦åŒ…å«å•ä½ä¿¡æ¯
                $title = $property_def['title'] ?? '';
                $description = $property_def['description'] ?? '';
                $combined_text = $title . ' ' . $description;

                if (preg_match('/\(([^)]+)\)/', $combined_text, $matches)) {
                    // æ ‡é¢˜æˆ–æè¿°ä¸­åŒ…å«å•ä½ä¿¡æ¯ï¼Œå¦‚ "Shipping Weight (lbs)"
                    $attribute['implied_unit'] = trim($matches[1]);
                    $attribute['defaultType'] = 'number_with_unit';

                    // æ ¹æ®å•ä½è‡ªåŠ¨åˆ†ç»„
                    $unit = strtolower($attribute['implied_unit']);
                    if (in_array($unit, ['lb', 'lbs', 'pound', 'pounds', 'oz', 'ounce', 'ounces', 'kg', 'kilogram', 'g', 'gram'])) {
                        $attribute['group'] = 'Weight';
                    } elseif (in_array($unit, ['in', 'inch', 'inches', 'ft', 'foot', 'feet', 'cm', 'centimeter', 'mm', 'millimeter'])) {
                        $attribute['group'] = 'Dimensions';
                    }
                } else {
                    $attribute['defaultType'] = 'number';
                }
                break;
            case 'boolean':
                $attribute['defaultType'] = 'boolean';
                break;
            case 'array':
                $attribute['defaultType'] = 'array';
                // å¦‚æœæ•°ç»„é¡¹æœ‰æšä¸¾å€¼ï¼Œè½¬æ¢ä¸ºå¤šé€‰
                if (isset($property_def['items']['enum'])) {
                    $attribute['allowed_values'] = $property_def['items']['enum'];
                    $attribute['enumValues'] = $property_def['items']['enum']; // å…¼å®¹æ€§å­—æ®µ
                    $attribute['defaultType'] = 'multiselect';
                }
                break;
            default:
                $attribute['defaultType'] = 'text';
        }
    }

    // å¦‚æœæœ‰æšä¸¾å€¼ï¼Œè®¾ç½®ä¸ºé€‰æ‹©æ¡†
    if (isset($property_def['enum']) && is_array($property_def['enum'])) {
        $attribute['defaultType'] = 'select';
        $attribute['allowed_values'] = $property_def['enum'];
        $attribute['enumValues'] = $property_def['enum']; // å…¼å®¹æ€§å­—æ®µ
    }

    // è§£æoneOfç»“æ„
    if (isset($property_def['oneOf']) && is_array($property_def['oneOf'])) {
        $enum_values = [];
        foreach ($property_def['oneOf'] as $option) {
            if (isset($option['enum'])) {
                $enum_values = array_merge($enum_values, $option['enum']);
            }
        }
        if (!empty($enum_values)) {
            $attribute['allowed_values'] = $enum_values;
            $attribute['defaultType'] = 'select';
        }
    }

    // å¤„ç†ç‰¹æ®Šå­—æ®µ
    if (in_array($property_name, ['keyFeatures', 'key_features'])) {
        $attribute['defaultType'] = 'textarea';
    }

    return $attribute;
}

/**
 * è‡ªåŠ¨æ£€æµ‹å­—æ®µåˆ†ç±»
 */
function auto_detect_field_category($property_name, $allowed_units = []) {
    $property_lower = strtolower($property_name);

    // é‡é‡ç›¸å…³å­—æ®µ
    $weight_keywords = ['weight', 'mass'];
    foreach ($weight_keywords as $keyword) {
        if (strpos($property_lower, $keyword) !== false) {
            return 'Weight';
        }
    }

    // é€šè¿‡å•ä½åˆ¤æ–­
    if (!empty($allowed_units)) {
        $weight_units = ['lb', 'oz', 'kg', 'g', 'pound', 'ounce', 'kilogram', 'gram'];
        $dimension_units = ['in', 'ft', 'cm', 'mm', 'inch', 'foot', 'centimeter', 'millimeter'];

        $has_weight_unit = !empty(array_intersect($allowed_units, $weight_units));
        $has_dimension_unit = !empty(array_intersect($allowed_units, $dimension_units));

        if ($has_weight_unit && !$has_dimension_unit) {
            return 'Weight';
        }
        if ($has_dimension_unit && !$has_weight_unit) {
            return 'Dimensions';
        }
    }

    // å°ºå¯¸ç›¸å…³å­—æ®µ
    $dimension_keywords = ['length', 'width', 'height', 'depth', 'dimension', 'size', 'diameter', 'thickness', 'radius'];
    foreach ($dimension_keywords as $keyword) {
        if (strpos($property_lower, $keyword) !== false) {
            return 'Dimensions';
        }
    }

    return 'General';
}

/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºå°ºå¯¸ç›¸å…³å±æ€§ (ä¿ç•™å‘åå…¼å®¹)
 */
function is_dimension_attribute($property_name) {
    return auto_detect_field_category($property_name) !== 'General';
}

/**
 * åˆ†æå“åº”ç»“æ„
 */
function analyze_response_structure($data, $max_depth = 3, $current_depth = 0) {
    if ($current_depth >= $max_depth) {
        return '...';
    }

    if (is_array($data)) {
        $structure = [];
        foreach (array_keys($data) as $key) {
            if (is_array($data[$key])) {
                $structure[$key] = analyze_response_structure($data[$key], $max_depth, $current_depth + 1);
            } else {
                $structure[$key] = gettype($data[$key]);
            }
        }
        return $structure;
    }

    return gettype($data);
}

/**
 * ä»æ•°æ®åº“è¯»å–å·²ä¿å­˜çš„å±æ€§
 */
function get_attributes_from_database($product_type_id) {
    global $wpdb;

    $table_name = $wpdb->prefix . 'walmart_product_attributes';

    $db_attributes = $wpdb->get_results($wpdb->prepare(
        "SELECT * FROM {$table_name} WHERE product_type_id = %s ORDER BY attribute_name",
        $product_type_id
    ));

    if (empty($db_attributes)) {
        return [];
    }

    $attributes = [];
    foreach ($db_attributes as $db_attr) {
        $attribute = [
            'attributeName' => $db_attr->attribute_name,
            'isrequired' => (bool)$db_attr->is_required,
            'description' => $db_attr->description,
            'defaultType' => $db_attr->attribute_type,
            'group' => $db_attr->attribute_group
        ];

        // æ·»åŠ æ ¼å¼ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (isset($db_attr->format) && !empty($db_attr->format)) {
            $attribute['format'] = $db_attr->format;
        }

        // å¤„ç†æšä¸¾å€¼
        if (!empty($db_attr->allowed_values)) {
            $attribute['allowed_values'] = $db_attr->allowed_values;

            // è§£ææšä¸¾å€¼ä¸ºæ•°ç»„æ ¼å¼ï¼ˆè¿‡æ»¤å•ä½ä¿¡æ¯ï¼‰
            $enum_values = array_filter(
                explode('|', $db_attr->allowed_values),
                function($val) {
                    return trim($val) &&
                           strpos($val, 'UNITS:') !== 0 &&
                           strpos($val, 'DEFAULT_UNIT:') !== 0;
                }
            );

            if (!empty($enum_values)) {
                $attribute['enumValues'] = array_values($enum_values);
            }
        }

        // å¤„ç†éªŒè¯è§„åˆ™
        if (!empty($db_attr->validation_rules)) {
            $validation_rules = json_decode($db_attr->validation_rules, true);
            if ($validation_rules) {
                $attribute['validation_rules'] = $validation_rules;
            }
        }

        $attributes[] = $attribute;
    }

    return $attributes;
}

/**
 * ä¿å­˜å±æ€§åˆ°æ•°æ®åº“
 */
function save_attributes_to_database($attributes, $product_type_id, $product_type_name) {
    global $wpdb;

    // åˆ›å»ºå±æ€§è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    $table_name = $wpdb->prefix . 'walmart_product_attributes';

    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE IF NOT EXISTS {$table_name} (
        id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        product_type_id varchar(191) NOT NULL,
        product_type_name varchar(255) NOT NULL,
        attribute_name varchar(191) NOT NULL,
        attribute_type varchar(50) NOT NULL DEFAULT 'text',
        is_required tinyint(1) DEFAULT 0,
        allowed_values longtext,
        validation_rules longtext,
        format varchar(50) DEFAULT '',
        display_order int(11) DEFAULT 0,
        attribute_group varchar(100) DEFAULT 'general',
        description text,
        created_at datetime NOT NULL,
        updated_at datetime NOT NULL,
        PRIMARY KEY (id),
        UNIQUE KEY unique_attr (product_type_id(100), attribute_name(100)),
        KEY product_type_id (product_type_id),
        KEY attribute_name (attribute_name),
        KEY is_required (is_required)
    ) {$charset_collate};";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);

    $saved_count = 0;
    $current_time = current_time('mysql');

    foreach ($attributes as $attr) {
        $allowed_values = '';
        if (isset($attr['allowed_values'])) {
            if (is_array($attr['allowed_values'])) {
                $allowed_values = implode('|', $attr['allowed_values']);
            } else {
                $allowed_values = $attr['allowed_values'];
            }
        }

        // å¤„ç†å•ä½ä¿¡æ¯
        $units_info = '';
        if (isset($attr['allowed_units']) && is_array($attr['allowed_units'])) {
            $units_info = implode('|', $attr['allowed_units']);
        } elseif (isset($attr['implied_unit'])) {
            $units_info = $attr['implied_unit'];
        }

        // å¤„ç†éªŒè¯è§„åˆ™
        $validation_rules = '';
        if (isset($attr['validation_rules']) && is_array($attr['validation_rules'])) {
            $validation_rules = wp_json_encode($attr['validation_rules'], JSON_UNESCAPED_UNICODE);
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        $existing = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM {$table_name} WHERE product_type_id = %s AND attribute_name = %s",
            $product_type_id,
            $attr['attributeName']
        ));

        $attribute_data = [
            'product_type_id' => $product_type_id,
            'product_type_name' => $product_type_name,
            'attribute_name' => $attr['attributeName'],
            'attribute_type' => $attr['defaultType'],
            'is_required' => $attr['isrequired'] ? 1 : 0,
            'allowed_values' => $allowed_values,
            'validation_rules' => $validation_rules,
            'format' => $attr['format'] ?? '', // æ·»åŠ æ ¼å¼å­—æ®µ
            'display_order' => 0,
            'attribute_group' => $attr['group'] ?? 'general',
            'description' => $attr['description'] ?? '',
            'created_at' => $current_time,
            'updated_at' => $current_time
        ];

        // å¦‚æœæœ‰å•ä½ä¿¡æ¯ï¼Œæ·»åŠ åˆ°allowed_valuesä¸­ï¼ˆç”¨ç‰¹æ®Šæ ¼å¼æ ‡è¯†ï¼‰
        if (!empty($units_info)) {
            if (!empty($attribute_data['allowed_values'])) {
                $attribute_data['allowed_values'] .= '||UNITS:' . $units_info;
            } else {
                $attribute_data['allowed_values'] = 'UNITS:' . $units_info;
            }

            // æ·»åŠ é»˜è®¤å•ä½ä¿¡æ¯
            if (isset($attr['default_unit'])) {
                $attribute_data['allowed_values'] .= '||DEFAULT_UNIT:' . $attr['default_unit'];
            }
        }

        if ($existing) {
            // æ›´æ–°ç°æœ‰è®°å½•
            $result = $wpdb->update(
                $table_name,
                $attribute_data,
                ['id' => $existing]
            );
        } else {
            // æ’å…¥æ–°è®°å½•
            $result = $wpdb->insert($table_name, $attribute_data);
        }

        if ($result !== false) {
            $saved_count++;
        }
    }

    woo_walmart_sync_log('å±æ€§ä¿å­˜', 'å®Œæˆ', [
        'product_type_id' => $product_type_id,
        'total_attributes' => count($attributes),
        'saved_count' => $saved_count
    ], 'å±æ€§ä¿å­˜åˆ°æ•°æ®åº“');

    return $saved_count;
}



/**
 * è·å–é»˜è®¤å±æ€§ï¼ˆå½“APIå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
 * @param string $category_name åˆ†ç±»åç§°
 * @return array é»˜è®¤å±æ€§æ•°ç»„
 */
function get_default_attributes($category_name) {
    return get_v5_enhanced_default_attributes($category_name);
}

/**
 * V5.0 å¢å¼ºçš„é»˜è®¤å±æ€§ï¼ˆåŸºäºV5.0å®é™…è¦æ±‚ï¼‰
 */
function get_v5_enhanced_default_attributes($category_name) {
    // V5.0 æ ¸å¿ƒå¿…éœ€å±æ€§
    $v5_core_attributes = [
        ['attributeName' => 'brand', 'isrequired' => true, 'description' => 'å“ç‰Œåç§° (V5.0å¿…å¡«ï¼Œæœ€å¤š60å­—ç¬¦)'],
        ['attributeName' => 'productName', 'isrequired' => true, 'description' => 'äº§å“åç§° (V5.0å¿…å¡«ï¼Œæœ€å¤š199å­—ç¬¦)'],
        ['attributeName' => 'keyFeatures', 'isrequired' => true, 'description' => 'äº§å“ç‰¹è‰² (V5.0å¿…å¡«ï¼Œæœ€å°‘3ä¸ªï¼Œæ¯ä¸ªæœ€å¤š10000å­—ç¬¦)'],
        ['attributeName' => 'shortDescription', 'isrequired' => false, 'description' => 'ç®€çŸ­æè¿° (V5.0æœ€å¤š100000å­—ç¬¦)'],
        ['attributeName' => 'mainImageUrl', 'isrequired' => true, 'description' => 'ä¸»å›¾ç‰‡URL (V5.0å¿…å¡«)'],
        ['attributeName' => 'price', 'isrequired' => true, 'description' => 'ä»·æ ¼ (V5.0å¿…å¡«)'],
        ['attributeName' => 'sku', 'isrequired' => true, 'description' => 'SKU (V5.0å¿…å¡«ï¼Œå”¯ä¸€æ ‡è¯†)'],
    ];

    // V5.0 é€šç”¨å¯é€‰å±æ€§
    $v5_optional_attributes = [
        ['attributeName' => 'manufacturer', 'isrequired' => false, 'description' => 'åˆ¶é€ å•†'],
        ['attributeName' => 'modelNumber', 'isrequired' => false, 'description' => 'å‹å·'],
        ['attributeName' => 'color', 'isrequired' => false, 'description' => 'é¢œè‰²'],
        ['attributeName' => 'size', 'isrequired' => false, 'description' => 'å°ºå¯¸'],
        ['attributeName' => 'material', 'isrequired' => false, 'description' => 'æè´¨'],
        ['attributeName' => 'weight', 'isrequired' => false, 'description' => 'é‡é‡'],
        ['attributeName' => 'dimensions', 'isrequired' => false, 'description' => 'å°ºå¯¸è§„æ ¼'],
    ];

    $attributes = array_merge($v5_core_attributes, $v5_optional_attributes);

    // æ ¹æ®åˆ†ç±»æ·»åŠ ç‰¹å®šå±æ€§
    $category_lower = strtolower($category_name);

    if (strpos($category_lower, 'furniture') !== false || strpos($category_lower, 'å®¶å…·') !== false) {
        $furniture_attrs = [
            ['attributeName' => 'assemblyRequired', 'isrequired' => false, 'description' => 'æ˜¯å¦éœ€è¦ç»„è£…'],
            ['attributeName' => 'roomType', 'isrequired' => false, 'description' => 'é€‚ç”¨æˆ¿é—´ç±»å‹'],
            ['attributeName' => 'style', 'isrequired' => false, 'description' => 'é£æ ¼'],
            ['attributeName' => 'shippingWeight', 'isrequired' => true, 'description' => 'è¿è¾“é‡é‡ (å®¶å…·ç±»å¿…å¡«)']
        ];
        $attributes = array_merge($attributes, $furniture_attrs);
    }

    if (strpos($category_lower, 'clothing') !== false || strpos($category_lower, 'apparel') !== false) {
        $clothing_attrs = [
            ['attributeName' => 'gender', 'isrequired' => false, 'description' => 'æ€§åˆ«åˆ†ç±»'],
            ['attributeName' => 'ageGroup', 'isrequired' => false, 'description' => 'å¹´é¾„ç»„'],
            ['attributeName' => 'fabricType', 'isrequired' => false, 'description' => 'é¢æ–™ç±»å‹'],
        ];
        $attributes = array_merge($attributes, $clothing_attrs);
    }

    // ä¸ºæ‰€æœ‰å±æ€§æ·»åŠ é»˜è®¤ç±»å‹
    foreach ($attributes as &$attr) {
        $attr['defaultType'] = determine_attribute_default_type($attr['attributeName'], $category_name);
    }

    return $attributes;
}



/**
 * V5.0 é™æ€å±æ€§è§„èŒƒ - åŸºäºå®˜æ–¹JSONè§„èŒƒæ–‡ä»¶çš„çœŸå®å±æ€§
 * è¿™æ˜¯V5.0çš„æ­£ç¡®å®ç°æ–¹å¼ï¼Œä¸å†ä¾èµ–åŠ¨æ€API
 */
function get_v5_static_attributes_from_spec($category_name, $category_id) {
    // V5.0 æ ¸å¿ƒå¿…éœ€å±æ€§ï¼ˆåŸºäºå®˜æ–¹JSONè§„èŒƒçš„çœŸå®å¿…å¡«è¦æ±‚ï¼‰
    $v5_core_attributes = [
        // "Required to sell on Walmart website" - é”€å”®åŸºæœ¬å¿…å¡«é¡¹
        [
            'attributeName' => 'productName',
            'isrequired' => true,
            'description' => 'äº§å“åç§° - 10-199å­—ç¬¦ (å¿…å¡«ï¼šåœ¨æ²ƒå°”ç›é”€å”®)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'sell'
        ],
        [
            'attributeName' => 'brand',
            'isrequired' => true,
            'description' => 'å“ç‰Œåç§° - æœ€å¤š60å­—ç¬¦ï¼Œæ— å“ç‰Œä½¿ç”¨"Unbranded" (å¿…å¡«ï¼šåœ¨æ²ƒå°”ç›é”€å”®)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'sell'
        ],
        [
            'attributeName' => 'keyFeatures',
            'isrequired' => true,
            'description' => 'äº§å“ç‰¹è‰² - æœ€å°‘3ä¸ªï¼Œæ¯ä¸ªæœ€å¤š10000å­—ç¬¦ (å¿…å¡«ï¼šå•†å“å¯è§)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'visible'
        ],
        [
            'attributeName' => 'mainImageUrl',
            'isrequired' => true,
            'description' => 'ä¸»å›¾ç‰‡URL - JPEGæ ¼å¼ï¼Œ2200x2200pxæ¨è (å¿…å¡«ï¼šå•†å“å¯è§)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'visible'
        ],

        // ç³»ç»Ÿçº§å¿…å¡«å±æ€§
        [
            'attributeName' => 'sku',
            'isrequired' => true,
            'description' => 'SKU - å•†å“å”¯ä¸€æ ‡è¯†ç¬¦ (ç³»ç»Ÿå¿…å¡«)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'system'
        ],
        [
            'attributeName' => 'price',
            'isrequired' => true,
            'description' => 'ä»·æ ¼ (ç³»ç»Ÿå¿…å¡«)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'system'
        ],

        // V5.0 Orderableéƒ¨åˆ†çš„é‡è¦å±æ€§
        [
            'attributeName' => 'startDate',
            'isrequired' => false,
            'description' => 'ä¸Šæ¶å¼€å§‹æ—¥æœŸ - Site Start Date (YYYY-MM-DDTHH:MM:SSZ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'endDate',
            'isrequired' => false,
            'description' => 'ä¸‹æ¶ç»“æŸæ—¥æœŸ - Site End Date (YYYY-MM-DDTHH:MM:SSZ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'stateRestrictions',
            'isrequired' => false,
            'description' => 'å·é™åˆ¶ - State Restrictions (æ•°ç»„)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'fulfillmentLagTime',
            'isrequired' => false,
            'description' => 'å¤‡è´§æ—¶é—´ - Fulfillment Lag Time (0-10å¤©)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'electronicsIndicator',
            'isrequired' => false,
            'description' => 'æ˜¯å¦åŒ…å«ç”µå­å…ƒä»¶ - Electronics Indicator (Yes/No)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'chemicalAerosolPesticide',
            'isrequired' => false,
            'description' => 'æ˜¯å¦åŒ…å«åŒ–å­¦å“/æ°”é›¾å‰‚/æ€è™«å‰‚ (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'batteryTechnologyType',
            'isrequired' => false,
            'description' => 'ç”µæ± ç±»å‹ - Battery Technology Type',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Mercury', 'Carbon Zinc', 'Lead Acid (Non-Spillable)', 'Alkaline', 'Does Not Contain a Battery', 'Lithium Primary (Lithium Metal)', 'Nickel Cadmium', 'Lithium Ion', 'Nickel Metal Hydride', 'Lead Acid', 'Silver', 'Magnesium'],
            'requiredLevel' => 'optional'
        ],

        [
            'attributeName' => 'MustShipAlone',
            'isrequired' => false,
            'description' => 'æ˜¯å¦å¿…é¡»å•ç‹¬å‘è´§ (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'IsPreorder',
            'isrequired' => false,
            'description' => 'æ˜¯å¦é¢„è®¢å•†å“ (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'releaseDate',
            'isrequired' => false,
            'description' => 'å‘å¸ƒæ—¥æœŸ (YYYY-MM-DD)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'quantity',
            'isrequired' => false,
            'description' => 'åº“å­˜æ•°é‡',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'fulfillmentCenterID',
            'isrequired' => false,
            'description' => 'å±¥è¡Œä¸­å¿ƒID',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'inventoryAvailabilityDate',
            'isrequired' => false,
            'description' => 'é¢„è®¢å¯ç”¨æ—¥æœŸ (YYYY-MM-DD)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'optional'
        ],

        [
            'attributeName' => 'ProductIdUpdate',
            'isrequired' => false,
            'description' => 'äº§å“IDæ›´æ–°',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'SkuUpdate',
            'isrequired' => false,
            'description' => 'SKUæ›´æ–°',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ]
    ];

    // V5.0 é€šç”¨å±æ€§ï¼ˆåŸºäºå®˜æ–¹JSONè§„èŒƒæ–‡ä»¶çš„å®é™…å±æ€§ï¼‰
    $v5_common_attributes = [
        // åŸºæœ¬ä¿¡æ¯å±æ€§
        [
            'attributeName' => 'shortDescription',
            'isrequired' => false,
            'description' => 'ç®€çŸ­æè¿° - æœ€å¤š100000å­—ç¬¦ (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'additionalImageUrl',
            'isrequired' => false,
            'description' => 'é™„åŠ å›¾ç‰‡URL - JPEGæ ¼å¼ï¼Œæœ€å°‘1å¼ æ¨è',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'swatchImages',
            'isrequired' => false,
            'description' => 'æ ·å“å›¾ç‰‡ - ç”¨äºé¢œè‰²/æè´¨å±•ç¤º',
            'defaultType' => 'auto_generate'
        ],

        // å°ºå¯¸å’Œé‡é‡å±æ€§ï¼ˆV5.0ä¸­éå¸¸é‡è¦ï¼ŒåŒ…å«measureå’Œunitï¼‰
        [
            'attributeName' => 'assembledProductLength',
            'isrequired' => false,
            'description' => 'ç»„è£…åäº§å“é•¿åº¦ - åŒ…å«æ•°å€¼å’Œå•ä½',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'assembledProductLengthUnit',
            'isrequired' => false,
            'description' => 'ç»„è£…åäº§å“é•¿åº¦å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['mm', 'ft', 'cm', 'in']
        ],
        [
            'attributeName' => 'assembledProductWidth',
            'isrequired' => false,
            'description' => 'ç»„è£…åäº§å“å®½åº¦ - åŒ…å«æ•°å€¼å’Œå•ä½',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'assembledProductWidthUnit',
            'isrequired' => false,
            'description' => 'ç»„è£…åäº§å“å®½åº¦å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['mm', 'ft', 'cm', 'in']
        ],
        [
            'attributeName' => 'assembledProductHeight',
            'isrequired' => false,
            'description' => 'ç»„è£…åäº§å“é«˜åº¦ - åŒ…å«æ•°å€¼å’Œå•ä½',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'assembledProductHeightUnit',
            'isrequired' => false,
            'description' => 'ç»„è£…åäº§å“é«˜åº¦å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['mm', 'ft', 'cm', 'in']
        ],
        [
            'attributeName' => 'assembledProductWeight',
            'isrequired' => false,
            'description' => 'ç»„è£…åäº§å“é‡é‡ - åŒ…å«æ•°å€¼å’Œå•ä½',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'assembledProductWeightUnit',
            'isrequired' => false,
            'description' => 'ç»„è£…åäº§å“é‡é‡å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['kg', 'lb', 'oz']
        ],

        // è¿è¾“åŒ…è£…å°ºå¯¸å’Œé‡é‡ï¼ˆéå¸¸é‡è¦ï¼‰
        [
            'attributeName' => 'shippingWeight',
            'isrequired' => false,
            'description' => 'è¿è¾“é‡é‡ - åŒ…è£…åçš„æ€»é‡é‡',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'shippingWeightUnit',
            'isrequired' => false,
            'description' => 'è¿è¾“é‡é‡å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['kg', 'lb', 'oz']
        ],
        [
            'attributeName' => 'shippingLength',
            'isrequired' => false,
            'description' => 'è¿è¾“åŒ…è£…é•¿åº¦',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'shippingLengthUnit',
            'isrequired' => false,
            'description' => 'è¿è¾“åŒ…è£…é•¿åº¦å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['mm', 'ft', 'cm', 'in']
        ],
        [
            'attributeName' => 'shippingWidth',
            'isrequired' => false,
            'description' => 'è¿è¾“åŒ…è£…å®½åº¦',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'shippingWidthUnit',
            'isrequired' => false,
            'description' => 'è¿è¾“åŒ…è£…å®½åº¦å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['mm', 'ft', 'cm', 'in']
        ],
        [
            'attributeName' => 'shippingHeight',
            'isrequired' => false,
            'description' => 'è¿è¾“åŒ…è£…é«˜åº¦',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'shippingHeightUnit',
            'isrequired' => false,
            'description' => 'è¿è¾“åŒ…è£…é«˜åº¦å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['mm', 'ft', 'cm', 'in']
        ],

        // äº§å“å†…å®¹å±æ€§ï¼ˆåŒ…å«measureå’Œunitï¼‰
        [
            'attributeName' => 'productNetContentMeasure',
            'isrequired' => false,
            'description' => 'å‡€å«é‡æ•°å€¼ - äº§å“å‡€å«é‡çš„æ•°å€¼éƒ¨åˆ†',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'productNetContentUnit',
            'isrequired' => false,
            'description' => 'å‡€å«é‡å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Count', 'Inch', 'Pint', 'Liter', 'Gallon', 'Ounce', 'Pound', 'Fluid Ounces', 'Each']
        ],
        [
            'attributeName' => 'netContentStatement',
            'isrequired' => false,
            'description' => 'å‡€å«é‡å£°æ˜ - å®Œæ•´çš„å‡€å«é‡æè¿°',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'netContent',
            'isrequired' => true,
            'description' => 'å‡€å«é‡ (å¿…å¡«ï¼šåœ¨æ²ƒå°”ç›é”€å”®)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'sell'
        ],

        // åŸºæœ¬äº§å“å±æ€§
        [
            'attributeName' => 'size',
            'isrequired' => false,
            'description' => 'å°ºå¯¸ - æœ€å¤š500å­—ç¬¦',
            'defaultType' => 'wc_attribute'
        ],
        [
            'attributeName' => 'color',
            'isrequired' => false,
            'description' => 'é¢œè‰²',
            'defaultType' => 'wc_attribute'
        ],
        [
            'attributeName' => 'material',
            'isrequired' => false,
            'description' => 'æè´¨',
            'defaultType' => 'wc_attribute'
        ],
        [
            'attributeName' => 'manufacturer',
            'isrequired' => false,
            'description' => 'åˆ¶é€ å•†',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'modelNumber',
            'isrequired' => false,
            'description' => 'å‹å·',
            'defaultType' => 'wc_attribute'
        ],

        // ä¿ä¿®ç›¸å…³å±æ€§ï¼ˆV5.0ä¸­é‡è¦ï¼‰
        [
            'attributeName' => 'has_written_warranty',
            'isrequired' => true,
            'description' => 'æ˜¯å¦æœ‰ä¹¦é¢ä¿ä¿® - Yes - Warranty Text / Yes - Warranty URL / No (å¿…å¡«ï¼šåœ¨æ²ƒå°”ç›é”€å”®)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes - Warranty Text', 'Yes - Warranty URL', 'No'],
            'requiredLevel' => 'sell'
        ],
        [
            'attributeName' => 'warrantyText',
            'isrequired' => false,
            'description' => 'ä¿ä¿®æ–‡æœ¬ - å½“has_written_warrantyä¸º"Yes - Warranty Text"æ—¶å¿…å¡«',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'warrantyURL',
            'isrequired' => false,
            'description' => 'ä¿ä¿®URL - å½“has_written_warrantyä¸º"Yes - Warranty URL"æ—¶å¿…å¡«',
            'defaultType' => 'default_value'
        ],

        // åŠ å·65å·ææ¡ˆè­¦å‘Šï¼ˆV5.0ä¸­é‡è¦ï¼‰
        [
            'attributeName' => 'isProp65WarningRequired',
            'isrequired' => true,
            'description' => 'æ˜¯å¦éœ€è¦åŠ å·65å·ææ¡ˆè­¦å‘Š - Yes/No (å¿…å¡«ï¼šåœ¨æ²ƒå°”ç›é”€å”®)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'sell'
        ],
        [
            'attributeName' => 'prop65WarningText',
            'isrequired' => false,
            'description' => 'åŠ å·65å·ææ¡ˆè­¦å‘Šæ–‡æœ¬ - å½“isProp65WarningRequiredä¸º"Yes"æ—¶å¿…å¡«',
            'defaultType' => 'default_value'
        ],

        // æ›´å¤šV5.0é€šç”¨å±æ€§
        [
            'attributeName' => 'condition',
            'isrequired' => true,
            'description' => 'å•†å“çŠ¶æ€ (å¿…å¡«ï¼šåœ¨æ²ƒå°”ç›é”€å”®)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['New', 'Open Box'],
            'requiredLevel' => 'sell'
        ],
        [
            'attributeName' => 'countryOfOrigin',
            'isrequired' => false,
            'description' => 'åŸäº§å›½',
            'defaultType' => 'default_value'
        ],

        // ä»·æ ¼ç›¸å…³å±æ€§ï¼ˆæ²ƒå°”ç›ä½¿ç”¨USDï¼‰
        [
            'attributeName' => 'currency',
            'isrequired' => false,
            'description' => 'è´§å¸å•ä½ - æ²ƒå°”ç›ä¸»è¦ä½¿ç”¨ç¾å…ƒ',
            'defaultType' => 'walmart_field',
            'enumValues' => ['USD']
        ],
        [
            'attributeName' => 'pricePerUnit',
            'isrequired' => false,
            'description' => 'å•ä½ä»·æ ¼ - ç”¨äºè®¡ç®—å•ä½ä»·æ ¼çš„æ•°å€¼',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'pricePerUnitUom',
            'isrequired' => false,
            'description' => 'å•ä½ä»·æ ¼çš„è®¡é‡å•ä½',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Each', 'Ounce', 'Pound', 'Gallon', 'Liter', 'Count', 'Cubic Foot', 'Square Foot']
        ],
        [
            'attributeName' => 'msrp',
            'isrequired' => false,
            'description' => 'å»ºè®®é›¶å”®ä»·',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'minimumAdvertisedPrice',
            'isrequired' => false,
            'description' => 'æœ€ä½å¹¿å‘Šä»·æ ¼',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'shelfLife',
            'isrequired' => false,
            'description' => 'ä¿è´¨æœŸ',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'ingredients',
            'isrequired' => false,
            'description' => 'æˆåˆ†åˆ—è¡¨',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'nutritionFacts',
            'isrequired' => false,
            'description' => 'è¥å…»æˆåˆ†',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'allergenInfo',
            'isrequired' => false,
            'description' => 'è¿‡æ•åŸä¿¡æ¯',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'instructions',
            'isrequired' => false,
            'description' => 'ä½¿ç”¨è¯´æ˜',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'safetyWarning',
            'isrequired' => false,
            'description' => 'å®‰å…¨è­¦å‘Š',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'certifications',
            'isrequired' => false,
            'description' => 'è®¤è¯ä¿¡æ¯ - å¦‚USDA Organic, FDAç­‰',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'sportsLeague',
            'isrequired' => false,
            'description' => 'ä½“è‚²è”ç›Ÿ - NFL, NBA, MLBç­‰',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'sportsTeam',
            'isrequired' => false,
            'description' => 'ä½“è‚²é˜Ÿä¼',
            'defaultType' => 'default_value'
        ],
        [
            'attributeName' => 'theme',
            'isrequired' => false,
            'description' => 'ä¸»é¢˜',
            'defaultType' => 'wc_attribute'
        ],
        [
            'attributeName' => 'occasion',
            'isrequired' => false,
            'description' => 'é€‚ç”¨åœºåˆ',
            'defaultType' => 'default_value'
        ],

        // æ›´å¤šåŸºäºV5.0è§„èŒƒçš„çœŸå®å±æ€§
        [
            'attributeName' => 'countPerPack',
            'isrequired' => false,
            'description' => 'æ¯åŒ…æ•°é‡ - æ•´æ•°ï¼Œæœ€å°å€¼0',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'manufacturerPartNumber',
            'isrequired' => false,
            'description' => 'åˆ¶é€ å•†é›¶ä»¶å·',
            'defaultType' => 'wc_attribute'
        ],
        [
            'attributeName' => 'multipackQuantity',
            'isrequired' => false,
            'description' => 'å¤šåŒ…è£…æ•°é‡ - æ•´æ•°ï¼Œæœ€å°å€¼0',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'pieceCount',
            'isrequired' => false,
            'description' => 'ä»¶æ•°',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'productLine',
            'isrequired' => false,
            'description' => 'äº§å“çº¿',
            'defaultType' => 'wc_attribute'
        ],
        [
            'attributeName' => 'count',
            'isrequired' => false,
            'description' => 'è®¡æ•°',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'variantGroupId',
            'isrequired' => false,
            'description' => 'å˜ä½“ç»„ID',
            'defaultType' => 'auto_generate'
        ],
        [
            'attributeName' => 'variantAttributeNames',
            'isrequired' => false,
            'description' => 'å˜ä½“å±æ€§åç§°',
            'defaultType' => 'walmart_field',
            'enumValues' => ['color', 'assembledProductWidth', 'multipackQuantity', 'size', 'count', 'assembledProductHeight']
        ],
        [
            'attributeName' => 'smallPartsWarnings',
            'isrequired' => false,
            'description' => 'å°é›¶ä»¶è­¦å‘Šä»£ç ',
            'defaultType' => 'walmart_field',
            'enumValues' => ['0 - No warning applicable', '5 - Choking hazard is a marble', '4 - Choking hazard balloon']
        ],
        [
            'attributeName' => 'thirdPartyAccreditationSymbolOnProductPackageCode',
            'isrequired' => false,
            'description' => 'ç¬¬ä¸‰æ–¹è®¤è¯ç¬¦å·ä»£ç ',
            'defaultType' => 'walmart_field',
            'enumValues' => ['CAC Absence of Peanut', 'For Life (Social Responsibility)', 'Certified California Sustainable Vineyard and Winery (CCSW)']
        ],
        [
            'attributeName' => 'has_storage',
            'isrequired' => false,
            'description' => 'æ˜¯å¦æœ‰å‚¨ç‰©ç©ºé—´ - Has Storage (Yes/No)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'required'
        ],
        [
            'attributeName' => 'has_trundle',
            'isrequired' => false,
            'description' => 'æ˜¯å¦åŒ…å«æ‹–æ‹‰åºŠ - Has Trundle (Yes/No)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'required'
        ],
        [
            'attributeName' => 'homeDecorStyle',
            'isrequired' => false,
            'description' => 'å®¶å±…è£…é¥°é£æ ¼ - Home Decor Style',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Mid-Century', 'Tropical', 'Eclectic', 'Glam', 'Cottage', 'Minimalist', 'Transitional', 'Rustic/Lodge', 'Scandinavian', 'Traditional', 'Victorian', 'Bohemian', 'Asian Inspired', 'Farmhouse', 'Industrial', 'French Country', 'Modern', 'Contemporary', 'Shabby Chic', 'Coastal', 'Southwestern', 'Art Deco'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'isAssemblyRequired',
            'isrequired' => false,
            'description' => 'æ˜¯å¦éœ€è¦ç»„è£… - Is Assembly Required (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'IsPreorder',
            'isrequired' => false,
            'description' => 'æ˜¯å¦ä¸ºé¢„è®¢å•†å“ - Is Preorder (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'isPrimaryVariant',
            'isrequired' => false,
            'description' => 'æ˜¯å¦ä¸ºä¸»è¦å˜ä½“ - Is Primary Variant (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'MustShipAlone',
            'isrequired' => false,
            'description' => 'æ˜¯å¦å¿…é¡»å•ç‹¬å‘è´§ - Must Ship Alone (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'numberOfDrawers',
            'isrequired' => false,
            'description' => 'æŠ½å±‰æ•°é‡ - Number of Drawers',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'numberOfShelves',
            'isrequired' => false,
            'description' => 'ææ¿æ•°é‡ - Number of Shelves',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'ProductIdUpdate',
            'isrequired' => false,
            'description' => 'æ˜¯å¦æ›´æ–°äº§å“ID - Product Id Update (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'items_included',
            'isrequired' => false,
            'description' => 'åŒ…å«ç‰©å“æ¸…å• - Items Included',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'maximumLoadWeight',
            'isrequired' => false,
            'description' => 'æœ€å¤§æ‰¿é‡ - Maximum Load Weight',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'upholstered',
            'isrequired' => true,
            'description' => 'æ˜¯å¦æœ‰è½¯å«è¦†ç›– - Upholstered (Yes/No)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'required'
        ],
        [
            'attributeName' => 'wood_type',
            'isrequired' => false,
            'description' => 'æœ¨æç±»å‹ - Wood Type',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Fir', 'Hickory', 'Elm', 'Cherry', 'Mahogany', 'Oak', 'Alder', 'Pine', 'Walnut', 'Teak', 'Rubberwood', 'Cedar', 'Birch', 'Beech', 'Poplar', 'Bamboo', 'Ash', 'Acacia', 'Rosewood', 'Maple'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'wood_tone',
            'isrequired' => false,
            'description' => 'æœ¨æè‰²è°ƒ - Wood Tone',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Red Wood', 'White Wood', 'Gray Wood', 'Medium Wood', 'Espresso Wood', 'Light Wood'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'profile',
            'isrequired' => false,
            'description' => 'äº§å“è½®å»“ç±»å‹ - Profile',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Standard Profile', 'Low Profile', 'High Profile'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'shipsInOriginalPackaging',
            'isrequired' => false,
            'description' => 'æ˜¯å¦å¯ä»¥åŸåŒ…è£…å‘è´§ - Ships in Original Packaging (Yes/No)',
            'defaultType' => 'walmart_field',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'optional'
        ],
        [
            'attributeName' => 'theme',
            'isrequired' => false,
            'description' => 'äº§å“ä¸»é¢˜ - Theme (å¦‚ï¼šBeach, Animal, Space, Retroç­‰)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'arm_style',
            'isrequired' => false,
            'description' => 'æ‰¶æ‰‹é£æ ¼ - Arm Style',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Flared Arms', 'Round Arms', 'Recessed Arms', 'Armless', 'Square Arms'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'frameColor',
            'isrequired' => false,
            'description' => 'æ¡†æ¶é¢œè‰² - Frame Color (å¦‚ï¼šWhite, Black, Grayç­‰)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'chair_style',
            'isrequired' => false,
            'description' => 'æ¤…å­é£æ ¼ - Chair Style',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Butterfly', 'Ghost', 'Wingback', 'Sling', 'Convertible', 'Club', 'Armchair', 'Balloon', 'Papasan', 'Side Chair', 'Chair-and-a-Half', 'Barcelona', 'Slipper', 'Scoop', 'Director\'s', 'Bergere', 'Barrel', 'Egg', 'Chesterfield'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'frameMaterial',
            'isrequired' => false,
            'description' => 'æ¡†æ¶æè´¨ - Frame Material (æ•°ç»„æ ¼å¼)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'ottoman_included',
            'isrequired' => false,
            'description' => 'æ˜¯å¦åŒ…å«è„šå‡³ - Ottoman Included (Yes/No)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'pattern',
            'isrequired' => false,
            'description' => 'å›¾æ¡ˆæ ·å¼ - Pattern (æ•°ç»„æ ¼å¼)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'leg_color',
            'isrequired' => false,
            'description' => 'è…¿éƒ¨é¢œè‰² - Leg Color',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'leg_material',
            'isrequired' => false,
            'description' => 'è…¿éƒ¨æè´¨ - Leg Material',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'preset_bed_positions',
            'isrequired' => false,
            'description' => 'é¢„è®¾åºŠä½ - Preset Bed Positions (ç”µåŠ¨å¯è°ƒåºŠæ¶ä¸“ç”¨)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Zero Gravity', 'Flat', 'None', 'Anti-Snore'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'dining_chair_type',
            'isrequired' => false,
            'description' => 'é¤æ¤…ç±»å‹ - Dining Chair Type (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Dining Arm Chairs', 'Dining Side Chairs'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'fillMaterial',
            'isrequired' => false,
            'description' => 'å¡«å……ææ–™ - Fill Material (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'default_value',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_back_style',
            'isrequired' => false,
            'description' => 'æ¤…èƒŒæ ·å¼ - Seat Back Style (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Fiddle Back', 'Keyhole Back', 'Splat Back', 'Wingback', 'Ladder Back', 'Lattice Back', 'Solid Back', 'Parsons', 'Slat Back', 'Cross Back', 'Windsor'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_back_cushion_style',
            'isrequired' => false,
            'description' => 'æ¤…èƒŒåå«æ ·å¼ - Seat Back Cushion Style (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Tufted Back', 'Biscuit Back', 'Split Back', 'Loose Back', 'Tight Back', 'Sewn-Pillow Back', 'Cushion Back', 'Pillow Back'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'decorative_pillow_type',
            'isrequired' => false,
            'description' => 'è£…é¥°æ•ç±»å‹ - Decorative Pillow Type (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Bolster Pillow', 'Decorative Pillow Set', 'Floor Pillow', 'Decorative Lumbar Pillow', 'Throw Pillow'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'is_filled',
            'isrequired' => false,
            'description' => 'æ˜¯å¦å¡«å…… - Is Filled (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_back_thickness',
            'isrequired' => false,
            'description' => 'æ¤…èƒŒåšåº¦ - Seat Back Thickness (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_back_width',
            'isrequired' => false,
            'description' => 'æ¤…èƒŒå®½åº¦ - Seat Back Width (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_color',
            'isrequired' => false,
            'description' => 'åº§æ¤…é¢œè‰² - Seat Color (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_depth',
            'isrequired' => false,
            'description' => 'åº§æ¤…æ·±åº¦ - Seat Depth (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_material',
            'isrequired' => false,
            'description' => 'åº§æ¤…æè´¨ - Seat Material (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'sizeDescriptor',
            'isrequired' => false,
            'description' => 'å°ºå¯¸æè¿°ç¬¦ - Size Descriptor (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'sofa_and_loveseat_design',
            'isrequired' => true,
            'description' => 'æ²™å‘è®¾è®¡é£æ ¼ - Sofa & Loveseat Design (å¿…å¡«ï¼šäº§å“åœ¨Walmartç½‘ç«™ä¸Šå¯è§)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'required'
        ],
        [
            'attributeName' => 'sofa_bed_size',
            'isrequired' => false,
            'description' => 'æ²™å‘åºŠå°ºå¯¸ - Sofa Bed Size (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_width',
            'isrequired' => false,
            'description' => 'åº§æ¤…å®½åº¦ - Seat Width (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seatBackHeight',
            'isrequired' => false,
            'description' => 'æ¤…èƒŒé«˜åº¦ - Seat Back Height (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seatHeight',
            'isrequired' => false,
            'description' => 'åº§æ¤…é«˜åº¦ - Seat Height (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seatingCapacity',
            'isrequired' => false,
            'description' => 'åº§æ¤…å®¹é‡ - Seating Capacity (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'recommendedLocations',
            'isrequired' => false,
            'description' => 'æ¨èä½¿ç”¨ä½ç½® - Recommended Locations (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Indoor', 'Outdoor'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'cleaningCareAndMaintenance',
            'isrequired' => false,
            'description' => 'æ¸…æ´æŠ¤ç†ä¸ç»´æŠ¤ - Cleaning, Care & Maintenance (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'default_value',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'bed_frame_adjustability',
            'isrequired' => false,
            'description' => 'åºŠæ¶å¯è°ƒæ€§ - æè¿°ç”µåŠ¨å¯è°ƒåºŠæ¶çš„å¯è°ƒéƒ¨ä½ (æ¨èï¼šæé«˜æœç´¢å’Œæµè§ˆ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],

        // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µ - æ ¹æ®å­—æ®µæ‹“å±•å¼€å‘æ–‡æ¡£æ·»åŠ 
        [
            'attributeName' => 'base_style',
            'isrequired' => false,
            'description' => 'åº•åº§æ ·å¼ - Base Style (ä»æ ‡é¢˜å’Œæè¿°æå–å¯¹åº”æšä¸¾å€¼ï¼Œé»˜è®¤ï¼šStandard Legs)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Standard Legs', 'Frame', 'Double Pedestal', 'Cross Legs', 'Sled', 'Trestle', 'Star Base', 'Pedestal', 'Abstract', 'Block'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'baseColor',
            'isrequired' => false,
            'description' => 'åº•åº§é¢œè‰² - Base Color (ä»æ ‡é¢˜å’Œæè¿°æå–äº§å“åº•åº§é¢œè‰²ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨äº§å“é¢œè‰²ï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆ™ä¸ä¼ é€’æ­¤å­—æ®µ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'baseMaterial',
            'isrequired' => false,
            'description' => 'åº•åº§æè´¨ - Base Material (ä»æ ‡é¢˜å’Œæè¿°æå–äº§å“åº•åº§æè´¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©ºä¸ä¼ é€’æ­¤å­—æ®µ)',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'is_extendable',
            'isrequired' => false,
            'description' => 'æ˜¯å¦å¯æ‰©å±• - Is Extendable (ä»æ ‡é¢˜å’Œæè¿°æå–å¯¹åº”æšä¸¾å€¼ï¼Œé»˜è®¤ï¼šNo)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Yes', 'No'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'table_leaf_type',
            'isrequired' => false,
            'description' => 'æ¡Œå¶ç±»å‹ - Table Leaf Type (ä»æ ‡é¢˜å’Œæè¿°æå–å¯¹åº”æšä¸¾å€¼ï¼Œå¦‚æœç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ)',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Drop Leaf', 'Self-Storing Leaf', 'Butterfly Leaf', 'Removable Leaf'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'table_shape',
            'isrequired' => true,
            'description' => 'æ¡Œå­å½¢çŠ¶ - Table Shape (ä»æ ‡é¢˜å’Œæè¿°æå–å¯¹åº”æšä¸¾å€¼ï¼Œé»˜è®¤ï¼šFree Form) - æ•°ç»„ç±»å‹ï¼Œå¿…å¡«',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Semicircle', 'Square', 'U-Shape', 'Free Form', 'Octagon', 'Oval', 'Curved', 'Round', 'Rectangle'],
            'requiredLevel' => 'required'
        ],
        [
            'attributeName' => 'table_top__material',
            'isrequired' => false,
            'description' => 'æ¡Œé¢æè´¨ - Table Top Material (ä»æ ‡é¢˜å’Œæè¿°æå–å±æ€§å­—æ®µå€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©ºä¸ä¼ é€’æ­¤å­—æ®µ) - æ•°ç»„ç±»å‹',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'top_color',
            'isrequired' => false,
            'description' => 'é¡¶éƒ¨é¢œè‰² - Top Color (ä»æ ‡é¢˜å’Œæè¿°æå–å±æ€§å­—æ®µå€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™æå–äº§å“ä¸»ä½“é¢œè‰²) - æ•°ç»„ç±»å‹',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        // ğŸ†• é—¨æ•°é‡å­—æ®µ
        [
            'attributeName' => 'number_of_doors',
            'isrequired' => true,
            'description' => 'Number of Doors - é—¨çš„æ•°é‡ï¼Œæ•´æ•°ç±»å‹ï¼ŒèŒƒå›´0-100000000000000000',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'required'
        ],
        // ğŸ†• å±‚æ•°å­—æ®µ
        [
            'attributeName' => 'number_of_tiers',
            'isrequired' => false,
            'description' => 'Number of Tiers - å±‚æ•°æˆ–çº§æ•°ï¼Œæ•´æ•°ç±»å‹ï¼ŒèŒƒå›´0-10000000000',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],

        // ğŸ†• æ¡Œå­ç›¸å…³å­—æ®µ
        [
            'attributeName' => 'table_color',
            'isrequired' => false,
            'description' => 'Table Color - æ¡Œå­é¢œè‰²ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œæœ€å¤§80å­—ç¬¦',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'table_top_type',
            'isrequired' => false,
            'description' => 'Table Top Type - æ¡Œé¢ç±»å‹',
            'defaultType' => 'auto_generate',
            'enumValues' => ['Tray Top', 'Lift Top'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'tableHeight',
            'isrequired' => false,
            'description' => 'Table Height - æ¡Œå­é«˜åº¦ï¼Œæµ‹é‡å¯¹è±¡æ ¼å¼',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],

        // ğŸ†• æŸœä½“ç›¸å…³å­—æ®µ - æ ¹æ®å­—æ®µæ‹“å±•å¼€å‘æ–‡æ¡£æ·»åŠ 
        [
            'attributeName' => 'cabinet_color',
            'isrequired' => false,
            'description' => 'Cabinet Color - æŸœä½“é¢œè‰²ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œæœ€å¤§80å­—ç¬¦',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'cabinet_material',
            'isrequired' => false,
            'description' => 'Cabinet Material - æŸœä½“æè´¨ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œæœ€å¤§400å­—ç¬¦',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'hardwareFinish',
            'isrequired' => false,
            'description' => 'Hardware Finish - äº”é‡‘è¡¨é¢å¤„ç†ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œæœ€å¤§4000å­—ç¬¦',
            'defaultType' => 'auto_generate',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'recommendedRooms',
            'isrequired' => false,
            'description' => 'Recommended Rooms - æ¨èæˆ¿é—´ï¼Œå¤šé€‰æ•°ç»„ç±»å‹',
            'defaultType' => 'auto_generate',
            'enumValues' => [
                'Entertainment Room', 'Bathroom', 'Living Room', 'Reception', 'Closet', 'Under the Bed', 'Lounge', 'Home Office', 'Dining Room', 'Utility Room', 'Waiting Room', 'Conference Room', 'Work Shop', 'Hallway', 'Playroom', 'Cellar', 'Dorm Room', 'Kid Room', 'Game Room', 'Gym', 'Studio', 'Basement', 'Mudroom', 'Home Theater', 'Kitchen', 'Classroom', 'Kids Room', 'Multi-room', 'Daycare', 'Family Room', 'Poolside', 'Garage', 'Den', 'Outdoors', 'Laundry', 'Patio', 'Loft', 'Linen Closet', 'Breakroom', 'Shed', 'Commercial Office', 'Carport', 'Recreation Room', 'Office', 'Attic', 'Entryway', 'Pantry', 'Sunroom', 'Nursery', 'Greenhouse', 'Bedroom', 'Laundry Room', 'Under-Bed', 'Cubicle'
            ],
            'requiredLevel' => 'recommended'
        ],

        // ğŸ†• åˆ†ç±»ç‰¹å®šfeatureså­—æ®µ - ä½¿ç”¨åˆ†ç±»IDåŒ¹é…
        [
            'attributeName' => 'features',
            'isrequired' => false,
            'description' => 'Additional Features - äº§å“é™„åŠ ç‰¹æ€§ï¼Œæ ¹æ®åˆ†ç±»IDåŠ¨æ€åŒ¹é…æšä¸¾å€¼',
            'defaultType' => 'auto_generate',
            'category_specific' => true, // æ ‡è®°ä¸ºåˆ†ç±»ç‰¹å®šå­—æ®µ
            'requiredLevel' => 'recommended'
        ],

        // ğŸ†• é€šç”¨å­—æ®µæ‹“å±• - 2025-10-12
        [
            'attributeName' => 'frame_finish',
            'isrequired' => false,
            'description' => 'Frame Finish - æ¡†æ¶è¡¨é¢å¤„ç†ï¼Œä»äº§å“æè¿°æå–æˆ–ä½¿ç”¨äº§å“é¢œè‰²',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'handle_width',
            'isrequired' => false,
            'description' => 'Handle Width - æŠŠæ‰‹å®½åº¦ï¼Œä»äº§å“æè¿°æå–æˆ–é»˜è®¤1 in',
            'defaultType' => 'auto_generate',
            'group' => 'Dimensions',
            'allowed_units' => ['cm', 'in'],
            'default_unit' => 'in',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'handleMaterial',
            'isrequired' => false,
            'description' => 'Handle Material - æŠŠæ‰‹æè´¨ï¼Œä»äº§å“æè¿°æå–',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'kitchen_serving_and_storage_cart_type',
            'isrequired' => true,
            'description' => 'Kitchen Serving & Storage Cart Type - å¨æˆ¿æ¨è½¦ç±»å‹ï¼Œä»äº§å“æè¿°æå–æˆ–é»˜è®¤Serving Cart',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'enumValues' => ['Serving Cart', 'Bar Cart'],
            'requiredLevel' => 'visible'
        ],
        [
            'attributeName' => 'numberOfHooks',
            'isrequired' => false,
            'description' => 'Number of Hooks - æŒ‚é’©æ•°é‡ï¼Œä»äº§å“æè¿°æå–æˆ–é»˜è®¤0',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'numberOfWheels',
            'isrequired' => false,
            'description' => 'Number of Wheels - è½®å­æ•°é‡ï¼Œä»äº§å“æè¿°æå–æˆ–é»˜è®¤0',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'topMaterial',
            'isrequired' => false,
            'description' => 'Top Material - é¡¶éƒ¨æè´¨ï¼Œä»äº§å“æè¿°æå–',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'requiredLevel' => 'recommended'
        ],

        // ğŸ†• é€šç”¨å­—æ®µæ‹“å±• - 2025-10-12 (ç¬¬äºŒæ‰¹)
        [
            'attributeName' => 'dining_furniture_set_type',
            'isrequired' => false,
            'description' => 'Dining Furniture Set Type - é¤å…å®¶å…·å¥—è£…ç±»å‹ï¼Œä»äº§å“æè¿°æå–æˆ–é»˜è®¤Dining Table with Chair',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'enumValues' => ['Dining Table with Bench', 'Dining Nook', 'Pub Table Set', 'Dining Table with Chair', 'Dining Table with Bench and Chair'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'overall_chair_depth',
            'isrequired' => false,
            'description' => 'Overall Chair Depth - æ¤…å­æ•´ä½“æ·±åº¦ï¼Œä»äº§å“æè¿°æå–',
            'defaultType' => 'auto_generate',
            'group' => 'Dimensions',
            'allowed_units' => ['in'],
            'default_unit' => 'in',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'overall_chair_height',
            'isrequired' => false,
            'description' => 'Overall Chair Height - æ¤…å­æ•´ä½“é«˜åº¦ï¼Œä»äº§å“æè¿°æå–',
            'defaultType' => 'auto_generate',
            'group' => 'Dimensions',
            'allowed_units' => ['in'],
            'default_unit' => 'in',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'overall_chair_width',
            'isrequired' => false,
            'description' => 'Overall Chair Width - æ¤…å­æ•´ä½“å®½åº¦ï¼Œä»äº§å“æè¿°æå–',
            'defaultType' => 'auto_generate',
            'group' => 'Dimensions',
            'allowed_units' => ['in'],
            'default_unit' => 'in',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seat_back_height_descriptor',
            'isrequired' => false,
            'description' => 'Seat Back Height Descriptor - åº§æ¤…é èƒŒé«˜åº¦æè¿°ï¼Œä»äº§å“æè¿°æå–',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'enumValues' => ['Mid Back', 'High Back', 'Low Back'],
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'seating_capacity_with_leaf',
            'isrequired' => false,
            'description' => 'Seating Capacity with Leaf - å¸¦æ‰©å±•å¶æ¿çš„åº§ä½å®¹é‡ï¼Œä»äº§å“æè¿°æå–æˆ–é»˜è®¤1',
            'defaultType' => 'auto_generate',
            'group' => 'Visible',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'table_length',
            'isrequired' => false,
            'description' => 'Table Length - æ¡Œå­é•¿åº¦ï¼Œä»äº§å“æè¿°æå–æˆ–é»˜è®¤1 in',
            'defaultType' => 'auto_generate',
            'group' => 'Dimensions',
            'allowed_units' => ['ft', 'cm', 'in'],
            'default_unit' => 'ft',
            'requiredLevel' => 'recommended'
        ],
        [
            'attributeName' => 'table_width',
            'isrequired' => false,
            'description' => 'Table Width - æ¡Œå­å®½åº¦ï¼Œä»äº§å“æè¿°æå–æˆ–é»˜è®¤1 in',
            'defaultType' => 'auto_generate',
            'group' => 'Dimensions',
            'allowed_units' => ['ft', 'cm', 'in'],
            'default_unit' => 'ft',
            'requiredLevel' => 'recommended'
        ]
    ];

    $attributes = array_merge($v5_core_attributes, $v5_common_attributes);

    // æ ¹æ®åˆ†ç±»æ·»åŠ ç‰¹å®šå±æ€§ï¼ˆåŸºäºV5.0è§„èŒƒä¸­çš„å®é™…åˆ†ç±»ï¼‰
    $category_lower = strtolower($category_name);

    // å®¶å±…è£…é¥°å’Œå¨æˆ¿ç”¨å“ (Home Decor, Kitchen, & Other)
    if (strpos($category_lower, 'home') !== false ||
        strpos($category_lower, 'kitchen') !== false ||
        strpos($category_lower, 'decor') !== false ||
        strpos($category_lower, 'other') !== false) {

        $home_kitchen_attrs = [
            [
                'attributeName' => 'assemblyRequired',
                'isrequired' => false,
                'description' => 'æ˜¯å¦éœ€è¦ç»„è£… - Yes/No',
                'defaultType' => 'auto_generate'
            ],
            [
                'attributeName' => 'roomType',
                'isrequired' => false,
                'description' => 'é€‚ç”¨æˆ¿é—´ç±»å‹',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'style',
                'isrequired' => false,
                'description' => 'é£æ ¼',
                'defaultType' => 'wc_attribute'
            ],
            [
                'attributeName' => 'pattern',
                'isrequired' => false,
                'description' => 'å›¾æ¡ˆ',
                'defaultType' => 'wc_attribute'
            ],
            [
                'attributeName' => 'finish',
                'isrequired' => false,
                'description' => 'è¡¨é¢å¤„ç†',
                'defaultType' => 'auto_generate'
            ],
            [
                'attributeName' => 'capacity',
                'isrequired' => false,
                'description' => 'å®¹é‡',
                'defaultType' => 'auto_generate'
            ],
            [
                'attributeName' => 'dishwasherSafe',
                'isrequired' => false,
                'description' => 'æ˜¯å¦å¯ç”¨æ´—ç¢—æœºæ¸…æ´— - Yes/No',
                'defaultType' => 'walmart_field',
                'enumValues' => ['Yes', 'No']
            ],
            [
                'attributeName' => 'microwaveSafe',
                'isrequired' => false,
                'description' => 'æ˜¯å¦å¯ç”¨å¾®æ³¢ç‚‰ - Yes/No',
                'defaultType' => 'walmart_field',
                'enumValues' => ['Yes', 'No']
            ]
        ];
        $attributes = array_merge($attributes, $home_kitchen_attrs);
    }

    // ç”µå­äº§å“åˆ†ç±»ç‰¹å®šå±æ€§
    if (strpos($category_lower, 'electronics') !== false ||
        strpos($category_lower, 'computer') !== false ||
        strpos($category_lower, 'audio') !== false ||
        strpos($category_lower, 'video') !== false) {

        $electronics_attrs = [
            [
                'attributeName' => 'batteryLife',
                'isrequired' => false,
                'description' => 'ç”µæ± å¯¿å‘½',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'connectivity',
                'isrequired' => false,
                'description' => 'è¿æ¥æ–¹å¼ - WiFi, Bluetooth, USBç­‰',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'powerSource',
                'isrequired' => false,
                'description' => 'ç”µæºç±»å‹',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'screenSize',
                'isrequired' => false,
                'description' => 'å±å¹•å°ºå¯¸',
                'defaultType' => 'auto_generate'
            ],
            [
                'attributeName' => 'resolution',
                'isrequired' => false,
                'description' => 'åˆ†è¾¨ç‡',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'operatingSystem',
                'isrequired' => false,
                'description' => 'æ“ä½œç³»ç»Ÿ',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'storageCapacity',
                'isrequired' => false,
                'description' => 'å­˜å‚¨å®¹é‡',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'ramMemory',
                'isrequired' => false,
                'description' => 'RAMå†…å­˜',
                'defaultType' => 'default_value'
            ]
        ];
        $attributes = array_merge($attributes, $electronics_attrs);
    }

    // å©´å„¿ç”¨å“åˆ†ç±»ç‰¹å®šå±æ€§ï¼ˆåŸºäºBaby Play Yardsç­‰çœŸå®è§„èŒƒï¼‰
    if (strpos($category_lower, 'baby') !== false ||
        strpos($category_lower, 'infant') !== false ||
        strpos($category_lower, 'toddler') !== false) {

        $baby_attrs = [
            // å©´å„¿ç”¨å“çš„å¿…å¡«å°ºå¯¸å±æ€§ï¼ˆåŸºäºå®˜æ–¹è§„èŒƒï¼‰
            [
                'attributeName' => 'assembledProductLength',
                'isrequired' => true,
                'description' => 'ç»„è£…åäº§å“é•¿åº¦ (å¿…å¡«ï¼šå•†å“å¯è§)',
                'defaultType' => 'auto_generate',
                'requiredLevel' => 'visible'
            ],
            [
                'attributeName' => 'assembledProductHeight',
                'isrequired' => true,
                'description' => 'ç»„è£…åäº§å“é«˜åº¦ (å¿…å¡«ï¼šå•†å“å¯è§)',
                'defaultType' => 'auto_generate',
                'requiredLevel' => 'visible'
            ],
            [
                'attributeName' => 'assembledProductWeight',
                'isrequired' => true,
                'description' => 'ç»„è£…åäº§å“é‡é‡ (å¿…å¡«ï¼šå•†å“å¯è§)',
                'defaultType' => 'auto_generate',
                'requiredLevel' => 'visible'
            ],
            [
                'attributeName' => 'assembledProductWidth',
                'isrequired' => true,
                'description' => 'ç»„è£…åäº§å“å®½åº¦ (å¿…å¡«ï¼šå•†å“å¯è§)',
                'defaultType' => 'auto_generate',
                'requiredLevel' => 'visible'
            ],
            [
                'attributeName' => 'ageGroup',
                'isrequired' => false,
                'description' => 'é€‚ç”¨å¹´é¾„ç»„ (æ¨è)',
                'defaultType' => 'walmart_field',
                'enumValues' => ['Teen', 'Tween', 'Adult', 'Child', 'Baby', 'Toddler'],
                'requiredLevel' => 'recommended'
            ],
            [
                'attributeName' => 'safetyFeatures',
                'isrequired' => false,
                'description' => 'å®‰å…¨ç‰¹æ€§ (æ¨è)',
                'defaultType' => 'walmart_field',
                'enumValues' => ['Foldable', 'Adjustable Height', 'Safety Lock'],
                'requiredLevel' => 'recommended'
            ],
            [
                'attributeName' => 'bpaFree',
                'isrequired' => false,
                'description' => 'æ˜¯å¦ä¸å«BPA - Yes/No (æ¨è)',
                'defaultType' => 'walmart_field',
                'enumValues' => ['Yes', 'No'],
                'requiredLevel' => 'recommended'
            ]
        ];
        $attributes = array_merge($attributes, $baby_attrs);
    }

    // æœè£…åˆ†ç±»ç‰¹å®šå±æ€§
    if (strpos($category_lower, 'clothing') !== false ||
        strpos($category_lower, 'apparel') !== false ||
        strpos($category_lower, 'fashion') !== false) {

        $clothing_attrs = [
            [
                'attributeName' => 'gender',
                'isrequired' => false,
                'description' => 'æ€§åˆ«åˆ†ç±» - Men, Women, Unisex',
                'defaultType' => 'walmart_field',
                'enumValues' => ['Unisex', 'Male', 'Female']
            ],
            [
                'attributeName' => 'fabricType',
                'isrequired' => false,
                'description' => 'é¢æ–™ç±»å‹',
                'defaultType' => 'wc_attribute'
            ],
            [
                'attributeName' => 'careInstructions',
                'isrequired' => false,
                'description' => 'æŠ¤ç†è¯´æ˜',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'season',
                'isrequired' => false,
                'description' => 'é€‚ç”¨å­£èŠ‚',
                'defaultType' => 'default_value'
            ],
            [
                'attributeName' => 'neckline',
                'isrequired' => false,
                'description' => 'é¢†å£ç±»å‹',
                'defaultType' => 'wc_attribute'
            ],
            [
                'attributeName' => 'sleeveLength',
                'isrequired' => false,
                'description' => 'è¢–é•¿',
                'defaultType' => 'wc_attribute'
            ]
        ];
        $attributes = array_merge($attributes, $clothing_attrs);
    }

    woo_walmart_sync_log('V5.0é™æ€å±æ€§ç”Ÿæˆå®Œæˆ', 'ä¿¡æ¯', [
        'category_name' => $category_name,
        'category_id' => $category_id,
        'total_attributes_count' => count($attributes),
        'core_attributes' => count($v5_core_attributes),
        'common_attributes' => count($v5_common_attributes),
        'category_specific_added' => count($attributes) - count($v5_core_attributes) - count($v5_common_attributes),
        'walmart_field_count' => count(array_filter($attributes, function($attr) { return $attr['defaultType'] === 'walmart_field'; }))
    ], 'å±æ€§åˆ—è¡¨å‰15ä¸ª: ' . json_encode(array_slice(array_column($attributes, 'attributeName'), 0, 15)));

    return $attributes;
}

/**
 * æ ¹æ®å±æ€§åç§°å’Œåˆ†ç±»ç¡®å®šé»˜è®¤æ˜ å°„ç±»å‹
 * @param string $attr_name å±æ€§åç§°
 * @param string $category_name åˆ†ç±»åç§°
 * @return string é»˜è®¤æ˜ å°„ç±»å‹
 */
function determine_attribute_default_type($attr_name, $category_name) {
    // æ£€æŸ¥attr_nameæ˜¯å¦ä¸ºnullæˆ–ç©º
    if (empty($attr_name) || !is_string($attr_name)) {
        return 'default_value';
    }

    $attr_lower = strtolower($attr_name);

    // å¯ä»¥è‡ªåŠ¨ç”Ÿæˆçš„å±æ€§
    $auto_generate_attrs = [
        'brand', // å“ç‰Œä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆï¼Œå…ˆä»WCå±æ€§è·å–ï¼Œæ²¡æœ‰åˆ™ç”¨Unbranded
        'keyfeatures', 'key_features', // äº§å“ç‰¹è‰²è‡ªåŠ¨ä»æè¿°å’Œæ ‡é¢˜ç”Ÿæˆ
        'shippingweight', 'shipping_weight',
        'lagtime', 'lag_time', 'fulfillmentlagtime',
        'sitestartdate', 'site_start_date', 'startdate',
        'siteenddate', 'site_end_date', 'enddate',
        'salerestrictions', 'sale_restrictions',
        'assemblyrequired', 'assembly_required',
        'dimensions', 'dimension'
    ];

    if (in_array($attr_lower, $auto_generate_attrs)) {
        return 'auto_generate';
    }

    // å¸¸è§çš„WooCommerceå±æ€§ï¼ˆé™¤äº†brandï¼Œå·²ç§»åˆ°auto_generateï¼‰
    $wc_attrs = ['color', 'size', 'material', 'style', 'gender'];
    if (in_array($attr_lower, $wc_attrs)) {
        return 'wc_attribute';
    }

    // é»˜è®¤ä½¿ç”¨é»˜è®¤å€¼
    return 'default_value';
}

// FeedçŠ¶æ€é¡µé¢
function woo_walmart_feeds_page() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'walmart_feeds';

    // å¤„ç†å„ç§æ“ä½œ
    if (isset($_POST['action'])) {
        $action = $_POST['action'];

        // æ¸…é™¤æ‰€æœ‰è®°å½•
        if ($action === 'clear_all') {
            check_admin_referer('walmart_feeds_clear_all');
            $deleted = $wpdb->query("DELETE FROM $table_name");
            echo '<div class="updated"><p>å·²æ¸…é™¤ ' . $deleted . ' æ¡åŒæ­¥è®°å½•ã€‚</p></div>';
        }

        // æ¸…é™¤æˆåŠŸè®°å½•
        elseif ($action === 'clear_success') {
            check_admin_referer('walmart_feeds_clear_success');
            $deleted = $wpdb->query("DELETE FROM $table_name WHERE status = 'PROCESSED'");
            echo '<div class="updated"><p>å·²æ¸…é™¤ ' . $deleted . ' æ¡æˆåŠŸè®°å½•ã€‚</p></div>';
        }

        // æ¸…é™¤å¤±è´¥è®°å½•
        elseif ($action === 'clear_failed') {
            check_admin_referer('walmart_feeds_clear_failed');
            $deleted = $wpdb->query("DELETE FROM $table_name WHERE status = 'ERROR'");
            echo '<div class="updated"><p>å·²æ¸…é™¤ ' . $deleted . ' æ¡å¤±è´¥è®°å½•ã€‚</p></div>';
        }

        // æ›´æ–°è¡¨ç»“æ„
        elseif ($action === 'update_table_structure') {
            check_admin_referer('walmart_feeds_update_structure');
            woo_walmart_sync_update_table_structure();
            echo '<div class="updated"><p>è¡¨ç»“æ„æ›´æ–°å®Œæˆï¼è¯·æŸ¥çœ‹åŒæ­¥æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚</p></div>';
        }

        // åˆ é™¤å•ä¸ªè®°å½•
        elseif ($action === 'delete_feed' && isset($_POST['feed_id'])) {
            check_admin_referer('walmart_feeds_action');
            $feed_id = sanitize_text_field($_POST['feed_id']);
            $deleted = $wpdb->delete($table_name, ['feed_id' => $feed_id]);
            if ($deleted) {
                echo '<div class="updated"><p>è®°å½•å·²åˆ é™¤ã€‚</p></div>';
            }
        }

        // é‡æ–°åŒæ­¥
        elseif ($action === 'resync_product' && isset($_POST['product_id'])) {
            check_admin_referer('walmart_feeds_action');
            $product_id = intval($_POST['product_id']);

            // è°ƒç”¨åŒæ­¥åŠŸèƒ½
            $sync = new Woo_Walmart_Product_Sync();
            $result = $sync->initiate_sync($product_id);

            if ($result['success']) {
                echo '<div class="updated"><p>é‡æ–°åŒæ­¥æˆåŠŸ: ' . esc_html($result['message']) . '</p></div>';
            } else {
                echo '<div class="error"><p>é‡æ–°åŒæ­¥å¤±è´¥: ' . esc_html($result['message']) . '</p></div>';
            }
        }

        // æ‰‹åŠ¨æ›´æ–°çŠ¶æ€
        elseif ($action === 'update_status' && isset($_POST['feed_id'])) {
            check_admin_referer('walmart_feeds_action');
            $feed_id = sanitize_text_field($_POST['feed_id']);

            // è°ƒç”¨çŠ¶æ€æ£€æŸ¥åŠŸèƒ½
            $sync = new Woo_Walmart_Product_Sync();
            $api_auth = new Woo_Walmart_API_Key_Auth();
            $endpoint = "/v3/feeds/{$feed_id}?includeDetails=true";
            $result = $api_auth->make_request($endpoint);

            if (!is_wp_error($result) && !empty($result['feedStatus'])) {
                $new_status = $result['feedStatus'];
                $updated = $wpdb->update(
                    $table_name,
                    [
                        'status' => $new_status,
                        'processed_at' => current_time('mysql'),
                        'api_response' => wp_json_encode($result)
                    ],
                    ['feed_id' => $feed_id]
                );

                if ($updated) {
                    echo '<div class="updated"><p>çŠ¶æ€å·²æ›´æ–°ä¸º: ' . esc_html($new_status) . '</p></div>';
                } else {
                    echo '<div class="error"><p>çŠ¶æ€æ›´æ–°å¤±è´¥ã€‚</p></div>';
                }
            } else {
                echo '<div class="error"><p>æ— æ³•è·å–æœ€æ–°çŠ¶æ€ï¼Œè¯·ç¨åé‡è¯•ã€‚</p></div>';
            }
        }

        // æ‰¹é‡æ“ä½œ
        elseif ($action === 'bulk_action' && isset($_POST['bulk_action_type']) && !empty($_POST['feed_ids'])) {
            check_admin_referer('walmart_feeds_bulk');
            $bulk_action = sanitize_text_field($_POST['bulk_action_type']);
            $feed_ids = array_map('sanitize_text_field', $_POST['feed_ids']);
            $affected = 0;

            if ($bulk_action === 'delete') {
                $placeholders = implode(',', array_fill(0, count($feed_ids), '%s'));
                $affected = $wpdb->query($wpdb->prepare("DELETE FROM $table_name WHERE feed_id IN ($placeholders)", $feed_ids));
                echo '<div class="updated"><p>å·²åˆ é™¤ ' . $affected . ' æ¡è®°å½•ã€‚</p></div>';
            }
            elseif ($bulk_action === 'resync') {
                $sync = new Woo_Walmart_Product_Sync();
                $success_count = 0;
                $error_count = 0;

                foreach ($feed_ids as $feed_id) {
                    $feed = $wpdb->get_row($wpdb->prepare("SELECT product_id FROM $table_name WHERE feed_id = %s", $feed_id));
                    if ($feed) {
                        $result = $sync->initiate_sync($feed->product_id);
                        if ($result['success']) {
                            $success_count++;
                        } else {
                            $error_count++;
                        }
                    }
                }

                echo '<div class="updated"><p>æ‰¹é‡é‡æ–°åŒæ­¥å®Œæˆï¼šæˆåŠŸ ' . $success_count . ' ä¸ªï¼Œå¤±è´¥ ' . $error_count . ' ä¸ªã€‚</p></div>';
            }
            elseif ($bulk_action === 'update_status') {
                $api_auth = new Woo_Walmart_API_Key_Auth();
                $updated_count = 0;

                foreach ($feed_ids as $feed_id) {
                    $endpoint = "/v3/feeds/{$feed_id}?includeDetails=true";
                    $result = $api_auth->make_request($endpoint);

                    if (!is_wp_error($result) && !empty($result['feedStatus'])) {
                        $new_status = $result['feedStatus'];
                        $updated = $wpdb->update(
                            $table_name,
                            [
                                'status' => $new_status,
                                'processed_at' => current_time('mysql'),
                                'api_response' => wp_json_encode($result)
                            ],
                            ['feed_id' => $feed_id]
                        );

                        if ($updated) {
                            $updated_count++;
                        }
                    }
                }

                echo '<div class="updated"><p>æ‰¹é‡çŠ¶æ€æ›´æ–°å®Œæˆï¼šæ›´æ–°äº† ' . $updated_count . ' ä¸ªè®°å½•ã€‚</p></div>';
            }
        }
    }

    // è·å–ç­›é€‰å‚æ•°
    $status_filter = isset($_GET['status']) ? sanitize_text_field($_GET['status']) : '';
    $sku_filter = isset($_GET['sku']) ? sanitize_text_field($_GET['sku']) : '';
    $per_page = 50;
    $current_page = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
    $offset = ($current_page - 1) * $per_page;

    // æ„å»ºæŸ¥è¯¢
    $where_clauses = [];
    if (!empty($status_filter)) {
        if ($status_filter === 'success') {
            $where_clauses[] = "status = 'PROCESSED'";
        } elseif ($status_filter === 'failed') {
            $where_clauses[] = "status = 'ERROR'";
        } elseif ($status_filter === 'processing') {
            $where_clauses[] = "status IN ('SUBMITTED', 'INPROGRESS')";
        }
    }

    // SKUç­›é€‰ - éœ€è¦è”æ¥äº§å“è¡¨è·å–SKU
    $join_sql = '';
    if (!empty($sku_filter)) {
        $join_sql = "LEFT JOIN {$wpdb->postmeta} pm ON f.product_id = pm.post_id AND pm.meta_key = '_sku'";
        $where_clauses[] = $wpdb->prepare("pm.meta_value LIKE %s", '%' . $wpdb->esc_like($sku_filter) . '%');
    }

    $where_sql = empty($where_clauses) ? '' : 'WHERE ' . implode(' AND ', $where_clauses);

    // ä¿®æ”¹æŸ¥è¯¢ä»¥æ”¯æŒSKUç­›é€‰
    if (!empty($sku_filter)) {
        $total_items = $wpdb->get_var("SELECT COUNT(DISTINCT f.id) FROM $table_name f $join_sql $where_sql");
        $feeds = $wpdb->get_results("SELECT DISTINCT f.* FROM $table_name f $join_sql $where_sql ORDER BY f.id DESC LIMIT $per_page OFFSET $offset");
    } else {
        $total_items = $wpdb->get_var("SELECT COUNT(*) FROM $table_name $where_sql");
        $feeds = $wpdb->get_results("SELECT * FROM $table_name $where_sql ORDER BY id DESC LIMIT $per_page OFFSET $offset");
    }

    // è·å–ç»Ÿè®¡æ•°æ®
    $stats = [
        'total' => $wpdb->get_var("SELECT COUNT(*) FROM $table_name"),
        'success' => $wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE status = 'PROCESSED'"),
        'failed' => $wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE status = 'ERROR'"),
        'processing' => $wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE status IN ('SUBMITTED', 'INPROGRESS')")
    ];

    ?>
    <div class="wrap">
        <h1>å•†å“åŒæ­¥çŠ¶æ€</h1>
        <p>è¿™é‡Œæ˜¾ç¤ºäº†æœ€è¿‘çš„åŒæ­¥ä»»åŠ¡ã€‚ç³»ç»Ÿä¼šæ¯5åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°å¤„ç†ä¸­çš„ä»»åŠ¡çŠ¶æ€ã€‚</p>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="sync-stats-cards" style="display: flex; gap: 15px; margin-bottom: 20px;">
            <div class="stats-card" style="background: #fff; border: 1px solid #c3c4c7; border-radius: 4px; padding: 15px; flex: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 14px; color: #646970;">æ€»è®¡</h3>
                <p style="margin: 0; font-size: 20px; font-weight: 600; color: #2271b1;"><?php echo number_format($stats['total']); ?></p>
            </div>
            <div class="stats-card" style="background: #fff; border: 1px solid #c3c4c7; border-radius: 4px; padding: 15px; flex: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 14px; color: #646970;">æˆåŠŸ</h3>
                <p style="margin: 0; font-size: 20px; font-weight: 600; color: #00a32a;"><?php echo number_format($stats['success']); ?></p>
            </div>
            <div class="stats-card" style="background: #fff; border: 1px solid #c3c4c7; border-radius: 4px; padding: 15px; flex: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 14px; color: #646970;">å¤±è´¥</h3>
                <p style="margin: 0; font-size: 20px; font-weight: 600; color: #d63638;"><?php echo number_format($stats['failed']); ?></p>
            </div>
            <div class="stats-card" style="background: #fff; border: 1px solid #c3c4c7; border-radius: 4px; padding: 15px; flex: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 14px; color: #646970;">å¤„ç†ä¸­</h3>
                <p style="margin: 0; font-size: 20px; font-weight: 600; color: #f0ad4e;"><?php echo number_format($stats['processing']); ?></p>
            </div>
        </div>

        <!-- ç­›é€‰å’Œæ“ä½œæ  -->
        <div class="tablenav top" style="margin-bottom: 10px;">
            <div class="alignleft actions">
                <!-- ç­›é€‰è¡¨å• -->
                <form method="get" style="display: inline-block; margin-right: 10px;">
                    <input type="hidden" name="page" value="<?php echo esc_attr($_GET['page'] ?? 'woo-walmart-feeds'); ?>">

                    <!-- çŠ¶æ€ç­›é€‰ -->
                    <select name="status" style="margin-right: 5px;">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="success" <?php selected($status_filter, 'success'); ?>>æˆåŠŸ</option>
                        <option value="failed" <?php selected($status_filter, 'failed'); ?>>å¤±è´¥</option>
                        <option value="processing" <?php selected($status_filter, 'processing'); ?>>å¤„ç†ä¸­</option>
                    </select>

                    <!-- SKUç­›é€‰ -->
                    <input type="text" name="sku" value="<?php echo esc_attr($sku_filter); ?>"
                           placeholder="è¾“å…¥SKUæœç´¢..." style="width: 150px; margin-right: 5px;">

                    <input type="submit" class="button" value="ç­›é€‰">

                    <?php if (!empty($status_filter) || !empty($sku_filter)) : ?>
                        <a href="<?php echo admin_url('admin.php?page=' . esc_attr($_GET['page'] ?? 'woo-walmart-feeds')); ?>"
                           class="button" style="margin-left: 5px;">æ¸…é™¤ç­›é€‰</a>
                    <?php endif; ?>
                </form>

                <!-- æ¸…é™¤æ“ä½œ -->
                <div class="clear-actions" style="display: inline-block;">
                    <form method="post" style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿ')">
                        <?php wp_nonce_field('walmart_feeds_clear_all'); ?>
                        <input type="hidden" name="action" value="clear_all">
                        <input type="submit" class="button" value="æ¸…é™¤å…¨éƒ¨">
                    </form>
                    <form method="post" style="display: inline; margin-left: 5px;" onsubmit="return confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æˆåŠŸè®°å½•å—ï¼Ÿ')">
                        <?php wp_nonce_field('walmart_feeds_clear_success'); ?>
                        <input type="hidden" name="action" value="clear_success">
                        <input type="submit" class="button" value="æ¸…é™¤æˆåŠŸ">
                    </form>
                    <form method="post" style="display: inline; margin-left: 5px;" onsubmit="return confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¤±è´¥è®°å½•å—ï¼Ÿ')">
                        <?php wp_nonce_field('walmart_feeds_clear_failed'); ?>
                        <input type="hidden" name="action" value="clear_failed">
                        <input type="submit" class="button" value="æ¸…é™¤å¤±è´¥">
                    </form>
                    <form method="post" style="display: inline; margin-left: 10px;" onsubmit="return confirm('ç¡®å®šè¦æ›´æ–°æ•°æ®åº“è¡¨ç»“æ„å—ï¼Ÿè¿™å°†æ·»åŠ ç¼ºå¤±çš„å­—æ®µã€‚')">
                        <?php wp_nonce_field('walmart_feeds_update_structure'); ?>
                        <input type="hidden" name="action" value="update_table_structure">
                        <input type="submit" class="button button-secondary" value="ğŸ”§ ä¿®å¤è¡¨ç»“æ„">
                    </form>
                </div>
            </div>
            <div style="clear: both;"></div>
        </div>

        <!-- æ‰¹é‡æ“ä½œè¡¨å• -->
        <form method="post" id="feeds-bulk-form">
            <?php wp_nonce_field('walmart_feeds_bulk'); ?>
            <input type="hidden" name="action" value="bulk_action">

            <!-- æ‰¹é‡æ“ä½œæ  -->
            <div class="tablenav top" style="margin-bottom: 10px;">
                <div class="alignleft actions">
                    <select name="bulk_action_type" id="bulk-action-selector">
                        <option value="">æ‰¹é‡æ“ä½œ</option>
                        <option value="delete">åˆ é™¤</option>
                        <option value="resync">é‡æ–°åŒæ­¥</option>
                        <option value="update_status">æ›´æ–°çŠ¶æ€</option>
                    </select>
                    <input type="submit" class="button action" value="åº”ç”¨" onclick="return confirmBulkAction()">
                </div>
                <div class="alignright">
                    <span id="selected-count" style="color: #646970;">å·²é€‰æ‹© 0 é¡¹</span>
                </div>
                <div style="clear: both;"></div>
            </div>

            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="select-all-feeds"></th>
                        <th style="width: 180px;">Feed ID</th>
                        <th style="width: 120px;">SKU</th>
                        <th>å•†å“</th>
                        <th style="width: 100px;">çŠ¶æ€</th>
                        <th style="width: 120px;">æäº¤æ—¶é—´</th>
                        <th style="width: 120px;">å¤„ç†æ—¶é—´</th>
                        <th style="width: 120px;">æ“ä½œ</th>
                        <th style="width: 200px;">APIå“åº”</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($feeds)) : ?>
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #646970;">
                                <div style="font-size: 16px; margin-bottom: 10px;">ğŸ“Š</div>
                                <div>æ²¡æœ‰æ‰¾åˆ°åŒæ­¥è®°å½•</div>
                                <?php if (!empty($status_filter) || !empty($sku_filter)) : ?>
                                    <div style="margin-top: 10px;">
                                        <a href="<?php echo admin_url('admin.php?page=woo-walmart-feeds'); ?>" class="button button-secondary">æŸ¥çœ‹å…¨éƒ¨</a>
                                    </div>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php else : ?>
                        <?php foreach ($feeds as $feed) :
                            // è·å–äº§å“SKU
                            $product = wc_get_product($feed->product_id);
                            $product_sku = $product ? $product->get_sku() : '';
                        ?>
                            <tr>
                                <td><input type="checkbox" name="feed_ids[]" value="<?php echo esc_attr($feed->feed_id); ?>" class="feed-checkbox"></td>
                                <td>
                                    <strong style="font-family: 'Courier New', monospace; font-size: 12px;">
                                        <?php echo esc_html(substr($feed->feed_id, 0, 18)) . '...'; ?>
                                    </strong>
                                </td>
                                <td>
                                    <?php if (!empty($product_sku)) : ?>
                                        <strong style="font-family: 'Courier New', monospace; font-size: 12px; color: #2271b1;">
                                            <?php echo esc_html($product_sku); ?>
                                        </strong>
                                    <?php else : ?>
                                        <span style="color: #d63638; font-size: 11px;">æ— SKU</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <a href="<?php echo esc_url(get_edit_post_link($feed->product_id)); ?>" target="_blank">
                                        <?php echo esc_html(get_the_title($feed->product_id)); ?>
                                        <span class="dashicons dashicons-external" style="font-size: 12px;"></span>
                                    </a>
                                    <div style="color: #646970; font-size: 12px;">ID: <?php echo esc_html($feed->product_id); ?></div>
                                </td>
                                <td>
                                    <?php
                                    $status = esc_html($feed->status);
                                    $status_class = '';
                                    $status_text = $status;

                                    switch ($status) {
                                        case 'PROCESSED':
                                            $status_class = 'success';
                                            $status_text = 'æˆåŠŸ';
                                            break;
                                        case 'ERROR':
                                            $status_class = 'error';
                                            $status_text = 'å¤±è´¥';
                                            break;
                                        case 'SUBMITTED':
                                            $status_class = 'processing';
                                            $status_text = 'å·²æäº¤';
                                            break;
                                        case 'INPROGRESS':
                                            $status_class = 'processing';
                                            $status_text = 'å¤„ç†ä¸­';
                                            break;
                                    }
                                    ?>
                                    <span class="status-badge <?php echo $status_class; ?>" style="display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        <?php echo $status_text; ?>
                                    </span>
                                </td>
                                <td>
                                    <div style="font-size: 12px;">
                                        <?php echo esc_html(date('m-d H:i', strtotime($feed->submitted_at))); ?>
                                    </div>
                                </td>
                                <td>
                                    <div style="font-size: 12px;">
                                        <?php echo $feed->processed_at ? esc_html(date('m-d H:i', strtotime($feed->processed_at))) : '-'; ?>
                                    </div>
                                </td>
                                <td>
                                    <div class="row-actions" style="white-space: nowrap;">
                                        <?php if (in_array($feed->status, ['SUBMITTED', 'INPROGRESS'])) : ?>
                                            <button type="button" class="button button-small button-secondary single-update-status"
                                                    data-feed-id="<?php echo esc_attr($feed->feed_id); ?>"
                                                    style="margin-right: 5px;">æ›´æ–°çŠ¶æ€</button>
                                        <?php endif; ?>
                                        <?php if ($feed->status === 'ERROR') : ?>
                                            <button type="button" class="button button-small button-primary single-resync"
                                                    data-product-id="<?php echo esc_attr($feed->product_id); ?>"
                                                    style="margin-right: 5px;">é‡æ–°åŒæ­¥</button>
                                        <?php endif; ?>
                                        <button type="button" class="button button-small button-link-delete single-delete"
                                                data-feed-id="<?php echo esc_attr($feed->feed_id); ?>">åˆ é™¤</button>
                                    </div>
                                </td>
                                <td>
                                    <details style="cursor: pointer;">
                                        <summary style="font-size: 12px; color: #2271b1;">æŸ¥çœ‹è¯¦æƒ…</summary>
                                        <pre style="white-space: pre-wrap; word-break: break-all; max-height: 150px; overflow-y: auto; font-size: 11px; margin-top: 5px; background: #f9f9f9; padding: 5px; border-radius: 3px;"><?php
                                            $response_data = !empty($feed->api_response) ? json_decode($feed->api_response, true) : null;
                                            echo esc_html(print_r($response_data, true));
                                        ?></pre>
                                    </details>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </form>

        <?php
        // åˆ†é¡µé“¾æ¥
        $total_pages = ceil($total_items / $per_page);
        if ($total_pages > 1) : ?>
            <div class="tablenav bottom" style="padding: 15px 0;">
                <div class="tablenav-pages" style="float: right;">
                    <?php
                    $page_links = paginate_links([
                        'base' => add_query_arg(['paged' => '%#%', 'status' => $status_filter, 'sku' => $sku_filter]),
                        'format' => '',
                        'prev_text' => 'â€¹ ä¸Šä¸€é¡µ',
                        'next_text' => 'ä¸‹ä¸€é¡µ â€º',
                        'total' => $total_pages,
                        'current' => $current_page,
                        'type' => 'plain'
                    ]);
                    echo $page_links;
                    ?>
                </div>
                <div class="displaying-num" style="color: #646970; line-height: 32px;">
                    æ˜¾ç¤ºç¬¬ <?php echo (($current_page - 1) * $per_page + 1); ?>-<?php echo min($current_page * $per_page, $total_items); ?> é¡¹ï¼Œå…± <?php echo $total_items; ?> é¡¹
                </div>
                <div style="clear: both;"></div>
            </div>
        <?php endif; ?>
    </div>

    <style>
    .status-badge.success {
        background: #f0fdf4;
        color: #16a34a;
        border: 1px solid #bbf7d0;
    }

    .status-badge.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }

    .status-badge.processing {
        background: #fefbf2;
        color: #d97706;
        border: 1px solid #fed7aa;
    }

    .button-link-delete {
        color: #d63638 !important;
        border-color: transparent !important;
        background: transparent !important;
        font-size: 11px;
        height: auto;
        line-height: 1.4;
        padding: 2px 6px;
    }

    .button-link-delete:hover {
        color: #fff !important;
        background: #d63638 !important;
        border-color: #d63638 !important;
    }

    .sync-stats-cards .stats-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,.1);
        transition: box-shadow 0.2s ease;
    }
    </style>

    <script type="text/javascript">
    jQuery(document).ready(function($) {
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        $('#select-all-feeds').on('change', function() {
            $('.feed-checkbox').prop('checked', this.checked);
            updateSelectedCount();
        });

        // å•ä¸ªå¤é€‰æ¡†å˜åŒ–
        $('.feed-checkbox').on('change', function() {
            updateSelectedCount();

            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            var totalCheckboxes = $('.feed-checkbox').length;
            var checkedCheckboxes = $('.feed-checkbox:checked').length;

            if (checkedCheckboxes === 0) {
                $('#select-all-feeds').prop('indeterminate', false).prop('checked', false);
            } else if (checkedCheckboxes === totalCheckboxes) {
                $('#select-all-feeds').prop('indeterminate', false).prop('checked', true);
            } else {
                $('#select-all-feeds').prop('indeterminate', true);
            }
        });

        // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
        function updateSelectedCount() {
            var count = $('.feed-checkbox:checked').length;
            $('#selected-count').text('å·²é€‰æ‹© ' + count + ' é¡¹');
        }

        // å•ä¸ªæ“ä½œå¤„ç†
        // æ›´æ–°çŠ¶æ€
        $('.single-update-status').on('click', function() {
            var button = $(this);
            var feedId = button.data('feed-id');

            button.prop('disabled', true).text('æ›´æ–°ä¸­...');

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'walmart_single_update_status',
                    feed_id: feedId,
                    nonce: '<?php echo wp_create_nonce('walmart_single_action'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        alert('çŠ¶æ€æ›´æ–°æˆåŠŸ');
                        location.reload();
                    } else {
                        alert('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + (response.data || 'æœªçŸ¥é”™è¯¯'));
                        button.prop('disabled', false).text('æ›´æ–°çŠ¶æ€');
                    }
                },
                error: function() {
                    alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    button.prop('disabled', false).text('æ›´æ–°çŠ¶æ€');
                }
            });
        });

        // é‡æ–°åŒæ­¥
        $('.single-resync').on('click', function() {
            var button = $(this);
            var productId = button.data('product-id');

            if (!confirm('ç¡®å®šè¦é‡æ–°åŒæ­¥è¿™ä¸ªå•†å“å—ï¼Ÿ')) {
                return;
            }

            button.prop('disabled', true).text('åŒæ­¥ä¸­...');

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'walmart_sync_product',
                    product_id: productId,
                    nonce: '<?php echo wp_create_nonce('walmart_sync_nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        alert('é‡æ–°åŒæ­¥è¯·æ±‚å·²æäº¤');
                        location.reload();
                    } else {
                        alert('é‡æ–°åŒæ­¥å¤±è´¥: ' + (response.data && response.data.message ? response.data.message : 'æœªçŸ¥é”™è¯¯'));
                        button.prop('disabled', false).text('é‡æ–°åŒæ­¥');
                    }
                },
                error: function() {
                    alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    button.prop('disabled', false).text('é‡æ–°åŒæ­¥');
                }
            });
        });

        // åˆ é™¤
        $('.single-delete').on('click', function() {
            var button = $(this);
            var feedId = button.data('feed-id');

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }

            button.prop('disabled', true).text('åˆ é™¤ä¸­...');

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'walmart_single_delete_feed',
                    feed_id: feedId,
                    nonce: '<?php echo wp_create_nonce('walmart_single_action'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        alert('åˆ é™¤æˆåŠŸ');
                        location.reload();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (response.data || 'æœªçŸ¥é”™è¯¯'));
                        button.prop('disabled', false).text('åˆ é™¤');
                    }
                },
                error: function() {
                    alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    button.prop('disabled', false).text('åˆ é™¤');
                }
            });
        });

        // æ‰¹é‡æ“ä½œè¡¨å•æäº¤å‰éªŒè¯ - åªéªŒè¯æ‰¹é‡æ“ä½œæŒ‰é’®çš„æäº¤
        $('#feeds-bulk-form').on('submit', function(e) {
            // æ£€æŸ¥æäº¤çš„æŒ‰é’®æ˜¯å¦æ˜¯æ‰¹é‡æ“ä½œæŒ‰é’®
            var submittedButton = $(document.activeElement);
            var isBulkActionSubmit = submittedButton.hasClass('action') && submittedButton.val() === 'åº”ç”¨';

            // æ£€æŸ¥æ˜¯å¦æ˜¯å•ä¸ªæ“ä½œè¡¨å•æäº¤
            var isSingleActionSubmit = submittedButton.closest('.single-action-form').length > 0;

            // å¦‚æœæ˜¯å•ä¸ªæ“ä½œæäº¤ï¼Œç›´æ¥å…è®¸
            if (isSingleActionSubmit) {
                return true;
            }

            // å¦‚æœä¸æ˜¯æ‰¹é‡æ“ä½œæäº¤ï¼Œä¹Ÿç›´æ¥å…è®¸
            if (!isBulkActionSubmit) {
                return true;
            }

            // åªå¯¹æ‰¹é‡æ“ä½œè¿›è¡ŒéªŒè¯
            var selectedAction = $('#bulk-action-selector').val();
            var selectedCount = $('.feed-checkbox:checked').length;

            if (!selectedAction) {
                e.preventDefault();
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ‰¹é‡æ“ä½œã€‚');
                return false;
            }

            if (selectedCount === 0) {
                e.preventDefault();
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®°å½•ã€‚');
                return false;
            }

            return true;
        });
    });

    // æ‰¹é‡æ“ä½œç¡®è®¤
    function confirmBulkAction() {
        var selectedAction = document.getElementById('bulk-action-selector').value;
        var selectedCount = document.querySelectorAll('.feed-checkbox:checked').length;

        if (!selectedAction) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªæ‰¹é‡æ“ä½œã€‚');
            return false;
        }

        if (selectedCount === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®°å½•ã€‚');
            return false;
        }

        var actionText = '';
        switch(selectedAction) {
            case 'delete':
                actionText = 'åˆ é™¤';
                break;
            case 'resync':
                actionText = 'é‡æ–°åŒæ­¥';
                break;
            case 'update_status':
                actionText = 'æ›´æ–°çŠ¶æ€';
                break;
        }

        return confirm('ç¡®å®šè¦å¯¹é€‰ä¸­çš„ ' + selectedCount + ' ä¸ªè®°å½•æ‰§è¡Œ"' + actionText + '"æ“ä½œå—ï¼Ÿ');
    }
    </script>
    <?php
}

// AJAXå¤„ç†å‡½æ•°ï¼šå•ä¸ªæ›´æ–°çŠ¶æ€
add_action('wp_ajax_walmart_single_update_status', function() {
    check_ajax_referer('walmart_single_action', 'nonce');

    if (!current_user_can('manage_options')) {
        wp_die('æƒé™ä¸è¶³');
    }

    $feed_id = sanitize_text_field($_POST['feed_id']);

    global $wpdb;
    $table_name = $wpdb->prefix . 'walmart_feeds';

    // è°ƒç”¨çŠ¶æ€æ£€æŸ¥åŠŸèƒ½
    $sync = new Woo_Walmart_Product_Sync();
    $api_auth = new Woo_Walmart_API_Key_Auth();
    $endpoint = "/v3/feeds/{$feed_id}?includeDetails=true";
    $result = $api_auth->make_request($endpoint);

    if (!is_wp_error($result) && !empty($result['feedStatus'])) {
        $new_status = $result['feedStatus'];
        $updated = $wpdb->update(
            $table_name,
            [
                'status' => $new_status,
                'processed_at' => current_time('mysql'),
                'api_response' => wp_json_encode($result)
            ],
            ['feed_id' => $feed_id]
        );

        if ($updated) {
            wp_send_json_success('çŠ¶æ€å·²æ›´æ–°ä¸º: ' . $new_status);
        } else {
            wp_send_json_error('çŠ¶æ€æ›´æ–°å¤±è´¥');
        }
    } else {
        wp_send_json_error('æ— æ³•è·å–æœ€æ–°çŠ¶æ€ï¼Œè¯·ç¨åé‡è¯•');
    }
});

// AJAXå¤„ç†å‡½æ•°ï¼šå•ä¸ªåˆ é™¤Feed
add_action('wp_ajax_walmart_single_delete_feed', function() {
    check_ajax_referer('walmart_single_action', 'nonce');

    if (!current_user_can('manage_options')) {
        wp_die('æƒé™ä¸è¶³');
    }

    $feed_id = sanitize_text_field($_POST['feed_id']);

    global $wpdb;
    $table_name = $wpdb->prefix . 'walmart_feeds';

    $deleted = $wpdb->delete($table_name, ['feed_id' => $feed_id]);

    if ($deleted) {
        wp_send_json_success('è®°å½•å·²åˆ é™¤');
    } else {
        wp_send_json_error('åˆ é™¤å¤±è´¥');
    }
});

// åº“å­˜åŒæ­¥ç®¡ç†é¡µé¢
function woo_walmart_inventory_sync_page() {
    global $wpdb;
    $inventory_manager = new WooWalmartSync_Inventory_Manager();
    $result_message = '';

    // å¤„ç†æ“ä½œ
    if (isset($_POST['action'])) {
        check_admin_referer('walmart_inventory_action');

        switch ($_POST['action']) {
            case 'sync_successful_products':
                // åŒæ­¥æ‰€æœ‰æˆåŠŸå‘å¸ƒçš„å•†å“åº“å­˜
                $feeds_table = $wpdb->prefix . 'walmart_feeds';

                // è·å–æ‰€æœ‰æˆåŠŸå¤„ç†çš„å•†å“ï¼ˆPROCESSEDçŠ¶æ€ï¼‰
                $successful_products = $wpdb->get_results("
                    SELECT DISTINCT f.product_id, f.sku, f.wpid
                    FROM $feeds_table f
                    WHERE f.status = 'PROCESSED'
                    ORDER BY f.created_at DESC
                ");

                if (!empty($successful_products)) {
                    // å‡†å¤‡æ‰¹é‡åŒæ­¥æ•°æ®
                    $batch_product_data = array();
                    $skipped_count = 0;

                    foreach ($successful_products as $product_row) {
                        $product = wc_get_product($product_row->product_id);
                        if (!$product) {
                            $skipped_count++;
                            continue;
                        }

                        // ä½¿ç”¨å®é™…çš„å•†å“SKUï¼Œè€Œä¸æ˜¯æ•°æ®åº“ä¸­å¯èƒ½ä¸ºç©ºçš„SKU
                        $walmart_sku = $product->get_sku();
                        if (empty($walmart_sku)) {
                            woo_walmart_sync_log('åº“å­˜åŒæ­¥è·³è¿‡', 'è­¦å‘Š', [
                                'product_id' => $product_row->product_id,
                                'reason' => 'å•†å“SKUä¸ºç©º'
                            ], "å•†å“ {$product_row->product_id} çš„SKUä¸ºç©ºï¼Œè·³è¿‡åº“å­˜åŒæ­¥");
                            $skipped_count++;
                            continue;
                        }

                        $batch_product_data[] = array(
                            'product_id' => $product_row->product_id,
                            'walmart_sku' => $walmart_sku
                        );
                    }

                    if (!empty($batch_product_data)) {
                        // ä½¿ç”¨æ‰¹é‡åŒæ­¥æœºåˆ¶
                        $inventory_manager->sync_batch_inventory($batch_product_data);

                        $total_products = count($successful_products);
                        $valid_products = count($batch_product_data);
                        $result_message = '<div class="updated"><p>ğŸš€ æ‰¹é‡åº“å­˜åŒæ­¥å·²è§¦å‘ï¼æ€»è®¡ ' . $total_products . ' ä¸ªå•†å“ï¼Œæœ‰æ•ˆ ' . $valid_products . ' ä¸ªï¼Œè·³è¿‡ ' . $skipped_count . ' ä¸ªã€‚<br>æ‰¹é‡åŒæ­¥ä½¿ç”¨Walmart Feed APIï¼Œé¿å…é¢‘ç‡é™åˆ¶é—®é¢˜ã€‚</p></div>';
                    } else {
                        $result_message = '<div class="notice notice-warning"><p>æ²¡æœ‰æœ‰æ•ˆçš„å•†å“å¯ä»¥åŒæ­¥åº“å­˜ã€‚</p></div>';
                    }
                } else {
                    $result_message = '<div class="notice notice-info"><p>æ²¡æœ‰æ‰¾åˆ°å·²å¤„ç†çš„å•†å“ã€‚è¯·å…ˆå‘å¸ƒå•†å“åˆ°Walmartå¹¶ç­‰å¾…å¤„ç†å®Œæˆã€‚</p></div>';
                }
                break;

            case 'sync_single_product':
                // åŒæ­¥å•ä¸ªå•†å“åº“å­˜
                if (!empty($_POST['product_id'])) {
                    $product_id = intval($_POST['product_id']);
                    $product = wc_get_product($product_id);

                    if ($product) {
                        $success = $inventory_manager->sync_single_inventory($product_id, $product->get_sku());
                        if ($success) {
                            $result_message = '<div class="updated"><p>å•†å“åº“å­˜åŒæ­¥å·²è§¦å‘ï¼</p></div>';
                        } else {
                            $result_message = '<div class="error"><p>åº“å­˜åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ã€‚</p></div>';
                        }
                    } else {
                        $result_message = '<div class="error"><p>å•†å“ä¸å­˜åœ¨ã€‚</p></div>';
                    }
                }
                break;

            case 'sync_unsynced_products':
                // åŒæ­¥æœªåŒæ­¥çš„å•†å“åº“å­˜
                $feeds_table = $wpdb->prefix . 'walmart_feeds';
                $inventory_table = $wpdb->prefix . 'walmart_inventory_sync';

                // è·å–å·²å¤„ç†ä½†æœªåŒæ­¥åº“å­˜çš„å•†å“ - ä¿®å¤å…³è”é€»è¾‘
                $unsynced_products = $wpdb->get_results("
                    SELECT DISTINCT f.product_id, f.sku
                    FROM $feeds_table f
                    LEFT JOIN $inventory_table i ON f.product_id = i.product_id AND f.sku = i.walmart_sku
                    WHERE f.status = 'PROCESSED'
                    AND i.product_id IS NULL
                    ORDER BY f.created_at DESC
                ");

                if (!empty($unsynced_products)) {
                    // å‡†å¤‡æ‰¹é‡åŒæ­¥æ•°æ®
                    $batch_product_data = array();
                    $skipped_count = 0;

                    foreach ($unsynced_products as $product_row) {
                        $product = wc_get_product($product_row->product_id);
                        if (!$product) {
                            $skipped_count++;
                            continue;
                        }

                        // ä½¿ç”¨å®é™…çš„å•†å“SKU
                        $walmart_sku = $product->get_sku();
                        if (empty($walmart_sku)) {
                            woo_walmart_sync_log('åº“å­˜åŒæ­¥è·³è¿‡', 'è­¦å‘Š', [
                                'product_id' => $product_row->product_id,
                                'reason' => 'å•†å“SKUä¸ºç©º'
                            ], "å•†å“ {$product_row->product_id} çš„SKUä¸ºç©ºï¼Œè·³è¿‡åº“å­˜åŒæ­¥");
                            $skipped_count++;
                            continue;
                        }

                        $batch_product_data[] = array(
                            'product_id' => $product_row->product_id,
                            'walmart_sku' => $walmart_sku
                        );
                    }

                    if (!empty($batch_product_data)) {
                        // ä½¿ç”¨æ‰¹é‡åŒæ­¥æœºåˆ¶
                        $inventory_manager->sync_batch_inventory($batch_product_data);

                        $total_products = count($unsynced_products);
                        $valid_products = count($batch_product_data);
                        $result_message = '<div class="updated"><p>ğŸ¯ æœªåŒæ­¥å•†å“åº“å­˜åŒæ­¥å·²è§¦å‘ï¼æ€»è®¡ ' . $total_products . ' ä¸ªæœªåŒæ­¥å•†å“ï¼Œæœ‰æ•ˆ ' . $valid_products . ' ä¸ªï¼Œè·³è¿‡ ' . $skipped_count . ' ä¸ªã€‚<br>è¿™äº›å•†å“ä¹‹å‰æ²¡æœ‰è¿›è¡Œè¿‡åº“å­˜åŒæ­¥ã€‚</p></div>';
                    } else {
                        $result_message = '<div class="notice notice-warning"><p>æ²¡æœ‰æœ‰æ•ˆçš„æœªåŒæ­¥å•†å“å¯ä»¥åŒæ­¥åº“å­˜ã€‚</p></div>';
                    }
                } else {
                    $result_message = '<div class="notice notice-info"><p>ğŸ‰ å¤ªæ£’äº†ï¼æ‰€æœ‰å·²å‘å¸ƒçš„å•†å“éƒ½å·²ç»åŒæ­¥è¿‡åº“å­˜äº†ã€‚</p></div>';
                }
                break;

            case 'retry_failed':
                // é‡è¯•å¤±è´¥çš„åº“å­˜åŒæ­¥
                $inventory_manager->retry_failed_inventory_sync();
                $result_message = '<div class="updated"><p>å·²å¼€å§‹é‡è¯•å¤±è´¥çš„åº“å­˜åŒæ­¥ï¼</p></div>';
                break;

            case 'export_failed':
                // å¯¼å‡ºå¤±è´¥è®°å½•
                $csv_url = $inventory_manager->export_failed_inventory_sync();
                if ($csv_url) {
                    $result_message = '<div class="updated"><p>å¯¼å‡ºæˆåŠŸï¼<a href="' . esc_url($csv_url) . '" target="_blank">ç‚¹å‡»ä¸‹è½½CSVæ–‡ä»¶</a></p></div>';
                } else {
                    $result_message = '<div class="notice notice-info"><p>æ²¡æœ‰å¤±è´¥çš„åº“å­˜åŒæ­¥è®°å½•å¯å¯¼å‡ºã€‚</p></div>';
                }
                break;

            case 'fix_table_structure':
                // ä¿®å¤è¡¨ç»“æ„
                check_admin_referer('walmart_inventory_action');
                woo_walmart_sync_update_table_structure();
                $result_message = '<div class="updated"><p>âœ… è¡¨ç»“æ„ä¿®å¤å®Œæˆï¼WPIDå­—æ®µå·²æ·»åŠ ã€‚è¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ›´æ–°åçš„æ•°æ®ã€‚</p></div>';
                break;

            case 'fix_empty_sku':
                // ä¿®å¤ç©ºSKUè®°å½•
                check_admin_referer('walmart_inventory_action');
                $feeds_table = $wpdb->prefix . 'walmart_feeds';

                $empty_sku_records = $wpdb->get_results("
                    SELECT product_id, id
                    FROM $feeds_table
                    WHERE (sku = '' OR sku IS NULL)
                    AND product_id > 0
                ");

                $fixed_count = 0;
                foreach ($empty_sku_records as $record) {
                    $product = wc_get_product($record->product_id);
                    if ($product && $product->get_sku()) {
                        $updated = $wpdb->update(
                            $feeds_table,
                            ['sku' => $product->get_sku()],
                            ['id' => $record->id]
                        );
                        if ($updated) {
                            $fixed_count++;
                        }
                    }
                }

                $result_message = '<div class="updated"><p>âœ… SKUä¿®å¤å®Œæˆï¼å·²ä¿®å¤ ' . $fixed_count . ' ä¸ªç©ºSKUè®°å½•ã€‚</p></div>';
                break;
        }
    }

    // è·å–æˆåŠŸå‘å¸ƒçš„å•†å“ç»Ÿè®¡
    $feeds_table = $wpdb->prefix . 'walmart_feeds';
    $inventory_table = $wpdb->prefix . 'walmart_inventory_sync';

    // æ£€æŸ¥åº“å­˜åŒæ­¥è¡¨æ˜¯å¦å­˜åœ¨
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$inventory_table'") === $inventory_table;

    // è°ƒè¯•ï¼šæ£€æŸ¥è¡¨ç»“æ„å’Œæ•°æ®
    $debug_info = array();
    $debug_info['table_exists'] = $wpdb->get_var("SHOW TABLES LIKE '$feeds_table'") === $feeds_table;
    $debug_info['total_records'] = $wpdb->get_var("SELECT COUNT(*) FROM $feeds_table");
    $debug_info['submitted_records'] = $wpdb->get_var("SELECT COUNT(*) FROM $feeds_table WHERE status = 'SUBMITTED'");
    // ç§»é™¤WPIDç»Ÿè®¡ï¼Œå› ä¸ºå¯¹åº“å­˜åŒæ­¥ä¸é‡è¦
    // $debug_info['with_wpid'] = $wpdb->get_var("SELECT COUNT(*) FROM $feeds_table WHERE wpid IS NOT NULL AND wpid != ''");

    // æŸ¥è¯¢æˆåŠŸå¤„ç†çš„å•†å“ï¼ˆPROCESSEDçŠ¶æ€è¡¨ç¤ºå¤„ç†å®Œæˆï¼‰
    $successful_products_count = $wpdb->get_var("
        SELECT COUNT(DISTINCT product_id)
        FROM $feeds_table
        WHERE status = 'PROCESSED'
    ");

    // è°ƒè¯•ï¼šæ·»åŠ æ›´å¤šçŠ¶æ€ç»Ÿè®¡
    $debug_info['processed_records'] = $wpdb->get_var("SELECT COUNT(*) FROM $feeds_table WHERE status = 'PROCESSED'");
    $debug_info['error_records'] = $wpdb->get_var("SELECT COUNT(*) FROM $feeds_table WHERE status = 'ERROR'");
    $debug_info['empty_sku_records'] = $wpdb->get_var("SELECT COUNT(*) FROM $feeds_table WHERE sku = '' OR sku IS NULL");

    // ç»Ÿè®¡æœªåŒæ­¥åº“å­˜çš„å•†å“ - ä¿®å¤å…³è”é€»è¾‘
    if ($table_exists) {
        $debug_info['unsynced_products'] = $wpdb->get_var("
            SELECT COUNT(DISTINCT f.product_id)
            FROM $feeds_table f
            LEFT JOIN $inventory_table i ON f.product_id = i.product_id AND f.sku = i.walmart_sku
            WHERE f.status = 'PROCESSED'
            AND i.product_id IS NULL
        ");
    } else {
        $debug_info['unsynced_products'] = $debug_info['processed_records'];
    }

    $inventory_stats = array();
    if ($table_exists) {
        $inventory_stats = $wpdb->get_results("
            SELECT status, COUNT(*) as count
            FROM $inventory_table
            GROUP BY status
        ", ARRAY_A);
    }

    // è·å–å¤±è´¥çš„åº“å­˜åŒæ­¥è®°å½•
    $failed_items = $inventory_manager->get_failed_inventory_sync(50);

    echo $result_message;
    ?>
    <div class="wrap">
        <h1>ğŸª åº“å­˜åŒæ­¥ç®¡ç†</h1>

        <div class="notice notice-info">
            <p><strong>ğŸ“‹ åº“å­˜åŒæ­¥æµç¨‹ï¼š</strong></p>
            <ol>
                <li><strong>å•†å“å‘å¸ƒ</strong> â†’ å•†å“æˆåŠŸå‘å¸ƒåˆ°Walmartï¼ˆè·å¾—PROCESSEDçŠ¶æ€ï¼‰</li>
                <li><strong>åº“å­˜åŒæ­¥</strong> â†’ é€šè¿‡SKUå°†WooCommerceåº“å­˜åŒæ­¥åˆ°Walmart</li>
                <li><strong>çŠ¶æ€ç®¡ç†</strong> â†’ è·Ÿè¸ªåº“å­˜åŒæ­¥çŠ¶æ€å’Œé‡è¯•å¤±è´¥é¡¹</li>
            </ol>
            <p><strong>ğŸ”‘ é‡è¦ï¼š</strong>åº“å­˜åŒæ­¥ä½¿ç”¨SKUä½œä¸ºå•†å“æ ‡è¯†ç¬¦ï¼ŒWPIDæ˜¯å¯é€‰çš„å†…éƒ¨å¼•ç”¨IDã€‚</p>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <?php if (current_user_can('administrator')): ?>
        <div class="notice notice-info" style="margin: 20px 0;">
            <p><strong>ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š</strong></p>
            <ul>
                <li>è¡¨æ˜¯å¦å­˜åœ¨: <?php echo $debug_info['table_exists'] ? 'âœ… æ˜¯' : 'âŒ å¦'; ?></li>
                <li>æ€»è®°å½•æ•°: <?php echo $debug_info['total_records']; ?></li>
                <li>SUBMITTEDçŠ¶æ€è®°å½•: <?php echo $debug_info['submitted_records']; ?></li>
                <li>PROCESSEDçŠ¶æ€è®°å½•: <?php echo $debug_info['processed_records']; ?> <strong>â† å¯åŒæ­¥åº“å­˜çš„å•†å“</strong></li>
                <li>ERRORçŠ¶æ€è®°å½•: <?php echo $debug_info['error_records']; ?></li>
                <li>ç©ºSKUè®°å½•: <?php echo $debug_info['empty_sku_records']; ?> <strong>â† éœ€è¦ä¿®å¤SKUï¼ˆå½±å“åº“å­˜åŒæ­¥ï¼‰</strong></li>
                <li>æœªåŒæ­¥åº“å­˜å•†å“: <?php echo $debug_info['unsynced_products']; ?> <strong>â† ä»æœªåŒæ­¥è¿‡åº“å­˜çš„å•†å“</strong></li>
                <li>æˆåŠŸå•†å“è®¡æ•°(å»é‡): <?php echo $successful_products_count; ?> <strong>â† å®é™…å¯åŒæ­¥æ•°é‡</strong></li>
            </ul>
        </div>
        <?php endif; ?>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="walmart-stats-container">
            <div class="walmart-stat-box">
                <h3>ğŸ“Š å•†å“å‘å¸ƒç»Ÿè®¡</h3>
                <div class="stat-number"><?php echo $successful_products_count ?: 0; ?></div>
                <p>æˆåŠŸå‘å¸ƒå•†å“</p>
                <small>è¿™äº›å•†å“å¯ä»¥é€šè¿‡SKUè¿›è¡Œåº“å­˜åŒæ­¥</small>
            </div>

            <div class="walmart-stat-box">
                <h3>ğŸ¯ æœªåŒæ­¥å•†å“</h3>
                <div class="stat-number" style="color: #f56e28;"><?php echo $debug_info['unsynced_products'] ?: 0; ?></div>
                <p>ä»æœªåŒæ­¥åº“å­˜çš„å•†å“</p>
                <small>è¿™äº›å•†å“éœ€è¦è¿›è¡Œé¦–æ¬¡åº“å­˜åŒæ­¥</small>
            </div>

            <div class="walmart-stat-box">
                <h3>ğŸ“¦ åº“å­˜åŒæ­¥ç»Ÿè®¡</h3>
                <?php if (!empty($inventory_stats)): ?>
                    <?php foreach ($inventory_stats as $stat): ?>
                        <div class="stat-item">
                            <span class="stat-label">
                                <?php
                                $status_labels = [
                                    'success' => 'âœ… æˆåŠŸ',
                                    'failed' => 'âŒ å¤±è´¥',
                                    'pending' => 'â³ å¾…å¤„ç†',
                                    'retrying' => 'ğŸ”„ é‡è¯•ä¸­'
                                ];
                                echo $status_labels[$stat['status']] ?? $stat['status'];
                                ?>
                            </span>
                            <span class="stat-count"><?php echo $stat['count']; ?></span>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <div class="stat-item">
                        <span class="stat-label">æš‚æ— åº“å­˜åŒæ­¥è®°å½•</span>
                    </div>
                <?php endif; ?>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="walmart-actions-container">
            <h3>ğŸš€ åº“å­˜åŒæ­¥æ“ä½œ</h3>

            <div class="walmart-actions-grid">
                <div class="action-group">
                    <h4>æ‰¹é‡æ“ä½œ</h4>
                    <form method="post" class="action-form">
                        <input type="hidden" name="action" value="sync_successful_products">
                        <?php wp_nonce_field('walmart_inventory_action'); ?>
                        <button type="submit" class="walmart-btn walmart-btn-primary"
                                onclick="return confirm('è¿™å°†ä½¿ç”¨æ‰¹é‡Feed APIä¸ºæ‰€æœ‰æˆåŠŸå‘å¸ƒçš„å•†å“åŒæ­¥åº“å­˜ï¼Œé¿å…é¢‘ç‡é™åˆ¶é—®é¢˜ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ');">
                            ğŸš€ æ‰¹é‡åŒæ­¥æ‰€æœ‰å•†å“åº“å­˜
                        </button>
                        <p class="action-desc">ä½¿ç”¨Walmartæ‰¹é‡Feed APIåŒæ­¥åº“å­˜ï¼Œé¿å…é¢‘ç‡é™åˆ¶</p>
                    </form>

                    <form method="post" class="action-form">
                        <input type="hidden" name="action" value="sync_unsynced_products">
                        <?php wp_nonce_field('walmart_inventory_action'); ?>
                        <button type="submit" class="walmart-btn walmart-btn-primary"
                                onclick="return confirm('è¿™å°†ä¸ºä»æœªåŒæ­¥è¿‡åº“å­˜çš„å•†å“è¿›è¡Œæ‰¹é‡åº“å­˜åŒæ­¥ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ');">
                            ğŸ¯ åŒæ­¥æœªåŒæ­¥å•†å“åº“å­˜
                        </button>
                        <p class="action-desc">ä¸ºä»æœªåŒæ­¥è¿‡åº“å­˜çš„å•†å“è¿›è¡Œæ‰¹é‡åŒæ­¥</p>
                    </form>

                    <form method="post" class="action-form">
                        <input type="hidden" name="action" value="retry_failed">
                        <?php wp_nonce_field('walmart_inventory_action'); ?>
                        <button type="submit" class="walmart-btn walmart-btn-secondary"
                                onclick="return confirm('ç¡®å®šè¦é‡è¯•æ‰€æœ‰å¤±è´¥çš„åº“å­˜åŒæ­¥å—ï¼Ÿ');">
                            ğŸ” é‡è¯•å¤±è´¥é¡¹
                        </button>
                        <p class="action-desc">é‡æ–°å°è¯•ä¹‹å‰å¤±è´¥çš„åº“å­˜åŒæ­¥</p>
                    </form>
                </div>

                <div class="action-group">
                    <h4>ç®¡ç†æ“ä½œ</h4>
                    <form method="post" class="action-form">
                        <input type="hidden" name="action" value="export_failed">
                        <?php wp_nonce_field('walmart_inventory_action'); ?>
                        <button type="submit" class="walmart-btn walmart-btn-secondary">
                            ğŸ“¥ å¯¼å‡ºå¤±è´¥è®°å½•
                        </button>
                        <p class="action-desc">å¯¼å‡ºå¤±è´¥è®°å½•ä¸ºCSVæ–‡ä»¶</p>
                    </form>

                    <form method="post" class="action-form">
                        <input type="hidden" name="action" value="fix_table_structure">
                        <?php wp_nonce_field('walmart_inventory_action'); ?>
                        <button type="submit" class="walmart-btn walmart-btn-secondary"
                                onclick="return confirm('è¿™å°†ä¿®å¤æ•°æ®åº“è¡¨ç»“æ„ï¼Œæ·»åŠ ç¼ºå¤±çš„WPIDå­—æ®µï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ');">
                            ğŸ”§ ä¿®å¤è¡¨ç»“æ„
                        </button>
                        <p class="action-desc">æ·»åŠ ç¼ºå¤±çš„WPIDå­—æ®µåˆ°æ•°æ®åº“è¡¨</p>
                    </form>

                    <form method="post" class="action-form">
                        <input type="hidden" name="action" value="fix_empty_sku">
                        <?php wp_nonce_field('walmart_inventory_action'); ?>
                        <button type="submit" class="walmart-btn walmart-btn-secondary"
                                onclick="return confirm('è¿™å°†ä¿®å¤ç©ºçš„SKUè®°å½•ï¼Œä»WooCommerceå•†å“ä¸­é‡æ–°è·å–SKUï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ');">
                            ğŸ”§ ä¿®å¤ç©ºSKU
                        </button>
                        <p class="action-desc">ä¿®å¤æ•°æ®åº“ä¸­ç©ºçš„SKUè®°å½•</p>
                    </form>
                </div>

                <div class="action-group">
                    <h4>å•ä¸ªå•†å“åŒæ­¥</h4>
                    <form method="post" class="action-form single-sync-form">
                        <input type="hidden" name="action" value="sync_single_product">
                        <?php wp_nonce_field('walmart_inventory_action'); ?>
                        <div class="input-group">
                            <label for="product_id">å•†å“IDï¼š</label>
                            <input type="number" name="product_id" id="product_id" placeholder="è¾“å…¥å•†å“ID" required>
                            <button type="submit" class="walmart-btn walmart-btn-small">åŒæ­¥åº“å­˜</button>
                        </div>
                        <p class="action-desc">ä¸ºæŒ‡å®šå•†å“IDåŒæ­¥åº“å­˜</p>
                    </form>
                </div>
            </div>
        </div>

        <!-- æˆåŠŸå‘å¸ƒçš„å•†å“åˆ—è¡¨ -->
        <h2>ğŸ“¦ æˆåŠŸå‘å¸ƒçš„å•†å“ï¼ˆå¯åŒæ­¥åº“å­˜ï¼‰</h2>

        <div class="notice notice-info" style="margin: 10px 0;">
            <p><strong>ğŸ’¡ å­—æ®µè¯´æ˜ï¼š</strong></p>
            <ul>
                <li><strong>å•†å“SKU</strong>ï¼šWooCommerceå•†å“çš„SKUæ ‡è¯†ç¬¦</li>
                <li><strong>Walmart SKU</strong>ï¼šç”¨äºWalmartåº“å­˜åŒæ­¥çš„SKUï¼ˆé€šå¸¸ä¸å•†å“SKUç›¸åŒï¼‰</li>
                <li><strong>WooCommerceåº“å­˜</strong>ï¼šå½“å‰åœ¨WooCommerceä¸­çš„åº“å­˜æ•°é‡</li>
            </ul>
        </div>

        <?php
        // è·å–æˆåŠŸå¤„ç†çš„å•†å“åˆ—è¡¨
        $successful_products = $wpdb->get_results("
            SELECT f.product_id, f.sku, f.wpid, f.created_at,
                   p.post_title as product_name
            FROM $feeds_table f
            LEFT JOIN {$wpdb->posts} p ON f.product_id = p.ID
            WHERE f.status = 'PROCESSED'
            ORDER BY f.created_at DESC
            LIMIT 200
        ");

        // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ•°æ®ï¼Œå°è¯•è·å–æ‰€æœ‰è®°å½•è¿›è¡Œè°ƒè¯•
        if (empty($successful_products)) {
            $all_feeds = $wpdb->get_results("
                SELECT f.product_id, f.sku, f.wpid, f.status, f.created_at,
                       p.post_title as product_name
                FROM $feeds_table f
                LEFT JOIN {$wpdb->posts} p ON f.product_id = p.ID
                ORDER BY f.created_at DESC
                LIMIT 20
            ");
        }
        ?>

        <?php if (empty($successful_products)): ?>
            <div class="notice notice-warning">
                <p>âš ï¸ æ²¡æœ‰æ‰¾åˆ°æˆåŠŸå‘å¸ƒçš„å•†å“ã€‚</p>
                <?php if (isset($all_feeds) && !empty($all_feeds)): ?>
                    <p><strong>è°ƒè¯•ä¿¡æ¯ - æ‰¾åˆ°çš„æ‰€æœ‰Feedè®°å½•ï¼š</strong></p>
                    <table class="wp-list-table widefat">
                        <thead>
                            <tr>
                                <th>å•†å“ID</th>
                                <th>å•†å“SKU</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($all_feeds as $feed): ?>
                                <tr>
                                    <td><?php echo esc_html($feed->product_id); ?></td>
                                    <td><code><?php echo esc_html($feed->sku ?: 'æ— SKU'); ?></code></td>
                                    <td><?php echo esc_html($feed->status); ?></td>
                                    <td><?php echo esc_html($feed->created_at); ?></td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                <?php else: ?>
                    <p>æ²¡æœ‰æ‰¾åˆ°ä»»ä½•Feedè®°å½•ã€‚è¯·å…ˆå‘å¸ƒå•†å“åˆ°Walmartã€‚</p>
                <?php endif; ?>
            </div>
        <?php else: ?>
            <table class="walmart-table">
                <thead>
                    <tr>
                        <th>å•†å“ID</th>
                        <th>å•†å“åç§°</th>
                        <th>å•†å“SKU</th>
                        <th>Walmart SKU</th>
                        <th>WooCommerceåº“å­˜</th>
                        <th>å‘å¸ƒæ—¶é—´</th>
                        <th>åº“å­˜çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($successful_products as $item): ?>
                        <?php
                        $product = wc_get_product($item->product_id);
                        $wc_stock = $product ? $product->get_stock_quantity() : 'N/A';
                        if (is_null($wc_stock)) $wc_stock = 'æ— é™åˆ¶';

                        // è·å–å®é™…çš„SKUï¼ˆä¼˜å…ˆä½¿ç”¨WooCommerceä¸­çš„SKUï¼‰
                        $actual_sku = $product ? $product->get_sku() : $item->sku;
                        $display_sku = !empty($actual_sku) ? $actual_sku : ($item->sku ?: 'æ— SKU');

                        // Walmart SKUå°±æ˜¯ç”¨äºåŒæ­¥çš„SKUï¼ˆé€šå¸¸ä¸å•†å“SKUç›¸åŒï¼‰
                        $walmart_sku = $actual_sku;

                        // æ£€æŸ¥åº“å­˜åŒæ­¥çŠ¶æ€
                        $inventory_status = '';
                        if ($table_exists && !empty($walmart_sku)) {
                            $sync_record = $wpdb->get_row($wpdb->prepare("
                                SELECT status, last_sync_time
                                FROM $inventory_table
                                WHERE product_id = %d AND walmart_sku = %s
                                ORDER BY last_sync_time DESC LIMIT 1
                            ", $item->product_id, $walmart_sku));

                            if ($sync_record) {
                                $status_labels = [
                                    'success' => 'âœ… å·²åŒæ­¥',
                                    'failed' => 'âŒ å¤±è´¥',
                                    'pending' => 'â³ å¾…å¤„ç†',
                                    'retrying' => 'ğŸ”„ é‡è¯•ä¸­'
                                ];
                                $inventory_status = $status_labels[$sync_record->status] ?? $sync_record->status;
                            } else {
                                $inventory_status = 'âšª æœªåŒæ­¥';
                            }
                        } else {
                            $inventory_status = empty($walmart_sku) ? 'âŒ æ— SKU' : 'âšª æœªåŒæ­¥';
                        }
                        ?>
                        <tr>
                            <td><?php echo esc_html($item->product_id); ?></td>
                            <td>
                                <strong><?php echo esc_html($item->product_name ?: 'æœªçŸ¥å•†å“'); ?></strong>
                                <br>
                                <small>
                                    <a href="<?php echo get_edit_post_link($item->product_id); ?>" target="_blank">
                                        ç¼–è¾‘å•†å“
                                    </a>
                                </small>
                            </td>
                            <td><code><?php echo esc_html($display_sku); ?></code></td>
                            <td><code><?php echo esc_html($walmart_sku ?: 'æ— SKU'); ?></code></td>
                            <td><strong><?php echo esc_html($wc_stock); ?></strong></td>
                            <td><?php echo esc_html($item->created_at); ?></td>
                            <td><?php echo $inventory_status; ?></td>
                            <td>
                                <form method="post" style="display: inline;">
                                    <input type="hidden" name="action" value="sync_single_product">
                                    <input type="hidden" name="product_id" value="<?php echo esc_attr($item->product_id); ?>">
                                    <?php wp_nonce_field('walmart_inventory_action'); ?>
                                    <input type="submit" class="button button-small" value="åŒæ­¥åº“å­˜">
                                </form>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>

        <!-- å¤±è´¥çš„åº“å­˜åŒæ­¥è®°å½• -->
        <h2>âŒ å¤±è´¥çš„åº“å­˜åŒæ­¥è®°å½•</h2>

        <?php if (empty($failed_items)): ?>
            <div class="notice notice-success">
                <p>ğŸ‰ å¤ªæ£’äº†ï¼ç›®å‰æ²¡æœ‰å¤±è´¥çš„åº“å­˜åŒæ­¥è®°å½•ã€‚</p>
            </div>
        <?php else: ?>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th style="width: 80px;">å•†å“ID</th>
                        <th style="width: 200px;">å•†å“åç§°</th>
                        <th style="width: 120px;">SKU</th>
                        <th style="width: 80px;">åº“å­˜æ•°é‡</th>
                        <th style="width: 80px;">é‡è¯•æ¬¡æ•°</th>
                        <th style="width: 150px;">æœ€ååŒæ­¥æ—¶é—´</th>
                        <th style="width: 200px;">é”™è¯¯ä¿¡æ¯</th>
                        <th style="width: 100px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($failed_items as $item): ?>
                        <tr>
                            <td><?php echo esc_html($item['product_id']); ?></td>
                            <td>
                                <strong><?php echo esc_html($item['product_name'] ?: 'æœªçŸ¥å•†å“'); ?></strong>
                                <br>
                                <small>
                                    <a href="<?php echo get_edit_post_link($item['product_id']); ?>" target="_blank">
                                        ç¼–è¾‘å•†å“
                                    </a>
                                </small>
                            </td>
                            <td><code><?php echo esc_html($item['walmart_sku']); ?></code></td>
                            <td><?php echo esc_html($item['quantity']); ?></td>
                            <td>
                                <span class="<?php echo $item['retry_count'] >= 3 ? 'error' : 'warning'; ?>">
                                    <?php echo esc_html($item['retry_count']); ?>/3
                                </span>
                            </td>
                            <td><?php echo esc_html($item['last_sync_time']); ?></td>
                            <td>
                                <small style="color: #d63638;">
                                    <?php echo esc_html(substr($item['response_data'], 0, 80)); ?>
                                    <?php if (strlen($item['response_data']) > 80): ?>...<?php endif; ?>
                                </small>
                            </td>
                            <td>
                                <form method="post" style="display: inline;">
                                    <input type="hidden" name="action" value="sync_single_product">
                                    <input type="hidden" name="product_id" value="<?php echo esc_attr($item['product_id']); ?>">
                                    <?php wp_nonce_field('walmart_inventory_action'); ?>
                                    <input type="submit" class="button button-small" value="é‡è¯•"
                                           onclick="return confirm('ç¡®å®šè¦é‡è¯•æ­¤å•†å“çš„åº“å­˜åŒæ­¥å—ï¼Ÿ');">
                                </form>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <p><small>
                <strong>è¯´æ˜ï¼š</strong>
                é‡è¯•æ¬¡æ•°è¾¾åˆ°3æ¬¡çš„å•†å“å°†ä¸å†è‡ªåŠ¨é‡è¯•ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æˆ–å¯¼å‡ºååœ¨Walmartå¹³å°æ‰‹åŠ¨æ›´æ–°åº“å­˜ã€‚
            </small></p>
        <?php endif; ?>
    </div>

    <style>
        /* è°ƒè¯•æ ‡è®° - ç¡®ä¿CSSåŠ è½½ */
        .walmart-products-manager {
            border-top: 3px solid #00a32a !important;
        }

        /* åŸºç¡€æ ·å¼ */
        .error { color: #d63638; font-weight: bold; }
        .warning { color: #dba617; font-weight: bold; }

        /* ç»Ÿè®¡å®¹å™¨ */
        .walmart-stats-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .walmart-stat-box {
            flex: 1;
            min-width: 300px;
            background: #fff;
            border: 1px solid #c3c4c7;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .walmart-stat-box h3 {
            margin: 0 0 15px 0;
            color: #1d2327;
            font-size: 16px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #46b450;
            margin: 10px 0;
        }
		

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f1;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
        }

        .stat-count {
            font-weight: bold;
            color: #2271b1;
        }

        /* æ“ä½œå®¹å™¨ */
        .walmart-actions-container {
            background: #f9f9f9;
            border: 1px solid #c3c4c7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .walmart-actions-container h3 {
            margin: 0 0 20px 0;
            color: #1d2327;
        }

        .walmart-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .action-group {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
        }

        .action-group h4 {
            margin: 0 0 15px 0;
            color: #1d2327;
            font-size: 14px;
            font-weight: 600;
        }

        .action-form {
            margin-bottom: 15px;
        }

        .action-form:last-child {
            margin-bottom: 0;
        }

        .action-desc {
            margin: 5px 0 0 0;
            font-size: 12px;
            color: #646970;
        }

        /* æŒ‰é’®æ ·å¼ */
        .walmart-btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 5px;
        }

        .walmart-btn-primary {
            background: #2271b1;
            color: #fff;
        }

        .walmart-btn-primary:hover {
            background: #135e96;
            color: #fff;
        }

        .walmart-btn-secondary {
            background: #f6f7f7;
            color: #2c3338;
            border: 1px solid #c3c4c7;
        }

        .walmart-btn-secondary:hover {
            background: #f0f0f1;
            color: #2c3338;
        }

        .walmart-btn-info {
            background: #17a2b8;
            border: 1px solid #17a2b8;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .walmart-btn-info:hover {
            background: #138496;
            border-color: #117a8b;
            color: #fff;
        }

        .walmart-btn-warning {
            background: #f56e28;
            border: 1px solid #f56e28;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .walmart-btn-warning:hover {
            background: #e65100;
            border-color: #e65100;
            color: #fff;
        }

        .walmart-btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            margin-bottom: 0;
        }

        /* è¾“å…¥ç»„ */
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .input-group label {
            font-weight: 500;
            min-width: 80px;
        }

        .input-group input[type="number"] {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #8c8f94;
            border-radius: 4px;
        }

        /* è¡¨æ ¼æ ·å¼ - æœ€é«˜ä¼˜å…ˆçº§ */
        .wrap.walmart-products-manager .walmart-table,
        .walmart-products-manager .walmart-table,
        table.walmart-table {
            width: 100% !important;
            border-collapse: collapse !important;
            background: #fff !important;
            border: 1px solid #c3c4c7 !important;
            border-radius: 4px !important;
            overflow: hidden !important;
            table-layout: fixed !important;
            margin: 0 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
        }

        .wrap.walmart-products-manager .walmart-table th,
        .walmart-products-manager .walmart-table th,
        table.walmart-table th,
        .wrap.walmart-products-manager .walmart-table td,
        .walmart-products-manager .walmart-table td,
        table.walmart-table td {
            padding: 12px 8px !important;
            text-align: center !important;
            border-bottom: 1px solid #f0f0f1 !important;
            word-wrap: break-word !important;
            overflow: hidden !important;
            vertical-align: middle !important;
            font-size: 13px !important;
            line-height: 1.4 !important;
        }

        .wrap.walmart-products-manager .walmart-table th,
        .walmart-products-manager .walmart-table th,
        table.walmart-table th {
            background: #f6f7f7 !important;
            font-weight: 600 !important;
            color: #1d2327 !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
            border-bottom: 2px solid #c3c4c7 !important;
            text-transform: none !important;
        }

        .walmart-products-manager .walmart-table tr:hover {
            background: #f9f9f9 !important;
            transition: background-color 0.2s ease !important;
        }

        .walmart-products-manager .walmart-table tr:nth-child(even) {
            background: #fafafa !important;
        }

        .walmart-products-manager .walmart-table tr:nth-child(even):hover {
            background: #f0f8ff !important;
        }

        /* å¤é€‰æ¡†åˆ— */
        .walmart-products-manager .walmart-table td:nth-child(1),
        .walmart-products-manager .walmart-table th:nth-child(1) {
            width: 50px !important;
            text-align: center !important;
        }

        /* å•†å“åç§°åˆ— - å·¦å¯¹é½ */
        .walmart-products-manager .walmart-table td:nth-child(2) {
            text-align: left !important;
            font-weight: 500 !important;
            line-height: 1.4 !important;
            padding-left: 12px !important;
        }

        .walmart-products-manager .walmart-table th:nth-child(2) {
            text-align: left !important;
            padding-left: 12px !important;
        }

        /* SKUå’ŒUPCåˆ—æ ·å¼ */
        .walmart-products-manager .walmart-table td:nth-child(3),
        .walmart-products-manager .walmart-table td:nth-child(4) {
            font-family: Consolas, Monaco, monospace !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            background: #f8f9fa !important;
            border-radius: 3px !important;
        }

        /* ä»·æ ¼åˆ—æ ·å¼ */
        .walmart-products-manager .walmart-table td:nth-child(5) {
            font-weight: 700 !important;
            color: #00a32a !important;
            font-size: 14px !important;
        }

        /* åº“å­˜åˆ—æ ·å¼ */
        .walmart-products-manager .walmart-table td:nth-child(6) {
            font-weight: 700 !important;
            color: #2271b1 !important;
            font-size: 14px !important;
        }

        /* çŠ¶æ€åˆ—æ ·å¼ */
        .walmart-products-manager .walmart-table td:nth-child(7) {
            font-weight: 600 !important;
        }

        /* æœ€ååŒæ­¥å’Œæ“ä½œåˆ—æ ·å¼ */
        .walmart-products-manager .walmart-table td:nth-child(8),
        .walmart-products-manager .walmart-table td:nth-child(9) {
            font-size: 12px !important;
        }

        /* æ’åºæŒ‰é’®æ ·å¼ - å¢å¼ºå¯è§æ€§ */
        .wrap.walmart-products-manager .sort-header,
        .walmart-products-manager .sort-header,
        table.walmart-table .sort-header,
        .sort-header {
            cursor: pointer !important;
            user-select: none !important;
            position: relative !important;
            padding-right: 25px !important;
            transition: all 0.2s ease !important;
            border-radius: 4px !important;
        }

        .wrap.walmart-products-manager .sort-header:hover,
        .walmart-products-manager .sort-header:hover,
        table.walmart-table .sort-header:hover,
        .sort-header:hover {
            background: #e8e9ea !important;
            color: #2271b1 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }

        .wrap.walmart-products-manager .sort-header .sort-icon,
        .walmart-products-manager .sort-header .sort-icon,
        table.walmart-table .sort-header .sort-icon,
        .sort-header .sort-icon {
            position: absolute !important;
            right: 6px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            font-size: 14px !important;
            color: #646970 !important;
            display: inline-block !important;
            width: 14px !important;
            height: 14px !important;
            text-align: center !important;
            line-height: 1 !important;
        }

        /* é»˜è®¤æ’åºå›¾æ ‡ - æ›´æ˜æ˜¾ */
        .wrap.walmart-products-manager .sort-header:not(.sort-asc):not(.sort-desc) .sort-icon::after,
        .walmart-products-manager .sort-header:not(.sort-asc):not(.sort-desc) .sort-icon::after,
        table.walmart-table .sort-header:not(.sort-asc):not(.sort-desc) .sort-icon::after,
        .sort-header:not(.sort-asc):not(.sort-desc) .sort-icon::after {
            content: "â†•" !important;
            color: #999 !important;
            font-size: 16px !important;
            font-weight: bold !important;
        }

        /* å‡åºå›¾æ ‡ */
        .wrap.walmart-products-manager .sort-header.sort-asc .sort-icon::after,
        .walmart-products-manager .sort-header.sort-asc .sort-icon::after,
        table.walmart-table .sort-header.sort-asc .sort-icon::after,
        .sort-header.sort-asc .sort-icon::after {
            content: "â–²" !important;
            color: #2271b1 !important;
            font-size: 14px !important;
            font-weight: bold !important;
        }

        /* é™åºå›¾æ ‡ */
        .wrap.walmart-products-manager .sort-header.sort-desc .sort-icon::after,
        .walmart-products-manager .sort-header.sort-desc .sort-icon::after,
        table.walmart-table .sort-header.sort-desc .sort-icon::after,
        .sort-header.sort-desc .sort-icon::after {
            content: "â–¼" !important;
            color: #2271b1 !important;
            font-size: 14px !important;
            font-weight: bold !important;
        }

        /* æ’åºå¤´æ‚¬åœæ—¶å›¾æ ‡å˜åŒ– */
        .wrap.walmart-products-manager .sort-header:hover .sort-icon::after,
        .walmart-products-manager .sort-header:hover .sort-icon::after,
        table.walmart-table .sort-header:hover .sort-icon::after,
        .sort-header:hover .sort-icon::after {
            color: #2271b1 !important;
            transform: scale(1.1) !important;
        }

        /* æ´»è·ƒæ’åºå¤´çš„ç‰¹æ®Šæ ·å¼ */
        .wrap.walmart-products-manager .sort-header.sort-asc,
        .walmart-products-manager .sort-header.sort-asc,
        table.walmart-table .sort-header.sort-asc,
        .sort-header.sort-asc,
        .wrap.walmart-products-manager .sort-header.sort-desc,
        .walmart-products-manager .sort-header.sort-desc,
        table.walmart-table .sort-header.sort-desc,
        .sort-header.sort-desc {
            background: #f0f8ff !important;
            color: #2271b1 !important;
            font-weight: 700 !important;
        }

        .walmart-products-manager .walmart-table code {
            background: #f1f1f1 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
            font-size: 11px !important;
            font-family: Consolas, Monaco, monospace !important;
        }

        /* å“åº”å¼å¸ƒå±€ä¼˜åŒ– */
        .walmart-export-diff-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .walmart-export-section {
            flex: 1;
            min-width: 400px;
        }

        .walmart-diff-stats {
            flex: 0 0 320px;
        }

        /* å·®å¼‚ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .walmart-diff-stats [onclick] {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .walmart-diff-stats [onclick]:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .walmart-export-diff-container {
                flex-direction: column;
            }

            .walmart-diff-stats {
                flex: 1;
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .walmart-stats-container {
                flex-direction: column;
            }

            .walmart-actions-grid {
                grid-template-columns: 1fr;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .input-group label {
                min-width: auto;
            }

            /* è¡¨æ ¼å“åº”å¼ */
            .walmart-table th,
            .walmart-table td {
                font-size: 11px;
                padding: 4px 2px;
            }

            .walmart-table colgroup col:nth-child(2) {
                width: 12% !important; /* å•†å“åç§°åˆ—è¿›ä¸€æ­¥ç¼©å° */
            }
        }
    </style>


    <?php
}

// Walmartå•†å“ç®¡ç†é¡µé¢
function woo_walmart_products_manager_page() {
    // æ£€æŸ¥æƒé™
    if (!current_user_can('manage_options')) {
        wp_die(__('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢ã€‚'));
    }

    // å¼•å…¥å•†å“ç®¡ç†å™¨ç±»
    require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-products-manager.php';
    require_once WOO_WALMART_SYNC_PATH . 'includes/class-walmart-local-data-manager.php';

    global $wpdb;
    $products_manager = new WooWalmartSync_Products_Manager();
    $local_data_manager = new Walmart_Local_Data_Manager();
    $result_message = '';

    // å¤„ç†æ“ä½œ
    if (isset($_POST['action'])) {
        check_admin_referer('walmart_products_action');

        switch ($_POST['action']) {
            case 'refresh_products':
                $force_refresh = isset($_POST['force_refresh']) && $_POST['force_refresh'] === '1';
                $result = $products_manager->fetch_walmart_products($force_refresh);

                if ($result['success']) {
                    if ($result['from_cache']) {
                        $result_message = '<div class="notice notice-info"><p>ğŸ“‹ ' . $result['message'] . '</p></div>';
                    } else {
                        $message = "ğŸ‰ å•†å“åŒæ­¥å®Œæˆï¼è·å–äº† {$result['total_fetched']} ä¸ªå•†å“";
                        if (!empty($result['errors'])) {
                            $message .= "ï¼Œä½†æœ‰ " . count($result['errors']) . " ä¸ªé”™è¯¯";
                        }
                        $result_message = '<div class="notice notice-success"><p>' . $message . '</p></div>';
                    }
                } else {
                    $result_message = '<div class="notice notice-error"><p>âŒ åŒæ­¥å¤±è´¥ï¼š' . $result['message'] . '</p></div>';
                }
                break;

            case 'sync_inventory':
                // åŒæ­¥æ‰€æœ‰å•†å“çš„åº“å­˜
                $result = $products_manager->sync_all_inventory();

                if ($result && $result['success']) {
                    $total = $result['total_products'];
                    $updated = $result['inventory_updated'];
                    $errors = $result['inventory_errors'];
                    $success_rate = $result['success_rate'];

                    if ($errors > ($total * 0.1)) {
                        $result_message = '<div class="notice notice-warning"><p>âš ï¸ åº“å­˜åŒæ­¥å®Œæˆï¼Œä½†æœ‰è¾ƒå¤šå¤±è´¥ï¼šæ€»è®¡ ' . $total . ' ä¸ªå•†å“ï¼ŒæˆåŠŸ ' . $updated . ' ä¸ªï¼Œå¤±è´¥ ' . $errors . ' ä¸ªï¼ŒæˆåŠŸç‡ ' . $success_rate . '%ã€‚è¯·æŸ¥çœ‹é€šçŸ¥é¡µé¢äº†è§£è¯¦æƒ…ã€‚</p></div>';
                    } else {
                        $result_message = '<div class="notice notice-success"><p>âœ… åº“å­˜åŒæ­¥å®Œæˆï¼šæ€»è®¡ ' . $total . ' ä¸ªå•†å“ï¼ŒæˆåŠŸ ' . $updated . ' ä¸ªï¼Œå¤±è´¥ ' . $errors . ' ä¸ªï¼ŒæˆåŠŸç‡ ' . $success_rate . '%</p></div>';
                    }
                } else {
                    $result_message = '<div class="notice notice-error"><p>âŒ åº“å­˜åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹é€šçŸ¥é¡µé¢äº†è§£è¯¦æƒ…</p></div>';
                }
                break;

            case 'sync_local_data':
                // åŒæ­¥æœ¬åœ°å•†å“æ•°æ®
                $force_refresh_local = isset($_POST['force_refresh_local']) && $_POST['force_refresh_local'] === '1';
                $result = $local_data_manager->sync_local_data($force_refresh_local);

                if ($result && $result['success']) {
                    $result_message = '<div class="notice notice-success"><p>âœ… æœ¬åœ°æ•°æ®åŒæ­¥å®Œæˆï¼š' . $result['message'] . '</p></div>';
                } else {
                    $result_message = '<div class="notice notice-error"><p>âŒ æœ¬åœ°æ•°æ®åŒæ­¥å¤±è´¥ï¼š' . $result['message'] . '</p></div>';
                }
                break;

        }
    }

    // è·å–å•†å“åˆ—è¡¨ - å…ˆå®šä¹‰è¡¨å
    $cache_table = $wpdb->prefix . 'walmart_products_cache';







    // å¤„ç†æ‰¹é‡æ“ä½œ
    if (isset($_POST['bulk_action']) && !empty($_POST['selected_products'])) {
        // è®°å½•æ‰¹é‡æ“ä½œå¼€å§‹
        woo_walmart_sync_log('æ‰¹é‡æ“ä½œå¼€å§‹', 'ä¿¡æ¯', [
            'bulk_action' => $_POST['bulk_action'],
            'selected_products_count' => count($_POST['selected_products']),
            'match_method' => $_POST['match_method'] ?? 'not_set',
            'nonce_present' => isset($_POST['_wpnonce']),
            'nonce_value' => isset($_POST['_wpnonce']) ? substr($_POST['_wpnonce'], 0, 10) . '...' : 'none'
        ], 'å¼€å§‹å¤„ç†æ‰¹é‡æ“ä½œ');

        try {
            // éªŒè¯nonce
            if (!isset($_POST['bulk_actions_nonce']) || !wp_verify_nonce($_POST['bulk_actions_nonce'], 'walmart_bulk_actions')) {
                woo_walmart_sync_log('æ‰¹é‡æ“ä½œnonceéªŒè¯', 'å¤±è´¥', [
                    'bulk_actions_nonce_present' => isset($_POST['bulk_actions_nonce']),
                    'bulk_actions_nonce_value' => isset($_POST['bulk_actions_nonce']) ? $_POST['bulk_actions_nonce'] : 'none',
                    '_wpnonce_present' => isset($_POST['_wpnonce']),
                    '_wpnonce_value' => isset($_POST['_wpnonce']) ? $_POST['_wpnonce'] : 'none',
                    'expected_action' => 'walmart_bulk_actions',
                    'all_post_keys' => array_keys($_POST)
                ], 'NonceéªŒè¯å¤±è´¥');
                throw new Exception('å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }

            woo_walmart_sync_log('æ‰¹é‡æ“ä½œnonceéªŒè¯', 'æˆåŠŸ', [], 'NonceéªŒè¯é€šè¿‡');

            // éªŒè¯å’Œæ¸…ç†POSTæ•°æ®
            if (empty($_POST['selected_products']) || !is_array($_POST['selected_products'])) {
                throw new Exception('æœªé€‰æ‹©ä»»ä½•å•†å“');
            }

            if (empty($_POST['bulk_action'])) {
                throw new Exception('æœªé€‰æ‹©æ“ä½œç±»å‹');
            }

            $selected_products = array_map('intval', $_POST['selected_products']);
            $bulk_action = sanitize_text_field($_POST['bulk_action']);
            $match_method = sanitize_text_field($_POST['match_method'] ?? 'sku');

            woo_walmart_sync_log('æ‰¹é‡æ“ä½œæ•°æ®éªŒè¯', 'æˆåŠŸ', [
                'selected_products' => $selected_products,
                'bulk_action' => $bulk_action,
                'match_method' => $match_method
            ], 'æ‰¹é‡æ“ä½œæ•°æ®éªŒè¯é€šè¿‡');

            // è·å–é€‰ä¸­å•†å“çš„è¯¦ç»†ä¿¡æ¯
            $selected_ids = implode(',', $selected_products);
            $selected_items = $wpdb->get_results("
                SELECT * FROM {$cache_table}
                WHERE id IN ({$selected_ids})
            ");

            woo_walmart_sync_log('æ‰¹é‡æ“ä½œæ•°æ®å‡†å¤‡', 'ä¿¡æ¯', [
                'selected_products' => $selected_products,
                'bulk_action' => $bulk_action,
                'match_method' => $match_method,
                'selected_items_count' => count($selected_items)
            ], 'æ‰¹é‡æ“ä½œæ•°æ®å‡†å¤‡å®Œæˆ');

            if (!empty($selected_items)) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„Walmartæ•°æ®è·å–æ“ä½œ
                if (in_array($bulk_action, ['fetch_walmart_price', 'fetch_walmart_inventory', 'fetch_walmart_both'])) {
                    woo_walmart_sync_log('æ‰¹é‡æ“ä½œç±»å‹', 'ä¿¡æ¯', [
                        'action_type' => 'walmart_fetch',
                        'bulk_action' => $bulk_action
                    ], 'æ‰§è¡ŒWalmartæ•°æ®è·å–æ“ä½œ');

                    // æ£€æŸ¥æ–¹æ³•æ˜¯å¦å­˜åœ¨
                    if (method_exists($products_manager, 'process_walmart_fetch_action')) {
                        $result = $products_manager->process_walmart_fetch_action($selected_items, $bulk_action);
                    } else {
                        $result = [
                            'success' => false,
                            'message' => 'process_walmart_fetch_action æ–¹æ³•ä¸å­˜åœ¨'
                        ];
                        woo_walmart_sync_log('æ‰¹é‡æ“ä½œé”™è¯¯', 'é”™è¯¯', [
                            'error' => 'method_not_exists',
                            'method' => 'process_walmart_fetch_action'
                        ], 'process_walmart_fetch_action æ–¹æ³•ä¸å­˜åœ¨');
                    }
                } else {
                    woo_walmart_sync_log('æ‰¹é‡æ“ä½œç±»å‹', 'ä¿¡æ¯', [
                        'action_type' => 'standard_bulk',
                        'bulk_action' => $bulk_action
                    ], 'æ‰§è¡Œæ ‡å‡†æ‰¹é‡æ“ä½œ');

                    // æ£€æŸ¥æ–¹æ³•æ˜¯å¦å­˜åœ¨
                    if (method_exists($products_manager, 'process_bulk_action')) {
                        $result = $products_manager->process_bulk_action($selected_items, $bulk_action, $match_method);
                    } else {
                        $result = [
                            'success' => false,
                            'message' => 'process_bulk_action æ–¹æ³•ä¸å­˜åœ¨'
                        ];
                        woo_walmart_sync_log('æ‰¹é‡æ“ä½œé”™è¯¯', 'é”™è¯¯', [
                            'error' => 'method_not_exists',
                            'method' => 'process_bulk_action'
                        ], 'process_bulk_action æ–¹æ³•ä¸å­˜åœ¨');
                    }
                }

                woo_walmart_sync_log('æ‰¹é‡æ“ä½œç»“æœ', isset($result['success']) && $result['success'] ? 'æˆåŠŸ' : 'å¤±è´¥', [
                    'result' => $result,
                    'result_type' => gettype($result),
                    'result_keys' => is_array($result) ? array_keys($result) : 'not_array'
                ], 'æ‰¹é‡æ“ä½œæ‰§è¡Œå®Œæˆ');

                if ($result && is_array($result) && isset($result['success'])) {
                    if ($result['success']) {
                        $result_message = '<div class="notice notice-success"><p>ğŸ‰ ' . ($result['message'] ?? 'æ“ä½œæˆåŠŸ') . '</p></div>';
                    } else {
                        $result_message = '<div class="notice notice-error"><p>âŒ ' . ($result['message'] ?? 'æ“ä½œå¤±è´¥') . '</p></div>';
                    }
                } else {
                    $result_message = '<div class="notice notice-error"><p>âŒ æ‰¹é‡æ“ä½œè¿”å›ç»“æœæ ¼å¼é”™è¯¯</p></div>';
                    woo_walmart_sync_log('æ‰¹é‡æ“ä½œé”™è¯¯', 'é”™è¯¯', [
                        'result' => $result,
                        'result_type' => gettype($result),
                        'is_array' => is_array($result),
                        'has_success_key' => is_array($result) && isset($result['success'])
                    ], 'æ‰¹é‡æ“ä½œè¿”å›ç»“æœæ ¼å¼é”™è¯¯');
                }
            } else {
                $result_message = '<div class="notice notice-error"><p>âŒ æœªæ‰¾åˆ°é€‰ä¸­çš„å•†å“</p></div>';
                woo_walmart_sync_log('æ‰¹é‡æ“ä½œé”™è¯¯', 'é”™è¯¯', [
                    'selected_ids' => $selected_ids,
                    'sql_query' => "SELECT * FROM {$cache_table} WHERE id IN ({$selected_ids})",
                    'sql_error' => $wpdb->last_error,
                    'wpdb_last_query' => $wpdb->last_query
                ], 'æœªæ‰¾åˆ°é€‰ä¸­çš„å•†å“');
            }

        } catch (Exception $e) {
            $error_message = $e->getMessage();

            // æ£€æŸ¥é”™è¯¯æ¶ˆæ¯æ˜¯å¦ä¸ºnullæˆ–ç©º
            if (empty($error_message) || !is_string($error_message)) {
                $error_message = 'æœªçŸ¥é”™è¯¯';
            }

            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å‹å¥½çš„æ¶ˆæ¯
            if (strpos($error_message, 'å®‰å…¨éªŒè¯å¤±è´¥') !== false) {
                $user_message = 'å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚';
            } elseif (strpos($error_message, 'æœªé€‰æ‹©') !== false) {
                $user_message = $error_message;
            } else {
                $user_message = 'æ‰¹é‡æ“ä½œå¤±è´¥ï¼š' . $error_message;
            }

            $result_message = '<div class="notice notice-error"><p>âŒ ' . $user_message . '</p></div>';

            woo_walmart_sync_log('æ‰¹é‡æ“ä½œå¼‚å¸¸', 'é”™è¯¯', [
                'exception' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'post_data' => [
                    'bulk_action' => $_POST['bulk_action'] ?? 'not_set',
                    'selected_products_count' => isset($_POST['selected_products']) ? count($_POST['selected_products']) : 0,
                    'nonce_present' => isset($_POST['_wpnonce'])
                ]
            ], 'æ‰¹é‡æ“ä½œå‘ç”Ÿå¼‚å¸¸');
        }
    }

    // åˆ†é¡µå‚æ•°
    $per_page = isset($_GET['per_page']) ? max(10, min(500, intval($_GET['per_page']))) : 30;
    $current_page = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
    $offset = ($current_page - 1) * $per_page;

    // æœç´¢å‚æ•°
    $search = isset($_GET['search']) ? sanitize_text_field($_GET['search']) : '';
    $status_filter = isset($_GET['status_filter']) ? sanitize_text_field($_GET['status_filter']) : '';

    // ä»·æ ¼ç­›é€‰å‚æ•°
    $price_min = isset($_GET['price_min']) && is_numeric($_GET['price_min']) ? floatval($_GET['price_min']) : '';
    $price_max = isset($_GET['price_max']) && is_numeric($_GET['price_max']) ? floatval($_GET['price_max']) : '';

    // åº“å­˜ç­›é€‰å‚æ•°
    $inventory_min = isset($_GET['inventory_min']) && is_numeric($_GET['inventory_min']) ? intval($_GET['inventory_min']) : '';
    $inventory_max = isset($_GET['inventory_max']) && is_numeric($_GET['inventory_max']) ? intval($_GET['inventory_max']) : '';

    // æ’åºå‚æ•°
    $sort_by = isset($_GET['sort_by']) ? sanitize_text_field($_GET['sort_by']) : 'updated_at';
    $sort_order = isset($_GET['sort_order']) && $_GET['sort_order'] === 'asc' ? 'asc' : 'desc';

    // éªŒè¯æ’åºå­—æ®µ
    $allowed_sort_fields = ['product_name', 'price', 'inventory_count', 'status', 'last_sync_time', 'updated_at'];
    if (!in_array($sort_by, $allowed_sort_fields)) {
        $sort_by = 'updated_at';
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    $where_conditions = ['1=1'];
    $where_values = [];

    if (!empty($search)) {
        $where_conditions[] = "(sku LIKE %s OR product_name LIKE %s)";
        $where_values[] = '%' . $wpdb->esc_like($search) . '%';
        $where_values[] = '%' . $wpdb->esc_like($search) . '%';
    }

    if (!empty($status_filter)) {
        $where_conditions[] = "status = %s";
        $where_values[] = $status_filter;
    }

    // ä»·æ ¼ç­›é€‰æ¡ä»¶
    if ($price_min !== '' && $price_max !== '') {
        $where_conditions[] = "price BETWEEN %f AND %f";
        $where_values[] = $price_min;
        $where_values[] = $price_max;
    } elseif ($price_min !== '') {
        $where_conditions[] = "price >= %f";
        $where_values[] = $price_min;
    } elseif ($price_max !== '') {
        $where_conditions[] = "price <= %f";
        $where_values[] = $price_max;
    }

    // åº“å­˜ç­›é€‰æ¡ä»¶
    if ($inventory_min !== '' && $inventory_max !== '') {
        $where_conditions[] = "inventory_count BETWEEN %d AND %d";
        $where_values[] = $inventory_min;
        $where_values[] = $inventory_max;
    } elseif ($inventory_min !== '') {
        $where_conditions[] = "inventory_count >= %d";
        $where_values[] = $inventory_min;
    } elseif ($inventory_max !== '') {
        $where_conditions[] = "inventory_count <= %d";
        $where_values[] = $inventory_max;
    }

    $where_clause = implode(' AND ', $where_conditions);

    // è·å–æ€»æ•°
    $total_query = "SELECT COUNT(*) FROM {$cache_table} WHERE {$where_clause}";
    if (!empty($where_values)) {
        $total_items = $wpdb->get_var($wpdb->prepare($total_query, $where_values));
    } else {
        $total_items = $wpdb->get_var($total_query);
    }

    // è·å–å•†å“åˆ—è¡¨
    $products_query = "SELECT * FROM {$cache_table} WHERE {$where_clause} ORDER BY {$sort_by} {$sort_order} LIMIT %d OFFSET %d";
    $query_values = array_merge($where_values, [(int) $per_page, (int) $offset]);
    $products = $wpdb->get_results($wpdb->prepare($products_query, $query_values));

    // è·å–æœ¬åœ°æ•°æ®è¿›è¡Œå¯¹æ¯”
    $local_data_map = [];
    if (!empty($products)) {
        $skus = array_column($products, 'sku');
        $local_data_list = $local_data_manager->get_local_data_by_skus($skus);

        // åˆ›å»ºSKUåˆ°æœ¬åœ°æ•°æ®çš„æ˜ å°„
        foreach ($local_data_list as $local_item) {
            $local_data_map[$local_item->sku] = $local_item;
        }
    }

    // è®¡ç®—åˆ†é¡µ
    $total_pages = ceil($total_items / $per_page);

    // è·å–ç»Ÿè®¡ä¿¡æ¯
    $stats = [
        'total' => $wpdb->get_var("SELECT COUNT(*) FROM {$cache_table}"),
        'active' => $wpdb->get_var("SELECT COUNT(*) FROM {$cache_table} WHERE status = 'ACTIVE'"),
        'retired' => $wpdb->get_var("SELECT COUNT(*) FROM {$cache_table} WHERE status = 'RETIRED'"),
        'last_sync' => $wpdb->get_var("SELECT MAX(last_sync_time) FROM {$cache_table}")
    ];

    // è°ƒè¯•ï¼šæ£€æŸ¥å®é™…çš„çŠ¶æ€å€¼
    $status_debug = $wpdb->get_results("SELECT status, COUNT(*) as count FROM {$cache_table} GROUP BY status");
    woo_walmart_sync_log('å•†å“çŠ¶æ€ç»Ÿè®¡è°ƒè¯•', 'è°ƒè¯•', [
        'status_breakdown' => $status_debug,
        'stats' => $stats
    ], 'æ£€æŸ¥å•†å“çŠ¶æ€åˆ†å¸ƒ');

    ?>
    <div class="wrap walmart-products-manager" style="margin: 0; max-width: none;">
        <h1 style="margin: 20px 0;"><span class="dashicons dashicons-store"></span> Walmartå•†å“ç®¡ç†</h1>
        <p class="description" style="margin-bottom: 20px;">ç®¡ç†ä»Walmartè·å–çš„å•†å“ä¿¡æ¯ï¼ŒåŒæ­¥åº“å­˜å’Œä»·æ ¼</p>

        <?php echo $result_message; ?>



        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="walmart-stats-container">
            <div class="walmart-stat-box">
                <h3>ğŸ“Š å•†å“ç»Ÿè®¡</h3>
                <div class="stat-number"><?php echo $stats['total'] ?: 0; ?></div>
                <p>æ€»å•†å“æ•°</p>
            </div>

            <div class="walmart-stat-box">
                <h3>âœ… æ´»è·ƒå•†å“</h3>
                <div class="stat-number" style="color: #00a32a;"><?php echo $stats['active'] ?: 0; ?></div>
                <p>æ´»è·ƒçŠ¶æ€</p>
            </div>

            <div class="walmart-stat-box">
                <h3>ğŸš« å·²ä¸‹æ¶</h3>
                <div class="stat-number" style="color: #d63638;"><?php echo $stats['retired'] ?: 0; ?></div>
                <p>ä¸‹æ¶çŠ¶æ€</p>
            </div>

            <div class="walmart-stat-box">
                <h3>ğŸ•’ æœ€ååŒæ­¥</h3>
                <div class="stat-text">
                    <?php
                    if ($stats['last_sync']) {
                        echo human_time_diff(strtotime($stats['last_sync']), current_time('timestamp')) . 'å‰';
                    } else {
                        echo 'ä»æœªåŒæ­¥';
                    }
                    ?>
                </div>
                <p>æ•°æ®æ›´æ–°æ—¶é—´</p>
            </div>
        </div>

        <!-- æ“ä½œé¢æ¿ -->
        <div class="walmart-actions-panel">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <form method="post" class="action-form" style="margin: 0;">
                    <input type="hidden" name="action" value="refresh_products">
                    <?php wp_nonce_field('walmart_products_action'); ?>
                    <button type="submit" class="walmart-btn walmart-btn-primary"
                            onclick="return confirm('ç¡®å®šè¦ä»WalmartåŒæ­¥å•†å“æ•°æ®å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚');">
                        ğŸ”„ åŒæ­¥Walmartå•†å“
                    </button>
                    <label style="margin-left: 10px;">
                        <input type="checkbox" name="force_refresh" value="1"> å¼ºåˆ¶åˆ·æ–°ï¼ˆå¿½ç•¥24å°æ—¶ç¼“å­˜ï¼‰
                    </label>
                    <div style="margin-left: 10px; margin-top: 5px; font-size: 11px; color: #d63638; font-weight: 600;">
                        âš ï¸ å¼ºåˆ¶åˆ·æ–°æ—¶ä¼šå¯ç”¨åˆ é™¤åŒæ­¥ï¼šè‡ªåŠ¨åˆ é™¤æœ¬åœ°å­˜åœ¨ä½†Walmartä¸­ä¸å­˜åœ¨çš„å•†å“
                    </div>
                </form>

                <form method="post" class="action-form" style="margin: 0;">
                    <input type="hidden" name="action" value="sync_inventory">
                    <?php wp_nonce_field('walmart_products_action'); ?>
                    <button type="submit" class="walmart-btn walmart-btn-secondary"
                            onclick="return confirm('ç¡®å®šè¦åŒæ­¥æ‰€æœ‰å•†å“çš„åº“å­˜æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åŒæ­¥æ‰€æœ‰å•†å“çš„åº“å­˜ï¼Œä½¿ç”¨Walmartæ‰¹é‡APIåˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹50ä¸ªå•†å“ã€‚\næ ¹æ®å•†å“æ•°é‡ï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿåˆ°åå‡ åˆ†é’Ÿæ—¶é—´ã€‚\n\nå»ºè®®åœ¨å•†å“è¾ƒå°‘çš„æ—¶å€™è¿›è¡ŒåŒæ­¥ã€‚');">
                        ğŸ“¦ åŒæ­¥æ‰€æœ‰åº“å­˜
                    </button>
                    <span style="margin-left: 10px; color: #646970; font-size: 12px;">
                        å°†åŒæ­¥æ‰€æœ‰å•†å“çš„åº“å­˜æ•°æ®
                    </span>
                </form>




            </div>

            <!-- ç¬¬äºŒè¡Œæ“ä½œ -->
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-top: 15px;">
                <form method="post" class="action-form" style="margin: 0;">
                    <input type="hidden" name="action" value="sync_local_data">
                    <?php wp_nonce_field('walmart_products_action'); ?>
                    <button type="submit" class="walmart-btn walmart-btn-secondary"
                            onclick="return confirm('ç¡®å®šè¦åŒæ­¥æœ¬åœ°å•†å“æ•°æ®å—ï¼Ÿè¿™å°†æ›´æ–°æœ¬åœ°ä»·æ ¼å’Œåº“å­˜ç¼“å­˜ã€‚');">
                        ğŸ  åŒæ­¥æœ¬åœ°å•†å“æ•°æ®
                    </button>
                    <label style="margin-left: 10px;">
                        <input type="checkbox" name="force_refresh_local" value="1"> å¼ºåˆ¶åˆ·æ–°ï¼ˆå¿½ç•¥24å°æ—¶ç¼“å­˜ï¼‰
                    </label>
                </form>
            </div>
        </div>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="walmart-search-panel">
            <form method="get" class="search-form">
                <input type="hidden" name="page" value="woo-walmart-products-manager">
                <input type="hidden" name="sort_by" value="<?php echo esc_attr($sort_by); ?>">
                <input type="hidden" name="sort_order" value="<?php echo esc_attr($sort_order); ?>">
                <div class="search-group">
                    <input type="text" name="search" value="<?php echo esc_attr($search); ?>"
                           placeholder="æœç´¢SKUæˆ–å•†å“åç§°..." class="search-input">
                    <select name="status_filter" class="status-filter">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="ACTIVE" <?php selected($status_filter, 'ACTIVE'); ?>>æ´»è·ƒ</option>
                        <option value="PUBLISHED" <?php selected($status_filter, 'PUBLISHED'); ?>>å·²å‘å¸ƒ</option>
                        <option value="UNPUBLISHED" <?php selected($status_filter, 'UNPUBLISHED'); ?>>æœªå‘å¸ƒ</option>
                        <option value="RETIRED" <?php selected($status_filter, 'RETIRED'); ?>>å·²ä¸‹æ¶</option>
                    </select>

                    <button type="submit" class="walmart-btn walmart-btn-secondary">ğŸ” æœç´¢</button>
                    <?php if (!empty($search) || !empty($status_filter) || $price_min !== '' || $price_max !== '' || $inventory_min !== '' || $inventory_max !== ''): ?>
                        <a href="<?php echo admin_url('admin.php?page=woo-walmart-products-manager'); ?>"
                           class="walmart-btn walmart-btn-secondary">æ¸…é™¤ç­›é€‰</a>
                    <?php endif; ?>
                </div>
            </form>
        </div>

        <!-- æ’åºçŠ¶æ€æ˜¾ç¤º -->
        <?php if (!empty($products) && $sort_by !== 'updated_at'): ?>
        <div class="sort-info">
            å½“å‰æ’åºï¼š
            <span class="current-sort">
                <?php
                $sort_names = [
                    'product_name' => 'å•†å“åç§°',
                    'price' => 'ä»·æ ¼',
                    'inventory_count' => 'åº“å­˜',
                    'status' => 'çŠ¶æ€',
                    'last_sync_time' => 'æœ€ååŒæ­¥æ—¶é—´'
                ];
                echo $sort_names[$sort_by] ?? $sort_by;
                echo ' (' . ($sort_order === 'asc' ? 'å‡åº' : 'é™åº') . ')';
                ?>
            </span>
            <a href="<?php echo admin_url('admin.php?page=woo-walmart-products-manager&search=' . urlencode($search) . '&status_filter=' . urlencode($status_filter) . '&price_min=' . urlencode($price_min) . '&price_max=' . urlencode($price_max) . '&inventory_min=' . urlencode($inventory_min) . '&inventory_max=' . urlencode($inventory_max) . '&per_page=' . $per_page); ?>"
               style="margin-left: 10px; color: #2271b1; text-decoration: none;">
                é‡ç½®æ’åº
            </a>
        </div>
        <?php endif; ?>

        <!-- æ‰¹é‡æ“ä½œé¢æ¿å·²ç§»åˆ°ä¸‹æ–¹ -->

            <!-- å¯¼å‡ºåŠŸèƒ½å’Œå·®å¼‚ç»Ÿè®¡åŒºåŸŸ -->
            <div class="walmart-export-diff-container" style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                <!-- å¯¼å‡ºåŠŸèƒ½åŒºåŸŸ -->
                <div class="walmart-export-section" style="flex: 1; min-width: 400px; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
                    <h4 style="margin: 0 0 15px 0;">ğŸ“¤ å¯¼å‡ºäº§å“æ•°æ®</h4>

                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <a href="<?php echo plugins_url('walmart-export.php', __FILE__) . '?export_action=quick_export&_wpnonce=' . wp_create_nonce('walmart_export_products'); ?>"
                           class="walmart-btn walmart-btn-success" target="_blank">
                            ğŸ“¤ å¿«é€Ÿå¯¼å‡º
                        </a>

                        <button type="button" class="walmart-btn walmart-btn-secondary" onclick="toggleExportOptions()">
                            âš™ï¸ é«˜çº§å¯¼å‡º
                        </button>

                        <span style="color: #646970; font-size: 12px; flex: 1; min-width: 200px;">
                            å¯¼å‡ºå½“å‰è¡¨æ ¼ä¸­çš„äº§å“ä¿¡æ¯ä¸ºCSVæ ¼å¼
                        </span>
                    </div>
                </div>

                <!-- å·®å¼‚ç»Ÿè®¡å¡ç‰‡ -->
                <div class="walmart-diff-stats" style="flex: 0 0 320px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <?php
                    // è·å–å…¨å±€å·®å¼‚ç»Ÿè®¡ï¼ˆæ‰€æœ‰å•†å“ï¼‰
                    $global_diff_stats = $local_data_manager->get_global_difference_stats();
                    ?>
                    <h4 style="margin: 0 0 15px 0; color: #1d2327;">ğŸ“Š æ•°æ®å·®å¼‚ç»Ÿè®¡</h4>

                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 3px; cursor: pointer;" onclick="showDifferenceModal('price')">
                            <span style="font-weight: 600; color: #856404;">ğŸ’° ä»·æ ¼å·®å¼‚</span>
                            <span style="font-weight: 700; color: #856404; font-size: 16px;"><?php echo $global_diff_stats['price_diff_count']; ?>ä¸ª</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #d1ecf1; border-left: 4px solid #17a2b8; border-radius: 3px; cursor: pointer;" onclick="showDifferenceModal('inventory')">
                            <span style="font-weight: 600; color: #0c5460;">ğŸ“¦ åº“å­˜å·®å¼‚</span>
                            <span style="font-weight: 700; color: #0c5460; font-size: 16px;"><?php echo $global_diff_stats['inventory_diff_count']; ?>ä¸ª</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 3px;">
                            <span style="font-weight: 600; color: #155724;">ğŸ”— å·²åŒ¹é…å•†å“</span>
                            <span style="font-weight: 700; color: #155724; font-size: 16px;"><?php echo $global_diff_stats['total_compared']; ?>ä¸ª</span>
                        </div>
                    </div>

                    <?php if ($global_diff_stats['price_diff_count'] > 0 || $global_diff_stats['inventory_diff_count'] > 0): ?>
                    <button type="button" class="walmart-btn walmart-btn-warning" style="width: 100%; margin-top: 10px;" onclick="showAllDifferences()">
                        ğŸ” æŸ¥çœ‹æ‰€æœ‰å·®å¼‚
                    </button>
                    <?php else: ?>
                    <div style="text-align: center; padding: 10px; color: #28a745; font-weight: 600;">
                        âœ… æ‰€æœ‰æ•°æ®ä¸€è‡´
                    </div>
                    <?php endif; ?>

                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef; font-size: 11px; color: #6c757d; text-align: center;">
                        æ€»è®¡ <?php echo $global_diff_stats['total_walmart']; ?> ä¸ªWalmartå•†å“<br>
                        <span style="color: #28a745;">æœ€åç»Ÿè®¡: <?php echo $global_diff_stats['last_update'] ? human_time_diff(strtotime($global_diff_stats['last_update']), current_time('timestamp')) . 'å‰' : 'æœªç»Ÿè®¡'; ?></span><br>
                        <button type="button" onclick="refreshDifferenceStats()" class="walmart-btn walmart-btn-small" style="margin-top: 8px; font-size: 10px; padding: 4px 8px;">
                            ğŸ”„ ç«‹å³åˆ·æ–°ç»Ÿè®¡
                        </button>
                    </div>
                </div>
            </div>

            </form>
        </div>

        <!-- é«˜çº§å¯¼å‡ºé€‰é¡¹é¢æ¿ï¼ˆç§»åˆ°è¡¨å•å¤–é¢ï¼‰ -->
        <div id="export-options-panel" style="display: none; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 4px; margin-top: 15px;">
            <h5>ğŸ”§ é«˜çº§å¯¼å‡ºé€‰é¡¹</h5>
            <form method="get" id="advanced-export-form" action="<?php echo plugins_url('walmart-export.php', __FILE__); ?>" target="_blank">
                <input type="hidden" name="export_action" value="advanced_export">
                <input type="hidden" name="_wpnonce" value="<?php echo wp_create_nonce('walmart_export_products_advanced'); ?>">

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h6>ğŸ“‹ å¯¼å‡ºå­—æ®µé€‰æ‹©</h6>
                                <button type="button" onclick="toggleAllExportFields()" class="walmart-btn walmart-btn-small" style="margin-bottom: 10px;">
                                    å…¨é€‰/å–æ¶ˆå…¨é€‰
                                </button>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                    <label><input type="checkbox" name="export_fields[]" value="sku" checked> SKU</label>
                                    <label><input type="checkbox" name="export_fields[]" value="product_name" checked> äº§å“åç§°</label>
                                    <label><input type="checkbox" name="export_fields[]" value="upc" checked> UPC</label>
                                    <label><input type="checkbox" name="export_fields[]" value="price" checked> ä»·æ ¼</label>
                                    <label><input type="checkbox" name="export_fields[]" value="inventory_count" checked> åº“å­˜</label>
                                    <label><input type="checkbox" name="export_fields[]" value="publish_status" checked> å‘å¸ƒçŠ¶æ€</label>
                                    <label><input type="checkbox" name="export_fields[]" value="lifecycle_status"> ç”Ÿå‘½å‘¨æœŸçŠ¶æ€</label>
                                    <label><input type="checkbox" name="export_fields[]" value="unpublished_reasons"> æœªå‘å¸ƒåŸå› </label>
                                    <label><input type="checkbox" name="export_fields[]" value="created_at"> åˆ›å»ºæ—¶é—´</label>
                                    <label><input type="checkbox" name="export_fields[]" value="updated_at" checked> æ›´æ–°æ—¶é—´</label>
                                </div>
                            </div>

                            <div>
                                <h6>ğŸ” ç­›é€‰æ¡ä»¶</h6>
                                <div style="margin-bottom: 10px;">
                                    <label>å‘å¸ƒçŠ¶æ€ï¼š</label>
                                    <select name="filter_publish_status" style="width: 100%;">
                                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                                        <option value="PUBLISHED">å·²å‘å¸ƒ</option>
                                        <option value="UNPUBLISHED">æœªå‘å¸ƒ</option>
                                        <option value="STAGE">æš‚å­˜</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 10px;">
                                    <label>åº“å­˜çŠ¶æ€ï¼š</label>
                                    <select name="filter_inventory_status" style="width: 100%;">
                                        <option value="">æ‰€æœ‰åº“å­˜</option>
                                        <option value="in_stock">æœ‰åº“å­˜ (>0)</option>
                                        <option value="out_of_stock">æ— åº“å­˜ (=0)</option>
                                        <option value="low_stock">ä½åº“å­˜ (1-10)</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 10px;">
                                    <label>æ›´æ–°æ—¶é—´ï¼š</label>
                                    <select name="filter_date_range" style="width: 100%;" onchange="handleDateRangeChange()">
                                        <option value="">æ‰€æœ‰æ—¶é—´</option>
                                        <option value="today">ä»Šå¤©</option>
                                        <option value="week">æœ€è¿‘ä¸€å‘¨</option>
                                        <option value="month">æœ€è¿‘ä¸€ä¸ªæœˆ</option>
                                        <option value="custom">è‡ªå®šä¹‰æ—¶é—´</option>
                                    </select>
                                </div>

                                <div id="custom-date-range" style="display: none; margin-bottom: 10px;">
                                    <label>å¼€å§‹æ—¥æœŸï¼š</label>
                                    <input type="date" name="start_date" style="width: 100%; margin-bottom: 5px;">
                                    <label>ç»“æŸæ—¥æœŸï¼š</label>
                                    <input type="date" name="end_date" style="width: 100%;">
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 15px; text-align: center;">
                            <button type="submit" class="walmart-btn walmart-btn-primary">
                                ğŸ“¤ æ‰§è¡Œé«˜çº§å¯¼å‡º
                            </button>
                            <button type="button" class="walmart-btn walmart-btn-secondary" onclick="toggleExportOptions()">
                                å–æ¶ˆ
                            </button>
                </div>
            </form>
        </div>

        <!-- æ‰¹é‡æ“ä½œè¡¨å•å¼€å§‹ -->
        <?php if (!empty($products)): ?>
        <div class="walmart-bulk-actions-panel">
            <h3>ğŸ› ï¸ æ‰¹é‡æ“ä½œ</h3>
            <form method="post" id="bulk-actions-form">
                <?php wp_nonce_field('walmart_bulk_actions', 'bulk_actions_nonce'); ?>
                <div class="bulk-actions-row">
                    <div class="bulk-action-group">
                        <label>æ“ä½œç±»å‹ï¼š</label>
                        <select name="bulk_action" class="bulk-action-select" required>
                            <option value="">é€‰æ‹©æ“ä½œ</option>
                            <optgroup label="ğŸ“¤ æœ¬åœ°åˆ°WalmartåŒæ­¥">
                                <option value="sync_inventory">ğŸš€ åŒæ­¥åº“å­˜ï¼ˆæ‰¹é‡APIï¼‰</option>
                                <option value="sync_price">ğŸ’° åŒæ­¥ä»·æ ¼ï¼ˆæ‰¹é‡Feedï¼‰</option>
                                <option value="sync_product_name">ğŸ“ åŒæ­¥äº§å“åç§°ï¼ˆæ‰¹é‡Feedï¼‰</option>
                                <option value="sync_both">âš¡ åŒæ­¥ä»·æ ¼å’Œåº“å­˜ï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰</option>
                            </optgroup>
                            <optgroup label="ğŸ“¥ Walmartåˆ°æœ¬åœ°åŒæ­¥">
                                <option value="fetch_walmart_price">ğŸ’² è·å–Walmartæœ€æ–°ä»·æ ¼</option>
                                <option value="fetch_walmart_inventory">ğŸ“¦ è·å–Walmartæœ€æ–°åº“å­˜</option>
                                <option value="fetch_walmart_both">ğŸ”„ è·å–Walmartä»·æ ¼å’Œåº“å­˜</option>
                            </optgroup>
                            <optgroup label="ğŸ”§ å•†å“çŠ¶æ€ç®¡ç†">
                                <option value="publish">ğŸ“¤ å•†å“ä¸Šæ¶</option>
                                <option value="unpublish">ğŸ“¥ å•†å“ä¸‹æ¶</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="bulk-action-group">
                        <label>åŒ¹é…æ–¹å¼ï¼š</label>
                        <select name="match_method" class="bulk-action-select">
                            <option value="sku">æŒ‰SKUåŒ¹é…</option>
                            <option value="upc">æŒ‰UPCåŒ¹é…</option>
                            <option value="both">SKUå’ŒUPCéƒ½åŒ¹é…</option>
                        </select>
                    </div>

                    <button type="submit" class="walmart-btn walmart-btn-primary"
                            onclick="return confirmBulkAction();">
                        æ‰§è¡Œæ‰¹é‡æ“ä½œ
                    </button>

                    <!-- éšè—å­—æ®µç”¨äºä¼ é€’é€‰ä¸­çš„å•†å“ID -->
                    <div id="selected-products-container"></div>
                </div>

                <!-- ä»·æ ¼å’Œåº“å­˜ç­›é€‰å™¨ -->
                <div class="bulk-filters-row" style="margin-top: 15px; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #1d2327;">ğŸ” ç­›é€‰è¡¨æ ¼æ•°æ®</h4>
                    <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
                        <!-- ä»·æ ¼ç­›é€‰ -->
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #1d2327;">ğŸ’° ä»·æ ¼èŒƒå›´ (USD)</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" name="price_min" value="<?php echo esc_attr($price_min); ?>"
                                       placeholder="æœ€ä½ä»·æ ¼" step="0.01" min="0"
                                       style="width: 90px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                <span style="color: #646970;">-</span>
                                <input type="number" name="price_max" value="<?php echo esc_attr($price_max); ?>"
                                       placeholder="æœ€é«˜ä»·æ ¼" step="0.01" min="0"
                                       style="width: 90px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            </div>
                        </div>

                        <!-- åº“å­˜ç­›é€‰ -->
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #1d2327;">ğŸ“¦ åº“å­˜èŒƒå›´</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" name="inventory_min" value="<?php echo esc_attr($inventory_min); ?>"
                                       placeholder="æœ€ä½åº“å­˜" min="0"
                                       style="width: 90px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                <span style="color: #646970;">-</span>
                                <input type="number" name="inventory_max" value="<?php echo esc_attr($inventory_max); ?>"
                                       placeholder="æœ€é«˜åº“å­˜" min="0"
                                       style="width: 90px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            </div>
                        </div>

                        <!-- ç­›é€‰æŒ‰é’® -->
                        <div style="flex: 0 0 auto;">
                            <button type="button" class="walmart-btn walmart-btn-secondary" onclick="applyTableFilters()">
                                ğŸ” åº”ç”¨ç­›é€‰
                            </button>
                            <?php if ($price_min !== '' || $price_max !== '' || $inventory_min !== '' || $inventory_max !== ''): ?>
                            <button type="button" class="walmart-btn walmart-btn-secondary" onclick="clearTableFilters()" style="margin-left: 8px;">
                                æ¸…é™¤ç­›é€‰
                            </button>
                            <?php endif; ?>
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: #646970;">
                        ä¾‹å¦‚ï¼š50-80 æˆ– 200ä»¥ä¸Šï¼ˆç•™ç©ºæœ€é«˜å€¼ï¼‰ã€‚ç­›é€‰åå¯é€‰æ‹©å•†å“è¿›è¡Œæ‰¹é‡æ“ä½œã€‚
                    </div>
                </div>

                <div style="margin-top: 10px; color: #646970; font-size: 12px;">
                    <strong>è¯´æ˜ï¼š</strong>
                    â€¢ <strong>ğŸ“¤ æœ¬åœ°åˆ°WalmartåŒæ­¥ï¼š</strong>å°†WooCommerceæ•°æ®åŒæ­¥åˆ°Walmartå¹³å°
                    â€¢ <strong>ğŸ“¥ Walmartåˆ°æœ¬åœ°åŒæ­¥ï¼š</strong>ä»Walmartè·å–æœ€æ–°æ•°æ®æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼ˆä¸å½±å“WooCommerceï¼‰
                    â€¢ <strong>ğŸ”§ å•†å“çŠ¶æ€ç®¡ç†ï¼š</strong>æ‰¹é‡ç®¡ç†Walmartå•†å“çš„å‘å¸ƒçŠ¶æ€
                    â€¢ è¯·å…ˆé€‰æ‹©å•†å“ï¼Œç„¶åé€‰æ‹©æ“ä½œç±»å‹
                </div>

                <!-- å•†å“è¡¨æ ¼ -->
                <div class="walmart-table-container">
                    <table class="walmart-table">
            <colgroup>
                <col style="width: 40px;">  <!-- å¤é€‰æ¡† -->
                <col style="width: 20%;">   <!-- å•†å“åç§° -->
                <col style="width: 100px;"> <!-- SKU -->
                <col style="width: 100px;"> <!-- UPC -->
                <col style="width: 80px;">  <!-- æ²ƒå°”ç›ä»·æ ¼ -->
                <col style="width: 80px;">  <!-- æœ¬åœ°ä»·æ ¼ -->
                <col style="width: 60px;">  <!-- ä»·æ ¼å·®å¼‚ -->
                <col style="width: 80px;">  <!-- æ²ƒå°”ç›åº“å­˜ -->
                <col style="width: 80px;">  <!-- æœ¬åœ°åº“å­˜ -->
                <col style="width: 60px;">  <!-- åº“å­˜å·®å¼‚ -->
                <col style="width: 80px;">  <!-- çŠ¶æ€ -->
                <col style="width: 120px;"> <!-- æœ€ååŒæ­¥ -->
                <col style="width: 80px;">  <!-- æ“ä½œ -->
            </colgroup>
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="select-all-products">
                    </th>
                    <th class="sort-header" data-sort="product_name">
                        å•†å“åç§°
                        <span class="sort-icon"></span>
                    </th>
                    <th>SKU</th>
                    <th>UPC</th>
                    <th class="sort-header" data-sort="price">
                        æ²ƒå°”ç›ä»·æ ¼
                        <span class="sort-icon"></span>
                    </th>
                    <th>æœ¬åœ°ä»·æ ¼</th>
                    <th>å·®å¼‚</th>
                    <th class="sort-header" data-sort="inventory_count">
                        æ²ƒå°”ç›åº“å­˜
                        <span class="sort-icon"></span>
                    </th>
                    <th>æœ¬åœ°åº“å­˜</th>
                    <th>å·®å¼‚</th>
                    <th class="sort-header" data-sort="status">
                        çŠ¶æ€
                        <span class="sort-icon"></span>
                    </th>
                    <th class="sort-header" data-sort="last_sync_time">
                        æœ€ååŒæ­¥
                        <span class="sort-icon"></span>
                    </th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($products as $product):
                    // è·å–æœ¬åœ°æ•°æ®
                    $local_data = isset($local_data_map[$product->sku]) ? $local_data_map[$product->sku] : null;

                    // è®¡ç®—å·®å¼‚
                    $price_diff = 0;
                    $inventory_diff = 0;
                    $has_local_data = false;

                    if ($local_data) {
                        $has_local_data = true;
                        $walmart_price = floatval($product->price);
                        $local_price = floatval($local_data->price);
                        $price_diff = $local_price - $walmart_price;

                        $walmart_inventory = intval($product->inventory_count);
                        $local_inventory = intval($local_data->stock_quantity);
                        $inventory_diff = $local_inventory - $walmart_inventory;
                    }
                ?>
                <tr>
                    <td>
                        <input type="checkbox" name="selected_products[]" value="<?php echo $product->id; ?>"
                               class="product-checkbox" data-sku="<?php echo esc_attr($product->sku); ?>"
                               data-upc="<?php echo esc_attr($product->upc); ?>">
                    </td>
                    <td>
                        <strong title="<?php echo esc_attr($product->product_name); ?>">
                            <?php echo esc_html(wp_trim_words($product->product_name, 8)); ?>
                        </strong>
                    </td>
                    <td><code><?php echo esc_html($product->sku); ?></code></td>
                    <td><code><?php echo esc_html($product->upc ?: 'æ— '); ?></code></td>

                    <!-- æ²ƒå°”ç›ä»·æ ¼ -->
                    <td><strong>$<?php echo number_format($product->price, 2); ?></strong></td>

                    <!-- æœ¬åœ°ä»·æ ¼ -->
                    <td>
                        <?php if ($has_local_data): ?>
                            <strong>$<?php echo number_format($local_data->price, 2); ?></strong>
                        <?php else: ?>
                            <span style="color: #646970;">-</span>
                        <?php endif; ?>
                    </td>

                    <!-- ä»·æ ¼å·®å¼‚ -->
                    <td>
                        <?php if ($has_local_data): ?>
                            <?php if (abs($price_diff) > 0.01): ?>
                                <span style="color: <?php echo $price_diff > 0 ? '#00a32a' : '#d63638'; ?>; font-weight: 600;">
                                    <?php echo ($price_diff > 0 ? '+' : '') . '$' . number_format($price_diff, 2); ?>
                                </span>
                            <?php else: ?>
                                <span style="color: #646970;">-</span>
                            <?php endif; ?>
                        <?php else: ?>
                            <span style="color: #646970;">-</span>
                        <?php endif; ?>
                    </td>

                    <!-- æ²ƒå°”ç›åº“å­˜ -->
                    <td><strong><?php echo $product->inventory_count; ?></strong></td>

                    <!-- æœ¬åœ°åº“å­˜ -->
                    <td>
                        <?php if ($has_local_data): ?>
                            <strong><?php echo $local_data->stock_quantity; ?></strong>
                        <?php else: ?>
                            <span style="color: #646970;">-</span>
                        <?php endif; ?>
                    </td>

                    <!-- åº“å­˜å·®å¼‚ -->
                    <td>
                        <?php if ($has_local_data): ?>
                            <?php if ($inventory_diff != 0): ?>
                                <span style="color: <?php echo $inventory_diff > 0 ? '#00a32a' : '#d63638'; ?>; font-weight: 600;">
                                    <?php echo ($inventory_diff > 0 ? '+' : '') . $inventory_diff; ?>
                                </span>
                            <?php else: ?>
                                <span style="color: #646970;">-</span>
                            <?php endif; ?>
                        <?php else: ?>
                            <span style="color: #646970;">-</span>
                        <?php endif; ?>
                    </td>

                    <!-- çŠ¶æ€ -->
                    <td>
                        <?php
                        switch ($product->status) {
                            case 'ACTIVE':
                                echo '<span style="color: #00a32a; font-weight: 600;">âœ… æ´»è·ƒ</span>';
                                break;
                            case 'PUBLISHED':
                                echo '<span style="color: #00a32a; font-weight: 600;">âœ… å·²å‘å¸ƒ</span>';
                                break;
                            case 'RETIRED':
                                echo '<span style="color: #d63638; font-weight: 600;">ğŸš« å·²ä¸‹æ¶</span>';
                                break;
                            case 'UNPUBLISHED':
                                echo '<span style="color: #f56e28; font-weight: 600;">â¸ï¸ æœªå‘å¸ƒ</span>';
                                break;
                            default:
                                echo '<span style="color: #646970; font-weight: 600;">â“ ' . esc_html($product->status) . '</span>';
                        }
                        ?>
                    </td>

                    <!-- æœ€ååŒæ­¥ -->
                    <td>
                        <small><?php echo human_time_diff(strtotime($product->last_sync_time), current_time('timestamp')); ?>å‰</small>
                    </td>

                    <!-- æ“ä½œ -->
                    <td>
                        <?php if ($has_local_data): ?>
                            <?php if (abs($price_diff) > 0.01 || $inventory_diff != 0): ?>
                                <button class="button button-primary button-small"
                                        onclick="syncSingleProduct(<?php echo $product->id; ?>, '<?php echo esc_js($product->sku); ?>')"
                                        title="åŒæ­¥ä»·æ ¼å’Œåº“å­˜åˆ°Walmart">
                                    ğŸ”„ åŒæ­¥
                                </button>
                            <?php else: ?>
                                <button class="button button-secondary button-small"
                                        onclick="syncSingleProduct(<?php echo $product->id; ?>, '<?php echo esc_js($product->sku); ?>')"
                                        title="å¼ºåˆ¶åŒæ­¥åˆ°Walmart">
                                    âœ… åŒæ­¥
                                </button>
                            <?php endif; ?>
                        <?php else: ?>
                            <span style="color: #646970; font-size: 11px;">æ— æœ¬åœ°æ•°æ®</span>
                        <?php endif; ?>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        </div>

                <!-- é€‰ä¸­æ•°é‡æ˜¾ç¤º -->
                <div style="margin: 15px 0; text-align: center; color: #646970; font-weight: 500;">
                    <span id="selected-count">å·²é€‰æ‹© 0 ä¸ªå•†å“</span>
                </div>
            </form>
        </div>

        <!-- åˆ†é¡µ -->
        <?php if ($total_pages > 1): ?>
        <div class="walmart-pagination">
            <?php
            $pagination_args = [
                'base' => add_query_arg('paged', '%#%'),
                'format' => '',
                'current' => $current_page,
                'total' => $total_pages,
                'prev_text' => 'â€¹ ä¸Šä¸€é¡µ',
                'next_text' => 'ä¸‹ä¸€é¡µ â€º',
                'show_all' => false,
                'end_size' => 1,
                'mid_size' => 2,
                'type' => 'plain',
                'add_args' => [
                    'search' => $search,
                    'status_filter' => $status_filter,
                    'price_min' => $price_min,
                    'price_max' => $price_max,
                    'inventory_min' => $inventory_min,
                    'inventory_max' => $inventory_max,
                    'per_page' => $per_page,
                    'sort_by' => $sort_by,
                    'sort_order' => $sort_order
                ]
            ];
            echo paginate_links($pagination_args);
            ?>
        </div>

        <!-- åˆ†é¡µä¿¡æ¯ -->
        <div class="walmart-pagination-info">
            æ˜¾ç¤ºç¬¬ <?php echo (($current_page - 1) * $per_page + 1); ?> - <?php echo min($current_page * $per_page, $total_items); ?> é¡¹ï¼Œ
            å…± <?php echo $total_items; ?> é¡¹ (ç¬¬ <?php echo $current_page; ?> é¡µï¼Œå…± <?php echo $total_pages; ?> é¡µ)
        </div>

        <!-- æ¯é¡µæ•°é‡é€‰æ‹© -->
        <div class="walmart-per-page-selector">
            <form method="get" style="display: inline-block;">
                <input type="hidden" name="page" value="woo-walmart-products-manager">
                <input type="hidden" name="search" value="<?php echo esc_attr($search); ?>">
                <input type="hidden" name="status_filter" value="<?php echo esc_attr($status_filter); ?>">
                <input type="hidden" name="price_min" value="<?php echo esc_attr($price_min); ?>">
                <input type="hidden" name="price_max" value="<?php echo esc_attr($price_max); ?>">
                <input type="hidden" name="inventory_min" value="<?php echo esc_attr($inventory_min); ?>">
                <input type="hidden" name="inventory_max" value="<?php echo esc_attr($inventory_max); ?>">
                <input type="hidden" name="sort_by" value="<?php echo esc_attr($sort_by); ?>">
                <input type="hidden" name="sort_order" value="<?php echo esc_attr($sort_order); ?>">
                <label for="per-page-select">æ¯é¡µæ˜¾ç¤ºï¼š</label>
                <select name="per_page" id="per-page-select" onchange="this.form.submit();">
                    <option value="10" <?php selected($per_page, 10); ?>>10</option>
                    <option value="20" <?php selected($per_page, 20); ?>>20</option>
                    <option value="30" <?php selected($per_page, 30); ?>>30</option>
                    <option value="50" <?php selected($per_page, 50); ?>>50</option>
                    <option value="100" <?php selected($per_page, 100); ?>>100</option>
                    <option value="300" <?php selected($per_page, 300); ?>>300</option>
                    <option value="500" <?php selected($per_page, 500); ?>>500</option>
                </select>
                <span>æ¡è®°å½•</span>
            </form>
        </div>
        <?php endif; ?>

        <?php else: ?>
        <div class="walmart-empty-state">
            <h3>ğŸ“¦ æš‚æ— å•†å“æ•°æ®</h3>
            <p>è¯·ç‚¹å‡»"åŒæ­¥Walmartå•†å“"æŒ‰é’®ä»Walmartè·å–å•†å“ä¿¡æ¯ã€‚</p>
        </div>
        <?php endif; ?>

        <!-- SKUè¯Šæ–­ç»“æœ -->
        <?php if (isset($diagnosis_results) && !empty($diagnosis_results)): ?>
        <div class="walmart-diagnosis-panel" style="margin-top: 30px; padding: 20px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
            <h3>ğŸ” SKUåŒ¹é…è¯Šæ–­ç»“æœ</h3>
            <div style="overflow-x: auto;">
                <table class="walmart-table" style="margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Walmartå•†å“</th>
                            <th>WooCommerceåŒ¹é…ç»“æœ</th>
                            <th>åº“å­˜å¯¹æ¯”</th>
                            <th>è°ƒè¯•ä¿¡æ¯</th>
                            <th>é—®é¢˜åˆ†æ</th>
                            <th>æ˜¯å¦å¯åŒæ­¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($diagnosis_results as $result): ?>
                        <tr>
                            <td>
                                <div style="font-size: 12px;">
                                    <strong>SKU:</strong> <code><?php echo esc_html($result['walmart_sku']); ?></code><br>
                                    <strong>å•†å“å:</strong> <?php echo esc_html(substr($result['walmart_product_name'] ?: 'æœªçŸ¥', 0, 30)); ?><br>
                                    <strong>Walmartåº“å­˜:</strong> <?php echo $result['walmart_inventory'] ?: '0'; ?>
                                </div>
                            </td>
                            <td>
                                <?php if ($result['wc_product_by_sku']): ?>
                                    <div style="color: #00a32a; font-size: 12px;">
                                        <strong>âœ… SKUåŒ¹é…æˆåŠŸ</strong><br>
                                        å•†å“ID: <?php echo $result['wc_product_by_sku']; ?><br>
                                        å•†å“å: <?php echo esc_html(substr($result['wc_product_name'] ?: 'æœªçŸ¥', 0, 30)); ?>
                                    </div>
                                <?php elseif ($result['wc_product_by_upc']): ?>
                                    <div style="color: #f56e28; font-size: 12px;">
                                        <strong>âš ï¸ UPCåŒ¹é…</strong><br>
                                        å•†å“ID: <?php echo $result['wc_product_by_upc']; ?>
                                    </div>
                                <?php else: ?>
                                    <span style="color: #d63638;">âŒ æœªæ‰¾åˆ°åŒ¹é…å•†å“</span>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php if ($result['wc_product_by_sku']): ?>
                                    <div style="font-size: 12px;">
                                        <strong>WCåº“å­˜:</strong> <?php echo $result['wc_stock_quantity'] ?: '0'; ?><br>
                                        <strong>Walmart:</strong> <?php echo $result['walmart_inventory'] ?: '0'; ?><br>
                                        <?php
                                        $wc_stock = (int)($result['wc_stock_quantity'] ?: 0);
                                        $walmart_stock = (int)($result['walmart_inventory'] ?: 0);
                                        if ($wc_stock !== $walmart_stock): ?>
                                            <span style="color: #f56e28;">ğŸ“Š éœ€è¦åŒæ­¥</span>
                                        <?php else: ?>
                                            <span style="color: #00a32a;">âœ… ä¸€è‡´</span>
                                        <?php endif; ?>
                                    </div>
                                <?php else: ?>
                                    <span style="color: #646970;">æ— æ³•å¯¹æ¯”</span>
                                <?php endif; ?>
                            </td>
                            <td>
                                <div style="font-size: 10px; max-width: 200px;">
                                    <strong>åŸºæœ¬æŸ¥è¯¢:</strong> <?php echo $result['debug_info']['basic_sku_query'] ?: 'æ— '; ?><br>
                                    <strong>å¿½ç•¥å¤§å°å†™:</strong> <?php echo $result['debug_info']['case_insensitive_query'] ?: 'æ— '; ?><br>
                                    <strong>å»ç©ºæ ¼:</strong> <?php echo $result['debug_info']['trimmed_query'] ?: 'æ— '; ?><br>
                                    <?php if (!empty($result['debug_info']['partial_matches'])): ?>
                                        <strong>éƒ¨åˆ†åŒ¹é…:</strong><br>
                                        <?php foreach (array_slice($result['debug_info']['partial_matches'], 0, 2) as $match): ?>
                                            ID: <?php echo $match->post_id; ?> - <code><?php echo esc_html($match->meta_value); ?></code><br>
                                        <?php endforeach; ?>
                                    <?php else: ?>
                                        <strong>éƒ¨åˆ†åŒ¹é…:</strong> æ— <br>
                                    <?php endif; ?>
                                    <?php if (isset($result['debug_info']['product_status'])): ?>
                                        <strong>å•†å“çŠ¶æ€:</strong> <?php echo $result['debug_info']['product_status']; ?><br>
                                    <?php endif; ?>
                                    <?php if ($result['debug_info']['last_error']): ?>
                                        <strong style="color: red;">SQLé”™è¯¯:</strong> <?php echo esc_html($result['debug_info']['last_error']); ?>
                                    <?php endif; ?>
                                </div>
                            </td>
                            <td style="font-size: 12px;">
                                <?php echo $result['problem_analysis']; ?>
                            </td>
                            <td>
                                <?php if ($result['can_sync']): ?>
                                    <span style="color: #00a32a; font-weight: bold;">âœ… å¯ä»¥</span>
                                <?php else: ?>
                                    <span style="color: #d63638; font-weight: bold;">âŒ ä¸å¯ä»¥</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 15px; padding: 15px; background: #fff; border-left: 4px solid #2271b1;">
                <h4>ğŸ“‹ è¯Šæ–­è¯´æ˜</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>Walmartå•†å“</strong>ï¼šæ˜¾ç¤ºWalmartå•†å“çš„SKUã€åç§°å’Œåº“å­˜</li>
                    <li><strong>WooCommerceåŒ¹é…ç»“æœ</strong>ï¼šæ£€æŸ¥æ˜¯å¦èƒ½åœ¨WooCommerceä¸­æ‰¾åˆ°å¯¹åº”çš„å•†å“</li>
                    <li><strong>åº“å­˜å¯¹æ¯”</strong>ï¼šå¯¹æ¯”WooCommerceå’ŒWalmartçš„åº“å­˜æ•°é‡</li>
                    <li><strong>ç›¸ä¼¼SKU</strong>ï¼šæ˜¾ç¤ºWooCommerceä¸­å‰ç¼€ç›¸ä¼¼çš„SKUï¼Œç”¨äºè°ƒè¯•</li>
                    <li><strong>é—®é¢˜åˆ†æ</strong>ï¼š
                        <ul style="margin-top: 5px;">
                            <li><span style="color: #00a32a;">âœ… SKUåŒ¹é…æˆåŠŸ</span>ï¼šå¯ä»¥ç›´æ¥è¿›è¡Œåº“å­˜åŒæ­¥</li>
                            <li><span style="color: #f56e28;">âš ï¸ SKUä¸åŒ¹é…ä½†UPCåŒ¹é…</span>ï¼šå»ºè®®ä½¿ç”¨UPCåŒ¹é…æ–¹å¼</li>
                            <li><span style="color: #646970;">ğŸ” æ‰¾åˆ°ç›¸ä¼¼SKU</span>ï¼šå¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´SKUæ ¼å¼</li>
                            <li><span style="color: #d63638;">âŒ æœªæ‰¾åˆ°å¯¹åº”å•†å“</span>ï¼šéœ€è¦åˆ›å»ºå•†å“æˆ–æ£€æŸ¥SKU</li>
                        </ul>
                    </li>
                </ul>

                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                    <strong>ğŸ’¡ æ“ä½œå»ºè®®ï¼š</strong>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>å¦‚æœæ˜¾ç¤º"âœ… å¯ä»¥"åŒæ­¥ï¼šç›´æ¥ä½¿ç”¨å¯¹åº”çš„åŒ¹é…æ–¹å¼è¿›è¡Œæ‰¹é‡åº“å­˜åŒæ­¥</li>
                        <li>å¦‚æœæ˜¾ç¤º"âŒ ä¸å¯ä»¥"åŒæ­¥ï¼šéœ€è¦å…ˆåœ¨WooCommerceä¸­åˆ›å»ºå¯¹åº”SKUçš„å•†å“</li>
                        <li>å¦‚æœæœ‰ç›¸ä¼¼SKUï¼šæ£€æŸ¥æ˜¯å¦æ˜¯SKUæ ¼å¼é—®é¢˜ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´</li>
                    </ul>
                </div>
            </div>
        </div>
        <?php endif; ?>


    </div>

    <script>
    // ç¡®ä¿ajaxurlå¯ç”¨
    if (typeof ajaxurl === 'undefined') {
        var ajaxurl = '<?php echo admin_url('admin-ajax.php'); ?>';
    }

    // æ’åºåŠŸèƒ½ - å¢å¼ºç‰ˆ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ”§ æ’åºåŠŸèƒ½åˆå§‹åŒ–å¼€å§‹');

        // åˆå§‹åŒ–æ’åºåŠŸèƒ½
        initSortFunction();

        // åˆå§‹åŒ–è¡¨æ ¼ç¾åŒ–
        initTableStyling();
    });

    function initSortFunction() {
        // è®¾ç½®å½“å‰æ’åºçŠ¶æ€
        const urlParams = new URLSearchParams(window.location.search);
        const currentSort = urlParams.get('sort_by');
        const currentOrder = urlParams.get('sort_order');

        console.log('ğŸ”§ å½“å‰æ’åºå‚æ•°:', { currentSort, currentOrder });

        // æ£€æŸ¥æ’åºå¤´å…ƒç´ 
        const sortHeaders = document.querySelectorAll('.sort-header');
        console.log('ğŸ“Š æ‰¾åˆ°æ’åºå¤´æ•°é‡:', sortHeaders.length);

        if (sortHeaders.length === 0) {
            console.log('âŒ æœªæ‰¾åˆ°ä»»ä½•æ’åºå¤´å…ƒç´ ');
            return;
        }

        // ä¸ºæ¯ä¸ªæ’åºå¤´æ·»åŠ æ ·å¼å’Œäº‹ä»¶
        sortHeaders.forEach((header, index) => {
            const sortField = header.getAttribute('data-sort');
            console.log(`ğŸ·ï¸ æ’åºå¤´ ${index}:`, sortField);

            // ç¡®ä¿æ’åºå›¾æ ‡å­˜åœ¨
            let sortIcon = header.querySelector('.sort-icon');
            if (!sortIcon) {
                sortIcon = document.createElement('span');
                sortIcon.className = 'sort-icon';
                header.appendChild(sortIcon);
                console.log('â• åˆ›å»ºæ’åºå›¾æ ‡:', sortField);
            }

            // å¼ºåˆ¶è®¾ç½®æ’åºå›¾æ ‡æ ·å¼
            sortIcon.style.position = 'absolute';
            sortIcon.style.right = '6px';
            sortIcon.style.top = '50%';
            sortIcon.style.transform = 'translateY(-50%)';
            sortIcon.style.fontSize = '14px';
            sortIcon.style.display = 'inline-block';
            sortIcon.style.width = '14px';
            sortIcon.style.height = '14px';
            sortIcon.style.textAlign = 'center';

            // è®¾ç½®å½“å‰æ’åºçŠ¶æ€
            header.classList.remove('sort-asc', 'sort-desc');
            if (currentSort === sortField) {
                const sortClass = currentOrder === 'asc' ? 'sort-asc' : 'sort-desc';
                header.classList.add(sortClass);
                console.log('âœ… è®¾ç½®æ’åºçŠ¶æ€:', sortField, currentOrder, sortClass);
            }

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            header.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('ğŸ–±ï¸ ç‚¹å‡»æ’åºå¤´:', sortField);

                // ç§»é™¤æ‰€æœ‰å…¶ä»–æ’åºå¤´çš„çŠ¶æ€
                sortHeaders.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });

                const currentUrl = new URL(window.location);

                // ç¡®å®šæ–°çš„æ’åºæ–¹å‘
                let newOrder = 'desc';
                if (currentUrl.searchParams.get('sort_by') === sortField) {
                    newOrder = currentUrl.searchParams.get('sort_order') === 'desc' ? 'asc' : 'desc';
                }

                console.log('æ–°æ’åºå‚æ•°:', { sortField, newOrder });

                // è®¾ç½®æ–°çš„æ’åºå‚æ•°
                currentUrl.searchParams.set('sort_by', sortField);
                currentUrl.searchParams.set('sort_order', newOrder);
                currentUrl.searchParams.set('paged', '1'); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ

                console.log('è·³è½¬åˆ°:', currentUrl.toString());

                // æ·»åŠ è§†è§‰åé¦ˆ
                this.classList.add(newOrder === 'asc' ? 'sort-asc' : 'sort-desc');

                // è·³è½¬åˆ°æ–°URL
                window.location.href = currentUrl.toString();
            });

            // æ·»åŠ æ‚¬åœæ•ˆæœ
            header.style.cursor = 'pointer';
            header.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#e8e9ea';
            });
            header.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });

        console.log('âœ… æ’åºåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    }

    function initTableStyling() {
        console.log('ğŸ¨ åˆå§‹åŒ–è¡¨æ ¼ç¾åŒ–');

        // ç¡®ä¿è¡¨æ ¼æœ‰æ­£ç¡®çš„ç±»å
        const table = document.querySelector('.walmart-table');
        if (table) {
            console.log('âœ… æ‰¾åˆ°è¡¨æ ¼å…ƒç´ ');

            // å¼ºåˆ¶åº”ç”¨æ ·å¼
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.background = '#fff';
            table.style.border = '1px solid #c3c4c7';
            table.style.borderRadius = '4px';
            table.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

            // ç¾åŒ–è¡¨å¤´
            const headers = table.querySelectorAll('th');
            headers.forEach(th => {
                th.style.background = '#f6f7f7';
                th.style.fontWeight = '600';
                th.style.color = '#1d2327';
                th.style.padding = '12px 8px';
                th.style.textAlign = 'center';
                th.style.borderBottom = '2px solid #c3c4c7';
            });

            // ç¾åŒ–è¡¨æ ¼è¡Œ
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                cells.forEach(td => {
                    td.style.padding = '12px 8px';
                    td.style.textAlign = 'center';
                    td.style.borderBottom = '1px solid #f0f0f1';
                    td.style.verticalAlign = 'middle';
                });

                // æ–‘é©¬çº¹æ•ˆæœ
                if (index % 2 === 1) {
                    row.style.backgroundColor = '#fafafa';
                }

                // æ‚¬åœæ•ˆæœ
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f9f9f9';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = index % 2 === 1 ? '#fafafa' : '';
                });
            });

            console.log('âœ… è¡¨æ ¼ç¾åŒ–å®Œæˆ');
        } else {
            console.log('âŒ æœªæ‰¾åˆ°è¡¨æ ¼å…ƒç´ ');
        }
    }

    // å…¨é€‰åŠŸèƒ½
    document.getElementById('select-all-products').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });

    // ç›‘å¬å•ä¸ªå¤é€‰æ¡†å˜åŒ–
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();

            // æ›´æ–°è¡¨æ ¼è¡Œé€‰ä¸­çŠ¶æ€
            const row = this.closest('tr');
            if (row) {
                if (this.checked) {
                    row.style.backgroundColor = '#e7f3ff';
                } else {
                    row.style.backgroundColor = '';
                }
            }

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¤é€‰æ¡†éƒ½è¢«é€‰ä¸­
            const allCheckboxes = document.querySelectorAll('.product-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            const selectAllCheckbox = document.getElementById('select-all-products');

            if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        });
    });

    // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
    function updateSelectedCount() {
        const checkedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        const count = checkedCheckboxes.length;

        // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
        const selectedCountElement = document.getElementById('selected-count');
        if (selectedCountElement) {
            selectedCountElement.textContent = `å·²é€‰æ‹© ${count} ä¸ªå•†å“`;
        }

        console.log('å·²é€‰ä¸­å•†å“æ•°é‡:', count);
    }

    // ç¡®è®¤æ‰¹é‡æ“ä½œ
    function confirmBulkAction() {
        const checkedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        const bulkAction = document.querySelector('select[name="bulk_action"]').value;
        const matchMethod = document.querySelector('select[name="match_method"]').value;

        console.log('æ‰¹é‡æ“ä½œç¡®è®¤:', {
            checkedCount: checkedCheckboxes.length,
            bulkAction: bulkAction,
            matchMethod: matchMethod
        });

        if (checkedCheckboxes.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„å•†å“ï¼');
            return false;
        }

        if (!bulkAction) {
            alert('è¯·é€‰æ‹©æ“ä½œç±»å‹ï¼');
            return false;
        }

        // æ¸…é™¤ä¹‹å‰çš„éšè—å­—æ®µ
        const container = document.getElementById('selected-products-container');
        container.innerHTML = '';

        // æ·»åŠ é€‰ä¸­å•†å“çš„éšè—å­—æ®µ
        checkedCheckboxes.forEach(checkbox => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'selected_products[]';
            hiddenInput.value = checkbox.value;
            container.appendChild(hiddenInput);
        });

        console.log('å·²æ·»åŠ éšè—å­—æ®µæ•°é‡:', container.children.length);

        const actionNames = {
            'sync_inventory': 'åŒæ­¥åº“å­˜ï¼ˆæ‰¹é‡APIï¼‰',
            'sync_price': 'åŒæ­¥ä»·æ ¼ï¼ˆæ‰¹é‡Feedï¼‰',
            'sync_product_name': 'åŒæ­¥äº§å“åç§°ï¼ˆæ‰¹é‡Feedï¼‰',
            'sync_both': 'åŒæ­¥ä»·æ ¼å’Œåº“å­˜ï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰',
            'fetch_walmart_price': 'è·å–Walmartæœ€æ–°ä»·æ ¼',
            'fetch_walmart_inventory': 'è·å–Walmartæœ€æ–°åº“å­˜',
            'fetch_walmart_both': 'è·å–Walmartä»·æ ¼å’Œåº“å­˜',
            'publish': 'å•†å“ä¸Šæ¶',
            'unpublish': 'å•†å“ä¸‹æ¶'
        };

        const matchNames = {
            'sku': 'SKU',
            'upc': 'UPC',
            'both': 'SKUå’ŒUPC'
        };

        let message = `ç¡®å®šè¦å¯¹é€‰ä¸­çš„ ${checkedCheckboxes.length} ä¸ªå•†å“æ‰§è¡Œ"${actionNames[bulkAction]}"æ“ä½œå—ï¼Ÿ\n\nåŒ¹é…æ–¹å¼ï¼š${matchNames[matchMethod]}\n\n`;

        if (bulkAction === 'sync_inventory') {
            message += `ğŸš€ æ‰¹é‡åº“å­˜åŒæ­¥ä¼˜åŒ–ï¼š\n`;
            message += `â€¢ ä½¿ç”¨Walmartæ‰¹é‡APIï¼Œæ¯æ‰¹å¤„ç†50ä¸ªå•†å“\n`;
            message += `â€¢ é¿å…APIé¢‘ç‡é™åˆ¶ï¼Œæé«˜åŒæ­¥æ•ˆç‡\n`;
            message += `â€¢ é¢„è®¡å¤„ç†æ—¶é—´ï¼šçº¦${Math.ceil(checkedCheckboxes.length / 50)}ä¸ªæ‰¹æ¬¡\n`;
            message += `â€¢ åº“å­˜æ•°æ®ä»WooCommerceè·å–å¹¶æ›´æ–°åˆ°Walmart\n\n`;
            message += `è¯·ç¡®ä¿WooCommerceä¸­çš„åº“å­˜æ•°æ®æ˜¯å‡†ç¡®çš„ï¼`;
        } else if (bulkAction === 'sync_price') {
            message += `ğŸ’° æ‰¹é‡ä»·æ ¼åŒæ­¥ä¼˜åŒ–ï¼š\n`;
            message += `â€¢ ä½¿ç”¨Walmartæ‰¹é‡ä»·æ ¼Feedï¼Œä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰å•†å“\n`;
            message += `â€¢ é¿å…APIé¢‘ç‡é™åˆ¶ï¼Œæé«˜åŒæ­¥æ•ˆç‡\n`;
            message += `â€¢ å¤„ç†æ—¶é—´ï¼šçº¦1-2åˆ†é’Ÿï¼ˆFeedæäº¤+å¤„ç†ï¼‰\n`;
            message += `â€¢ ä»·æ ¼æ•°æ®ä»WooCommerceè·å–å¹¶æ›´æ–°åˆ°Walmart\n\n`;
            message += `è¯·ç¡®ä¿WooCommerceä¸­çš„ä»·æ ¼æ•°æ®æ˜¯å‡†ç¡®çš„ï¼`;
        } else if (bulkAction === 'sync_product_name') {
            message += `ğŸ“ æ‰¹é‡äº§å“åç§°åŒæ­¥ï¼š\n`;
            message += `â€¢ ä½¿ç”¨Walmartæ‰¹é‡äº§å“ä¿¡æ¯Feedï¼Œä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰å•†å“\n`;
            message += `â€¢ é¿å…APIé¢‘ç‡é™åˆ¶ï¼Œæé«˜åŒæ­¥æ•ˆç‡\n`;
            message += `â€¢ å¤„ç†æ—¶é—´ï¼šçº¦1-2åˆ†é’Ÿï¼ˆFeedæäº¤+å¤„ç†ï¼‰\n`;
            message += `â€¢ äº§å“åç§°ä»WooCommerceè·å–å¹¶æ›´æ–°åˆ°Walmart\n\n`;
            message += `è¯·ç¡®ä¿WooCommerceä¸­çš„äº§å“åç§°æ˜¯å‡†ç¡®çš„ï¼`;
        } else if (bulkAction === 'sync_both') {
            message += `âš¡ å…¨æ‰¹é‡åŒæ­¥æ¨¡å¼ï¼š\n`;
            message += `â€¢ åº“å­˜ä½¿ç”¨æ‰¹é‡APIï¼ˆ50ä¸ªä¸€æ‰¹ï¼‰\n`;
            message += `â€¢ ä»·æ ¼ä½¿ç”¨æ‰¹é‡Feedï¼ˆä¸€æ¬¡æ€§å¤„ç†ï¼‰\n`;
            message += `â€¢ ä¸¤ä¸ªæ“ä½œéƒ½é¿å…APIé¢‘ç‡é™åˆ¶\n`;
            message += `â€¢ é¢„è®¡å¤„ç†æ—¶é—´ï¼šçº¦${Math.ceil(checkedCheckboxes.length / 50)}ä¸ªåº“å­˜æ‰¹æ¬¡ + 1ä¸ªä»·æ ¼Feed\n`;
            message += `â€¢ è¯·ç¡®ä¿WooCommerceä¸­çš„æ•°æ®æ˜¯å‡†ç¡®çš„`;
        } else if (bulkAction === 'fetch_walmart_price') {
            message += `ğŸ’² è·å–Walmartæœ€æ–°ä»·æ ¼ï¼š\n`;
            message += `â€¢ ç›´æ¥ä»Walmart APIè·å–æœ€æ–°ä»·æ ¼æ•°æ®\n`;
            message += `â€¢ ä¸ç»è¿‡ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®æœ€æ–°\n`;
            message += `â€¢ ä»…æ›´æ–°æœ¬åœ°ç¼“å­˜ä¸­çš„Walmartä»·æ ¼\n`;
            message += `â€¢ ä¸ä¼šå½±å“WooCommerceå•†å“ä»·æ ¼\n`;
            message += `â€¢ ç”¨äºæŸ¥çœ‹Walmartå¹³å°çš„æœ€æ–°ä»·æ ¼ä¿¡æ¯\n\n`;
            message += `è¿™æ˜¯åªè¯»æ“ä½œï¼Œä¸ä¼šä¿®æ”¹æ‚¨çš„WooCommerceæ•°æ®ï¼`;
        } else if (bulkAction === 'fetch_walmart_inventory') {
            message += `ğŸ“¦ è·å–Walmartæœ€æ–°åº“å­˜ï¼š\n`;
            message += `â€¢ ç›´æ¥ä»Walmart APIè·å–æœ€æ–°åº“å­˜æ•°æ®\n`;
            message += `â€¢ ä¸ç»è¿‡ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®æœ€æ–°\n`;
            message += `â€¢ ä»…æ›´æ–°æœ¬åœ°ç¼“å­˜ä¸­çš„Walmartåº“å­˜\n`;
            message += `â€¢ ä¸ä¼šå½±å“WooCommerceå•†å“åº“å­˜\n`;
            message += `â€¢ ç”¨äºæŸ¥çœ‹Walmartå¹³å°çš„æœ€æ–°åº“å­˜ä¿¡æ¯\n\n`;
            message += `è¿™æ˜¯åªè¯»æ“ä½œï¼Œä¸ä¼šä¿®æ”¹æ‚¨çš„WooCommerceæ•°æ®ï¼`;
        } else if (bulkAction === 'fetch_walmart_both') {
            message += `ğŸ”„ è·å–Walmartä»·æ ¼å’Œåº“å­˜ï¼š\n`;
            message += `â€¢ ç›´æ¥ä»Walmart APIè·å–æœ€æ–°æ•°æ®\n`;
            message += `â€¢ ä¸ç»è¿‡ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®æœ€æ–°\n`;
            message += `â€¢ åŒæ—¶æ›´æ–°ä»·æ ¼å’Œåº“å­˜ä¿¡æ¯\n`;
            message += `â€¢ ä¸ä¼šå½±å“WooCommerceå•†å“æ•°æ®\n`;
            message += `â€¢ ç”¨äºå…¨é¢äº†è§£Walmartå¹³å°çš„æœ€æ–°çŠ¶æ€\n\n`;
            message += `è¿™æ˜¯åªè¯»æ“ä½œï¼Œä¸ä¼šä¿®æ”¹æ‚¨çš„WooCommerceæ•°æ®ï¼`;
        } else {
            message += `æ­¤æ“ä½œå°†ç›´æ¥åŒæ­¥åˆ°Walmartï¼Œè¯·ç¡®è®¤æ— è¯¯åç»§ç»­ã€‚`;
        }

        return confirm(message);
    }

    function editProduct(productId) {
        // TODO: å®ç°å•†å“ç¼–è¾‘åŠŸèƒ½
        alert('å•†å“ç¼–è¾‘åŠŸèƒ½å³å°†æ¨å‡ºï¼å•†å“ID: ' + productId);
    }

    // åˆ‡æ¢é«˜çº§å¯¼å‡ºé€‰é¡¹é¢æ¿
    function toggleExportOptions() {
        const panel = document.getElementById('export-options-panel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    }

    // å¤„ç†è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´æ˜¾ç¤º
    function handleDateRangeChange() {
        const dateRangeSelect = document.querySelector('select[name="filter_date_range"]');
        const customDateRange = document.getElementById('custom-date-range');

        if (dateRangeSelect && customDateRange) {
            if (dateRangeSelect.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        }
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰å¯¼å‡ºå­—æ®µ
    function toggleAllExportFields() {
        const checkboxes = document.querySelectorAll('input[name="export_fields[]"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });
    }

    // æ˜¾ç¤ºå·®å¼‚è¯¦æƒ…å¼¹çª—
    function showDifferenceModal(type) {
        // å‘é€AJAXè¯·æ±‚è·å–å·®å¼‚å•†å“è¯¦æƒ…
        const data = {
            action: 'get_difference_products',
            type: type,
            limit: 1000, // å¢åŠ é™åˆ¶æ•°é‡ï¼Œæ˜¾ç¤ºæ›´å¤šå·®å¼‚å•†å“
            nonce: '<?php echo wp_create_nonce('walmart_difference_action'); ?>'
        };

        fetch(ajaxurl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showDifferencePopup(result.data, type);
            } else {
                alert('è·å–å·®å¼‚æ•°æ®å¤±è´¥ï¼š' + result.data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        });
    }

    // æ˜¾ç¤ºæ‰€æœ‰å·®å¼‚
    function showAllDifferences() {
        showDifferenceModal('all');
    }

    // åˆ·æ–°å·®å¼‚ç»Ÿè®¡
    function refreshDifferenceStats() {
        const button = event.target;
        const originalText = button.innerHTML;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        button.innerHTML = 'â³ åˆ·æ–°ä¸­...';
        button.disabled = true;

        const data = {
            action: 'refresh_difference_stats',
            nonce: '<?php echo wp_create_nonce('walmart_difference_action'); ?>'
        };

        fetch(ajaxurl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæœ€æ–°ç»Ÿè®¡
                location.reload();
            } else {
                alert('åˆ·æ–°å¤±è´¥ï¼š' + result.data);
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // æ˜¾ç¤ºå·®å¼‚å¼¹çª—
    function showDifferencePopup(products, type) {
        if (products.length === 0) {
            alert('æ²¡æœ‰æ‰¾åˆ°æœ‰å·®å¼‚çš„å•†å“ã€‚');
            return;
        }

        const typeNames = {
            'price': 'ä»·æ ¼å·®å¼‚',
            'inventory': 'åº“å­˜å·®å¼‚',
            'all': 'æ‰€æœ‰å·®å¼‚'
        };

        // åˆ›å»ºå¼¹çª—HTML
        const modalHtml = `
            <div id="difference-modal" data-sync-type="${type}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 8px; max-width: 90%; max-height: 90%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #1d2327;">ğŸ“Š ${typeNames[type]} - ${products.length}ä¸ªå•†å“ ${products.length >= 1000 ? '(å·²æ˜¾ç¤ºå‰1000ä¸ª)' : ''}</h3>
                        <button onclick="closeDifferenceModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                        <div style="margin-bottom: 15px;">
                            <button onclick="selectAllDiffProducts()" class="walmart-btn walmart-btn-secondary" style="margin-right: 10px;">å…¨é€‰</button>
                            <button onclick="syncSelectedDiffProducts()" class="walmart-btn walmart-btn-primary">åŒæ­¥é€‰ä¸­å•†å“</button>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #f6f7f7;">
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">é€‰æ‹©</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">å•†å“åç§°</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">SKU</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">æ²ƒå°”ç›ä»·æ ¼</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">æœ¬åœ°ä»·æ ¼</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">ä»·æ ¼å·®å¼‚</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">æ²ƒå°”ç›åº“å­˜</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">æœ¬åœ°åº“å­˜</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">åº“å­˜å·®å¼‚</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                            <input type="checkbox" class="diff-product-checkbox" value="${product.walmart_product.id}" data-sku="${product.walmart_product.sku}">
                                        </td>
                                        <td style="padding: 8px; border: 1px solid #ddd; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${product.walmart_product.product_name}">
                                            ${product.walmart_product.product_name.substring(0, 30)}${product.walmart_product.product_name.length > 30 ? '...' : ''}
                                        </td>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><code>${product.walmart_product.sku}</code></td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">$${parseFloat(product.walmart_product.price).toFixed(2)}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">$${parseFloat(product.local_data.price).toFixed(2)}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; color: ${product.price_diff > 0 ? '#00a32a' : product.price_diff < 0 ? '#d63638' : '#646970'}; font-weight: 600;">
                                            ${product.price_diff > 0 ? '+' : ''}$${product.price_diff.toFixed(2)}
                                        </td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${product.walmart_product.inventory_count}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${product.local_data.stock_quantity}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; color: ${product.inventory_diff > 0 ? '#00a32a' : product.inventory_diff < 0 ? '#d63638' : '#646970'}; font-weight: 600;">
                                            ${product.inventory_diff > 0 ? '+' : ''}${product.inventory_diff}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    // å…³é—­å·®å¼‚å¼¹çª—
    function closeDifferenceModal() {
        const modal = document.getElementById('difference-modal');
        if (modal) {
            modal.remove();
        }
    }

    // å…¨é€‰å·®å¼‚å•†å“
    function selectAllDiffProducts() {
        const checkboxes = document.querySelectorAll('.diff-product-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    // åŒæ­¥é€‰ä¸­çš„å·®å¼‚å•†å“
    function syncSelectedDiffProducts() {
        const checkboxes = document.querySelectorAll('.diff-product-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦åŒæ­¥çš„å•†å“ï¼');
            return;
        }

        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        const selectedSkus = Array.from(checkboxes).map(cb => cb.dataset.sku);

        // è·å–å½“å‰çš„åŒæ­¥ç±»å‹
        const modal = document.getElementById('difference-modal');
        const syncType = modal ? modal.getAttribute('data-sync-type') : 'all';

        // æ ¹æ®åŒæ­¥ç±»å‹è®¾ç½®ç¡®è®¤æ¶ˆæ¯
        const syncTypeNames = {
            'price': 'ä»·æ ¼',
            'inventory': 'åº“å­˜',
            'all': 'ä»·æ ¼å’Œåº“å­˜'
        };

        const syncTypeName = syncTypeNames[syncType] || 'ä»·æ ¼å’Œåº“å­˜';

        const confirmMessage = `ç¡®å®šè¦åŒæ­¥é€‰ä¸­çš„ ${selectedIds.length} ä¸ªå•†å“çš„${syncTypeName}å—ï¼Ÿ\n\n` +
                              `è¿™å°†åŒæ­¥${syncTypeName}æ•°æ®åˆ°Walmartã€‚\n\n` +
                              `å•†å“SKU: ${selectedSkus.slice(0, 5).join(', ')}${selectedSkus.length > 5 ? '...' : ''}`;

        if (confirm(confirmMessage)) {
            // å…³é—­å¼¹çª—
            closeDifferenceModal();

            // æ‰§è¡ŒåŒæ­¥æ“ä½œ
            const data = {
                action: 'sync_difference_products',
                product_ids: selectedIds,
                sync_type: syncType,
                nonce: '<?php echo wp_create_nonce('walmart_sync_action'); ?>'
            };

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = '<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10001;"><p>æ­£åœ¨åŒæ­¥å•†å“æ•°æ®ï¼Œè¯·ç¨å€™...</p></div>';
            document.body.appendChild(loadingDiv);

            fetch(ajaxurl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(result => {
                loadingDiv.remove();
                if (result.success) {
                    alert('åŒæ­¥æ“ä½œå·²å¯åŠ¨ï¼è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦ç»†è¿›åº¦ã€‚');
                    // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ•°æ®
                    location.reload();
                } else {
                    alert('åŒæ­¥å¤±è´¥ï¼š' + result.data);
                }
            })
            .catch(error => {
                loadingDiv.remove();
                console.error('Error:', error);
                alert('åŒæ­¥è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            });
        }
    }

    // æ˜¾ç¤ºå½“å‰é¡µé¢å·®å¼‚è¯¦æƒ…ï¼ˆåŸæœ‰åŠŸèƒ½ä¿ç•™ï¼‰
    function showDifferenceDetails() {
        // è·å–æ‰€æœ‰æœ‰å·®å¼‚çš„è¡Œ
        const rows = document.querySelectorAll('.walmart-table tbody tr');
        const diffRows = [];

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 10) {
                const priceDiff = cells[6].textContent.trim();
                const inventoryDiff = cells[9].textContent.trim();

                if (priceDiff !== '-' || inventoryDiff !== '-') {
                    diffRows.push(row);
                }
            }
        });

        if (diffRows.length === 0) {
            alert('å½“å‰é¡µé¢æ²¡æœ‰æ‰¾åˆ°æœ‰å·®å¼‚çš„å•†å“ã€‚');
            return;
        }

        // é«˜äº®æ˜¾ç¤ºæœ‰å·®å¼‚çš„è¡Œ
        rows.forEach(row => {
            row.style.backgroundColor = '';
            row.style.border = '';
        });

        diffRows.forEach(row => {
            row.style.backgroundColor = '#fff3cd';
            row.style.border = '2px solid #ffc107';
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        const message = `å½“å‰é¡µé¢æ‰¾åˆ° ${diffRows.length} ä¸ªæœ‰å·®å¼‚çš„å•†å“ï¼Œå·²é«˜äº®æ˜¾ç¤ºã€‚\n\n` +
                       `é»„è‰²é«˜äº®çš„å•†å“å­˜åœ¨ä»·æ ¼æˆ–åº“å­˜å·®å¼‚ï¼Œå»ºè®®è¿›è¡ŒåŒæ­¥æ“ä½œã€‚`;
        alert(message);

        // 5ç§’åç§»é™¤é«˜äº®
        setTimeout(() => {
            diffRows.forEach(row => {
                row.style.backgroundColor = '';
                row.style.border = '';
            });
        }, 5000);
    }

    // å•ä¸ªå•†å“åŒæ­¥åŠŸèƒ½
    function syncSingleProduct(productId, sku) {
        const confirmMessage = `ç¡®å®šè¦åŒæ­¥å•†å“ ${sku} å—ï¼Ÿ\n\nè¿™å°†åŒæ­¥è¯¥å•†å“çš„ä»·æ ¼å’Œåº“å­˜æ•°æ®åˆ°Walmartã€‚`;

        if (!confirm(confirmMessage)) {
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = 'â³ åŒæ­¥ä¸­...';
        button.disabled = true;

        // å‘é€AJAXè¯·æ±‚
        const data = {
            action: 'sync_single_product',
            product_id: productId,
            sku: sku,
            nonce: '<?php echo wp_create_nonce('walmart_single_sync_action'); ?>'
        };

        fetch(ajaxurl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // åŒæ­¥æˆåŠŸ
                button.innerHTML = 'âœ… æˆåŠŸ';
                button.className = 'button button-secondary button-small';

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showSyncMessage('success', `å•†å“ ${sku} åŒæ­¥æˆåŠŸï¼${result.data.message || ''}`);

                // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    button.innerHTML = 'âœ… åŒæ­¥';
                    button.disabled = false;
                }, 3000);

                // å¯é€‰ï¼šåˆ·æ–°å½“å‰è¡Œçš„æ•°æ®
                if (result.data.refresh_needed) {
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }

            } else {
                // åŒæ­¥å¤±è´¥
                button.innerHTML = 'âŒ å¤±è´¥';
                button.className = 'button button-secondary button-small';
                button.disabled = false;

                showSyncMessage('error', `å•†å“ ${sku} åŒæ­¥å¤±è´¥ï¼š${result.data || 'æœªçŸ¥é”™è¯¯'}`);

                // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.className = 'button button-primary button-small';
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.innerHTML = 'âŒ é”™è¯¯';
            button.disabled = false;

            showSyncMessage('error', `å•†å“ ${sku} åŒæ­¥è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`);

            // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                button.innerHTML = originalText;
                button.className = 'button button-primary button-small';
            }, 3000);
        });
    }

    // æ˜¾ç¤ºåŒæ­¥æ¶ˆæ¯
    function showSyncMessage(type, message) {
        // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
        const existingMessage = document.querySelector('.sync-message');
        if (existingMessage) {
            existingMessage.remove();
        }

        // åˆ›å»ºæ–°æ¶ˆæ¯
        const messageDiv = document.createElement('div');
        messageDiv.className = `notice sync-message ${type === 'success' ? 'notice-success' : 'notice-error'} is-dismissible`;
        messageDiv.style.position = 'fixed';
        messageDiv.style.top = '32px';
        messageDiv.style.right = '20px';
        messageDiv.style.zIndex = '10000';
        messageDiv.style.maxWidth = '400px';
        messageDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';

        messageDiv.innerHTML = `
            <p><strong>${type === 'success' ? 'âœ… åŒæ­¥æˆåŠŸ' : 'âŒ åŒæ­¥å¤±è´¥'}</strong></p>
            <p>${message}</p>
            <button type="button" class="notice-dismiss" onclick="this.parentElement.remove()">
                <span class="screen-reader-text">å…³é—­</span>
            </button>
        `;

        document.body.appendChild(messageDiv);

        // 5ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.remove();
            }
        }, 5000);
    }

    // åº”ç”¨è¡¨æ ¼ç­›é€‰
    function applyTableFilters() {
        const priceMin = document.querySelector('input[name="price_min"]').value;
        const priceMax = document.querySelector('input[name="price_max"]').value;
        const inventoryMin = document.querySelector('input[name="inventory_min"]').value;
        const inventoryMax = document.querySelector('input[name="inventory_max"]').value;

        // æ„å»ºURLå‚æ•°
        const currentUrl = new URL(window.location);
        const params = new URLSearchParams(currentUrl.search);

        // æ›´æ–°ç­›é€‰å‚æ•°
        if (priceMin) {
            params.set('price_min', priceMin);
        } else {
            params.delete('price_min');
        }

        if (priceMax) {
            params.set('price_max', priceMax);
        } else {
            params.delete('price_max');
        }

        if (inventoryMin) {
            params.set('inventory_min', inventoryMin);
        } else {
            params.delete('inventory_min');
        }

        if (inventoryMax) {
            params.set('inventory_max', inventoryMax);
        } else {
            params.delete('inventory_max');
        }

        // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        params.delete('paged');

        // è·³è½¬åˆ°æ–°URL
        window.location.href = currentUrl.pathname + '?' + params.toString();
    }

    // æ¸…é™¤è¡¨æ ¼ç­›é€‰
    function clearTableFilters() {
        const currentUrl = new URL(window.location);
        const params = new URLSearchParams(currentUrl.search);

        // åˆ é™¤ç­›é€‰å‚æ•°
        params.delete('price_min');
        params.delete('price_max');
        params.delete('inventory_min');
        params.delete('inventory_max');
        params.delete('paged');

        // è·³è½¬åˆ°æ–°URL
        window.location.href = currentUrl.pathname + '?' + params.toString();
    }

    // åˆå§‹åŒ–
    updateSelectedCount();

    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
        // æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨äº‹ä»¶
        const dateRangeSelect = document.querySelector('select[name="filter_date_range"]');
        if (dateRangeSelect) {
            dateRangeSelect.addEventListener('change', handleDateRangeChange);
        }

        // ç­›é€‰è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        const filterInputs = document.querySelectorAll('input[name="price_min"], input[name="price_max"], input[name="inventory_min"], input[name="inventory_max"]');
        filterInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyTableFilters();
                }
            });
        });
    });
    </script>
    <?php
}

// å›¾ç‰‡æ‰«æç®¡ç†é¡µé¢
function woo_walmart_image_scanner_page() {
    // æ£€æŸ¥æƒé™
    if (!current_user_can('manage_options')) {
        wp_die(__('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢ã€‚'));
    }

    // åŒ…å«å›¾ç‰‡æ‰«æå™¨ç±»
    require_once plugin_dir_path(__FILE__) . 'includes/class-image-scanner.php';
    $scanner = new Walmart_Image_Scanner();

    $result_message = '';
    $scan_results = null;

    // å¤„ç†æ‰«æè¯·æ±‚
    if (isset($_POST['action']) && $_POST['action'] === 'scan_images') {
        check_admin_referer('walmart_image_scan');

        $scan_type = sanitize_text_field($_POST['scan_type']);

        if ($scan_type === 'category') {
            $category = sanitize_text_field($_POST['category']);
            if (!empty($category)) {
                $scan_results = $scanner->scan_by_category($category);
                $result_message = '<div class="updated"><p>âœ… åˆ†ç±»æ‰«æå®Œæˆï¼šåœ¨ ' . $scan_results['total_products'] . ' ä¸ªäº§å“ä¸­å‘ç° ' . $scan_results['problem_products'] . ' ä¸ªäº§å“æœ‰è¶…å¤§å›¾ç‰‡ã€‚</p></div>';
            }
        } elseif ($scan_type === 'sku_batch') {
            $sku_list = sanitize_textarea_field($_POST['sku_list']);
            if (!empty($sku_list)) {
                $scan_results = $scanner->scan_by_skus($sku_list);
                $result_message = '<div class="updated"><p>âœ… SKUæ‰¹é‡æ‰«æå®Œæˆï¼šåœ¨ ' . $scan_results['found_products'] . ' ä¸ªæ‰¾åˆ°çš„äº§å“ä¸­å‘ç° ' . $scan_results['problem_products'] . ' ä¸ªäº§å“æœ‰è¶…å¤§å›¾ç‰‡ã€‚</p></div>';
            }
        }
    }

    // å¤„ç†æ‰¹é‡æ“ä½œ
    if (isset($_POST['action']) && $_POST['action'] === 'batch_process') {
        check_admin_referer('walmart_image_process');

        $process_type = sanitize_text_field($_POST['process_type']);
        $selected_products = json_decode(stripslashes($_POST['selected_products']), true);

        if (!empty($selected_products)) {
            $batch_result = $scanner->batch_process($selected_products, $process_type);

            $action_name = ($process_type === 'delete') ? 'åˆ é™¤' : 'æ ‡è®°è·³è¿‡';
            $result_message = '<div class="updated"><p>âœ… æ‰¹é‡' . $action_name . 'å®Œæˆï¼šæˆåŠŸå¤„ç† ' . $batch_result['success_count'] . ' ä¸ªäº§å“ï¼Œå¤±è´¥ ' . $batch_result['failed_count'] . ' ä¸ªäº§å“ã€‚</p></div>';
        }
    }

    ?>
    <div class="wrap">
        <h1>å›¾ç‰‡æ‰«æç®¡ç†</h1>
        <p>æ‰«æäº§å“ä¸­è¶…è¿‡5MBçš„å›¾ç‰‡ï¼Œå¹¶æä¾›åˆ é™¤æˆ–æ ‡è®°è·³è¿‡çš„å¤„ç†æ–¹å¼ã€‚</p>

        <?php echo $result_message; ?>

        <!-- æ‰«æé€‰é¡¹ -->
        <div class="walmart-card">
            <h2>æ‰«æé€‰é¡¹</h2>

            <!-- æŒ‰åˆ†ç±»æ‰«æ -->
            <div class="scan-option-group">
                <h3>ğŸ·ï¸ æŒ‰åˆ†ç±»æ‰«æ</h3>
                <form method="post" style="display: inline-block;">
                    <?php wp_nonce_field('walmart_image_scan'); ?>
                    <input type="hidden" name="action" value="scan_images">
                    <input type="hidden" name="scan_type" value="category">

                    <select name="category" required style="min-width: 400px;">
                        <option value="">é€‰æ‹©åˆ†ç±»...</option>
                        <?php
                        // è·å–æ‰€æœ‰WooCommerceäº§å“åˆ†ç±»ï¼ˆçœŸå®åˆ†ç±»ç»“æ„ï¼‰
                        $wc_categories = get_terms([
                            'taxonomy' => 'product_cat',
                            'hide_empty' => false,
                            'orderby' => 'name',
                            'order' => 'ASC'
                        ]);

                        // æ„å»ºå±‚çº§æ ‘ç»“æ„
                        function build_category_tree($categories, $parent_id = 0) {
                            $tree = [];
                            foreach ($categories as $category) {
                                if ($category->parent == $parent_id) {
                                    $children = build_category_tree($categories, $category->term_id);
                                    $tree[] = [
                                        'category' => $category,
                                        'children' => $children
                                    ];
                                }
                            }
                            return $tree;
                        }

                        // é€’å½’æ˜¾ç¤ºåˆ†ç±»é€‰é¡¹
                        function display_category_options($tree, $level = 0) {
                            foreach ($tree as $item) {
                                $category = $item['category'];
                                $indent = str_repeat('ã€€', $level);
                                $display_name = $indent . $category->name . ' (' . $category->count . ' ä¸ªäº§å“)';

                                // åªæ˜¾ç¤ºæœ‰äº§å“çš„åˆ†ç±»
                                if ($category->count > 0) {
                                    echo '<option value="' . esc_attr($category->term_id) . '">' . esc_html($display_name) . '</option>';
                                }

                                // é€’å½’æ˜¾ç¤ºå­åˆ†ç±»
                                if (!empty($item['children'])) {
                                    display_category_options($item['children'], $level + 1);
                                }
                            }
                        }

                        $category_tree = build_category_tree($wc_categories);
                        display_category_options($category_tree);
                        ?>
                    </select>

                    <button type="submit" class="walmart-btn walmart-btn-primary">ğŸ” æ‰«ææ­¤åˆ†ç±»</button>
                </form>
                <p class="description">æ‰«ææŒ‡å®šåˆ†ç±»ä¸‹æ‰€æœ‰äº§å“çš„å›¾ç‰‡å¤§å°</p>
            </div>

            <!-- æŒ‰SKUæ‰¹é‡æ‰«æ -->
            <div class="scan-option-group">
                <h3>ğŸ“ æŒ‰SKUæ‰¹é‡æ‰«æ</h3>
                <form method="post">
                    <?php wp_nonce_field('walmart_image_scan'); ?>
                    <input type="hidden" name="action" value="scan_images">
                    <input type="hidden" name="scan_type" value="sku_batch">

                    <textarea name="sku_list" rows="6" cols="50" placeholder="è¾“å…¥SKUï¼Œæ¯è¡Œä¸€ä¸ªï¼š&#10;W834S00491&#10;W714S00830&#10;..." required style="width: 100%; max-width: 500px;"></textarea>
                    <br><br>
                    <button type="submit" class="walmart-btn walmart-btn-primary">ğŸ” æ‰«æè¿™äº›SKU</button>
                </form>
                <p class="description">è¾“å…¥å¤šä¸ªSKUè¿›è¡Œæ‰¹é‡æ‰«æï¼Œæ¯è¡Œä¸€ä¸ªSKU</p>
            </div>
        </div>

        <?php if ($scan_results && !empty($scan_results['results'])): ?>
        <!-- æ‰«æç»“æœ -->
        <div class="walmart-card">
            <h2>æ‰«æç»“æœ</h2>

            <div class="scan-summary">
                <p><strong>æ‰«æç±»å‹ï¼š</strong><?php echo esc_html($scan_results['scan_type'] === 'category' ? 'åˆ†ç±»æ‰«æ' : 'SKUæ‰¹é‡æ‰«æ'); ?></p>
                <p><strong>æ‰«æç›®æ ‡ï¼š</strong><?php echo esc_html($scan_results['scan_target']); ?></p>
                <p><strong>å‘ç°é—®é¢˜ï¼š</strong><?php echo count($scan_results['results']); ?> ä¸ªäº§å“æœ‰è¶…è¿‡5MBçš„å›¾ç‰‡</p>
            </div>

            <form method="post" id="batch-process-form">
                <?php wp_nonce_field('walmart_image_process'); ?>
                <input type="hidden" name="action" value="batch_process">
                <input type="hidden" name="selected_products" id="selected-products-data">

                <div class="bulk-actions-bar">
                    <select name="process_type" id="process-type" required>
                        <option value="">é€‰æ‹©å¤„ç†æ–¹å¼...</option>
                        <option value="delete">ğŸ—‘ï¸ ç›´æ¥åˆ é™¤è¶…å¤§å›¾ç‰‡</option>
                        <option value="mark">ğŸ·ï¸ æ ‡è®°è·³è¿‡è¶…å¤§å›¾ç‰‡</option>
                    </select>

                    <button type="button" class="walmart-btn walmart-btn-secondary" onclick="selectAllProducts()">å…¨é€‰</button>
                    <button type="button" class="walmart-btn walmart-btn-secondary" onclick="deselectAllProducts()">å–æ¶ˆå…¨é€‰</button>
                    <button type="submit" class="walmart-btn walmart-btn-primary" onclick="return confirmBatchProcess()">æ‰§è¡Œå¤„ç†</button>
                </div>

                <table class="wp-list-table widefat fixed striped">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="select-all-checkbox"></th>
                            <th>äº§å“ä¿¡æ¯</th>
                            <th>è¶…å¤§å›¾ç‰‡</th>
                            <th>æ€»å¤§å°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($scan_results['results'] as $index => $result): ?>
                        <tr>
                            <td>
                                <input type="checkbox" class="product-checkbox"
                                       data-product='<?php echo esc_attr(json_encode($result)); ?>'>
                            </td>
                            <td>
                                <strong><?php echo esc_html($result['name']); ?></strong><br>
                                <small>SKU: <?php echo esc_html($result['sku']); ?></small><br>
                                <small>ID: <?php echo esc_html($result['product_id']); ?></small>
                            </td>
                            <td>
                                <strong style="color: #d63638;"><?php echo $result['oversized_count']; ?> å¼ è¶…å¤§å›¾ç‰‡</strong><br>
                                <?php foreach ($result['oversized_images'] as $img): ?>
                                    <div style="font-size: 11px; margin: 2px 0;">
                                        å›¾ç‰‡<?php echo ($img['index'] + 1); ?>: <?php echo esc_html($img['size_formatted']); ?>
                                        <?php if ($img['is_main']): ?>
                                            <span style="color: #d63638; font-weight: bold;">(ä¸»å›¾)</span>
                                        <?php endif; ?>
                                    </div>
                                <?php endforeach; ?>
                            </td>
                            <td>
                                <?php echo esc_html($result['total_size_formatted']); ?><br>
                                <small><?php echo $result['total_images']; ?> å¼ å›¾ç‰‡</small>
                            </td>
                            <td>
                                <button type="button" class="walmart-btn walmart-btn-small"
                                        onclick="previewProduct(<?php echo $result['product_id']; ?>)">
                                    é¢„è§ˆ
                                </button>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </form>
        </div>
        <?php endif; ?>

        <!-- å¤„ç†è¯´æ˜ -->
        <div class="walmart-card">
            <h2>å¤„ç†æ–¹å¼è¯´æ˜</h2>

            <div class="process-explanation">
                <div class="process-option">
                    <h4>ğŸ—‘ï¸ ç›´æ¥åˆ é™¤</h4>
                    <ul>
                        <li>æ°¸ä¹…åˆ é™¤è¶…è¿‡5MBçš„å›¾ç‰‡URLå¼•ç”¨</li>
                        <li>å¦‚æœä¸»å›¾è¢«åˆ é™¤ï¼Œè‡ªåŠ¨å°†ç¬¬ä¸€å¼ å‰¯å›¾è®¾ä¸ºä¸»å›¾</li>
                        <li>é‡æ–°ç»„ç»‡å›¾ç‰‡é¡ºåºï¼Œä¿æŒè¿ç»­æ€§</li>
                        <li><strong>æ³¨æ„ï¼š</strong>åˆ é™¤åæ— æ³•æ¢å¤</li>
                    </ul>
                </div>

                <div class="process-option">
                    <h4>ğŸ·ï¸ æ ‡è®°è·³è¿‡</h4>
                    <ul>
                        <li>ä¿ç•™å›¾ç‰‡URLï¼Œä½†æ ‡è®°ä¸ºè·³è¿‡</li>
                        <li>WalmartåŒæ­¥æ—¶ä¼šè‡ªåŠ¨è·³è¿‡æ ‡è®°çš„å›¾ç‰‡</li>
                        <li>å¦‚æœä¸»å›¾è¢«æ ‡è®°ï¼Œè‡ªåŠ¨ä½¿ç”¨ç¬¬ä¸€å¼ æœªæ ‡è®°çš„å‰¯å›¾</li>
                        <li><strong>ä¼˜åŠ¿ï¼š</strong>å¯ä»¥éšæ—¶å–æ¶ˆæ ‡è®°æ¢å¤å›¾ç‰‡</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <style>
    .walmart-card {
        background: #fff;
        border: 1px solid #ccd0d4;
        border-radius: 4px;
        padding: 20px;
        margin: 20px 0;
    }

    .scan-option-group {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #e1e1e1;
        border-radius: 4px;
        background: #f9f9f9;
    }

    .scan-summary {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .bulk-actions-bar {
        margin: 15px 0;
        padding: 10px;
        background: #f0f0f1;
        border-radius: 4px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .process-explanation {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 15px;
    }

    .process-option {
        padding: 15px;
        border: 1px solid #e1e1e1;
        border-radius: 4px;
        background: #fafafa;
    }

    .process-option h4 {
        margin-top: 0;
        color: #2271b1;
    }

    .walmart-btn-small {
        padding: 4px 8px;
        font-size: 11px;
    }
    </style>

    <script>
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    document.getElementById('select-all-checkbox').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    function selectAllProducts() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
        document.getElementById('select-all-checkbox').checked = true;
    }

    function deselectAllProducts() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        document.getElementById('select-all-checkbox').checked = false;
    }

    // ç¡®è®¤æ‰¹é‡å¤„ç†
    function confirmBatchProcess() {
        const processType = document.getElementById('process-type').value;
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');

        if (!processType) {
            alert('è¯·é€‰æ‹©å¤„ç†æ–¹å¼');
            return false;
        }

        if (checkedBoxes.length === 0) {
            alert('è¯·é€‰æ‹©è¦å¤„ç†çš„äº§å“');
            return false;
        }

        const actionName = processType === 'delete' ? 'åˆ é™¤' : 'æ ‡è®°è·³è¿‡';
        const confirmMessage = `ç¡®å®šè¦å¯¹é€‰ä¸­çš„ ${checkedBoxes.length} ä¸ªäº§å“æ‰§è¡Œ"${actionName}"æ“ä½œå—ï¼Ÿ\n\n` +
                              (processType === 'delete' ? 'âš ï¸ åˆ é™¤æ“ä½œæ— æ³•æ¢å¤ï¼' : 'ğŸ’¡ æ ‡è®°æ“ä½œå¯ä»¥éšæ—¶å–æ¶ˆã€‚');

        if (confirm(confirmMessage)) {
            // æ”¶é›†é€‰ä¸­çš„äº§å“æ•°æ®
            const selectedProducts = [];
            checkedBoxes.forEach(cb => {
                selectedProducts.push(JSON.parse(cb.dataset.product));
            });

            document.getElementById('selected-products-data').value = JSON.stringify(selectedProducts);
            return true;
        }

        return false;
    }

    // é¢„è§ˆäº§å“
    function previewProduct(productId) {
        const url = '<?php echo admin_url('post.php'); ?>?post=' + productId + '&action=edit';
        window.open(url, '_blank');
    }
    </script>
    <?php
}

// WalmartåŒæ­¥é€šçŸ¥é¡µé¢
function woo_walmart_notifications_page() {
    // æ£€æŸ¥æƒé™
    if (!current_user_can('manage_options')) {
        wp_die(__('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢ã€‚'));
    }

    global $wpdb;
    $notifications_table = $wpdb->prefix . 'walmart_sync_notifications';
    $result_message = '';

    // å¤„ç†æ“ä½œ
    if (isset($_POST['action'])) {
        check_admin_referer('walmart_notifications_action');

        switch ($_POST['action']) {
            case 'mark_read':
                if (!empty($_POST['notification_ids'])) {
                    $ids = array_map('intval', $_POST['notification_ids']);
                    $placeholders = implode(',', array_fill(0, count($ids), '%d'));
                    $prepare_values = array_merge([current_time('mysql')], array_map('intval', $ids));
                    $wpdb->query($wpdb->prepare(
                        "UPDATE {$notifications_table} SET status = 'read', read_at = %s WHERE id IN ({$placeholders})",
                        $prepare_values
                    ));
                    $result_message = '<div class="notice notice-success"><p>å·²æ ‡è®° ' . count($ids) . ' æ¡é€šçŸ¥ä¸ºå·²è¯»ã€‚</p></div>';
                }
                break;

            case 'delete_notifications':
                if (!empty($_POST['notification_ids'])) {
                    $ids = array_map('intval', $_POST['notification_ids']);
                    $placeholders = implode(',', array_fill(0, count($ids), '%d'));
                    $wpdb->query($wpdb->prepare(
                        "DELETE FROM {$notifications_table} WHERE id IN ({$placeholders})",
                        $ids
                    ));
                    $result_message = '<div class="notice notice-success"><p>å·²åˆ é™¤ ' . count($ids) . ' æ¡é€šçŸ¥ã€‚</p></div>';
                }
                break;

            case 'clear_all_read':
                $wpdb->query("DELETE FROM {$notifications_table} WHERE status = 'read'");
                $result_message = '<div class="notice notice-success"><p>å·²æ¸…é™¤æ‰€æœ‰å·²è¯»é€šçŸ¥ã€‚</p></div>';
                break;
        }
    }

    // è·å–é€šçŸ¥åˆ—è¡¨
    $per_page = 20;
    $current_page = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
    $offset = ($current_page - 1) * $per_page;

    $status_filter = isset($_GET['status_filter']) ? sanitize_text_field($_GET['status_filter']) : '';
    $type_filter = isset($_GET['type_filter']) ? sanitize_text_field($_GET['type_filter']) : '';

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    $where_conditions = ['1=1'];
    $where_values = [];

    if (!empty($status_filter)) {
        $where_conditions[] = "status = %s";
        $where_values[] = $status_filter;
    }

    if (!empty($type_filter)) {
        $where_conditions[] = "notification_type = %s";
        $where_values[] = $type_filter;
    }

    $where_clause = implode(' AND ', $where_conditions);

    // è·å–æ€»æ•°
    $total_query = "SELECT COUNT(*) FROM {$notifications_table} WHERE {$where_clause}";
    if (!empty($where_values)) {
        $total_items = $wpdb->get_var($wpdb->prepare($total_query, $where_values));
    } else {
        $total_items = $wpdb->get_var($total_query);
    }

    // è·å–é€šçŸ¥åˆ—è¡¨
    $notifications_query = "SELECT * FROM {$notifications_table} WHERE {$where_clause} ORDER BY created_at DESC LIMIT %d OFFSET %d";
    $query_values = array_merge($where_values, [(int) $per_page, (int) $offset]);
    $notifications = $wpdb->get_results($wpdb->prepare($notifications_query, $query_values));

    // è®¡ç®—åˆ†é¡µ
    $total_pages = ceil($total_items / $per_page);

    // è·å–ç»Ÿè®¡ä¿¡æ¯
    $stats = [
        'total' => $wpdb->get_var("SELECT COUNT(*) FROM {$notifications_table}"),
        'unread' => $wpdb->get_var("SELECT COUNT(*) FROM {$notifications_table} WHERE status = 'unread'"),
        'error' => $wpdb->get_var("SELECT COUNT(*) FROM {$notifications_table} WHERE priority = 'error'"),
        'success' => $wpdb->get_var("SELECT COUNT(*) FROM {$notifications_table} WHERE priority = 'success'")
    ];

    ?>
    <div class="wrap walmart-notifications">
        <h1><span class="dashicons dashicons-bell"></span> WalmartåŒæ­¥é€šçŸ¥</h1>
        <p class="description">æŸ¥çœ‹WalmartåŒæ­¥è¿‡ç¨‹ä¸­çš„é€šçŸ¥å’Œé”™è¯¯ä¿¡æ¯</p>

        <?php echo $result_message; ?>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="walmart-stats-container">
            <div class="walmart-stat-box">
                <h3>ğŸ“Š æ€»é€šçŸ¥</h3>
                <div class="stat-number"><?php echo $stats['total'] ?: 0; ?></div>
                <p>æ‰€æœ‰é€šçŸ¥</p>
            </div>

            <div class="walmart-stat-box">
                <h3>ğŸ”” æœªè¯»</h3>
                <div class="stat-number" style="color: #f56e28;"><?php echo $stats['unread'] ?: 0; ?></div>
                <p>æœªè¯»é€šçŸ¥</p>
            </div>

            <div class="walmart-stat-box">
                <h3>âŒ é”™è¯¯</h3>
                <div class="stat-number" style="color: #d63638;"><?php echo $stats['error'] ?: 0; ?></div>
                <p>é”™è¯¯é€šçŸ¥</p>
            </div>

            <div class="walmart-stat-box">
                <h3>âœ… æˆåŠŸ</h3>
                <div class="stat-number" style="color: #00a32a;"><?php echo $stats['success'] ?: 0; ?></div>
                <p>æˆåŠŸé€šçŸ¥</p>
            </div>
        </div>

        <!-- ç­›é€‰é¢æ¿ -->
        <div class="walmart-search-panel">
            <form method="get" class="search-form">
                <input type="hidden" name="page" value="woo-walmart-notifications">
                <div class="search-group">
                    <select name="status_filter" class="status-filter">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="unread" <?php selected($status_filter, 'unread'); ?>>æœªè¯»</option>
                        <option value="read" <?php selected($status_filter, 'read'); ?>>å·²è¯»</option>
                    </select>
                    <select name="type_filter" class="type-filter">
                        <option value="">æ‰€æœ‰ç±»å‹</option>
                        <option value="sync_success" <?php selected($type_filter, 'sync_success'); ?>>åŒæ­¥æˆåŠŸ</option>
                        <option value="api_error" <?php selected($type_filter, 'api_error'); ?>>APIé”™è¯¯</option>
                        <option value="inventory_sync" <?php selected($type_filter, 'inventory_sync'); ?>>åº“å­˜åŒæ­¥</option>
                        <option value="price_sync" <?php selected($type_filter, 'price_sync'); ?>>ä»·æ ¼åŒæ­¥</option>
                    </select>
                    <button type="submit" class="walmart-btn walmart-btn-secondary">ğŸ” ç­›é€‰</button>
                    <?php if (!empty($status_filter) || !empty($type_filter)): ?>
                        <a href="<?php echo admin_url('admin.php?page=woo-walmart-notifications'); ?>"
                           class="walmart-btn walmart-btn-secondary">æ¸…é™¤ç­›é€‰</a>
                    <?php endif; ?>
                </div>
            </form>
        </div>

        <!-- æ‰¹é‡æ“ä½œ -->
        <?php if (!empty($notifications)): ?>
        <form method="post" id="notifications-form">
            <?php wp_nonce_field('walmart_notifications_action'); ?>

            <div class="walmart-bulk-actions">
                <select name="action" id="bulk-action">
                    <option value="">æ‰¹é‡æ“ä½œ</option>
                    <option value="mark_read">æ ‡è®°ä¸ºå·²è¯»</option>
                    <option value="delete_notifications">åˆ é™¤</option>
                </select>
                <button type="submit" class="walmart-btn walmart-btn-secondary"
                        onclick="return confirm('ç¡®å®šè¦æ‰§è¡Œæ­¤æ‰¹é‡æ“ä½œå—ï¼Ÿ');">æ‰§è¡Œ</button>

                <button type="submit" name="action" value="clear_all_read"
                        class="walmart-btn walmart-btn-secondary"
                        onclick="return confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²è¯»é€šçŸ¥å—ï¼Ÿ');">
                    æ¸…é™¤å·²è¯»é€šçŸ¥
                </button>
            </div>

            <!-- é€šçŸ¥åˆ—è¡¨ -->
            <div class="walmart-notifications-list">
                <?php foreach ($notifications as $notification): ?>
                <div class="notification-item <?php echo $notification->status === 'unread' ? 'unread' : 'read'; ?> priority-<?php echo $notification->priority; ?>">
                    <div class="notification-checkbox">
                        <input type="checkbox" name="notification_ids[]" value="<?php echo $notification->id; ?>">
                    </div>

                    <div class="notification-content">
                        <div class="notification-header">
                            <h4><?php echo esc_html($notification->title); ?></h4>
                            <div class="notification-meta">
                                <span class="notification-type"><?php echo esc_html($notification->notification_type); ?></span>
                                <span class="notification-time"><?php echo human_time_diff(strtotime($notification->created_at), current_time('timestamp')); ?>å‰</span>
                                <?php if ($notification->status === 'unread'): ?>
                                    <span class="notification-status unread">æœªè¯»</span>
                                <?php endif; ?>
                            </div>
                        </div>

                        <div class="notification-message">
                            <?php echo esc_html($notification->message); ?>
                        </div>

                        <?php if (!empty($notification->related_data)): ?>
                        <div class="notification-details">
                            <details>
                                <summary>æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</summary>
                                <pre><?php echo esc_html(json_encode(json_decode($notification->related_data), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)); ?></pre>
                            </details>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
                <?php endforeach; ?>
            </div>
        </form>

        <!-- åˆ†é¡µ -->
        <?php if ($total_pages > 1): ?>
        <div class="walmart-pagination">
            <?php
            $pagination_args = [
                'base' => add_query_arg('paged', '%#%'),
                'format' => '',
                'current' => $current_page,
                'total' => $total_pages,
                'prev_text' => 'â€¹ ä¸Šä¸€é¡µ',
                'next_text' => 'ä¸‹ä¸€é¡µ â€º'
            ];
            echo paginate_links($pagination_args);
            ?>
        </div>
        <?php endif; ?>

        <?php else: ?>
        <div class="walmart-empty-state">
            <h3>ğŸ”” æš‚æ— é€šçŸ¥</h3>
            <p>å½“å‰æ²¡æœ‰åŒæ­¥é€šçŸ¥ã€‚</p>
        </div>
        <?php endif; ?>
    </div>
    <?php
}

// UPCå¯¼å‡ºå¤„ç†å‡½æ•°
function woo_walmart_upc_export_handler() {
    // ç›´æ¥åŒ…å«å¯¼å‡ºå¤„ç†æ–‡ä»¶
    require_once WOO_WALMART_SYNC_PATH . 'upc-export.php';
}

// AJAXå¤„ç†å‡½æ•°ï¼šæ‰¹é‡ä¼˜åŒ–é¡µé¢ç›¸å…³
add_action('wp_ajax_validate_sku_list', 'handle_validate_sku_list');
add_action('wp_ajax_start_sku_batch_sync', 'handle_start_sku_batch_sync');
add_action('wp_ajax_convert_skus_to_product_ids', 'handle_convert_skus_to_product_ids');
add_action('wp_ajax_walmart_batch_sync_products', 'handle_walmart_batch_sync_products');

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šæ‰¹é‡äº§å“åŒæ­¥
 */
function handle_walmart_batch_sync_products() {
    // ğŸ”§ å¢å¼ºé”™è¯¯å¤„ç†å’Œè¾“å‡ºç¼“å†²
    ob_start(); // å¼€å§‹è¾“å‡ºç¼“å†²ï¼Œé˜²æ­¢æ„å¤–è¾“å‡º

    try {
        // è®¾ç½®æ›´é•¿çš„æ‰§è¡Œæ—¶é—´å’Œå†…å­˜é™åˆ¶
        @ini_set('max_execution_time', 300); // 5åˆ†é’Ÿ
        @ini_set('memory_limit', '512M');

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        if (!is_user_logged_in()) {
            ob_clean(); // æ¸…ç†è¾“å‡ºç¼“å†²
            wp_send_json_error(['message' => 'ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•WordPressåå°']);
            return;
        }

        // æ£€æŸ¥ç”¨æˆ·æƒé™
        if (!current_user_can('manage_options')) {
            ob_clean();
            wp_send_json_error(['message' => 'æƒé™ä¸è¶³ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™']);
            return;
        }

        // éªŒè¯nonceå®‰å…¨ä»¤ç‰Œ
        if (!wp_verify_nonce($_POST['nonce'], 'sku_batch_sync_nonce')) {
            ob_clean();
            wp_send_json_error(['message' => 'å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•']);
            return;
        }

        // è·å–POSTæ•°æ®
        $product_ids = isset($_POST['product_ids']) ? array_map('intval', $_POST['product_ids']) : [];
        $force_sync = isset($_POST['force_sync']) ? (bool) $_POST['force_sync'] : false;
        $skip_validation = isset($_POST['skip_validation']) ? (bool) $_POST['skip_validation'] : false;

        // éªŒè¯äº§å“ID
        if (empty($product_ids)) {
            ob_clean();
            wp_send_json_error(['message' => 'æ²¡æœ‰æä¾›æœ‰æ•ˆçš„äº§å“ID']);
            return;
        }

        // é™åˆ¶æ‰¹é‡åŒæ­¥æ•°é‡
        if (count($product_ids) > 10000) {
            ob_clean();
            wp_send_json_error(['message' => 'æ‰¹é‡åŒæ­¥æœ€å¤šæ”¯æŒ10000ä¸ªäº§å“']);
            return;
        }

        // è®°å½•æ‰¹é‡åŒæ­¥å¼€å§‹
        woo_walmart_sync_log('æ‰¹é‡äº§å“åŒæ­¥', 'ä¿¡æ¯', [
            'product_count' => count($product_ids),
            'product_ids' => $product_ids,
            'force_sync' => $force_sync,
            'skip_validation' => $skip_validation
        ], 'å¼€å§‹æ‰¹é‡äº§å“åŒæ­¥');

        // ä½¿ç”¨æ‰¹é‡Feedæ„å»ºå™¨å¤„ç†åŒæ­¥
        $batch_builder = new Walmart_Batch_Feed_Builder();

        // åˆ›å»ºæ‰¹æ¬¡å¹¶å¤„ç†
        $result = $batch_builder->create_batch($product_ids, 'batch_feed');

        // æ¸…ç†è¾“å‡ºç¼“å†²
        ob_clean();

        if ($result['success']) {
            // è®°å½•æˆåŠŸ
            woo_walmart_sync_log('æ‰¹é‡äº§å“åŒæ­¥', 'æˆåŠŸ', [
                'batch_id' => $result['batch_id'],
                'feed_id' => $result['feed_id'] ?? null,
                'product_count' => count($product_ids)
            ], 'æ‰¹é‡äº§å“åŒæ­¥æäº¤æˆåŠŸ');

            wp_send_json_success([
                'message' => $result['message'],
                'batch_id' => $result['batch_id'],
                'feed_id' => $result['feed_id'] ?? null,
                'product_count' => count($product_ids)
            ]);
        } else {
            // è®°å½•å¤±è´¥
            woo_walmart_sync_log('æ‰¹é‡äº§å“åŒæ­¥', 'é”™è¯¯', [
                'error_message' => $result['message'],
                'product_count' => count($product_ids)
            ], 'æ‰¹é‡äº§å“åŒæ­¥å¤±è´¥');

            wp_send_json_error(['message' => $result['message']]);
        }

    } catch (Exception $e) {
        // æ¸…ç†è¾“å‡ºç¼“å†²
        ob_clean();

        // è®°å½•å¼‚å¸¸
        woo_walmart_sync_log('æ‰¹é‡äº§å“åŒæ­¥', 'é”™è¯¯', [
            'exception' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
            'file' => $e->getFile(),
            'line' => $e->getLine()
        ], 'æ‰¹é‡äº§å“åŒæ­¥å¼‚å¸¸');

        wp_send_json_error(['message' => 'æ‰¹é‡åŒæ­¥å¼‚å¸¸ï¼š' . $e->getMessage()]);

    } catch (Error $e) {
        // æ•è·PHP 7+ çš„Errorç±»å‹
        ob_clean();

        woo_walmart_sync_log('æ‰¹é‡äº§å“åŒæ­¥', 'è‡´å‘½é”™è¯¯', [
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
            'file' => $e->getFile(),
            'line' => $e->getLine()
        ], 'PHPè‡´å‘½é”™è¯¯');

        wp_send_json_error(['message' => 'PHPè‡´å‘½é”™è¯¯ï¼š' . $e->getMessage()]);

    } finally {
        // ç¡®ä¿è¾“å‡ºç¼“å†²è¢«æ¸…ç†
        if (ob_get_level()) {
            ob_end_clean();
        }
    }
}

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šéªŒè¯SKUåˆ—è¡¨
 */
function handle_validate_sku_list() {
    try {
        $sku_list = isset($_POST['sku_list']) ? sanitize_textarea_field($_POST['sku_list']) : '';

        if (empty($sku_list)) {
            wp_send_json_error(['message' => 'SKUåˆ—è¡¨ä¸èƒ½ä¸ºç©º']);
            return;
        }

        // è§£æSKUåˆ—è¡¨
        $skus = array_filter(array_map('trim', explode("\n", $sku_list)));
        $skus = array_unique($skus); // å»é‡

        if (empty($skus)) {
            wp_send_json_error(['message' => 'æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„SKU']);
            return;
        }

        // é™åˆ¶æ•°é‡
        if (count($skus) > 500) {
            wp_send_json_error(['message' => 'ä¸€æ¬¡æœ€å¤šåªèƒ½éªŒè¯500ä¸ªSKU']);
            return;
        }

        $results = [];
        $valid_count = 0;
        $invalid_count = 0;

        foreach ($skus as $sku) {
            // æŸ¥æ‰¾å¯¹åº”çš„WooCommerceäº§å“
            $product_id = wc_get_product_id_by_sku($sku);

            if ($product_id) {
                $product = wc_get_product($product_id);
                if ($product) {
                    $results[] = [
                        'sku' => $sku,
                        'product_id' => $product_id,
                        'name' => $product->get_name(),
                        'status' => 'valid',
                        'message' => 'æ‰¾åˆ°å¯¹åº”äº§å“'
                    ];
                    $valid_count++;
                } else {
                    $results[] = [
                        'sku' => $sku,
                        'product_id' => null,
                        'name' => '',
                        'status' => 'invalid',
                        'message' => 'äº§å“IDå­˜åœ¨ä½†æ— æ³•åŠ è½½äº§å“'
                    ];
                    $invalid_count++;
                }
            } else {
                $results[] = [
                    'sku' => $sku,
                    'product_id' => null,
                    'name' => '',
                    'status' => 'invalid',
                    'message' => 'æœªæ‰¾åˆ°å¯¹åº”çš„äº§å“'
                ];
                $invalid_count++;
            }
        }

        wp_send_json_success([
            'results' => $results,
            'summary' => [
                'total' => count($skus),
                'valid' => $valid_count,
                'invalid' => $invalid_count
            ]
        ]);

    } catch (Exception $e) {
        wp_send_json_error(['message' => 'SKUéªŒè¯å¼‚å¸¸ï¼š' . $e->getMessage()]);
    }
}

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šå°†SKUè½¬æ¢ä¸ºäº§å“ID
 */
function handle_convert_skus_to_product_ids() {
    // ğŸ”§ å¢å¼ºé”™è¯¯å¤„ç†å’Œè¾“å‡ºç¼“å†²
    ob_start();

    try {
        // æ£€æŸ¥ç”¨æˆ·æƒé™
        if (!current_user_can('manage_options')) {
            ob_clean();
            wp_send_json_error(['message' => 'æƒé™ä¸è¶³']);
            return;
        }

        // éªŒè¯nonce
        if (!wp_verify_nonce($_POST['nonce'], 'sku_batch_sync_nonce')) {
            ob_clean();
            wp_send_json_error(['message' => 'å®‰å…¨éªŒè¯å¤±è´¥']);
            return;
        }

        $sku_list = isset($_POST['sku_list']) ? $_POST['sku_list'] : [];

        if (empty($sku_list) || !is_array($sku_list)) {
            ob_clean();
            wp_send_json_error(['message' => 'SKUåˆ—è¡¨ä¸ºç©º']);
            return;
        }

        $product_ids = [];
        $found_skus = [];
        $not_found_skus = [];

        foreach ($sku_list as $sku) {
            $sku = trim($sku);
            if (empty($sku)) continue;

            $product_id = wc_get_product_id_by_sku($sku);
            if ($product_id) {
                $product_ids[] = $product_id;
                $found_skus[] = $sku;
            } else {
                $not_found_skus[] = $sku;
            }
        }

        // æ¸…ç†è¾“å‡ºç¼“å†²
        ob_clean();

        wp_send_json_success([
            'product_ids' => $product_ids,
            'found_skus' => $found_skus,
            'not_found_skus' => $not_found_skus,
            'summary' => [
                'total' => count($sku_list),
                'found' => count($found_skus),
                'not_found' => count($not_found_skus)
            ]
        ]);

    } catch (Exception $e) {
        ob_clean();
        woo_walmart_sync_log('SKUè½¬æ¢', 'å¼‚å¸¸', [
            'exception' => $e->getMessage(),
            'trace' => $e->getTraceAsString()
        ], 'SKUè½¬æ¢å¼‚å¸¸');

        wp_send_json_error(['message' => 'SKUè½¬æ¢å¼‚å¸¸ï¼š' . $e->getMessage()]);

    } catch (Error $e) {
        ob_clean();
        woo_walmart_sync_log('SKUè½¬æ¢', 'è‡´å‘½é”™è¯¯', [
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString()
        ], 'SKUè½¬æ¢è‡´å‘½é”™è¯¯');

        wp_send_json_error(['message' => 'SKUè½¬æ¢è‡´å‘½é”™è¯¯ï¼š' . $e->getMessage()]);

    } finally {
        if (ob_get_level()) {
            ob_end_clean();
        }
    }
}

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šå¼€å§‹SKUæ‰¹é‡åŒæ­¥
 */
function handle_start_sku_batch_sync() {
    try {
        $product_ids = isset($_POST['product_ids']) ? array_map('intval', $_POST['product_ids']) : [];

        if (empty($product_ids)) {
            wp_send_json_error(['message' => 'æ²¡æœ‰æä¾›æœ‰æ•ˆçš„äº§å“ID']);
            return;
        }

        // è°ƒç”¨æ‰¹é‡åŒæ­¥å¤„ç†
        handle_walmart_batch_sync_products();

    } catch (Exception $e) {
        wp_send_json_error(['message' => 'SKUæ‰¹é‡åŒæ­¥å¼‚å¸¸ï¼š' . $e->getMessage()]);
    }
}

// AJAXå¤„ç†å‡½æ•°ï¼šè·å–æ‰¹æ¬¡è¯¦æƒ…
add_action('wp_ajax_get_batch_details', 'handle_get_batch_details');

// AJAXå¤„ç†å‡½æ•°ï¼šæ ‡è®°æ‰¹æ¬¡ä¸ºå®Œæˆ
add_action('wp_ajax_mark_batch_completed', 'handle_mark_batch_completed');
function handle_get_batch_details() {
    // éªŒè¯nonce
    if (!wp_verify_nonce($_POST['nonce'], 'batch_details_nonce')) {
        wp_die('å®‰å…¨éªŒè¯å¤±è´¥');
    }

    $batch_id = sanitize_text_field($_POST['batch_id']);
    $type = sanitize_text_field($_POST['type']); // 'success' æˆ– 'failed'

    global $wpdb;
    $batch_items_table = $wpdb->prefix . 'walmart_batch_items';
    $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';

    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸»æ‰¹æ¬¡ï¼Œå¦‚æœæ˜¯ä¸»æ‰¹æ¬¡ï¼Œéœ€è¦æŸ¥è¯¢å­æ‰¹æ¬¡çš„å•†å“
    $batch_info = $wpdb->get_row($wpdb->prepare(
        "SELECT batch_type FROM {$batch_feeds_table} WHERE batch_id = %s",
        $batch_id
    ));

    $query_batch_ids = [$batch_id];

    // å¦‚æœæ˜¯ä¸»æ‰¹æ¬¡ï¼Œè·å–æ‰€æœ‰å­æ‰¹æ¬¡ID
    if ($batch_info && $batch_info->batch_type === 'master') {
        $sub_batch_ids = $wpdb->get_col($wpdb->prepare(
            "SELECT batch_id FROM {$batch_feeds_table} WHERE parent_batch_id = %s",
            $batch_id
        ));

        if (!empty($sub_batch_ids)) {
            $query_batch_ids = $sub_batch_ids; // åªæŸ¥è¯¢å­æ‰¹æ¬¡ï¼Œä¸æŸ¥è¯¢ä¸»æ‰¹æ¬¡
        }
    }

    // æ ¹æ®ç±»å‹æŸ¥è¯¢SKUåˆ—è¡¨ - å…¼å®¹æ–°æ—§çŠ¶æ€å€¼
    $status_conditions = [];
    if ($type === 'success') {
        $status_conditions = ['SUCCESS'];
    } elseif ($type === 'failed') {
        $status_conditions = ['ERROR'];
    } elseif ($type === 'processing') {
        // å…¼å®¹æ–°æ—§çŠ¶æ€å€¼
        $status_conditions = ['INPROGRESS', 'PENDING', 'PROCESSING'];
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    $batch_placeholders = implode(',', array_fill(0, count($query_batch_ids), '%s'));
    $status_placeholders = implode(',', array_fill(0, count($status_conditions), '%s'));
    $query_params = array_merge($query_batch_ids, $status_conditions);

    if ($type === 'success') {
        // æˆåŠŸçš„å•†å“åªéœ€è¦SKU
        $skus = $wpdb->get_col($wpdb->prepare(
            "SELECT sku FROM $batch_items_table
             WHERE batch_id IN ($batch_placeholders) AND status IN ($status_placeholders)
             ORDER BY id ASC",
            ...$query_params
        ));

        $items = array_map(function($sku) {
            return ['sku' => $sku];
        }, $skus);
    } else {
        // å¤±è´¥çš„å•†å“å’Œå¤„ç†ä¸­çš„å•†å“éœ€è¦SKUå’Œé”™è¯¯ä¿¡æ¯
        $items = $wpdb->get_results($wpdb->prepare(
            "SELECT sku, error_message FROM $batch_items_table
             WHERE batch_id IN ($batch_placeholders) AND status IN ($status_placeholders)
             ORDER BY id ASC",
            ...$query_params
        ), ARRAY_A);
    }

    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä»APIå“åº”ä¸­è·å–æ›´å‡†ç¡®çš„æ•°æ®
    $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';
    $batch_data = $wpdb->get_row($wpdb->prepare(
        "SELECT api_response, success_count, failed_count, status FROM {$batch_feeds_table} WHERE batch_id = %s",
        $batch_id
    ));

    // å¦‚æœbatch_itemsè¡¨æ²¡æœ‰æ•°æ®ï¼Œæˆ–è€…æ•°æ®ä¸ä¸€è‡´ï¼ˆæ‰€æœ‰å•†å“éƒ½æ˜¯PENDINGä½†æ‰¹æ¬¡æœ‰ç»Ÿè®¡æ•°æ®ï¼‰ï¼Œå°è¯•ä»api_responseä¸­è§£æ
    $should_use_api_response = false;

    if (empty($items)) {
        $should_use_api_response = true;
    } else {
        // æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ï¼šå¦‚æœæ‰€æœ‰å•†å“éƒ½æ˜¯PENDINGï¼Œä½†æ‰¹æ¬¡æœ‰æˆåŠŸ/å¤±è´¥ç»Ÿè®¡ï¼Œè¯´æ˜æ•°æ®ä¸åŒæ­¥
        $all_pending = true;
        foreach ($items as $item) {
            if (isset($item['status']) && $item['status'] !== 'PENDING') {
                $all_pending = false;
                break;
            }
        }

        if ($all_pending && $batch_data && ($batch_data->success_count > 0 || $batch_data->failed_count > 0)) {
            $should_use_api_response = true;
            woo_walmart_sync_log('æ‰¹æ¬¡è¯¦æƒ…æ•°æ®ä¸ä¸€è‡´', 'è­¦å‘Š', [
                'batch_id' => $batch_id,
                'type' => $type,
                'items_count' => count($items),
                'success_count' => $batch_data->success_count,
                'failed_count' => $batch_data->failed_count
            ], 'æ£€æµ‹åˆ°æ•°æ®ä¸ä¸€è‡´ï¼Œå°†ä»APIå“åº”ä¸­è·å–å‡†ç¡®æ•°æ®');
        }
    }

    if ($should_use_api_response && $batch_data) {

        if (!empty($batch_data->api_response)) {
            $api_response = json_decode($batch_data->api_response, true);
            $items = extract_items_from_api_response($api_response, $type);
        } else {
            // æ£€æŸ¥æ˜¯å¦æœ‰å­æ‰¹æ¬¡ï¼ˆä¸»æ‰¹æ¬¡çš„æƒ…å†µï¼‰
            $sub_batches = $wpdb->get_results($wpdb->prepare(
                "SELECT batch_id, api_response FROM {$batch_feeds_table}
                 WHERE parent_batch_id = %s
                 AND api_response IS NOT NULL AND api_response != ''
                 ORDER BY batch_id",
                $batch_id
            ));

            if (!empty($sub_batches)) {
                // é‡ç½®itemsæ•°ç»„ï¼Œåªä½¿ç”¨APIå“åº”æ•°æ®
                $items = [];

                // ä»æ‰€æœ‰å­æ‰¹æ¬¡ä¸­æ”¶é›†å•†å“ä¿¡æ¯
                foreach ($sub_batches as $sub_batch) {
                    $sub_api_response = json_decode($sub_batch->api_response, true);
                    if ($sub_api_response) {
                        $sub_items = extract_items_from_api_response($sub_api_response, $type);
                        $items = array_merge($items, $sub_items);
                    }
                }

                woo_walmart_sync_log('æ‰¹æ¬¡è¯¦æƒ…æŸ¥è¯¢-å­æ‰¹æ¬¡', 'è°ƒè¯•', [
                    'batch_id' => $batch_id,
                    'type' => $type,
                    'sub_batches_count' => count($sub_batches),
                    'extracted_items_count' => count($items)
                ], "ä» " . count($sub_batches) . " ä¸ªå­æ‰¹æ¬¡ä¸­æå–åˆ° " . count($items) . " ä¸ªå•†å“");

            } else if ($batch_data && ($batch_data->success_count > 0 || $batch_data->failed_count > 0)) {
                // å¦‚æœæ²¡æœ‰å­æ‰¹æ¬¡ä¸”APIå“åº”ä¸ºç©ºï¼Œå°è¯•ä»batch_itemsè¡¨è·å–æ‰€æœ‰å•†å“å¹¶æ ¹æ®ç»Ÿè®¡æ•°æ®æ¨æ–­
                $all_batch_items = $wpdb->get_results($wpdb->prepare(
                    "SELECT sku, error_message FROM $batch_items_table WHERE batch_id = %s ORDER BY id ASC",
                    $batch_id
                ), ARRAY_A);

                if (!empty($all_batch_items)) {
                    $success_count = intval($batch_data->success_count);
                    $failed_count = intval($batch_data->failed_count);

                    if ($type === 'success' && $success_count > 0) {
                        // å–å‰Nä¸ªä½œä¸ºæˆåŠŸå•†å“ï¼ˆè¿™æ˜¯ä¸€ä¸ªè¿‘ä¼¼æ–¹æ¡ˆï¼‰
                        $items = array_slice($all_batch_items, 0, $success_count);
                        foreach ($items as &$item) {
                            unset($item['error_message']); // æˆåŠŸå•†å“ä¸éœ€è¦é”™è¯¯ä¿¡æ¯
                        }
                    } else if ($type === 'failed' && $failed_count > 0) {
                        // å–åNä¸ªä½œä¸ºå¤±è´¥å•†å“ï¼ˆè¿™æ˜¯ä¸€ä¸ªè¿‘ä¼¼æ–¹æ¡ˆï¼‰
                        $items = array_slice($all_batch_items, -$failed_count);
                        foreach ($items as &$item) {
                            if (empty($item['error_message'])) {
                                $item['error_message'] = 'åŒæ­¥å¤±è´¥ï¼ˆè¯¦ç»†é”™è¯¯ä¿¡æ¯ä¸å¯ç”¨ï¼‰';
                            }
                        }
                    }
                }

                woo_walmart_sync_log('æ‰¹æ¬¡è¯¦æƒ…æŸ¥è¯¢-æ¨æ–­', 'è°ƒè¯•', [
                    'batch_id' => $batch_id,
                    'type' => $type,
                    'success_count' => $batch_data->success_count ?? 0,
                    'failed_count' => $batch_data->failed_count ?? 0,
                    'extracted_items_count' => count($items)
                ], "ä»ç»Ÿè®¡æ•°æ®æ¨æ–­å¾—åˆ° " . count($items) . " ä¸ªå•†å“");
            }
        }
    }

    wp_send_json_success([
        'items' => $items,
        'count' => count($items),
        'type' => $type
    ]);
}

/**
 * å¤„ç†æ ‡è®°æ‰¹æ¬¡ä¸ºå®Œæˆçš„AJAXè¯·æ±‚
 */
function handle_mark_batch_completed() {
    // éªŒè¯nonce
    if (!wp_verify_nonce($_POST['nonce'], 'walmart_batch_action')) {
        wp_send_json_error(['message' => 'å®‰å…¨éªŒè¯å¤±è´¥']);
        return;
    }

    // éªŒè¯ç”¨æˆ·æƒé™
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'æƒé™ä¸è¶³']);
        return;
    }

    $batch_id = sanitize_text_field($_POST['batch_id']);

    if (empty($batch_id)) {
        wp_send_json_error(['message' => 'æ‰¹æ¬¡IDä¸èƒ½ä¸ºç©º']);
        return;
    }

    global $wpdb;
    $batch_feeds_table = $wpdb->prefix . 'walmart_batch_feeds';
    $batch_items_table = $wpdb->prefix . 'walmart_batch_items';

    try {
        // 1. æ£€æŸ¥æ‰¹æ¬¡æ˜¯å¦å­˜åœ¨
        $batch_info = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $batch_feeds_table WHERE batch_id = %s",
            $batch_id
        ));

        if (!$batch_info) {
            wp_send_json_error(['message' => 'æ‰¹æ¬¡ä¸å­˜åœ¨']);
            return;
        }

        // 2. æ£€æŸ¥æ‰¹æ¬¡å½“å‰çŠ¶æ€
        if ($batch_info->status === 'COMPLETED') {
            wp_send_json_error(['message' => 'æ‰¹æ¬¡å·²ç»æ˜¯å®ŒæˆçŠ¶æ€']);
            return;
        }

        // 3. è·å–æ‰¹æ¬¡ç»Ÿè®¡ä¿¡æ¯
        $total_items = $batch_info->product_count;
        $current_success = $batch_info->success_count;
        $current_failed = $batch_info->failed_count;
        $processing_count = $total_items - $current_success - $current_failed;

        // 4. æ›´æ–°ä¸»æ‰¹æ¬¡çŠ¶æ€
        $update_result = $wpdb->update(
            $batch_feeds_table,
            [
                'status' => 'COMPLETED',
                'completed_at' => current_time('mysql'),
                'updated_at' => current_time('mysql')
            ],
            ['batch_id' => $batch_id]
        );

        if ($update_result === false) {
            wp_send_json_error(['message' => 'æ›´æ–°æ‰¹æ¬¡çŠ¶æ€å¤±è´¥']);
            return;
        }

        // 5. å¦‚æœæ˜¯ä¸»æ‰¹æ¬¡ï¼ŒåŒæ—¶æ›´æ–°æ‰€æœ‰å­æ‰¹æ¬¡
        if ($batch_info->batch_type === 'master') {
            $sub_batch_update = $wpdb->update(
                $batch_feeds_table,
                [
                    'status' => 'COMPLETED',
                    'completed_at' => current_time('mysql'),
                    'updated_at' => current_time('mysql')
                ],
                ['parent_batch_id' => $batch_id]
            );

            // æ›´æ–°æ‰€æœ‰å¤„ç†ä¸­çš„å•†å“çŠ¶æ€ä¸ºå·²å®Œæˆï¼ˆä½†ä¿æŒåŸæœ‰çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€ï¼‰
            if ($processing_count > 0) {
                // å°†æ‰€æœ‰PENDING/INPROGRESSçŠ¶æ€çš„å•†å“æ ‡è®°ä¸ºå·²å¤„ç†ï¼ˆé»˜è®¤ä¸ºæˆåŠŸï¼‰
                $items_update = $wpdb->update(
                    $batch_items_table,
                    [
                        'status' => 'SUCCESS',
                        'processed_at' => current_time('mysql')
                    ],
                    [
                        'batch_id' => $batch_id,
                        'status' => 'PENDING'
                    ]
                );

                // åŒæ—¶å¤„ç†å­æ‰¹æ¬¡çš„å•†å“
                $sub_batches = $wpdb->get_col($wpdb->prepare(
                    "SELECT batch_id FROM $batch_feeds_table WHERE parent_batch_id = %s",
                    $batch_id
                ));

                foreach ($sub_batches as $sub_batch_id) {
                    $wpdb->update(
                        $batch_items_table,
                        [
                            'status' => 'SUCCESS',
                            'processed_at' => current_time('mysql')
                        ],
                        [
                            'batch_id' => $sub_batch_id,
                            'status' => 'PENDING'
                        ]
                    );
                }

                // æ›´æ–°æˆåŠŸæ•°é‡ç»Ÿè®¡
                $new_success_count = $current_success + $processing_count;
                $wpdb->update(
                    $batch_feeds_table,
                    ['success_count' => $new_success_count],
                    ['batch_id' => $batch_id]
                );
            }
        } else {
            // å¦‚æœæ˜¯å­æ‰¹æ¬¡ï¼Œæ›´æ–°è¯¥æ‰¹æ¬¡çš„å•†å“çŠ¶æ€
            if ($processing_count > 0) {
                $wpdb->update(
                    $batch_items_table,
                    [
                        'status' => 'SUCCESS',
                        'processed_at' => current_time('mysql')
                    ],
                    [
                        'batch_id' => $batch_id,
                        'status' => 'PENDING'
                    ]
                );

                // æ›´æ–°æˆåŠŸæ•°é‡ç»Ÿè®¡
                $new_success_count = $current_success + $processing_count;
                $wpdb->update(
                    $batch_feeds_table,
                    ['success_count' => $new_success_count],
                    ['batch_id' => $batch_id]
                );
            }
        }

        // 6. è®°å½•æ“ä½œæ—¥å¿—
        woo_walmart_sync_log('æ‰¹æ¬¡æ‰‹åŠ¨æ ‡è®°å®Œæˆ', 'æ“ä½œ', [
            'batch_id' => $batch_id,
            'batch_type' => $batch_info->batch_type,
            'original_status' => $batch_info->status,
            'total_items' => $total_items,
            'success_count' => $current_success,
            'failed_count' => $current_failed,
            'processing_count' => $processing_count,
            'operator' => wp_get_current_user()->user_login,
            'operation_time' => current_time('mysql')
        ], "æ‰¹æ¬¡ {$batch_id} å·²æ‰‹åŠ¨æ ‡è®°ä¸ºå®Œæˆ");

        // 7. è¿”å›æˆåŠŸå“åº”
        wp_send_json_success([
            'message' => "æ‰¹æ¬¡å·²æˆåŠŸæ ‡è®°ä¸ºå®Œæˆï¼\n\næ‰¹æ¬¡ä¿¡æ¯ï¼š\n- æ€»å•†å“æ•°ï¼š{$total_items}\n- æˆåŠŸï¼š" . ($current_success + $processing_count) . "\n- å¤±è´¥ï¼š{$current_failed}\n- å¤„ç†ä¸­å•†å“å·²æ ‡è®°ä¸ºæˆåŠŸ",
            'batch_id' => $batch_id,
            'new_status' => 'COMPLETED'
        ]);

    } catch (Exception $e) {
        woo_walmart_sync_log('æ‰¹æ¬¡æ ‡è®°å®Œæˆå¤±è´¥', 'é”™è¯¯', [
            'batch_id' => $batch_id,
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString()
        ], "æ‰¹æ¬¡ {$batch_id} æ ‡è®°å®Œæˆå¤±è´¥ï¼š" . $e->getMessage());

        wp_send_json_error(['message' => 'æ“ä½œå¤±è´¥ï¼š' . $e->getMessage()]);
    }
}

// ä»APIå“åº”ä¸­æå–å•†å“åˆ—è¡¨ï¼ˆåŒ…å«SKUå’Œé”™è¯¯ä¿¡æ¯ï¼‰
function extract_items_from_api_response($api_response, $type) {
    $items = [];

    if (isset($api_response['itemDetails']['itemIngestionStatus'])) {
        $api_items = $api_response['itemDetails']['itemIngestionStatus'];

        foreach ($api_items as $item) {
            if (isset($item['sku'])) {
                $ingestion_status = $item['ingestionStatus'] ?? '';
                $is_success = ($ingestion_status === 'SUCCESS');
                $is_processing = ($ingestion_status === 'INPROGRESS');
                $is_failed = in_array($ingestion_status, ['DATA_ERROR', 'SYSTEM_ERROR', 'TIMEOUT_ERROR', 'ERROR']);

                // æ ¹æ®è¯·æ±‚ç±»å‹ç­›é€‰å•†å“
                $should_include = false;
                if ($type === 'success' && $is_success) {
                    $should_include = true;
                } elseif ($type === 'failed' && $is_failed) {
                    $should_include = true;
                } elseif ($type === 'processing' && $is_processing) {
                    $should_include = true;
                }

                if ($should_include) {
                    $result_item = ['sku' => $item['sku']];

                    // å¦‚æœæ˜¯å¤±è´¥çš„å•†å“ï¼Œæå–é”™è¯¯ä¿¡æ¯
                    if ($is_failed) {
                        $error_messages = [];

                        if (isset($item['ingestionErrors']['ingestionError'])) {
                            $errors = $item['ingestionErrors']['ingestionError'];

                            foreach ($errors as $error) {
                                if (isset($error['description'])) {
                                    $error_messages[] = $error['description'];
                                }
                            }
                        }

                        $result_item['error_message'] = implode('; ', $error_messages);
                    }

                    // å¦‚æœæ˜¯å¤„ç†ä¸­çš„å•†å“ï¼Œæ·»åŠ çŠ¶æ€ä¿¡æ¯
                    if ($is_processing) {
                        $result_item['error_message'] = 'å•†å“æ­£åœ¨å¤„ç†ä¸­...';
                    }

                    $items[] = $result_item;
                }
            }
        }
    }

    return $items;
}

/**
 * ä¿å­˜Walmartåˆ†ç±»æ•°æ®åˆ°æ•°æ®åº“
 * @param array $categories_data APIè¿”å›çš„åˆ†ç±»æ•°æ®
 * @return array ä¿å­˜ç»“æœ
 */
function woo_walmart_save_categories_to_db($categories_data) {
    global $wpdb;
    $categories_table = $wpdb->prefix . 'walmart_categories';

    $stats = [
        'categories' => 0,
        'ptgs' => 0,
        'pts' => 0,
        'updated' => 0,
        'inserted' => 0
    ];

    try {
        // å¼€å§‹äº‹åŠ¡
        $wpdb->query('START TRANSACTION');

        foreach ($categories_data as $category) {
            // é€‚é…ä¸åŒçš„APIå“åº”å­—æ®µ
            $category_id = $category['category'] ?? ($category['id'] ?? '');
            $category_name = $category['category'] ?? ($category['name'] ?? '');

            if (empty($category_id) || empty($category_name)) {
                continue;
            }

            // ä¿å­˜åˆ†ç±»
            $result = $wpdb->replace(
                $categories_table,
                [
                    'category_id' => $category_id,
                    'category_name' => $category_name,
                    'parent_id' => null,
                    'level' => 0,
                    'path' => $category_name,
                    'is_active' => 1,
                    'sync_status' => 'synced',
                    'last_sync_time' => current_time('mysql'),
                    'updated_at' => current_time('mysql')
                ],
                [
                    '%s', '%s', '%s', '%d', '%s', '%d', '%s', '%s', '%s'
                ]
            );

            if ($result !== false) {
                $stats['categories']++;
            }

            // å¤„ç†PTG (Product Type Groups)
            $ptg_field = null;
            if (isset($category['productTypeGroup']) && is_array($category['productTypeGroup'])) {
                $ptg_field = 'productTypeGroup';
            } elseif (isset($category['productTypeGroups']) && is_array($category['productTypeGroups'])) {
                $ptg_field = 'productTypeGroups';
            }

            if ($ptg_field) {
                foreach ($category[$ptg_field] as $ptg) {
                    // é€‚é…ä¸åŒçš„PTGå­—æ®µå
                    $ptg_id = $ptg['productTypeGroupName'] ?? ($ptg['productTypeGroup'] ?? ($ptg['id'] ?? ($ptg['name'] ?? '')));
                    $ptg_name = $ptg['productTypeGroupName'] ?? ($ptg['productTypeGroup'] ?? ($ptg['name'] ?? ''));

                    if (empty($ptg_id) || empty($ptg_name)) {
                        continue;
                    }

                    // ä¿å­˜PTG
                    $result = $wpdb->replace(
                        $categories_table,
                        [
                            'category_id' => $ptg_id,
                            'category_name' => $ptg_name,
                            'parent_id' => $category_id,
                            'level' => 1,
                            'path' => $category_name . ' > ' . $ptg_name,
                            'product_type_group_id' => $ptg_id,
                            'product_type_group_name' => $ptg_name,
                            'is_active' => 1,
                            'sync_status' => 'synced',
                            'last_sync_time' => current_time('mysql'),
                            'updated_at' => current_time('mysql')
                        ],
                        [
                            '%s', '%s', '%s', '%d', '%s', '%s', '%s', '%d', '%s', '%s', '%s'
                        ]
                    );

                    if ($result !== false) {
                        $stats['ptgs']++;
                    }

                    // å¤„ç†PT (Product Types)
                    $pt_field = null;
                    if (isset($ptg['productType']) && is_array($ptg['productType'])) {
                        $pt_field = 'productType';
                    } elseif (isset($ptg['productTypes']) && is_array($ptg['productTypes'])) {
                        $pt_field = 'productTypes';
                    }

                    if ($pt_field) {
                        foreach ($ptg[$pt_field] as $pt) {
                            // é€‚é…ä¸åŒçš„PTå­—æ®µå
                            $pt_id = $pt['productTypeName'] ?? ($pt['productType'] ?? ($pt['id'] ?? ($pt['name'] ?? '')));
                            $pt_name = $pt['productTypeName'] ?? ($pt['productType'] ?? ($pt['name'] ?? ''));

                            if (empty($pt_id) || empty($pt_name)) {
                                continue;
                            }

                            // ä¿å­˜PT
                            $result = $wpdb->replace(
                                $categories_table,
                                [
                                    'category_id' => $pt_id,
                                    'category_name' => $pt_name,
                                    'parent_id' => $ptg_id,
                                    'level' => 2,
                                    'path' => $category_name . ' > ' . $ptg_name . ' > ' . $pt_name,
                                    'product_type_group_id' => $ptg_id,
                                    'product_type_group_name' => $ptg_name,
                                    'product_type_id' => $pt_id,
                                    'product_type_name' => $pt_name,
                                    'is_active' => 1,
                                    'sync_status' => 'synced',
                                    'last_sync_time' => current_time('mysql'),
                                    'updated_at' => current_time('mysql')
                                ],
                                [
                                    '%s', '%s', '%s', '%d', '%s', '%s', '%s', '%s', '%s', '%d', '%s', '%s', '%s'
                                ]
                            );

                            if ($result !== false) {
                                $stats['pts']++;
                            }
                        }
                    }
                }
            }
        }

        // æäº¤äº‹åŠ¡
        $wpdb->query('COMMIT');

        return [
            'success' => true,
            'message' => 'åˆ†ç±»æ•°æ®ä¿å­˜æˆåŠŸ',
            'stats' => $stats
        ];

    } catch (Exception $e) {
        // å›æ»šäº‹åŠ¡
        $wpdb->query('ROLLBACK');

        return [
            'success' => false,
            'message' => 'ä¿å­˜å¤±è´¥: ' . $e->getMessage(),
            'stats' => $stats
        ];
    }
}

/**
 * ä»æ•°æ®åº“è·å–Walmartåˆ†ç±»æ•°æ®ç”¨äºæ˜ å°„é¡µé¢æ˜¾ç¤º
 * ğŸ”§ ä¿®æ”¹ï¼šæ ¹æ®å½“å‰ä¸»å¸‚åœºè®¾ç½®è‡ªåŠ¨åŠ è½½å¯¹åº”çš„åˆ†ç±»åˆ—è¡¨
 * @return array æ ¼å¼åŒ–çš„åˆ†ç±»æ•°æ®ï¼Œå…¼å®¹åŸæœ‰çš„æ˜¾ç¤ºé€»è¾‘
 */
function woo_walmart_get_categories_for_mapping() {
    global $wpdb;

    // ğŸ”§ è·å–å½“å‰ä¸»å¸‚åœºè®¾ç½®
    $business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');
    $market_code = str_replace('WALMART_', '', $business_unit); // WALMART_CA -> CA

    // ğŸ”§ æ ¹æ®å¸‚åœºé€‰æ‹©å¯¹åº”çš„æ•°æ®è¡¨å’Œtransient
    if ($market_code === 'CA') {
        // ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§å¸‚åœºï¼šä½¿ç”¨ä¸“ç”¨è¡¨
        $categories_table = $wpdb->prefix . 'walmart_categories_ca';
        $transient_key = 'walmart_ca_categories';
    } else {
        // ğŸ‡ºğŸ‡¸ ç¾å›½åŠå…¶ä»–å¸‚åœºï¼šä½¿ç”¨é»˜è®¤è¡¨
        $categories_table = $wpdb->prefix . 'walmart_categories';
        $transient_key = 'walmart_api_categories';
    }

    // é¦–å…ˆå°è¯•ä»æ•°æ®åº“è·å–
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$categories_table'") === $categories_table;

    if ($table_exists) {
        if ($market_code === 'CA') {
            // ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§å¸‚åœºï¼šç®€åŒ–çš„è¡¨ç»“æ„
            $db_categories = $wpdb->get_results("SELECT * FROM $categories_table ORDER BY category_name");

            if (!empty($db_categories)) {
                $formatted_categories = [];
                foreach ($db_categories as $category) {
                    $formatted_categories[] = [
                        'categoryId' => $category->category_id,
                        'categoryName' => $category->category_name,
                        'level' => 0,
                        'path' => $category->category_path,
                        'market' => 'CA',
                        'version' => '3.16'
                    ];
                }
                return $formatted_categories;
            }
        } else {
            // ğŸ‡ºğŸ‡¸ ç¾å›½å¸‚åœºï¼šå®Œæ•´çš„è¡¨ç»“æ„
            $db_categories = $wpdb->get_results("SELECT * FROM $categories_table ORDER BY level, category_name");

            if (!empty($db_categories)) {
                $formatted_categories = [];
                foreach ($db_categories as $category) {
                    $formatted_categories[] = [
                        'categoryId' => $category->category_id,
                        'categoryName' => $category->category_name,
                        'level' => $category->level,
                        'path' => $category->path,
                        'productTypeGroupId' => $category->product_type_group_id,
                        'productTypeGroupName' => $category->product_type_group_name,
                        'productTypeId' => $category->product_type_id,
                        'productTypeName' => $category->product_type_name
                    ];
                }
                return $formatted_categories;
            }
        }
    }

    // å¦‚æœæ•°æ®åº“æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»transientè·å–ï¼ˆå‘åå…¼å®¹ï¼‰
    $transient_categories = get_transient($transient_key);

    if (!empty($transient_categories)) {
        // å¦‚æœtransientæœ‰æ•°æ®ä½†æ•°æ®åº“æ²¡æœ‰ï¼Œè½¬æ¢æ ¼å¼
        $formatted_categories = [];

        foreach ($transient_categories as $category) {
            // é€‚é…ä¸åŒçš„APIå“åº”æ ¼å¼
            $category_id = $category['category'] ?? ($category['categoryId'] ?? '');
            $category_name = $category['category'] ?? ($category['categoryName'] ?? '');

            if (!empty($category_id) && !empty($category_name)) {
                $formatted_categories[] = [
                    'categoryId' => $category_id,
                    'categoryName' => $category_name,
                    'level' => 0,
                    'path' => $category_name
                ];
            }
        }

        return $formatted_categories;
    }

    return [];
}

/**
 * è§£æJSON Schemaæ ¼å¼çš„å±æ€§æ•°æ®
 * å®Œå…¨æŒ‰ç…§å‚è€ƒæ’ä»¶çš„é€»è¾‘å®ç°
 */
function parse_json_schema_attributes($schema_data, $product_type_id) {
    $attributes = [];

    woo_walmart_sync_log('å±æ€§åŒæ­¥', 'JSON Schemaè§£æå¼€å§‹', [
        'product_type_id' => $product_type_id,
        'schema_keys' => array_keys($schema_data)
    ], 'JSON Schemaæ ¼å¼æ£€æµ‹');

    // æŸ¥æ‰¾MPItemä¸­çš„properties
    if (isset($schema_data['properties']['MPItem']['items']['properties'])) {
        $mp_item_properties = $schema_data['properties']['MPItem']['items']['properties'];

        // è·å–å¿…å¡«å±æ€§åˆ—è¡¨
        $required_properties = [];
        if (isset($schema_data['properties']['MPItem']['items']['required'])) {
            $required_properties = $schema_data['properties']['MPItem']['items']['required'];
        }

        // è®°å½•æ‰€æœ‰æ‰¾åˆ°çš„å±æ€§ç”¨äºè°ƒè¯•
        $all_properties = array_keys($mp_item_properties);

        woo_walmart_sync_log('å±æ€§åŒæ­¥', 'æ‰¾åˆ°MPItemå±æ€§', [
            'properties_count' => count($mp_item_properties),
            'required_count' => count($required_properties),
            'required_properties' => $required_properties,
            'all_properties' => $all_properties
        ], 'JSON Schemaè§£æ');

        foreach ($mp_item_properties as $property_name => $property_def) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå¿…å¡«å±æ€§
            $is_required = in_array($property_name, $required_properties);

            // ç‰¹æ®Šå¤„ç†Visibleå±æ€§ - å®ƒåŒ…å«äº§å“ç‰¹å®šçš„å±æ€§
            if ($property_name === 'Visible' && isset($property_def['properties'])) {
                // æŸ¥æ‰¾äº§å“ç±»å‹ç‰¹å®šçš„å±æ€§
                if (isset($property_def['properties'][$product_type_id]['properties'])) {
                    $visible_props = $property_def['properties'][$product_type_id]['properties'];
                    $visible_required = $property_def['properties'][$product_type_id]['required'] ?? [];

                    woo_walmart_sync_log('å±æ€§åŒæ­¥', 'è§£æVisibleå±æ€§', [
                        'product_type_id' => $product_type_id,
                        'visible_props_count' => count($visible_props),
                        'visible_required_count' => count($visible_required)
                    ], 'Visibleå±æ€§è§£æ');

                    foreach ($visible_props as $nested_prop_name => $nested_prop_def) {
                        $nested_is_required = in_array($nested_prop_name, $visible_required);

                        $attribute = extract_attribute_from_schema_v2(
                            $nested_prop_name,
                            $nested_prop_def,
                            $product_type_id,
                            $nested_is_required,
                            'Visible'
                        );

                        if ($attribute) {
                            $attributes[] = $attribute;
                        }
                    }
                }
            }
            // ç‰¹æ®Šå¤„ç†Orderableå±æ€§ - å®ƒåŒ…å«æ‰€æœ‰å®é™…çš„äº§å“å±æ€§
            elseif ($property_name === 'Orderable' && isset($property_def['properties'])) {
                $orderable_props = $property_def['properties'];
                $orderable_required = $property_def['required'] ?? [];

                woo_walmart_sync_log('å±æ€§åŒæ­¥', 'è§£æOrderableå±æ€§', [
                    'orderable_props_count' => count($orderable_props),
                    'orderable_required_count' => count($orderable_required)
                ], 'Orderableå±æ€§è§£æ');

                foreach ($orderable_props as $nested_prop_name => $nested_prop_def) {
                    $nested_is_required = in_array($nested_prop_name, $orderable_required);

                    $attribute = extract_attribute_from_schema_v2(
                        $nested_prop_name,
                        $nested_prop_def,
                        $product_type_id,
                        $nested_is_required,
                        'Orderable'
                    );

                    if ($attribute) {
                        $attributes[] = $attribute;
                    }
                }
            } else {
                // å¤„ç†å…¶ä»–é¡¶çº§å±æ€§
                $attribute = extract_attribute_from_schema_v2($property_name, $property_def, $product_type_id, $is_required, 'General');

                if ($attribute) {
                    $attributes[] = $attribute;
                }
            }
        }
    }

    woo_walmart_sync_log('å±æ€§åŒæ­¥', 'JSON Schemaè§£æå®Œæˆ', [
        'product_type_id' => $product_type_id,
        'attributes_count' => count($attributes)
    ], 'JSON Schemaè§£æç»“æœ');

    return $attributes;
}



/**
 * AJAXå¤„ç†å‡½æ•°ï¼šè·å–Walmartåˆ†ç±»æ ‘æ•°æ®
 */
add_action('wp_ajax_get_walmart_category_tree', function() {
    // éªŒè¯nonce - ä½¿ç”¨åˆ†ç±»æ˜ å°„é¡µé¢çš„nonce
    $nonce = $_POST['_wpnonce'] ?? '';
    if (!wp_verify_nonce($nonce, 'walmart_category_map_save')) {
        wp_send_json_error('å®‰å…¨éªŒè¯å¤±è´¥');
        return;
    }

    if (!current_user_can('manage_options')) {
        wp_send_json_error('æƒé™ä¸è¶³');
        return;
    }

    try {
        // è·å–åˆ†ç±»æ•°æ®
        $categories = woo_walmart_get_categories_for_mapping();

        if (empty($categories)) {
            wp_send_json_error('æ²¡æœ‰æ‰¾åˆ°åˆ†ç±»æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»"ä»æ²ƒå°”ç›æ›´æ–°åˆ†ç±»åˆ—è¡¨"æŒ‰é’®è·å–æ•°æ®');
            return;
        }

        // ğŸ”§ æ ¹æ®å½“å‰å¸‚åœºåŠ¨æ€é€‰æ‹©æ•°æ®è¡¨
        global $wpdb;
        $business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');
        $market_code = str_replace('WALMART_', '', $business_unit); // WALMART_CA -> CA

        if ($market_code === 'CA') {
            // ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§å¸‚åœºï¼šä½¿ç”¨ä¸“ç”¨è¡¨ï¼ˆç®€åŒ–ç»“æ„ï¼Œåªæœ‰ä¸€çº§åˆ†ç±»ï¼‰
            $categories_table = $wpdb->prefix . 'walmart_categories_ca';

            $db_categories = $wpdb->get_results("
                SELECT category_id, category_name
                FROM $categories_table
                ORDER BY category_name
            ");

            $simplified_categories = array_map(function($cat) {
                return [
                    'categoryId' => $cat->category_id,
                    'categoryName' => $cat->category_name,
                    'level' => 0,  // CAåˆ†ç±»å…¨éƒ¨ä¸º0çº§ï¼ˆä¸€çº§åˆ†ç±»ï¼‰
                    'parent_id' => null  // CAåˆ†ç±»æ²¡æœ‰çˆ¶çº§
                ];
            }, $db_categories);
        } else {
            // ğŸ‡ºğŸ‡¸ ç¾å›½åŠå…¶ä»–å¸‚åœºï¼šä½¿ç”¨é»˜è®¤è¡¨ï¼ˆæœ‰å±‚çº§ç»“æ„ï¼‰
            $categories_table = $wpdb->prefix . 'walmart_categories';

            $db_categories = $wpdb->get_results("
                SELECT category_id, category_name, level, parent_id
                FROM $categories_table
                ORDER BY level, category_name
            ");

            $simplified_categories = array_map(function($cat) {
                return [
                    'categoryId' => $cat->category_id,
                    'categoryName' => $cat->category_name,
                    'level' => isset($cat->level) ? (int)$cat->level : 0,
                    'parent_id' => $cat->parent_id ?? null
                ];
            }, $db_categories);
        }

        wp_send_json_success($simplified_categories);

    } catch (Exception $e) {
        wp_send_json_error('è·å–åˆ†ç±»æ•°æ®å¤±è´¥: ' . $e->getMessage());
    }
});

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šè·å–æœªæ˜ å°„çš„æœ¬åœ°ç±»ç›®
 */
add_action('wp_ajax_get_unmapped_local_categories', function() {
    // éªŒè¯nonce
    if (!wp_verify_nonce($_POST['nonce'], 'walmart_category_map_nonce')) {
        wp_send_json_error('å®‰å…¨éªŒè¯å¤±è´¥');
    }

    // éªŒè¯ç”¨æˆ·æƒé™
    if (!current_user_can('manage_options')) {
        wp_send_json_error('æƒé™ä¸è¶³');
    }

    $walmart_category = sanitize_text_field($_POST['walmart_category']);

    if (empty($walmart_category)) {
        wp_send_json_error('Walmartåˆ†ç±»å‚æ•°ç¼ºå¤±');
    }

    try {
        global $wpdb;
        $map_table = $wpdb->prefix . 'walmart_category_map';

        // è·å–æ‰€æœ‰WooCommerceäº§å“åˆ†ç±»ï¼ˆåŒ…å«å±‚çº§ä¿¡æ¯ï¼‰
        $all_categories = get_terms([
            'taxonomy' => 'product_cat',
            'hide_empty' => false,
            'orderby' => 'menu_order',
            'order' => 'ASC',
            'hierarchical' => true
        ]);

        if (is_wp_error($all_categories)) {
            wp_send_json_error('è·å–æœ¬åœ°åˆ†ç±»å¤±è´¥');
        }

        // è·å–å·²æ˜ å°„çš„åˆ†ç±»IDï¼ˆåŒ…æ‹¬å…±äº«æ˜ å°„ä¸­çš„æ‰€æœ‰æœ¬åœ°åˆ†ç±»IDï¼‰
        $mapped_category_ids = [];
        $all_mappings = $wpdb->get_results(
            "SELECT wc_category_id, local_category_ids FROM $map_table WHERE walmart_category_path IS NOT NULL AND walmart_category_path != ''"
        );

        foreach ($all_mappings as $mapping) {
            if (!empty($mapping->local_category_ids)) {
                $local_ids = json_decode($mapping->local_category_ids, true) ?: [];
                $mapped_category_ids = array_merge($mapped_category_ids, $local_ids);
            } else {
                // å…¼å®¹æ—§æ•°æ®
                $mapped_category_ids[] = $mapping->wc_category_id;
            }
        }

        $mapped_category_ids = array_unique($mapped_category_ids);

        // è¿‡æ»¤å‡ºæœªæ˜ å°„çš„åˆ†ç±»å¹¶æ„å»ºå±‚çº§ç»“æ„
        $unmapped_categories = [];
        foreach ($all_categories as $category) {
            if (!in_array($category->term_id, $mapped_category_ids)) {
                // è®¡ç®—åˆ†ç±»å±‚çº§æ·±åº¦
                $level = 0;
                $parent_id = $category->parent;
                $parent_names = [];

                // å‘ä¸Šè¿½æº¯çˆ¶åˆ†ç±»
                while ($parent_id > 0) {
                    $parent_term = get_term($parent_id, 'product_cat');
                    if ($parent_term && !is_wp_error($parent_term)) {
                        $parent_names[] = $parent_term->name;
                        $parent_id = $parent_term->parent;
                        $level++;
                    } else {
                        break;
                    }
                }

                // åè½¬çˆ¶åˆ†ç±»åç§°æ•°ç»„ï¼Œä½¿å…¶ä»é¡¶çº§åˆ°ç›´æ¥çˆ¶çº§
                $parent_names = array_reverse($parent_names);

                $unmapped_categories[] = [
                    'term_id' => $category->term_id,
                    'name' => $category->name,
                    'count' => $category->count,
                    'parent' => $category->parent,
                    'level' => $level,
                    'parent_names' => $parent_names,
                    'full_path' => !empty($parent_names) ? implode(' > ', $parent_names) . ' > ' . $category->name : $category->name
                ];
            }
        }

        // æŒ‰å±‚çº§å’Œåç§°æ’åº
        usort($unmapped_categories, function($a, $b) {
            // é¦–å…ˆæŒ‰çˆ¶åˆ†ç±»è·¯å¾„æ’åº
            $path_compare = strcmp($a['full_path'], $b['full_path']);
            if ($path_compare !== 0) {
                return $path_compare;
            }
            // ç„¶åæŒ‰å±‚çº§æ’åº
            if ($a['level'] !== $b['level']) {
                return $a['level'] - $b['level'];
            }
            // æœ€åæŒ‰åç§°æ’åº
            return strcmp($a['name'], $b['name']);
        });

        wp_send_json_success($unmapped_categories);

    } catch (Exception $e) {
        woo_walmart_sync_log('è·å–æœªæ˜ å°„æœ¬åœ°ç±»ç›®å¤±è´¥', 'é”™è¯¯', [
            'walmart_category' => $walmart_category,
            'error' => $e->getMessage()
        ]);

        wp_send_json_error('è·å–æœªæ˜ å°„æœ¬åœ°ç±»ç›®å¤±è´¥: ' . $e->getMessage());
    }
});

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šä¿å­˜æœ¬åœ°ç±»ç›®æ˜ å°„ï¼ˆå…±äº«æ˜ å°„è®°å½•ï¼‰
 */
add_action('wp_ajax_save_local_category_mappings', function() {
    // éªŒè¯nonce
    if (!wp_verify_nonce($_POST['nonce'], 'walmart_category_map_nonce')) {
        wp_send_json_error('å®‰å…¨éªŒè¯å¤±è´¥');
    }

    // éªŒè¯ç”¨æˆ·æƒé™
    if (!current_user_can('manage_options')) {
        wp_send_json_error('æƒé™ä¸è¶³');
    }

    $walmart_category = sanitize_text_field($_POST['walmart_category']);
    $walmart_category_name = sanitize_text_field($_POST['walmart_category_name']);
    $local_categories = array_map('intval', $_POST['local_categories']);

    if (empty($walmart_category) || empty($local_categories)) {
        wp_send_json_error('å‚æ•°ç¼ºå¤±');
    }

    try {
        global $wpdb;
        $map_table = $wpdb->prefix . 'walmart_category_map';

        // æŸ¥æ‰¾è¯¥Walmartåˆ†ç±»çš„ç°æœ‰æ˜ å°„è®°å½•
        $existing_mapping = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $map_table WHERE walmart_category_path = %s LIMIT 1",
            $walmart_category
        ));

        $success_count = 0;
        $errors = [];

        // éªŒè¯æ‰€æœ‰æœ¬åœ°åˆ†ç±»
        $valid_categories = [];
        foreach ($local_categories as $category_id) {
            // æ£€æŸ¥åˆ†ç±»æ˜¯å¦å­˜åœ¨
            $category = get_term($category_id, 'product_cat');
            if (is_wp_error($category) || !$category) {
                $errors[] = "åˆ†ç±»ID {$category_id} ä¸å­˜åœ¨";
                continue;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜ å°„åˆ°å…¶ä»–Walmartåˆ†ç±»
            $existing_other = $wpdb->get_var($wpdb->prepare(
                "SELECT walmart_category_path FROM $map_table WHERE wc_category_id = %d",
                $category_id
            ));

            if ($existing_other && $existing_other !== $walmart_category) {
                $errors[] = "åˆ†ç±» {$category->name} å·²ç»æ˜ å°„åˆ°å…¶ä»–Walmartåˆ†ç±»: {$existing_other}";
                continue;
            }

            $valid_categories[] = [
                'id' => $category_id,
                'name' => $category->name
            ];
        }

        if (empty($valid_categories)) {
            wp_send_json_error('æ²¡æœ‰æœ‰æ•ˆçš„æœ¬åœ°åˆ†ç±»å¯ä»¥æ·»åŠ ï¼š' . implode(', ', $errors));
        }

        if ($existing_mapping) {
            // æ›´æ–°ç°æœ‰æ˜ å°„è®°å½•ï¼Œæ·»åŠ æ–°çš„æœ¬åœ°åˆ†ç±»ID
            $current_local_ids = [];

            // æ£€æŸ¥æ˜¯å¦æœ‰local_category_idså­—æ®µ
            if (isset($existing_mapping->local_category_ids) && !empty($existing_mapping->local_category_ids)) {
                $current_local_ids = json_decode($existing_mapping->local_category_ids, true) ?: [];
            } else {
                // å¦‚æœæ²¡æœ‰local_category_idså­—æ®µï¼Œä½¿ç”¨wc_category_idä½œä¸ºåˆå§‹å€¼
                $current_local_ids = [$existing_mapping->wc_category_id];
            }

            // æ·»åŠ æ–°çš„æœ¬åœ°åˆ†ç±»ID
            foreach ($valid_categories as $cat) {
                if (!in_array($cat['id'], $current_local_ids)) {
                    $current_local_ids[] = $cat['id'];
                    $success_count++;
                }
            }

            // æ›´æ–°æ˜ å°„è®°å½•
            $update_data = [
                'local_category_ids' => json_encode($current_local_ids),
                'wc_category_name' => $existing_mapping->wc_category_name . ' + ' . count($valid_categories) . 'ä¸ªæ–°åˆ†ç±»'
            ];

            $result = $wpdb->update(
                $map_table,
                $update_data,
                ['id' => $existing_mapping->id]
            );

            if ($result !== false) {
                woo_walmart_sync_log('æ›´æ–°å…±äº«æ˜ å°„è®°å½•', 'æˆåŠŸ', [
                    'walmart_category' => $walmart_category,
                    'added_categories' => $valid_categories,
                    'total_local_categories' => count($current_local_ids),
                    'mapping_id' => $existing_mapping->id
                ]);
            } else {
                throw new Exception('æ›´æ–°æ˜ å°„è®°å½•å¤±è´¥: ' . $wpdb->last_error);
            }

        } else {
            // åˆ›å»ºæ–°çš„å…±äº«æ˜ å°„è®°å½•
            $local_category_ids = array_column($valid_categories, 'id');
            $local_category_names = array_column($valid_categories, 'name');

            $insert_data = [
                'wc_category_id' => $local_category_ids[0], // ä½¿ç”¨ç¬¬ä¸€ä¸ªåˆ†ç±»IDä½œä¸ºä¸»åˆ†ç±»
                'wc_category_name' => implode(', ', $local_category_names),
                'walmart_category_path' => $walmart_category,
                'local_category_ids' => json_encode($local_category_ids)
            ];

            $result = $wpdb->insert($map_table, $insert_data);

            if ($result) {
                $success_count = count($valid_categories);

                woo_walmart_sync_log('åˆ›å»ºå…±äº«æ˜ å°„è®°å½•', 'æˆåŠŸ', [
                    'walmart_category' => $walmart_category,
                    'local_categories' => $valid_categories,
                    'mapping_id' => $wpdb->insert_id
                ]);
            } else {
                throw new Exception('åˆ›å»ºæ˜ å°„è®°å½•å¤±è´¥: ' . $wpdb->last_error);
            }
        }

        if ($success_count > 0) {
            $message = "æˆåŠŸæ·»åŠ  {$success_count} ä¸ªæœ¬åœ°ç±»ç›®åˆ°å…±äº«æ˜ å°„";
            if (!empty($errors)) {
                $message .= "ï¼Œä½†æœ‰ " . count($errors) . " ä¸ªå¤±è´¥ï¼š" . implode(', ', $errors);
            }
            wp_send_json_success($message);
        } else {
            wp_send_json_error('æ²¡æœ‰æˆåŠŸæ·»åŠ ä»»ä½•æ˜ å°„ï¼š' . implode(', ', $errors));
        }

    } catch (Exception $e) {
        woo_walmart_sync_log('ä¿å­˜å…±äº«æ˜ å°„å¤±è´¥', 'é”™è¯¯', [
            'walmart_category' => $walmart_category,
            'local_categories' => $local_categories,
            'error' => $e->getMessage()
        ]);

        wp_send_json_error('ä¿å­˜å¤±è´¥: ' . $e->getMessage());
    }
});

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šä¿å­˜åˆ†ç±»æ˜ å°„
 */
add_action('wp_ajax_save_category_mapping', function() {
    // éªŒè¯nonce
    $nonce = $_POST['_wpnonce'] ?? '';
    if (!wp_verify_nonce($nonce, 'walmart_category_map_save')) {
        wp_send_json_error('å®‰å…¨éªŒè¯å¤±è´¥');
        return;
    }

    if (!current_user_can('manage_options')) {
        wp_send_json_error('æƒé™ä¸è¶³');
        return;
    }

    global $wpdb;
    $map_table = $wpdb->prefix . 'walmart_category_map';

    try {
        if (!empty($_POST['walmart_category'])) {
            foreach ($_POST['walmart_category'] as $wc_cat_id => $walmart_path) {
                $wc_cat_id = intval($wc_cat_id);
                $walmart_path = sanitize_text_field($walmart_path);
                $wc_term = get_term($wc_cat_id, 'product_cat');

                $attributes_mapping = [];

                // å¤„ç†å±æ€§æ•°æ®
                if (isset($_POST['attributes'][$wc_cat_id]['name']) && is_array($_POST['attributes'][$wc_cat_id]['name'])) {
                    $raw_attributes = wp_unslash($_POST['attributes'][$wc_cat_id]);
                    $required_levels = isset($_POST['required_levels'][$wc_cat_id]) ? wp_unslash($_POST['required_levels'][$wc_cat_id]) : [];
                    $attribute_groups = isset($_POST['attribute_groups'][$wc_cat_id]) ? wp_unslash($_POST['attribute_groups'][$wc_cat_id]) : [];
                    $enum_values = isset($_POST['enum_values'][$wc_cat_id]) ? wp_unslash($_POST['enum_values'][$wc_cat_id]) : [];

                    foreach($raw_attributes['name'] as $index => $name) {
                        if (!empty($name)) {
                            $name = sanitize_text_field($name);
                            $type = isset($raw_attributes['type'][$index]) ? sanitize_text_field($raw_attributes['type'][$index]) : 'default_value';
                            $source = isset($raw_attributes['source'][$index]) ? sanitize_text_field($raw_attributes['source'][$index]) : '';
                            $required_level = isset($required_levels[$index]) ? sanitize_text_field($required_levels[$index]) : '';
                            $group = isset($attribute_groups[$index]) ? sanitize_text_field($attribute_groups[$index]) : '';
                            $format = isset($raw_attributes['format'][$index]) ? sanitize_text_field($raw_attributes['format'][$index]) : '';
                            $enum_value = isset($enum_values[$index]) ? sanitize_text_field($enum_values[$index]) : '';

                            // å¤„ç†attributes_fieldç±»å‹çš„é¢å¤–å­—æ®µ
                            $attributes_key = '';
                            if (isset($raw_attributes['attributes_key'][$index])) {
                                $attributes_key = sanitize_text_field($raw_attributes['attributes_key'][$index]);
                            }

                            $attributes_mapping['name'][] = $name;
                            $attributes_mapping['type'][] = $type;
                            $attributes_mapping['source'][] = $source;
                            $attributes_mapping['required_level'][] = $required_level;
                            $attributes_mapping['group'][] = $group;
                            $attributes_mapping['attributes_key'][] = $attributes_key;
                            $attributes_mapping['format'][] = $format;
                            $attributes_mapping['enum_values'][] = $enum_value;
                        }
                    }
                }

                if ($wc_term && !is_wp_error($wc_term)) {
                    if (empty($walmart_path)) {
                        $wpdb->delete($map_table, ['wc_category_id' => $wc_cat_id]);
                    } else {
                        $json_data = wp_json_encode($attributes_mapping, JSON_UNESCAPED_UNICODE);

                        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç°æœ‰æ˜ å°„è®°å½•ï¼Œä¿ç•™local_category_idså­—æ®µ
                        $existing_mapping = $wpdb->get_row($wpdb->prepare(
                            "SELECT * FROM $map_table WHERE wc_category_id = %d",
                            $wc_cat_id
                        ));

                        // å¦‚æœæ²¡æ‰¾åˆ°ç›´æ¥æ˜ å°„ï¼Œæ£€æŸ¥å…±äº«æ˜ å°„
                        if (!$existing_mapping) {
                            $all_mappings = $wpdb->get_results("SELECT * FROM $map_table WHERE local_category_ids IS NOT NULL AND local_category_ids != ''");
                            foreach ($all_mappings as $potential_mapping) {
                                $local_ids = json_decode($potential_mapping->local_category_ids, true) ?: [];
                                if (in_array($wc_cat_id, array_map('intval', $local_ids))) {
                                    $existing_mapping = $potential_mapping;
                                    break;
                                }
                            }
                        }

                        $save_data = [
                            'wc_category_id' => $wc_cat_id,
                            'wc_category_name' => $wc_term->name,
                            'walmart_category_path' => $walmart_path,
                            'walmart_attributes' => $json_data
                        ];

                        // ä¿ç•™ç°æœ‰çš„local_category_idså­—æ®µ
                        if ($existing_mapping && !empty($existing_mapping->local_category_ids)) {
                            $save_data['local_category_ids'] = $existing_mapping->local_category_ids;
                        }

                        $result = $wpdb->replace($map_table, $save_data);

                        if ($result === false) {
                            wp_send_json_error('æ•°æ®åº“ä¿å­˜å¤±è´¥');
                            return;
                        }
                    }
                }
            }

            woo_walmart_sync_log('AJAXåˆ†ç±»æ˜ å°„ä¿å­˜', 'æˆåŠŸ', [
                'categories_count' => count($_POST['walmart_category']),
                'post_data' => $_POST
            ], 'AJAXæ–¹å¼ä¿å­˜åˆ†ç±»æ˜ å°„æˆåŠŸ');

            wp_send_json_success('åˆ†ç±»æ˜ å°„ä¿å­˜æˆåŠŸ');
        } else {
            wp_send_json_error('æ²¡æœ‰è¦ä¿å­˜çš„æ˜ å°„æ•°æ®');
        }

    } catch (Exception $e) {
        woo_walmart_sync_log('AJAXåˆ†ç±»æ˜ å°„ä¿å­˜', 'å¤±è´¥', [
            'error' => $e->getMessage(),
            'post_data' => $_POST
        ], 'AJAXä¿å­˜å¤±è´¥');

        wp_send_json_error('ä¿å­˜å¤±è´¥: ' . $e->getMessage());
    }
});

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šè·å–å±æ€§æšä¸¾å€¼
 */
add_action('wp_ajax_get_attribute_enum_values', function() {
    // éªŒè¯nonce
    if (!wp_verify_nonce($_POST['nonce'], 'walmart_enum_values_nonce')) {
        wp_send_json_error('å®‰å…¨éªŒè¯å¤±è´¥');
    }

    if (!current_user_can('manage_options')) {
        wp_send_json_error('æƒé™ä¸è¶³');
    }

    $attribute_name = sanitize_text_field($_POST['attribute_name']);
    $walmart_category = sanitize_text_field($_POST['walmart_category']);

    if (empty($attribute_name) || empty($walmart_category)) {
        wp_send_json_error('å‚æ•°ä¸å®Œæ•´');
    }

    global $wpdb;
    $attr_table = $wpdb->prefix . 'walmart_product_attributes';

    // æŸ¥è¯¢å±æ€§çš„æšä¸¾å€¼
    $attribute = $wpdb->get_row($wpdb->prepare(
        "SELECT allowed_values FROM $attr_table
         WHERE product_type_id = %s AND attribute_name = %s",
        $walmart_category, $attribute_name
    ));

    if (!$attribute || empty($attribute->allowed_values)) {
        wp_send_json_error('æœªæ‰¾åˆ°æšä¸¾å€¼');
    }

    // è§£ææšä¸¾å€¼
    $allowed_values_parts = explode('||', $attribute->allowed_values);
    $enum_values = explode('|', $allowed_values_parts[0]);

    // è¿‡æ»¤æ‰å•ä½ä¿¡æ¯
    $filtered_enum_values = array_filter($enum_values, function($value) {
        return strpos($value, 'UNITS:') !== 0 && strpos($value, 'DEFAULT_UNIT:') !== 0 && !empty(trim($value));
    });

    if (empty($filtered_enum_values)) {
        wp_send_json_error('æ²¡æœ‰æœ‰æ•ˆçš„æšä¸¾å€¼');
    }

    // é‡æ–°ç´¢å¼•æ•°ç»„
    $filtered_enum_values = array_values($filtered_enum_values);

    wp_send_json_success($filtered_enum_values);
});

/**
 * AJAXå¤„ç†å‡½æ•°ï¼šç§»é™¤åˆ†ç±»æ˜ å°„
 */
add_action('wp_ajax_remove_category_mapping', function() {
    // éªŒè¯nonce
    $nonce = $_POST['nonce'] ?? '';
    if (!wp_verify_nonce($nonce, 'walmart_category_map_nonce')) {
        wp_send_json_error('å®‰å…¨éªŒè¯å¤±è´¥');
        return;
    }

    if (!current_user_can('manage_options')) {
        wp_send_json_error('æƒé™ä¸è¶³');
        return;
    }

    $category_id = intval($_POST['category_id'] ?? 0);
    $mapping_id = intval($_POST['mapping_id'] ?? 0);

    if (!$category_id || !$mapping_id) {
        wp_send_json_error('å‚æ•°é”™è¯¯');
        return;
    }

    global $wpdb;
    $map_table = $wpdb->prefix . 'walmart_category_map';

    try {
        // é¦–å…ˆæ£€æŸ¥å¹¶æ·»åŠ local_category_idså­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        $columns = $wpdb->get_results("SHOW COLUMNS FROM {$map_table} LIKE 'local_category_ids'");
        if (empty($columns)) {
            $alter_result = $wpdb->query("ALTER TABLE {$map_table} ADD COLUMN local_category_ids TEXT NULL AFTER walmart_attributes");
            if ($alter_result === false) {
                woo_walmart_sync_log('æ•°æ®åº“å‡çº§', 'å¤±è´¥', [
                    'error' => $wpdb->last_error,
                    'table' => $map_table
                ], 'æ·»åŠ local_category_idså­—æ®µå¤±è´¥');
                wp_send_json_error('æ•°æ®åº“å‡çº§å¤±è´¥: ' . $wpdb->last_error);
                return;
            }
            woo_walmart_sync_log('æ•°æ®åº“å‡çº§', 'æˆåŠŸ', [], 'æ·»åŠ äº†local_category_idså­—æ®µåˆ°åˆ†ç±»æ˜ å°„è¡¨');
        }

        // è·å–å½“å‰æ˜ å°„è®°å½•
        $mapping = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM {$map_table} WHERE id = %d",
            $mapping_id
        ));

        if (!$mapping) {
            wp_send_json_error('æ˜ å°„è®°å½•ä¸å­˜åœ¨');
            return;
        }

        // è§£æå½“å‰çš„æœ¬åœ°åˆ†ç±»IDåˆ—è¡¨
        $local_category_ids = [];
        if (!empty($mapping->local_category_ids)) {
            $local_category_ids = json_decode($mapping->local_category_ids, true);
            if (!is_array($local_category_ids)) {
                $local_category_ids = [$mapping->wc_category_id]; // å…¼å®¹æ—§æ ¼å¼
            }
        } else {
            $local_category_ids = [$mapping->wc_category_id]; // å…¼å®¹æ—§æ ¼å¼
        }

        // ä»åˆ—è¡¨ä¸­ç§»é™¤æŒ‡å®šçš„åˆ†ç±»ID
        $local_category_ids = array_filter($local_category_ids, function($id) use ($category_id) {
            return intval($id) !== $category_id;
        });

        // é‡æ–°ç´¢å¼•æ•°ç»„
        $local_category_ids = array_values($local_category_ids);

        if (empty($local_category_ids)) {
            // å¦‚æœæ²¡æœ‰å‰©ä½™çš„æœ¬åœ°åˆ†ç±»ï¼Œåˆ é™¤æ•´ä¸ªæ˜ å°„è®°å½•
            $result = $wpdb->delete($map_table, ['id' => $mapping_id]);
            if ($result === false) {
                wp_send_json_error('åˆ é™¤æ˜ å°„è®°å½•å¤±è´¥');
                return;
            }

            woo_walmart_sync_log('ç§»é™¤åˆ†ç±»æ˜ å°„', 'æˆåŠŸ', [
                'mapping_id' => $mapping_id,
                'removed_category_id' => $category_id,
                'action' => 'delete_mapping'
            ], 'åˆ é™¤äº†æ•´ä¸ªæ˜ å°„è®°å½•ï¼Œå› ä¸ºæ²¡æœ‰å‰©ä½™çš„æœ¬åœ°åˆ†ç±»');
        } else {
            // æ›´æ–°æ˜ å°„è®°å½•ï¼Œç§»é™¤æŒ‡å®šçš„åˆ†ç±»ID
            $result = $wpdb->update(
                $map_table,
                [
                    'local_category_ids' => wp_json_encode($local_category_ids)
                ],
                ['id' => $mapping_id]
            );

            if ($result === false) {
                woo_walmart_sync_log('æ›´æ–°æ˜ å°„è®°å½•', 'å¤±è´¥', [
                    'mapping_id' => $mapping_id,
                    'category_id' => $category_id,
                    'local_category_ids' => $local_category_ids,
                    'wpdb_error' => $wpdb->last_error
                ], 'æ›´æ–°æ˜ å°„è®°å½•å¤±è´¥');
                wp_send_json_error('æ›´æ–°æ˜ å°„è®°å½•å¤±è´¥: ' . $wpdb->last_error);
                return;
            }

            woo_walmart_sync_log('ç§»é™¤åˆ†ç±»æ˜ å°„', 'æˆåŠŸ', [
                'mapping_id' => $mapping_id,
                'removed_category_id' => $category_id,
                'remaining_categories' => $local_category_ids,
                'action' => 'update_mapping'
            ], 'ä»å…±äº«æ˜ å°„ä¸­ç§»é™¤äº†æŒ‡å®šåˆ†ç±»');
        }

        wp_send_json_success('åˆ†ç±»ç§»é™¤æˆåŠŸ');

    } catch (Exception $e) {
        woo_walmart_sync_log('ç§»é™¤åˆ†ç±»æ˜ å°„', 'å¤±è´¥', [
            'mapping_id' => $mapping_id,
            'category_id' => $category_id,
            'error' => $e->getMessage()
        ], 'ç§»é™¤åˆ†ç±»æ˜ å°„å¤±è´¥');

        wp_send_json_error('ç§»é™¤å¤±è´¥: ' . $e->getMessage());
    }
});

/**
 * å¤„ç†è‡ªåŠ¨ç”Ÿæˆå­—æ®µçš„ä¸»å…¥å£å‡½æ•°
 * åŸºäºè§„åˆ™å’Œè‡ªåŠ¨æ£€æµ‹æœºåˆ¶ï¼Œä¸ä½¿ç”¨ç¡¬ç¼–ç 
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @param string $field_name å­—æ®µåç§°
 * @return mixed ç”Ÿæˆçš„å­—æ®µå€¼
 */
function handle_auto_generate_field($product, $field_name) {
    if (!$product || !is_a($product, 'WC_Product')) {
        return null;
    }

    // å®Œå…¨ä¾èµ–äºç°æœ‰çš„generate_auto_attribute_valueå‡½æ•°
    // è¯¥å‡½æ•°å·²ç»åŒ…å«äº†æ‰€æœ‰å¿…è¦çš„è‡ªåŠ¨æ£€æµ‹é€»è¾‘
    return generate_auto_attribute_value($field_name, $product);
}

/**
 * è‡ªåŠ¨ç”Ÿæˆå±æ€§å€¼
 *
 * @param string $attribute_name å±æ€§åç§°
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return mixed ç”Ÿæˆçš„å±æ€§å€¼
 */
function generate_auto_attribute_value($attribute_name, $product) {
    if (!$product || !is_a($product, 'WC_Product')) {
        return '';
    }

    switch ($attribute_name) {
        case 'productName':
            // ä½¿ç”¨äº§å“æ ‡é¢˜
            return $product->get_name();

        case 'brand':
            // ä¼˜å…ˆä½¿ç”¨äº§å“å“ç‰Œå±æ€§ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨"Unbranded"
            $brand = '';

            // å°è¯•ä»äº§å“å±æ€§ä¸­è·å–å“ç‰Œ
            $attributes = $product->get_attributes();
            foreach ($attributes as $attribute) {
                $attribute_name_lower = strtolower($attribute->get_name());
                if (in_array($attribute_name_lower, ['brand', 'å“ç‰Œ', 'marca', 'marque'])) {
                    $terms = $attribute->get_terms();
                    if (!empty($terms)) {
                        $brand = $terms[0]->name;
                        break;
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å“ç‰Œï¼Œå°è¯•ä»è‡ªå®šä¹‰å­—æ®µè·å–
            if (empty($brand)) {
                $brand_fields = ['_brand', 'brand', '_product_brand', 'product_brand'];
                foreach ($brand_fields as $field) {
                    $brand = get_post_meta($product->get_id(), $field, true);
                    if (!empty($brand)) {
                        break;
                    }
                }
            }

            return !empty($brand) ? $brand : 'Unbranded';

        case 'shortDescription':
            // ä½¿ç”¨äº§å“ç®€çŸ­æè¿°
            return $product->get_short_description();

        case 'keyFeatures':
            // æ™ºèƒ½ç”Ÿæˆäº§å“ç‰¹è‰²
            return generate_key_features($product);

        case 'mainImageUrl':
            // è¯»å–äº§å“ä¸»å›¾
            return get_product_main_image_url($product);

        case 'material':
            // ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§Main Materialï¼Œå¦åˆ™è‡ªåŠ¨æå–
            return get_product_material($product);

        case 'bed_frame_type':
            // ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§bed_frame_typeï¼Œå¦åˆ™è‡ªåŠ¨æå–
            return get_product_bed_frame_type($product);

        case 'bedSize':
            // ä¼˜å…ˆä½¿ç”¨äº§å“å±æ€§bedSizeï¼Œå¦åˆ™è‡ªåŠ¨æå–
            return get_product_bed_size($product);

        case 'assembledProductLength':
            // ä»Product Sizeæå–é•¿åº¦å€¼
            return get_product_dimension($product, 'length');

        case 'assembledProductWidth':
            // ä»Product Sizeæå–å®½åº¦å€¼
            return get_product_dimension($product, 'width');

        case 'assembledProductHeight':
            // ä»Product Sizeæå–é«˜åº¦å€¼
            return get_product_dimension($product, 'height');

        case 'assembledProductWeight':
            // ä»Product Weightæå–é‡é‡å€¼
            return get_product_weight($product);

        case 'productSecondaryImageURL':
            // è·å–äº§å“é™„åŠ å›¾ç‰‡URLæ•°ç»„
            return get_product_secondary_images($product);

        case 'productIdentifiers':
            // ç”ŸæˆUPCäº§å“æ ‡è¯†ç¬¦å¯¹è±¡
            return generate_product_identifiers($product);


        case 'netContent':
            // è¿”å›netContentå¯¹è±¡ç»“æ„
            return [
                'productNetContentMeasure' => 1,
                'productNetContentUnit' => 'Count'
            ];

        case 'box_spring_required':
            return get_product_box_spring_required($product);

        case 'color':
            return get_product_color($product);

        case 'colorCategory':
            $color = get_product_color($product);
            return map_color_to_category($color);

        case 'items_included':
            return get_product_items_included($product);

        case 'manufacturerPartNumber':
        case 'modelNumber':
            return encode_sku_for_walmart($product->get_sku());

        case 'maximumLoadWeight':
            return get_product_maximum_load_weight($product);

        case 'occasion':
            return get_product_attribute_value($product, 'occasion', '');

        case 'productLine':
            return get_product_attribute_value($product, 'productLine', '');

        case 'swatchImages':
            return get_product_main_image_url($product);

        case 'sku':
            return $product->get_sku();

        case 'price':
            return number_format((float)$product->get_price(), 2, '.', '');

        case 'ShippingWeight':
            return get_product_shipping_weight($product);

        case 'electronicsIndicator':
            return get_product_electronics_indicator($product);

        case 'features':
            return get_product_features($product);

        case 'has_storage':
            return get_product_has_storage($product);

        case 'has_trundle':
            return get_product_has_trundle($product);

        case 'homeDecorStyle':
            return get_product_home_decor_style($product);

        case 'numberOfDrawers':
            return get_product_number_of_drawers($product);

        case 'numberOfShelves':
            return get_product_number_of_shelves($product);

        case 'upholstered':
            return get_product_upholstered($product);

        case 'wood_type':
            return get_product_wood_type($product);

        case 'wood_tone':
            return get_product_wood_tone($product);

        case 'profile':
            return get_product_profile($product);

        case 'theme':
            return get_product_theme($product);

        case 'arm_style':
            return get_product_arm_style($product);

        case 'frameColor':
            return get_product_frame_color($product);

        case 'chair_style':
            return get_product_chair_style($product);

        case 'frameMaterial':
            return get_product_frame_material($product);

        case 'ottoman_included':
            return get_product_ottoman_included($product);

        case 'pattern':
            return get_product_pattern($product);

        case 'leg_color':
            return get_product_leg_color($product);

        case 'leg_material':
            return get_product_leg_material($product);

        case 'preset_bed_positions':
            return get_product_preset_bed_positions($product);

        case 'fulfillmentCenterID':
            // è·å–å±¥è¡Œä¸­å¿ƒIDï¼Œä¼˜å…ˆä½¿ç”¨å¸‚åœºä¸“ç”¨é…ç½®ï¼Œç„¶åä½¿ç”¨é€šç”¨é…ç½®
            $business_unit = get_option('woo_walmart_business_unit', 'WALMART_US');
            $market_code = str_replace('WALMART_', '', $business_unit);

            // ä¼˜å…ˆä½¿ç”¨å¸‚åœºä¸“ç”¨çš„å±¥è¡Œä¸­å¿ƒID
            $fulfillment_center_id = get_option("woo_walmart_{$market_code}_fulfillment_center_id", '');

            // å¦‚æœå¸‚åœºä¸“ç”¨IDä¸ºç©ºï¼Œä½¿ç”¨é€šç”¨é…ç½®
            if (empty($fulfillment_center_id)) {
                $fulfillment_center_id = get_option('woo_walmart_fulfillment_center_id', '');
            }

            // å¦‚æœè¿˜æ˜¯ä¸ºç©ºï¼Œæ ¹æ®å¸‚åœºæä¾›é»˜è®¤å€¼
            if (empty($fulfillment_center_id)) {
                switch ($market_code) {
                    case 'CA':
                        return 'WFS_CA';
                    case 'MX':
                        return 'WFS_MX';
                    case 'CL':
                        return 'WFS_CL';
                    case 'US':
                    default:
                        return 'WFS';
                }
            }

            return $fulfillment_center_id;

        case 'fulfillmentLagTime':
            // è¿”å›æ•´æ•°ï¼Œé»˜è®¤1å¤©ï¼ˆå•ä½å·²éšå«ä¸ºå¤©ï¼‰
            return 1;

        case 'releaseDate':
        case 'startDate':
            // åŒæ­¥å½“å¤©å¾€å‰æ¨ä¸€å¤©
            return date('Y-m-d', strtotime('-1 day'));

        case 'endDate':
            // åŒæ­¥å½“å¤©å¾€åæ¨15å¹´
            return date('Y-m-d', strtotime('+15 years'));

        default:
            return '';
    }
}

/**
 * æ™ºèƒ½ç”Ÿæˆäº§å“ç‰¹è‰²
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array ç‰¹è‰²åˆ—è¡¨
 */
function generate_key_features($product) {
    $features = [];

    // ç¬¬ä¸€ä¼˜å…ˆï¼šä»ç®€çŸ­æè¿°ä¸­æå–ç‰¹è‰²
    $short_description = $product->get_short_description();
    if (!empty($short_description)) {
        $features = extract_features_from_description($short_description);
    }

    // ç¬¬äºŒä¼˜å…ˆï¼šå¦‚æœç®€çŸ­æè¿°æ²¡æœ‰å†…å®¹ï¼Œä»äº§å“æè¿°å’Œæ ‡é¢˜æ™ºèƒ½ç”Ÿæˆ
    if (empty($features)) {
        $features = generate_features_from_content($product);
    }

    // ç¡®ä¿è‡³å°‘æœ‰3ä¸ªç‰¹è‰²ï¼Œæœ€å¤š5ä¸ª
    $features = array_slice($features, 0, 5);
    if (count($features) < 3) {
        // è¡¥å……é€šç”¨ç‰¹è‰²
        $generic_features = [
            'High quality construction',
            'Easy to use and maintain',
            'Suitable for daily use'
        ];

        foreach ($generic_features as $generic) {
            if (count($features) >= 3) break;
            if (!in_array($generic, $features)) {
                $features[] = $generic;
            }
        }
    }

    return $features;
}

/**
 * ä»æè¿°ä¸­æå–ç‰¹è‰²åˆ—è¡¨
 *
 * @param string $description æè¿°æ–‡æœ¬
 * @return array ç‰¹è‰²åˆ—è¡¨
 */
function extract_features_from_description($description) {
    $features = [];

    // ç§»é™¤HTMLæ ‡ç­¾
    $text = strip_tags($description);

    // åŒ¹é…ä¸åŒæ ¼å¼çš„åˆ—è¡¨é¡¹
    $patterns = [
        '/(?:^|\n)\s*<li[^>]*>(.*?)<\/li>/i',  // HTML liæ ‡ç­¾
        '/(?:^|\n)\s*[*â€¢-]\s*(.+?)(?=\n|$)/m', // * â€¢ - å¼€å¤´
        '/(?:^|\n)\s*\d+\.\s*(.+?)(?=\n|$)/m', // æ•°å­—. å¼€å¤´
    ];

    foreach ($patterns as $pattern) {
        if (preg_match_all($pattern, $description, $matches)) {
            foreach ($matches[1] as $match) {
                $feature = trim(strip_tags($match));
                if (!empty($feature) && strlen($feature) > 10 && strlen($feature) <= 200) {
                    $features[] = $feature;
                }
            }
        }
    }

    return array_unique($features);
}

/**
 * ä»äº§å“å†…å®¹æ™ºèƒ½ç”Ÿæˆç‰¹è‰²
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array ç‰¹è‰²åˆ—è¡¨
 */
function generate_features_from_content($product) {
    $features = [];

    // ä»äº§å“æ ‡é¢˜æå–å…³é”®è¯
    $title = $product->get_name();
    $description = $product->get_description();

    // åŸºäºäº§å“ç±»å‹å’Œå±æ€§ç”Ÿæˆç‰¹è‰²
    $categories = wp_get_post_terms($product->get_id(), 'product_cat');
    $attributes = $product->get_attributes();

    // æ·»åŠ åŸºäºåˆ†ç±»çš„ç‰¹è‰²
    if (!empty($categories)) {
        $category_name = $categories[0]->name;
        $features[] = "Perfect for " . strtolower($category_name) . " needs";
    }

    // æ·»åŠ åŸºäºå±æ€§çš„ç‰¹è‰²
    foreach ($attributes as $attribute) {
        $terms = $attribute->get_terms();
        if (!empty($terms)) {
            $attr_name = $attribute->get_name();
            $attr_value = $terms[0]->name;
            $features[] = ucfirst($attr_name) . ": " . $attr_value;
        }
    }

    // æ·»åŠ åŸºäºå°ºå¯¸çš„ç‰¹è‰²
    $dimensions = $product->get_dimensions(false);
    if (!empty($dimensions['length']) || !empty($dimensions['width']) || !empty($dimensions['height'])) {
        $features[] = "Compact and space-efficient design";
    }

    // æ·»åŠ åŸºäºé‡é‡çš„ç‰¹è‰²
    $weight = $product->get_weight();
    if (!empty($weight)) {
        $features[] = "Lightweight and portable";
    }

    return array_slice($features, 0, 5);
}

/**
 * è·å–äº§å“ä¸»å›¾URL
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string ä¸»å›¾URL
 */
function get_product_main_image_url($product) {
    // è·å–äº§å“ä¸»å›¾ID
    $image_id = $product->get_image_id();

    if (!$image_id) {
        return '';
    }

    $image_url = '';

    // å¤„ç†ä¸åŒç±»å‹çš„å›¾ç‰‡ID
    if (is_numeric($image_id) && $image_id > 0) {
        // æœ¬åœ°å›¾ç‰‡ï¼ˆWordPressåª’ä½“åº“ï¼‰
        $image_url = wp_get_attachment_url($image_id);
    } elseif (is_string($image_id) && strpos($image_id, 'remote_') === 0) {
        // è¿œç¨‹å›¾ç‰‡ï¼ˆremote_å‰ç¼€ï¼‰
        // è¿œç¨‹å›¾ç‰‡URLå­˜å‚¨åœ¨ meta key: _remote_image_url_{remote_id}
        $remote_url_meta = get_post_meta($product->get_id(), '_remote_image_url_' . $image_id, true);
        if (!empty($remote_url_meta) && filter_var($remote_url_meta, FILTER_VALIDATE_URL)) {
            $image_url = $remote_url_meta;
        }
    }

    // å¦‚æœä¸»å›¾è·å–å¤±è´¥ï¼Œå°è¯•ä»äº§å“å›¾åº“è·å–ç¬¬ä¸€å¼ å›¾ç‰‡
    if (empty($image_url)) {
        $gallery_image_ids = $product->get_gallery_image_ids();

        if (!empty($gallery_image_ids)) {
            foreach ($gallery_image_ids as $gallery_id) {
                if (is_numeric($gallery_id) && $gallery_id > 0) {
                    // æœ¬åœ°å›¾ç‰‡
                    $gallery_url = wp_get_attachment_url($gallery_id);
                    if (!empty($gallery_url)) {
                        $image_url = $gallery_url;
                        break;
                    }
                } elseif (is_string($gallery_id) && strpos($gallery_id, 'remote_') === 0) {
                    // è¿œç¨‹å›¾ç‰‡ï¼ˆremote_å‰ç¼€ï¼‰
                    $remote_url_meta = get_post_meta($product->get_id(), '_remote_image_url_' . $gallery_id, true);
                    if (!empty($remote_url_meta) && filter_var($remote_url_meta, FILTER_VALIDATE_URL)) {
                        $image_url = $remote_url_meta;
                        break;
                    }
                }
            }
        }
    }

    if (empty($image_url)) {
        return '';
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºè¿œç¨‹URLï¼ˆå·²ç»æ˜¯å®Œæ•´URLï¼‰
    if (filter_var($image_url, FILTER_VALIDATE_URL)) {
        return $image_url;
    }

    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºå®Œæ•´URL
    if (strpos($image_url, '/') === 0) {
        return home_url($image_url);
    }

    return $image_url;
}

/**
 * è·å–äº§å“æè´¨ä¿¡æ¯
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string æè´¨ä¿¡æ¯
 */
function get_product_material($product) {
    // ä¼˜å…ˆä»äº§å“å±æ€§ä¸­è·å–Main Material
    $attributes = $product->get_attributes();

    foreach ($attributes as $attribute) {
        $attribute_name = strtolower($attribute->get_name());
        if (in_array($attribute_name, ['main material', 'material', 'æè´¨', 'ä¸»è¦æè´¨'])) {
            $terms = $attribute->get_terms();
            if (!empty($terms)) {
                return $terms[0]->name;
            }
        }
    }

    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å±æ€§ï¼Œä»æ ‡é¢˜å’Œæè¿°ä¸­æå–
    $title = $product->get_name();
    $description = $product->get_description() . ' ' . $product->get_short_description();

    // å¸¸è§æè´¨å…³é”®è¯
    $materials = [
        'wood', 'wooden', 'oak', 'pine', 'mahogany', 'bamboo',
        'metal', 'steel', 'iron', 'aluminum', 'brass',
        'plastic', 'vinyl', 'leather', 'fabric', 'cotton',
        'glass', 'ceramic', 'stone', 'marble', 'granite'
    ];

    $content = strtolower($title . ' ' . $description);

    foreach ($materials as $material) {
        if (strpos($content, $material) !== false) {
            return ucfirst($material);
        }
    }

    return 'Mixed Materials';  // æè´¨é»˜è®¤å€¼
}

/**
 * è·å–äº§å“åºŠæ¶ç±»å‹ä¿¡æ¯
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string åºŠæ¶ç±»å‹ä¿¡æ¯
 */
/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«åºŠæ¶ç±»å‹
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string åºŠæ¶ç±»å‹
 */
function get_product_bed_frame_type($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å…è®¸çš„åºŠæ¶ç±»å‹ï¼ˆæŒ‰APIè§„èŒƒï¼‰
    $allowed_bed_frame_types = [
        'Trundle Bed Frames',
        'Power Adjustable Bed Frames',
        'Standard Bed Frames',
        'Expandable Size Bed Frames'
    ];

    // å®šä¹‰åºŠæ¶ç±»å‹å…³é”®è¯æ˜ å°„ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    $bed_frame_keywords = [
        // Trundle Bed Frames - æ‹–åºŠ
        'Trundle Bed Frames' => [
            'trundle', 'trundle bed', 'pull out bed', 'pull-out bed',
            'daybed with trundle', 'twin trundle', 'guest bed',
            'æ‹–åºŠ', 'å­æ¯åºŠ', 'æŠ½æ‹‰åºŠ'
        ],

        // Expandable Size Bed Frames - å¯æ‰©å±•å°ºå¯¸åºŠæ¶ï¼ˆä¼˜å…ˆæ£€æŸ¥ï¼Œé¿å…ä¸Power Adjustableå†²çªï¼‰
        'Expandable Size Bed Frames' => [
            'expandable', 'extendable', 'adjustable size', 'multi-size',
            'convertible size', 'size adjustable', 'variable size',
            'twin to full', 'full to queen', 'queen to king',
            'å¯æ‰©å±•', 'å¯ä¼¸ç¼©', 'å¤šå°ºå¯¸'
        ],

        // Power Adjustable Bed Frames - ç”µåŠ¨å¯è°ƒåºŠæ¶
        'Power Adjustable Bed Frames' => [
            'power adjustable', 'electric adjustable', 'motorized',
            'remote control', 'adjustable base', 'power base', 'electric base',
            'zero gravity', 'massage', 'usb charging', 'wireless remote',
            'ç”µåŠ¨', 'å¯è°ƒèŠ‚', 'é¥æ§', 'æŒ‰æ‘©'
        ],

        // Standard Bed Frames - æ ‡å‡†åºŠæ¶ï¼ˆæœ€åæ£€æŸ¥ï¼Œå› ä¸ºæ˜¯é»˜è®¤å€¼ï¼‰
        'Standard Bed Frames' => [
            'standard', 'basic', 'simple', 'regular', 'traditional',
            'platform', 'metal frame', 'steel frame', 'wooden frame',
            'æ ‡å‡†', 'åŸºç¡€', 'æ™®é€š'
        ]
    ];

    // æ£€æŸ¥æ¯ä¸ªåºŠæ¶ç±»å‹çš„å…³é”®è¯ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºæ£€æŸ¥ï¼‰
    $priority_order = ['Trundle Bed Frames', 'Expandable Size Bed Frames', 'Power Adjustable Bed Frames', 'Standard Bed Frames'];

    foreach ($priority_order as $frame_type) {
        if (isset($bed_frame_keywords[$frame_type])) {
            foreach ($bed_frame_keywords[$frame_type] as $keyword) {
                // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
                if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                    return $frame_type;
                }
            }
        }
    }

    // åŸºäºäº§å“ç±»å‹æ¨æ–­åºŠæ¶ç±»å‹
    $product_type_to_frame_type_mapping = [
        'daybed' => 'Trundle Bed Frames',
        'guest bed' => 'Trundle Bed Frames',
        'sofa bed' => 'Standard Bed Frames',
        'murphy bed' => 'Standard Bed Frames',
        'loft bed' => 'Standard Bed Frames',
        'bunk bed' => 'Standard Bed Frames',
        'canopy bed' => 'Standard Bed Frames',
        'sleigh bed' => 'Standard Bed Frames',
        'panel bed' => 'Standard Bed Frames',
        'platform bed' => 'Standard Bed Frames'
    ];

    foreach ($product_type_to_frame_type_mapping as $product_type => $frame_type) {
        if (strpos($content, $product_type) !== false) {
            return $frame_type;
        }
    }

    // åŸºäºåŠŸèƒ½ç‰¹å¾æ¨æ–­
    if (strpos($content, 'massage') !== false ||
        strpos($content, 'zero gravity') !== false ||
        strpos($content, 'usb port') !== false ||
        strpos($content, 'wireless') !== false) {
        return 'Power Adjustable Bed Frames';
    }

    if (strpos($content, 'pull out') !== false ||
        strpos($content, 'guest') !== false ||
        strpos($content, 'extra sleeping') !== false) {
        return 'Trundle Bed Frames';
    }

    if (strpos($content, 'twin to full') !== false ||
        strpos($content, 'full to queen') !== false ||
        strpos($content, 'size conversion') !== false) {
        return 'Expandable Size Bed Frames';
    }

    // é»˜è®¤å€¼ï¼šStandard Bed Frames
    return 'Standard Bed Frames';
}

/**
 * è·å–äº§å“åºŠå°ºå¯¸ä¿¡æ¯
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string åºŠå°ºå¯¸ä¿¡æ¯
 */
function get_product_bed_size($product) {
    // 1. ä¼˜å…ˆä»äº§å“å±æ€§ä¸­è·å–bedSize
    $bed_size = get_product_attribute_value($product, 'bedSize', '');
    if (!empty($bed_size)) {
        // éªŒè¯å±æ€§å€¼æ˜¯å¦åœ¨å…è®¸çš„æšä¸¾ä¸­
        $valid_sizes = ['King', 'Full', 'Non-Standard', 'Queen', 'Twin', 'Twin-XL', 'Crib/Toddler Bed', 'California King'];
        foreach ($valid_sizes as $valid_size) {
            if (stripos($bed_size, $valid_size) !== false) {
                return $valid_size;
            }
        }
    }

    // 2. å°è¯•å…¶ä»–å¯èƒ½çš„åºŠå°ºå¯¸å±æ€§å
    $size_attributes = ['bed_size', 'bed size', 'size', 'åºŠå°ºå¯¸', 'å°ºå¯¸'];
    foreach ($size_attributes as $attr_name) {
        $bed_size = get_product_attribute_value($product, $attr_name, '');
        if (!empty($bed_size)) {
            // éªŒè¯å±æ€§å€¼æ˜¯å¦åœ¨å…è®¸çš„æšä¸¾ä¸­
            $valid_sizes = ['King', 'Full', 'Non-Standard', 'Queen', 'Twin', 'Twin-XL', 'Crib/Toddler Bed', 'California King'];
            foreach ($valid_sizes as $valid_size) {
                if (stripos($bed_size, $valid_size) !== false) {
                    return $valid_size;
                }
            }
        }
    }

    // 3. ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å…³é”®è¯æ˜ å°„ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼Œä»æœ€å…·ä½“åˆ°æœ€ä¸€èˆ¬ï¼‰
    $keyword_mapping = [
        'California King' => ['california king', 'cal king', 'cal-king', 'cali king'],
        'Twin-XL' => ['twin xl', 'twin-xl', 'twin extra long', 'twin xlong'],
        'Crib/Toddler Bed' => ['crib', 'toddler', 'baby bed', 'infant bed', 'nursery bed'],
        'King' => ['king size', 'king bed', ' king ', 'eastern king'],
        'Queen' => ['queen size', 'queen bed', ' queen '],
        'Full' => ['full size', 'full bed', ' full ', 'double bed', 'double size'],
        'Twin' => ['twin size', 'twin bed', ' twin ', 'single bed', 'single size'],
    ];

    // æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥å…³é”®è¯
    foreach ($keyword_mapping as $bed_size => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($content, $keyword) !== false) {
                return $bed_size;
            }
        }
    }

    // 4. é»˜è®¤å€¼
    return 'Non-Standard';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦éœ€è¦å¼¹ç°§åºŠå«
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string Yes æˆ– No
 */
function get_product_box_spring_required($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰éœ€è¦å¼¹ç°§åºŠå«çš„å…³é”®è¯
    $requires_box_spring_keywords = [
        'box spring required',
        'requires box spring',
        'need box spring',
        'needs box spring',
        'box spring needed',
        'with box spring',
        'includes box spring',
        'box spring included',
        'foundation required',
        'requires foundation',
        'need foundation',
        'needs foundation',
        'foundation needed',
        'with foundation',
        'includes foundation',
        'foundation included',
        'mattress support required',
        'requires mattress support',
        'need mattress support',
        'needs mattress support',
        'mattress support needed'
    ];

    // å®šä¹‰ä¸éœ€è¦å¼¹ç°§åºŠå«çš„å…³é”®è¯
    $no_box_spring_keywords = [
        'no box spring required',
        'no box spring needed',
        'box spring not required',
        'box spring not needed',
        'without box spring',
        'no foundation required',
        'no foundation needed',
        'foundation not required',
        'foundation not needed',
        'without foundation',
        'platform bed',
        'platform frame',
        'slat bed',
        'slatted bed',
        'slat frame',
        'slatted frame',
        'built-in support',
        'integrated support',
        'self-supporting',
        'no additional support needed',
        'complete bed frame'
    ];

    // é¦–å…ˆæ£€æŸ¥æ˜ç¡®è¡¨ç¤ºä¸éœ€è¦çš„å…³é”®è¯ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    foreach ($no_box_spring_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'No';
        }
    }

    // ç„¶åæ£€æŸ¥æ˜ç¡®è¡¨ç¤ºéœ€è¦çš„å…³é”®è¯
    // ä½†è¦æ’é™¤å·²ç»è¢«"ä¸éœ€è¦"å…³é”®è¯åŒ¹é…çš„æƒ…å†µ
    $found_requires = false;
    foreach ($requires_box_spring_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            // å†æ¬¡ç¡®è®¤è¿™ä¸æ˜¯"ä¸éœ€è¦"çš„è¡¨è¿°
            $context_around = $content;
            $is_negated = false;

            // æ£€æŸ¥æ˜¯å¦æœ‰å¦å®šè¯åœ¨å…³é”®è¯å‰é¢
            $negation_patterns = ['no ', 'not ', 'without ', 'never '];
            foreach ($negation_patterns as $negation) {
                if (strpos($content, $negation . $keyword) !== false) {
                    $is_negated = true;
                    break;
                }
            }

            if (!$is_negated) {
                $found_requires = true;
                break;
            }
        }
    }

    if ($found_requires) {
        return 'Yes';
    }

    // é»˜è®¤å€¼ï¼šNoï¼ˆå¤§å¤šæ•°ç°ä»£åºŠæ¶ä¸éœ€è¦å¼¹ç°§åºŠå«ï¼‰
    return 'No';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«ç”µå­å…ƒä»¶
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string Yes æˆ– No
 */
function get_product_electronics_indicator($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰åŒ…å«ç”µå­å…ƒä»¶çš„å…³é”®è¯
    $electronics_keywords = [
        // é€šç”¨ç”µå­è®¾å¤‡å…³é”®è¯
        'electronic', 'electronics', 'digital', 'smart', 'bluetooth', 'wifi', 'wireless',
        'battery', 'rechargeable', 'usb', 'charging', 'charger', 'adapter', 'power cord',
        'led', 'lcd', 'oled', 'display', 'screen', 'monitor', 'remote control', 'remote',

        // éŸ³é¢‘è®¾å¤‡
        'speaker', 'headphone', 'earphone', 'microphone', 'amplifier', 'stereo', 'audio',
        'sound system', 'music player', 'radio', 'fm', 'am', 'bluetooth speaker',

        // è®¡ç®—è®¾å¤‡
        'computer', 'laptop', 'tablet', 'smartphone', 'phone', 'processor', 'cpu', 'gpu',
        'memory', 'storage', 'hard drive', 'ssd', 'keyboard', 'mouse', 'webcam',

        // å®¶ç”µè®¾å¤‡
        'electric', 'electrical', 'motor', 'pump', 'fan', 'heater', 'cooler', 'air conditioner',
        'refrigerator', 'microwave', 'oven', 'dishwasher', 'washing machine', 'dryer',

        // ç…§æ˜è®¾å¤‡
        'light', 'lighting', 'lamp', 'bulb', 'fixture', 'chandelier', 'flashlight', 'torch',
        'dimmer', 'switch', 'sensor', 'motion sensor', 'timer',

        // å®‰å…¨è®¾å¤‡
        'alarm', 'security', 'camera', 'surveillance', 'detector', 'smoke detector',
        'carbon monoxide detector', 'doorbell', 'intercom',

        // å¨±ä¹è®¾å¤‡
        'tv', 'television', 'projector', 'gaming', 'game console', 'dvd', 'blu-ray',
        'streaming', 'media player', 'set-top box',

        // é€šä¿¡è®¾å¤‡
        'router', 'modem', 'antenna', 'satellite', 'cable', 'ethernet', 'network',
        'walkie talkie', 'two-way radio',

        // æµ‹é‡ä»ªå™¨
        'meter', 'gauge', 'thermometer', 'hygrometer', 'scale', 'timer', 'clock',
        'calculator', 'multimeter', 'oscilloscope',

        // åŒ»ç–—è®¾å¤‡
        'blood pressure monitor', 'thermometer', 'pulse oximeter', 'hearing aid',
        'electric toothbrush', 'massage device',

        // æ±½è½¦ç”µå­
        'car stereo', 'gps', 'navigation', 'dash cam', 'car charger', 'inverter',
        'jump starter', 'tire pressure monitor',

        // å·¥å…·è®¾å¤‡
        'drill', 'saw', 'grinder', 'sander', 'electric tool', 'power tool',
        'soldering iron', 'heat gun', 'electric screwdriver',

        // å…¶ä»–ç”µå­å…ƒä»¶
        'circuit', 'board', 'chip', 'transistor', 'capacitor', 'resistor', 'diode',
        'sensor', 'actuator', 'controller', 'module', 'component'
    ];

    // å®šä¹‰æ˜ç¡®ä¸åŒ…å«ç”µå­å…ƒä»¶çš„å…³é”®è¯
    $non_electronics_keywords = [
        'no electronics', 'no electronic', 'non-electronic', 'non electronic',
        'manual', 'mechanical', 'hand operated', 'hand-operated', 'purely mechanical',
        'no battery', 'no power', 'unpowered', 'passive', 'analog only',
        'traditional', 'classic', 'vintage', 'antique', 'old-fashioned',
        'wood only', 'metal only', 'plastic only', 'fabric only', 'leather only',
        'no electrical', 'no digital', 'no smart features'
    ];

    // é¦–å…ˆæ£€æŸ¥æ˜ç¡®è¡¨ç¤ºä¸åŒ…å«ç”µå­å…ƒä»¶çš„å…³é”®è¯
    foreach ($non_electronics_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'No';
        }
    }

    // ç„¶åæ£€æŸ¥åŒ…å«ç”µå­å…ƒä»¶çš„å…³é”®è¯
    foreach ($electronics_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'Yes';
        }
    }

    // é»˜è®¤å€¼ï¼šNoï¼ˆå¤§å¤šæ•°äº§å“ä¸åŒ…å«ç”µå­å…ƒä»¶ï¼‰
    return 'No';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«åºŠæ¶ç‰¹è‰²åŠŸèƒ½ï¼ˆä»…é™Bed Framesç±»ç›®ï¼‰
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array ç‰¹è‰²åŠŸèƒ½æ•°ç»„
 */
function get_product_features($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰åºŠæ¶ç‰¹è‰²åŠŸèƒ½å…³é”®è¯æ˜ å°„
    $feature_keywords = [
        'Lighted Headboard' => [
            'lighted headboard', 'led headboard', 'illuminated headboard', 'light headboard',
            'headboard light', 'headboard lighting', 'backlit headboard', 'lit headboard',
            'headboard with light', 'headboard with led', 'glowing headboard'
        ],
        'Under Bed Storage' => [
            'under bed storage', 'storage under bed', 'underneath storage', 'bed storage',
            'storage drawers', 'drawer storage', 'built-in storage', 'integrated storage',
            'storage compartment', 'hidden storage', 'storage space', 'storage bed',
            'drawers underneath', 'pull-out drawers', 'storage frame'
        ],
        'Nailhead Trim' => [
            'nailhead trim', 'nailhead detail', 'nail head trim', 'nail head detail',
            'studded trim', 'decorative nails', 'metal studs', 'brass nails',
            'upholstery nails', 'decorative studs', 'nail trim', 'stud trim'
        ],
        'USB Port' => [
            'usb port', 'usb charging', 'usb outlet', 'charging port', 'charging station',
            'built-in usb', 'integrated usb', 'usb connector', 'phone charging',
            'device charging', 'charging capability', 'power port', 'usb hub'
        ],
        'Tufted' => [
            'tufted', 'button tufted', 'diamond tufted', 'deep tufted', 'tufting',
            'quilted', 'buttoned', 'padded', 'upholstered tufted', 'tufted design',
            'tufted headboard', 'tufted detail', 'capitone', 'diamond pattern'
        ]
    ];

    $detected_features = [];

    // æ£€æŸ¥æ¯ä¸ªç‰¹è‰²åŠŸèƒ½çš„å…³é”®è¯
    foreach ($feature_keywords as $feature => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($content, $keyword) !== false) {
                $detected_features[] = $feature;
                break; // æ‰¾åˆ°ä¸€ä¸ªå…³é”®è¯å°±è·³å‡ºå†…å±‚å¾ªç¯
            }
        }
    }

    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•ç‰¹è‰²åŠŸèƒ½ï¼Œè¿”å›é»˜è®¤å€¼
    if (empty($detected_features)) {
        return ['Under Bed Storage'];
    }

    // å»é‡å¹¶è¿”å›
    return array_unique($detected_features);
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦æœ‰å‚¨ç‰©ç©ºé—´
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string Yes æˆ– No
 */
function get_product_has_storage($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å‚¨ç‰©ç©ºé—´å…³é”®è¯
    $storage_keywords = [
        // ç›´æ¥å‚¨ç‰©å…³é”®è¯
        'storage', 'store', 'storing', 'compartment', 'compartments',
        'drawer', 'drawers', 'pull-out drawer', 'pull out drawer',
        'cabinet', 'cabinets', 'cupboard', 'cupboards',
        'shelf', 'shelves', 'shelving', 'bookshelf', 'bookshelves',

        // åºŠä¸‹å‚¨ç‰©
        'under bed storage', 'underneath storage', 'storage under bed',
        'bed storage', 'storage bed', 'storage frame',
        'drawers underneath', 'built-in storage', 'integrated storage',
        'hidden storage', 'concealed storage', 'storage space',

        // å‚¨ç‰©ç®±/ç›’
        'storage box', 'storage boxes', 'storage bin', 'storage bins',
        'storage basket', 'storage baskets', 'storage container', 'storage containers',
        'storage chest', 'storage trunk', 'toy box', 'toy chest',

        // å‚¨ç‰©åŠŸèƒ½æè¿°
        'with storage', 'includes storage', 'featuring storage',
        'storage capacity', 'storage solution', 'storage options',
        'extra storage', 'additional storage', 'ample storage',
        'plenty of storage', 'lots of storage', 'spacious storage',

        // ç‰¹å®šå®¶å…·å‚¨ç‰©
        'ottoman with storage', 'bench with storage', 'coffee table with storage',
        'nightstand with drawer', 'bedside table with drawer',
        'dresser', 'chest of drawers', 'armoire', 'wardrobe',

        // å‚¨ç‰©ç›¸å…³åŠ¨è¯
        'organize', 'organizing', 'organization', 'tidy', 'tidying',
        'keep', 'keeping', 'hold', 'holding', 'contain', 'containing'
    ];

    // å®šä¹‰æ˜ç¡®ä¸åŒ…å«å‚¨ç‰©çš„å…³é”®è¯
    $no_storage_keywords = [
        'no storage', 'without storage', 'no drawers', 'no compartments',
        'no shelves', 'storage-free', 'minimal design', 'simple design',
        'basic model', 'standard model', 'no additional storage',
        'open design', 'open frame', 'platform only'
    ];

    // é¦–å…ˆæ£€æŸ¥æ˜ç¡®è¡¨ç¤ºæ²¡æœ‰å‚¨ç‰©çš„å…³é”®è¯
    foreach ($no_storage_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'No';
        }
    }

    // ç„¶åæ£€æŸ¥åŒ…å«å‚¨ç‰©çš„å…³é”®è¯
    foreach ($storage_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'Yes';
        }
    }

    // é»˜è®¤å€¼ï¼šNoï¼ˆå¤§å¤šæ•°äº§å“æ²¡æœ‰å‚¨ç‰©ç©ºé—´ï¼‰
    return 'No';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«æ‹–æ‹‰åºŠ
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string Yes æˆ– No
 */
function get_product_has_trundle($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰æ‹–æ‹‰åºŠå…³é”®è¯
    $trundle_keywords = [
        // ç›´æ¥æ‹–æ‹‰åºŠå…³é”®è¯
        'trundle', 'trundle bed', 'trundle frame',
        'pull-out bed', 'pull out bed', 'pullout bed',
        'roll-out bed', 'roll out bed', 'rollout bed',
        'slide-out bed', 'slide out bed', 'slideout bed',

        // æ‹–æ‹‰åºŠåŠŸèƒ½æè¿°
        'with trundle', 'includes trundle', 'featuring trundle',
        'trundle included', 'trundle attachment', 'trundle option',
        'additional bed', 'extra bed', 'guest bed',
        'second bed', 'twin bed underneath', 'bed underneath',

        // æ‹–æ‹‰åºŠç±»å‹
        'daybed with trundle', 'bunk bed with trundle',
        'captain bed with trundle', 'platform bed with trundle',
        'storage bed with trundle', 'loft bed with trundle',

        // æ‹–æ‹‰åºŠæœºåˆ¶
        'rolling bed', 'wheeled bed', 'caster bed',
        'under-bed pullout', 'under bed pullout', 'underneath pullout',
        'hidden bed', 'concealed bed', 'pop-up bed',

        // æ‹–æ‹‰åºŠç”¨é€”
        'sleepover', 'sleepovers', 'overnight guest', 'overnight guests',
        'guest accommodation', 'extra sleeping', 'additional sleeping',
        'space-saving bed', 'space saving bed', 'compact sleeping'
    ];

    // å®šä¹‰æ˜ç¡®ä¸åŒ…å«æ‹–æ‹‰åºŠçš„å…³é”®è¯
    $no_trundle_keywords = [
        'no trundle', 'without trundle', 'trundle-free',
        'single bed only', 'one bed only', 'standard bed',
        'basic bed', 'simple bed', 'no additional bed',
        'no pull-out', 'no pullout', 'no extra bed'
    ];

    // é¦–å…ˆæ£€æŸ¥æ˜ç¡®è¡¨ç¤ºæ²¡æœ‰æ‹–æ‹‰åºŠçš„å…³é”®è¯
    foreach ($no_trundle_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'No';
        }
    }

    // ç„¶åæ£€æŸ¥åŒ…å«æ‹–æ‹‰åºŠçš„å…³é”®è¯
    foreach ($trundle_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'Yes';
        }
    }

    // é»˜è®¤å€¼ï¼šNoï¼ˆå¤§å¤šæ•°åºŠä¸åŒ…å«æ‹–æ‹‰åºŠï¼‰
    return 'No';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«å®¶å±…è£…é¥°é£æ ¼
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array å®¶å±…è£…é¥°é£æ ¼æ•°ç»„
 */
function get_product_home_decor_style($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å®¶å±…è£…é¥°é£æ ¼å…³é”®è¯æ˜ å°„
    $style_keywords = [
        'Mid-Century' => [
            'mid-century', 'mid century', 'mcm', 'retro', '50s', '60s', 'atomic', 'danish modern',
            'eames', 'walnut', 'teak', 'hairpin legs', 'starburst', 'boomerang'
        ],
        'Tropical' => [
            'tropical', 'palm', 'bamboo', 'rattan', 'wicker', 'tiki', 'hawaiian', 'island',
            'coconut', 'pineapple', 'monstera', 'banana leaf', 'jungle', 'exotic'
        ],
        'Eclectic' => [
            'eclectic', 'mixed', 'bohemian chic', 'worldly', 'collected', 'curated',
            'vintage mix', 'global', 'artistic', 'unique', 'one-of-a-kind'
        ],
        'Glam' => [
            'glam', 'glamorous', 'hollywood', 'luxe', 'gold', 'silver', 'crystal', 'velvet',
            'mirrored', 'sequin', 'metallic', 'sparkle', 'elegant', 'opulent'
        ],
        'Cottage' => [
            'cottage', 'cozy', 'quaint', 'charming', 'country cottage', 'english cottage',
            'floral', 'gingham', 'vintage', 'romantic', 'pastoral'
        ],
        'Minimalist' => [
            'minimalist', 'minimal', 'simple', 'clean', 'sleek', 'modern minimal',
            'zen', 'uncluttered', 'streamlined', 'basic', 'essential', 'pure'
        ],
        'Transitional' => [
            'transitional', 'classic', 'timeless', 'neutral', 'balanced', 'refined',
            'sophisticated', 'versatile', 'understated', 'elegant'
        ],
        'Rustic/Lodge' => [
            'rustic', 'lodge', 'cabin', 'log', 'wood', 'natural', 'rough hewn',
            'distressed wood', 'barnwood', 'reclaimed', 'country', 'wilderness'
        ],
        'Scandinavian' => [
            'scandinavian', 'nordic', 'danish', 'swedish', 'norwegian', 'hygge',
            'light wood', 'white', 'cozy', 'functional', 'birch', 'pine'
        ],
        'Traditional' => [
            'traditional', 'classic', 'formal', 'elegant', 'mahogany', 'cherry',
            'ornate', 'detailed', 'rich', 'stately', 'heritage'
        ],
        'Victorian' => [
            'victorian', 'ornate', 'elaborate', 'antique', 'carved', 'detailed',
            'gothic', 'romantic', 'lace', 'velvet', 'dark wood'
        ],
        'Bohemian' => [
            'bohemian', 'boho', 'hippie', 'eclectic', 'colorful', 'patterned',
            'macrame', 'tapestry', 'ethnic', 'artistic', 'free-spirited'
        ],
        'Asian Inspired' => [
            'asian', 'zen', 'japanese', 'chinese', 'oriental', 'feng shui',
            'bamboo', 'meditation', 'peaceful', 'harmony', 'balance'
        ],
        'Farmhouse' => [
            'farmhouse', 'farm', 'barn', 'country', 'shiplap', 'mason jar',
            'galvanized', 'chicken wire', 'burlap', 'distressed', 'weathered'
        ],
        'Industrial' => [
            'industrial', 'loft', 'urban', 'metal', 'steel', 'iron', 'concrete',
            'exposed brick', 'pipe', 'warehouse', 'factory', 'raw'
        ],
        'French Country' => [
            'french country', 'french', 'provence', 'toile', 'shabby', 'distressed',
            'vintage french', 'rustic french', 'country french', 'pastoral'
        ],
        'Modern' => [
            'modern', 'contemporary modern', 'sleek', 'geometric', 'angular',
            'chrome', 'glass', 'steel', 'innovative', 'cutting-edge'
        ],
        'Contemporary' => [
            'contemporary', 'current', 'trendy', 'stylish', 'updated', 'fresh',
            'now', 'today', 'latest', 'fashionable'
        ],
        'Shabby Chic' => [
            'shabby chic', 'shabby', 'distressed', 'vintage', 'romantic', 'feminine',
            'pastel', 'roses', 'lace', 'weathered', 'chippy paint'
        ],
        'Coastal' => [
            'coastal', 'beach', 'nautical', 'seaside', 'ocean', 'marine', 'driftwood',
            'seashell', 'coral', 'blue', 'white', 'sandy', 'lighthouse'
        ],
        'Southwestern' => [
            'southwestern', 'southwest', 'desert', 'adobe', 'terracotta', 'cactus',
            'navajo', 'mexican', 'spanish', 'turquoise', 'rustic', 'earthy'
        ],
        'Art Deco' => [
            'art deco', 'deco', '1920s', '1930s', 'geometric', 'gold', 'black',
            'glamour', 'luxury', 'streamlined', 'stylized', 'ornamental'
        ]
    ];

    $detected_styles = [];

    // æ£€æŸ¥æ¯ä¸ªé£æ ¼çš„å…³é”®è¯
    foreach ($style_keywords as $style => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($content, $keyword) !== false) {
                $detected_styles[] = $style;
                break; // æ‰¾åˆ°ä¸€ä¸ªå…³é”®è¯å°±è·³å‡ºå†…å±‚å¾ªç¯
            }
        }
    }

    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•é£æ ¼ï¼Œè¿”å›é»˜è®¤å€¼
    if (empty($detected_styles)) {
        return ['Minimalist'];
    }

    // å»é‡å¹¶è¿”å›
    return array_unique($detected_styles);
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«æŠ½å±‰æ•°é‡
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return int æŠ½å±‰æ•°é‡
 */
function get_product_number_of_drawers($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰æ•°å­—åŒ¹é…æ¨¡å¼
    $number_patterns = [
        // ç›´æ¥æ•°å­— + drawer(s)
        '/(\d+)\s*drawer[s]?/',
        '/(\d+)[-\s]*drawer[s]?/',

        // æ–‡å­—æ•°å­— + drawer(s)
        '/one\s+drawer[s]?/' => 1,
        '/two\s+drawer[s]?/' => 2,
        '/three\s+drawer[s]?/' => 3,
        '/four\s+drawer[s]?/' => 4,
        '/five\s+drawer[s]?/' => 5,
        '/six\s+drawer[s]?/' => 6,
        '/seven\s+drawer[s]?/' => 7,
        '/eight\s+drawer[s]?/' => 8,
        '/nine\s+drawer[s]?/' => 9,
        '/ten\s+drawer[s]?/' => 10,

        // ç‰¹æ®Šæè¿°
        '/single\s+drawer/' => 1,
        '/double\s+drawer[s]?/' => 2,
        '/triple\s+drawer[s]?/' => 3,
        '/multiple\s+drawer[s]?/' => 2, // é»˜è®¤å¤šä¸ªä¸º2

        // ä¸­æ–‡æ•°å­—
        '/ä¸€ä¸ªæŠ½å±‰/' => 1,
        '/ä¸¤ä¸ªæŠ½å±‰/' => 2,
        '/ä¸‰ä¸ªæŠ½å±‰/' => 3,
        '/å››ä¸ªæŠ½å±‰/' => 4,
        '/äº”ä¸ªæŠ½å±‰/' => 5,
        '/å…­ä¸ªæŠ½å±‰/' => 6,
        '/ä¸ƒä¸ªæŠ½å±‰/' => 7,
        '/å…«ä¸ªæŠ½å±‰/' => 8,
        '/ä¹ä¸ªæŠ½å±‰/' => 9,
        '/åä¸ªæŠ½å±‰/' => 10
    ];

    // æ£€æŸ¥æ•°å­—æ¨¡å¼
    foreach ($number_patterns as $pattern => $default_value) {
        if (is_string($pattern)) {
            // æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
            if (preg_match($pattern, $content, $matches)) {
                if (isset($matches[1])) {
                    $number = intval($matches[1]);
                    return min($number, 100); // é™åˆ¶æœ€å¤§å€¼ä¸º100
                }
            }
        } else {
            // å›ºå®šå€¼æ¨¡å¼
            if (preg_match('/' . $pattern . '/', $content)) {
                return $default_value;
            }
        }
    }

    // æ£€æŸ¥æ˜¯å¦æåˆ°æŠ½å±‰ä½†æ²¡æœ‰å…·ä½“æ•°é‡
    if (preg_match('/drawer[s]?/', $content)) {
        return 1; // é»˜è®¤æœ‰æŠ½å±‰ä½†æ²¡è¯´æ•°é‡çš„æƒ…å†µä¸‹è¿”å›1
    }

    // é»˜è®¤å€¼ï¼š0ï¼ˆæ²¡æœ‰æŠ½å±‰ï¼‰
    return 0;
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨è¯†åˆ«ææ¿æ•°é‡
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return int ææ¿æ•°é‡
 */
function get_product_number_of_shelves($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰æ•°å­—åŒ¹é…æ¨¡å¼
    $number_patterns = [
        // ç›´æ¥æ•°å­— + shelf/shelves
        '/(\d+)\s*shelves?/',
        '/(\d+)[-\s]*shelves?/',
        '/(\d+)\s*tier[s]?/',
        '/(\d+)[-\s]*tier[s]?/',
        '/(\d+)\s*level[s]?/',
        '/(\d+)[-\s]*level[s]?/',

        // æ–‡å­—æ•°å­— + shelf/shelves
        '/one\s+shelf/' => 1,
        '/two\s+shelves?/' => 2,
        '/three\s+shelves?/' => 3,
        '/four\s+shelves?/' => 4,
        '/five\s+shelves?/' => 5,
        '/six\s+shelves?/' => 6,
        '/seven\s+shelves?/' => 7,
        '/eight\s+shelves?/' => 8,
        '/nine\s+shelves?/' => 9,
        '/ten\s+shelves?/' => 10,

        // å±‚çº§æè¿°
        '/single\s+shelf/' => 1,
        '/double\s+shelf/' => 2,
        '/triple\s+shelf/' => 3,
        '/multiple\s+shelves?/' => 3, // é»˜è®¤å¤šä¸ªä¸º3

        // ç‰¹æ®Šæè¿°
        '/2[-\s]*tier/' => 2,
        '/3[-\s]*tier/' => 3,
        '/4[-\s]*tier/' => 4,
        '/5[-\s]*tier/' => 5,

        // ä¸­æ–‡æ•°å­—
        '/ä¸€å±‚/' => 1,
        '/ä¸¤å±‚/' => 2,
        '/ä¸‰å±‚/' => 3,
        '/å››å±‚/' => 4,
        '/äº”å±‚/' => 5,
        '/å…­å±‚/' => 6,
        '/ä¸€ä¸ªææ¿/' => 1,
        '/ä¸¤ä¸ªææ¿/' => 2,
        '/ä¸‰ä¸ªææ¿/' => 3,
        '/å››ä¸ªææ¿/' => 4,
        '/äº”ä¸ªææ¿/' => 5
    ];

    // æ£€æŸ¥æ•°å­—æ¨¡å¼
    foreach ($number_patterns as $pattern => $default_value) {
        if (is_string($pattern)) {
            // æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
            if (preg_match($pattern, $content, $matches)) {
                if (isset($matches[1])) {
                    $number = intval($matches[1]);
                    return min($number, 100); // é™åˆ¶æœ€å¤§å€¼ä¸º100
                }
            }
        } else {
            // å›ºå®šå€¼æ¨¡å¼
            if (preg_match('/' . $pattern . '/', $content)) {
                return $default_value;
            }
        }
    }

    // æ£€æŸ¥æ˜¯å¦æåˆ°ææ¿ä½†æ²¡æœ‰å…·ä½“æ•°é‡
    if (preg_match('/shelf|shelves|tier|level|å±‚|ææ¿/', $content)) {
        return 2; // é»˜è®¤æœ‰ææ¿ä½†æ²¡è¯´æ•°é‡çš„æƒ…å†µä¸‹è¿”å›2
    }

    // é»˜è®¤å€¼ï¼š0ï¼ˆæ²¡æœ‰ææ¿ï¼‰
    return 0;
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«åŒ…å«çš„ç‰©å“æ¸…å•
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array åŒ…å«ç‰©å“çš„æ•°ç»„
 */
function get_product_items_included($product) {
    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å¸¸è§çš„åŒ…å«ç‰©å“å…³é”®è¯
    $item_keywords = [
        // å®¶å…·é…ä»¶
        'mattress' => 'Mattress',
        'pillow' => 'Pillow',
        'pillows' => 'Pillows',
        'headboard' => 'Headboard',
        'footboard' => 'Footboard',
        'side rails' => 'Side Rails',
        'guardrails' => 'Guardrails',
        'guard rails' => 'Guard Rails',
        'safety rails' => 'Safety Rails',
        'bed rails' => 'Bed Rails',
        'trundle' => 'Trundle',
        'trundle bed' => 'Trundle Bed',
        'ladder' => 'Ladder',
        'stairs' => 'Stairs',
        'staircase' => 'Staircase',

        // å‚¨ç‰©ç›¸å…³
        'storage' => 'Storage',
        'storage box' => 'Storage Box',
        'storage bins' => 'Storage Bins',
        'storage drawers' => 'Storage Drawers',
        'under bed storage' => 'Under Bed Storage',
        'hydraulic storage' => 'Hydraulic Storage System',
        'hydraulic storage system' => 'Hydraulic Storage System',
        'storage compartment' => 'Storage Compartment',
        'storage space' => 'Storage Space',

        // æŠ½å±‰å’Œææ¿
        'drawers' => 'Drawers',
        'drawer' => 'Drawer',
        'shelves' => 'Shelves',
        'shelf' => 'Shelf',
        'bookshelf' => 'Bookshelf',
        'nightstand' => 'Nightstand',

        // ç¡¬ä»¶å’Œé…ä»¶
        'hardware' => 'Hardware',
        'screws' => 'Screws',
        'bolts' => 'Bolts',
        'assembly hardware' => 'Assembly Hardware',
        'mounting hardware' => 'Mounting Hardware',
        'brackets' => 'Brackets',
        'hinges' => 'Hinges',
        'handles' => 'Handles',
        'knobs' => 'Knobs',
        'pulls' => 'Pulls',

        // å®‰å…¨é…ä»¶
        'wall anchor' => 'Wall Anchor',
        'wall anchors' => 'Wall Anchors',
        'anti-tip kit' => 'Anti-Tip Kit',
        'safety kit' => 'Safety Kit',
        'wall mounting kit' => 'Wall Mounting Kit',

        // ç”µå­äº§å“é…ä»¶
        'remote control' => 'Remote Control',
        'remote' => 'Remote',
        'power cord' => 'Power Cord',
        'power cable' => 'Power Cable',
        'usb cable' => 'USB Cable',
        'charging cable' => 'Charging Cable',
        'adapter' => 'Adapter',
        'charger' => 'Charger',
        'battery' => 'Battery',
        'batteries' => 'Batteries',
        'manual' => 'Manual',
        'instruction manual' => 'Instruction Manual',
        'user guide' => 'User Guide',

        // çººç»‡å“
        'cushion' => 'Cushion',
        'cushions' => 'Cushions',
        'cover' => 'Cover',
        'covers' => 'Covers',
        'fabric' => 'Fabric',
        'upholstery' => 'Upholstery',

        // å·¥å…·
        'tools' => 'Tools',
        'assembly tools' => 'Assembly Tools',
        'allen wrench' => 'Allen Wrench',
        'screwdriver' => 'Screwdriver',
        'wrench' => 'Wrench'
    ];

    $detected_items = [];

    // æ£€æŸ¥æ¯ä¸ªå…³é”®è¯
    foreach ($item_keywords as $keyword => $item_name) {
        if (strpos($content, $keyword) !== false) {
            $detected_items[] = $item_name;
        }
    }

    // æ£€æŸ¥"åŒ…å«"ã€"é™„å¸¦"ç­‰å…³é”®è¯åé¢çš„å†…å®¹
    $include_patterns = [
        '/includes?\s+([^.;,]+)/i',
        '/comes?\s+with\s+([^.;,]+)/i',
        '/åŒ…å«\s*([^ã€‚ï¼›ï¼Œ]+)/u',
        '/é™„å¸¦\s*([^ã€‚ï¼›ï¼Œ]+)/u',
        '/é…æœ‰\s*([^ã€‚ï¼›ï¼Œ]+)/u'
    ];

    foreach ($include_patterns as $pattern) {
        if (preg_match_all($pattern, $content, $matches)) {
            foreach ($matches[1] as $match) {
                $items = explode(' and ', trim($match));
                foreach ($items as $item) {
                    $item = trim($item);
                    if (strlen($item) > 2 && strlen($item) <= 200) {
                        $detected_items[] = ucwords($item);
                    }
                }
            }
        }
    }

    // æ£€æŸ¥äº§å“åç§°ä¸­çš„ä¸»è¦ç»„ä»¶
    $product_name = $product->get_name();
    $main_components = [];

    // ä»äº§å“åç§°æå–ä¸»è¦ç»„ä»¶
    if (preg_match('/(\d+[-\s]?piece|piece)/i', $product_name)) {
        // å¦‚æœæ˜¯å¥—è£…ï¼Œå°è¯•è¯†åˆ«ä¸»è¦ç»„ä»¶
        $main_components[] = $product_name;
    } else {
        // å•ä¸ªäº§å“ï¼Œä½¿ç”¨äº§å“åç§°ä½œä¸ºä¸»è¦ç»„ä»¶
        $main_components[] = $product_name;
    }

    // åˆå¹¶æ‰€æœ‰æ£€æµ‹åˆ°çš„ç‰©å“
    $all_items = array_merge($detected_items, $main_components);

    // å»é‡å¹¶æ¸…ç†
    $all_items = array_unique($all_items);
    $cleaned_items = [];

    foreach ($all_items as $item) {
        $item = trim($item);
        if (strlen($item) >= 1 && strlen($item) <= 200) {
            $cleaned_items[] = $item;
        }
    }

    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•ç‰©å“ï¼Œè¿”å›äº§å“åç§°
    if (empty($cleaned_items)) {
        $cleaned_items[] = $product->get_name();
    }

    return $cleaned_items;
}

/**
 * ä»äº§å“å±æ€§Product Sizeä¸­æå–å°ºå¯¸å€¼
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @param string $dimension å°ºå¯¸ç±»å‹ï¼š'length', 'width', 'height'
 * @return array åŒ…å«measureå’Œunitçš„æ•°ç»„
 */
function get_product_dimension($product, $dimension) {
    // ä»äº§å“å±æ€§ä¸­è·å–Product Size
    $product_size = get_product_attribute_value($product, 'Product Size', '');

    if (empty($product_size)) {
        // å¦‚æœæ²¡æœ‰Product Sizeå±æ€§ï¼Œè¿”å›é»˜è®¤å€¼1 in
        return [
            'measure' => 1,
            'unit' => 'in'
        ];
    }

    // è§£æProduct Sizeå­—ç¬¦ä¸²
    $dimensions = parse_product_size($product_size);

    // æ ¹æ®è¯·æ±‚çš„å°ºå¯¸ç±»å‹è¿”å›å¯¹åº”å€¼
    switch ($dimension) {
        case 'length':
            return [
                'measure' => $dimensions['length'],
                'unit' => $dimensions['unit']
            ];
        case 'width':
            return [
                'measure' => $dimensions['width'],
                'unit' => $dimensions['unit']
            ];
        case 'height':
            return [
                'measure' => $dimensions['height'],
                'unit' => $dimensions['unit']
            ];
        default:
            return [
                'measure' => 1,
                'unit' => 'in'
            ];
    }
}

/**
 * è§£æProduct Sizeå­—ç¬¦ä¸²
 *
 * @param string $size_string å°ºå¯¸å­—ç¬¦ä¸²ï¼Œå¦‚"54.00 in Ã— 23.00 in Ã— 31.50 in"
 * @return array åŒ…å«length, width, height, unitçš„æ•°ç»„
 */
function parse_product_size($size_string) {
    // é»˜è®¤å€¼
    $default = [
        'length' => 1,
        'width' => 1,
        'height' => 1,
        'unit' => 'in'
    ];

    if (empty($size_string)) {
        return $default;
    }

    // æ¸…ç†å­—ç¬¦ä¸²ï¼Œç§»é™¤å¤šä½™ç©ºæ ¼
    $size_string = trim($size_string);

    // æå–å•ä½ï¼ˆæŸ¥æ‰¾å¸¸è§å•ä½ï¼‰
    $unit = 'in'; // é»˜è®¤å•ä½
    if (preg_match('/\b(in|inch|inches|cm|mm|ft|feet)\b/i', $size_string, $unit_matches)) {
        $unit = strtolower($unit_matches[1]);
        // æ ‡å‡†åŒ–å•ä½
        if (in_array($unit, ['inch', 'inches'])) {
            $unit = 'in';
        } elseif (in_array($unit, ['feet', 'ft'])) {
            $unit = 'ft';
        }
    }

    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ•°å­—
    // æ”¯æŒå¤šç§æ ¼å¼ï¼š
    // 76.50 in Ã— 40.50 in Ã— 71.00 in
    // 76.50 Ã— 40.50 Ã— 71.00 in
    // 76.50Ã—40.50Ã—71.00

    // å…ˆç§»é™¤æ‰€æœ‰å•ä½ï¼Œåªä¿ç•™æ•°å­—å’Œåˆ†éš”ç¬¦
    $cleaned = preg_replace('/\s*(in|inch|inches|cm|mm|ft|feet)\s*/i', ' ', $size_string);
    $cleaned = trim($cleaned);

    // æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šÃ—, x, X, *, ç©ºæ ¼ç­‰
    $pattern = '/(\d+(?:\.\d+)?)\s*[Ã—xX*\s]+\s*(\d+(?:\.\d+)?)\s*[Ã—xX*\s]+\s*(\d+(?:\.\d+)?)/';

    if (preg_match($pattern, $cleaned, $matches)) {
        return [
            'length' => (float)$matches[1],
            'width' => (float)$matches[2],
            'height' => (float)$matches[3],
            'unit' => $unit
        ];
    }

    // å¦‚æœæ— æ³•è§£æï¼Œè¿”å›é»˜è®¤å€¼
    return $default;
}

/**
 * ä»äº§å“å±æ€§Product Weightä¸­æå–é‡é‡å€¼
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array åŒ…å«measureå’Œunitçš„æ•°ç»„
 */
function get_product_weight($product) {
    // ä»äº§å“å±æ€§ä¸­è·å–Product Weight
    $product_weight = get_product_attribute_value($product, 'Product Weight', '');

    if (empty($product_weight)) {
        // å¦‚æœæ²¡æœ‰Product Weightå±æ€§ï¼Œè¿”å›é»˜è®¤å€¼1 lb
        return [
            'measure' => 1,
            'unit' => 'lb'
        ];
    }

    // è§£æé‡é‡å­—ç¬¦ä¸²ï¼Œæå–æ•°å­—éƒ¨åˆ†
    $weight_value = parse_weight_value($product_weight);

    return [
        'measure' => $weight_value,
        'unit' => 'lb'
    ];
}

/**
 * è§£æé‡é‡å­—ç¬¦ä¸²ï¼Œæå–æ•°å­—å€¼
 *
 * @param string $weight_string é‡é‡å­—ç¬¦ä¸²ï¼Œå¦‚"33.00 lb"æˆ–"33"
 * @return float é‡é‡æ•°å€¼
 */
function parse_weight_value($weight_string) {
    if (empty($weight_string)) {
        return 1.0;
    }

    // æ¸…ç†å­—ç¬¦ä¸²
    $weight_string = trim($weight_string);

    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ•°å­—ï¼ˆåŒ…æ‹¬å°æ•°ï¼‰
    if (preg_match('/(\d+(?:\.\d+)?)/', $weight_string, $matches)) {
        return (float)$matches[1];
    }

    // å¦‚æœæ— æ³•è§£æï¼Œè¿”å›é»˜è®¤å€¼
    return 1.0;
}

/**
 * è·å–äº§å“é™„åŠ å›¾ç‰‡URLæ•°ç»„
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array å›¾ç‰‡URLæ•°ç»„
 */
function get_product_secondary_images($product) {
    $secondary_images = [];

    // è·å–äº§å“å›¾åº“å›¾ç‰‡ID
    $gallery_image_ids = $product->get_gallery_image_ids();

    if (empty($gallery_image_ids)) {
        // å¦‚æœæ²¡æœ‰å›¾åº“å›¾ç‰‡ï¼Œè¿”å›ç©ºæ•°ç»„
        return $secondary_images;
    }

    foreach ($gallery_image_ids as $image_id) {
        $image_url = get_product_image_url($image_id);
        if (!empty($image_url)) {
            $secondary_images[] = $image_url;
        }
    }

    return $secondary_images;
}

/**
 * è·å–äº§å“å›¾ç‰‡URLï¼ˆæ”¯æŒè¿œç¨‹URLå’Œæœ¬åœ°å›¾ç‰‡ï¼‰
 *
 * @param mixed $image_id å›¾ç‰‡IDæˆ–è¿œç¨‹URL
 * @return string å›¾ç‰‡URL
 */
function get_product_image_url($image_id) {
    if (empty($image_id)) {
        return '';
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯è¿œç¨‹URLï¼ˆä»¥remote_å¼€å¤´çš„å­—ç¬¦ä¸²ï¼‰
    if (is_string($image_id) && strpos($image_id, 'remote_') === 0) {
        // æå–è¿œç¨‹URL
        $remote_url = substr($image_id, 7); // ç§»é™¤'remote_'å‰ç¼€

        // éªŒè¯è¿œç¨‹URLæ˜¯å¦å¯è®¿é—®
        if (is_valid_remote_image_url($remote_url)) {
            return $remote_url;
        }
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ•°å­—ID
    if (is_numeric($image_id) && $image_id > 0) {
        // è·å–æœ¬åœ°å›¾ç‰‡URL
        $local_url = wp_get_attachment_image_url($image_id, 'full');
        if ($local_url) {
            return $local_url;
        }
    }

    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ä¸”çœ‹èµ·æ¥åƒURLï¼Œç›´æ¥è¿”å›
    if (is_string($image_id) && (strpos($image_id, 'http://') === 0 || strpos($image_id, 'https://') === 0)) {
        return $image_id;
    }

    return '';
}

/**
 * éªŒè¯è¿œç¨‹å›¾ç‰‡URLæ˜¯å¦å¯è®¿é—®
 *
 * @param string $url è¿œç¨‹å›¾ç‰‡URL
 * @return bool æ˜¯å¦å¯è®¿é—®
 */
function is_valid_remote_image_url($url) {
    if (empty($url) || !filter_var($url, FILTER_VALIDATE_URL)) {
        return false;
    }

    // ç®€å•çš„URLæ ¼å¼æ£€æŸ¥
    $allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
    $extension = strtolower(pathinfo(parse_url($url, PHP_URL_PATH), PATHINFO_EXTENSION));

    return in_array($extension, $allowed_extensions);
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ€å¤§æ‰¿é‡
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array åŒ…å«measureå’Œunitçš„æ•°ç»„
 */
function get_product_maximum_load_weight($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $load_weight_attr = get_product_attribute_value($product, 'maximumLoadWeight', '');
    if (!empty($load_weight_attr)) {
        $parsed = parse_weight_value($load_weight_attr);
        if ($parsed > 0) {
            return [
                'measure' => $parsed,
                'unit' => 'lb'
            ];
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰é‡é‡åŒ¹é…æ¨¡å¼
    $weight_patterns = [
        // ç›´æ¥æ•°å­— + é‡é‡å•ä½
        '/(\d+(?:\.\d+)?)\s*(?:lb|lbs|pound|pounds)\s*(?:capacity|weight\s*capacity|load\s*capacity|max\s*load|maximum\s*load|weight\s*limit|load\s*limit)/i',
        '/(?:capacity|weight\s*capacity|load\s*capacity|max\s*load|maximum\s*load|weight\s*limit|load\s*limit)[\s:]*(\d+(?:\.\d+)?)\s*(?:lb|lbs|pound|pounds)/i',
        '/(?:holds?|supports?|carries?)\s*(?:up\s*to\s*)?(\d+(?:\.\d+)?)\s*(?:lb|lbs|pound|pounds)/i',
        '/(\d+(?:\.\d+)?)\s*(?:lb|lbs|pound|pounds)\s*(?:capacity|load|weight)/i',

        // ç›å¸å•ä½
        '/(\d+(?:\.\d+)?)\s*(?:oz|ounce|ounces)\s*(?:capacity|weight\s*capacity|load\s*capacity|max\s*load|maximum\s*load)/i',
        '/(?:capacity|weight\s*capacity|load\s*capacity|max\s*load|maximum\s*load)[\s:]*(\d+(?:\.\d+)?)\s*(?:oz|ounce|ounces)/i',
        '/(?:holds?|supports?|carries?)\s*(?:up\s*to\s*)?(\d+(?:\.\d+)?)\s*(?:oz|ounce|ounces)/i',

        // å…¬åˆ¶å•ä½ï¼ˆéœ€è¦è½¬æ¢ï¼‰
        '/(\d+(?:\.\d+)?)\s*(?:kg|kilogram|kilograms)\s*(?:capacity|weight\s*capacity|load\s*capacity|max\s*load|maximum\s*load)/i',
        '/(?:capacity|weight\s*capacity|load\s*capacity|max\s*load|maximum\s*load)[\s:]*(\d+(?:\.\d+)?)\s*(?:kg|kilogram|kilograms)/i',
        '/(?:holds?|supports?|carries?)\s*(?:up\s*to\s*)?(\d+(?:\.\d+)?)\s*(?:kg|kilogram|kilograms)/i',

        // ä¸­æ–‡æ¨¡å¼
        '/(\d+(?:\.\d+)?)\s*(?:ç£…|lb)\s*(?:æ‰¿é‡|è½½é‡|è´Ÿé‡|å®¹é‡)/u',
        '/(?:æ‰¿é‡|è½½é‡|è´Ÿé‡|å®¹é‡)[\s:]*(\d+(?:\.\d+)?)\s*(?:ç£…|lb)/u',
        '/(?:æœ€å¤§|æœ€é«˜)(?:æ‰¿é‡|è½½é‡|è´Ÿé‡)[\s:]*(\d+(?:\.\d+)?)\s*(?:ç£…|lb)/u'
    ];

    // æ£€æŸ¥é‡é‡æ¨¡å¼
    foreach ($weight_patterns as $pattern) {
        if (preg_match($pattern, $content, $matches)) {
            $weight_value = floatval($matches[1]);

            if ($weight_value > 0) {
                // ç¡®å®šå•ä½
                $unit = 'lb'; // é»˜è®¤å•ä½

                if (stripos($pattern, 'oz|ounce') !== false) {
                    $unit = 'oz';
                } elseif (stripos($pattern, 'kg|kilogram') !== false) {
                    // å°†å…¬æ–¤è½¬æ¢ä¸ºç£… (1 kg = 2.20462 lb)
                    $weight_value = $weight_value * 2.20462;
                    $unit = 'lb';
                }

                // é™åˆ¶æœ€å¤§å€¼å’Œç²¾åº¦
                $weight_value = min($weight_value, 10000000000000000);
                $weight_value = round($weight_value, 3);

                return [
                    'measure' => $weight_value,
                    'unit' => $unit
                ];
            }
        }
    }

    // æ£€æŸ¥å¸¸è§çš„æ‰¿é‡å…³é”®è¯ï¼ˆæ²¡æœ‰å…·ä½“æ•°å­—çš„æƒ…å†µï¼‰
    $capacity_keywords = [
        'heavy duty' => 500,
        'heavy-duty' => 500,
        'industrial strength' => 1000,
        'commercial grade' => 750,
        'professional grade' => 600,
        'extra strong' => 300,
        'reinforced' => 250,
        'sturdy' => 200,
        'durable' => 150,
        'lightweight' => 50
    ];

    foreach ($capacity_keywords as $keyword => $estimated_weight) {
        if (strpos($content, $keyword) !== false) {
            return [
                'measure' => $estimated_weight,
                'unit' => 'lb'
            ];
        }
    }

    // æ ¹æ®äº§å“ç±»å‹æ¨æ–­æ‰¿é‡
    $product_type_weights = [
        'bed' => 500,
        'bunk bed' => 400,
        'chair' => 250,
        'desk' => 200,
        'table' => 300,
        'shelf' => 100,
        'bookshelf' => 150,
        'dresser' => 200,
        'cabinet' => 250,
        'tv stand' => 200,
        'mount' => 100,
        'rack' => 150,
        'stool' => 200,
        'bench' => 300
    ];

    foreach ($product_type_weights as $type => $weight) {
        if (strpos($content, $type) !== false) {
            return [
                'measure' => $weight,
                'unit' => 'lb'
            ];
        }
    }

    // é»˜è®¤å€¼ï¼š1 lb
    return [
        'measure' => 1,
        'unit' => 'lb'
    ];
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ˜¯å¦æœ‰è½¯å«è¦†ç›–
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string Yesæˆ–No
 */
function get_product_upholstered($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $upholstered_attr = get_product_attribute_value($product, 'upholstered', '');
    if (!empty($upholstered_attr)) {
        $normalized = strtolower(trim($upholstered_attr));
        if (in_array($normalized, ['yes', 'y', '1', 'true', 'upholstered'])) {
            return 'Yes';
        } elseif (in_array($normalized, ['no', 'n', '0', 'false', 'not upholstered'])) {
            return 'No';
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰è½¯å«è¦†ç›–çš„å…³é”®è¯ï¼ˆè¡¨ç¤ºYesï¼‰
    $upholstered_keywords = [
        // ç›´æ¥æè¿°
        'upholstered',
        'upholstery',
        'padded',
        'cushioned',
        'fabric covered',
        'fabric-covered',
        'soft padded',
        'foam padded',
        'memory foam',

        // é¢æ–™ç±»å‹
        'velvet',
        'linen',
        'cotton',
        'polyester',
        'microfiber',
        'faux leather',
        'genuine leather',
        'leather upholstery',
        'fabric upholstery',
        'suede',
        'corduroy',
        'chenille',
        'jacquard',
        'boucle',

        // è½¯å«ç‰¹å¾
        'tufted',
        'button tufted',
        'diamond tufted',
        'quilted',
        'plush',
        'soft seat',
        'soft back',
        'cushion seat',
        'cushion back',
        'padded seat',
        'padded back',
        'padded arms',
        'padded armrests',

        // å®¶å…·ç±»å‹ï¼ˆé€šå¸¸æœ‰è½¯å«ï¼‰
        'armchair',
        'recliner',
        'loveseat',
        'sectional',
        'ottoman',
        'chaise lounge',
        'accent chair',
        'dining chair with cushion',
        'office chair',
        'swivel chair',
        'rocking chair',
        'glider',
        'wingback chair',

        // åºŠç±»è½¯å«
        'headboard upholstered',
        'upholstered headboard',
        'padded headboard',
        'fabric headboard',
        'tufted headboard',

        // ä¸­æ–‡å…³é”®è¯
        'è½¯å«',
        'å¸ƒè‰º',
        'é¢æ–™',
        'æµ·ç»µ',
        'å¡«å……',
        'è½¯åŒ…',
        'åŒ…å¸ƒ'
    ];

    // æ£€æŸ¥è½¯å«å…³é”®è¯
    foreach ($upholstered_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'Yes';
        }
    }

    // å®šä¹‰éè½¯å«å…³é”®è¯ï¼ˆè¡¨ç¤ºNoï¼‰
    $non_upholstered_keywords = [
        // æè´¨ç±»å‹
        'wood',
        'wooden',
        'solid wood',
        'hardwood',
        'oak',
        'pine',
        'maple',
        'cherry',
        'walnut',
        'bamboo',
        'metal',
        'steel',
        'iron',
        'aluminum',
        'plastic',
        'resin',
        'wicker',
        'rattan',
        'glass',
        'marble',
        'stone',
        'concrete',

        // è¡¨é¢å¤„ç†
        'painted',
        'stained',
        'lacquered',
        'varnished',
        'polished',
        'brushed',
        'powder coated',
        'chrome',
        'brass',

        // å®¶å…·ç±»å‹ï¼ˆé€šå¸¸æ— è½¯å«ï¼‰
        'dining table',
        'coffee table',
        'side table',
        'end table',
        'console table',
        'desk',
        'bookshelf',
        'bookcase',
        'dresser',
        'nightstand',
        'wardrobe',
        'cabinet',
        'shelf',
        'rack',
        'stand',
        'stool' // å¤§å¤šæ•°å‡³å­æ— è½¯å«
    ];

    // æ£€æŸ¥éè½¯å«å…³é”®è¯
    foreach ($non_upholstered_keywords as $keyword) {
        if (strpos($content, $keyword) !== false) {
            return 'No';
        }
    }

    // ç‰¹æ®Šè§„åˆ™ï¼šå¦‚æœæ˜¯æ¤…å­ä½†æ²¡æœ‰æ˜ç¡®çš„è½¯å«å…³é”®è¯ï¼Œè¿›ä¸€æ­¥æ£€æŸ¥
    if (strpos($content, 'chair') !== false) {
        // å¦‚æœæåˆ°æ¤…å­ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è½¯å«ç›¸å…³æè¿°
        $chair_upholstery_indicators = [
            'cushion',
            'padded',
            'soft',
            'comfortable',
            'plush',
            'fabric',
            'leather',
            'upholstered'
        ];

        foreach ($chair_upholstery_indicators as $indicator) {
            if (strpos($content, $indicator) !== false) {
                return 'Yes';
            }
        }

        // å¦‚æœæ˜¯æ¤…å­ä½†æ²¡æœ‰è½¯å«æŒ‡ç¤ºè¯ï¼Œå¯èƒ½æ˜¯ç¡¬æ¤…å­
        return 'No';
    }

    // ç‰¹æ®Šè§„åˆ™ï¼šå¦‚æœæ˜¯åºŠï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è½¯å«åºŠå¤´æ¿
    if (strpos($content, 'bed') !== false) {
        $bed_upholstery_indicators = [
            'upholstered headboard',
            'padded headboard',
            'fabric headboard',
            'tufted headboard',
            'soft headboard'
        ];

        foreach ($bed_upholstery_indicators as $indicator) {
            if (strpos($content, $indicator) !== false) {
                return 'Yes';
            }
        }

        // å¤§å¤šæ•°åºŠæ¶æœ¬èº«ä¸ç®—è½¯å«å®¶å…·
        return 'No';
    }

    // é»˜è®¤å€¼ï¼šNoï¼ˆå¤§å¤šæ•°å®¶å…·ä¸æ˜¯è½¯å«å®¶å…·ï¼‰
    return 'No';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ¨æç±»å‹
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array|string æœ¨æç±»å‹æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
 */
function get_product_wood_type($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $wood_type_attr = get_product_attribute_value($product, 'wood_type', '');
    if (!empty($wood_type_attr)) {
        // è§£æå±æ€§å€¼ï¼Œå¯èƒ½åŒ…å«å¤šä¸ªæœ¨æç±»å‹
        $parsed_types = parse_wood_types($wood_type_attr);
        if (!empty($parsed_types)) {
            return $parsed_types;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å…è®¸çš„æœ¨æç±»å‹ï¼ˆæŒ‰APIè§„èŒƒï¼‰
    $allowed_wood_types = [
        'fir' => 'Fir',
        'hickory' => 'Hickory',
        'elm' => 'Elm',
        'cherry' => 'Cherry',
        'mahogany' => 'Mahogany',
        'oak' => 'Oak',
        'alder' => 'Alder',
        'pine' => 'Pine',
        'walnut' => 'Walnut',
        'teak' => 'Teak',
        'rubberwood' => 'Rubberwood',
        'cedar' => 'Cedar',
        'birch' => 'Birch',
        'beech' => 'Beech',
        'poplar' => 'Poplar',
        'bamboo' => 'Bamboo',
        'ash' => 'Ash',
        'acacia' => 'Acacia',
        'rosewood' => 'Rosewood',
        'maple' => 'Maple'
    ];

    // å®šä¹‰æœ¨æç±»å‹çš„å˜ä½“å’Œåˆ«å
    $wood_type_variants = [
        // Oak variants
        'red oak' => 'Oak',
        'white oak' => 'Oak',
        'oak wood' => 'Oak',
        'solid oak' => 'Oak',

        // Pine variants
        'pine wood' => 'Pine',
        'solid pine' => 'Pine',
        'white pine' => 'Pine',
        'yellow pine' => 'Pine',

        // Maple variants
        'maple wood' => 'Maple',
        'solid maple' => 'Maple',
        'hard maple' => 'Maple',
        'soft maple' => 'Maple',

        // Cherry variants
        'cherry wood' => 'Cherry',
        'solid cherry' => 'Cherry',
        'black cherry' => 'Cherry',

        // Walnut variants
        'walnut wood' => 'Walnut',
        'solid walnut' => 'Walnut',
        'black walnut' => 'Walnut',

        // Mahogany variants
        'mahogany wood' => 'Mahogany',
        'solid mahogany' => 'Mahogany',

        // Teak variants
        'teak wood' => 'Teak',
        'solid teak' => 'Teak',

        // Cedar variants
        'cedar wood' => 'Cedar',
        'solid cedar' => 'Cedar',
        'red cedar' => 'Cedar',

        // Birch variants
        'birch wood' => 'Birch',
        'solid birch' => 'Birch',
        'yellow birch' => 'Birch',

        // Ash variants
        'ash wood' => 'Ash',
        'solid ash' => 'Ash',
        'white ash' => 'Ash',

        // Acacia variants
        'acacia wood' => 'Acacia',
        'solid acacia' => 'Acacia',

        // Bamboo variants
        'bamboo wood' => 'Bamboo',
        'solid bamboo' => 'Bamboo',

        // Other variants
        'rubberwood' => 'Rubberwood',
        'rubber wood' => 'Rubberwood',
        'rosewood' => 'Rosewood',
        'rose wood' => 'Rosewood',
        'poplar wood' => 'Poplar',
        'solid poplar' => 'Poplar',
        'beech wood' => 'Beech',
        'solid beech' => 'Beech',
        'alder wood' => 'Alder',
        'solid alder' => 'Alder',
        'elm wood' => 'Elm',
        'solid elm' => 'Elm',
        'fir wood' => 'Fir',
        'solid fir' => 'Fir',
        'hickory wood' => 'Hickory',
        'solid hickory' => 'Hickory'
    ];

    $detected_wood_types = [];

    // é¦–å…ˆæ£€æŸ¥å˜ä½“å’Œåˆ«åï¼ˆæ›´å…·ä½“çš„åŒ¹é…ï¼‰
    foreach ($wood_type_variants as $variant => $standard_type) {
        if (strpos($content, $variant) !== false) {
            if (!in_array($standard_type, $detected_wood_types)) {
                $detected_wood_types[] = $standard_type;
            }
        }
    }

    // ç„¶åæ£€æŸ¥åŸºæœ¬æœ¨æç±»å‹
    foreach ($allowed_wood_types as $wood_key => $wood_value) {
        if (strpos($content, $wood_key) !== false) {
            if (!in_array($wood_value, $detected_wood_types)) {
                $detected_wood_types[] = $wood_value;
            }
        }
    }

    // ç‰¹æ®Šæ¨¡å¼åŒ¹é…
    $wood_patterns = [
        '/(\w+)\s+wood/i',
        '/solid\s+(\w+)/i',
        '/(\w+)\s+timber/i',
        '/(\w+)\s+lumber/i'
    ];

    foreach ($wood_patterns as $pattern) {
        if (preg_match_all($pattern, $content, $matches)) {
            foreach ($matches[1] as $match) {
                $wood_key = strtolower(trim($match));
                if (isset($allowed_wood_types[$wood_key])) {
                    $wood_value = $allowed_wood_types[$wood_key];
                    if (!in_array($wood_value, $detected_wood_types)) {
                        $detected_wood_types[] = $wood_value;
                    }
                }
            }
        }
    }

    // ä¸­æ–‡æœ¨æç±»å‹è¯†åˆ«
    $chinese_wood_types = [
        'æ©¡æœ¨' => 'Oak',
        'æ¾æœ¨' => 'Pine',
        'æ«æœ¨' => 'Maple',
        'æ¨±æ¡ƒæœ¨' => 'Cherry',
        'èƒ¡æ¡ƒæœ¨' => 'Walnut',
        'æ¡ƒèŠ±å¿ƒæœ¨' => 'Mahogany',
        'æŸšæœ¨' => 'Teak',
        'é›ªæ¾' => 'Cedar',
        'æ¡¦æœ¨' => 'Birch',
        'ç™½èœ¡æœ¨' => 'Ash',
        'ç›¸æ€æœ¨' => 'Acacia',
        'ç«¹å­' => 'Bamboo',
        'ç«¹æœ¨' => 'Bamboo'
    ];

    foreach ($chinese_wood_types as $chinese => $english) {
        if (strpos($content, $chinese) !== false) {
            if (!in_array($english, $detected_wood_types)) {
                $detected_wood_types[] = $english;
            }
        }
    }

    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æœ¨æç±»å‹ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆä¸åŒæ­¥æ­¤å­—æ®µï¼‰
    if (empty($detected_wood_types)) {
        return '';
    }

    // è¿”å›æ£€æµ‹åˆ°çš„æœ¨æç±»å‹æ•°ç»„
    return $detected_wood_types;
}

/**
 * è§£ææœ¨æç±»å‹å­—ç¬¦ä¸²
 *
 * @param string $wood_type_string æœ¨æç±»å‹å­—ç¬¦ä¸²
 * @return array è§£æåçš„æœ¨æç±»å‹æ•°ç»„
 */
function parse_wood_types($wood_type_string) {
    $allowed_types = ['Fir', 'Hickory', 'Elm', 'Cherry', 'Mahogany', 'Oak', 'Alder', 'Pine', 'Walnut', 'Teak', 'Rubberwood', 'Cedar', 'Birch', 'Beech', 'Poplar', 'Bamboo', 'Ash', 'Acacia', 'Rosewood', 'Maple'];

    $parsed_types = [];

    // åˆ†å‰²å­—ç¬¦ä¸²ï¼ˆæ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼‰
    $separators = [',', ';', '|', '/', '&', ' and ', ' + '];
    $types = [$wood_type_string];

    foreach ($separators as $separator) {
        $new_types = [];
        foreach ($types as $type) {
            $split = explode($separator, $type);
            $new_types = array_merge($new_types, $split);
        }
        $types = $new_types;
    }

    // æ¸…ç†å’ŒéªŒè¯æ¯ä¸ªç±»å‹
    foreach ($types as $type) {
        $type = trim($type);
        $type = ucfirst(strtolower($type));

        if (in_array($type, $allowed_types)) {
            if (!in_array($type, $parsed_types)) {
                $parsed_types[] = $type;
            }
        }
    }

    return $parsed_types;
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æœ¨æè‰²è°ƒ
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string æœ¨æè‰²è°ƒï¼Œå¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
 */
function get_product_wood_tone($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $wood_tone_attr = get_product_attribute_value($product, 'wood_tone', '');
    if (!empty($wood_tone_attr)) {
        $normalized_tone = normalize_wood_tone($wood_tone_attr);
        if (!empty($normalized_tone)) {
            return $normalized_tone;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å…è®¸çš„æœ¨æè‰²è°ƒï¼ˆæŒ‰APIè§„èŒƒï¼‰
    $allowed_wood_tones = [
        'Red Wood',
        'White Wood',
        'Gray Wood',
        'Medium Wood',
        'Espresso Wood',
        'Light Wood'
    ];

    // å®šä¹‰æœ¨æè‰²è°ƒå…³é”®è¯æ˜ å°„
    $wood_tone_keywords = [
        // Red Wood å…³é”®è¯
        'Red Wood' => [
            'red wood', 'red oak', 'cherry wood', 'cherry', 'mahogany', 'rosewood',
            'red stain', 'red finish', 'burgundy', 'crimson', 'auburn',
            'çº¢æœ¨', 'æ¨±æ¡ƒæœ¨', 'çº¢æ©¡æœ¨', 'æ¡ƒèŠ±å¿ƒæœ¨'
        ],

        // White Wood å…³é”®è¯
        'White Wood' => [
            'white wood', 'white oak', 'white pine', 'birch', 'maple', 'ash',
            'white stain', 'white finish', 'whitewash', 'bleached', 'ivory',
            'cream', 'off-white', 'antique white', 'snow white',
            'ç™½æœ¨', 'ç™½æ©¡æœ¨', 'ç™½æ¾æœ¨', 'æ¡¦æœ¨', 'æ«æœ¨'
        ],

        // Gray Wood å…³é”®è¯
        'Gray Wood' => [
            'gray wood', 'grey wood', 'gray stain', 'grey stain', 'gray finish', 'grey finish',
            'weathered', 'driftwood', 'charcoal', 'slate', 'pewter', 'silver',
            'storm gray', 'storm grey', 'ash gray', 'ash grey',
            'ç°æœ¨', 'ç°è‰²æœ¨æ', 'é£åŒ–æœ¨'
        ],

        // Medium Wood å…³é”®è¯
        'Medium Wood' => [
            'medium wood', 'medium tone', 'medium stain', 'medium finish',
            'natural wood', 'natural finish', 'honey', 'amber', 'golden',
            'warm wood', 'medium brown', 'caramel', 'toffee',
            'ä¸­ç­‰è‰²è°ƒ', 'å¤©ç„¶æœ¨è‰²', 'èœ‚èœœè‰²'
        ],

        // Espresso Wood å…³é”®è¯
        'Espresso Wood' => [
            'espresso', 'espresso wood', 'espresso stain', 'espresso finish',
            'dark wood', 'dark brown', 'chocolate', 'coffee', 'mocha',
            'walnut', 'dark walnut', 'ebony', 'black wood', 'dark stain',
            'æ·±è‰²æœ¨æ', 'èƒ¡æ¡ƒæœ¨', 'æ·±æ£•è‰²', 'å’–å•¡è‰²'
        ],

        // Light Wood å…³é”®è¯
        'Light Wood' => [
            'light wood', 'light stain', 'light finish', 'light tone',
            'blonde', 'blonde wood', 'pine', 'fir', 'cedar', 'poplar',
            'natural pine', 'light oak', 'beech', 'light brown',
            'vanilla', 'wheat', 'sand', 'buff',
            'æµ…è‰²æœ¨æ', 'æ¾æœ¨', 'æ‰æœ¨', 'æµ…æ©¡æœ¨'
        ]
    ];

    // æ£€æŸ¥æ¯ä¸ªè‰²è°ƒçš„å…³é”®è¯
    foreach ($wood_tone_keywords as $tone => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($content, $keyword) !== false) {
                return $tone;
            }
        }
    }

    // åŸºäºæœ¨æç±»å‹æ¨æ–­è‰²è°ƒ
    $wood_type_to_tone_mapping = [
        'cherry' => 'Red Wood',
        'mahogany' => 'Red Wood',
        'rosewood' => 'Red Wood',
        'red oak' => 'Red Wood',

        'maple' => 'White Wood',
        'birch' => 'White Wood',
        'ash' => 'White Wood',
        'white oak' => 'White Wood',

        'walnut' => 'Espresso Wood',
        'black walnut' => 'Espresso Wood',
        'ebony' => 'Espresso Wood',

        'pine' => 'Light Wood',
        'fir' => 'Light Wood',
        'cedar' => 'Light Wood',
        'poplar' => 'Light Wood',
        'beech' => 'Light Wood',

        'oak' => 'Medium Wood',
        'teak' => 'Medium Wood',
        'acacia' => 'Medium Wood',
        'hickory' => 'Medium Wood'
    ];

    foreach ($wood_type_to_tone_mapping as $wood_type => $tone) {
        if (strpos($content, $wood_type) !== false) {
            return $tone;
        }
    }

    // åŸºäºé¢œè‰²å…³é”®è¯æ¨æ–­
    $color_to_tone_mapping = [
        'dark' => 'Espresso Wood',
        'black' => 'Espresso Wood',
        'brown' => 'Medium Wood',
        'light' => 'Light Wood',
        'white' => 'White Wood',
        'gray' => 'Gray Wood',
        'grey' => 'Gray Wood',
        'red' => 'Red Wood'
    ];

    // æ£€æŸ¥é¢œè‰²å…³é”®è¯ï¼ˆéœ€è¦ä¸woodç›¸å…³ï¼‰
    foreach ($color_to_tone_mapping as $color => $tone) {
        if (strpos($content, $color) !== false &&
            (strpos($content, 'wood') !== false ||
             strpos($content, 'finish') !== false ||
             strpos($content, 'stain') !== false)) {
            return $tone;
        }
    }

    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æœ¨æè‰²è°ƒï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆä¸åŒæ­¥æ­¤å­—æ®µï¼‰
    return '';
}

/**
 * æ ‡å‡†åŒ–æœ¨æè‰²è°ƒå€¼
 *
 * @param string $tone_string æœ¨æè‰²è°ƒå­—ç¬¦ä¸²
 * @return string æ ‡å‡†åŒ–åçš„æœ¨æè‰²è°ƒ
 */
function normalize_wood_tone($tone_string) {
    $allowed_tones = ['Red Wood', 'White Wood', 'Gray Wood', 'Medium Wood', 'Espresso Wood', 'Light Wood'];

    $tone_string = trim($tone_string);

    // ç›´æ¥åŒ¹é…
    if (in_array($tone_string, $allowed_tones)) {
        return $tone_string;
    }

    // ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
    foreach ($allowed_tones as $allowed_tone) {
        if (strcasecmp($tone_string, $allowed_tone) === 0) {
            return $allowed_tone;
        }
    }

    // éƒ¨åˆ†åŒ¹é…
    $tone_lower = strtolower($tone_string);

    if (strpos($tone_lower, 'red') !== false) {
        return 'Red Wood';
    } elseif (strpos($tone_lower, 'white') !== false) {
        return 'White Wood';
    } elseif (strpos($tone_lower, 'gray') !== false || strpos($tone_lower, 'grey') !== false) {
        return 'Gray Wood';
    } elseif (strpos($tone_lower, 'espresso') !== false || strpos($tone_lower, 'dark') !== false) {
        return 'Espresso Wood';
    } elseif (strpos($tone_lower, 'light') !== false) {
        return 'Light Wood';
    } elseif (strpos($tone_lower, 'medium') !== false || strpos($tone_lower, 'natural') !== false) {
        return 'Medium Wood';
    }

    return '';
}

/**
 * ç”Ÿæˆäº§å“æ ‡è¯†ç¬¦å¯¹è±¡ï¼ˆ5.0ç‰ˆæœ¬ï¼‰
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array äº§å“æ ‡è¯†ç¬¦å¯¹è±¡
 */
function generate_product_identifiers($product) {
    // è·å–äº§å“çš„UPCç 
    $upc = get_product_upc_code($product);

    // å¦‚æœUPCä¸ºç©ºï¼ˆUPCæ± ç”¨å°½ï¼‰ï¼Œè¿”å›ç©ºå€¼
    if (empty($upc)) {
        return '';
    }

    return [
        'productIdType' => 'UPC',
        'productId' => $upc
    ];
}

/**
 * è·å–äº§å“UPCç¼–ç ï¼ˆ5.0ç‰ˆæœ¬ï¼‰
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string UPCç¼–ç 
 */
function get_product_upc_code($product) {
    $product_id = $product->get_id();

    // é¦–å…ˆæ£€æŸ¥äº§å“æ˜¯å¦å·²æœ‰UPC
    $existing_upc = get_post_meta($product_id, '_walmart_upc', true);
    if (!empty($existing_upc)) {
        return $existing_upc;
    }

    // å¦‚æœæ²¡æœ‰UPCï¼Œä»UPCæ± åˆ†é…ä¸€ä¸ª
    global $wpdb;
    $upc_table = $wpdb->prefix . 'walmart_upc_pool';

    // è·å–ç¬¬ä¸€ä¸ªæœªä½¿ç”¨çš„UPC
    $available_upc = $wpdb->get_row($wpdb->prepare("SELECT id, upc_code FROM $upc_table WHERE is_used = 0 LIMIT 1"));

    if (!$available_upc) {
        // å¦‚æœUPCæ± å·²ç”¨å°½ï¼Œè®°å½•é”™è¯¯å¹¶è¿”å›ç©ºå€¼
        woo_walmart_sync_log('UPCåˆ†é…', 'é”™è¯¯', [
            'product_id' => $product_id,
            'message' => 'UPCæ± å·²ç”¨å°½ï¼Œæ— æ³•ä¸ºäº§å“åˆ†é…UPC'
        ], 'UPCæ± å·²ç”¨å°½ï¼Œè¯·åœ¨UPCæ± ç®¡ç†é¡µé¢è¡¥å……æ–°çš„UPCç ');

        return ''; // è¿”å›ç©ºå€¼ï¼Œä¸ä½¿ç”¨é»˜è®¤UPC
    }

    // æ ‡è®°UPCä¸ºå·²ä½¿ç”¨
    $wpdb->update(
        $upc_table,
        [
            'is_used' => 1,
            'product_id' => $product_id,
            'used_at' => current_time('mysql'),
        ],
        ['id' => $available_upc->id]
    );

    // ä¿å­˜UPCåˆ°äº§å“meta
    update_post_meta($product_id, '_walmart_upc', $available_upc->upc_code);

    woo_walmart_sync_log('UPCåˆ†é…', 'æˆåŠŸ', [
        'product_id' => $product_id,
        'upc_code' => $available_upc->upc_code,
        'upc_pool_id' => $available_upc->id
    ], "æˆåŠŸä¸ºäº§å“åˆ†é…UPC: {$available_upc->upc_code}");

    return $available_upc->upc_code;
}



/**
 * è·å–äº§å“å±æ€§å€¼çš„é€šç”¨å‡½æ•°
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @param string $attribute_name å±æ€§åç§°
 * @param string $default_value é»˜è®¤å€¼
 * @return string å±æ€§å€¼
 */
function get_product_attribute_value($product, $attribute_name, $default_value = '') {
    // ä¼˜å…ˆçº§é¡ºåºï¼šç²¾ç¡®åŒ¹é… > å˜ä½“åŒ¹é…ï¼Œå¦‚æœæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…å°±ç«‹å³è¿”å›

    // ä¼˜å…ˆçº§1: ç²¾ç¡®åŒ¹é… - ç›´æ¥ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„å±æ€§å
    $value = $product->get_attribute($attribute_name);
    if (!empty($value)) {
        return $value;
    }

    // ä¼˜å…ˆçº§2: å¸¸è§å˜ä½“åŒ¹é…ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    $priority_variants = [
        $attribute_name,                                    // åŸå§‹åç§°
        str_replace('_', ' ', $attribute_name),            // ä¸‹åˆ’çº¿è½¬ç©ºæ ¼ (bed_size -> bed size)
        str_replace('-', ' ', $attribute_name),            // è¿å­—ç¬¦è½¬ç©ºæ ¼ (bed-size -> bed size)
        ucwords(str_replace(['_', '-'], ' ', $attribute_name)), // æ ‡é¢˜æ ¼å¼ (bed_size -> Bed Size)
        strtolower($attribute_name),                       // å°å†™
        str_replace(' ', '_', $attribute_name),            // ç©ºæ ¼è½¬ä¸‹åˆ’çº¿ (bed size -> bed_size)
        str_replace(' ', '-', $attribute_name),            // ç©ºæ ¼è½¬è¿å­—ç¬¦ (bed size -> bed-size)
        str_replace('_', '-', $attribute_name),            // ä¸‹åˆ’çº¿è½¬è¿å­—ç¬¦
        str_replace('-', '_', $attribute_name),            // è¿å­—ç¬¦è½¬ä¸‹åˆ’çº¿
        ucfirst(strtolower($attribute_name)),              // é¦–å­—æ¯å¤§å†™
    ];

    // ç§»é™¤é‡å¤é¡¹ï¼Œä¿æŒé¡ºåº
    $priority_variants = array_values(array_unique($priority_variants));

    // æŒ‰ä¼˜å…ˆçº§å°è¯•æ¯ä¸ªå˜ä½“ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå°±è¿”å›
    foreach ($priority_variants as $variant) {
        if ($variant === $attribute_name) {
            continue; // å·²ç»åœ¨ä¼˜å…ˆçº§1ä¸­å°è¯•è¿‡äº†
        }

        $value = $product->get_attribute($variant);
        if (!empty($value)) {
            return $value; // æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„å€¼å°±ç«‹å³è¿”å›
        }
    }

    // ä¼˜å…ˆçº§3: ä»å±æ€§æ•°ç»„ä¸­æ‰‹åŠ¨æŸ¥æ‰¾ï¼ˆç”¨äºå¤„ç†åˆ†ç±»æ³•å±æ€§ï¼‰
    $attributes = $product->get_attributes();
    foreach ($attributes as $attribute) {
        $attr_name = $attribute->get_name();

        // æ£€æŸ¥æ˜¯å¦ä¸ä»»ä½•ä¼˜å…ˆçº§å˜ä½“åŒ¹é…
        foreach ($priority_variants as $target_variant) {
            if (strcasecmp($attr_name, $target_variant) === 0 ||
                strcasecmp(str_replace('pa_', '', $attr_name), $target_variant) === 0) {

                if ($attribute->is_taxonomy()) {
                    $terms = wp_get_post_terms($product->get_id(), $attribute->get_name());
                    if (!is_wp_error($terms) && !empty($terms)) {
                        return $terms[0]->name; // è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ†ç±»é¡¹
                    }
                } else {
                    $options = $attribute->get_options();
                    if (!empty($options)) {
                        return $options[0]; // è¿”å›ç¬¬ä¸€ä¸ªé€‰é¡¹
                    }
                }
            }
        }
    }

    return $default_value;
}

/**
 * è·å–äº§å“é¢œè‰²ä¿¡æ¯
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string é¢œè‰²å€¼
 */
function get_product_color($product) {
    // ä¼˜å…ˆä»äº§å“å±æ€§ä¸­è·å–Main Color
    $color = get_product_attribute_value($product, 'Main Color', '');
    if (!empty($color)) {
        return $color;
    }

    // å°è¯•å…¶ä»–é¢œè‰²å±æ€§å
    $color_attributes = ['color', 'colour', 'main_color', 'é¢œè‰²', 'ä¸»è‰²'];
    foreach ($color_attributes as $attr_name) {
        $color = get_product_attribute_value($product, $attr_name, '');
        if (!empty($color)) {
            return $color;
        }
    }

    // ä»æ ‡é¢˜å’Œæè¿°ä¸­æå–é¢œè‰²
    $title = $product->get_name();
    $description = $product->get_description() . ' ' . $product->get_short_description();
    $content = strtolower($title . ' ' . $description);

    $colors = [
        'black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple',
        'pink', 'brown', 'gray', 'grey', 'silver', 'gold', 'bronze', 'beige'
    ];

    foreach ($colors as $color) {
        if (strpos($content, $color) !== false) {
            return ucfirst($color);
        }
    }

    return ''; // æ— æ³•æå–åˆ™ç•™ç©º
}

/**
 * å°†é¢œè‰²æ˜ å°„åˆ°é¢œè‰²åˆ†ç±»
 *
 * @param string $color é¢œè‰²å€¼
 * @return string é¢œè‰²åˆ†ç±»
 */
function map_color_to_category($color) {
    if (empty($color)) {
        return '';
    }

    $color_lower = strtolower($color);

    // é¢œè‰²æ˜ å°„è¡¨
    $color_mapping = [
        'blue' => 'Blue',
        'navy' => 'Blue',
        'royal' => 'Blue',
        'brown' => 'Brown',
        'tan' => 'Brown',
        'chocolate' => 'Brown',
        'gold' => 'Gold',
        'golden' => 'Gold',
        'gray' => 'Gray',
        'grey' => 'Gray',
        'silver' => 'Gray',
        'purple' => 'Purple',
        'violet' => 'Purple',
        'clear' => 'Clear',
        'transparent' => 'Clear',
        'yellow' => 'Yellow',
        'cream' => 'Off-White',
        'ivory' => 'Off-White',
        'off-white' => 'Off-White',
        'black' => 'Black',
        'beige' => 'Beige',
        'pink' => 'Pink',
        'rose' => 'Pink',
        'orange' => 'Orange',
        'green' => 'Green',
        'white' => 'White',
        'red' => 'Red',
        'bronze' => 'Bronze'
    ];

    foreach ($color_mapping as $key => $category) {
        if (strpos($color_lower, $key) !== false) {
            return $category;
        }
    }

    return 'Multicolor'; // é»˜è®¤å€¼
}

/**
 * ä¸ºæ²ƒå°”ç›ç¼–ç SKUï¼ˆå¤„ç†ä¸­æ–‡å­—ç¬¦ï¼‰
 *
 * @param string $sku åŸå§‹SKU
 * @return string ç¼–ç åçš„SKU
 */
function encode_sku_for_walmart($sku) {
    if (empty($sku)) {
        return '';
    }

    // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
    if (preg_match('/[\x{4e00}-\x{9fff}]/u', $sku)) {
        // åŒ…å«ä¸­æ–‡ï¼Œè¿›è¡Œç¼–ç 
        return 'SKU_' . md5($sku);
    }

    // ä¸åŒ…å«ä¸­æ–‡ï¼Œç›´æ¥è¿”å›
    return $sku;
}

/**
 * è·å–äº§å“è¿è¾“é‡é‡
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string è¿è¾“é‡é‡
 */
function get_product_shipping_weight($product) {
    // ä¼˜å…ˆä»äº§å“å±æ€§ä¸­è·å–Package Weight
    $weight = get_product_attribute_value($product, 'Package Weight', '');
    if (!empty($weight)) {
        // æå–æ•°å­—éƒ¨åˆ†
        if (preg_match('/(\d+(?:\.\d+)?)/', $weight, $matches)) {
            return $matches[1];
        }
    }

    // ä½¿ç”¨äº§å“é‡é‡
    $product_weight = $product->get_weight();
    if (!empty($product_weight)) {
        return $product_weight;
    }

    return '1'; // é»˜è®¤å€¼
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«äº§å“è½®å»“ç±»å‹
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string äº§å“è½®å»“ç±»å‹
 */
function get_product_profile($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $profile_attr = get_product_attribute_value($product, 'profile', '');
    if (!empty($profile_attr)) {
        $normalized_profile = normalize_profile($profile_attr);
        if (!empty($normalized_profile)) {
            return $normalized_profile;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰è½®å»“ç±»å‹å…³é”®è¯æ˜ å°„
    $profile_keywords = [
        // Low Profile å…³é”®è¯
        'Low Profile' => [
            'low profile', 'low-profile', 'slim profile', 'thin profile', 'compact profile',
            'space saving', 'space-saving', 'minimal profile', 'sleek profile', 'streamlined',
            'ultra-thin', 'ultra thin', 'shallow', 'flat profile', 'minimalist',
            'low height', 'reduced height', 'compact design', 'slim design', 'thin design'
        ],

        // High Profile å…³é”®è¯
        'High Profile' => [
            'high profile', 'high-profile', 'tall profile', 'elevated profile', 'raised profile',
            'deep profile', 'thick profile', 'full profile', 'extended profile', 'prominent',
            'substantial', 'oversized', 'extra tall', 'extra-tall', 'high rise', 'high-rise',
            'towering', 'bold profile', 'dramatic profile', 'statement piece', 'commanding presence'
        ],

        // Standard Profile å…³é”®è¯
        'Standard Profile' => [
            'standard profile', 'standard-profile', 'regular profile', 'normal profile',
            'classic profile', 'traditional profile', 'conventional', 'standard height',
            'regular height', 'normal height', 'medium profile', 'balanced profile'
        ]
    ];

    // æ£€æŸ¥æ¯ä¸ªè½®å»“ç±»å‹çš„å…³é”®è¯
    foreach ($profile_keywords as $profile => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($content, $keyword) !== false) {
                return $profile;
            }
        }
    }

    // åŸºäºäº§å“ç±»å‹æ¨æ–­è½®å»“
    $product_type_mapping = [
        // Low Profile äº§å“ç±»å‹
        'tv mount' => 'Low Profile',
        'wall mount' => 'Low Profile',
        'flat panel' => 'Low Profile',
        'space saver' => 'Low Profile',

        // High Profile äº§å“ç±»å‹
        'tower' => 'High Profile',
        'cabinet' => 'High Profile',
        'armoire' => 'High Profile',
        'bookcase' => 'High Profile',
        'entertainment center' => 'High Profile',
        'tall dresser' => 'High Profile',
        'chest of drawers' => 'High Profile',
        'wardrobe' => 'High Profile'
    ];

    foreach ($product_type_mapping as $product_type => $profile) {
        if (strpos($content, $product_type) !== false) {
            return $profile;
        }
    }

    // åŸºäºå°ºå¯¸å…³é”®è¯æ¨æ–­
    if (strpos($content, 'thin') !== false || strpos($content, 'slim') !== false ||
        strpos($content, 'flat') !== false || strpos($content, 'compact') !== false) {
        return 'Low Profile';
    }

    if (strpos($content, 'tall') !== false || strpos($content, 'high') !== false ||
        strpos($content, 'deep') !== false || strpos($content, 'oversized') !== false) {
        return 'High Profile';
    }

    // åŸºäºåŠŸèƒ½ç‰¹å¾æ¨æ–­
    if (strpos($content, 'wall mounted') !== false || strpos($content, 'wall-mounted') !== false) {
        return 'Low Profile';
    }

    if (strpos($content, 'floor standing') !== false || strpos($content, 'freestanding') !== false) {
        return 'High Profile';
    }

    // é»˜è®¤å€¼ï¼šStandard Profile
    return 'Standard Profile';
}

/**
 * æ ‡å‡†åŒ–è½®å»“ç±»å‹å€¼
 *
 * @param string $profile_string è½®å»“ç±»å‹å­—ç¬¦ä¸²
 * @return string æ ‡å‡†åŒ–åçš„è½®å»“ç±»å‹
 */
function normalize_profile($profile_string) {
    $allowed_profiles = ['Standard Profile', 'Low Profile', 'High Profile'];

    $profile_string = trim($profile_string);

    // ç›´æ¥åŒ¹é…
    if (in_array($profile_string, $allowed_profiles)) {
        return $profile_string;
    }

    // ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
    foreach ($allowed_profiles as $allowed_profile) {
        if (strcasecmp($profile_string, $allowed_profile) === 0) {
            return $allowed_profile;
        }
    }

    // éƒ¨åˆ†åŒ¹é…
    $profile_lower = strtolower($profile_string);

    if (strpos($profile_lower, 'low') !== false) {
        return 'Low Profile';
    } elseif (strpos($profile_lower, 'high') !== false) {
        return 'High Profile';
    } elseif (strpos($profile_lower, 'standard') !== false ||
              strpos($profile_lower, 'regular') !== false ||
              strpos($profile_lower, 'normal') !== false) {
        return 'Standard Profile';
    }

    return 'Standard Profile'; // é»˜è®¤å€¼
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«äº§å“ä¸»é¢˜
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string äº§å“ä¸»é¢˜
 */
function get_product_theme($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $theme_attr = get_product_attribute_value($product, 'theme', '');
    if (!empty($theme_attr)) {
        // éªŒè¯ä¸»é¢˜é•¿åº¦ï¼ˆAPIè¦æ±‚1-800å­—ç¬¦ï¼‰
        $theme_attr = trim($theme_attr);
        if (strlen($theme_attr) >= 1 && strlen($theme_attr) <= 800) {
            return $theme_attr;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰ä¸»é¢˜å…³é”®è¯æ˜ å°„ï¼ˆä¼˜åŒ–ç²¾ç¡®åŒ¹é…ï¼‰
    $theme_keywords = [
        // åœ°ç†/åœ°ç‚¹ä¸»é¢˜
        'Beach' => [
            'beach', 'seaside', 'coastal', 'ocean view', 'surf', 'sand dune', 'seashell',
            'nautical', 'marine', 'wave', 'shore', 'beachside', 'oceanfront',
            'æµ·æ»©', 'æµ·è¾¹', 'æ²™æ»©', 'æµ·æ´‹'
        ],

        'Hawaiian' => [
            'hawaiian', 'tropical paradise', 'palm tree', 'island', 'aloha', 'tiki', 'luau',
            'paradise', 'coconut palm', 'pineapple', 'hibiscus', 'lei',
            'å¤å¨å¤·', 'çƒ­å¸¦', 'æ¤°å­', 'è è'
        ],

        'Desert' => [
            'desert', 'cactus', 'sand dune', 'oasis', 'southwestern', 'adobe',
            'mesa', 'canyon', 'sage brush', 'tumble weed', 'arid',
            'æ²™æ¼ ', 'ä»™äººæŒ', 'è¥¿å—é£'
        ],

        'Jungle' => [
            'jungle', 'safari', 'rainforest', 'wild life', 'bamboo forest',
            'vine', 'canopy', 'expedition', 'adventure', 'explorer',
            'ä¸›æ—', 'çƒ­å¸¦é›¨æ—', 'é‡ç”Ÿ', 'æ¢é™©'
        ],

        // é£æ ¼ä¸»é¢˜
        'Retro' => [
            'retro', 'vintage', 'classic style', 'old-fashioned', 'antique', 'nostalgic',
            'mid-century', 'throwback', 'old school', 'heritage',
            'å¤å¤', 'æ€€æ—§', 'ç»å…¸', 'ä¼ ç»Ÿ'
        ],

        'Hollywood' => [
            'hollywood', 'movie star', 'cinema', 'glamour', 'celebrity',
            'red carpet', 'spotlight', 'premiere', 'oscar', 'film star',
            'å¥½è±å', 'ç”µå½±', 'æ˜æ˜Ÿ', 'é­…åŠ›'
        ],

        // æƒ…æ„Ÿ/æ¦‚å¿µä¸»é¢˜
        'Love' => [
            'love', 'heart shape', 'romantic', 'valentine', 'couple', 'romance',
            'affection', 'passion', 'sweetheart', 'beloved', 'adore',
            'çˆ±æƒ…', 'æµªæ¼«', 'æƒ…äººèŠ‚', 'å¿ƒå½¢'
        ],

        'Be Kind' => [
            'be kind', 'kindness', 'compassion', 'caring', 'gentle', 'thoughtful',
            'considerate', 'empathy', 'goodness', 'benevolent', 'charitable',
            'å–„è‰¯', 'ä»æ…ˆ', 'å…³çˆ±', 'æ¸©æŸ”'
        ],

        'Religious' => [
            'religious', 'faith', 'church', 'cross', 'spiritual', 'holy',
            'sacred', 'divine', 'prayer', 'blessing', 'worship', 'christian',
            'å®—æ•™', 'ä¿¡ä»°', 'ç¥åœ£', 'ç¥ˆç¥·'
        ],

        'Magic' => [
            'magic', 'wizard', 'enchanted', 'mystical',
            'spell', 'potion', 'magic wand', 'crystal ball', 'supernatural', 'fantasy magic',
            'é­”æ³•', 'ç¥å¥‡', 'å·«å¸ˆ'
        ],

        // è§’è‰²/ç”Ÿç‰©ä¸»é¢˜
        'Animal' => [
            'animal', 'pet', 'dog', 'cat', 'bird', 'wildlife', 'zoo',
            'farm animal', 'forest animal', 'creature', 'paw print', 'fur', 'feather',
            'åŠ¨ç‰©', 'å® ç‰©', 'ç‹—', 'çŒ«', 'é¸Ÿ', 'é‡ç”ŸåŠ¨ç‰©'
        ],

        'Princesses' => [
            'princess', 'royal', 'crown', 'castle', 'fairy tale', 'tiara',
            'kingdom', 'palace', 'throne', 'regal', 'noble', 'duchess',
            'å…¬ä¸»', 'çš‡å®¤', 'ç‹å† ', 'åŸå ¡', 'ç«¥è¯'
        ],

        'Unicorns' => [
            'unicorn', 'rainbow', 'fantasy', 'mythical', 'unicorn horn',
            'mane', 'sparkle', 'glitter', 'enchanted unicorn',
            'ç‹¬è§’å…½', 'å½©è™¹', 'å¹»æƒ³', 'ç¥è¯'
        ],

        // ç¯å¢ƒä¸»é¢˜
        'Space' => [
            'space', 'galaxy', 'planet', 'astronaut', 'cosmic',
            'universe', 'rocket', 'moon', 'solar system', 'nebula', 'orbit',
            'å¤ªç©º', 'æ˜Ÿç³»', 'æ˜Ÿçƒ', 'å®‡èˆªå‘˜', 'å®‡å®™'
        ],

        'Carnival' => [
            'carnival', 'circus', 'festival', 'celebration', 'parade',
            'ferris wheel', 'carousel', 'clown', 'tent', 'festive', 'party',
            'å˜‰å¹´å', 'é©¬æˆå›¢', 'èŠ‚æ—¥', 'åº†å…¸'
        ]
    ];

    // æ£€æŸ¥æ¯ä¸ªä¸»é¢˜çš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…å’Œæ’é™¤é€»è¾‘ï¼‰
    foreach ($theme_keywords as $theme => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                // ç‰¹æ®Šæ’é™¤é€»è¾‘ï¼Œé¿å…è¯¯åŒ¹é…
                if ($theme === 'Hollywood' && $keyword === 'star' &&
                    (strpos($content, 'space') !== false || strpos($content, 'galaxy') !== false)) {
                    continue; // è·³è¿‡ space/galaxy ä¸Šä¸‹æ–‡ä¸­çš„ "star"
                }

                if ($theme === 'Magic' && $keyword === 'fairy' &&
                    strpos($content, 'fairy tale') !== false) {
                    continue; // è·³è¿‡ fairy tale ä¸Šä¸‹æ–‡ä¸­çš„ "fairy"ï¼Œä¼˜å…ˆ Princesses
                }

                if ($theme === 'Carnival' && $keyword === 'fair' &&
                    strpos($content, 'fairy') !== false) {
                    continue; // è·³è¿‡åŒ…å« fairy çš„ä¸Šä¸‹æ–‡ä¸­çš„ "fair"
                }

                return $theme;
            }
        }
    }

    // åŸºäºäº§å“ç±»å‹æ¨æ–­ä¸»é¢˜
    $product_type_to_theme_mapping = [
        // åŠ¨ç‰©ç›¸å…³äº§å“
        'pet' => 'Animal',
        'dog bed' => 'Animal',
        'cat tree' => 'Animal',
        'bird cage' => 'Animal',
        'fish tank' => 'Animal',

        // å„¿ç«¥ç›¸å…³äº§å“
        'kids' => 'Multi-theme',
        'children' => 'Multi-theme',
        'baby' => 'Multi-theme',

        // æˆ·å¤–ç›¸å…³äº§å“
        'outdoor' => 'Multi-theme',
        'patio' => 'Multi-theme',
        'garden' => 'Multi-theme'
    ];

    foreach ($product_type_to_theme_mapping as $product_type => $theme) {
        if (strpos($content, $product_type) !== false) {
            return $theme;
        }
    }

    // åŸºäºé¢œè‰²æ¨æ–­å¯èƒ½çš„ä¸»é¢˜
    $color_to_theme_hints = [
        'rainbow' => 'Unicorns',
        'pink' => 'Princesses',
        'gold' => 'Hollywood',
        'silver' => 'Hollywood'
    ];

    foreach ($color_to_theme_hints as $color => $theme) {
        if (strpos($content, $color) !== false) {
            // éœ€è¦ç»“åˆå…¶ä»–å…³é”®è¯ç¡®è®¤
            $theme_keywords_for_color = $theme_keywords[$theme] ?? [];
            foreach ($theme_keywords_for_color as $keyword) {
                if (strpos($content, $keyword) !== false) {
                    return $theme;
                }
            }
        }
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªä¸»é¢˜å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…å’Œæ’é™¤é€»è¾‘ï¼‰
    $detected_themes = [];
    foreach ($theme_keywords as $theme => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                // åº”ç”¨ç›¸åŒçš„æ’é™¤é€»è¾‘
                if ($theme === 'Hollywood' && $keyword === 'star' &&
                    (strpos($content, 'space') !== false || strpos($content, 'galaxy') !== false)) {
                    continue;
                }

                if ($theme === 'Magic' && $keyword === 'fairy' &&
                    strpos($content, 'fairy tale') !== false) {
                    continue;
                }

                if ($theme === 'Carnival' && $keyword === 'fair' &&
                    strpos($content, 'fairy') !== false) {
                    continue;
                }

                if (!in_array($theme, $detected_themes)) {
                    $detected_themes[] = $theme;
                }
                break; // æ‰¾åˆ°ä¸€ä¸ªå°±å¤Ÿäº†
            }
        }
    }

    // å¦‚æœæ£€æµ‹åˆ°å¤šä¸ªä¸»é¢˜ï¼Œè¿”å›ç»„åˆæˆ–Multi-theme
    if (count($detected_themes) > 1) {
        // å¦‚æœä¸»é¢˜æ•°é‡è¾ƒå°‘ï¼Œå¯ä»¥ç»„åˆ
        if (count($detected_themes) <= 3) {
            $combined_theme = implode(';', $detected_themes);
            // æ£€æŸ¥é•¿åº¦é™åˆ¶
            if (strlen($combined_theme) <= 800) {
                return $combined_theme;
            }
        }
        return 'Multi-theme';
    }

    // é»˜è®¤å€¼ï¼šMulti-theme
    return 'Multi-theme';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ‰¶æ‰‹é£æ ¼
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string æ‰¶æ‰‹é£æ ¼
 */
function get_product_arm_style($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $arm_style_attr = get_product_attribute_value($product, 'arm_style', '');
    if (!empty($arm_style_attr)) {
        $normalized_style = normalize_arm_style($arm_style_attr);
        if (!empty($normalized_style)) {
            return $normalized_style;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å…è®¸çš„æ‰¶æ‰‹é£æ ¼ï¼ˆæŒ‰APIè§„èŒƒï¼‰
    $allowed_arm_styles = [
        'Flared Arms',
        'Round Arms',
        'Recessed Arms',
        'Armless',
        'Square Arms'
    ];

    // å®šä¹‰æ‰¶æ‰‹é£æ ¼å…³é”®è¯æ˜ å°„ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    $arm_style_keywords = [
        // Flared Arms - å¤–å±•æ‰¶æ‰‹
        'Flared Arms' => [
            'flared arms', 'flared arm', 'flare arms', 'flare arm',
            'curved outward arms', 'outward curved arms', 'wing arms',
            'angled outward arms', 'splayed arms', 'wide arms',
            'å¤–å±•æ‰¶æ‰‹', 'å¼ å¼€æ‰¶æ‰‹', 'å¼¯æ›²æ‰¶æ‰‹'
        ],

        // Round Arms - åœ†å½¢æ‰¶æ‰‹
        'Round Arms' => [
            'round arms', 'round arm', 'rounded arms', 'rounded arm',
            'circular arms', 'curved arms', 'soft arms', 'pillow arms',
            'roll arms', 'rolled arms', 'cushioned arms',
            'åœ†å½¢æ‰¶æ‰‹', 'åœ†å¼§æ‰¶æ‰‹', 'è½¯åŒ…æ‰¶æ‰‹'
        ],

        // Recessed Arms - å†…å‡¹æ‰¶æ‰‹
        'Recessed Arms' => [
            'recessed arms', 'recessed arm', 'inset arms', 'inset arm',
            'sunken arms', 'low arms', 'set back arms', 'narrow arms',
            'slim arms', 'minimal arms', 'sleek arms',
            'å†…å‡¹æ‰¶æ‰‹', 'ä½æ‰¶æ‰‹', 'çª„æ‰¶æ‰‹'
        ],

        // Square Arms - æ–¹å½¢æ‰¶æ‰‹
        'Square Arms' => [
            'square arms', 'square arm', 'straight arms', 'straight arm',
            'angular arms', 'block arms', 'geometric arms', 'modern arms',
            'clean line arms', 'sharp arms', 'boxy arms',
            'æ–¹å½¢æ‰¶æ‰‹', 'ç›´çº¿æ‰¶æ‰‹', 'å‡ ä½•æ‰¶æ‰‹'
        ],

        // Armless - æ— æ‰¶æ‰‹ï¼ˆæœ€åæ£€æŸ¥ï¼Œå› ä¸ºæ˜¯é»˜è®¤å€¼ï¼‰
        'Armless' => [
            'armless', 'no arms', 'without arms', 'no armrests',
            'without armrests', 'open sides', 'side-less',
            'æ— æ‰¶æ‰‹', 'æ²¡æœ‰æ‰¶æ‰‹', 'å¼€æ”¾å¼'
        ]
    ];

    // æ£€æŸ¥æ¯ä¸ªæ‰¶æ‰‹é£æ ¼çš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼‰
    foreach ($arm_style_keywords as $style => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                return $style;
            }
        }
    }

    // åŸºäºäº§å“ç±»å‹æ¨æ–­æ‰¶æ‰‹é£æ ¼
    $product_type_to_arm_style_mapping = [
        // é€šå¸¸æœ‰æ‰¶æ‰‹çš„å®¶å…·ç±»å‹
        'sofa' => 'Round Arms',
        'couch' => 'Round Arms',
        'sectional' => 'Round Arms',
        'recliner' => 'Round Arms',
        'armchair' => 'Round Arms',
        'lounge chair' => 'Round Arms',
        'accent chair' => 'Square Arms',
        'office chair' => 'Square Arms',

        // é€šå¸¸æ— æ‰¶æ‰‹çš„å®¶å…·ç±»å‹
        'dining chair' => 'Armless',
        'bar stool' => 'Armless',
        'counter stool' => 'Armless',
        'side chair' => 'Armless',
        'desk chair' => 'Armless',
        'vanity chair' => 'Armless',
        'bench' => 'Armless',
        'ottoman' => 'Armless',
        'stool' => 'Armless'
    ];

    foreach ($product_type_to_arm_style_mapping as $product_type => $style) {
        if (strpos($content, $product_type) !== false) {
            return $style;
        }
    }

    // åŸºäºé£æ ¼å…³é”®è¯æ¨æ–­
    $style_to_arm_style_mapping = [
        'modern' => 'Square Arms',
        'contemporary' => 'Square Arms',
        'minimalist' => 'Recessed Arms',
        'traditional' => 'Round Arms',
        'classic' => 'Round Arms',
        'vintage' => 'Round Arms',
        'mid-century' => 'Square Arms',
        'industrial' => 'Square Arms'
    ];

    foreach ($style_to_arm_style_mapping as $style_keyword => $arm_style) {
        if (strpos($content, $style_keyword) !== false) {
            return $arm_style;
        }
    }

    // åŸºäºæè´¨å’Œç»“æ„æ¨æ–­
    if (strpos($content, 'upholstered') !== false ||
        strpos($content, 'fabric') !== false ||
        strpos($content, 'leather') !== false) {
        return 'Round Arms'; // è½¯åŒ…å®¶å…·é€šå¸¸æœ‰åœ†å½¢æ‰¶æ‰‹
    }

    if (strpos($content, 'metal') !== false ||
        strpos($content, 'steel') !== false ||
        strpos($content, 'aluminum') !== false) {
        return 'Square Arms'; // é‡‘å±å®¶å…·é€šå¸¸æœ‰æ–¹å½¢æ‰¶æ‰‹
    }

    // é»˜è®¤å€¼ï¼šArmless
    return 'Armless';
}

/**
 * æ ‡å‡†åŒ–æ‰¶æ‰‹é£æ ¼å€¼
 *
 * @param string $arm_style_string æ‰¶æ‰‹é£æ ¼å­—ç¬¦ä¸²
 * @return string æ ‡å‡†åŒ–åçš„æ‰¶æ‰‹é£æ ¼
 */
function normalize_arm_style($arm_style_string) {
    $allowed_styles = ['Flared Arms', 'Round Arms', 'Recessed Arms', 'Armless', 'Square Arms'];

    $arm_style_string = trim($arm_style_string);

    // ç›´æ¥åŒ¹é…
    if (in_array($arm_style_string, $allowed_styles)) {
        return $arm_style_string;
    }

    // ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
    foreach ($allowed_styles as $allowed_style) {
        if (strcasecmp($arm_style_string, $allowed_style) === 0) {
            return $allowed_style;
        }
    }

    // éƒ¨åˆ†åŒ¹é…
    $style_lower = strtolower($arm_style_string);

    if (strpos($style_lower, 'flared') !== false || strpos($style_lower, 'flare') !== false) {
        return 'Flared Arms';
    } elseif (strpos($style_lower, 'round') !== false || strpos($style_lower, 'rounded') !== false) {
        return 'Round Arms';
    } elseif (strpos($style_lower, 'recessed') !== false || strpos($style_lower, 'inset') !== false) {
        return 'Recessed Arms';
    } elseif (strpos($style_lower, 'square') !== false || strpos($style_lower, 'straight') !== false) {
        return 'Square Arms';
    } elseif (strpos($style_lower, 'armless') !== false || strpos($style_lower, 'no arm') !== false) {
        return 'Armless';
    }

    return 'Armless'; // é»˜è®¤å€¼
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¡†æ¶é¢œè‰²
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string æ¡†æ¶é¢œè‰²
 */
function get_product_frame_color($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $frame_color_attr = get_product_attribute_value($product, 'frameColor', '');
    if (!empty($frame_color_attr)) {
        // éªŒè¯é•¿åº¦ï¼ˆAPIè¦æ±‚1-400å­—ç¬¦ï¼‰
        $frame_color_attr = trim($frame_color_attr);
        if (strlen($frame_color_attr) >= 1 && strlen($frame_color_attr) <= 400) {
            return $frame_color_attr;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰æ¡†æ¶é¢œè‰²å…³é”®è¯æ˜ å°„ï¼ˆåŸºäºAPIç¤ºä¾‹ï¼‰
    $frame_color_keywords = [
        // åŸºç¡€é¢œè‰²
        'White' => ['white', 'white frame', 'white finish', 'ivory', 'cream', 'off-white', 'ç™½è‰²', 'ç™½æ¡†'],
        'Black' => ['black', 'black frame', 'black finish', 'ebony', 'charcoal', 'é»‘è‰²', 'é»‘æ¡†'],
        'Gray' => ['gray', 'grey', 'gray frame', 'grey frame', 'silver gray', 'ç°è‰²', 'ç°æ¡†'],
        'Silver' => ['silver', 'silver frame', 'metallic silver', 'chrome', 'é“¶è‰²', 'é“¶æ¡†'],
        'Beige' => ['beige', 'beige frame', 'tan', 'sand', 'khaki', 'ç±³è‰²', 'ç±³é»„è‰²'],
        'Tan' => ['tan', 'tan frame', 'brown', 'camel', 'cognac', 'æ£•è¤è‰²', 'æ£•è‰²'],

        // æ‰©å±•é¢œè‰²
        'Gold' => ['gold', 'gold frame', 'golden', 'brass', 'é‡‘è‰²', 'é‡‘æ¡†'],
        'Bronze' => ['bronze', 'bronze frame', 'antique bronze', 'é’é“œè‰²'],
        'Copper' => ['copper', 'copper frame', 'é“œè‰²', 'é“œæ¡†'],
        'Red' => ['red', 'red frame', 'burgundy', 'crimson', 'çº¢è‰²', 'çº¢æ¡†'],
        'Blue' => ['blue', 'blue frame', 'navy', 'royal blue', 'è“è‰²', 'è“æ¡†'],
        'Green' => ['green', 'green frame', 'forest green', 'olive', 'ç»¿è‰²', 'ç»¿æ¡†'],
        'Yellow' => ['yellow', 'yellow frame', 'golden yellow', 'é»„è‰²', 'é»„æ¡†'],
        'Pink' => ['pink', 'pink frame', 'rose', 'blush', 'ç²‰è‰²', 'ç²‰æ¡†'],
        'Purple' => ['purple', 'purple frame', 'violet', 'lavender', 'ç´«è‰²', 'ç´«æ¡†'],
        'Orange' => ['orange', 'orange frame', 'coral', 'æ©™è‰²', 'æ©™æ¡†'],

        // æœ¨æé¢œè‰²
        'Natural' => ['natural', 'natural wood', 'natural finish', 'å¤©ç„¶è‰²', 'åŸæœ¨è‰²'],
        'Walnut' => ['walnut', 'walnut finish', 'dark walnut', 'èƒ¡æ¡ƒæœ¨è‰²'],
        'Oak' => ['oak', 'oak finish', 'light oak', 'æ©¡æœ¨è‰²'],
        'Cherry' => ['cherry', 'cherry finish', 'cherry wood', 'æ¨±æ¡ƒæœ¨è‰²'],
        'Mahogany' => ['mahogany', 'mahogany finish', 'æ¡ƒèŠ±å¿ƒæœ¨è‰²'],
        'Espresso' => ['espresso', 'espresso finish', 'dark brown', 'æ·±æ£•è‰²']
    ];

    // æ£€æŸ¥æ¯ä¸ªé¢œè‰²çš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼‰
    foreach ($frame_color_keywords as $color => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                return $color;
            }
        }
    }

    // åŸºäºæè´¨æ¨æ–­é¢œè‰²
    $material_to_color_mapping = [
        'stainless steel' => 'Silver',
        'aluminum' => 'Silver',
        'chrome' => 'Silver',
        'brass' => 'Gold',
        'copper' => 'Copper',
        'iron' => 'Black',
        'steel' => 'Black'
    ];

    foreach ($material_to_color_mapping as $material => $color) {
        if (strpos($content, $material) !== false) {
            return $color;
        }
    }

    // å°è¯•ä»ç°æœ‰çš„ color å­—æ®µè·å–
    $existing_color = get_product_attribute_value($product, 'color', '');
    if (!empty($existing_color)) {
        $existing_color = trim($existing_color);
        // æ£€æŸ¥æ˜¯å¦åŒ¹é…å·²çŸ¥é¢œè‰²
        foreach ($frame_color_keywords as $color => $keywords) {
            if (strcasecmp($existing_color, $color) === 0) {
                return $color;
            }
            // æ£€æŸ¥æ˜¯å¦åŒ…å«é¢œè‰²å…³é”®è¯
            foreach ($keywords as $keyword) {
                if (stripos($existing_color, $keyword) !== false) {
                    return $color;
                }
            }
        }

        // å¦‚æœç°æœ‰é¢œè‰²ç¬¦åˆé•¿åº¦è¦æ±‚ï¼Œç›´æ¥ä½¿ç”¨
        if (strlen($existing_color) >= 1 && strlen($existing_color) <= 400) {
            return $existing_color;
        }
    }

    // é»˜è®¤å€¼ï¼šProduct color
    return 'Product color';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¤…å­é£æ ¼
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string æ¤…å­é£æ ¼
 */
function get_product_chair_style($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $chair_style_attr = get_product_attribute_value($product, 'chair_style', '');
    if (!empty($chair_style_attr)) {
        $normalized_style = normalize_chair_style($chair_style_attr);
        if (!empty($normalized_style)) {
            return $normalized_style;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å…è®¸çš„æ¤…å­é£æ ¼ï¼ˆæŒ‰APIè§„èŒƒï¼‰
    $allowed_chair_styles = [
        'Butterfly', 'Ghost', 'Wingback', 'Sling', 'Convertible', 'Club', 'Armchair',
        'Balloon', 'Papasan', 'Side Chair', 'Chair-and-a-Half', 'Barcelona', 'Slipper',
        'Scoop', 'Director\'s', 'Bergere', 'Barrel', 'Egg', 'Chesterfield'
    ];

    // å®šä¹‰æ¤…å­é£æ ¼å…³é”®è¯æ˜ å°„ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    $chair_style_keywords = [
        // ç‰¹æ®Šé£æ ¼æ¤…å­
        'Butterfly' => ['butterfly', 'butterfly chair', 'è´è¶æ¤…'],
        'Ghost' => ['ghost', 'ghost chair', 'transparent', 'acrylic chair', 'é€æ˜æ¤…'],
        'Wingback' => ['wingback', 'wing back', 'wing chair', 'high back', 'ç¿¼èƒŒæ¤…'],
        'Papasan' => ['papasan', 'papasan chair', 'bowl chair', 'è—¤æ¤…'],
        'Barcelona' => ['barcelona', 'barcelona chair', 'mies van der rohe', 'å·´å¡ç½—é‚£æ¤…'],
        'Egg' => ['egg', 'egg chair', 'oval chair', 'è›‹æ¤…'],
        'Chesterfield' => ['chesterfield', 'chesterfield chair', 'tufted', 'åˆ‡æ–¯ç‰¹è²å°”å¾·æ¤…'],

        // åŠŸèƒ½æ€§æ¤…å­
        'Convertible' => ['convertible', 'convertible chair', 'sleeper chair', 'chair bed', 'å¯è½¬æ¢æ¤…'],
        'Sling' => ['sling', 'sling chair', 'canvas chair', 'åŠå¸¦æ¤…'],
        'Director\'s' => ['director', 'directors chair', 'folding chair', 'å¯¼æ¼”æ¤…'],

        // ä¼ ç»Ÿé£æ ¼æ¤…å­
        'Club' => ['club', 'club chair', 'leather chair', 'ä¿±ä¹éƒ¨æ¤…'],
        'Bergere' => ['bergere', 'bergere chair', 'french chair', 'è´çƒ­æ¤…'],
        'Barrel' => ['barrel', 'barrel chair', 'round chair', 'æ¡¶å½¢æ¤…'],
        'Balloon' => ['balloon', 'balloon chair', 'round back', 'æ°”çƒæ¤…'],

        // ç°ä»£é£æ ¼æ¤…å­
        'Scoop' => ['scoop', 'scoop chair', 'curved seat', 'å‹ºå½¢æ¤…'],
        'Slipper' => ['slipper', 'slipper chair', 'low chair', 'armless chair', 'æ‹–é‹æ¤…'],

        // åŸºæœ¬æ¤…å­ç±»å‹
        'Armchair' => ['armchair', 'arm chair', 'lounge chair', 'accent chair', 'æ‰¶æ‰‹æ¤…'],
        'Chair-and-a-Half' => ['chair and a half', 'oversized chair', 'large chair', 'å¤§å·æ¤…'],
        'Side Chair' => ['side chair', 'dining chair', 'desk chair', 'accent chair', 'è¾¹æ¤…', 'é¤æ¤…']
    ];

    // æ£€æŸ¥æ¯ä¸ªæ¤…å­é£æ ¼çš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼‰
    foreach ($chair_style_keywords as $style => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                return $style;
            }
        }
    }

    // åŸºäºäº§å“ç±»å‹æ¨æ–­æ¤…å­é£æ ¼
    $product_type_to_chair_style_mapping = [
        'dining chair' => 'Side Chair',
        'office chair' => 'Side Chair',
        'desk chair' => 'Side Chair',
        'accent chair' => 'Armchair',
        'lounge chair' => 'Armchair',
        'recliner' => 'Armchair',
        'swivel chair' => 'Side Chair',
        'bar stool' => 'Side Chair',
        'counter stool' => 'Side Chair'
    ];

    foreach ($product_type_to_chair_style_mapping as $product_type => $style) {
        if (strpos($content, $product_type) !== false) {
            return $style;
        }
    }

    // åŸºäºæè´¨å’Œç‰¹å¾æ¨æ–­
    if (strpos($content, 'leather') !== false &&
        (strpos($content, 'traditional') !== false || strpos($content, 'classic') !== false)) {
        return 'Club';
    }

    if (strpos($content, 'high back') !== false || strpos($content, 'tall back') !== false) {
        return 'Wingback';
    }

    if (strpos($content, 'armless') !== false || strpos($content, 'no arms') !== false) {
        return 'Side Chair';
    }

    if (strpos($content, 'oversized') !== false || strpos($content, 'extra large') !== false) {
        return 'Chair-and-a-Half';
    }

    // é»˜è®¤å€¼ï¼šSide Chair
    return 'Side Chair';
}

/**
 * æ ‡å‡†åŒ–æ¤…å­é£æ ¼å€¼
 *
 * @param string $chair_style_string æ¤…å­é£æ ¼å­—ç¬¦ä¸²
 * @return string æ ‡å‡†åŒ–åçš„æ¤…å­é£æ ¼
 */
function normalize_chair_style($chair_style_string) {
    $allowed_styles = [
        'Butterfly', 'Ghost', 'Wingback', 'Sling', 'Convertible', 'Club', 'Armchair',
        'Balloon', 'Papasan', 'Side Chair', 'Chair-and-a-Half', 'Barcelona', 'Slipper',
        'Scoop', 'Director\'s', 'Bergere', 'Barrel', 'Egg', 'Chesterfield'
    ];

    $chair_style_string = trim($chair_style_string);

    // ç›´æ¥åŒ¹é…
    if (in_array($chair_style_string, $allowed_styles)) {
        return $chair_style_string;
    }

    // ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
    foreach ($allowed_styles as $allowed_style) {
        if (strcasecmp($chair_style_string, $allowed_style) === 0) {
            return $allowed_style;
        }
    }

    // éƒ¨åˆ†åŒ¹é…
    $style_lower = strtolower($chair_style_string);

    if (strpos($style_lower, 'butterfly') !== false) return 'Butterfly';
    if (strpos($style_lower, 'ghost') !== false) return 'Ghost';
    if (strpos($style_lower, 'wingback') !== false || strpos($style_lower, 'wing back') !== false) return 'Wingback';
    if (strpos($style_lower, 'sling') !== false) return 'Sling';
    if (strpos($style_lower, 'convertible') !== false) return 'Convertible';
    if (strpos($style_lower, 'club') !== false) return 'Club';
    if (strpos($style_lower, 'armchair') !== false || strpos($style_lower, 'arm chair') !== false) return 'Armchair';
    if (strpos($style_lower, 'balloon') !== false) return 'Balloon';
    if (strpos($style_lower, 'papasan') !== false) return 'Papasan';
    if (strpos($style_lower, 'side chair') !== false) return 'Side Chair';
    if (strpos($style_lower, 'chair-and-a-half') !== false || strpos($style_lower, 'chair and a half') !== false) return 'Chair-and-a-Half';
    if (strpos($style_lower, 'barcelona') !== false) return 'Barcelona';
    if (strpos($style_lower, 'slipper') !== false) return 'Slipper';
    if (strpos($style_lower, 'scoop') !== false) return 'Scoop';
    if (strpos($style_lower, 'director') !== false) return 'Director\'s';
    if (strpos($style_lower, 'bergere') !== false) return 'Bergere';
    if (strpos($style_lower, 'barrel') !== false) return 'Barrel';
    if (strpos($style_lower, 'egg') !== false) return 'Egg';
    if (strpos($style_lower, 'chesterfield') !== false) return 'Chesterfield';

    return 'Side Chair'; // é»˜è®¤å€¼
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ¡†æ¶æè´¨
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array æ¡†æ¶æè´¨æ•°ç»„
 */
function get_product_frame_material($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $frame_material_attr = get_product_attribute_value($product, 'frameMaterial', '');
    if (!empty($frame_material_attr)) {
        $parsed_materials = parse_frame_materials($frame_material_attr);
        if (!empty($parsed_materials)) {
            return $parsed_materials;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰æ¡†æ¶æè´¨å…³é”®è¯æ˜ å°„ï¼ˆåŸºäºAPIç¤ºä¾‹ï¼‰
    $frame_material_keywords = [
        // é‡‘å±æè´¨
        'Metal' => [
            'metal', 'metal frame', 'metallic', 'alloy',
            'é‡‘å±', 'é‡‘å±æ¡†æ¶'
        ],
        'Steel' => [
            'steel', 'steel frame', 'stainless steel', 'carbon steel',
            'powder coated steel', 'é’¢', 'é’¢æ', 'ä¸é”ˆé’¢'
        ],

        // æœ¨ææè´¨
        'Wood' => [
            'wood', 'wood frame', 'solid wood', 'hardwood', 'softwood',
            'wooden', 'timber', 'æœ¨æ', 'æœ¨è´¨', 'å®æœ¨'
        ],
        'Manufactured Wood' => [
            'manufactured wood', 'engineered wood', 'composite wood', 'plywood',
            'mdf', 'particle board', 'chipboard', 'laminated wood',
            'äººé€ æœ¨æ', 'å¤åˆæœ¨æ', 'èƒ¶åˆæ¿'
        ],
        'Bamboo' => [
            'bamboo', 'bamboo frame', 'bamboo wood',
            'ç«¹å­', 'ç«¹æ', 'ç«¹æœ¨'
        ],

        // å…¶ä»–æè´¨
        'Acrylic' => [
            'acrylic', 'acrylic frame', 'plexiglass', 'lucite',
            'äºšå…‹åŠ›', 'æœ‰æœºç»ç’ƒ'
        ],
        'Plastic' => [
            'plastic', 'plastic frame', 'polymer', 'resin',
            'å¡‘æ–™', 'å¡‘èƒ¶'
        ],
        'Wicker' => [
            'wicker', 'wicker frame', 'rattan', 'cane',
            'æŸ³æ¡', 'è—¤æ¡', 'è—¤ç¼–'
        ],

        // è½¯è´¨æè´¨
        'Fabric' => [
            'fabric', 'fabric frame', 'textile', 'cloth',
            'ç»‡ç‰©', 'å¸ƒæ–™', 'é¢æ–™'
        ],
        'Leather' => [
            'leather', 'leather frame', 'genuine leather', 'real leather',
            'çš®é©', 'çœŸçš®', 'ç‰›çš®'
        ],
        'Faux Leather' => [
            'faux leather', 'synthetic leather', 'artificial leather', 'pu leather',
            'vinyl', 'leatherette', 'äººé€ çš®é©', 'ä»¿çš®'
        ],
        'Upholstered' => [
            'upholstered', 'upholstered frame', 'padded', 'cushioned',
            'è½¯åŒ…', 'åŒ…è¦†', 'å¡«å……'
        ]
    ];

    $detected_materials = [];

    // æ£€æŸ¥æ¯ä¸ªæè´¨çš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼‰
    foreach ($frame_material_keywords as $material => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                if (!in_array($material, $detected_materials)) {
                    $detected_materials[] = $material;
                }
                break; // æ‰¾åˆ°ä¸€ä¸ªå°±å¤Ÿäº†
            }
        }
    }

    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æ¡†æ¶æè´¨ï¼Œå°è¯•ä»ä¸»æè´¨è·å–
    if (empty($detected_materials)) {
        $main_material = get_product_attribute_value($product, 'material', '');
        if (!empty($main_material)) {
            $parsed_main_materials = parse_frame_materials($main_material);
            if (!empty($parsed_main_materials)) {
                $detected_materials = $parsed_main_materials;
            }
        }
    }

    // åŸºäºäº§å“ç±»å‹æ¨æ–­æè´¨
    if (empty($detected_materials)) {
        $product_type_to_material_mapping = [
            'office chair' => ['Metal', 'Plastic'],
            'bar stool' => ['Metal'],
            'dining chair' => ['Wood'],
            'accent chair' => ['Wood', 'Fabric'],
            'outdoor chair' => ['Metal', 'Wicker'],
            'patio furniture' => ['Metal', 'Wicker'],
            'recliner' => ['Steel', 'Upholstered']
        ];

        foreach ($product_type_to_material_mapping as $product_type => $materials) {
            if (strpos($content, $product_type) !== false) {
                $detected_materials = $materials;
                break;
            }
        }
    }

    // éªŒè¯æ¯ä¸ªæè´¨çš„é•¿åº¦ï¼ˆAPIè¦æ±‚1-400å­—ç¬¦ï¼‰
    $valid_materials = [];
    foreach ($detected_materials as $material) {
        $material = trim($material);
        if (strlen($material) >= 1 && strlen($material) <= 400) {
            $valid_materials[] = $material;
        }
    }

    // å¦‚æœä»ç„¶æ²¡æœ‰æ£€æµ‹åˆ°æè´¨ï¼Œè¿”å›ç©ºæ•°ç»„
    if (empty($valid_materials)) {
        return [];
    }

    return $valid_materials;
}

/**
 * è§£ææ¡†æ¶æè´¨å­—ç¬¦ä¸²
 *
 * @param string $material_string æè´¨å­—ç¬¦ä¸²
 * @return array è§£æåçš„æè´¨æ•°ç»„
 */
function parse_frame_materials($material_string) {
    $api_materials = [
        'Metal', 'Steel', 'Wood', 'Acrylic', 'Fabric', 'Faux Leather',
        'Leather', 'Manufactured Wood', 'Upholstered', 'Plastic', 'Wicker', 'Bamboo'
    ];

    $parsed_materials = [];

    // åˆ†å‰²å­—ç¬¦ä¸²ï¼ˆæ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼‰
    $separators = [',', ';', '|', '/', '&', ' and ', ' + ', ' with '];
    $materials = [$material_string];

    foreach ($separators as $separator) {
        $new_materials = [];
        foreach ($materials as $material) {
            $split = explode($separator, $material);
            $new_materials = array_merge($new_materials, $split);
        }
        $materials = $new_materials;
    }

    // æ¸…ç†å’ŒéªŒè¯æ¯ä¸ªæè´¨
    foreach ($materials as $material) {
        $material = trim($material);

        // ç›´æ¥åŒ¹é…
        foreach ($api_materials as $api_material) {
            if (strcasecmp($material, $api_material) === 0) {
                if (!in_array($api_material, $parsed_materials)) {
                    $parsed_materials[] = $api_material;
                }
                break;
            }
        }

        // éƒ¨åˆ†åŒ¹é…
        $material_lower = strtolower($material);
        if (strpos($material_lower, 'steel') !== false && !in_array('Steel', $parsed_materials)) {
            $parsed_materials[] = 'Steel';
        } elseif (strpos($material_lower, 'metal') !== false && !in_array('Metal', $parsed_materials)) {
            $parsed_materials[] = 'Metal';
        } elseif ((strpos($material_lower, 'wood') !== false || strpos($material_lower, 'wooden') !== false) &&
                  !in_array('Wood', $parsed_materials) && !in_array('Manufactured Wood', $parsed_materials)) {
            if (strpos($material_lower, 'manufactured') !== false || strpos($material_lower, 'engineered') !== false) {
                $parsed_materials[] = 'Manufactured Wood';
            } else {
                $parsed_materials[] = 'Wood';
            }
        } elseif (strpos($material_lower, 'leather') !== false) {
            if (strpos($material_lower, 'faux') !== false || strpos($material_lower, 'synthetic') !== false) {
                if (!in_array('Faux Leather', $parsed_materials)) {
                    $parsed_materials[] = 'Faux Leather';
                }
            } else {
                if (!in_array('Leather', $parsed_materials)) {
                    $parsed_materials[] = 'Leather';
                }
            }
        }
    }

    return $parsed_materials;
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åŒ…å«è„šå‡³
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string æ˜¯å¦åŒ…å«è„šå‡³ (Yes/No)
 */
function get_product_ottoman_included($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $ottoman_attr = get_product_attribute_value($product, 'ottoman_included', '');
    if (!empty($ottoman_attr)) {
        $normalized_ottoman = normalize_ottoman_included($ottoman_attr);
        if (!empty($normalized_ottoman)) {
            return $normalized_ottoman;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰åŒ…å«è„šå‡³çš„å…³é”®è¯
    $ottoman_included_keywords = [
        'ottoman included', 'with ottoman', 'includes ottoman', 'ottoman attachment',
        'matching ottoman', 'ottoman set', 'chair and ottoman', 'chair with footrest',
        'footrest included', 'with footrest', 'includes footrest', 'footstool included',
        'with footstool', 'includes footstool', 'leg rest included', 'with leg rest',
        'åŒ…å«è„šå‡³', 'å¸¦è„šå‡³', 'å«è„šå‡³', 'è„šå‡³å¥—è£…'
    ];

    // æ£€æŸ¥æ˜¯å¦åŒ…å«è„šå‡³çš„å…³é”®è¯
    foreach ($ottoman_included_keywords as $keyword) {
        if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
            return 'Yes';
        }
    }

    // æ£€æŸ¥äº§å“åç§°ä¸­æ˜¯å¦æ˜ç¡®æåˆ°è„šå‡³
    $product_name_lower = strtolower($product->get_name());
    if (strpos($product_name_lower, 'ottoman') !== false &&
        (strpos($product_name_lower, 'set') !== false ||
         strpos($product_name_lower, 'combo') !== false ||
         strpos($product_name_lower, 'with') !== false)) {
        return 'Yes';
    }

    // åŸºäºäº§å“ç±»å‹æ¨æ–­
    $product_types_with_ottoman = [
        'recliner with ottoman',
        'chair and ottoman set',
        'lounge chair with footrest',
        'accent chair with ottoman'
    ];

    foreach ($product_types_with_ottoman as $product_type) {
        if (strpos($content, $product_type) !== false) {
            return 'Yes';
        }
    }

    // æ£€æŸ¥æ˜¯å¦æ˜ç¡®è¯´æ˜ä¸åŒ…å«è„šå‡³
    $no_ottoman_keywords = [
        'no ottoman', 'without ottoman', 'ottoman not included', 'chair only',
        'ottoman sold separately', 'ottoman separate', 'no footrest',
        'ä¸å«è„šå‡³', 'æ— è„šå‡³', 'è„šå‡³å¦å”®'
    ];

    foreach ($no_ottoman_keywords as $keyword) {
        if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
            return 'No';
        }
    }

    // é»˜è®¤å€¼ï¼šNo
    return 'No';
}

/**
 * æ ‡å‡†åŒ–è„šå‡³åŒ…å«å€¼
 *
 * @param string $ottoman_string è„šå‡³åŒ…å«å­—ç¬¦ä¸²
 * @return string æ ‡å‡†åŒ–åçš„å€¼
 */
function normalize_ottoman_included($ottoman_string) {
    $allowed_values = ['Yes', 'No'];

    $ottoman_string = trim($ottoman_string);

    // ç›´æ¥åŒ¹é…
    if (in_array($ottoman_string, $allowed_values)) {
        return $ottoman_string;
    }

    // ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
    foreach ($allowed_values as $allowed_value) {
        if (strcasecmp($ottoman_string, $allowed_value) === 0) {
            return $allowed_value;
        }
    }

    // éƒ¨åˆ†åŒ¹é…
    $ottoman_lower = strtolower($ottoman_string);

    if (strpos($ottoman_lower, 'yes') !== false ||
        strpos($ottoman_lower, 'true') !== false ||
        strpos($ottoman_lower, 'included') !== false ||
        strpos($ottoman_lower, 'with') !== false) {
        return 'Yes';
    } elseif (strpos($ottoman_lower, 'no') !== false ||
              strpos($ottoman_lower, 'false') !== false ||
              strpos($ottoman_lower, 'not included') !== false ||
              strpos($ottoman_lower, 'without') !== false) {
        return 'No';
    }

    return 'No'; // é»˜è®¤å€¼
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«å›¾æ¡ˆæ ·å¼
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return array å›¾æ¡ˆæ ·å¼æ•°ç»„
 */
function get_product_pattern($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $pattern_attr = get_product_attribute_value($product, 'pattern', '');
    if (!empty($pattern_attr)) {
        $parsed_patterns = parse_patterns($pattern_attr);
        if (!empty($parsed_patterns)) {
            return $parsed_patterns;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å›¾æ¡ˆæ ·å¼å…³é”®è¯æ˜ å°„ï¼ˆåŸºäºAPIç¤ºä¾‹å’Œå¸¸è§å›¾æ¡ˆï¼‰
    $pattern_keywords = [
        // åŸºç¡€å›¾æ¡ˆ
        'Solid' => [
            'solid', 'solid color', 'plain', 'single color', 'uniform',
            'çº¯è‰²', 'å•è‰²', 'ç´ è‰²'
        ],
        'Pattern' => [
            'pattern', 'patterned', 'design', 'motif', 'decorative',
            'å›¾æ¡ˆ', 'èŠ±çº¹', 'è£…é¥°'
        ],
        'Floral' => [
            'floral', 'flower', 'flowers', 'botanical', 'rose', 'lily',
            'peony', 'daisy', 'bloom', 'blossom',
            'èŠ±å‰', 'èŠ±æœµ', 'æ¤ç‰©'
        ],

        // æ‰©å±•å›¾æ¡ˆ
        'Striped' => [
            'striped', 'stripe', 'stripes', 'linear', 'band',
            'æ¡çº¹', 'æ¨ªæ¡', 'ç«–æ¡'
        ],
        'Plaid' => [
            'plaid', 'tartan', 'checkered', 'checked', 'gingham',
            'æ ¼å­', 'æ–¹æ ¼', 'è‹æ ¼å…°æ ¼'
        ],
        'Geometric' => [
            'geometric', 'triangle', 'circle', 'square', 'diamond',
            'hexagon', 'polygon', 'abstract',
            'å‡ ä½•', 'ä¸‰è§’', 'åœ†å½¢', 'æ–¹å½¢'
        ],
        'Paisley' => [
            'paisley', 'teardrop', 'boteh',
            'ä½©æ–¯åˆ©', 'æ°´æ»´çº¹'
        ],
        'Animal Print' => [
            'animal print', 'leopard', 'zebra', 'tiger', 'cheetah',
            'snake', 'crocodile', 'cowhide',
            'åŠ¨ç‰©çº¹', 'è±¹çº¹', 'æ–‘é©¬çº¹'
        ],
        'Polka Dot' => [
            'polka dot', 'polka dots', 'dotted', 'spots', 'spotted',
            'æ³¢ç‚¹', 'åœ†ç‚¹', 'æ–‘ç‚¹'
        ],
        'Damask' => [
            'damask', 'baroque', 'ornate', 'scrollwork',
            'å¤§é©¬å£«é©', 'å·´æ´›å…‹'
        ],
        'Toile' => [
            'toile', 'pastoral', 'scenic', 'countryside',
            'å°èŠ±å¸ƒ', 'ç”°å›­'
        ],
        'Ikat' => [
            'ikat', 'tie dye', 'tie-dye', 'resist dye',
            'æ‰æŸ“', 'èœ¡æŸ“'
        ],
        'Chevron' => [
            'chevron', 'zigzag', 'herringbone', 'v-shape',
            'äººå­—çº¹', 'ä¹‹å­—å½¢'
        ]
    ];

    $detected_patterns = [];

    // æ£€æŸ¥æ¯ä¸ªå›¾æ¡ˆçš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼Œä¼˜å…ˆå…·ä½“å›¾æ¡ˆï¼‰
    $specific_patterns = ['Floral', 'Striped', 'Plaid', 'Geometric', 'Paisley', 'Animal Print', 'Polka Dot', 'Damask', 'Toile', 'Ikat', 'Chevron'];
    $general_patterns = ['Solid', 'Pattern'];

    // å…ˆæ£€æŸ¥å…·ä½“å›¾æ¡ˆ
    foreach ($specific_patterns as $pattern) {
        if (isset($pattern_keywords[$pattern])) {
            foreach ($pattern_keywords[$pattern] as $keyword) {
                if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                    if (!in_array($pattern, $detected_patterns)) {
                        $detected_patterns[] = $pattern;
                    }
                    break;
                }
            }
        }
    }

    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å…·ä½“å›¾æ¡ˆï¼Œå†æ£€æŸ¥é€šç”¨å›¾æ¡ˆ
    if (empty($detected_patterns)) {
        foreach ($general_patterns as $pattern) {
            if (isset($pattern_keywords[$pattern])) {
                foreach ($pattern_keywords[$pattern] as $keyword) {
                    if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                        if (!in_array($pattern, $detected_patterns)) {
                            $detected_patterns[] = $pattern;
                        }
                        break;
                    }
                }
            }
        }
    }

    // éªŒè¯æ¯ä¸ªå›¾æ¡ˆçš„é•¿åº¦ï¼ˆAPIè¦æ±‚1-400å­—ç¬¦ï¼‰
    $valid_patterns = [];
    foreach ($detected_patterns as $pattern) {
        $pattern = trim($pattern);
        if (strlen($pattern) >= 1 && strlen($pattern) <= 400) {
            $valid_patterns[] = $pattern;
        }
    }

    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°å›¾æ¡ˆï¼Œè¿”å›é»˜è®¤å€¼
    if (empty($valid_patterns)) {
        return ['Solid'];
    }

    return $valid_patterns;
}

/**
 * è§£æå›¾æ¡ˆæ ·å¼å­—ç¬¦ä¸²
 *
 * @param string $pattern_string å›¾æ¡ˆå­—ç¬¦ä¸²
 * @return array è§£æåçš„å›¾æ¡ˆæ•°ç»„
 */
function parse_patterns($pattern_string) {
    $common_patterns = [
        'Solid', 'Pattern', 'Floral', 'Striped', 'Plaid', 'Geometric',
        'Paisley', 'Animal Print', 'Polka Dot', 'Damask', 'Toile', 'Ikat', 'Chevron'
    ];

    $parsed_patterns = [];

    // åˆ†å‰²å­—ç¬¦ä¸²ï¼ˆæ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼‰
    $separators = [',', ';', '|', '/', '&', ' and ', ' + ', ' with '];
    $patterns = [$pattern_string];

    foreach ($separators as $separator) {
        $new_patterns = [];
        foreach ($patterns as $pattern) {
            $split = explode($separator, $pattern);
            $new_patterns = array_merge($new_patterns, $split);
        }
        $patterns = $new_patterns;
    }

    // æ¸…ç†å’ŒéªŒè¯æ¯ä¸ªå›¾æ¡ˆ
    foreach ($patterns as $pattern) {
        $pattern = trim($pattern);

        // ç›´æ¥åŒ¹é…
        foreach ($common_patterns as $common_pattern) {
            if (strcasecmp($pattern, $common_pattern) === 0) {
                if (!in_array($common_pattern, $parsed_patterns)) {
                    $parsed_patterns[] = $common_pattern;
                }
                break;
            }
        }

        // éƒ¨åˆ†åŒ¹é…
        $pattern_lower = strtolower($pattern);
        if (strpos($pattern_lower, 'floral') !== false || strpos($pattern_lower, 'flower') !== false) {
            if (!in_array('Floral', $parsed_patterns)) {
                $parsed_patterns[] = 'Floral';
            }
        } elseif (strpos($pattern_lower, 'stripe') !== false) {
            if (!in_array('Striped', $parsed_patterns)) {
                $parsed_patterns[] = 'Striped';
            }
        } elseif (strpos($pattern_lower, 'geometric') !== false) {
            if (!in_array('Geometric', $parsed_patterns)) {
                $parsed_patterns[] = 'Geometric';
            }
        } elseif (strpos($pattern_lower, 'solid') !== false || strpos($pattern_lower, 'plain') !== false) {
            if (!in_array('Solid', $parsed_patterns)) {
                $parsed_patterns[] = 'Solid';
            }
        }
    }

    return $parsed_patterns;
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«è…¿éƒ¨é¢œè‰²
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string è…¿éƒ¨é¢œè‰²
 */
function get_product_leg_color($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $leg_color_attr = get_product_attribute_value($product, 'leg_color', '');
    if (!empty($leg_color_attr)) {
        // éªŒè¯é•¿åº¦ï¼ˆAPIè¦æ±‚1-400å­—ç¬¦ï¼‰
        $leg_color_attr = trim($leg_color_attr);
        if (strlen($leg_color_attr) >= 1 && strlen($leg_color_attr) <= 400) {
            return $leg_color_attr;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰è…¿éƒ¨é¢œè‰²å…³é”®è¯æ˜ å°„ï¼ˆåŸºäºAPIç¤ºä¾‹ï¼‰
    $leg_color_keywords = [
        'White' => ['white legs', 'white leg', 'white base', 'ç™½è‰²è…¿'],
        'Black' => ['black legs', 'black leg', 'black base', 'é»‘è‰²è…¿'],
        'Brown' => ['brown legs', 'brown leg', 'brown base', 'walnut legs', 'æ£•è‰²è…¿'],
        'Gray' => ['gray legs', 'grey legs', 'gray leg', 'grey leg', 'silver legs', 'ç°è‰²è…¿'],
        'Beige' => ['beige legs', 'beige leg', 'tan legs', 'ç±³è‰²è…¿'],
        'Tan' => ['tan legs', 'tan leg', 'camel legs', 'æ£•è¤è‰²è…¿'],
        'Gold' => ['gold legs', 'gold leg', 'brass legs', 'é‡‘è‰²è…¿'],
        'Natural' => ['natural legs', 'natural leg', 'wood legs', 'å¤©ç„¶è‰²è…¿']
    ];

    // æ£€æŸ¥æ¯ä¸ªé¢œè‰²çš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼‰
    foreach ($leg_color_keywords as $color => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                return $color;
            }
        }
    }

    // å°è¯•ä»ä¸»é¢œè‰²è·å–
    $main_color = get_product_attribute_value($product, 'color', '');
    if (!empty($main_color)) {
        $main_color = trim($main_color);
        // æ£€æŸ¥æ˜¯å¦åŒ¹é…å·²çŸ¥é¢œè‰²
        foreach ($leg_color_keywords as $color => $keywords) {
            if (strcasecmp($main_color, $color) === 0) {
                return $color;
            }
        }

        // å¦‚æœä¸»é¢œè‰²ç¬¦åˆé•¿åº¦è¦æ±‚ï¼Œç›´æ¥ä½¿ç”¨
        if (strlen($main_color) >= 1 && strlen($main_color) <= 400) {
            return $main_color;
        }
    }

    // åŸºäºæè´¨æ¨æ–­é¢œè‰²
    if (strpos($content, 'metal') !== false || strpos($content, 'steel') !== false) {
        return 'Black';
    }
    if (strpos($content, 'wood') !== false || strpos($content, 'wooden') !== false) {
        return 'Brown';
    }

    // é»˜è®¤å€¼ï¼šä½¿ç”¨äº§å“ä¸»ä½“é¢œè‰²æˆ– Brown
    return !empty($main_color) ? $main_color : 'Brown';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«è…¿éƒ¨æè´¨
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string è…¿éƒ¨æè´¨
 */
function get_product_leg_material($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $leg_material_attr = get_product_attribute_value($product, 'leg_material', '');
    if (!empty($leg_material_attr)) {
        // éªŒè¯é•¿åº¦ï¼ˆAPIè¦æ±‚1-400å­—ç¬¦ï¼‰
        $leg_material_attr = trim($leg_material_attr);
        if (strlen($leg_material_attr) >= 1 && strlen($leg_material_attr) <= 400) {
            return $leg_material_attr;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰è…¿éƒ¨æè´¨å…³é”®è¯æ˜ å°„ï¼ˆåŸºäºAPIç¤ºä¾‹ï¼‰
    $leg_material_keywords = [
        'Wood' => ['wood legs', 'wooden legs', 'wood leg', 'wooden leg', 'timber legs', 'æœ¨è…¿'],
        'Metal' => ['metal legs', 'metal leg', 'steel legs', 'iron legs', 'é‡‘å±è…¿'],
        'Plastic' => ['plastic legs', 'plastic leg', 'polymer legs', 'å¡‘æ–™è…¿'],
        'Acrylic' => ['acrylic legs', 'acrylic leg', 'lucite legs', 'äºšå…‹åŠ›è…¿']
    ];

    // æ£€æŸ¥æ¯ä¸ªæè´¨çš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼‰
    foreach ($leg_material_keywords as $material => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                return $material;
            }
        }
    }

    // åŸºäºäº§å“ç±»å‹æ¨æ–­æè´¨
    if (strpos($content, 'office chair') !== false || strpos($content, 'desk chair') !== false) {
        return 'Metal';
    }
    if (strpos($content, 'dining chair') !== false || strpos($content, 'accent chair') !== false) {
        return 'Wood';
    }
    if (strpos($content, 'outdoor') !== false || strpos($content, 'patio') !== false) {
        return 'Metal';
    }

    // å°è¯•ä»ä¸»æè´¨è·å–
    $main_material = get_product_attribute_value($product, 'material', '');
    if (!empty($main_material)) {
        $main_material = trim($main_material);

        // æ£€æŸ¥æ˜¯å¦åŒ¹é…å·²çŸ¥æè´¨
        foreach ($leg_material_keywords as $material => $keywords) {
            if (strcasecmp($main_material, $material) === 0) {
                return $material;
            }
        }

        // éƒ¨åˆ†åŒ¹é…
        $material_lower = strtolower($main_material);
        if (strpos($material_lower, 'wood') !== false) {
            return 'Wood';
        } elseif (strpos($material_lower, 'metal') !== false || strpos($material_lower, 'steel') !== false) {
            return 'Metal';
        } elseif (strpos($material_lower, 'plastic') !== false) {
            return 'Plastic';
        } elseif (strpos($material_lower, 'acrylic') !== false) {
            return 'Acrylic';
        }

        // å¦‚æœä¸»æè´¨ç¬¦åˆé•¿åº¦è¦æ±‚ï¼Œç›´æ¥ä½¿ç”¨
        if (strlen($main_material) >= 1 && strlen($main_material) <= 400) {
            return $main_material;
        }
    }

    // é»˜è®¤å€¼ï¼šWood
    return 'Wood';
}

/**
 * æ ¹æ®äº§å“æ ‡é¢˜å’Œæè¿°è‡ªåŠ¨è¯†åˆ«é¢„è®¾åºŠä½
 *
 * @param WC_Product $product WooCommerceäº§å“å¯¹è±¡
 * @return string é¢„è®¾åºŠä½
 */
function get_product_preset_bed_positions($product) {
    // é¦–å…ˆå°è¯•ä»äº§å“å±æ€§ä¸­è·å–
    $preset_attr = get_product_attribute_value($product, 'preset_bed_positions', '');
    if (!empty($preset_attr)) {
        $normalized_preset = normalize_preset_bed_positions($preset_attr);
        if (!empty($normalized_preset)) {
            return $normalized_preset;
        }
    }

    // ä»äº§å“æ ‡é¢˜å’Œæè¿°ä¸­æå–å…³é”®è¯
    $content = strtolower($product->get_name() . ' ' . $product->get_description() . ' ' . $product->get_short_description());

    // å®šä¹‰å…è®¸çš„é¢„è®¾åºŠä½ï¼ˆæŒ‰APIè§„èŒƒï¼‰
    $allowed_positions = ['Zero Gravity', 'Flat', 'None', 'Anti-Snore'];

    // å®šä¹‰é¢„è®¾åºŠä½å…³é”®è¯æ˜ å°„ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    $preset_keywords = [
        // Zero Gravity - é›¶é‡åŠ›ä½ç½®
        'Zero Gravity' => [
            'zero gravity', 'zero-gravity', 'weightless', 'weightlessness',
            'nasa position', 'astronaut position', 'zero g', 'zero-g',
            'neutral body position', 'zero gravity preset',
            'é›¶é‡åŠ›', 'å¤±é‡', 'å®‡èˆªå‘˜å§¿åŠ¿'
        ],

        // Anti-Snore - é˜²æ‰“é¼¾ä½ç½®
        'Anti-Snore' => [
            'anti snore', 'anti-snore', 'snore relief', 'stop snoring',
            'reduce snoring', 'snoring solution', 'anti snoring',
            'head elevation', 'elevated head', 'snore prevention',
            'é˜²æ‰“é¼¾', 'æ­¢é¼¾', 'æŠ—é¼¾'
        ],

        // Flat - å¹³èººä½ç½®
        'Flat' => [
            'flat', 'flat position', 'completely flat', 'level',
            'horizontal', 'flat preset', 'zero incline',
            'å¹³èºº', 'æ°´å¹³', 'å¹³æ”¾'
        ]
    ];

    // æ£€æŸ¥æ¯ä¸ªé¢„è®¾ä½ç½®çš„å…³é”®è¯ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼‰
    foreach ($preset_keywords as $position => $keywords) {
        foreach ($keywords as $keyword) {
            // ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†è¯åŒ¹é…
            if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
                return $position;
            }
        }
    }

    // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯æ‰‹åŠ¨è°ƒèŠ‚ï¼ˆé¿å…ä¸ç”µåŠ¨æ··æ·†ï¼‰
    if (strpos($content, 'manual') !== false && strpos($content, 'adjustable') !== false) {
        return 'None';
    }

    // åŸºäºåºŠæ¶ç±»å‹æ¨æ–­é¢„è®¾ä½ç½®
    // å¦‚æœæ˜¯ç”µåŠ¨å¯è°ƒåºŠæ¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³åŠŸèƒ½æè¿°
    if (strpos($content, 'adjustable') !== false ||
        strpos($content, 'power') !== false ||
        strpos($content, 'electric') !== false ||
        strpos($content, 'motorized') !== false) {

        // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‰æ‘©åŠŸèƒ½ï¼ˆé€šå¸¸é…æœ‰é›¶é‡åŠ›ä½ç½®ï¼‰
        if (strpos($content, 'massage') !== false ||
            strpos($content, 'vibration') !== false ||
            strpos($content, 'therapeutic') !== false) {
            return 'Zero Gravity';
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å¥åº·åŠŸèƒ½ï¼ˆå¯èƒ½æœ‰é˜²æ‰“é¼¾ï¼‰
        if (strpos($content, 'health') !== false ||
            strpos($content, 'wellness') !== false ||
            strpos($content, 'sleep quality') !== false ||
            strpos($content, 'breathing') !== false) {
            return 'Anti-Snore';
        }

        // å¦‚æœæ˜¯ç”µåŠ¨å¯è°ƒä½†æ²¡æœ‰ç‰¹æ®ŠåŠŸèƒ½ï¼Œé»˜è®¤ä¸ºFlat
        return 'Flat';
    }

    // åŸºäºäº§å“æè¿°ä¸­çš„åŠŸèƒ½ç‰¹å¾æ¨æ–­
    if (strpos($content, 'remote control') !== false ||
        strpos($content, 'wireless remote') !== false ||
        strpos($content, 'app control') !== false) {

        // æœ‰é¥æ§åŠŸèƒ½çš„é€šå¸¸æœ‰å¤šç§é¢„è®¾ä½ç½®ï¼Œä¼˜å…ˆé›¶é‡åŠ›
        if (strpos($content, 'position') !== false ||
            strpos($content, 'preset') !== false) {
            return 'Zero Gravity';
        }

        return 'Flat';
    }

    // æ£€æŸ¥æ˜¯å¦æ˜ç¡®è¯´æ˜æ²¡æœ‰é¢„è®¾ä½ç½®
    $no_preset_keywords = [
        'no preset', 'no presets', 'manual only', 'manual adjustment',
        'no automatic', 'basic model', 'standard frame'
    ];

    foreach ($no_preset_keywords as $keyword) {
        if (preg_match('/\b' . preg_quote($keyword, '/') . '\b/i', $content)) {
            return 'None';
        }
    }

    // å¦‚æœä¸æ˜¯ç”µåŠ¨å¯è°ƒåºŠæ¶ï¼Œé»˜è®¤ä¸ºNone
    if (strpos($content, 'bed frame') !== false &&
        strpos($content, 'adjustable') === false &&
        strpos($content, 'power') === false &&
        strpos($content, 'electric') === false) {
        return 'None';
    }

    // é»˜è®¤å€¼ï¼šNone
    return 'None';
}

/**
 * æ ‡å‡†åŒ–é¢„è®¾åºŠä½å€¼
 *
 * @param string $preset_string é¢„è®¾åºŠä½å­—ç¬¦ä¸²
 * @return string æ ‡å‡†åŒ–åçš„é¢„è®¾åºŠä½
 */
function normalize_preset_bed_positions($preset_string) {
    $allowed_positions = ['Zero Gravity', 'Flat', 'None', 'Anti-Snore'];

    $preset_string = trim($preset_string);

    // ç›´æ¥åŒ¹é…
    if (in_array($preset_string, $allowed_positions)) {
        return $preset_string;
    }

    // ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
    foreach ($allowed_positions as $allowed_position) {
        if (strcasecmp($preset_string, $allowed_position) === 0) {
            return $allowed_position;
        }
    }

    // éƒ¨åˆ†åŒ¹é…
    $preset_lower = strtolower($preset_string);

    if (strpos($preset_lower, 'zero gravity') !== false || strpos($preset_lower, 'zero-gravity') !== false) {
        return 'Zero Gravity';
    } elseif (strpos($preset_lower, 'anti snore') !== false || strpos($preset_lower, 'anti-snore') !== false) {
        return 'Anti-Snore';
    } elseif (strpos($preset_lower, 'flat') !== false) {
        return 'Flat';
    } elseif (strpos($preset_lower, 'none') !== false || strpos($preset_lower, 'no preset') !== false) {
        return 'None';
    }

    return 'None'; // é»˜è®¤å€¼
}

/**
 * SKUæ‰¹é‡åŒæ­¥é¡µé¢
 */
function woo_walmart_sku_batch_sync_page() {
    include_once WOO_WALMART_SYNC_PATH . 'admin/sku-batch-sync-dual.php';
}

/**
 * ğŸ”§ AJAXè°ƒè¯•æµ‹è¯•é¡µé¢
 */
function woo_walmart_ajax_debug_page() {
    include_once WOO_WALMART_SYNC_PATH . 'admin/ajax-debug-test.php';
}