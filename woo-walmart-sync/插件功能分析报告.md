# Woo Walmart Sync 插件功能分析报告

## 📋 目录
1. [插件概述](#插件概述)
2. [核心架构](#核心架构)
3. [同步逻辑](#同步逻辑)
4. [分类映射页面](#分类映射页面)
5. [按钮功能详解](#按钮功能详解)

---

## 📌 插件概述

### 基本信息
- **插件名称**: Woo Walmart Sync
- **版本**: 2.0.0
- **描述**: WooCommerce商品同步到沃尔玛，API Key直连，无需OAuth授权
- **主文件**: `woo-walmart-sync.php`

### 核心功能
1. **产品同步**: 将WooCommerce产品同步到Walmart Marketplace
2. **分类映射**: 本地分类与Walmart分类的映射管理
3. **库存管理**: 自动同步库存数量
4. **价格同步**: 同步产品价格到Walmart
5. **多市场支持**: 支持美国、加拿大等多个市场
6. **UPC管理**: UPC码池管理和自动分配

---

## 🏗️ 核心架构

### 主要类文件

#### 1. **API认证类** (`class-api-key-auth.php`)
- 处理Walmart API的认证和请求
- 支持API Key方式直连
- 管理API请求的签名和加密

#### 2. **产品映射类** (`class-product-mapper.php`)
- 将WooCommerce产品数据映射为Walmart格式
- 处理属性转换和数据格式化
- 支持V5.0 API规范

#### 3. **产品同步类** (`class-product-sync.php`)
- 管理产品同步流程
- 处理单个和批量同步
- Feed状态跟踪

#### 4. **库存管理类** (`class-inventory-manager.php`)
- 同步库存数量到Walmart
- 支持单个商品和变体商品
- 自动重试失败的库存同步

#### 5. **多市场支持类**
- `class-multi-market-config.php`: 市场配置
- `class-multi-market-data-manager.php`: 多市场数据管理
- `class-multi-market-api-router.php`: API路由

### 数据库表结构

```sql
-- 1. 日志表
wp_woo_walmart_sync_logs
- id, created_at, action, status, request, response, product_id

-- 2. UPC池表
wp_walmart_upc_pool
- id, upc_code, product_id, assigned_at, status

-- 3. 分类映射表 (核心)
wp_walmart_category_map
- id, wc_category_id, wc_category_name
- walmart_category_path, walmart_attributes
- local_category_ids (JSON格式，支持共享映射)
- created_at, updated_at

-- 4. Feed状态表
wp_walmart_feeds
- id, feed_id, product_id, status, submitted_at, response

-- 5. 批量Feed表
wp_walmart_batch_feeds
- id, batch_id, total_items, status, created_at

-- 6. 批量项目表
wp_walmart_batch_items
- id, batch_id, product_id, sku, status, error_message
```

---

## 🔄 同步逻辑

### 同步流程图

```
产品同步请求
    ↓
【1. 前置校验】
    - 检查SKU
    - 检查价格
    - 检查产品名称
    - 检查产品状态
    ↓
【2. UPC分配】
    - 从UPC池获取或分配UPC
    ↓
【3. 分类映射查找】
    - 获取产品分类
    - 查找对应的Walmart分类映射
    - 获取属性映射规则
    ↓
【4. 产品数据映射】
    - 调用 Product_Mapper->map()
    - 转换为Walmart V5.0格式
    - 生成MPItem结构
    ↓
【5. API提交】
    - 调用 /v3/feeds?feedType=MP_ITEM
    - 提交Feed数据
    - 获取Feed ID
    ↓
【6. 延迟库存同步】
    - 5分钟后触发库存同步
    - 等待商品在Walmart系统生效
    ↓
【7. Feed状态跟踪】
    - 定期查询Feed处理状态
    - 更新本地记录
```

### 关键代码位置

**单个产品同步** (`class-product-sync.php`):
```php
public function initiate_sync($product_id) {
    // Line 36-289
    // 1. 前置校验
    // 2. UPC分配
    // 3. 分类映射
    // 4. 产品映射
    // 5. API调用
    // 6. 延迟库存同步
}
```

**批量同步** (`woo-walmart-sync.php`):
```php
private function build_batch_feed_data($product_ids) {
    // Line 4300-4380
    // 构建批量Feed数据
    // 支持最多10000个产品
}
```

**库存同步** (`class-inventory-manager.php`):
```php
public function sync_single_product_inventory($product, $walmart_sku) {
    // Line 88-150
    // 调用 /v3/inventory API
    // 更新库存数量
}
```

### 同步类型

#### 1. **单个产品同步**
- 触发: 手动点击同步按钮
- 流程: 完整的校验→映射→提交流程
- 适用: 测试、单个产品更新

#### 2. **批量同步**
- 触发: SKU批量同步页面
- 流程: 批量构建Feed→一次性提交
- 适用: 大量产品初始化

#### 3. **自动库存同步**
- 触发: 产品创建成功后5分钟
- 流程: 延迟任务→库存API调用
- 适用: 保持库存一致性

---

## 📂 分类映射页面

### 页面位置
**路径**: WordPress后台 → Walmart同步 → 分类映射  
**文件**: `woo-walmart-sync.php` (Line 5718-10750)

### 页面结构

```
┌─────────────────────────────────────────────────────┐
│ Walmart分类映射管理                                  │
├─────────────────────────────────────────────────────┤
│ [从沃尔玛更新分类列表] [修复映射数据]                │
├─────────────────────────────────────────────────────┤
│                                                     │
│ 【已映射分组区域】                                   │
│ ┌─────────────────────────────────────────────┐   │
│ │ 📦 Walmart分类: Dish Racks  [+ 新增本地类目] │   │
│ │ 包含 2 个本地分类                            │   │
│ ├─────────────────────────────────────────────┤   │
│ │ ✓ 本地分类1 (ID: 95, 商品数: 291) [移除]    │   │
│ │ ✓ 本地分类2 (ID: 96, 商品数: 0)   [移除]    │   │
│ ├─────────────────────────────────────────────┤   │
│ │ 【共享属性映射配置】                         │   │
│ │ ┌─────────────────────────────────────┐     │   │
│ │ │ 属性名称 │ 类型 │ 数据源 │ 必填 │ 操作 │     │   │
│ │ ├─────────────────────────────────────┤     │   │
│ │ │ brand    │自动生成│ auto  │ ■   │ 删除 │     │   │
│ │ │ material │WC属性 │ color │     │ 删除 │     │   │
│ │ └─────────────────────────────────────┘     │   │
│ │ [智能加载] [重置属性] [调试API] [保存配置]   │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ 【未映射分类区域】                                   │
│ ┌─────────────────────────────────────────────┐   │
│ │ 本地分类: 赛盈产品 (ID: 94, 商品数: 213)     │   │
│ │ [选择Walmart分类] ▼                          │   │
│ │ [智能加载] [重置属性] [保存此分类的映射配置]  │   │
│ └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

### 核心功能

#### 1. **分组显示逻辑** (Line 7320-7410)
```php
// 按Walmart分类分组
$grouped_categories = [];
foreach ($all_mappings as $mapping) {
    $walmart_cat = $mapping->walmart_category_path;
    
    // 获取该映射的所有本地分类
    $local_category_ids = json_decode($mapping->local_category_ids, true) ?: [];
    
    // 分组存储
    $grouped_categories[$walmart_cat][] = $local_cats;
}
```

#### 2. **共享映射机制**
- 多个本地分类可以映射到同一个Walmart分类
- 共享同一套属性配置
- 通过 `local_category_ids` JSON字段实现

#### 3. **属性映射配置**
每个属性包含以下字段:
- `name`: 属性名称
- `type`: 映射类型 (auto_generate/wc_attribute/default_value)
- `source`: 数据源
- `required_level`: 必填级别
- `group`: 属性分组
- `format`: 数据格式
- `enum_values`: 枚举值

---

## 🔘 按钮功能详解

### 1. 【从沃尔玛更新分类列表】按钮

**位置**: 页面顶部  
**代码**: Line 7288-7290

**功能**:
- 从Walmart API获取最新的分类列表
- 更新本地缓存的分类数据
- 支持V5.0 API规范

**触发流程**:
```
点击按钮
  ↓
验证nonce (fetch_walmart_categories_nonce)
  ↓
调用 woo_walmart_fetch_categories_from_api()
  ↓
请求 Walmart Taxonomy API
  ↓
解析分类树结构
  ↓
保存到数据库
  ↓
刷新页面显示
```

**相关代码**: Line 11000-11500 (AJAX处理函数)

---

### 2. 【修复映射数据】按钮

**位置**: 页面顶部  
**代码**: Line 7291-7293

**功能**:
- 修复数据索引错位问题
- 对齐属性数组长度
- 清理无效数据

**修复逻辑** (Line 6070-6120):
```php
// 检查数组长度是否一致
if ($name_count !== $type_count || $name_count !== $source_count) {
    // 修复: 截断或填充数组
    $fixed_attributes = [
        'name' => array_slice($names, 0, $min_count),
        'type' => array_pad(array_slice($types, 0, $min_count), $min_count, 'default_value'),
        'source' => array_pad(array_slice($sources, 0, $min_count), $min_count, '')
    ];
}
```

---

### 3. 【新增本地类目】按钮

**位置**: 每个Walmart分类分组头部  
**代码**: Line 7422-7427

**功能**:
- 为已映射的Walmart分类添加更多本地分类
- 实现一对多映射关系
- 自动复制属性配置

**操作流程**:
```
点击按钮
  ↓
显示弹窗 (showLocalCategoryModal)
  ↓
AJAX加载未映射的本地分类 (get_unmapped_local_categories)
  ↓
用户选择分类
  ↓
保存映射 (save_local_category_mappings)
  ↓
更新 local_category_ids 字段
  ↓
刷新页面
```

**JavaScript代码** (Line 10530-10750):
```javascript
$(document).on('click', '.add-local-category-btn', function() {
    var walmartCategory = $(this).data('walmart-category');
    var walmartCategoryName = $(this).data('walmart-category-name');
    showLocalCategoryModal(walmartCategory, walmartCategoryName);
});
```

**AJAX处理** (Line 21177-21329):
```php
add_action('wp_ajax_save_local_category_mappings', function() {
    // 验证nonce
    // 获取现有映射
    // 合并本地分类ID
    // 更新数据库
    // 返回结果
});
```

---

### 4. 【移除】按钮

**位置**: 每个本地分类旁边  
**代码**: Line 7445-7460

**功能**:
- 从共享映射中移除指定的本地分类
- 如果是最后一个分类,删除整个映射记录
- 保留其他分类的映射关系

**处理逻辑** (Line 21516-21638):
```php
// 从 local_category_ids 中移除指定ID
$local_category_ids = array_diff($local_category_ids, [$category_id]);

if (empty($local_category_ids)) {
    // 删除整个映射记录
    $wpdb->delete($map_table, ['id' => $mapping_id]);
} else {
    // 更新映射记录
    $wpdb->update($map_table, [
        'local_category_ids' => json_encode($local_category_ids)
    ], ['id' => $mapping_id]);
}
```

---

### 5. 【智能加载】按钮

**位置**: 每个分类映射区域  
**代码**: Line 7530-7600

**功能**:
- 从Walmart API动态获取分类属性
- 智能合并现有属性
- 支持增量加载

**加载策略**:
1. 检查是否已选择Walmart分类
2. 检测分类是否更换
3. 如果更换,询问用户是否替换所有属性
4. 调用 `get_walmart_category_attributes` AJAX
5. 合并或替换属性列表

**JavaScript代码** (Line 9880-10220):
```javascript
$('.smart-load-attributes-button').on('click', function() {
    // 获取Walmart分类信息
    // 检测分类变化
    // AJAX请求属性
    // 智能合并属性
    // 更新UI
});
```

---

### 6. 【重置属性】按钮

**位置**: 每个分类映射区域  
**代码**: Line 7540-7550

**功能**:
- 清空现有属性配置
- 重新加载完整的V5.0规范属性
- 不可撤销操作

**执行流程** (Line 9470-9850):
```
点击按钮
  ↓
检查是否已选择Walmart分类
  ↓
确认对话框 (如果有现有属性)
  ↓
清空属性表格
  ↓
AJAX请求 (get_walmart_category_attributes)
  - force_refresh: true
  - force_replace: true
  ↓
重建属性行
  - 设置字段类型 (auto_generate/wc_attribute)
  - 添加必填标识
  - 保存枚举值
  ↓
更新属性计数
  ↓
完成提示
```

**关键特性**:
- 强制刷新缓存
- 自动识别自动生成字段
- 保留必填级别信息
- 支持枚举值

---

### 7. 【调试API】按钮

**位置**: 每个分类映射区域  
**代码**: Line 9500-9600

**功能**:
- 调试Walmart API响应
- 查看原始API数据
- 帮助排查问题

**调试信息**:
```javascript
$.ajax({
    action: 'debug_walmart_api_response',
    category_id: walmartCatId,
    category_name: walmartCatName
}).done(function(response) {
    console.log('API原始响应:', response);
    alert('调试信息已输出到浏览器控制台');
});
```

---

### 8. 【保存此分类的映射配置】按钮

**位置**: 每个分类映射区域底部  
**代码**: Line 8213-8220

**功能**:
- 保存单个分类的映射配置
- 包括Walmart分类选择和属性映射
- AJAX方式提交,无需刷新页面

**保存数据结构**:
```php
[
    'wc_category_id' => 95,
    'wc_category_name' => '本地分类名称',
    'walmart_category_path' => 'Home > Kitchen > Dish Racks',
    'walmart_attributes' => json_encode([
        'name' => ['brand', 'material', ...],
        'type' => ['auto_generate', 'wc_attribute', ...],
        'source' => ['auto', 'color', ...],
        'required_level' => ['REQUIRED', 'RECOMMENDED', ...],
        'group' => ['Basic', 'Additional', ...],
        'format' => ['string', 'array', ...],
        'enum_values' => [[], [], ...]
    ])
]
```

**AJAX处理** (Line 21334-21455):
```php
add_action('wp_ajax_save_category_mapping', function() {
    // 验证nonce
    // 解析属性数据
    // 检测数据变化
    // 保存到数据库
    // 返回成功/失败
});
```

---

## 📊 数据流向图

```
WooCommerce产品
    ↓
【分类映射查找】
    ↓
wp_walmart_category_map 表
    ↓
获取属性映射规则 (walmart_attributes JSON)
    ↓
【Product_Mapper->map()】
    ↓
生成Walmart V5.0格式数据
    ↓
【API提交】
    ↓
Walmart Marketplace
    ↓
【Feed状态跟踪】
    ↓
wp_walmart_feeds 表
    ↓
【延迟库存同步】
    ↓
库存API更新
```

---

## 🎯 总结

### 插件核心优势
1. ✅ **API Key直连**: 无需复杂的OAuth授权
2. ✅ **V5.0规范支持**: 完整支持最新API版本
3. ✅ **智能属性映射**: 自动生成+手动配置结合
4. ✅ **批量同步**: 支持最多10000个产品
5. ✅ **多市场支持**: 美国、加拿大等市场
6. ✅ **完整日志**: 详细的操作日志记录

### 关键技术点
- **共享映射机制**: 多对一分类映射
- **延迟库存同步**: 避免API限制
- **Feed状态跟踪**: 异步处理结果
- **属性智能加载**: 动态获取最新规范
- **数据验证**: 多层次的数据校验

### 维护建议
1. 定期更新Walmart分类列表
2. 监控Feed处理状态
3. 检查库存同步日志
4. 备份分类映射配置
5. 测试新产品同步流程

---

**文档生成时间**: 2025-01-XX  
**插件版本**: 2.0.0  
**分析基于**: 代码库完整扫描

